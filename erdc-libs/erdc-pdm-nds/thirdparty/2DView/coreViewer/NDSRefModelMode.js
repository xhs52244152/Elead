!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSRefModelMode=t():e.NDSRefModelMode=t()}(window,function(){return n={},i.m=r=[function(e,t,r){"use strict";r.r(t);class n extends NDSWebViewer.Extension{constructor(){super(),this.name="RefModelModeExtension"}overrideValue(e,t){super.overrideValue(this.currentTypeName,e,t)}overrideFunction(e,t){super.overrideFunction(this.currentTypeName,e,t)}overridePrototype(e){super.overridePrototype(this.currentTypeName,e)}load(e){super.load(e),this.currentTypeName="",this.loadContext={nTotalBufferChunksCount:0,nBufferChunkLoadedCount:0,chunkRequestFiredNum:0,unloadReferenceModels:[],loadingReferenceModels:new Set,nUnHandledLoadingModels:1,numObject:0}}unload(e){super.unload(e)}}const re=new n;NDSWebViewer.ExtensionManager.addExtension(re),re.currentTypeName="CTMLoader",re.overrideFunction("readBvhV4Ref",function(e,t,r,n,i){var a=e.readInt32(),o=e.readByte();t.setNumNodes(a);for(var s,d,l,u,h,m,c=new Float32Array(6),f=0,g=new THREE.Box3,p=new THREE.Matrix4,y=e=>!(e[0]>e[3]||e[1]>e[4]||e[2]>e[5]),b=()=>{g.min.fromArray(c,0),g.max.fromArray(c,3),g.applyMatrix4(n),c[0]=g.min.x,c[1]=g.min.y,c[2]=g.min.z,c[3]=g.max.x,c[4]=g.max.y,c[5]=g.max.z},v=0;v<a;++v){e.readInt32();for(var M=0;M<6;++M)c[M]=e.readFloat32();n&&y(c)&&b(),s=e.readInt32(),f=e.readInt32(),u=r?t.meshManager.nMeshes+e.readInt32():e.readInt32(),d=e.readInt32(),h=r?t.meshManager.nLineSegments+e.readInt32():e.readInt32(),l=e.readInt32(),m=r?t.meshManager.nTexts+e.readInt32():e.readInt32(),t.setNode(v,c,s,f,u,d,h,l,m)}var w=null;if(1===o)for(var x=e.readInt32(),w=new Float32Array(16*x),v=0;v<x;++v){for(var I=16*v,M=0;M<16;++M){var T=e.readFloat32();w[I+M]=T,n&&(p.elements[M]=T)}n&&(p.premultiply(n),w.set(p.elements,I))}let C=0;1===o&&(r?C=t.meshManager.addMatrixes(w):t.meshManager.setMatrixes(w));for(var B,E=e.readInt32(),S=[],M=0;M<E;++M)B=0===this.materialIdType?this.readUuid3(e):this.readUuid(e),S.push(B);let R=0;r?R=t.meshManager.addMaterialUuids(S):t.meshManager.setMaterialUuids(S);for(var A,F=e.readInt32(),k=[],N=0;N<F;++N)A=0===this.objectIdType?this.readUuid3(e):this.readUuid(e),1<i&&(A+="_"+i),k.push(A);f=e.readInt32();let L=0;r?L=t.meshManager.expandMeshes(f,!0,1===o):t.meshManager.setNumMeshes(f,!0,1===o);for(var D,U,O,j=new Int32Array(f),H=0;H<f;++H)j[H]=L+H;t.setMeshIds(j);for(var G=0;G<f;++G){for(var P=e.readInt32(),V=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),W=e.readInt32(),M=0;M<6;++M)c[M]=e.readFloat32();n&&y(c)&&b(),D=e.readInt32(),U=e.readInt32(),e.readInt32(),O=-1,1===o&&(O=e.readInt32()),t.meshManager.setMeshFromGeomUuid(L+G,c,V,W,R+D,U,P,C+O)}var z=e.readInt32();let J=0;r?J=t.meshManager.expandLineSegments(z,!0,1===o):t.meshManager.setNumLineSegments(z,!0,1===o);for(var q=0;q<z;++q)P=e.readInt32(),V=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),D=e.readInt32(),U=e.readInt32(),e.readInt32(),O=-1,1===o&&(O=e.readInt32()),t.meshManager.setLineSegmentsFromGeomUuid(J+q,V,U,R+D,P,C+O);var Q=e.readInt32();let X=0;r?X=t.meshManager.expandTexts(Q,!0,1===o):t.meshManager.setNumTexts(Q,!0,1===o);for(var Y=0;Y<Q;++Y)P=e.readInt32(),V=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),D=e.readInt32(),U=e.readInt32(),e.readInt32(),O=-1,1===o&&(O=e.readInt32()),t.meshManager.setTextFromGeomUuid(X+Y,V,U,R+D,P,C+O);t.meshManager.setBodyUuids(k,L,J,X)}),re.overrideFunction("readBvh",function(e,t,r,n={}){let i=n.modelBvh;var a=n.parentBvhNode;let o=n.referenceModel;var s=n.referenceCount,d=n.worldMatrix,n=(e.readString(),e.readInt32());4===(t.version=n)?a||s?(this.readBvhV4Ref(e,t,!!a,d,s),a&&(o.dynamicBvhNode=i.mergeSubTree(a,t))):this.readBvhV4(e,t):1==n?this.readBvhV1(e,t):1<n&&this.readBvhV2(e,t,n),r&&r({binaryData:e.data})}),re.currentTypeName="NdsMeshManager",re.overrideValue("newMeshStart",0),re.overrideValue("newMaterialUuidStart",0),re.overrideValue("newLineSegmentStart",0),re.overrideValue("newTextStart",0),re.overrideFunction("addMatrixes",function(e){if(!this.matrixes)return this.setMatrixes(e),0;var t=this.matrixes.length/16;let r=new Array;return r.extend(this.matrixes),r.extend(e),this.matrixes=new Float32Array(r),t}),re.overrideFunction("expandMeshes",function(t,e=!1,r=!1){if(0===this.nMeshes)return this.setNumMeshes(t,e,r),0;var n=this.nMeshes;this.nMeshes+=t;let i=new Array;i.extend(this.bboxes),i.extend(new Array(6*t).fill(0)),this.bboxes=new Float32Array(i);let a=new Array;a.extend(this.geomId),a.extend(new Array(t).fill(0)),this.geomId=new Int32Array(a);let o=new Array;o.extend(this.materialId),o.extend(new Array(t).fill(0)),this.materialId=new Int32Array(o);let s=new Array;s.extend(this.materialIdOriginal),s.extend(new Array(t).fill(0)),this.materialIdOriginal=new Int32Array(s);let d=new Array;d.extend(this.bodyNodes),d.extend(new Array(t)),this.bodyNodes=d;let l=new Array;if(l.extend(this.bodyUuids),l.extend(new Array(t)),this.bodyUuids=l,e){let e=new Array;e.extend(this.meshObjectUuids),e.extend(new Array(t)),this.meshObjectUuids=e}if(r){let e=new Array;e.extend(this.matrixId),e.extend(new Array(t)),this.matrixId=new Int32Array(e)}return this.instancedMeshIds.length=0,n}),re.overrideFunction("addMaterialUuids",function(e){if(!this.materialUuids)return this.setMaterialUuids(e),0;var t=this.materialUuids.length;return e&&0<e.length&&(this.materialUuids=this.materialUuids.concat(e)),t}),re.overrideFunction("setBodyUuids",function(t,e=0,r=0,n=0){for(var i,a=e;a<this.nMeshes;a++)i=this.bodyUuids[a],this.bodyUuids[a]=t[i],this.meshObjectUuids&&(i=this.meshObjectUuids[a],this.meshObjectUuids[a]=t[i]);for(var o,a=r;a<this.nLineSegments;a++)o=this.lineSegBodyUuids[a],this.lineSegBodyUuids[a]=t[o],this.lineSegObjectUuids&&(o=this.lineSegObjectUuids[a],this.lineSegObjectUuids[a]=t[o]);var s;for(let e=n;e<this.nTexts;++e)s=this.textBodyUuids[e],this.textBodyUuids[e]=t[s],this.textObjectUuids&&(s=this.textObjectUuids[e],this.textObjectUuids[e]=t[s]);for(var d=this.bodyUuids.length,l=0;l<d;++l)this.bodyUuid2IdMap[this.bodyUuids[l]]=l}),re.overrideFunction("setMaterialInfor",function(){if(this.newMaterialUuidStart!==this.materialUuids.length||this.newMeshStart!==this.nMeshes){var t=0,r=this.mats.length,n=this.mats;this.mats=[];let e=this.mats.length;var i,a=this.materialUuids.length;for(t=0;t<a;++t)t<this.newMaterialUuidStart?this.mats[e++]=n[t]:(i=(i=this.materials[this.materialUuids[t]])||this.materials[this.materialUuids[t].toUpperCase()],this.mats[e++]=i?i.mat:null);var o,s,d={};for(t=0;t<this.nMeshes;++t)-1<this.geomId[t]&&(l=this.geomManager.getGeomFromId(this.geomId[t])).vertexColors&&((s=d[this.materialId[t]])||((o=(new(o=this.mats[this.materialId[t]]).constructor).copy(o)).vertexColors=THREE.VertexColors,this.mats[e++]=o,++a,s=this.mats.length-1,d[this.materialId[t]]=s),this.materialId[t]=s,this.materialIdOriginal[t]=s);for(t=0;t<a;++t)this.mats[t]?this.mats[e++]=t<this.newMaterialUuidStart?n[t]:(new this.mats[t].constructor).copy(this.mats[t]):this.mats[e++]=null;if(this.supportInstancedArrays)for(var l,u=this.mats.length/2,t=0;t<this.nMeshes;++t)-1<this.geomId[t]&&(1<(l=this.geomManager.getGeomFromId(this.geomId[t])).refMeshes.length&&!l.useSharedGlBuffer?(this.materialId[t]=this.materialIdOriginal[t]+u,l.updateModelMatrix=!0):this.materialId[t]=this.materialIdOriginal[t]);if(0<this.matsCopy.length&&this.mats.length!=r){var h=this.matsCopy[0].opacity;for(t=0;t<this.matsCopy.length;++t)this.matsCopy[t].dispose();for(t=this.matsCopy.length=0;t<this.mats.length;++t)this.mats[t]&&(this.matsCopy[t]=this.mats[t].clone(),this.matsCopy[t].uuid=this.mats[t].uuid,this.matsCopy[t].program=this.mats[t].program,this.matsCopy[t].needsUpdate=this.mats[t].needsUpdate,this.matsCopy[t].opacity=h,this.matsCopy[t].transparent=!0)}}}),re.overrideFunction("mapGeomUuidToGeomId",function(){for(var e=0,e=this.newMeshStart;e<this.nMeshes;++e)this.geomId[e]=this.geomManager.getGeomIdFromUuid(this.geomUuid[e],this.subgeomId[e]);for(e=this.newLineSegmentStart;e<this.nLineSegments;++e)this.lineSegGeomId[e]=this.geomManager.getGeomIdFromUuid(this.lineSegGeomUuid[e],0);for(e=this.newTextStart;e<this.nTexts;++e)this.textGeomId[e]=this.geomManager.getGeomIdFromUuid(this.textGeomUuid[e],0);for(this.collectGeomRefEntities(),e=0;e<this.geomManager.geoms.length;++e){var t=this.geomManager.geoms[e];if(1<t.refMeshes.length){t.refMeshesSameMaterial=!0,t.refMeshesSameMaterialOriginal=!0;for(var r=0;r<t.refMeshes.length-1;++r){var n=t.refMeshes[r],i=t.refMeshes[r+1];if(this.materialId[n]!=this.materialId[i]){t.refMeshesSameMaterial=!1,t.refMeshesSameMaterialOriginal=!1;break}}}}this.setMaterialInfor(),this.bNeedRecalculateInstanceMesh=!0,this.newMeshStart=this.nMeshes,this.newMaterialUuidStart=this.materialUuids.length,this.newLineSegmentStart=this.nLineSegments,this.newTextStart=this.nTexts}),re.overrideFunction("expandLineSegments",function(t,e=!1,r=!1){if(0===this.nLineSegments)return this.setNumLineSegments(t,e,r),0;var n=this.nLineSegments;this.nLineSegments+=t;let i=new Array;i.extend(this.lineSegGeomId),i.extend(new Array(t).fill(0)),this.lineSegGeomId=new Int32Array(i);let a=new Array;a.extend(this.lineSegMaterialId),a.extend(new Array(t).fill(0)),this.lineSegMaterialId=new Int32Array(a);let o=new Array;o.extend(this.lineSegFlag),o.extend(new Array(t).fill(0)),this.lineSegFlag=new Uint8Array(o);let s=new Array;s.extend(this.lineSegBodyNodes),s.extend(new Array(t)),this.lineSegBodyNodes=s;let d=new Array;if(d.extend(this.lineSegBodyUuids),d.extend(new Array(t)),this.lineSegBodyUuids=d,e){let e=new Array;e.extend(this.lineSegObjectUuids),e.extend(new Array(t)),this.lineSegObjectUuids=e}if(r){let e=new Array;e.extend(this.lineSegMatrixId),e.extend(new Array(t)),this.lineSegMatrixId=new Int32Array(e)}return n}),re.overrideFunction("expandTexts",function(t,e,r=!1){if(0===this.nTexts)return this.setNumTexts(t,e,r),0;var n=this.nTexts;this.nTexts+=t;let i=new Array;i.extend(this.textGeomId),i.extend(new Array(t).fill(0)),this.textGeomId=new Int32Array(i);let a=new Array;a.extend(this.textMaterialId),a.extend(new Array(t).fill(0)),this.textMaterialId=new Int32Array(a);let o=new Array;o.extend(this.textBodyNodes),o.extend(new Array(t)),this.textBodyNodes=o;let s=new Array;if(s.extend(this.textBodyUuids),s.extend(new Array(t)),this.textBodyUuids=s,e){let e=new Array;e.extend(this.textObjectUuids),e.extend(new Array(t)),this.textObjectUuids=e}if(r){let e=new Array;e.extend(this.textMatrixId),e.extend(new Array(t)),this.textMatrixId=new Int32Array(e)}return n}),re.currentTypeName="NdsBodyNode",re.overrideFunction("getMaterialBodyNodeUUid",function(){for(var e=null,t=this;null!=t;){if(t.useBodyNodeMaterial){e=t.uuid;break}t=t.parent}return e}),re.currentTypeName="NdsMeshSet",re.overrideFunction("sortMeshes",function(e){}),re.overrideFunction("sortMeshes2",function(e){}),re.currentTypeName="NdsModel",re.overrideFunction("prepareForRendering",function(e,t,r){this.meshManager.supportInstancedArrays=e,this.meshManager.supportInstancedArraysCopy=e,this.meshManager.mapGeomUuidToGeomId(),this.buildMeshSets();var n=function(e){if(e.unload=!0,e.visible=!1,0<e.children.length)for(var t=0;t<e.children.length;++t)n(e.children[t])};this.leafNodeCount=0,this.wholeLeafBodyNodes.length=0,this.wholeRefEntityNodes.length=0,this.wholeCoordinateNodes.length=0,this.bodyUuid2NodeMap={};for(var i=[this.rootBodyNode],a=0;a<i.length;++a){var o=i[a],s=(this.bodyUuid2NodeMap[o.uuid]=o).type.toLowerCase();0===o.children.length&&("part"!=s&&"assembly"!=s&&(o.id=this.meshManager.bodyUuid2IdMap[o.uuid],o.id||(1==NDSWebViewer.SETTING.inAssemblyContext?o.id=this.leafNodeCount++:o.id=999999)),o.isReferenceEntity()?this.wholeRefEntityNodes.push(o):o.isCoordinate()?(this.wholeCoordinateNodes.push(o),null==o.worldMatrix&&(o.worldMatrix=this.calculateNodeWorldMatrix(o)),null==o.leafBodyAttri&&(o.leafBodyAttri=new NDSWebViewer.NdsCoordSystemAttri,o.visible||o.hide())):("part"!=s&&"assembly"!=s&&this.wholeLeafBodyNodes.push(o),null==o.worldMatrix&&(o.worldMatrix=this.calculateNodeWorldMatrix(o))),this.hasRawMesh||"rawmesh"!=s||(this.hasRawMesh=!0)),this.objectidTouuid?(o.objectid&&(this.objectidTouuid[o.objectid]=o.uuid),t.unvisibleList&&-1!=t.unvisibleList.indexOf(o.objectid)&&n(o)):(null==(s=this.meshManager.bodyUuid2IdMap[o.uuid])&&(this.meshManager.bodyUuid2IdMap[o.uuid]=this.meshManager.bodyUuids.length,this.meshManager.bodyUuids.push(o.uuid),s=this.meshManager.bodyUuid2IdMap[o.uuid]),t.useUnvisibleList&&t.unvisibleList&&-1!=t.unvisibleList.indexOf(s)&&n(o));for(var d=0,l=o.children.length;d<l;++d)i.push(o.children[d])}for(a=0;a<this.meshManager.nMeshes;++a){var u=this.meshManager.bodyUuids[a];if(h=this.bodyUuid2NodeMap[u])if(null==(this.meshManager.bodyNodes[a]=h).leafBodyAttri){h.leafBodyAttri=new NDSWebViewer.NdsLeafBodyAttri,null==h.worldMatrix&&(h.worldMatrix=this.calculateNodeWorldMatrix(h)),this.inIsolate()&&h.isolate(),h.leafBodyAttri.bodyMeshIds.push(a);for(d=0;d<6;++d)h.leafBodyAttri.bodyBbox[d]=this.meshManager.bboxes[6*a+d]}else if(-1==h.leafBodyAttri.bodyMeshIds.indexOf(a)){h.leafBodyAttri.bodyMeshIds.push(a);for(d=0;d<3;++d)this.meshManager.bboxes[6*a+d]<h.leafBodyAttri.bodyBbox[d]&&(h.leafBodyAttri.bodyBbox[d]=this.meshManager.bboxes[6*a+d]),this.meshManager.bboxes[6*a+3+d]>h.leafBodyAttri.bodyBbox[3+d]&&(h.leafBodyAttri.bodyBbox[3+d]=this.meshManager.bboxes[6*a+3+d])}}for(a=0;a<this.meshManager.nTexts;++a){var u=this.meshManager.textBodyUuids[a],h=this.bodyUuid2NodeMap[u];null==(this.meshManager.textBodyNodes[a]=h).leafBodyAttri?(h.leafBodyAttri=new NDSWebViewer.NdsLeafBodyAttri,h.leafBodyAttri.bodyTextIds.push(a),null==h.worldMatrix&&(h.worldMatrix=this.calculateNodeWorldMatrix(h))):-1==h.leafBodyAttri.bodyTextIds.indexOf(a)&&h.leafBodyAttri.bodyTextIds.push(a)}for(var m=[],a=0;a<this.meshManager.nLineSegments;++a){u=this.meshManager.lineSegBodyUuids[a],h=this.bodyUuid2NodeMap[u];(this.meshManager.lineSegBodyNodes[a]=h)||console.log("loss body: "+u),null==h.leafBodyAttri?(h.leafBodyAttri=new NDSWebViewer.NdsLeafBodyAttri,h.leafBodyAttri.bodyLineSegIds.push(a),null==h.worldMatrix&&(h.worldMatrix=this.calculateNodeWorldMatrix(h)),m.push(h)):-1==h.leafBodyAttri.bodyLineSegIds.indexOf(a)&&h.leafBodyAttri.bodyLineSegIds.push(a)}if(0<(this.pureLineBody=m).length)for(a=0;a<m.length;a++)6!==m[a].leafBodyAttri.bodyBbox.length&&this.calculateLineBodyBoundingBox(m[a]),6!==m[a].leafBodyAttri.bodyBbox.length&&(m[a].leafBodyAttri.bodyBbox[0]=1/0,m[a].leafBodyAttri.bodyBbox[1]=1/0,m[a].leafBodyAttri.bodyBbox[2]=1/0,m[a].leafBodyAttri.bodyBbox[3]=-1/0,m[a].leafBodyAttri.bodyBbox[4]=-1/0,m[a].leafBodyAttri.bodyBbox[5]=-1/0);this.transparentBodyChanged=!0,r?this.getAllTransparentBodies(!0):this.getAllTransparentBodies(!1);for(i=[this.rootBodyNode],a=this.hideBodies.length=0;a<i.length;++a)if((o=i[a]).visible)for(d=0,l=o.children.length;d<l;++d)i.push(o.children[d]);else this.hideBody(o);for(a=0;a<this.wholeCoordinateNodes.length;++a){var c,f=this.wholeCoordinateNodes[a];f.visible&&(f.leafBodyAttri.renderObject?f.leafBodyAttri.renderObject.attach(f):(c=null,c=this.viewer.canvas2D||this.viewer.canvas3D,(c=new NDSWebViewer.NdsCoordSystem(this.viewer.camera,c)).attach(f),f.leafBodyAttri.renderObject=c,this.viewer.scene.add(c)))}this.meshManager.resetGeomSameMaterialFlags()}),re.overrideFunction("attachBodyNode",function(t,r,e,n){!t.propertyfile&&r.propertyfile&&(t.propertyfile=r.propertyfile,this.viewer.propertyManager.bindReference(t.uuid,r.referenceNode||r.uuid));for(let e=0;e<r.children.length;e++)t.children.push(r.children[e]),r.children[e].parent=t}),re.currentTypeName="BrepManager",re.overrideFunction("parseBreps",function(n){var i=n.readByte();this.version=i;var e=n.readInt32();let a=new Array(e);for(let r=0;r<e;++r){var t=n.readGuid();a[r]={geomUUID:t};var o=n.readInt32();if(0<o){a[r].lines={ids:new Int32Array(o),indexRanges:new Int32Array(2*o),lengthes:new Float32Array(o)};for(let e=0;e<o;++e)a[r].lines.ids[e]=n.readInt32(),a[r].lines.indexRanges[2*e]=n.readInt32(),a[r].lines.indexRanges[2*e+1]=n.readInt32(),a[r].lines.lengthes[e]=n.readFloat32()}var s=n.readInt32();if(0<s){a[r].circles={ids:new Int32Array(s),indexRanges:new Int32Array(2*s),lengthes:new Float32Array(s),centers:new Float32Array(3*s),radiuses:new Float32Array(s)};for(let t=0;t<s;++t){a[r].circles.ids[t]=n.readInt32(),a[r].circles.indexRanges[2*t]=n.readInt32(),a[r].circles.indexRanges[2*t+1]=n.readInt32(),a[r].circles.lengthes[t]=n.readFloat32();for(let e=0;e<3;++e)a[r].circles.centers[3*t+e]=n.readFloat32();a[r].circles.radiuses[t]=n.readFloat32()}}var d=n.readInt32();if(0<d){a[r].ellipses={ids:new Int32Array(d),indexRanges:new Int32Array(2*d),lengthes:new Float32Array(d)};for(let e=0;e<d;++e)a[r].ellipses.ids[e]=n.readInt32(),a[r].ellipses.indexRanges[2*e]=n.readInt32(),a[r].ellipses.indexRanges[2*e+1]=n.readInt32(),a[r].ellipses.lengthes[e]=n.readFloat32()}var l=n.readInt32();if(0<l){a[r].nurbses={ids:new Int32Array(l),indexRanges:new Int32Array(2*l),lengthes:new Float32Array(l)};for(let e=0;e<l;++e)a[r].nurbses.ids[e]=n.readInt32(),a[r].nurbses.indexRanges[2*e]=n.readInt32(),a[r].nurbses.indexRanges[2*e+1]=n.readInt32(),a[r].nurbses.lengthes[e]=n.readFloat32()}var u=n.readInt32();if(0<u){a[r].others={ids:new Int32Array(u),indexRanges:new Int32Array(2*u),lengthes:new Float32Array(u)};for(let e=0;e<u;++e)a[r].others.ids[e]=n.readInt32(),a[r].others.indexRanges[2*e]=n.readInt32(),a[r].others.indexRanges[2*e+1]=n.readInt32(),a[r].others.lengthes[e]=n.readFloat32()}}let r=0;this.brepInfos.edgeGroups?(r=this.brepInfos.edgeGroups.length,this.brepInfos.edgeGroups=this.brepInfos.edgeGroups.concat(a)):this.brepInfos.edgeGroups=a;var h=n.readInt32();let m=new Array(h);for(let r=0;r<h;++r){var c=n.readGuid();m[r]={geomUUID:c,loopPerimeters:[],loopStartEdgeId:[]};var f=n.readInt32();if(0<f){m[r].planes={ids:new Int32Array(f),triIndexRanges:new Int32Array(2*f),areas:new(i<7?Float32Array:Float64Array)(f),origins:new Float32Array(3*f),normals:new Float32Array(3*f),loops:new Int32Array(2*f)};for(let t=0;t<f;++t){m[r].planes.ids[t]=n.readInt32(),m[r].planes.triIndexRanges[2*t]=n.readInt32(),m[r].planes.triIndexRanges[2*t+1]=n.readInt32(),m[r].planes.areas[t]=i<7?n.readFloat32():n.readFloat64();var g=n.readInt32(),p=m[r].loopPerimeters.length;for(let e=0;e<g;++e)m[r].loopPerimeters[p+e]=n.readFloat32(),m[r].loopStartEdgeId[p+e]=n.readInt32();m[r].planes.loops[2*t]=p,m[r].planes.loops[2*t+1]=g;for(let e=0;e<3;++e)m[r].planes.origins[3*t+e]=n.readFloat32();for(let e=0;e<3;++e)m[r].planes.normals[3*t+e]=n.readFloat32()}}var y=n.readInt32();if(0<y){m[r].cylinders={ids:new Int32Array(y),triIndexRanges:new Int32Array(2*y),areas:new(i<7?Float32Array:Float64Array)(y),loops:new Int32Array(2*y),origins:new Float32Array(3*y),axis:new Float32Array(3*y),radiuses:new Float32Array(y)};for(let t=0;t<y;++t){m[r].cylinders.ids[t]=n.readInt32(),m[r].cylinders.triIndexRanges[2*t]=n.readInt32(),m[r].cylinders.triIndexRanges[2*t+1]=n.readInt32(),m[r].cylinders.areas[t]=i<7?n.readFloat32():n.readFloat64();var b=n.readInt32(),v=m[r].loopPerimeters.length;for(let e=0;e<b;++e)m[r].loopPerimeters[v+e]=n.readFloat32(),m[r].loopStartEdgeId[v+e]=n.readInt32();m[r].cylinders.loops[2*t]=v,m[r].cylinders.loops[2*t+1]=b;for(let e=0;e<3;++e)m[r].cylinders.axis[3*t+e]=n.readFloat32();for(let e=0;e<3;++e)m[r].cylinders.origins[3*t+e]=n.readFloat32();m[r].cylinders.radiuses[t]=n.readFloat32()}}var M=n.readInt32();if(0<M){m[r].cones={ids:new Int32Array(M),triIndexRanges:new Int32Array(2*M),areas:new(i<7?Float32Array:Float64Array)(M),loops:new Int32Array(2*M),origins:new Float32Array(3*M),axis:new Float32Array(3*M),radiuses:new Float32Array(M)};for(let t=0;t<M;++t){m[r].cones.ids[t]=n.readInt32(),m[r].cones.triIndexRanges[2*t]=n.readInt32(),m[r].cones.triIndexRanges[2*t+1]=n.readInt32(),m[r].cones.areas[t]=i<7?n.readFloat32():n.readFloat64();var w=n.readInt32(),x=m[r].loopPerimeters.length;for(let e=0;e<w;++e)m[r].loopPerimeters[x+e]=n.readFloat32(),m[r].loopStartEdgeId[x+e]=n.readInt32();m[r].cones.loops[2*t]=x,m[r].cones.loops[2*t+1]=w;for(let e=0;e<3;++e)m[r].cones.axis[3*t+e]=n.readFloat32();for(let e=0;e<3;++e)m[r].cones.origins[3*t+e]=n.readFloat32();m[r].cones.radiuses[t]=n.readFloat32()}}var I=n.readInt32();if(0<I){m[r].spheres={ids:new Int32Array(I),triIndexRanges:new Int32Array(2*I),areas:new(i<7?Float32Array:Float64Array)(I),loops:new Int32Array(2*I)};for(let e=0;e<I;++e){m[r].spheres.ids[e]=n.readInt32(),m[r].spheres.triIndexRanges[2*e]=n.readInt32(),m[r].spheres.triIndexRanges[2*e+1]=n.readInt32(),m[r].spheres.areas[e]=i<7?n.readFloat32():n.readFloat64();var T=n.readInt32(),C=m[r].loopPerimeters.length;for(let e=0;e<T;++e)m[r].loopPerimeters[C+e]=n.readFloat32(),m[r].loopStartEdgeId[C+e]=n.readInt32();m[r].spheres.loops[2*e]=C,m[r].spheres.loops[2*e+1]=T}}var B=n.readInt32();if(0<B){m[r].toruses={ids:new Int32Array(B),triIndexRanges:new Int32Array(2*B),areas:new(i<7?Float32Array:Float64Array)(B),loops:new Int32Array(2*B)};for(let e=0;e<B;++e){m[r].toruses.ids[e]=n.readInt32(),m[r].toruses.triIndexRanges[2*e]=n.readInt32(),m[r].toruses.triIndexRanges[2*e+1]=n.readInt32(),m[r].toruses.areas[e]=i<7?n.readFloat32():n.readFloat64();var E=n.readInt32(),S=m[r].loopPerimeters.length;for(let e=0;e<E;++e)m[r].loopPerimeters[S+e]=n.readFloat32(),m[r].loopStartEdgeId[S+e]=n.readInt32();m[r].toruses.loops[2*e]=S,m[r].toruses.loops[2*e+1]=E}}var R=n.readInt32();if(0<R){m[r].nurbses={ids:new Int32Array(R),triIndexRanges:new Int32Array(2*R),areas:new(i<7?Float32Array:Float64Array)(R),loops:new Int32Array(2*R)};for(let e=0;e<R;++e){m[r].nurbses.ids[e]=n.readInt32(),m[r].nurbses.triIndexRanges[2*e]=n.readInt32(),m[r].nurbses.triIndexRanges[2*e+1]=n.readInt32(),m[r].nurbses.areas[e]=i<7?n.readFloat32():n.readFloat64();var A=n.readInt32(),F=m[r].loopPerimeters.length;for(let e=0;e<A;++e)m[r].loopPerimeters[F+e]=n.readFloat32(),m[r].loopStartEdgeId[F+e]=n.readInt32();m[r].nurbses.loops[2*e]=F,m[r].nurbses.loops[2*e+1]=A}}var k=n.readInt32();if(0<k){m[r].others={ids:new Int32Array(k),triIndexRanges:new Int32Array(2*k),areas:new(i<7?Float32Array:Float64Array)(k),loops:new Int32Array(2*k)};for(let e=0;e<k;++e){m[r].others.ids[e]=n.readInt32(),m[r].others.triIndexRanges[2*e]=n.readInt32(),m[r].others.triIndexRanges[2*e+1]=n.readInt32(),m[r].others.areas[e]=i<7?n.readFloat32():n.readFloat64();var N=n.readInt32(),L=m[r].loopPerimeters.length;for(let e=0;e<N;++e)m[r].loopPerimeters[L+e]=n.readFloat32(),m[r].loopStartEdgeId[L+e]=n.readInt32();m[r].others.loops[2*e]=L,m[r].others.loops[2*e+1]=N}}}let D=0;this.brepInfos.faceGroups?(D=this.brepInfos.faceGroups.length,this.brepInfos.faceGroups=this.brepInfos.faceGroups.concat(m)):this.brepInfos.faceGroups=m;var U=n.readInt32();let O=new Uint32Array(U),j=new Float32Array(3*U);for(let t=0;t<U;++t){O[t]=n.readInt32();for(let e=0;e<3;++e)j[3*t+e]=n.readFloat32()}this.brepInfos.vertices||(this.brepInfos.vertices={ids:O,coords:j});var H=n.readInt32();let G=new Array(H);for(let t=0;t<H;++t){G[t]={},G[t].area=i<7?n.readFloat32():n.readFloat64(),G[t].volume=i<7?n.readFloat32():n.readFloat64();var P=n.readInt32();if(0<P){G[t].edgeGroups=new Int32Array(P);for(let e=0;e<P;++e)G[t].edgeGroups[e]=r+n.readInt32()}var V=n.readInt32();if(0<V){G[t].faceGroups=new Int32Array(V);for(let e=0;e<V;++e)G[t].faceGroups[e]=D+n.readInt32()}var W=n.readInt32();if(0<W){G[t].vertices=new Int32Array(W);for(let e=0;e<W;++e)G[t].vertices[e]=n.readInt32()}}let z=0;this.brepInfos.breps?(z=this.brepInfos.breps.length,this.brepInfos.breps=this.brepInfos.breps.concat(G)):this.brepInfos.breps=G;var J=n.readInt32();let q=new Map;for(let e=0;e<J;++e){var Q=n.readGuid(),X=z+n.readInt32();q.set(Q,X)}this.brepInfos.bodies?q.forEach((e,t)=>{this.brepInfos.bodies.set(t,e)}):this.brepInfos.bodies=q}),re.currentTypeName="PropertyManager",re.overrideValue("referenceMap",null),re.overrideFunction("getObjectProperty",function(e,t,r){var n=e.referenceNode||e.uuid;this.referenceMap&&this.referenceMap.has(n)&&(n=this.referenceMap.get(n));var i=e.propertyfile;if(null!=i&&null!=i)if(void 0===this.cachedProperties||this.cachedPropertyFileName!=i||null==this.cachedProperties[n]||null==t){e=new NDSWebViewer.BIMXHRLoader(this.loadingManager);e.setCrossOrigin("anonymous"),e.setResponseType("arraybuffer");var a=(e=>{e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")})(this.viewer.modelInfo[0].url);if(0<i.indexOf("/")){let n=i.split(/['/','\\']+/);if(this.viewer.configurations&&this.viewer.configurations.has(n[0])){var o=this.viewer.configurations.get(n[0]).Configurations;let r="0";for(let e=0,t=o.length;e<t;++e)if(o[e].Name===n[1]){r=o[e].Folder;break}n[1]=r}let t=a.split(/['/','\\']+/);a=t[0].toLowerCase().includes("http")?t[0]+"/":t[0];for(let e=1;e<t.length-n.length;++e)a+="/"+t[e];for(let e=0;e<n.length;++e)a+="/"+n[e]}else a+=i;e.load(null,a,e=>{e=pako.inflate(e,{to:"string"});this.cachedProperties=JSON.parse(e),null!=this.cachedProperties&&(this.cachedPropertyFileName=i,null!=t&&(null!=this.cachedProperties[n]?t(this.cachedProperties[n],r):t(null,r)))},void 0,e=>{null!=t&&t(null,r)},!0)}else t(this.cachedProperties[n],r);else null!=t&&t(null,r)}),re.overrideFunction("bindReference",function(e,t){this.referenceMap||(this.referenceMap=new Map),this.referenceMap.set(e,t)}),re.currentTypeName="SelectionManager",re.overrideFunction("getSelectedBodyVolumeAndArea",function(){let s=(e,t)=>{for(var r=0,n=e.length;r<n;r++)if("body"==e[r].type.toLowerCase()){for(var i,a=!1,o=0;o<this.selectedObjects.length;++o)if(e[r].uuid==this.selectedObjects[o].uuid){a=!0;break}a&&this.selectedObjects!=e||(i=this.viewer.brepManager.GetBodyVolumeAndArea(e[r].referenceNode||e[r].uuid))&&(t.volume+=i.volume,t.area+=i.area)}else{for(a=!1,o=0;o<this.selectedObjects.length;++o)if(e[r].uuid==this.selectedObjects[o].uuid){a=!0;break}(!a||this.selectedObjects==e)&&0<e[r].children.length&&s(e[r].children,t)}};if(this.viewer.hasBrepInfo()&&0<this.selectedObjects.length){var e={volume:0,area:0};if(s(this.selectedObjects,e),1e-7<e.area){var t=this.viewer.getDispalyModelUnit(e.volume,e.area);return e.volume=e.volume*t.scale*t.scale*t.scale,e.area=e.area*t.scale*t.scale,[e,t.unit]}return null}return null}),re.currentTypeName="MeasureBase",re.overrideFunction("getSelectInfoFromIntersect",function(e){if(e&&this.viewer.hasBrepInfo()){var t=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(t){var r,n,i,a=t.referenceNode||t.uuid,t=e.object.uuid;return this.viewer.ndsModel&&(0<=e.meshId?(e.mesh=this.viewer.ndsModel.meshManager.getSingleMesh(e.meshId),e.mesh&&(r=e.faceIndex-e.mesh.geometry.drawRange.start/3,n="face")):0<=e.lineSegId&&(e.mesh=this.viewer.ndsModel.meshManager.getLineSegments(e.lineSegId),e.mesh&&(r=.5*(e.index-e.mesh.geometry.drawRange.start),n="edge")),t=e.geomUuid),0<=r&&(i=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(a,t,r,n))&&(i.parentObj=e.mesh,i.geometry=e.mesh.geometry,i.matrixWorld=e.mesh.matrixWorld.clone(),i.intersect=e.point.clone(),i.bodyId=e.bodyId,i.bodyUuid=a,i.meshId=e.meshId,i.topolIndex=r,i.topolType=n,i.lineSegId=e.lineSegId,"face"==n&&(i.edgeInfos=this.viewer.brepManager.GetEdgeInfoFromFace(a,i.edgeIDS)),i.normal&&null==i.worldNormal&&(e=new THREE.Vector3,n=new THREE.Quaternion,a=new THREE.Vector3,i.parentObj.matrixWorld.decompose(e,n,a),i.worldNormal=new THREE.Vector3(i.normal[0],i.normal[1],i.normal[2]),i.worldNormal.applyQuaternion(n)),i.origin&&null==i.worldOrigin&&(i.worldOrigin=new THREE.Vector3(i.origin[0],i.origin[1],i.origin[2]),i.worldOrigin.applyMatrix4(i.matrixWorld))),i}}});var i=NDSWebViewer.NdsMeshSet;class a{constructor(){this.boundingBox=new THREE.Box3,this.boundingSphere=new THREE.Sphere,this.children=[],this.items=[],this.parent=null,this.addSubTree=e=>{((e=!e.isDynamicBVH?new l(e):e).root.parent=this).children.push(e.root);let t=this;for(;t;)t.boundingBox.expandByPoint(e.root.boundingBox.min),t.boundingBox.expandByPoint(e.root.boundingBox.max),t=t.parent;return e.root},this.queryByRayCast=function(){new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3;let a=(r,n,i)=>{if(n.intersectsBox(r.boundingBox)){0<=r.meshSetId&&(i[i.length]=r.meshSetId);for(let e=0,t=r.children.length;e<t;++e)a(r.children[e],n,i)}};return function(e,t){a(this,e,t)}}()}}class l{constructor(e,t){this.isDynamicBVH=!0,this.root=new a,(this.root.bvh=this).meshIds=[],e&&(this.meshManager=e.meshManager,0<e.nNodes&&this.initNodeByModelBvhNode(this.root,e,0)),t&&(this.meshManager=t),0<e.leftChild.length&&-1!==e.leftChild[0]&&(this.buildFromModelBvh(this.root,e,e.leftChild[0]),this.buildFromModelBvh(this.root,e,e.leftChild[0]+1))}mergeSubTree(e,t){return t.meshIds&&(this.meshIds=this.meshIds.concat(t.meshIds)),e.addSubTree(t)}initNodeByModelBvhNode(e,t,r){t.nNodes<=r||(e.boundingBox.min.set(t.bboxes[6*r+0],t.bboxes[6*r+1],t.bboxes[6*r+2]),e.boundingBox.max.set(t.bboxes[6*r+3],t.bboxes[6*r+4],t.bboxes[6*r+5]),e.nMeshes=t.nMeshes[r],e.startMesh=t.startMesh[r],4===t.version&&(e.nLines=t.nLines[r],e.startLine=t.startLine[r],e.nTexts=t.nTexts[r],e.startText=t.startText[r]))}buildFromModelBvh(e,t,r){let n=new a;n.parent=e,this.initNodeByModelBvhNode(n,t,r),e.children.push(n),0<t.leftChild.length&&-1!==t.leftChild[r]&&(this.buildFromModelBvh(n,t,t.leftChild[r]),this.buildFromModelBvh(n,t,t.leftChild[r]+1))}buildMeshSets(){let e=0,t=[];this.nodeId2MeshSetIdMap=[],this.nodeId2NodeMap=[];let n=r=>{r.id=e++,0<(this.nodeId2NodeMap[r.id]=r).nMeshes?(t.push(new i(this,r.id)),r.meshSetId=t.length-1,this.nodeId2MeshSetIdMap[r.id]=r.meshSetId):this.nodeId2MeshSetIdMap[r.id]=-1;for(let e=0,t=r.children.length;e<t;++e)n(r.children[e])};return n(this.root),t}getNodeBox(e,t){let r=t||new THREE.Box3;e=this.nodeId2NodeMap[e];return e&&r.copy(e.boundingBox),r}setMeshIds(e){this.meshIds=this.meshIds.concat(e)}getNumMeshes(e){e=this.nodeId2NodeMap[e];return e?e.nMeshes:0}getMesh(e,t){e=this.nodeId2NodeMap[e];if(e){t=e.startMesh+t;return this.meshManager.getMesh(t)}return null}getMeshId(e,t){e=this.nodeId2NodeMap[e];return e?e.startMesh+t:-1}getNumTexts(e){e=this.nodeId2NodeMap[e];return e?e.nTexts:-1}getTextId(e,t){e=this.nodeId2NodeMap[e];return e?e.startText+t:-1}getText(e,t){e=this.nodeId2NodeMap[e];if(e){t=e.startText+t;return this.meshManager.getText(t)}return null}getNumLineSegments(e){e=this.nodeId2NodeMap[e];return e?e.nLines:-1}getLineSegmentsId(e,t){e=this.nodeId2NodeMap[e];return e?e.startLine+t:-1}getLineSegmentsWithState(e,t,r,n){e=this.nodeId2NodeMap[e];if(e){t=e.startLine+t;return this.meshManager.getLineSegmentsWithState(t,r,n)}return{state:-1,lineSegments:null}}getLineSegments(e,t,r,n){n=this.getLineSegmentsWithState(e,t,r,n);return 1===n.state?n.lineSegments:null}intersect(e){let r=[];if(this.meshManager.ndsModel.hasDraggedBodies()||0<this.meshManager.ndsModel.explodeFactor||0<this.meshManager.ndsModel.explodeFactorX||0<this.meshManager.ndsModel.explodeFactorY||0<this.meshManager.ndsModel.explodeFactorZ||NDSWebViewer.SETTING.inBIMContext)for(let e=0,t=this.nodeId2MeshSetIdMap.length;e<t;++e)0<=this.nodeId2MeshSetIdMap[e]&&(r[r.length]=this.nodeId2MeshSetIdMap[e]);else this.root.queryByRayCast(e,r);return r}}re.currentTypeName="BIMObjectLoader";function u(e,t){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.loader=null,this.linkMap={},this.linkWaitingArray={},this.linkDoneMap={},this.treeIndex=1e4,this.viewer=t,this.chunkRequestQueue=[],this.maxRequestNum=7,this.loadCanceled=!1,this.chunkRequestFiredNum=0,this.SDFMaker=new o,this.geometryTOchild={},t.SDFMaker=this.SDFMaker}var h,c=NDSWebViewer.DecalGeometry,ne=NDSWebViewer.CTMLoader,ie=NDSWebViewer.BIMJSONLoader,I=NDSWebViewer.BIMXHRLoader,m=NDSWebViewer.BIMLoader,o=NDSWebViewer.SDFCreater,T=NDSWebViewer.BrepManager,ae=NDSWebViewer.MaterialsSetting,oe=NDSWebViewer.NdsGeometry,f=NDSWebViewer.NdsBodyNode,C=NDSWebViewer.NdsModel,S=NDSWebViewer.SETTING,p=NDSWebViewer.BVHCreater,B=NDSWebViewer.NdsModelBvh;u.prototype={constructor:u,getRefUUID:function(e,t){return t&&1<t?e+"_"+t:e},load:function(m,c,f,g,p,y,b,e,v,M={}){this.treeIndex=1e4,this.isReferenceModel=!!M.isReferenceModel;const w=m&&m.modelReferenceCount&&1<m.modelReferenceCount.get(c);var x=this;this.loader=new I,this.loader.setCrossOrigin(this.crossOrigin);let d=e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",r=0,n=e.length;r<n;r++)t+=String.fromCharCode(e[r]);return decodeURIComponent(escape(t))};if(Array.isArray(c))for(var i={combine:!(x.nLoadedJsonCount=0)},t=0;t<c.length;++t){var r=new I;r.attribute=t,r.load(null,c[t],function(e,t){var r,n=null;try{n=JSON.parse(e)}catch(e){return void(v&&v())}null!=n.modelContentFile&&null!=n.modelContentFile?((r=new I(new THREE.LoadingManager)).setCrossOrigin("anonymous"),r.setResponseType("arraybuffer"),e=x.extractUrlBase(c[t])+n.modelContentFile,null!=g&&null!=g&&(e=g[t]),r.load(null,e,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);x.handleMaterialLoadMultiple(x,m,n,e,i,c,f,t,p,y,b)},void 0,v)):x.handleMaterialLoadMultiple(x,m,n,n,i,c,f,t,p,y,b)},void 0,v)}else{let t=t=>{var h=null;if(t.isMain)h=t;else try{(h=JSON.parse(t)).isMain=!0}catch(e){return p&&p({isLoadFailed:!0},null,null,null,c),void(v&&v())}let s=()=>{var t,e,r,n,i,a,o=x.extractUrlBase(c);if(x.viewer.modelContentVersion=h.modelContentVersion||1,h.fileID&&!x.viewer.watermark){var s=h.fileID.slice(4);x.viewer.watermark="";for(var d=0;d<s.length/4;d++){var l=s.slice(4*d,4*(d+1));x.viewer.watermark+=String.fromCharCode(parseInt(l,16))}"Viewer版本过低，请升级"==x.viewer.watermark&&(x.viewer.watermark="")}function u(e){M.referenceCount<=1&&(m.modelContent.get(c).bvh=e.binaryData);performance.now().toFixed(0);x.viewer.ndsModel.buildMeshSets(),x.viewer.ndsModelBvhLoaded=!0,x.viewer.ndsModelObjectTreeLoaded&&x.viewer.prepareModelForRendering()}if(x.viewer.ndsModelObjectTreeLoaded=!1,x.viewer.ndsModelBvhLoaded=!1,x.viewer.ndsModelPMILoaded=!1,x.viewer.cameraInfoFile=h.cameraInfo,x.viewer.cameraInfoFile&&(x.viewer.cameraInfoFile.hasSet=!1),h.pmiContentFile?(t=(o=x.extractUrlBase(c))+"pmi.bin",m.modelContent?m.modelContent.get(c).pmiContent&&(e=m.modelContent.get(c).pmiContent,x.SDFMaker.CreateMaterial(e,1,x.viewer.modelContentVersion),x.viewer.is2DModel&&x.viewer.saveTextForPDF(e,1),x.handleMaterialLoad(x,m,h,e,c,t,p,y,function(){x.viewer.render()},!0)):((e=new I).setCrossOrigin("anonymous"),e.setResponseType("arraybuffer"),r=o+h.pmiContentFile,e.load(null,r,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);x.SDFMaker.CreateMaterial(e,1,x.viewer.modelContentVersion),x.viewer.is2DModel&&x.viewer.saveTextForPDF(e,1),x.handleMaterialLoad(x,m,h,e,c,t,p,y,function(){x.viewer.render()},!0)},void 0,v))):(x.viewer.ndsModelPMILoaded=!0,x.viewer.dispatchEvent({type:"PMIInfoEvent",PMI:!1})),h.bvh&&0==S.inAssemblyContext&&(x.viewer.ndsModel||(x.viewer.ndsModel=new C(x.viewer),x.viewer.ndsModel.is2DModel=x.viewer.is2DModel),x.viewer.isRunning||setTimeout(x.viewer.run(),1),performance.now().toFixed(0),n={useWorker:!1,bufferlenth:h.bvhBufferLength,compress:!0,bvh:x.isReferenceModel?new B(x.viewer.ndsModel.meshManager):x.viewer.ndsModel.bvh},x.isReferenceModel&&(n.worldMatrix=M.worldMatrix,n.referenceModel=M.referenceModel,n.referenceCount=M.referenceCount),M.parentBvhNode&&(n.modelBvh=x.viewer.ndsModel.bvh,n.parentBvhNode=M.parentBvhNode),r=new ne({objectIdType:h.objectIdType,materialIdType:h.materialIdType,geomIdType:h.geomIdType,instanceIdType:h.instanceIdType}),m.modelContent?m.modelContent.get(c).bvh&&(n.compress=!1,n.bufferlenth=m.modelContent.get(c).bvh.length,r.parseBvh(m.modelContent.get(c).bvh,n,u)):r.loadBvh(null,o+h.bvh,n,u)),x.viewer.cameraInfoFile=h.cameraInfo,x.viewer.cameraInfoFile&&(x.viewer.cameraInfoFile.hasSet=!1),null!=h.geometryChunksFile&&null!=h.geometryChunksFile?((n=new I).setCrossOrigin("anonymous"),n.setResponseType("arraybuffer"),i=o+h.geometryChunksFile,n.load(null,i,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);x.loadModelContent(x,m,h,e,o,g,c,f,p,y,b,v)},void 0,v)):x.loadModelContent(x,m,h,null,o,g,c,f,p,y,b,v),null==h.modelBrepData||null==h.modelBrepData||w||(i=o+h.modelBrepData,null==x.viewer.brepManager&&(x.viewer.brepManager=new T(x.viewer)),"modelBrep.js.gz"==h.modelBrepData&&(x.viewer.brepManager.type=0),x.viewer.brepManager.addBrepFileUrl(i),S.enablePreSelectBrep||S.inAssemblyContext?x.viewer.loadBrepInfo(!1):((i=new I).setCrossOrigin("anonymous"),i.setResponseType("arraybuffer"),a=(o=x.extractUrlBase(c))+h.modelBrepData,i.load(null,a,void 0,void 0,void 0,!0))),null!=h.uvfile){let e=new I;e.setCrossOrigin("anonymous"),e.setResponseType("arraybuffer");let r=x.extractUrlBase(c),n=r+h.uvfile;x.SDFMaker.SetVersion(2),e.load(null,n,function(e){var e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);x.SDFMaker.CreateMaterial(e,2,x.viewer.modelContentVersion);let t=new ne;e={useWorker:!1,bufferlenth:h.texturelength,compress:!0};n=r+h.texturefile,t.loadTexture(null,n,e,function(e){x.SDFMaker.SetTexture(e,x.viewer.modelContentVersion,function(){x.viewer.render()})})},void 0,v)}if(x.viewer.loadbrepDefault)x.viewer.loadBrepInfo(!1);else{let t=(e,a)=>{x.viewer.productDataMap||(x.viewer.productDataMap={}),x.viewer.productData||(x.viewer.productData={datas:[{area:0,pmiNum:0,volume:0}]}),x.viewer.productData.datas[0].area+=e.datas[0].area,x.viewer.productData.datas[0].pmiNum+=e.datas[0].pmiNum,x.viewer.productData.datas[0].volume+=e.datas[0].volume,function e(t){var r,n;if(t.uuid&&(r={area:t.area,volume:t.volume},n=x.getRefUUID(t.uuid,a),x.viewer.productDataMap[n]=r),0<t.children.length)for(var i=0;i<t.children.length;++i)e(t.children[i])}(e.datas[0].modelTree)};m.modelContent?m.modelContent.get(c).productData?(a=m.modelReferenceCount.get(c),t(m.modelContent.get(c).productData,a)):x.viewer.is2DModel||x.viewer.loadBrepInfo(!1):x.loader.load(null,o+"productData.json",function(e){try{x.viewer.productData=JSON.parse(e),t(x.viewer.productData)}catch(e){x.viewer.is2DModel||x.viewer.loadBrepInfo(!1)}},void 0,function(){x.viewer.is2DModel||x.viewer.loadBrepInfo(!1)})}};if(h.bundleFile&&!w){m.isBundledType||(m.isBundledType=!0,m.referenceModels=new Map,m.modelReferenceCount=new Map,m.modelContent=new Map,m.configurations=new Map),m.modelContent.has(c)||m.modelContent.set(c,{model:h});let e=new I;e.setCrossOrigin(this.crossOrigin),e.setResponseType("arraybuffer");t=c.substr(0,c.length-8)+h.bundleFile;e.load(null,t,e=>{e=new Uint8Array(e,0,e.byteLength);let r=new Zlib.Unzip(e);var n=r.getFilenames();for(let e=0,t=n.length;e<t;++e){var i,a,o=r.decompress(n[e]);"Configurations.json"===n[e]?(i=c.split(/['/','\\']+/),m.configurations.has(i[i.length-3])||m.configurations.set(i[i.length-3],JSON.parse(d(o)))):"modelContent.js"===n[e]?(a=d(o),m.modelContent&&(m.modelContent.get(c).modelContent=a)):"bvh.bin"===n[e]?m.modelContent&&(m.modelContent.get(c).bvh=o):"productData.json"===n[e]?(a=d(o),m.modelContent&&(a=JSON.parse(a),m.modelContent.get(c).productData=a)):"pmiContent.js"===n[e]&&(o=d(o),m.modelContent&&(m.modelContent.get(c).pmiContent=JSON.parse(o)))}s()})}else s();return h};w?t(m.modelContent.get(c).model):this.loader.load(null,c,function(e){e=t(e);m.modelContent&&(m.modelContent.get(c).model=e)},e,e=>{p&&p({isLoadFailed:!0},null,null,null,c),v&&v(e)})}},loadModelContent:function(i,a,o,s,d,e,l,u,h,m,c,r){if(o.modelContentFile){var n,f=!!a&&!!a.isBundledType;const g=a&&a.modelReferenceCount&&1<a.modelReferenceCount.get(l);let t=t=>{if(t.isModelContent)r=t;else{try{var e=t.replace(/\\[^u]{1}/g,e=>"-"+e[1]),r=JSON.parse(e)}catch(e){r=JSON.parse(t)}r.isModelContent=!0,r.objectIdType=o.objectIdType,r.materialIdType=o.materialIdType,r.geomIdType=o.geomIdType,r.instanceIdType=o.instanceIdType}if(r.uv&&!g){i.SDFMaker.SetVersion(2),i.SDFMaker.CreateMaterial(r.uv,2,i.viewer.modelContentVersion);var n=d+r.texturefile,e=new ne,t={useWorker:!1,bufferlenth:r.texturelength,compress:!0};if(e.loadTexture(null,n,t,function(e){i.SDFMaker.SetTexture(e,i.viewer.modelContentVersion,function(){i.viewer.render()})}),null!=r.shxlength&&0<r.shxlength){n=d+r.shxfile;let e=new ne;t={useWorker:!1,bufferlenth:r.shxlength,compress:!0};e.loadShx(null,n,t,function(e){i.SDFMaker.ProcessShxText(i.viewer,e)})}}else g||i.SDFMaker.CreateMaterial(r,1,i.viewer.modelContentVersion);i.viewer.is2DModel&&i.viewer.saveTextForPDF(r,2<=i.viewer.modelContentVersion?2:1);performance.now().toFixed(0);return s&&Object.assign(r,s),null!=o.bvh&&null!=o.bvh&&1!=S.inAssemblyContext||(i.viewer.ndsModel?i.viewer.ndsModel&&i.viewer.ndsModel.bvhCreater&&i.viewer.ndsModel.bvhCreater.Reconstruct(r):(i.viewer.ndsModel=new C(i.viewer),i.viewer.isRunning||setTimeout(i.viewer.run(),1),i.viewer.ndsModel.bvhCreater=new p(r,i.viewer.ndsModel),i.viewer.ndsModel.bvhCreater.Build(),i.viewer.ndsModelBvhLoaded=!0,i.viewer.ndsModelObjectTreeLoaded&&i.viewer.ndsModelPMILoaded&&i.viewer.prepareModelForRendering())),i.handleMaterialLoad(i,a,o,r,l,u,h,m,c),r};g||f?a.modelContent&&a.modelContent.get(l).modelContent&&(n=t(a.modelContent.get(l).modelContent),a.modelContent.get(l).modelContent=n):((f=new I).setCrossOrigin("anonymous"),f.setResponseType("arraybuffer"),n=d+o.modelContentFile,f.load(null,n=null!=e&&null!=e?e:n,function(e){e=pako.inflate(e,{to:"string"});t(e)},void 0,r))}else i.handleMaterialLoad(i,a,o,o,l,u,h,m,c)},handleMaterialLoad:function(t,e,r,n,i,a,o,s,d,l){null!=l&&0!=l||(t.viewer.modelUnit=n.unit),null==r.materialsPath&&e.searchMaterialsFile&&(r.materialsPath="materials.js"),e.materialsSetting&&(n.materials=e.materialsSetting.materials);var u,h;e&&e.modelReferenceCount&&e.modelReferenceCount.get(i);r.materialsPath&&null==e.materialsSetting?((u=new I).setCrossOrigin(t.crossOrigin),h=t.extractUrlBase(i),u.load(null,h+r.materialsPath,function(e){e=JSON.parse(e);n.materials=e.materials,t.parse(null,n,i,a,null,o,s,d)},void 0,function(e){t.parse(null,n,i,a,null,o,s,d)})):((r={}).loadingPmi=l,r.referenceModels=e.referenceModels,r.modelReferenceCount=e.modelReferenceCount,r.modelContent=e.modelContent,t.parse(r,n,i,a,null,o,s,d))},handleMaterialLoadMultiple:function(t,e,r,n,i,a,o,s,d,l,u){var h;null==r.materialsPath&&e.searchMaterialsFile&&(r.materialsPath="materials.js"),e.materialsSetting&&(n.materials=e.materialsSetting.materials),r.materialsPath&&null==e.materialsSetting?((h=new I).setCrossOrigin(t.crossOrigin),e=t.extractUrlBase(a[s]),h.load(null,e+r.materialsPath,function(e){++t.nLoadedJsonCount;e=JSON.parse(e);n.materials=e.materials,t.mergeMainJson(a[s],o[s],s,i,n),t.nLoadedJsonCount==a.length&&t.parse(null,i,a,o,null,d,l,u)},void 0,function(e){++t.nLoadedJsonCount,t.mergeMainJson(a[s],o[s],s,i,n),t.nLoadedJsonCount==a.length&&t.parse(null,i,a,o,null,d,l,u)})):(++t.nLoadedJsonCount,t.mergeMainJson(a[s],o[s],s,i,n),t.nLoadedJsonCount==a.length&&t.parse(null,i,a,o,null,d,l,u))},mergeMainJson:function(e,t,r,n,i){if(i.materials)if(null==n.materials){n.materials=i.materials;for(var a=0;a<n.materials.length;++a)n.materials[a].jsonUrl=e}else for(a=0;a<i.materials.length;++a)i.materials[a].jsonUrl=e,n.materials.push(i.materials[a]);if(i.object&&(null==n.object&&(n.object={type:"Object3D",children:[]}),n.object.children.push(i.object)),null==n.bufferchunks&&(n.bufferchunks=[]),i.buffer&&((t={buffer:t,bufferlenth:i.bufferlenth,geometries:i.geometries}).compress=i.compress,t.isChunk=!1,n.bufferchunks.push(t)),i.bufferchunks)for(a=0;a<i.bufferchunks.length;++a)i.bufferchunks[a].compress=i.compress,i.bufferchunks[a].jsonUrl=e,i.bufferchunks[a].urlIndex=r,i.bufferchunks[a].isChunk=!0,n.bufferchunks.push(i.bufferchunks[a]);if(i.solidAnimations)if(null==n.solidAnimations)n.solidAnimations=i.solidAnimations;else for(a=0;a<i.solidAnimations.length;++a)n.solidAnimations.push(i.solidAnimations[a])},setCrossOrigin:function(e){this.crossOrigin=e},extractUrlBase:function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},checkGeometries:function(e,t){if(this.needsTangents(t))for(var r=0,n=e.length;r<n;r++)e[r].computeTangents()},needsTangents:function(e){for(var t in e)if(e[t].mat instanceof THREE.ShaderMaterial)return!0;return!1},parseMorphing:function(e,t){if(t instanceof THREE.Geometry){if(null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;for(var r=0,n=e.morphTargets.length;r<n;r++){t.morphTargets[r]={},t.morphTargets[r].name=e.morphTargets[r].name,t.morphTargets[r].vertices=[];for(var i=t.morphTargets[r].vertices,a=0,o=(l=e.morphTargets[r].vertices).length;a<o;a+=3){var s=new THREE.Vector3;s.x=+l[a],s.y=+l[a+1],s.z=+l[a+2],i.push(s)}}}}else if(t instanceof THREE.BufferGeometry&&null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;var d=e.morphTargets.length;morphTargetsPosition=[],t.morphAttributes.position=morphTargetsPosition;for(r=0;r<d;r++){var l=e.morphTargets[r].vertices,u=new THREE.Float32BufferAttribute(l.length,3);u.name=e.morphTargets[r].name,morphTargetsPosition.push(u.copyArray(l))}}},parseGeometry:function(e){},parseTexGeometry:function(e){var t={size:e.textFont.size,height:0,weight:e.textFont.weight,font:this.viewer.fontsManager.Fonts.default,style:e.textFont.style,bevelEnabled:!1,curveSegments:12,steps:1};0==t.size&&(t.size=1),e.isChina&&(t.font=this.viewer.fontsManager.Fonts.simfang);t=new THREE.TextBufferGeometry(e.text,t);return t.type="TextBufferGeometry",t},parseSDFTextGeometry:function(t,e,r,n,i,a=!1,o,s){var d=0,l=0,u=this,h=new(a?oe:THREE.BufferGeometry),m=u.SDFMaker.GetMaterialStyleId(t.textFont.style,t.textFont.weight),c=this.SDFMaker.RegText(t.text);t.text=c.text;var f=t.text.length;S.enableTextRenderingBothSide&&(f*=2);var a=new Float32Array(4*f*9),a=new THREE.InterleavedBuffer(a,9),g=new THREE.InterleavedBufferAttribute(a,3,0,!1),p=new THREE.InterleavedBufferAttribute(a,3,3,!1),y=new THREE.InterleavedBufferAttribute(a,2,6,!1),b=new THREE.InterleavedBufferAttribute(a,1,8,!1);h.addAttribute("position",g),h.addAttribute("color",p),h.addAttribute("uv",y),h.addAttribute("textureid",b),h.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(6*f),1));for(var v,M,w,x=h.getIndex().array,I=0;I<t.text.length;I++){var T=t.text[I];if(!(B=u.SDFMaker.GetDimensionsForSize(T,t.textFont.size,m,t.textFont.name,t.textFont.width,t.textFont.bigName)))return null;(c.superscript&&I>=c.superscriptbegin&&I<=c.superscriptend||c.subscript&&I>=c.subscriptbegin&&I<=c.subscriptend)&&(B.height*=.5,B.width*=.5);let e=B.height*u.SDFMaker.GetTextOffset(T,t.textFont.name);c.superscript&&I>=c.superscriptbegin&&I<=c.superscriptend&&(e-=B.height),l<B.height-e&&(l=B.height-e),g.array[36*I]=d,g.array[36*I+1]=B.height-e,g.array[36*I+2]=0,p.array[36*I+3]=n.r,p.array[36*I+4]=n.g,p.array[36*I+5]=n.b,y.array[36*I+6]=B.left,y.array[36*I+7]=B.top,b.array[36*I+8]=B.textureid,g.array[36*I+9]=d+B.width,g.array[36*I+10]=B.height-e,g.array[36*I+11]=0,p.array[36*I+12]=n.r,p.array[36*I+13]=n.g,p.array[36*I+14]=n.b,y.array[36*I+15]=B.right,y.array[36*I+16]=B.top,b.array[36*I+17]=B.textureid,g.array[36*I+18]=d,g.array[36*I+19]=-e,g.array[36*I+20]=0,p.array[36*I+21]=n.r,p.array[36*I+22]=n.g,p.array[36*I+23]=n.b,y.array[36*I+24]=B.left,y.array[36*I+25]=B.bottom,b.array[36*I+26]=B.textureid,g.array[36*I+27]=d+B.width,g.array[36*I+28]=-e,g.array[36*I+29]=0,p.array[36*I+30]=n.r,p.array[36*I+31]=n.g,p.array[36*I+32]=n.b,y.array[36*I+33]=B.right,y.array[36*I+34]=B.bottom,b.array[36*I+35]=B.textureid,x[6*I]=4*I,x[6*I+1]=4*I+2,x[6*I+2]=4*I+1,x[6*I+3]=4*I+2,x[6*I+4]=4*I+3,x[6*I+5]=4*I+1,d+=B.width}if(S.enableTextRenderingBothSide)for(var d=0,C=t.text.length-1,I=t.text.length;0<=C;C--,I++){var B,T=t.text[C];if(!(B=u.SDFMaker.GetDimensionsForSize(T,t.textFont.size,m,t.textFont.name,t.textFont.width,t.textFont.bigName)))return null;var E=B.height*u.SDFMaker.GetTextOffset(T,t.textFont.name);g.array[36*I]=d,g.array[36*I+1]=B.height-E,g.array[36*I+2]=0,p.array[36*I+3]=n.r,p.array[36*I+4]=n.g,p.array[36*I+5]=n.b,y.array[36*I+6]=B.left,y.array[36*I+7]=B.top,b.array[36*I+8]=B.textureid,g.array[36*I+9]=d+B.width,g.array[36*I+10]=B.height-E,g.array[36*I+11]=0,p.array[36*I+12]=n.r,p.array[36*I+13]=n.g,p.array[36*I+14]=n.b,y.array[36*I+15]=B.right,y.array[36*I+16]=B.top,b.array[36*I+17]=B.textureid,g.array[36*I+18]=d,g.array[36*I+19]=-E,g.array[36*I+20]=0,p.array[36*I+21]=n.r,p.array[36*I+22]=n.g,p.array[36*I+23]=n.b,y.array[36*I+24]=B.left,y.array[36*I+25]=B.bottom,b.array[36*I+26]=B.textureid,g.array[36*I+27]=d+B.width,g.array[36*I+28]=-E,g.array[36*I+29]=0,p.array[36*I+30]=n.r,p.array[36*I+31]=n.g,p.array[36*I+32]=n.b,y.array[36*I+33]=B.right,y.array[36*I+34]=B.bottom,b.array[36*I+35]=B.textureid,x[6*I+2]=4*I+1,x[6*I]=4*I+2,x[6*I+1]=4*I,x[6*I+3]=4*I+1,x[6*I+4]=4*I+3,x[6*I+5]=4*I+2,d+=B.width}return h.type="TextBufferGeometry",h.name=t.text,h.styleId=m,this.viewer.is2DModel&&((f=new THREE.Euler).setFromQuaternion(r),this.viewer.modelContentVersion<2&&(h.rotateZ(f.z),h.rotateY(f.y),h.rotateX(f.x),h.translate(e.x,e.y,e.z),this.SDFMaker.AddObject(h,m,i)),c.underscode&&((v=new THREE.LineBasicMaterial).color.setRGB(n.r,n.g,n.b),(M=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(d,0,0)),M.rotateZ(f.z),M.rotateY(f.y),M.rotateX(f.x),M.translate(e.x,e.y,e.z),(w=new THREE.LineSegments(M,v)).name=i,w.color=v.color.clone(),this.SDFMaker.AddLine(w)),c.box&&((v=new THREE.LineBasicMaterial).color.setRGB(n.r,n.g,n.b),(M=new THREE.Geometry).vertices.push(new THREE.Vector3(d,l,0),new THREE.Vector3(d,0,0),new THREE.Vector3(d,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,l,0),new THREE.Vector3(0,l,0),new THREE.Vector3(d,l,0)),M.rotateZ(f.z),M.rotateY(f.y),M.rotateX(f.x),M.translate(e.x,e.y,e.z),(w=new THREE.LineSegments(M,v)).name=i,w.color=v.color.clone(),this.SDFMaker.AddLine(w)),c.dash&&((v=new THREE.LineBasicMaterial).color.setRGB(n.r,n.g,n.b),(M=new THREE.Geometry).vertices.push(new THREE.Vector3(0,l,0),new THREE.Vector3(d,l,0)),M.rotateZ(f.z),M.rotateY(f.y),M.rotateX(f.x),M.translate(e.x,e.y,e.z),(w=new THREE.LineSegments(M,v)).name=i,w.color=v.color.clone(),this.SDFMaker.AddLine(w))),h},parseBufferGeometry:function(e){var t=new THREE.BufferGeometry;t.morphTargets=[],this.parseMorphing(e,t),t.bones=e.bones;var r=[],n=[];void 0!==e.animations&&null!=e.animations&&(e.animations.length?n=n.concat(e.animations):n.push(e.animations));for(var i=0;i<n.length;i++){var a=THREE.AnimationClip.parseAnimation(n[i],t.bones);a&&(this.viewer.animationsManager.bHasSkeletonAnimation=!0,a.animationUUID=n[i].uuid,r.push(a))}if(t.morphAttributes.position&&0<t.morphAttributes.position.length){var o=THREE.AnimationClip.CreateClipsFromMorphTargetSequences(t.morphAttributes.position,5);if(null!=o&&0<o.length)for(var r=r.concat(o),s=0;s<o.length;s++)o[s].uuid=e.morphInfos[s].uuid,o[s].ndsDuration=e.morphInfos[s].duration,o[s].ndsFps=e.morphInfos[s].fps}return 0<r.length&&(t.animations=r),t},parse:function(r,i,o,e,a,t,n,s){var d=r&&r.modelReferenceCount&&1<r.modelReferenceCount.get(o);Array.isArray(o)||(a=a&&"string"==typeof a?a:this.extractUrlBase(o));var l=new ie(void 0,this.manager,this.viewer),u=this,h=void 0;if(i.buffer){var m={};function c(){}for(var f=[],g=[],p=0,y=i.geometries.length;p<y;++p)"BufferGeometry"===i.geometries[p].type?f.push(new THREE.BufferGeometry):"Geometry"===i.geometries[p].type&&f.push(new THREE.Geometry),1==i.geometries[p].vertexColors&&(g[i.geometries[p].uuid]=!0),m[i.geometries[p].uuid]=f[p],u.manager.itemStart();var b={useWorker:!1,bufferlenth:i.bufferlenth,compress:i.compress,geometriesArray:f},v=new ne;this.manager.itemStart(),v.load(null,e,c,b,function(){u.parseDecals(a,i.decals,h),s&&s(!0,!0,unHandledModels),u.manager.itemEnd()});var M=l.initMaterials(i.materials,a,i.lineType,i.fonts);u.checkGeometries(m,M);var w=u.parseObject(i.object,m,M,o,g);return(Y=new THREE.Object3D).add(w),(h=Y).isPmi=r.loadingPmi,i.solidAnimations&&0<(Q=u.parseSolidAnimations(i.solidAnimations,m,M)).length&&this.viewer&&(this.viewer.animationsManager.bHasSolidAnimation=!0,this.viewer.animationsManager.initSolidAnimations(Y,Q)),this.viewer&&(this.viewer.materialsSetting||(this.viewer.materialsSetting=new ae),r.loadingPmi||this.viewer.materialsSetting.initMaterialsInfo(M)),t&&t(Y,i.lightsPreset),i.rendersetting&&(X=a+i.rendersetting,this.loader.load(null,X,function(e){n&&n(JSON.parse(e))})),u.manager.itemEnd(),Y}{var m={},x=0,I=i.bufferchunks?i.bufferchunks.concat():[];if(I){for(var T=0;T<I.length;++T)0<I[T].bufferlenth&&(i.bufferchunks[x]=I[T],x++);0<I.length-x&&i.bufferchunks.splice(x,I.length-x)}var C=0,B=[],E=[],g=[],S=!!u.viewer.ndsModel;r.loadingPmi&&(S=!1);var R;function A(){++C,++re.loadContext.nBufferChunkLoadedCount,C===x&&u.parseDecals(a,i.decals,h);for(var e,t=!0,r=0;r<B.length;++r)for(var n=0;n<B[r].length;++n)if(null==B[r][n].boundingBox){t=!1;break}s&&(e=!1,(re.loadContext.nBufferChunkLoadedCount===re.loadContext.nTotalBufferChunksCount||u.viewer.ndsModel&&u.loadCanceled&&re.loadContext.nBufferChunkLoadedCount===re.loadContext.chunkRequestFiredNum)&&(e=0===re.loadContext.unloadReferenceModels.length&&0===re.loadContext.loadingReferenceModels.size&&0===re.loadContext.nUnHandledLoadingModels,u.loadCanceled=!1),s(e,t))}function c(){}function F(){var e,t=u.viewer.ndsModel;if(t&&t.geomManager.stopLoading){if(0<u.chunkRequestQueue.length){if(u.loadCanceled=!0,u.chunkRequestFiredNum=x-u.chunkRequestQueue.length,re.loadContext.chunkRequestFiredNum+=u.chunkRequestFiredNum,t.geomManager.ignorePendingBufferChunks)return void(u.chunkRequestQueue.length=0);for(var r=0,n=u.chunkRequestQueue.length;r<n;++r)t.geomManager.ignorePendingLineSegBufferChunks&&0<u.chunkRequestQueue[r].parameters.ndsGeometriesArray[0].refLineSegs.length||(u.chunkRequestQueue[r].callback=A,t.geomManager.bufferChunksToLoad.push(u.chunkRequestQueue[r]));u.chunkRequestQueue.length=0}}else 0<u.chunkRequestQueue.length&&(e=u.chunkRequestQueue.shift(),new ne({objectIdType:i.objectIdType,geomIdType:i.geomIdType,materialIdType:i.materialIdType,instanceIdType:i.instanceIdType}).load(null,e.url,c,e.parameters,A,F))}if(u.viewer.nBufferChunks+=x,d)M=i.materials,R=i._fonts;else{if(M=l.initMaterials(i.materials,a,i.lineType,i.fonts),i.materials=M,R=new Map,i.fonts)for(let e=0,t=i.fonts.length;e<t;++e)R.set(i.fonts[e].uuid,i.fonts[e]);i._fonts=R}if(S||!function e(t){null!=t.geometry&&(u.geometryTOchild[t.geometry]||(u.geometryTOchild[t.geometry]=new Array),u.geometryTOchild[t.geometry].push(t));var r=t.children;if(r&&0<r.length)for(var n=0;n<r.length;n++)e(r[n])}(i.object),x<=0)u.viewer.ndsModelBvhLoaded=!0;else if(d)r&&r.modelContent&&(m=r.modelContent.get(o).threeGeometries);else{for(var k=0;k<x;++k){for(var f=[],N=[],p=0;p<i.bufferchunks[k].geometries.length;++p){var L=i.bufferchunks[k].geometries[p].type;if(null!=i.bufferchunks[k].geometries[p].id&&null!=i.bufferchunks[k].geometries[p].id||(i.bufferchunks[k].geometries[p].id=0),S){var D=i.bufferchunks[k].geometries[p].uuid;if(36===D.length&&(D=D.slice(0,8)+D.slice(9,13)+D.slice(14,18)+D.slice(19,23)+D.slice(24,36)),"PointGeometry"===L){var U=u.viewer.ndsModel.getGeomManager().getPointGeomFromUuid(D);U||((U=new NdsPointGeometry).uuid=D,u.viewer.ndsModel.getGeomManager().addPointGeom(U)),N.push(U);continue}if("BufferGeometry"===L){U=u.viewer.ndsModel.getGeomManager().getGeomFromUuid(D,i.bufferchunks[k].geometries[p].id);U||((U=new oe).geomType=i.bufferchunks[k].geometries[p].geomType,U.uuid=D,U.subGeomId=i.bufferchunks[k].geometries[p].id,U.bufferLength=i.bufferchunks[k].geometries[p].bufferLength,i.bufferchunks[k].geometries[p].box&&U.boundingBox.setFromArray(i.bufferchunks[k].geometries[p].box),i.bufferchunks[k].geometries[p].vertexColors&&(U.vertexColors=!0),u.viewer.ndsModel.getGeomManager().addGeom(U)),N.push(U),U.updateModelMatrix=!0,m[U.uuid]=U;continue}if("TextGeometry"===L){if(!(P=u.viewer.ndsModel.getGeomManager().getGeomFromUuid(D,i.bufferchunks[k].geometries[p].id))){let e=i.bufferchunks[k].geometries[p];i.fonts&&(e.textFont=R.get(e.textFont));var O=new THREE.Vector3;e.position&&(O.x=e.position.x,O.y=e.position.y,O.z=e.position.z);var j=new THREE.Quaternion;void 0!==e.angle&&j.setFromAxisAngle(new THREE.Vector3(0,0,1),e.angle);var H=new THREE.Color;"unLoad"==(P=this.SDFMaker.ParseSDFTextGeometry(e,O,j,H,i.bufferchunks[k].geometries[p].uuid,!0,e.isMirroredInX,e.isMirroredInY,!1,this.viewer.is2DModel,this.viewer.modelContentVersion)).textLoad&&this.SDFMaker.AddShxTextInfo({jsonText:e,geomuuid:D,id:i.bufferchunks[k].geometries[p].id}),P.text=e.text,P.uuid=D,P.isTextGeometry=!0,P.subGeomId=i.bufferchunks[k].geometries[p].id,P.bufferLength=i.bufferchunks[k].geometries[p].bufferLength,P.position=O,P.quaternion=j,u.viewer.ndsModel.getGeomManager().addGeom(P);D="text:"+P.styleId;u.viewer.ndsModel.getMeshManager().materials[D]||(u.viewer.ndsModel.getMeshManager().materials[D]={mat:this.SDFMaker.GetMaterial(P.styleId),refCount:0})}N.push(P),P.updateModelMatrix=!0,m[P.uuid]=P;continue}}if("BufferGeometry"===L){var G=this.parseBufferGeometry(i.bufferchunks[k].geometries[p]);f.push(G)}else if("Geometry"===L){G=new THREE.Geometry;f.push(G)}else if("TextGeometry"===L){var P,V=this.geometryTOchild[i.bufferchunks[k].geometries[p].uuid];if(V)for(var W=0;W<V.length;++W){var z,J,q=V[W],H=M[q.material].mat.color,O=new THREE.Vector3,j=new THREE.Quaternion;q.position?(O.set(q.position[0],q.position[1],q.position[2]),j.setFromAxisAngle(new THREE.Vector3(0,0,1),q.angle)):q.matrix&&((z=new THREE.Matrix4).fromArray(q.matrix),J=new THREE.Vector3,z.decompose(O,j,J));let e=i.bufferchunks[k].geometries[p];i.fonts&&(e.textFont=R.get(e.textFont)),P=this.parseSDFTextGeometry(e,O,j,H,q.uuid),f.push(P)}else{let e=i.bufferchunks[k].geometries[p];i.fonts&&(e.textFont=R.get(e.textFont));O=new THREE.Vector3;e.position&&(O.x=e.position.x,O.y=e.position.y,O.z=e.position.z);j=new THREE.Quaternion;void 0!==e.angle&&j.setFromAxisAngle(new THREE.Vector3(0,0,1),e.angle);H=new THREE.Color;P=this.parseSDFTextGeometry(e,O,j,H,i.bufferchunks[k].geometries[p].uuid),f.push(P)}}m[i.bufferchunks[k].geometries[p].uuid]=f[p],null!=i.bufferchunks[k].urlIndex&&(m[i.bufferchunks[k].geometries[p].uuid].urlIndex=i.bufferchunks[k].urlIndex),i.bufferchunks[k].geometries[p].box&&(f[p].boundingBox=new THREE.Box3,f[p].boundingBox.setFromArray(i.bufferchunks[k].geometries[p].box)),1==i.bufferchunks[k].geometries[p].vertexColors&&(g[i.bufferchunks[k].geometries[p].uuid]=!0)}B.push(f),E.push(N)}!S&&r&&r.modelContent&&(r.modelContent.get(o).threeGeometries=m)}this.geometryTOchild={},S||u.checkGeometries(m,M),S&&!d&&M&&u.viewer.ndsModel.getMeshManager().setMaterials(M);var Q,X,Y=new THREE.Object3D,_=[];if(S){var l={},Z={},K={};if(i.instances)for(let e=0,t=i.instances.length;e<t;++e)i.instances[e].geometries&&(K[i.instances[e].uuid]={geometries:i.instances[e].geometries,materials:i.instances[e].materials});let t,a={};var $=u.parseNdsModelObject(i.object,l,Z,K,0,a,M);if(r&&r.referenceModels&&r.referenceModels.has(o)){let e=r.referenceModels.get(o),n=r.modelReferenceCount.get(o),i=r=>{var e=this.getRefUUID(r.uuid,n);"Body"===r.type&&this.viewer.brepManager.bindReference(e,r.uuid),a[r.uuid]&&(a[e]=a[r.uuid],delete a[r.uuid]),r.referenceNode=r.uuid,r.uuid=e;for(let e=0,t=r.children.length;e<t;++e)i(r.children[e]);if(r.pmiuuid)for(let e=0,t=r.pmiuuid.length;e<t;++e)r.pmiuuid[e]=this.getRefUUID(r.pmiuuid[e],n)};1<n&&i($),t=e.worldMatrix,!e.parent&&e.lastParent&&e.lastParent.add(e),u.viewer.ndsModel.attachBodyNode(e,$,l,Z)}else u.viewer.ndsModel.setRootBodyNode($,l,Z);u.viewer.ndsModel.setBodyNodeMaterials(a),Y.boundingBox=new THREE.Box3,i.bbox&&(Y.boundingBox.min.fromArray(i.bbox,0),Y.boundingBox.max.fromArray(i.bbox,3)),t&&Y.boundingBox.applyMatrix4(t);for(let e=0,t=$.children.length;e<t;++e)$.children[e].referenceModel&&(_[_.length]=$.children[e]);if(0<this.SDFMaker.lines.length){var ee=new THREE.Group;ee.name="dashLine";for(T=0;T<this.SDFMaker.lines.length;T++)ee.add(this.SDFMaker.lines[T]);this.viewer.scene.add(ee)}}else{w=u.parseObject(i.object,m,M,o,g);if(r&&r.referenceModels&&r.referenceModels.has(o)){Z=r.referenceModels.get(o);Y.matrix.copy(Z.worldMatrix),Y.matrixAutoUpdate=!1;let e=r.modelReferenceCount.get(o),n=r=>{r.uuid=this.getRefUUID(r.uuid,e),r.name&&(r.name=this.getRefUUID(r.name,e));for(let e=0,t=r.children.length;e<t;++e)n(r.children[e])};1<e&&n(w)}if(this.SDFMaker.HaveSDF()&&this.viewer.is2DModel&&this.viewer.modelContentVersion<2){w.add(this.SDFMaker.CreateMesh());for(T=0;T<this.SDFMaker.lines.length;T++)w.add(this.SDFMaker.lines[T])}else w.updateMatrixWorld(!0);Y.add(w),Y.updateMatrixWorld(!0)}(h=Y).isPmi=r.loadingPmi,i.solidAnimations&&0<(Q=u.parseSolidAnimations(i.solidAnimations,m,M)).length&&this.viewer&&(this.viewer.animationsManager.bHasSolidAnimation=!0,this.viewer.animationsManager.initSolidAnimations(Y,Q)),this.viewer&&(this.viewer.materialsSetting||(this.viewer.materialsSetting=new ae(this.viewer)),r.loadingPmi||this.viewer.materialsSetting.initMaterialsInfo(M)),t&&t(Y,i.lightsPreset,!1,_.length?_:null,o),i.rendersetting&&(X=a+i.rendersetting,this.loader.load(null,X,function(e){n&&n(JSON.parse(e))}));performance.now().toFixed(0);if(r.loadingPmi||(re.loadContext.nTotalBufferChunksCount+=x),0===x&&s&&0===re.loadContext.unloadReferenceModels.length&&0===re.loadContext.loadingReferenceModels.size&&0===re.loadContext.nUnHandledLoadingModels&&re.loadContext.nBufferChunkLoadedCount===re.loadContext.nTotalBufferChunksCount&&s(!0,!0),d)!r.loadingPmi&&0<x&&(re.loadContext.nBufferChunkLoadedCount+=x,s&&(d=0===re.loadContext.unloadReferenceModels.length&&0===re.loadContext.loadingReferenceModels.size&&0===re.loadContext.nUnHandledLoadingModels&&re.loadContext.nBufferChunkLoadedCount===re.loadContext.nTotalBufferChunksCount,s(d,!0)));else for(k=0;k<x;++k){var f=B[k],N=S?E[k]:null,te=a+i.bufferchunks[k].buffer,b={useWorker:!0,bufferlenth:i.bufferchunks[k].bufferlenth,compress:i.compress,bufferIndex:k,geometriesArray:S?null:f,ndsGeometriesArray:N};null!=i.bufferchunks[k].compress&&(b.compress=i.bufferchunks[k].compress),i.bufferchunks[k].jsonUrl&&(te=this.extractUrlBase(i.bufferchunks[k].jsonUrl)+i.bufferchunks[k].buffer),0==i.bufferchunks[k].isChunk&&(te=i.bufferchunks[k].buffer),k<u.maxRequestNum?(v=new ne({objectIdType:i.objectIdType,materialIdType:i.materialIdType,geomIdType:i.geomIdType,instanceIdType:i.instanceIdType}),r.loadingPmi?v.load(null,te,c,b):v.load(null,te,c,b,A,F)):u.chunkRequestQueue.push({url:te,parameters:b}),S&&(u.viewer.ndsModel.getGeomManager().bufferChunk[te]=b)}return Y}},parseSolidAnimations:function(e,t,r){if(e.length<=0)return null;for(var n,i,a,o=[],s=0;s<e.length;s++)null!=e[s].fps&&(e[s].fps=parseFloat(e[s].fps)),null!=e[s].duration&&(e[s].duration=parseFloat(e[s].duration)),null!=e[s].fps&&null!=e[s].duration&&(e[s].fps<=0||e[s].duration<=0||(n=THREE.AnimationClip.parse(e[s]),null!=e[s].uuid&&(n.uuid=e[s].uuid),null!=e[s].fps&&(n.fps=parseFloat(e[s].fps)),e[s].animationObject&&(i=this.parseObject(e[s].animationObject,t,r,null),(a=new THREE.Object3D).add(i),n.animationScene=new THREE.Scene,n.animationScene.autoUpdate=!1,n.animationScene.add(a)),o.push(n)));return o},parseDecals:function(e,t,r){if(void 0!==t&&void 0!==r){var n={},i={},a={},o=new THREE.Object3D;o.type="decals",r.add(o),r.updateMatrixWorld(!0);for(var s=0;s<t.length;++s){var d,l=void 0,l=new(void 0!==this.viewer.convertPhongToPBR&&this.viewer.convertPhongToPBR?THREE.MeshStandardMaterial:THREE.MeshPhongMaterial);n[t[s].uuid]=t[s],l.map=(new m).loadTexture(l,i,e+t[s].textureFile,void 0,void 0,NDS.TextureLoadingManager.onError),a[t[s].uuid]=l,void 0===t[s].opacity||(d=parseFloat(t[s].opacity))<1&&(l.transparent=!0,l.opacity=d)}this.traverseDecals(o,r,a,n),o.matrixAutoUpdate=!1,o.matrixWorldNeedsUpdate=!1,o.updateMatrixWorld(!0)}},traverseDecals:function(e,t,r,n){if(null!=t&&t instanceof THREE.Object3D&&!(t instanceof THREE.Light))if(void 0===t.decals){if(null!=t.children)for(u=t.children,h=0;h<u.length;++h)this.traverseDecals(e,t.children[h],r,n)}else if(t.hasOwnProperty("geometry"))for(var i=0;i<t.decals.length;++i){var a=n[t.decals[i]],o=r[t.decals[i]],s=new THREE.Vector3(a.origin[0],a.origin[1],a.origin[2]),d=new THREE.Vector3(a.vecX[0],a.vecX[1],a.vecX[2]),l=new THREE.Vector3(a.vecY[0],a.vecY[1],a.vecY[2]);s.addScaledVector(d,.5),s.addScaledVector(l,.5),"MapPlanar"===a.mappingType&&(a=new c(t,s,d,l,a.projectionType),(o=new THREE.Mesh(a,o)).matrixAutoUpdate=!1,o.matrixWorldNeedsUpdate=!1,o.updateMatrixWorld(!0),e.add(o))}else for(var u=t.children,h=0;h<u.length;++h)this.traverseChild(t.decals,e,t.children[h],r,n)},traverseChild:function(e,t,r,n,i){if(null!=r&&r instanceof THREE.Object3D&&!(r instanceof THREE.Light))if(void 0===e){if(null!=r.children)for(var a=r.children,o=0;o<a.length;++o)this.traverseChild(e,t,r.children[o],n,i)}else if(r.hasOwnProperty("geometry"))for(var s=0;s<e.length;++s){var d=i[e[s]],l=n[e[s]],u=new THREE.Vector3(d.origin[0],d.origin[1],d.origin[2]),h=new THREE.Vector3(d.vecX[0],d.vecX[1],d.vecX[2]),m=new THREE.Vector3(d.vecY[0],d.vecY[1],d.vecY[2]);u.addScaledVector(h,.5),u.addScaledVector(m,.5),"MapPlanar"===d.mappingType&&(d=new c(r,u,h,m,d.projectionType),(l=new THREE.Mesh(d,l)).matrixAutoUpdate=!1,l.matrixWorldNeedsUpdate=!1,l.updateMatrixWorld(!0),t.add(l))}},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new ie,n=new THREE.BufferGeometryLoader,i=0,a=e.length;i<a;i++){var o,s=e[i];switch(s.type){case"PlaneGeometry":o=new THREE.PlaneGeometry(s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=n.parse(s.data);break;case"Geometry":o=r.parse(s.data).geometry}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e){var t={};if(void 0!==e)for(var r=new THREE.MaterialLoader,n=0,i=e.length;n<i;n++){var a=e[n],o=r.parse(a);o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),t[a.uuid]=o}return t},parseLink:function(e,o,s,d,t){var l=this,u=this.extractUrlBase(t)+e.linkPath;this.manager.itemStart(),this.loader.load(null,u,function(e){var t=JSON.parse(e);if(t.buffer){var r={};for(var n=[],i=0;i<t.geometries.length;++i)"BufferGeometry"===t.geometries[i].type?n.push(new THREE.BufferGeometry):"Geometry"===t.geometries[i].type&&n.push(new THREE.Geometry),r[t.geometries[i].uuid]=n[i];var e=l.extractUrlBase(u)+t.buffer,a={useWorker:!0,bufferlenth:t.bufferlenth,compress:t.compress,geometriesArray:n};(new ne).load(null,e,function(){l.manager.itemEnd()},a),l.checkGeometries(r,d);a=l.parseObject(t.object,r,d,u);o.add(a),l.onLinkComplete(o.linkID)}else{a=l.parseObject(t.object,s,d,u);o.add(a),l.onLinkComplete(o.linkID)}})},recordLink:function(e,t){return null==this.linkMap[e]&&(this.linkMap[e]=t,!(this.linkDoneMap[e]=!1))},addWaitingLink:function(e,t){var r=this.linkWaitingArray[e];null==r&&(this.linkWaitingArray[e]=r=[]),r.push(t)},cloneObject:function(e,t){var r=null;if(null!=e.linkID?((r=e.clone(void 0,t=!1)).linkID=e.linkID,this.isLinkComplete(r.linkID)?this.processLoadedLink(r,this.getCompleteLink(r.linkID)):this.addWaitingLink(r.linkID,r)):r=e.clone(void 0,!1),r.uuid=e.uuid,r.type=e.type,!0===t)for(var n=0;n<e.children.length;n++){var i=e.children[n];r.add(this.cloneObject(i,t))}return r},processLoadedLink:function(e,t){for(var r=0;r<t.children.length;r++)e.add(this.cloneObject(t.children[r],!0))},isLinkComplete:function(e){return this.linkDoneMap[e]},getCompleteLink:function(e){return this.linkMap[e]},onLinkComplete:function(e){this.linkDoneMap[e]=!0;for(var t=this.linkWaitingArray[e],r=0;r<t.length;r++)this.processLoadedLink(t[r],this.linkMap[e])},parseObject:(h=new THREE.Matrix4,function(e,t,r,n,i){var a=n;switch(e.type){case"Scene":s=new THREE.Scene;break;case"PerspectiveCamera":s=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":s=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":s=new THREE.AmbientLight(e.color);break;case"DirectionalLight":s=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":s=new THREE.PointLight(e.color,e.intensity,e.distance);break;case"SpotLight":s=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent);break;case"HemisphereLight":s=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":if("TextBufferGeometry"!==(d=t[e.geometry]).type||this.viewer.is2DModel){if("TextBufferGeometry"===d.type&&this.viewer.is2DModel)return null;36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36));var o=r[e.material];i&&i[e.geometry]&&o.mat&&(o.mat.vertexColors=THREE.VertexColors),++o.refCount,void 0===d&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===o&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Mesh(d,o.mat)}else var o=this.SDFMaker.GetMaterial(d.styleId),s=new THREE.Mesh(d,o);null!=d.urlIndex&&(s.urlIndex=d.urlIndex);break;case"Line":var d=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(o=r[e.material]).refCount,void 0===d&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===o&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Line(d,o.mat),null!=d.urlIndex&&(s.urlIndex=d.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==S.tangentEdgeVisible&&(s.visible=!1));break;case"LineStrip":d=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(o=r[e.material]).refCount,void 0===d&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===o&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Line(d,o.mat,THREE.LineStrip),null!=d.urlIndex&&(s.urlIndex=d.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==S.tangentEdgeVisible&&(s.visible=!1));break;case"LinePieces":d=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(o=r[e.material]).refCount,void 0===d&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===o&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.LineSegments(d,o.mat),null!=d.urlIndex&&(s.urlIndex=d.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==S.tangentEdgeVisible&&(s.visible=!1));break;case"Sprite":36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),void 0===(o=r[e.material])&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Sprite(o.mat);break;case"Group":s=new THREE.Group;break;case"Link":(s=new THREE.Object3D).type="Link",s.linkID=e.linkID,this.recordLink(e.linkID,s)?this.parseLink(e,s,t,r,a):this.isLinkComplete(e.linkID)?this.processLoadedLink(s,this.getCompleteLink(e.linkID)):this.addWaitingLink(e.linkID,s);break;default:s=new THREE.Object3D,void 0!==e.type&&(s.type=e.type)}if(void 0!==e.uuid?s.uuid=e.uuid:(s.uuid=this.treeIndex.toString(),++this.treeIndex),void 0!==e.name?s.name=e.name:s.name=s.uuid,void 0!==e.propertyfile&&(s.propertyfile=e.propertyfile,this.viewer.containProperty=!0),void 0!==e.matrix?(h.fromArray(e.matrix),h.decompose(s.position,s.quaternion,s.scale)):(void 0!==e.position&&s.position.fromArray(e.position),void 0!==e.rotation&&s.rotation.fromArray(e.rotation),void 0!==e.scale&&s.scale.fromArray(e.scale)),s.updateMatrixWorld(!0),s.originMatrixWorld=s.matrixWorld.clone(),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.userData&&(s.userData=e.userData),void 0!==e.decals&&(s.decals=e.decals),!this.viewer.isPartPmi()&&!this.viewer.isAssemblyPmi()||this.viewer.pmiVisible||"PMI"==s.type||"Object3D"==s.type||(s.visible=!1),void 0!==e.children)for(var l=0;l<e.children.length;++l){var u=this.parseObject(e.children[l],t,r,n,i);null!=u&&s.add(u)}return s.updateMatrix(),s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1,s}),setVisibleOfChild:function(e){for(var t in e.children)e.children[t].visible=!1,this.setVisibleOfChild(e.children[t])},parseNdsModelObject:function(e,r,t,n,i,a,o,s,d){var l=new f;if(l.unload=!1,void 0!==e.uuid?(l.uuid=e.uuid,36===l.uuid.length&&"-"==l.uuid.charAt(8)&&"-"==l.uuid.charAt(13)&&"-"==l.uuid.charAt(18)&&"-"==l.uuid.charAt(23)&&(l.uuid=l.uuid.slice(0,8)+l.uuid.slice(9,13)+l.uuid.slice(14,18)+l.uuid.slice(19,23)+l.uuid.slice(24,36)),l.uuid=l.uuid.toLowerCase()):(l.uuid=this.treeIndex.toString(),++this.treeIndex),void 0!==e.objectid?(l.objectid="o_"+re.loadContext.numObject++,this.viewer.ndsModel.objectidTouuid[e.objectid]=l.uuid):this.viewer.ndsModel.objectidTouuid&&(this.viewer.ndsModel.objectidTouuid=null),void 0!==e.name?l.name=e.name:l.name=l.uuid,e.referenceModel&&(l.referenceModel=e.referenceModel,e.configName?l.configName=e.configName:l.configName="0"),e.material&&a&&o&&o[e.material]&&(a[l.uuid]=o[e.material].mat),void 0!==e.propertyfile?(l.propertyfile=l.referenceModel?l.referenceModel+"/"+l.configName+"/"+e.propertyfile:e.propertyfile,this.viewer.containProperty=!0):!l.referenceModel&&d&&(l.propertyfile=d,this.viewer.containProperty=!0),this.viewer.useUnvisibleList||void 0===e.visible||(l.visible=e.visible),void 0!==e.fixed&&(l.fixed=e.fixed),void 0!==e.matrix&&(l.matrix=e.matrix.slice(0)),void 0!==e.worldMatrix&&(l.worldMatrix=e.worldMatrix.clone()),l.type=e.type,null!=e.pmiuuid&&(l.pmiuuid=[].concat(e.pmiuuid),"Assembly"!==e.type&&"Model"!==e.type?(this.viewer.haspartPMI=!0,this.viewer.PartPMIuuid.push(l.pmiuuid)):this.viewer.hasAssemblyPMI=!0),void 0!==e.children){"Body"===e.children[0].type&&(i=0);for(var u=0;u<e.children.length;u++){var h,m=e.children[u];if("Mesh"!==m.type&&"Line"!==m.type&&"LinePieces"!==m.type){if("Instance"!==m.type)"RefPoint"!==m.type&&"RefAxis"!==m.type&&"RefPlane"!==m.type?((h=this.parseNdsModelObject(m,r,t,n,i,a,o,s,l.propertyfile)).parent=l,"Body"===m.type&&i++,("Body"===m.type||!S.inBIMContext||h.children&&0!=h.children.length)&&(m.referenceModel&&(l.hasReferenceModel=!0),void 0!==l.visible&&0==l.visible&&(h.visible=!1,this.setVisibleOfChild(h)),l.children.push(h),"CoordSystem"===m.type&&m.visible&&l.setComponentCoordinateSysVisibility(!0))):(h={parentNode:l,uuid:m.uuid,type:m.type,name:m.name,visible:m.visible,coords:m.points},this.viewer.ndsModel.addReferenceEntity(h),"RefAxis"===m.type&&m.visible&&l.setComponentRefAxisVisibility(!0),"RefPlane"===m.type&&m.visible&&l.setComponentRefPlaneVisibility(!0));else if(n.hasOwnProperty(m.instance)){var c=n[m.instance];for(let t=0,e=c.geometries.length;t<e;++t){r[l.uuid+":"+t]=c.geometries[t];let e=c.materials[t];36===e.length&&"-"==e.charAt(8)&&"-"==e.charAt(13)&&"-"==e.charAt(18)&&"-"==e.charAt(23)&&(e=e.slice(0,8)+e.slice(9,13)+e.slice(14,18)+e.slice(19,23)+e.slice(24,36)),this.viewer.ndsModel.getMeshManager().materials[e].refCount++}}}else"Line"!==m.type&&"LinePieces"!==m.type||!m.tangentEdgeObject||(t[m.geometry]=!0),36===m.material.length&&"-"==m.material.charAt(8)&&"-"==m.material.charAt(13)&&"-"==m.material.charAt(18)&&"-"==m.material.charAt(23)&&(m.material=m.material.slice(0,8)+m.material.slice(9,13)+m.material.slice(14,18)+m.material.slice(19,23)+m.material.slice(24,36)),this.viewer.ndsModel.getMeshManager().materials[m.material].refCount++,r[m.uuid]=m.geometry}}return"Body"!=e.type?void 0!==e.fileguid&&(l.fileguid=e.fileguid,this.viewer.ndsModel.fileguidTouuid[l.fileguid]||(this.viewer.ndsModel.fileguidTouuid[l.fileguid]=[]),"Model"==e.type&&1==e.children.length&&"Part"==e.children[0].type?this.viewer.ndsModel.fileguidTouuid[l.fileguid].push(e.children[0].uuid):this.viewer.ndsModel.fileguidTouuid[l.fileguid].push(l.uuid)):l.BodyfileID=i,l}},re.overridePrototype(u.prototype),re.currentTypeName="Viewer",re.overrideFunction("initViewer",function(e){this.inited&&!e||(this.brepLoadIndex=0,this.oldenableBroadcast=NDSWebViewer.SETTING.enableBroadcast,NDSWebViewer.SETTING.enableBroadcast=!1,this.explodeObjects=[],this.inited=!0),delete this.parameters.isBundledType,delete this.parameters.referenceModels,delete this.parameters.modelReferenceCount,delete this.parameters.modelContent,delete this.parameters.configurations;let a=this;this.loadCallback=function(e,t,r,n,i){if(a.ndsModel&&1!=e.isPmi){re.loadContext.nUnHandledLoadingModels--,!a.configurations&&a.parameters.configurations&&(a.configurations=a.parameters.configurations),re.loadContext.loadingReferenceModels&&i&&re.loadContext.loadingReferenceModels.delete(i),n&&(re.loadContext.unloadReferenceModels=re.loadContext.unloadReferenceModels.concat(n)),a.continueLoadReferenceModel();n=!1;if(0===re.loadContext.nUnHandledLoadingModels&&0===re.loadContext.unloadReferenceModels.length&&0===re.loadContext.loadingReferenceModels.size&&(a.controls.SetBoundingBoxUpdated(!1),a.camera.setOrginalCameraInfo(null),n=!0),a.ndsModelObjectTreeLoaded=!0,e.isLoadFailed)return a.ndsModelBvhLoaded=!0,void(a.ndsModelPMILoaded=!0);a.ndsModelBvhLoaded&&a.ndsModelPMILoaded&&(a.prepareModelForRendering(e,n),a.setBodyNodeMaterialsInfo(a.bodyNodeUUidToMaterial)),a.modelRootObject&&!e.boundingBox.isEmpty()&&(a.modelRootObject.boundingBox.isEmpty()?(a.modelRootObject.boundingBox.copy(e.boundingBox),a.resetCamera({})):(a.modelRootObject.boundingBox.expandByPoint(e.boundingBox.min),a.modelRootObject.boundingBox.expandByPoint(e.boundingBox.max)))}e instanceof THREE.Scene?(a.scene=e,a.modelRootObject=e):e.isPmi?(a.pmiObject||(a.pmiObject=new THREE.Object3D,a.pmiObject.name="pmiobject"),a.pmiObject.add(e),a.dispatchEvent({type:"PMIInfoEvent",PMI:!0}),a.pmiVisible&&a.pmiObject.parent!==a.scene&&a.scene.add(a.pmiObject),a.ndsModelPMILoaded=!0,a.ndsModelBvhLoaded&&a.ndsModelObjectTreeLoaded&&a.setBodyNodeMaterialsInfo(a.bodyNodeUUidToMaterial)):a.modelRootObject?(a.ndsModel||e.children[0].children[0]&&a.modelRootObject.children[0].children[0].add(e.children[0].children[0]),a.selectionManager.computeTargetList(a.scene)):(a.ndsModel||a.scene.add(e),a.modelRootObject=e),e.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(null!=e.urlIndex?a.meshLoadedUUIDs.push({uuid:e.uuid,urlIndex:e.urlIndex}):a.meshLoadedUUIDs.push({uuid:e.uuid,urlIndex:0}))}),a.addLights(a.scene),void 0!==r&&(a.bGeoBufferChunkLoaded=r)}}),re.overrideFunction("continueLoadReferenceModel",function(){let i=this;if(i.modelInfo[0])for(;0<re.loadContext.unloadReferenceModels.length;){i.parameters.referenceModels||(i.parameters.referenceModels=new Map,i.parameters.modelReferenceCount=new Map,i.parameters.modelContent=new Map,i.parameters.configurations=new Map),i.ndsModel.bvh.isDynamicBVH||(i.ndsModel.bvh=new l(i.ndsModel.bvh));let n=i.modelInfo[0].url.trim(),r=n.split(/['/','\\']+/);n="";for(let e=0,t=r.length-3;e<t;++e)0===e&&(r[e].toLowerCase().includes("http")||r[e].toLowerCase().includes("file"))?n+=r[e]+"//":n+=r[e]+"/";const s=re.loadContext.unloadReferenceModels[0];var e=r=>{if(re.loadContext.loadingReferenceModels.has(r))return!1;i.parameters.modelReferenceCount.has(r)||re.loadContext.loadingReferenceModels.add(r),re.loadContext.unloadReferenceModels.splice(0,1),s.worldMatrix||(s.worldMatrix=i.ndsModel.calculateNodeWorldMatrix(s));let e=s.parent;for(;!e.dynamicBvhNode&&e.parent;)e=e.parent;let n=e.dynamicBvhNode||i.ndsModel.bvh.root;setTimeout(()=>{i.parameters.referenceModels.set(r,s),i.parameters.modelContent.has(r)||i.parameters.modelContent.set(r,{});var e=new u(i.loadingManager,i);let t=1;i.parameters.modelReferenceCount.has(r)&&(t=i.parameters.modelReferenceCount.get(r)+1),i.parameters.modelReferenceCount.set(r,t),e.load(i.parameters,r,null,null,i.loadCallback,i.renderSettingCallback,i.bufferChunkCallback,void 0,i.loadErrorCallback,{isReferenceModel:!0,worldMatrix:s.worldMatrix,parentBvhNode:n,referenceModel:s,referenceCount:t})},0),re.loadContext.nUnHandledLoadingModels++};if("0"===s.configName){if(!e(n+s.referenceModel+"/0/model.js"))break}else{if(!i.parameters.configurations.has(s.referenceModel)){for(let e=0,t=re.loadContext.unloadReferenceModels.length;e<t;++e)if(!i.parameters.configurations.has(s.referenceModel)){var a=n+s.referenceModel+"/Configurations.json";const d=this;fetch(a).then(e=>e.json()).then(e=>{i.parameters.configurations.set(s.referenceModel,e),d.continueLoadReferenceModel()}).catch(e=>{i.parameters.configurations.set(s.referenceModel,{Configurations:[]}),d.continueLoadReferenceModel()}),i.parameters.configurations.set(s.referenceModel,{loading:!0})}break}{var o=i.parameters.configurations.get(s.referenceModel);if(o.loading)break;let r="0";o=o.Configurations;for(let e=0,t=o.length;e<t;++e)if(o[e].Name===s.configName){r=o[e].Folder;break}if(!e(n+s.referenceModel+"/"+r+"/model.js"))break}}}return re.loadContext.unloadReferenceModels.length}),re.overrideFunction("getObjectProperty",function(e,t,r){let i=this;var a=new Set,o=new Set;null==i.propertyManager&&(i.propertyManager=new PropertyManager(i)),r=r||!1,function e(t){if(!t.isHidden()&&t.visible){var r=t.type.toLowerCase();"body"!==r&&!t.leafBodyAttri||t.isHidden()||t.isReferenceEntity()||t.isCoordinate()||a.has(t)||a.add(t),"model"!==r&&"assembly"!==r&&"part"!==r||("model"===r&&0<=t.id&&t.leafBodyAttri?a.add(t):0<t.children.length&&"part"===r&&!i.ndsModel.isBodyAllChildHidden(t)&&(o.has(t.uuid)||o.add(t.uuid)));for(var n=0;n<t.children.length;++n)e(t.children[n])}}(e);var n,s=[];for(n of a)s.push(n);var d={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:o.size,bodyNum:s.length,unit:i.modelUnit,boundingboxVolume:0},l=new THREE.Box3;if(i.brepManager)for(var u=0;u<s.length;++u){var h=s[u],m=i.brepManager.GetBodyVolumeAndArea(h.uuid),c=i.ndsModel.getBodyBoundingBox(h),f=h.isHidden();m?f||(d.area+=m.area,d.volume+=m.volume,c&&!c.isEmpty()&&(l.expandByPoint(c.max),l.expandByPoint(c.min))):this.productDataMap&&(h=s[u],(m=this.productDataMap[h.uuid])&&!f&&(d.area+=m.area,d.volume+=m.volume,!c||isNaN(c.max.x)||c.isEmpty()||(l.expandByPoint(c.max),l.expandByPoint(c.min))))}else if(this.productDataMap)for(var g=0;g<s.length;++g){h=s[g],m=this.productDataMap[h.uuid],c=this.ndsModel.getBodyBoundingBox(h),f=h.isHidden();m&&!f&&(d.area+=m.area,d.volume+=m.volume,!c||isNaN(c.max.x)||c.isEmpty()||(l.expandByPoint(c.max),l.expandByPoint(c.min)))}this.productData&&(d.pmiNum=this.productData.datas[0].pmiNum),!this.productData||e.uuid!=i.ndsModel.rootBodyNode.uuid&&!r||this.ndsModel.isBodyOrSomeChildHidden(e)||(l=this.modelRootObject.boundingBox),d.boundingboxVolume=Math.abs(l.max.x-l.min.x)*Math.abs(l.max.y-l.min.y)*Math.abs(l.max.z-l.min.z),d.boundingbox.x=Math.abs(l.max.x-l.min.x),d.boundingbox.y=Math.abs(l.max.y-l.min.y),d.boundingbox.z=Math.abs(l.max.z-l.min.z);r=i.getDispalyModelUnit(d.volume,d.area);return r&&(d.volume=d.volume*r.scale*r.scale*r.scale,d.area=d.area*r.scale*r.scale,d.boundingbox.x*=r.scale,d.boundingbox.y*=r.scale,d.boundingbox.z*=r.scale,d.boundingboxVolume=d.boundingboxVolume*r.scale*r.scale*r.scale,d.unit=r.unit),i.hasBrepFile()||(d.boundingbox=new THREE.Vector3,d.boundingboxVolume=0),i.propertyManager.getObjectProperty(e,t,d),d})}],i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0);function i(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}var r,n});