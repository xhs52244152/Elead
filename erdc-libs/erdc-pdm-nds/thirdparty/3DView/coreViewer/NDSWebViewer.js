!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSWebViewer=t():e.NDSWebViewer=t()}(window,function(){return o={},r.m=n=[function(e,t,n){var i=n(1);i(i.S,"Object",{create:n(47)})},function(e,t,n){var p=n(6),m=n(43),g=n(19),v=n(20),y=n(35),E="prototype",b=function(e,t,n){var i,r,o,a=e&b.F,s=e&b.G,l=e&b.S,d=e&b.P,c=e&b.B,h=s?p:l?p[t]||(p[t]={}):(p[t]||{})[E],u=s?m:m[t]||(m[t]={}),f=u[E]||(u[E]={});for(i in n=s?t:n)r=((o=!a&&h&&void 0!==h[i])?h:n)[i],o=c&&o?y(r,p):d&&"function"==typeof r?y(Function.call,r):r,h&&v(h,i,r,e&b.U),u[i]!=r&&g(u,i,o),d&&f[i]!=r&&(f[i]=r)};p.core=m,b.F=1,b.G=2,b.S=4,b.P=8,b.B=16,b.W=32,b.U=64,b.R=128,e.exports=b},function(e,t,n){var i=n(10).f,r=Function.prototype,o=/^\s*function ([^ (]*)/;"name"in r||n(8)&&i(r,"name",{configurable:!0,get:function(){try{return(""+this).match(o)[1]}catch(e){return""}}})},function(e,t,n){"use strict";n(92)("sub",function(e){return function(){return e(this,"sub","","")}})},function(e,t,n){"use strict";var i=n(1),r=n(75)(!1),o=[].indexOf,a=!!o&&1/[1].indexOf(1,-0)<0;i(i.P+i.F*(a||!n(49)(o)),"Array",{indexOf:function(e){return a?o.apply(this,arguments)||0:r(this,e,arguments[1])}})},function(e,t,n){n(30)("Float32",4,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t){e=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(e,t,n){var i=n(71)("wks"),r=n(34),o=n(6).Symbol,a="function"==typeof o;(e.exports=function(e){return i[e]||(i[e]=a&&o[e]||(a?o:r)("Symbol."+e))}).store=i},function(e,t,n){e.exports=!n(9)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var i=n(13),r=n(101),o=n(54),a=Object.defineProperty;t.f=n(8)?Object.defineProperty:function(e,t,n){if(i(e),t=o(t,!0),i(n),r)try{return a(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){"use strict";n(59);function i(e){n(20)(RegExp.prototype,s,e,!0)}var r=n(13),o=n(67),a=n(8),s="toString",l=/./[s];n(9)(function(){return"/a/b"!=l.call({source:"a",flags:"b"})})?i(function(){var e=r(this);return"/".concat(e.source,"/","flags"in e?e.flags:!a&&e instanceof RegExp?o.call(e):void 0)}):l.name!=s&&i(function(){return l.call(this)})},function(e,t,n){var i=Date.prototype,r="Invalid Date",o="toString",a=i[o],s=i.getTime;new Date(NaN)+""!=r&&n(20)(i,o,function(){var e=s.call(this);return e==e?a.call(this):r})},function(e,t,n){var i=n(14);e.exports=function(e){if(!i(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){var i=n(27),r=Math.min;e.exports=function(e){return 0<e?r(i(e),9007199254740991):0}},function(e,t,n){for(var i=n(18),r=n(46),o=n(20),a=n(6),s=n(19),l=n(50),n=n(7),d=n("iterator"),c=n("toStringTag"),h=l.Array,u={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},f=r(u),p=0;p<f.length;p++){var m,g=f[p],v=u[g],y=a[g],E=y&&y.prototype;if(E&&(E[d]||s(E,d,h),E[c]||s(E,c,g),l[g]=h,v))for(m in i)E[m]||o(E,m,i[m],!0)}},function(e,t,n){n(30)("Uint8",1,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){"use strict";var i=n(85),r=n(110),o=n(50),a=n(36);e.exports=n(86)(Array,"Array",function(e,t){this._t=a(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,r(1)):r(0,"keys"==t?n:"values"==t?e[n]:[n,e[n]])},"values"),o.Arguments=o.Array,i("keys"),i("values"),i("entries")},function(e,t,n){var i=n(10),r=n(45);e.exports=n(8)?function(e,t,n){return i.f(e,t,r(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var o=n(6),a=n(19),s=n(26),l=n(34)("src"),i="toString",r=Function[i],d=(""+r).split(i);n(43).inspectSource=function(e){return r.call(e)},(e.exports=function(e,t,n,i){var r="function"==typeof n;r&&(s(n,"name")||a(n,"name",t)),e[t]!==n&&(r&&(s(n,l)||a(n,l,e[t]?""+e[t]:d.join(String(t)))),e===o?e[t]=n:i?e[t]?e[t]=n:a(e,t,n):(delete e[t],a(e,t,n)))})(Function.prototype,i,function(){return"function"==typeof this&&this[l]||r.call(this)})},function(e,t,n){n(30)("Uint16",2,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){n=n(1);n(n.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,n){"use strict";var h=n(114),v=n(13),y=n(109),E=n(95),b=n(15),M=n(68),u=n(96),x=Math.min,f=[].push,i="split",w="length",I="lastIndex",S=!!function(){try{return new RegExp("x","y")}catch(e){}}();n(69)("split",2,function(r,o,p,m){var g="c"=="abbc"[i](/(b)*/)[1]||4!="test"[i](/(?:)/,-1)[w]||2!="ab"[i](/(?:ab)*/)[w]||4!="."[i](/(.?)(.?)/)[w]||1<"."[i](/()()/)[w]||""[i](/.?/)[w]?function(e,t){var n=String(this);if(void 0===e&&0===t)return[];if(!h(e))return p.call(n,e,t);for(var i,r,o,a=[],s=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),l=0,d=void 0===t?4294967295:t>>>0,c=new RegExp(e.source,s+"g");(i=u.call(c,n))&&!(l<(r=c[I])&&(a.push(n.slice(l,i.index)),1<i[w]&&i.index<n[w]&&f.apply(a,i.slice(1)),o=i[0][w],l=r,a[w]>=d));)c[I]===i.index&&c[I]++;return l===n[w]?!o&&c.test("")||a.push(""):a.push(n.slice(l)),a[w]>d?a.slice(0,d):a}:"0"[i](void 0,0)[w]?function(e,t){return void 0===e&&0===t?[]:p.call(this,e,t)}:p;return[function(e,t){var n=r(this),i=null==e?void 0:e[o];return void 0!==i?i.call(e,n,t):g.call(String(n),e,t)},function(e,t){var n=m(g,e,this,t,g!==p);if(n.done)return n.value;var i=v(e),r=String(this),n=y(i,RegExp),o=i.unicode,e=(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.unicode?"u":"")+(S?"y":"g"),a=new n(S?i:"^(?:"+i.source+")",e),s=void 0===t?4294967295:t>>>0;if(0==s)return[];if(0===r.length)return null===M(a,r)?[r]:[];for(var l=0,d=0,c=[];d<r.length;){a.lastIndex=S?d:0;var h,u=M(a,S?r:r.slice(d));if(null===u||(h=x(b(a.lastIndex+(S?0:d)),r.length))===l)d=E(r,d,o);else{if(c.push(r.slice(l,d)),c.length===s)return c;for(var f=1;f<=u.length-1;f++)if(c.push(u[f]),c.length===s)return c;d=l=h}}return c.push(r.slice(l)),c}]})},function(e,t,n){var i=n(1);i(i.S+i.F,"Object",{assign:n(140)})},function(e,t,n){var i=n(37);e.exports=function(e){return Object(i(e))}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t){var n=Math.ceil,i=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(0<e?i:n)(e)}},function(e,t,n){n(99)("asyncIterator")},function(e,t,n){"use strict";function i(e){var t=z[e]=A(H[_]);return t._k=e,t}function r(e,t){x(e);for(var n,i=b(t=I(t)),r=0,o=i.length;r<o;)J(e,n=i[r++],t[n]);return e}function o(e){var t=j.call(this,e=S(e,!0));return!(this===W&&l(z,e)&&!l(G,e))&&(!(t||!l(this,e)||!l(z,e)||l(this,k)&&this[k][e])||t)}function a(e,t){if(e=I(e),t=S(t,!0),e!==W||!l(z,t)||l(G,t)){var n=B(e,t);return!n||!l(z,t)||l(e,k)&&e[k][t]||(n.enumerable=!0),n}}var s=n(6),l=n(26),d=n(8),c=n(1),h=n(20),u=n(73).KEY,f=n(9),p=n(71),m=n(55),g=n(34),v=n(7),y=n(100),E=n(99),b=n(123),M=n(79),x=n(13),w=n(14),I=n(36),S=n(54),T=n(45),A=n(47),R=n(125),O=n(63),P=n(10),C=n(46),B=O.f,L=P.f,D=R.f,H=s.Symbol,N=s.JSON,F=N&&N.stringify,_="prototype",k=v("_hidden"),V=v("toPrimitive"),j={}.propertyIsEnumerable,U=p("symbol-registry"),z=p("symbols"),G=p("op-symbols"),W=Object[_],Y="function"==typeof H,X=s.QObject,Z=!X||!X[_]||!X[_].findChild,q=d&&f(function(){return 7!=A(L({},"a",{get:function(){return L(this,"a",{value:7}).a}})).a})?function(e,t,n){var i=B(W,t);i&&delete W[t],L(e,t,n),i&&e!==W&&L(W,t,i)}:L,Q=Y&&"symbol"==typeof H.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof H},J=function(e,t,n){return e===W&&J(G,t,n),x(e),t=S(t,!0),x(n),l(z,t)?(n.enumerable?(l(e,k)&&e[k][t]&&(e[k][t]=!1),n=A(n,{enumerable:T(0,!1)})):(l(e,k)||L(e,k,T(1,{})),e[k][t]=!0),q(e,t,n)):L(e,t,n)},p=function(e){for(var t,n=D(I(e)),i=[],r=0;n.length>r;)l(z,t=n[r++])||t==k||t==u||i.push(t);return i},X=function(e){for(var t,n=e===W,i=D(n?G:I(e)),r=[],o=0;i.length>o;)!l(z,t=i[o++])||n&&!l(W,t)||r.push(z[t]);return r};Y||(h((H=function(){if(this instanceof H)throw TypeError("Symbol is not a constructor!");var t=g(0<arguments.length?arguments[0]:void 0),n=function(e){this===W&&n.call(G,e),l(this,k)&&l(this[k],t)&&(this[k][t]=!1),q(this,t,T(1,e))};return d&&Z&&q(W,t,{configurable:!0,set:n}),i(t)})[_],"toString",function(){return this._k}),O.f=a,P.f=J,n(48).f=R.f=p,n(62).f=o,n(78).f=X,d&&!n(44)&&h(W,"propertyIsEnumerable",o,!0),y.f=function(e){return i(v(e))}),c(c.G+c.W+c.F*!Y,{Symbol:H});for(var K="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),$=0;K.length>$;)v(K[$++]);for(var ee=C(v.store),te=0;ee.length>te;)E(ee[te++]);c(c.S+c.F*!Y,"Symbol",{for:function(e){return l(U,e+="")?U[e]:U[e]=H(e)},keyFor:function(e){if(!Q(e))throw TypeError(e+" is not a symbol!");for(var t in U)if(U[t]===e)return t},useSetter:function(){Z=!0},useSimple:function(){Z=!1}}),c(c.S+c.F*!Y,"Object",{create:function(e,t){return void 0===t?A(e):r(A(e),t)},defineProperty:J,defineProperties:r,getOwnPropertyDescriptor:a,getOwnPropertyNames:p,getOwnPropertySymbols:X}),N&&c(c.S+c.F*(!Y||f(function(){var e=H();return"[null]"!=F([e])||"{}"!=F({a:e})||"{}"!=F(Object(e))})),"JSON",{stringify:function(e){for(var t,n,i=[e],r=1;r<arguments.length;)i.push(arguments[r++]);if(n=t=i[1],(w(t)||void 0!==e)&&!Q(e))return M(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!Q(t))return t}),i[1]=t,F.apply(N,i)}}),H[_][V]||n(19)(H[_],V,H[_].valueOf),m(H,"Symbol"),m(Math,"Math",!0),m(s.JSON,"JSON",!0)},function(e,t,n){"use strict";var f,p,m,g,v,i,h,y,r,E,o,a,b,M,s,l,d,x,w,u,I,S,T,A,R,c,O,P,C,B,L,D,H,N,F,_,k,V,j,U,z,G,W,Y,X,Z,q,Q,J,K,$,ee,te,ne,ie,re,oe,ae,se,le,de,ce,he,ue,fe,pe,me,ge,ve,ye,Ee,be,Me,xe,we,Ie,Se,Te,Ae,Re,Oe,Pe,Ce,Be,Le,De,He,Ne,Fe,_e,ke,Ve,je;n(8)?(f=n(44),p=n(6),m=n(9),g=n(1),v=n(80),i=n(106),h=n(35),y=n(65),r=n(45),E=n(19),o=n(64),a=n(27),b=n(15),M=n(107),s=n(61),l=n(54),d=n(26),x=n(82),w=n(14),u=n(25),I=n(83),S=n(47),T=n(108),A=n(48).f,R=n(84),ke=n(34),Oe=n(7),Ve=n(57),c=n(75),O=n(109),P=n(18),C=n(50),B=n(87),L=n(88),D=n(81),H=n(130),N=n(10),F=n(63),_=N.f,k=F.f,V=p.RangeError,j=p.TypeError,U=p.Uint8Array,G="Shared"+(z="ArrayBuffer"),W="BYTES_PER_ELEMENT",Y="prototype",n=Array[Y],X=i.ArrayBuffer,Z=i.DataView,q=Ve(0),Q=Ve(2),J=Ve(3),K=Ve(4),$=Ve(5),ee=Ve(6),te=c(!0),ne=c(!1),ie=P.values,re=P.keys,oe=P.entries,ae=n.lastIndexOf,se=n.reduce,le=n.reduceRight,de=n.join,ce=n.sort,he=n.slice,ue=n.toString,fe=n.toLocaleString,pe=Oe("iterator"),me=Oe("toStringTag"),ge=ke("typed_constructor"),ve=ke("def_constructor"),n=v.CONSTR,ye=v.TYPED,Ee=v.VIEW,be="Wrong length!",Me=Ve(1,function(e,t){return Te(O(e,e[ve]),t)}),xe=m(function(){return 1===new U(new Uint16Array([1]).buffer)[0]}),we=!!U&&!!U[Y].set&&m(function(){new U(1).set({})}),Ie=function(e,t){e=a(e);if(e<0||e%t)throw V("Wrong offset!");return e},Se=function(e){if(w(e)&&ye in e)return e;throw j(e+" is not a typed array!")},Te=function(e,t){if(!(w(e)&&ge in e))throw j("It is not a typed array constructor!");return new e(t)},Ae=function(e,t){return Re(O(e,e[ve]),t)},Re=function(e,t){for(var n=0,i=t.length,r=Te(e,i);n<i;)r[n]=t[n++];return r},Oe=function(e,t,n){_(e,t,{get:function(){return this._d[n]}})},Pe=function(e){var t,n,i,r,o,a,s=u(e),l=arguments.length,d=1<l?arguments[1]:void 0,c=void 0!==d,e=R(s);if(null!=e&&!I(e)){for(a=e.call(s),i=[],t=0;!(o=a.next()).done;t++)i.push(o.value);s=i}for(c&&2<l&&(d=h(d,arguments[2],2)),t=0,n=b(s.length),r=Te(this,n);t<n;t++)r[t]=c?d(s[t],t):s[t];return r},Ce=function(){for(var e=0,t=arguments.length,n=Te(this,t);e<t;)n[e]=arguments[e++];return n},Be=!!U&&m(function(){fe.call(new U(1))}),Le=function(){return fe.apply(Be?he.call(Se(this)):Se(this),arguments)},De={copyWithin:function(e,t){return H.call(Se(this),e,t,2<arguments.length?arguments[2]:void 0)},every:function(e){return K(Se(this),e,1<arguments.length?arguments[1]:void 0)},fill:function(e){return D.apply(Se(this),arguments)},filter:function(e){return Ae(this,Q(Se(this),e,1<arguments.length?arguments[1]:void 0))},find:function(e){return $(Se(this),e,1<arguments.length?arguments[1]:void 0)},findIndex:function(e){return ee(Se(this),e,1<arguments.length?arguments[1]:void 0)},forEach:function(e){q(Se(this),e,1<arguments.length?arguments[1]:void 0)},indexOf:function(e){return ne(Se(this),e,1<arguments.length?arguments[1]:void 0)},includes:function(e){return te(Se(this),e,1<arguments.length?arguments[1]:void 0)},join:function(e){return de.apply(Se(this),arguments)},lastIndexOf:function(e){return ae.apply(Se(this),arguments)},map:function(e){return Me(Se(this),e,1<arguments.length?arguments[1]:void 0)},reduce:function(e){return se.apply(Se(this),arguments)},reduceRight:function(e){return le.apply(Se(this),arguments)},reverse:function(){for(var e,t=this,n=Se(t).length,i=Math.floor(n/2),r=0;r<i;)e=t[r],t[r++]=t[--n],t[n]=e;return t},some:function(e){return J(Se(this),e,1<arguments.length?arguments[1]:void 0)},sort:function(e){return ce.call(Se(this),e)},subarray:function(e,t){var n=Se(this),i=n.length,e=s(e,i);return new(O(n,n[ve]))(n.buffer,n.byteOffset+e*n.BYTES_PER_ELEMENT,b((void 0===t?i:s(t,i))-e))}},He=function(e,t){return Ae(this,he.call(Se(this),e,t))},Ne=function(e){Se(this);var t=Ie(arguments[1],1),n=this.length,i=u(e),r=b(i.length),o=0;if(n<r+t)throw V(be);for(;o<r;)this[t+o]=i[o++]},Fe={entries:function(){return oe.call(Se(this))},keys:function(){return re.call(Se(this))},values:function(){return ie.call(Se(this))}},_e=function(e,t){return w(e)&&e[ye]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},ke=function(e,t){return _e(e,t=l(t,!0))?r(2,e[t]):k(e,t)},Ve=function(e,t,n){return!(_e(e,t=l(t,!0))&&w(n)&&d(n,"value"))||d(n,"get")||d(n,"set")||n.configurable||d(n,"writable")&&!n.writable||d(n,"enumerable")&&!n.enumerable?_(e,t,n):(e[t]=n.value,e)},n||(F.f=ke,N.f=Ve),g(g.S+g.F*!n,"Object",{getOwnPropertyDescriptor:ke,defineProperty:Ve}),m(function(){ue.call({})})&&(ue=fe=function(){return de.call(this)}),je=o({},De),o(je,Fe),E(je,pe,Fe.values),o(je,{slice:He,set:Ne,constructor:function(){},toString:ue,toLocaleString:Le}),Oe(je,"buffer","b"),Oe(je,"byteOffset","o"),Oe(je,"byteLength","l"),Oe(je,"length","e"),_(je,me,{get:function(){return this[ye]}}),e.exports=function(e,d,t,i){function c(e,t){_(e,t,{get:function(){return function(e,t){e=e._d;return e.v[n](t*d+e.o,xe)}(this,t)},set:function(e){return function(e,t,n){e=e._d;i&&(n=(n=Math.round(n))<0?0:255<n?255:255&n),e.v[r](t*d+e.o,n,xe)}(this,t,e)},enumerable:!0})}var h=e+((i=!!i)?"Clamped":"")+"Array",n="get"+e,r="set"+e,u=p[h],o=u||{},a=u&&T(u),s=!u||!v.ABV,e={},l=u&&u[Y];s?(u=t(function(e,t,n,i){y(e,u,h,"_d");var r,o,a=0,s=0;if(w(t)){if(!(t instanceof X||(l=x(t))==z||l==G))return ye in t?Re(u,t):Pe.call(u,t);var l=t,s=Ie(n,d),n=t.byteLength;if(void 0===i){if(n%d)throw V(be);if((r=n-s)<0)throw V(be)}else if(n<(r=b(i)*d)+s)throw V(be);o=r/d}else o=M(t),l=new X(r=o*d);for(E(e,"_d",{b:l,o:s,l:r,e:o,v:new Z(l)});a<o;)c(e,a++)}),l=u[Y]=S(je),E(l,"constructor",u)):m(function(){u(1)})&&m(function(){new u(-1)})&&B(function(e){new u,new u(null),new u(1.5),new u(e)},!0)||(u=t(function(e,t,n,i){var r;return y(e,u,h),w(t)?t instanceof X||(r=x(t))==z||r==G?void 0!==i?new o(t,Ie(n,d),i):void 0!==n?new o(t,Ie(n,d)):new o(t):ye in t?Re(u,t):Pe.call(u,t):new o(M(t))}),q(a!==Function.prototype?A(o).concat(A(a)):A(o),function(e){e in u||E(u,e,o[e])}),u[Y]=l,f||(l.constructor=u));s=l[pe],t=!!s&&("values"==s.name||null==s.name),a=Fe.values;E(u,ge,!0),E(l,ye,h),E(l,Ee,!0),E(l,ve,u),(i?new u(1)[me]==h:me in l)||_(l,me,{get:function(){return h}}),e[h]=u,g(g.G+g.W+g.F*(u!=o),e),g(g.S,h,{BYTES_PER_ELEMENT:d}),g(g.S+g.F*m(function(){o.of.call(u,1)}),h,{from:Pe,of:Ce}),W in l||E(l,W,d),g(g.P,h,De),L(h),g(g.P+g.F*we,h,{set:Ne}),g(g.P+g.F*!t,h,Fe),f||l.toString==ue||(l.toString=ue),g(g.P+g.F*m(function(){new u(1).slice()}),h,{slice:He}),g(g.P+g.F*(m(function(){return[1,2].toLocaleString()!=new u([1,2]).toLocaleString()})||!m(function(){l.toLocaleString.call([1,2])})),h,{toLocaleString:Le}),C[h]=t?s:a,f||t||E(l,pe,a)}):e.exports=function(){}},function(e,t,n){"use strict";var i=n(1),r=n(57)(1);i(i.P+i.F*!n(49)([].map,!0),"Array",{map:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var i=n(1);i(i.S,"Array",{isArray:n(79)})},function(e,t,n){"use strict";var i=n(1),r=n(72),o=n(25),a=n(9),s=[].sort,l=[1,2,3];i(i.P+i.F*(a(function(){l.sort(void 0)})||!a(function(){l.sort(null)})||!n(49)(s)),"Array",{sort:function(e){return void 0===e?s.call(o(this)):s.call(o(this),r(e))}})},function(e,t){var n=0,i=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+i).toString(36))}},function(e,t,n){var o=n(72);e.exports=function(i,r,e){if(o(i),void 0===r)return i;switch(e){case 1:return function(e){return i.call(r,e)};case 2:return function(e,t){return i.call(r,e,t)};case 3:return function(e,t,n){return i.call(r,e,t,n)}}return function(){return i.apply(r,arguments)}}},function(e,t,n){var i=n(74),r=n(37);e.exports=function(e){return i(r(e))}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){"use strict";var i=n(1),r=n(57)(0),n=n(49)([].forEach,!0);i(i.P+i.F*!n,"Array",{forEach:function(e){return r(this,e,arguments[1])}})},function(e,t,n){"use strict";function i(e){if("string"==typeof(t=d(e,!1))&&2<t.length){var t,n,i,r=(t=y?t.trim():f(t,3)).charCodeAt(0);if(43===r||45===r){if(88===(e=t.charCodeAt(2))||120===e)return NaN}else if(48===r){switch(t.charCodeAt(1)){case 66:case 98:n=2,i=49;break;case 79:case 111:n=8,i=55;break;default:return+t}for(var o,a=t.slice(2),s=0,l=a.length;s<l;s++)if((o=a.charCodeAt(s))<48||i<o)return NaN;return parseInt(a,n)}}return+t}var r=n(6),o=n(26),a=n(56),s=n(90),d=n(54),l=n(9),c=n(48).f,h=n(63).f,u=n(10).f,f=n(91).trim,p="Number",m=b=r[p],g=b.prototype,v=a(n(47)(g))==p,y="trim"in String.prototype;if(!b(" 0o1")||!b("0b1")||b("+0x1")){for(var E,b=function(e){var e=arguments.length<1?0:e,t=this;return t instanceof b&&(v?l(function(){g.valueOf.call(t)}):a(t)!=p)?s(new m(i(e)),t,b):i(e)},M=n(8)?c(m):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),x=0;M.length>x;x++)o(m,E=M[x])&&!o(b,E)&&u(b,E,h(m,E));(b.prototype=g).constructor=b,n(20)(r,p,b)}},function(e,t,n){"use strict";var i=n(113)(!0);n(86)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e=this._t,t=this._i;return t>=e.length?{value:void 0,done:!0}:(t=i(e,t),this._i+=t.length,{value:t,done:!1})})},function(e,t,n){n(30)("Uint32",4,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){var i=n(1);i(i.P,"Array",{fill:n(81)}),n(85)("fill")},function(e,t){e=e.exports={version:"2.6.2"};"number"==typeof __e&&(__e=e)},function(e,t){e.exports=!1},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var i=n(103),r=n(77);e.exports=Object.keys||function(e){return i(e,r)}},function(e,t,n){function i(){}var r=n(13),o=n(104),a=n(77),s=n(76)("IE_PROTO"),l="prototype",d=function(){var e=n(102)("iframe"),t=a.length;for(e.style.display="none",n(124).appendChild(e),e.src="javascript:",(e=e.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),d=e.F;t--;)delete d[l][a[t]];return d()};e.exports=Object.create||function(e,t){var n;return null!==e?(i[l]=r(e),n=new i,i[l]=null,n[s]=e):n=d(),void 0===t?n:o(n,t)}},function(e,t,n){var i=n(103),r=n(77).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return i(e,r)}},function(e,t,n){"use strict";var i=n(9);e.exports=function(e,t){return!!e&&i(function(){t?e.call(null,function(){},1):e.call(null)})}},function(e,t){e.exports={}},function(e,t,n){var i=n(1);i(i.S+i.F*!n(8),"Object",{defineProperty:n(10).f})},function(e,t,n){n(30)("Int32",4,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){"use strict";var x=n(13),w=n(25),I=n(15),S=n(27),T=n(95),A=n(68),R=Math.max,O=Math.min,P=Math.floor,C=/\$([$&`']|\d\d?|<[^>]*>)/g,B=/\$([$&`']|\d\d?)/g;n(69)("replace",2,function(r,o,b,M){return[function(e,t){var n=r(this),i=null==e?void 0:e[o];return void 0!==i?i.call(e,n,t):b.call(String(n),e,t)},function(e,t){var n=M(b,e,this,t);if(n.done)return n.value;var i=x(e),r=String(this),o="function"==typeof t;o||(t=String(t));var a,s=i.global;s&&(a=i.unicode,i.lastIndex=0);for(var l=[];;){var d=A(i,r);if(null===d)break;if(l.push(d),!s)break;""===String(d[0])&&(i.lastIndex=T(r,I(i.lastIndex),a))}for(var c,h="",u=0,f=0;f<l.length;f++){for(var d=l[f],p=String(d[0]),m=R(O(S(d.index),r.length),0),g=[],v=1;v<d.length;v++)g.push(void 0===(c=d[v])?c:String(c));var y,E=d.groups,E=o?(y=[p].concat(g,m,r),void 0!==E&&y.push(E),String(t.apply(void 0,y))):function(o,a,s,l,d,e){var c=s+o.length,h=l.length,t=B;void 0!==d&&(d=w(d),t=C);return b.call(e,t,function(e,t){var n;switch(t.charAt(0)){case"$":return"$";case"&":return o;case"`":return a.slice(0,s);case"'":return a.slice(c);case"<":n=d[t.slice(1,-1)];break;default:var i=+t;if(0==i)return e;if(h<i){var r=P(i/10);return 0===r?e:r<=h?void 0===l[r-1]?t.charAt(1):l[r-1]+t.charAt(1):e}n=l[i-1]}return void 0===n?"":n})}(p,r,m,g,E,t);u<=m&&(h+=r.slice(u,m)+E,u=m+p.length)}return h+r.slice(u)}]})},function(e,t,n){var r=n(14);e.exports=function(e,t){if(!r(e))return e;var n,i;if(t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;if("function"==typeof(n=e.valueOf)&&!r(i=n.call(e)))return i;if(!t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;throw TypeError("Can't convert object to primitive value")}},function(e,t,n){var i=n(10).f,r=n(26),o=n(7)("toStringTag");e.exports=function(e,t,n){e&&!r(e=n?e:e.prototype,o)&&i(e,o,{configurable:!0,value:t})}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var E=n(35),b=n(74),M=n(25),x=n(15),i=n(127);e.exports=function(h,e){var u=1==h,f=2==h,p=3==h,m=4==h,g=6==h,v=5==h||g,y=e||i;return function(e,t,n){for(var i,r,o=M(e),a=b(o),s=E(t,n,3),l=x(a.length),d=0,c=u?y(e,l):f?y(e,0):void 0;d<l;d++)if((v||d in a)&&(r=s(i=a[d],d,o),h))if(u)c[d]=r;else if(r)switch(h){case 3:return!0;case 5:return i;case 6:return d;case 2:c.push(i)}else if(m)return!1;return g?-1:p||m?m:c}}},function(e,t,n){"use strict";var i=n(1),r=n(36),o=n(27),a=n(15),s=[].lastIndexOf,l=!!s&&1/[1].lastIndexOf(1,-0)<0;i(i.P+i.F*(l||!n(49)(s)),"Array",{lastIndexOf:function(e){if(l)return s.apply(this,arguments)||0;var t=r(this),n=a(t.length),i=n-1;for((i=1<arguments.length?Math.min(i,o(arguments[1])):i)<0&&(i=n+i);0<=i;i--)if(i in t&&t[i]===e)return i||0;return-1}})},function(e,t,n){n(8)&&"g"!=/./g.flags&&n(10).f(RegExp.prototype,"flags",{configurable:!0,get:n(67)})},function(e,t,n){"use strict";var i=n(117),r=n(97);e.exports=n(119)("Map",function(e){return function(){return e(this,0<arguments.length?arguments[0]:void 0)}},{get:function(e){e=i.getEntry(r(this,"Map"),e);return e&&e.v},set:function(e,t){return i.def(r(this,"Map"),0===e?0:e,t)}},i,!0)},function(e,t,n){var i=n(27),r=Math.max,o=Math.min;e.exports=function(e,t){return(e=i(e))<0?r(e+t,0):o(e,t)}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var i=n(62),r=n(45),o=n(36),a=n(54),s=n(26),l=n(101),d=Object.getOwnPropertyDescriptor;t.f=n(8)?d:function(e,t){if(e=o(e),t=a(t,!0),l)try{return d(e,t)}catch(e){}if(s(e,t))return r(!i.f.call(e,t),e[t])}},function(e,t,n){var r=n(20);e.exports=function(e,t,n){for(var i in t)r(e,i,t[i],n);return e}},function(e,t){e.exports=function(e,t,n,i){if(!(e instanceof t)||void 0!==i&&i in e)throw TypeError(n+": incorrect invocation!");return e}},function(t,e){!function(e){t.exports=e}.call(this,{})},function(e,t,n){"use strict";var i=n(13);e.exports=function(){var e=i(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,n){"use strict";var i=n(82),r=RegExp.prototype.exec;e.exports=function(e,t){var n=e.exec;if("function"==typeof n){n=n.call(e,t);if("object"!=typeof n)throw new TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==i(e))throw new TypeError("RegExp#exec called on incompatible receiver");return r.call(e,t)}},function(e,t,n){"use strict";n(137);var l=n(20),d=n(19),c=n(9),h=n(37),u=n(7),f=n(96),p=u("species"),m=!c(function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}),g=function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};e="ab".split(e);return 2===e.length&&"a"===e[0]&&"b"===e[1]}();e.exports=function(n,e,t){var o,i,r=u(n),a=!c(function(){var e={};return e[r]=function(){return 7},7!=""[n](e)}),s=a?!c(function(){var e=!1,t=/a/;return t.exec=function(){return e=!0,null},"split"===n&&(t.constructor={},t.constructor[p]=function(){return t}),t[r](""),!e}):void 0;a&&s&&("replace"!==n||m)&&("split"!==n||g)||(o=/./[r],t=(s=t(h,r,""[n],function(e,t,n,i,r){return t.exec===f?a&&!r?{done:!0,value:o.call(t,n,i)}:{done:!0,value:e.call(n,t,i)}:{done:!1}}))[0],i=s[1],l(String.prototype,n,t),d(RegExp.prototype,r,2==e?function(e,t){return i.call(e,this,t)}:function(e){return i.call(e,this)}))}},function(e,t,n){"use strict";var s=n(13),l=n(139),d=n(68);n(69)("search",1,function(i,r,o,a){return[function(e){var t=i(this),n=null==e?void 0:e[r];return void 0!==n?n.call(e,t):new RegExp(e)[r](String(t))},function(e){var t=a(o,e,this);if(t.done)return t.value;var n=s(e),t=String(this),e=n.lastIndex;l(e,0)||(n.lastIndex=0);t=d(n,t);return l(n.lastIndex,e)||(n.lastIndex=e),null===t?-1:t.index}]})},function(e,t,n){var i=n(43),r=n(6),o="__core-js_shared__",a=r[o]||(r[o]={});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:i.version,mode:n(44)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){function i(e){s(e,r,{value:{i:"O"+ ++l,w:{}}})}var r=n(34)("meta"),o=n(14),a=n(26),s=n(10).f,l=0,d=Object.isExtensible||function(){return!0},c=!n(9)(function(){return d(Object.preventExtensions({}))}),h=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,r)){if(!d(e))return"F";if(!t)return"E";i(e)}return e[r].i},getWeak:function(e,t){if(!a(e,r)){if(!d(e))return!0;if(!t)return!1;i(e)}return e[r].w},onFreeze:function(e){return c&&h.NEED&&d(e)&&!a(e,r)&&i(e),e}}},function(e,t,n){var i=n(56);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==i(e)?e.split(""):Object(e)}},function(e,t,n){var l=n(36),d=n(15),c=n(61);e.exports=function(s){return function(e,t,n){var i,r=l(e),o=d(r.length),a=c(n,o);if(s&&t!=t){for(;a<o;)if((i=r[a++])!=i)return!0}else for(;a<o;a++)if((s||a in r)&&r[a]===t)return s||a||0;return!s&&-1}}},function(e,t,n){var i=n(71)("keys"),r=n(34);e.exports=function(e){return i[e]||(i[e]=r(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var i=n(56);e.exports=Array.isArray||function(e){return"Array"==i(e)}},function(e,t,n){for(var i,r=n(6),o=n(19),n=n(34),a=n("typed_array"),s=n("view"),n=!(!r.ArrayBuffer||!r.DataView),l=n,d=0,c="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");d<9;)(i=r[c[d++]])?(o(i.prototype,a,!0),o(i.prototype,s,!0)):l=!1;e.exports={ABV:n,CONSTR:l,TYPED:a,VIEW:s}},function(e,t,n){"use strict";var a=n(25),s=n(61),l=n(15);e.exports=function(e){for(var t=a(this),n=l(t.length),i=arguments.length,r=s(1<i?arguments[1]:void 0,n),i=2<i?arguments[2]:void 0,o=void 0===i?n:s(i,n);r<o;)t[r++]=e;return t}},function(e,t,n){var i=n(56),r=n(7)("toStringTag"),o="Arguments"==i(function(){return arguments}());e.exports=function(e){var t;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(e=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),r))?e:o?i(t):"Object"==(e=i(t))&&"function"==typeof t.callee?"Arguments":e}},function(e,t,n){var i=n(50),r=n(7)("iterator"),o=Array.prototype;e.exports=function(e){return void 0!==e&&(i.Array===e||o[r]===e)}},function(e,t,n){var i=n(82),r=n(7)("iterator"),o=n(50);e.exports=n(43).getIteratorMethod=function(e){if(null!=e)return e[r]||e["@@iterator"]||o[i(e)]}},function(e,t,n){var i=n(7)("unscopables"),r=Array.prototype;null==r[i]&&n(19)(r,i,{}),e.exports=function(e){r[i][e]=!0}},function(e,t,n){"use strict";function y(){return this}var E=n(44),b=n(1),M=n(20),x=n(19),w=n(50),I=n(129),S=n(55),T=n(108),A=n(7)("iterator"),R=!([].keys&&"next"in[].keys()),O="values";e.exports=function(e,t,n,i,r,o,a){I(n,t,i);function s(e){if(!R&&e in p)return p[e];switch(e){case"keys":case O:return function(){return new n(this,e)}}return function(){return new n(this,e)}}var l,d,c,h=t+" Iterator",u=r==O,f=!1,p=e.prototype,m=p[A]||p["@@iterator"]||r&&p[r],g=m||s(r),v=r?u?s("entries"):g:void 0,i="Array"==t&&p.entries||m;if(i&&(c=T(i.call(new e)))!==Object.prototype&&c.next&&(S(c,h,!0),E||"function"==typeof c[A]||x(c,A,y)),u&&m&&m.name!==O&&(f=!0,g=function(){return m.call(this)}),E&&!a||!R&&!f&&p[A]||x(p,A,g),w[t]=g,w[h]=y,r)if(l={values:u?g:s(O),keys:o?g:s("keys"),entries:v},a)for(d in l)d in p||M(p,d,l[d]);else b(b.P+b.F*(R||f),t,l);return l}},function(e,t,n){var o=n(7)("iterator"),a=!1;try{var i=[7][o]();i.return=function(){a=!0},Array.from(i,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!a)return!1;var n=!1;try{var i=[7],r=i[o]();r.next=function(){return{done:n=!0}},i[o]=function(){return r},e(i)}catch(e){}return n}},function(e,t,n){"use strict";var i=n(6),r=n(10),o=n(8),a=n(7)("species");e.exports=function(e){e=i[e];o&&e&&!e[a]&&r.f(e,a,{configurable:!0,get:function(){return this}})}},function(e,t,n){var i=n(25),r=n(46);n(131)("keys",function(){return function(e){return r(i(e))}})},function(e,t,n){var r=n(14),o=n(105).set;e.exports=function(e,t,n){var i,t=t.constructor;return t!==n&&"function"==typeof t&&(i=t.prototype)!==n.prototype&&r(i)&&o&&o(e,i),e}},function(e,t,n){var o=n(1),i=n(37),a=n(9),s=n(111),n="["+s+"]",r=RegExp("^"+n+n+"*"),l=RegExp(n+n+"*$"),n=function(e,t,n){var i={},r=a(function(){return!!s[e]()||"​"!="​"[e]()}),t=i[e]=r?t(d):s[e];n&&(i[n]=t),o(o.P+o.F*r,"String",i)},d=n.trim=function(e,t){return e=String(i(e)),1&t&&(e=e.replace(r,"")),e=2&t?e.replace(l,""):e};e.exports=n},function(e,t,n){function i(e,t,n,i){var r=String(a(e)),e="<"+t;return""!==n&&(e+=" "+n+'="'+String(i).replace(s,"&quot;")+'"'),e+">"+r+"</"+t+">"}var r=n(1),o=n(9),a=n(37),s=/"/g;e.exports=function(t,e){var n={};n[t]=e(i),r(r.P+r.F*o(function(){var e=""[t]('"');return e!==e.toLowerCase()||3<e.split('"').length}),"String",n)}},function(e,t,n){"use strict";var i=n(1),r=n(57)(2);i(i.P+i.F*!n(49)([].filter,!0),"Array",{filter:function(e){return r(this,e,arguments[1])}})},function(e,t,n){"use strict";var i=n(1),r=n(57)(5),o="find",a=!0;o in[]&&Array(1)[o](function(){a=!1}),i(i.P+i.F*a,"Array",{find:function(e){return r(this,e,1<arguments.length?arguments[1]:void 0)}}),n(85)(o)},function(e,t,n){"use strict";var i=n(113)(!0);e.exports=function(e,t,n){return t+(n?i(e,t).length:1)}},function(e,t,n){"use strict";var i,a=n(67),s=RegExp.prototype.exec,l=String.prototype.replace,r=s,d="lastIndex",c=(i=/a/,n=/b*/g,s.call(i,"a"),s.call(n,"a"),0!==i[d]||0!==n[d]),h=void 0!==/()??/.exec("")[1];e.exports=r=c||h?function(e){var t,n,i,r,o=this;return h&&(n=new RegExp("^"+o.source+"$(?!\\s)",a.call(o))),c&&(t=o[d]),i=s.call(o,e),c&&i&&(o[d]=o.global?i.index+i[0].length:t),h&&i&&1<i.length&&l.call(i[0],n,function(){for(r=1;r<arguments.length-2;r++)void 0===arguments[r]&&(i[r]=void 0)}),i}:r},function(e,t,n){var i=n(14);e.exports=function(e,t){if(!i(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e}},function(e,t,n){"use strict";var i=n(117),r=n(97);e.exports=n(119)("Set",function(e){return function(){return e(this,0<arguments.length?arguments[0]:void 0)}},{add:function(e){return i.def(r(this,"Set"),e=0===e?0:e,e)}},i)},function(e,t,n){var i=n(6),r=n(43),o=n(44),a=n(100),s=n(10).f;e.exports=function(e){var t=r.Symbol||(r.Symbol=!o&&i.Symbol||{});"_"==e.charAt(0)||e in t||s(t,e,{value:a.f(e)})}},function(e,t,n){t.f=n(7)},function(e,t,n){e.exports=!n(8)&&!n(9)(function(){return 7!=Object.defineProperty(n(102)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var i=n(14),r=n(6).document,o=i(r)&&i(r.createElement);e.exports=function(e){return o?r.createElement(e):{}}},function(e,t,n){var a=n(26),s=n(36),l=n(75)(!1),d=n(76)("IE_PROTO");e.exports=function(e,t){var n,i=s(e),r=0,o=[];for(n in i)n!=d&&a(i,n)&&o.push(n);for(;t.length>r;)a(i,n=t[r++])&&(~l(o,n)||o.push(n));return o}},function(e,t,n){var a=n(10),s=n(13),l=n(46);e.exports=n(8)?Object.defineProperties:function(e,t){s(e);for(var n,i=l(t),r=i.length,o=0;o<r;)a.f(e,n=i[o++],t[n]);return e}},function(e,t,r){function o(e,t){if(i(e),!n(t)&&null!==t)throw TypeError(t+": can't set as prototype!")}var n=r(14),i=r(13);e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,n,i){try{(i=r(35)(Function.call,r(63).f(Object.prototype,"__proto__").set,2))(e,[]),n=!(e instanceof Array)}catch(e){n=!0}return function(e,t){return o(e,t),n?e.__proto__=t:i(e,t),e}}({},!1):void 0),check:o}},function(e,t,n){"use strict";var i=n(6),r=n(8),o=n(44),a=n(80),s=n(19),l=n(64),d=n(9),c=n(65),h=n(27),u=n(15),f=n(107),p=n(48).f,m=n(10).f,g=n(81),v=n(55),y="ArrayBuffer",E="DataView",b="prototype",M="Wrong index!",x=i[y],w=i[E],n=i.Math,I=i.RangeError,S=i.Infinity,T=x,A=n.abs,R=n.pow,O=n.floor,P=n.log,C=n.LN2,i="byteLength",n="byteOffset",B=r?"_b":"buffer",L=r?"_l":i,D=r?"_o":n;function H(e,t,n){var i,r,o=new Array(n),a=8*n-t-1,s=(1<<a)-1,l=s>>1,d=23===t?R(2,-24)-R(2,-77):0,c=0,h=e<0||0===e&&1/e<0?1:0;for((e=A(e))!=e||e===S?(r=e!=e?1:0,i=s):(i=O(P(e)/C),e*(n=R(2,-i))<1&&(i--,n*=2),2<=(e+=1<=i+l?d/n:d*R(2,1-l))*n&&(i++,n/=2),s<=i+l?(r=0,i=s):1<=i+l?(r=(e*n-1)*R(2,t),i+=l):(r=e*R(2,l-1)*R(2,t),i=0));8<=t;o[c++]=255&r,r/=256,t-=8);for(i=i<<t|r,a+=t;0<a;o[c++]=255&i,i/=256,a-=8);return o[--c]|=128*h,o}function N(e,t,n){var i,r=8*n-t-1,o=(1<<r)-1,a=o>>1,s=r-7,l=n-1,n=e[l--],d=127&n;for(n>>=7;0<s;d=256*d+e[l],l--,s-=8);for(i=d&(1<<-s)-1,d>>=-s,s+=t;0<s;i=256*i+e[l],l--,s-=8);if(0===d)d=1-a;else{if(d===o)return i?NaN:n?-S:S;i+=R(2,t),d-=a}return(n?-1:1)*i*R(2,d-t)}function F(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]}function _(e){return[255&e]}function k(e){return[255&e,e>>8&255]}function V(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function j(e){return H(e,52,8)}function U(e){return H(e,23,4)}function z(e,t,n){m(e[b],t,{get:function(){return this[n]}})}function G(e,t,n,i){var r=f(+n);if(r+t>e[L])throw I(M);n=e[B]._b,e=r+e[D],t=n.slice(e,e+t);return i?t:t.reverse()}function W(e,t,n,i,r,o){n=f(+n);if(n+t>e[L])throw I(M);for(var a=e[B]._b,s=n+e[D],l=i(+r),d=0;d<t;d++)a[s+d]=l[o?d:t-d-1]}if(a.ABV){if(!d(function(){x(1)})||!d(function(){new x(-1)})||d(function(){return new x,new x(1.5),new x(NaN),x.name!=y})){for(var Y,X=(x=function(e){return c(this,x),new T(f(e))})[b]=T[b],Z=p(T),q=0;Z.length>q;)(Y=Z[q++])in x||s(x,Y,T[Y]);o||(X.constructor=x)}var X=new w(new x(2)),Q=w[b].setInt8;X.setInt8(0,2147483648),X.setInt8(1,2147483649),!X.getInt8(0)&&X.getInt8(1)||l(w[b],{setInt8:function(e,t){Q.call(this,e,t<<24>>24)},setUint8:function(e,t){Q.call(this,e,t<<24>>24)}},!0)}else x=function(e){c(this,x,y);e=f(e);this._b=g.call(new Array(e),0),this[L]=e},w=function(e,t,n){c(this,w,E),c(e,x,E);var i=e[L],t=h(t);if(t<0||i<t)throw I("Wrong offset!");if(i<t+(n=void 0===n?i-t:u(n)))throw I("Wrong length!");this[B]=e,this[D]=t,this[L]=n},r&&(z(x,i,"_l"),z(w,"buffer","_b"),z(w,i,"_l"),z(w,n,"_o")),l(w[b],{getInt8:function(e){return G(this,1,e)[0]<<24>>24},getUint8:function(e){return G(this,1,e)[0]},getInt16:function(e){e=G(this,2,e,arguments[1]);return(e[1]<<8|e[0])<<16>>16},getUint16:function(e){e=G(this,2,e,arguments[1]);return e[1]<<8|e[0]},getInt32:function(e){return F(G(this,4,e,arguments[1]))},getUint32:function(e){return F(G(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return N(G(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return N(G(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){W(this,1,e,_,t)},setUint8:function(e,t){W(this,1,e,_,t)},setInt16:function(e,t){W(this,2,e,k,t,arguments[2])},setUint16:function(e,t){W(this,2,e,k,t,arguments[2])},setInt32:function(e,t){W(this,4,e,V,t,arguments[2])},setUint32:function(e,t){W(this,4,e,V,t,arguments[2])},setFloat32:function(e,t){W(this,4,e,U,t,arguments[2])},setFloat64:function(e,t){W(this,8,e,j,t,arguments[2])}});v(x,y),v(w,E),s(w[b],a.VIEW,!0),t[y]=x,t[E]=w},function(e,t,n){var i=n(27),r=n(15);e.exports=function(e){if(void 0===e)return 0;var t=i(e),e=r(t);if(t!==e)throw RangeError("Wrong length!");return e}},function(e,t,n){var i=n(26),r=n(25),o=n(76)("IE_PROTO"),a=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),i(e,o)?e[o]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?a:null}},function(e,t,n){var i=n(13),r=n(72),o=n(7)("species");e.exports=function(e,t){var n,e=i(e).constructor;return void 0===e||null==(n=i(e)[o])?t:r(n)}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,n){var i=n(1);i(i.S+i.F*!n(8),"Object",{defineProperties:n(104)})},function(e,t,n){var a=n(27),s=n(37);e.exports=function(o){return function(e,t){var n,i=String(s(e)),r=a(t),e=i.length;return r<0||e<=r?o?"":void 0:(t=i.charCodeAt(r))<55296||56319<t||r+1===e||(n=i.charCodeAt(r+1))<56320||57343<n?o?i.charAt(r):t:o?i.slice(r,r+2):n-56320+(t-55296<<10)+65536}}},function(e,t,n){var i=n(14),r=n(56),o=n(7)("match");e.exports=function(e){var t;return i(e)&&(void 0!==(t=e[o])?!!t:"RegExp"==r(e))}},function(e,t,n){var r=n(13);e.exports=function(t,e,n,i){try{return i?e(r(n)[0],n[1]):e(n)}catch(e){n=t.return;throw void 0!==n&&r(n.call(t)),e}}},function(e,t,n){"use strict";n(92)("fixed",function(e){return function(){return e(this,"tt","","")}})},function(e,t,n){"use strict";function a(e,t){var n,i=p(t);if("F"!==i)return e._i[i];for(n=e._f;n;n=n.n)if(n.k==t)return n}var s=n(10).f,l=n(47),d=n(64),c=n(35),h=n(65),u=n(118),i=n(86),r=n(110),o=n(88),f=n(8),p=n(73).fastKey,m=n(97),g=f?"_s":"size";e.exports={getConstructor:function(e,r,n,i){var o=e(function(e,t){h(e,o,r,"_i"),e._t=r,e._i=l(null),e._f=void 0,e._l=void 0,e[g]=0,null!=t&&u(t,n,e[i],e)});return d(o.prototype,{clear:function(){for(var e=m(this,r),t=e._i,n=e._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete t[n.i];e._f=e._l=void 0,e[g]=0},delete:function(e){var t,n=m(this,r),i=a(n,e);return i&&(t=i.n,e=i.p,delete n._i[i.i],i.r=!0,e&&(e.n=t),t&&(t.p=e),n._f==i&&(n._f=t),n._l==i&&(n._l=e),n[g]--),!!i},forEach:function(e){m(this,r);for(var t,n=c(e,1<arguments.length?arguments[1]:void 0,3);t=t?t.n:this._f;)for(n(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!a(m(this,r),e)}}),f&&s(o.prototype,"size",{get:function(){return m(this,r)[g]}}),o},def:function(e,t,n){var i,r=a(e,t);return r?r.v=n:(e._l=r={i:i=p(t,!0),k:t,v:n,p:n=e._l,n:void 0,r:!1},e._f||(e._f=r),n&&(n.n=r),e[g]++,"F"!==i&&(e._i[i]=r)),e},getEntry:a,setStrong:function(e,n,t){i(e,n,function(e,t){this._t=m(e,n),this._k=t,this._l=void 0},function(){for(var e=this,t=e._k,n=e._l;n&&n.r;)n=n.p;return e._t&&(e._l=n=n?n.n:e._t._f)?r(0,"keys"==t?n.k:"values"==t?n.v:[n.k,n.v]):(e._t=void 0,r(1))},t?"entries":"values",!t,!0),o(n)}}},function(e,t,n){var h=n(35),u=n(115),f=n(83),p=n(13),m=n(15),g=n(84),v={},y={};(t=e.exports=function(e,t,n,i,r){var o,a,s,l,r=r?function(){return e}:g(e),d=h(n,i,t?2:1),c=0;if("function"!=typeof r)throw TypeError(e+" is not iterable!");if(f(r)){for(o=m(e.length);c<o;c++)if((l=t?d(p(a=e[c])[0],a[1]):d(e[c]))===v||l===y)return l}else for(s=r.call(e);!(a=s.next()).done;)if((l=u(s,d,a.value,t))===v||l===y)return l}).BREAK=v,t.RETURN=y},function(e,t,n){"use strict";var v=n(6),y=n(1),E=n(20),b=n(64),M=n(73),x=n(118),w=n(65),I=n(14),S=n(9),T=n(87),A=n(55),R=n(90);e.exports=function(n,e,t,i,r,o){function a(e){var n=m[e];E(m,e,"delete"==e?function(e){return!(o&&!I(e))&&n.call(this,0===e?0:e)}:"has"==e?function(e){return!(o&&!I(e))&&n.call(this,0===e?0:e)}:"get"==e?function(e){return o&&!I(e)?void 0:n.call(this,0===e?0:e)}:"add"==e?function(e){return n.call(this,0===e?0:e),this}:function(e,t){return n.call(this,0===e?0:e,t),this})}var s,l,d,c,h,u=v[n],f=u,p=r?"set":"add",m=f&&f.prototype,g={};return"function"==typeof f&&(o||m.forEach&&!S(function(){(new f).entries().next()}))?(l=(s=new f)[p](o?{}:-0,1)!=s,d=S(function(){s.has(1)}),c=T(function(e){new f(e)}),h=!o&&S(function(){for(var e=new f,t=5;t--;)e[p](t,t);return!e.has(-0)}),c||(((f=e(function(e,t){w(e,f,n);e=R(new u,e,f);return null!=t&&x(t,r,e[p],e),e})).prototype=m).constructor=f),(d||h)&&(a("delete"),a("has"),r&&a("get")),(h||l)&&a(p),o&&m.clear&&delete m.clear):(f=i.getConstructor(e,n,r,p),b(f.prototype,t),M.NEED=!0),A(f,n),g[n]=f,y(y.G+y.W+y.F*(f!=u),g),o||i.setStrong(f,n,r),f}},function(e,t,n){var i=n(1);i(i.P,"String",{repeat:n(145)})},function(e,t,n){"use strict";n(91)("trim",function(e){return function(){return e(this,3)}})},function(e,t,n){var i=n(1);i(i.S,"Math",{sign:n(152)})},function(e,t,n){var s=n(46),l=n(78),d=n(62);e.exports=function(e){var t=s(e),n=l.f;if(n)for(var i,r=n(e),o=d.f,a=0;r.length>a;)o.call(e,i=r[a++])&&t.push(i);return t}},function(e,t,n){n=n(6).document;e.exports=n&&n.documentElement},function(e,t,n){var i=n(36),r=n(48).f,o={}.toString,a="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return a&&"[object Window]"==o.call(e)?function(e){try{return r(e)}catch(e){return a.slice()}}(e):r(i(e))}},function(e,t,n){var i=n(1);i(i.S,"Object",{setPrototypeOf:n(105).set})},function(e,t,n){var i=n(128);e.exports=function(e,t){return new(i(e))(t)}},function(e,t,n){var i=n(14),r=n(79),o=n(7)("species");e.exports=function(e){var t;return r(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!r(t.prototype)||(t=void 0),i(t)&&null===(t=t[o])&&(t=void 0)),void 0===t?Array:t}},function(e,t,n){"use strict";var i=n(47),r=n(45),o=n(55),a={};n(19)(a,n(7)("iterator"),function(){return this}),e.exports=function(e,t,n){e.prototype=i(a,{next:r(1,n)}),o(e,t+" Iterator")}},function(e,t,n){"use strict";var l=n(25),d=n(61),c=n(15);e.exports=[].copyWithin||function(e,t){var n=l(this),i=c(n.length),r=d(e,i),o=d(t,i),t=2<arguments.length?arguments[2]:void 0,a=Math.min((void 0===t?i:d(t,i))-o,i-r),s=1;for(o<r&&r<o+a&&(s=-1,o+=a-1,r+=a-1);0<a--;)o in n?n[r]=n[o]:delete n[r],r+=s,o+=s;return n}},function(e,t,n){var r=n(1),o=n(43),a=n(9);e.exports=function(e,t){var n=(o.Object||{})[e]||Object[e],i={};i[e]=t(n),r(r.S+r.F*a(function(){n(1)}),"Object",i)}},function(e,t,n){var i=n(1),r=n(6).isFinite;i(i.S,"Number",{isFinite:function(e){return"number"==typeof e&&r(e)}})},function(e,t,i){"use strict";!function(t,n){i(28),i(29),i(59),i(2),i(136),i(52),i(21),i(17),i(11),i(12);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e){"object"===("undefined"==typeof exports?"undefined":a(exports))&&void 0!==t?t.exports=e():"function"==typeof define&&i(66)?define([],e):("undefined"!=typeof window?window:void 0!==n?n:"undefined"!=typeof self?self:this).pako=e()}(function(){return function i(r,o,a){function s(n,e){if(!o[n]){if(!r[n]){if(0,l)return l(n,!0);var t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}t=o[n]={exports:{}};r[n][0].call(t.exports,function(e){var t=r[n][1][e];return s(t||e)},t,t.exports,i,r,o,a)}return o[n].exports}for(var l=!1,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){var a=e("./zlib/deflate"),s=e("./utils/common"),l=e("./utils/strings"),i=e("./zlib/messages"),r=e("./zlib/zstream"),d=Object.prototype.toString,c=0,o=-1,h=0,u=8;function f(e){if(!(this instanceof f))return new f(e);this.options=s.assign({level:o,method:u,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},e||{});var t=this.options;if(t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new r,this.strm.avail_out=0,(e=a.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy))!==c)throw new Error(i[e]);if(t.header&&a.deflateSetHeader(this.strm,t.header),t.dictionary){t="string"==typeof t.dictionary?l.string2buf(t.dictionary):"[object ArrayBuffer]"===d.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary;if((e=a.deflateSetDictionary(this.strm,t))!==c)throw new Error(i[e]);this._dict_set=!0}}function p(e,t){t=new f(t);if(t.push(e,!0),t.err)throw t.msg||i[t.err];return t.result}f.prototype.push=function(e,t){var n,i,r=this.strm,o=this.options.chunkSize;if(this.ended)return!1;i=t===~~t?t:!0===t?4:0,"string"==typeof e?r.input=l.string2buf(e):"[object ArrayBuffer]"===d.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new s.Buf8(o),r.next_out=0,r.avail_out=o),1!==(n=a.deflate(r,i))&&n!==c)return this.onEnd(n),!(this.ended=!0)}while(0!==r.avail_out&&(0!==r.avail_in||4!==i&&2!==i)||("string"===this.options.to?this.onData(l.buf2binstring(s.shrinkBuf(r.output,r.next_out))):this.onData(s.shrinkBuf(r.output,r.next_out))),(0<r.avail_in||0===r.avail_out)&&1!==n);return 4===i?(n=a.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===c):2!==i||(this.onEnd(c),!(r.avail_out=0))},f.prototype.onData=function(e){this.chunks.push(e)},f.prototype.onEnd=function(e){e===c&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Deflate=f,n.deflate=p,n.deflateRaw=function(e,t){return(t=t||{}).raw=!0,p(e,t)},n.gzip=function(e,t){return(t=t||{}).gzip=!0,p(e,t)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(e,t,n){var h=e("./zlib/inflate"),u=e("./utils/common"),f=e("./utils/strings"),p=e("./zlib/constants"),i=e("./zlib/messages"),r=e("./zlib/zstream"),o=e("./zlib/gzheader"),m=Object.prototype.toString;function a(e){if(!(this instanceof a))return new a(e);this.options=u.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new r,this.strm.avail_out=0;t=h.inflateInit2(this.strm,t.windowBits);if(t!==p.Z_OK)throw new Error(i[t]);this.header=new o,h.inflateGetHeader(this.strm,this.header)}function s(e,t){t=new a(t);if(t.push(e,!0),t.err)throw t.msg||i[t.err];return t.result}a.prototype.push=function(e,t){var n,i,r,o,a,s=this.strm,l=this.options.chunkSize,d=this.options.dictionary,c=!1;if(this.ended)return!1;i=t===~~t?t:!0===t?p.Z_FINISH:p.Z_NO_FLUSH,"string"==typeof e?s.input=f.binstring2buf(e):"[object ArrayBuffer]"===m.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;do{if(0===s.avail_out&&(s.output=new u.Buf8(l),s.next_out=0,s.avail_out=l),(n=h.inflate(s,p.Z_NO_FLUSH))===p.Z_NEED_DICT&&d&&(a="string"==typeof d?f.string2buf(d):"[object ArrayBuffer]"===m.call(d)?new Uint8Array(d):d,n=h.inflateSetDictionary(this.strm,a)),n===p.Z_BUF_ERROR&&!0===c&&(n=p.Z_OK,c=!1),n!==p.Z_STREAM_END&&n!==p.Z_OK)return this.onEnd(n),!(this.ended=!0)}while(s.next_out&&(0!==s.avail_out&&n!==p.Z_STREAM_END&&(0!==s.avail_in||i!==p.Z_FINISH&&i!==p.Z_SYNC_FLUSH)||("string"===this.options.to?(r=f.utf8border(s.output,s.next_out),o=s.next_out-r,a=f.buf2string(s.output,r),s.next_out=o,s.avail_out=l-o,o&&u.arraySet(s.output,s.output,r,o,0),this.onData(a)):this.onData(u.shrinkBuf(s.output,s.next_out)))),0===s.avail_in&&0===s.avail_out&&(c=!0),(0<s.avail_in||0===s.avail_out)&&n!==p.Z_STREAM_END);return(i=n===p.Z_STREAM_END?p.Z_FINISH:i)===p.Z_FINISH?(n=h.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===p.Z_OK):i!==p.Z_SYNC_FLUSH||(this.onEnd(p.Z_OK),!(s.avail_out=0))},a.prototype.onData=function(e){this.chunks.push(e)},a.prototype.onEnd=function(e){e===p.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=u.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Inflate=a,n.inflate=s,n.inflateRaw=function(e,t){return(t=t||{}).raw=!0,s(e,t)},n.ungzip=s},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(e,t,n){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;n.assign=function(e){for(var t,n,i=Array.prototype.slice.call(arguments,1);i.length;){var r=i.shift();if(r){if("object"!==a(r))throw new TypeError(r+"must be non-object");for(var o in r)t=r,n=o,Object.prototype.hasOwnProperty.call(t,n)&&(e[o]=r[o])}}return e},n.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var r={arraySet:function(e,t,n,i,r){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+i),r);else for(var o=0;o<i;o++)e[r+o]=t[n+o]},flattenChunks:function(e){for(var t,n,i,r=0,o=0,a=e.length;o<a;o++)r+=e[o].length;for(i=new Uint8Array(r),o=t=0,a=e.length;o<a;o++)n=e[o],i.set(n,t),t+=n.length;return i}},o={arraySet:function(e,t,n,i,r){for(var o=0;o<i;o++)e[r+o]=t[n+o]},flattenChunks:function(e){return[].concat.apply([],e)}};n.setTyped=function(e){e?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,r)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,o))},n.setTyped(i)},{}],4:[function(e,t,n){var l=e("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(e){r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){o=!1}for(var d=new l.Buf8(256),i=0;i<256;i++)d[i]=252<=i?6:248<=i?5:240<=i?4:224<=i?3:192<=i?2:1;function c(e,t){if(t<65537&&(e.subarray&&o||!e.subarray&&r))return String.fromCharCode.apply(null,l.shrinkBuf(e,t));for(var n="",i=0;i<t;i++)n+=String.fromCharCode(e[i]);return n}d[254]=d[254]=1,n.string2buf=function(e){for(var t,n,i,r,o=e.length,a=0,s=0;s<o;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(i=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(i-56320),s++),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new l.Buf8(a),s=r=0;r<a;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(i=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(i-56320),s++),n<128?t[r++]=n:(n<2048?t[r++]=192|n>>>6:(n<65536?t[r++]=224|n>>>12:(t[r++]=240|n>>>18,t[r++]=128|n>>>12&63),t[r++]=128|n>>>6&63),t[r++]=128|63&n);return t},n.buf2binstring=function(e){return c(e,e.length)},n.binstring2buf=function(e){for(var t=new l.Buf8(e.length),n=0,i=t.length;n<i;n++)t[n]=e.charCodeAt(n);return t},n.buf2string=function(e,t){for(var n,i,r=t||e.length,o=new Array(2*r),a=0,s=0;s<r;)if((n=e[s++])<128)o[a++]=n;else if(4<(i=d[n]))o[a++]=65533,s+=i-1;else{for(n&=2===i?31:3===i?15:7;1<i&&s<r;)n=n<<6|63&e[s++],i--;1<i?o[a++]=65533:n<65536?o[a++]=n:(n-=65536,o[a++]=55296|n>>10&1023,o[a++]=56320|1023&n)}return c(o,a)},n.utf8border=function(e,t){for(var n=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=n&&128==(192&e[n]);)n--;return!(n<0)&&0!==n&&n+d[e[n]]>t?n:t}},{"./common":3}],5:[function(e,t,n){t.exports=function(e,t,n,i){for(var r=65535&e|0,o=e>>>16&65535|0,a=0;0!==n;){for(n-=a=2e3<n?2e3:n;o=o+(r=r+t[i++]|0)|0,--a;);r%=65521,o%=65521}return r|o<<16|0}},{}],6:[function(e,t,n){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(e,t,n){var s=function(){for(var e=[],t=0;t<256;t++){for(var n=t,i=0;i<8;i++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e}();t.exports=function(e,t,n,i){var r=s,o=i+n;e^=-1;for(var a=i;a<o;a++)e=e>>>8^r[255&(e^t[a])];return-1^e}},{}],8:[function(e,t,n){var s,h=e("../utils/common"),l=e("./trees"),u=e("./adler32"),f=e("./crc32"),i=e("./messages"),d=0,c=4,p=0,m=-2,g=-1,v=4,r=2,y=8,E=9,o=286,a=30,b=19,M=2*o+1,x=15,w=3,I=258,S=I+w+1,T=42,A=113,R=1,O=2,P=3,C=4;function B(e,t){return e.msg=i[t],t}function L(e){return(e<<1)-(4<e?9:0)}function D(e){for(var t=e.length;0<=--t;)e[t]=0}function H(e){var t=e.state,n=t.pending;0!==(n=n>e.avail_out?e.avail_out:n)&&(h.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function N(e,t){l._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,H(e.strm)}function F(e,t){e.pending_buf[e.pending++]=t}function _(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function k(e,t){var n,i,r=e.max_chain_length,o=e.strstart,a=e.prev_length,s=e.nice_match,l=e.strstart>e.w_size-S?e.strstart-(e.w_size-S):0,d=e.window,c=e.w_mask,h=e.prev,u=e.strstart+I,f=d[o+a-1],p=d[o+a];e.prev_length>=e.good_match&&(r>>=2),s>e.lookahead&&(s=e.lookahead);do{if(d[(n=t)+a]===p&&d[n+a-1]===f&&d[n]===d[o]&&d[++n]===d[o+1]){for(o+=2,n++;d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<u;);if(i=I-(u-o),o=u-I,a<i){if(e.match_start=t,s<=(a=i))break;f=d[o+a-1],p=d[o+a]}}}while((t=h[t&c])>l&&0!=--r);return a<=e.lookahead?a:e.lookahead}function V(e){var t,n,i,r,o,a,s,l,d,c=e.w_size;do{if(d=e.window_size-e.lookahead-e.strstart,e.strstart>=c+(c-S)){for(h.arraySet(e.window,e.window,c,c,0),e.match_start-=c,e.strstart-=c,e.block_start-=c,t=n=e.hash_size;i=e.head[--t],e.head[t]=c<=i?i-c:0,--n;);for(t=n=c;i=e.prev[--t],e.prev[t]=c<=i?i-c:0,--n;);d+=c}if(0===e.strm.avail_in)break;if(o=e.strm,a=e.window,s=e.strstart+e.lookahead,l=d,d=void 0,d=o.avail_in,n=0===(d=l<d?l:d)?0:(o.avail_in-=d,h.arraySet(a,o.input,o.next_in,d,s),1===o.state.wrap?o.adler=u(o.adler,a,d,s):2===o.state.wrap&&(o.adler=f(o.adler,a,d,s)),o.next_in+=d,o.total_in+=d,d),e.lookahead+=n,e.lookahead+e.insert>=w)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=(e.ins_h<<e.hash_shift^e.window[r+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[r+w-1])&e.hash_mask,e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<w)););}while(e.lookahead<S&&0!==e.strm.avail_in)}function j(e,t){for(var n,i;;){if(e.lookahead<S){if(V(e),e.lookahead<S&&t===d)return R;if(0===e.lookahead)break}if(n=0,e.lookahead>=w&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+w-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-S&&(e.match_length=k(e,n)),e.match_length>=w)if(i=l._tr_tally(e,e.strstart-e.match_start,e.match_length-w),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=w){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+w-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else i=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(N(e,!1),0===e.strm.avail_out))return R}return e.insert=e.strstart<w-1?e.strstart:w-1,t===c?(N(e,!0),0===e.strm.avail_out?P:C):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?R:O}function U(e,t){for(var n,i,r;;){if(e.lookahead<S){if(V(e),e.lookahead<S&&t===d)return R;if(0===e.lookahead)break}if(n=0,e.lookahead>=w&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+w-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=w-1,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-S&&(e.match_length=k(e,n),e.match_length<=5&&(1===e.strategy||e.match_length===w&&4096<e.strstart-e.match_start)&&(e.match_length=w-1)),e.prev_length>=w&&e.match_length<=e.prev_length){for(r=e.strstart+e.lookahead-w,i=l._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-w),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+w-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=w-1,e.strstart++,i&&(N(e,!1),0===e.strm.avail_out))return R}else if(e.match_available){if((i=l._tr_tally(e,0,e.window[e.strstart-1]))&&N(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return R}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=l._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<w-1?e.strstart:w-1,t===c?(N(e,!0),0===e.strm.avail_out?P:C):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?R:O}function z(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}function G(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=y,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new h.Buf16(2*M),this.dyn_dtree=new h.Buf16(2*(2*a+1)),this.bl_tree=new h.Buf16(2*(2*b+1)),D(this.dyn_ltree),D(this.dyn_dtree),D(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new h.Buf16(x+1),this.heap=new h.Buf16(2*o+1),D(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new h.Buf16(2*o+1),D(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function W(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=r,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?T:A,e.adler=2===t.wrap?0:1,t.last_flush=d,l._tr_init(t),p):B(e,m)}function Y(e){var t=W(e);return t===p&&((e=e.state).window_size=2*e.w_size,D(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=w-1,e.match_available=0,e.ins_h=0),t}function X(e,t,n,i,r,o){if(!e)return m;var a=1;if(t===g&&(t=6),i<0?(a=0,i=-i):15<i&&(a=2,i-=16),r<1||E<r||n!==y||i<8||15<i||t<0||9<t||o<0||v<o)return B(e,m);8===i&&(i=9);var s=new G;return(e.state=s).strm=e,s.wrap=a,s.gzhead=null,s.w_bits=i,s.w_size=1<<s.w_bits,s.w_mask=s.w_size-1,s.hash_bits=r+7,s.hash_size=1<<s.hash_bits,s.hash_mask=s.hash_size-1,s.hash_shift=~~((s.hash_bits+w-1)/w),s.window=new h.Buf8(2*s.w_size),s.head=new h.Buf16(s.hash_size),s.prev=new h.Buf16(s.w_size),s.lit_bufsize=1<<r+6,s.pending_buf_size=4*s.lit_bufsize,s.pending_buf=new h.Buf8(s.pending_buf_size),s.d_buf=+s.lit_bufsize,s.l_buf=3*s.lit_bufsize,s.level=t,s.strategy=o,s.method=n,Y(e)}s=[new z(0,0,0,0,function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(V(e),0===e.lookahead&&t===d)return R;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+n;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,N(e,!1),0===e.strm.avail_out))return R;if(e.strstart-e.block_start>=e.w_size-S&&(N(e,!1),0===e.strm.avail_out))return R}return e.insert=0,t===c?(N(e,!0),0===e.strm.avail_out?P:C):(e.strstart>e.block_start&&(N(e,!1),e.strm.avail_out),R)}),new z(4,4,8,4,j),new z(4,5,16,8,j),new z(4,6,32,32,j),new z(4,4,16,16,U),new z(8,16,32,32,U),new z(8,16,128,128,U),new z(8,32,128,256,U),new z(32,128,258,1024,U),new z(32,258,258,4096,U)],n.deflateInit=function(e,t){return X(e,t,y,15,8,0)},n.deflateInit2=X,n.deflateReset=Y,n.deflateResetKeep=W,n.deflateSetHeader=function(e,t){return!e||!e.state||2!==e.state.wrap?m:(e.state.gzhead=t,p)},n.deflate=function(e,t){var n,i,r,o;if(!e||!e.state||5<t||t<0)return e?B(e,m):m;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||666===n.status&&t!==c)return B(e,0===e.avail_out?-5:m);if(n.strm=e,a=n.last_flush,n.last_flush=t,n.status===T&&(2===n.wrap?(e.adler=0,F(n,31),F(n,139),F(n,8),n.gzhead?(F(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),F(n,255&n.gzhead.time),F(n,n.gzhead.time>>8&255),F(n,n.gzhead.time>>16&255),F(n,n.gzhead.time>>24&255),F(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),F(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(F(n,255&n.gzhead.extra.length),F(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=f(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(F(n,0),F(n,0),F(n,0),F(n,0),F(n,0),F(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),F(n,3),n.status=A)):(o=y+(n.w_bits-8<<4)<<8,o|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(o|=32),o+=31-o%31,n.status=A,_(n,o),0!==n.strstart&&(_(n,e.adler>>>16),_(n,65535&e.adler)),e.adler=1)),69===n.status)if(n.gzhead.extra){for(i=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),H(e),i=n.pending,n.pending!==n.pending_buf_size));)F(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),H(e),i=n.pending,n.pending===n.pending_buf_size)){r=1;break}}while(r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,F(n,r),0!==r);n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),0===r&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),H(e),i=n.pending,n.pending===n.pending_buf_size)){r=1;break}}while(r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,F(n,r),0!==r);n.gzhead.hcrc&&n.pending>i&&(e.adler=f(e.adler,n.pending_buf,n.pending-i,i)),0===r&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&H(e),n.pending+2<=n.pending_buf_size&&(F(n,255&e.adler),F(n,e.adler>>8&255),e.adler=0,n.status=A)):n.status=A),0!==n.pending){if(H(e),0===e.avail_out)return n.last_flush=-1,p}else if(0===e.avail_in&&L(t)<=L(a)&&t!==c)return B(e,-5);if(666===n.status&&0!==e.avail_in)return B(e,-5);if(0!==e.avail_in||0!==n.lookahead||t!==d&&666!==n.status){var a=2===n.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(V(e),0===e.lookahead)){if(t===d)return R;break}if(e.match_length=0,n=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(N(e,!1),0===e.strm.avail_out))return R}return e.insert=0,t===c?(N(e,!0),0===e.strm.avail_out?P:C):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?R:O}(n,t):3===n.strategy?function(e,t){for(var n,i,r,o,a=e.window;;){if(e.lookahead<=I){if(V(e),e.lookahead<=I&&t===d)return R;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=w&&0<e.strstart&&(i=a[r=e.strstart-1])===a[++r]&&i===a[++r]&&i===a[++r]){for(o=e.strstart+I;i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&r<o;);e.match_length=I-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=w?(n=l._tr_tally(e,1,e.match_length-w),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(N(e,!1),0===e.strm.avail_out))return R}return e.insert=0,t===c?(N(e,!0),0===e.strm.avail_out?P:C):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?R:O}(n,t):s[n.level].func(n,t);if(a!==P&&a!==C||(n.status=666),a===R||a===P)return 0===e.avail_out&&(n.last_flush=-1),p;if(a===O&&(1===t?l._tr_align(n):5!==t&&(l._tr_stored_block(n,0,0,!1),3===t&&(D(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),H(e),0===e.avail_out))return n.last_flush=-1,p}return t!==c?p:n.wrap<=0?1:(2===n.wrap?(F(n,255&e.adler),F(n,e.adler>>8&255),F(n,e.adler>>16&255),F(n,e.adler>>24&255),F(n,255&e.total_in),F(n,e.total_in>>8&255),F(n,e.total_in>>16&255),F(n,e.total_in>>24&255)):(_(n,e.adler>>>16),_(n,65535&e.adler)),H(e),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?p:1)},n.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==T&&69!==t&&73!==t&&91!==t&&103!==t&&t!==A&&666!==t?B(e,m):(e.state=null,t===A?B(e,-3):p):m},n.deflateSetDictionary=function(e,t){var n,i,r,o,a,s,l,d=t.length;if(!e||!e.state)return m;if(2===(o=(n=e.state).wrap)||1===o&&n.status!==T||n.lookahead)return m;for(1===o&&(e.adler=u(e.adler,t,d,0)),n.wrap=0,d>=n.w_size&&(0===o&&(D(n.head),n.strstart=0,n.block_start=0,n.insert=0),l=new h.Buf8(n.w_size),h.arraySet(l,t,d-n.w_size,n.w_size,0),t=l,d=n.w_size),a=e.avail_in,s=e.next_in,l=e.input,e.avail_in=d,e.next_in=0,e.input=t,V(n);n.lookahead>=w;){for(i=n.strstart,r=n.lookahead-(w-1);n.ins_h=(n.ins_h<<n.hash_shift^n.window[i+w-1])&n.hash_mask,n.prev[i&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=i,i++,--r;);n.strstart=i,n.lookahead=w-1,V(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=w-1,n.match_available=0,e.next_in=s,e.input=l,e.avail_in=a,n.wrap=o,p},n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(e,t,n){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(e,t,n){t.exports=function(e,t){var n,i,r,o,a,s,l=e.state,d=e.next_in,c=e.input,h=d+(e.avail_in-5),u=e.next_out,f=e.output,p=u-(t-e.avail_out),m=u+(e.avail_out-257),g=l.dmax,v=l.wsize,y=l.whave,E=l.wnext,b=l.window,M=l.hold,x=l.bits,w=l.lencode,I=l.distcode,S=(1<<l.lenbits)-1,T=(1<<l.distbits)-1;e:do{x<15&&(M+=c[d++]<<x,x+=8,M+=c[d++]<<x,x+=8),n=w[M&S];t:for(;;){if(M>>>=i=n>>>24,x-=i,0===(i=n>>>16&255))f[u++]=65535&n;else{if(!(16&i)){if(0==(64&i)){n=w[(65535&n)+(M&(1<<i)-1)];continue t}if(32&i){l.mode=12;break e}e.msg="invalid literal/length code",l.mode=30;break e}r=65535&n,(i&=15)&&(x<i&&(M+=c[d++]<<x,x+=8),r+=M&(1<<i)-1,M>>>=i,x-=i),x<15&&(M+=c[d++]<<x,x+=8,M+=c[d++]<<x,x+=8),n=I[M&T];n:for(;;){if(M>>>=i=n>>>24,x-=i,!(16&(i=n>>>16&255))){if(0==(64&i)){n=I[(65535&n)+(M&(1<<i)-1)];continue n}e.msg="invalid distance code",l.mode=30;break e}if(o=65535&n,x<(i&=15)&&(M+=c[d++]<<x,(x+=8)<i&&(M+=c[d++]<<x,x+=8)),g<(o+=M&(1<<i)-1)){e.msg="invalid distance too far back",l.mode=30;break e}if(M>>>=i,x-=i,(i=u-p)<o){if(y<(i=o-i)&&l.sane){e.msg="invalid distance too far back",l.mode=30;break e}if(s=b,(a=0)===E){if(a+=v-i,i<r){for(r-=i;f[u++]=b[a++],--i;);a=u-o,s=f}}else if(E<i){if(a+=v+E-i,(i-=E)<r){for(r-=i;f[u++]=b[a++],--i;);if(a=0,E<r){for(r-=i=E;f[u++]=b[a++],--i;);a=u-o,s=f}}}else if(a+=E-i,i<r){for(r-=i;f[u++]=b[a++],--i;);a=u-o,s=f}for(;2<r;)f[u++]=s[a++],f[u++]=s[a++],f[u++]=s[a++],r-=3;r&&(f[u++]=s[a++],1<r&&(f[u++]=s[a++]))}else{for(a=u-o;f[u++]=f[a++],f[u++]=f[a++],f[u++]=f[a++],2<(r-=3););r&&(f[u++]=f[a++],1<r&&(f[u++]=f[a++]))}break}}break}}while(d<h&&u<m);M&=(1<<(x-=(r=x>>3)<<3))-1,e.next_in=d-=r,e.next_out=u,e.avail_in=d<h?h-d+5:5-(d-h),e.avail_out=u<m?m-u+257:257-(u-m),l.hold=M,l.bits=x}},{}],11:[function(e,t,n){var O=e("../utils/common"),P=e("./adler32"),C=e("./crc32"),B=e("./inffast"),L=e("./inftrees"),D=1,H=2,N=0,F=-2,_=1,i=852,r=592;function k(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function o(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new O.Buf16(320),this.work=new O.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function a(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=_,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new O.Buf32(i),t.distcode=t.distdyn=new O.Buf32(r),t.sane=1,t.back=-1,N):F}function s(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,a(e)):F}function l(e,t){var n,i;return e&&e.state?(i=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?F:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,s(e))):F}function d(e,t){var n;return e?(n=new o,(e.state=n).window=null,(t=l(e,t))!==N&&(e.state=null),t):F}var V,j,U=!0;function z(e,t,n,i){var r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new O.Buf8(r.wsize)),i>=r.wsize?(O.arraySet(r.window,t,n-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):(e=r.wsize-r.wnext,O.arraySet(r.window,t,n-i,e=i<e?i:e,r.wnext),(i-=e)?(O.arraySet(r.window,t,n-i,i,0),r.wnext=i,r.whave=r.wsize):(r.wnext+=e,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=e))),0}n.inflateReset=s,n.inflateReset2=l,n.inflateResetKeep=a,n.inflateInit=function(e){return d(e,15)},n.inflateInit2=d,n.inflate=function(e,t){var n,i,r,o,a,s,l,d,c,h,u,f,p,m,g,v,y,E,b,M,x,w,I,S,T=0,A=new O.Buf8(4),R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return F;12===(n=e.state).mode&&(n.mode=13),a=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,i=e.input,s=e.avail_in,d=n.hold,c=n.bits,h=s,u=l,w=N;e:for(;;)switch(n.mode){case _:if(0===n.wrap){n.mode=13;break}for(;c<16;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(2&n.wrap&&35615===d){A[n.check=0]=255&d,A[1]=d>>>8&255,n.check=C(n.check,A,2,0),c=d=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",n.mode=30;break}if(8!=(15&d)){e.msg="unknown compression method",n.mode=30;break}if(c-=4,x=8+(15&(d>>>=4)),0===n.wbits)n.wbits=x;else if(x>n.wbits){e.msg="invalid window size",n.mode=30;break}n.dmax=1<<x,e.adler=n.check=1,n.mode=512&d?10:12,c=d=0;break;case 2:for(;c<16;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(n.flags=d,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=30;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=30;break}n.head&&(n.head.text=d>>8&1),512&n.flags&&(A[0]=255&d,A[1]=d>>>8&255,n.check=C(n.check,A,2,0)),c=d=0,n.mode=3;case 3:for(;c<32;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.head&&(n.head.time=d),512&n.flags&&(A[0]=255&d,A[1]=d>>>8&255,A[2]=d>>>16&255,A[3]=d>>>24&255,n.check=C(n.check,A,4,0)),c=d=0,n.mode=4;case 4:for(;c<16;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&n.flags&&(A[0]=255&d,A[1]=d>>>8&255,n.check=C(n.check,A,2,0)),c=d=0,n.mode=5;case 5:if(1024&n.flags){for(;c<16;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.length=d,n.head&&(n.head.extra_len=d),512&n.flags&&(A[0]=255&d,A[1]=d>>>8&255,n.check=C(n.check,A,2,0)),c=d=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((f=s<(f=n.length)?s:f)&&(n.head&&(x=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),O.arraySet(n.head.extra,i,o,f,x)),512&n.flags&&(n.check=C(n.check,i,f,o)),s-=f,o+=f,n.length-=f),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===s)break e;for(f=0;x=i[o+f++],n.head&&x&&n.length<65536&&(n.head.name+=String.fromCharCode(x)),x&&f<s;);if(512&n.flags&&(n.check=C(n.check,i,f,o)),s-=f,o+=f,x)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===s)break e;for(f=0;x=i[o+f++],n.head&&x&&n.length<65536&&(n.head.comment+=String.fromCharCode(x)),x&&f<s;);if(512&n.flags&&(n.check=C(n.check,i,f,o)),s-=f,o+=f,x)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;c<16;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(d!==(65535&n.check)){e.msg="header crc mismatch",n.mode=30;break}c=d=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=12;break;case 10:for(;c<32;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}e.adler=n.check=k(d),c=d=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,n.hold=d,n.bits=c,2;e.adler=n.check=1,n.mode=12;case 12:if(5===t||6===t)break e;case 13:if(n.last){d>>>=7&c,c-=7&c,n.mode=27;break}for(;c<3;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}switch(n.last=1&d,--c,3&(d>>>=1)){case 0:n.mode=14;break;case 1:if(!function(e){if(U){var t;for(V=new O.Buf32(512),j=new O.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(L(D,e.lens,0,288,V,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;L(H,e.lens,0,32,j,0,e.work,{bits:5}),U=!1}e.lencode=V,e.lenbits=9,e.distcode=j,e.distbits=5}(n),n.mode=20,6!==t)break;d>>>=2,c-=2;break e;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=30}d>>>=2,c-=2;break;case 14:for(d>>>=7&c,c-=7&c;c<32;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",n.mode=30;break}if(n.length=65535&d,c=d=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(f=n.length){if(0===(f=l<(f=s<f?s:f)?l:f))break e;O.arraySet(r,i,o,f,a),s-=f,o+=f,l-=f,a+=f,n.length-=f;break}n.mode=12;break;case 17:for(;c<14;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(n.nlen=257+(31&d),d>>>=5,c-=5,n.ndist=1+(31&d),d>>>=5,c-=5,n.ncode=4+(15&d),d>>>=4,c-=4,286<n.nlen||30<n.ndist){e.msg="too many length or distance symbols",n.mode=30;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;c<3;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.lens[R[n.have++]]=7&d,d>>>=3,c-=3}for(;n.have<19;)n.lens[R[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,I={bits:n.lenbits},w=L(0,n.lens,0,19,n.lencode,0,n.work,I),n.lenbits=I.bits,w){e.msg="invalid code lengths set",n.mode=30;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;v=(T=n.lencode[d&(1<<n.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(y<16)d>>>=g,c-=g,n.lens[n.have++]=y;else{if(16===y){for(S=g+2;c<S;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(d>>>=g,c-=g,0===n.have){e.msg="invalid bit length repeat",n.mode=30;break}x=n.lens[n.have-1],f=3+(3&d),d>>>=2,c-=2}else if(17===y){for(S=g+3;c<S;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}c-=g,x=0,f=3+(7&(d>>>=g)),d>>>=3,c-=3}else{for(S=g+7;c<S;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}c-=g,x=0,f=11+(127&(d>>>=g)),d>>>=7,c-=7}if(n.have+f>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=30;break}for(;f--;)n.lens[n.have++]=x}}if(30===n.mode)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=30;break}if(n.lenbits=9,I={bits:n.lenbits},w=L(D,n.lens,0,n.nlen,n.lencode,0,n.work,I),n.lenbits=I.bits,w){e.msg="invalid literal/lengths set",n.mode=30;break}if(n.distbits=6,n.distcode=n.distdyn,I={bits:n.distbits},w=L(H,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,I),n.distbits=I.bits,w){e.msg="invalid distances set",n.mode=30;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(6<=s&&258<=l){e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,n.hold=d,n.bits=c,B(e,u),a=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,i=e.input,s=e.avail_in,d=n.hold,c=n.bits,12===n.mode&&(n.back=-1);break}for(n.back=0;v=(T=n.lencode[d&(1<<n.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(v&&0==(240&v)){for(E=g,b=v,M=y;v=(T=n.lencode[M+((d&(1<<E+b)-1)>>E)])>>>16&255,y=65535&T,!(E+(g=T>>>24)<=c);){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}d>>>=E,c-=E,n.back+=E}if(d>>>=g,c-=g,n.back+=g,n.length=y,0===v){n.mode=26;break}if(32&v){n.back=-1,n.mode=12;break}if(64&v){e.msg="invalid literal/length code",n.mode=30;break}n.extra=15&v,n.mode=22;case 22:if(n.extra){for(S=n.extra;c<S;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,c-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;v=(T=n.distcode[d&(1<<n.distbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(0==(240&v)){for(E=g,b=v,M=y;v=(T=n.distcode[M+((d&(1<<E+b)-1)>>E)])>>>16&255,y=65535&T,!(E+(g=T>>>24)<=c);){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}d>>>=E,c-=E,n.back+=E}if(d>>>=g,c-=g,n.back+=g,64&v){e.msg="invalid distance code",n.mode=30;break}n.offset=y,n.extra=15&v,n.mode=24;case 24:if(n.extra){for(S=n.extra;c<S;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,c-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=30;break}n.mode=25;case 25:if(0===l)break e;if(n.offset>(f=u-l)){if((f=n.offset-f)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=30;break}p=f>n.wnext?(f-=n.wnext,n.wsize-f):n.wnext-f,f>n.length&&(f=n.length),m=n.window}else m=r,p=a-n.offset,f=n.length;for(l-=f=l<f?l:f,n.length-=f;r[a++]=m[p++],--f;);0===n.length&&(n.mode=21);break;case 26:if(0===l)break e;r[a++]=n.length,l--,n.mode=21;break;case 27:if(n.wrap){for(;c<32;){if(0===s)break e;s--,d|=i[o++]<<c,c+=8}if(u-=l,e.total_out+=u,n.total+=u,u&&(e.adler=n.check=(n.flags?C:P)(n.check,r,u,a-u)),u=l,(n.flags?d:k(d))!==n.check){e.msg="incorrect data check",n.mode=30;break}c=d=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;c<32;){if(0===s)break e;s--,d+=i[o++]<<c,c+=8}if(d!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=30;break}c=d=0}n.mode=29;case 29:w=1;break e;case 30:w=-3;break e;case 31:return-4;case 32:default:return F}return e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,n.hold=d,n.bits=c,(n.wsize||u!==e.avail_out&&n.mode<30&&(n.mode<27||4!==t))&&z(e,e.output,e.next_out,u-e.avail_out)?(n.mode=31,-4):(h-=e.avail_in,u-=e.avail_out,e.total_in+=h,e.total_out+=u,n.total+=u,n.wrap&&u&&(e.adler=n.check=(n.flags?C:P)(n.check,r,u,e.next_out-u)),e.data_type=n.bits+(n.last?64:0)+(12===n.mode?128:0)+(20===n.mode||15===n.mode?256:0),(0==h&&0===u||4===t)&&w===N?-5:w)},n.inflateEnd=function(e){if(!e||!e.state)return F;var t=e.state;return t.window&&(t.window=null),e.state=null,N},n.inflateGetHeader=function(e,t){return!e||!e.state||0==(2&(e=e.state).wrap)?F:((e.head=t).done=!1,N)},n.inflateSetDictionary=function(e,t){var n,i=t.length;return!e||!e.state||0!==(n=e.state).wrap&&11!==n.mode?F:11===n.mode&&P(1,t,i,0)!==n.check?-3:z(e,t,i,i)?(n.mode=31,-4):(n.havedict=1,N)},n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(e,t,n){var D=e("../utils/common"),H=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],N=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],F=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,n,i,r,o,a,s){for(var l,d,c,h,u,f,p,m,g,v=s.bits,y=0,E=0,b=0,M=0,x=0,w=0,I=0,S=0,T=0,A=0,R=null,O=0,P=new D.Buf16(16),C=new D.Buf16(16),B=null,L=0,y=0;y<=15;y++)P[y]=0;for(E=0;E<i;E++)P[t[n+E]]++;for(x=v,M=15;1<=M&&0===P[M];M--);if(M<x&&(x=M),0===M)return r[o++]=20971520,r[o++]=20971520,s.bits=1,0;for(b=1;b<M&&0===P[b];b++);for(x<b&&(x=b),y=S=1;y<=15;y++)if(S<<=1,(S-=P[y])<0)return-1;if(0<S&&(0===e||1!==M))return-1;for(C[1]=0,y=1;y<15;y++)C[y+1]=C[y]+P[y];for(E=0;E<i;E++)0!==t[n+E]&&(a[C[t[n+E]]++]=E);if(f=0===e?(R=B=a,19):1===e?(R=H,O-=257,B=N,L-=257,256):(R=F,B=_,-1),y=b,u=o,I=E=A=0,c=-1,h=(T=1<<(w=x))-1,1===e&&852<T||2===e&&592<T)return 1;for(;;){for(g=a[E]<f?(m=0,a[E]):a[E]>f?(m=B[L+a[E]],R[O+a[E]]):(m=96,0),l=1<<(p=y-I),b=d=1<<w;r[u+(A>>I)+(d-=l)]=p<<24|m<<16|g|0,0!==d;);for(l=1<<y-1;A&l;)l>>=1;if(0!==l?(A&=l-1,A+=l):A=0,E++,0==--P[y]){if(y===M)break;y=t[n+a[E]]}if(x<y&&(A&h)!==c){for(u+=b,S=1<<(w=y-(I=0===I?x:I));w+I<M&&!((S-=P[w+I])<=0);)w++,S<<=1;if(T+=1<<w,1===e&&852<T||2===e&&592<T)return 1;r[c=A&h]=x<<24|w<<16|u-o|0}}return 0!==A&&(r[u+A]=y-I<<24|64<<16|0),s.bits=x,0}},{"../utils/common":3}],13:[function(e,t,n){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(e,t,n){var r=e("../utils/common"),s=0,l=1;function i(e){for(var t=e.length;0<=--t;)e[t]=0}var o=0,a=29,d=256,c=d+1+a,h=30,u=19,g=2*c+1,v=15,f=16,p=7,m=256,y=16,E=17,b=18,M=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],x=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],w=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],I=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],S=new Array(2*(c+2));i(S);var T=new Array(2*h);i(T);var A=new Array(512);i(A);var R=new Array(256);i(R);var O=new Array(a);i(O);var P,C,B,L=new Array(h);function D(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}function H(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function N(e){return e<256?A[e]:A[256+(e>>>7)]}function F(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function _(e,t,n){e.bi_valid>f-n?(e.bi_buf|=t<<e.bi_valid&65535,F(e,e.bi_buf),e.bi_buf=t>>f-e.bi_valid,e.bi_valid+=n-f):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function k(e,t,n){_(e,n[2*t],n[2*t+1])}function V(e,t){for(var n=0;n|=1&e,e>>>=1,n<<=1,0<--t;);return n>>>1}function j(e,t,n){for(var i,r=new Array(v+1),o=0,a=1;a<=v;a++)r[a]=o=o+n[a-1]<<1;for(i=0;i<=t;i++){var s=e[2*i+1];0!==s&&(e[2*i]=V(r[s]++,s))}}function U(e){for(var t=0;t<c;t++)e.dyn_ltree[2*t]=0;for(t=0;t<h;t++)e.dyn_dtree[2*t]=0;for(t=0;t<u;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*m]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function z(e){8<e.bi_valid?F(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function G(e,t,n,i){var r=2*t,o=2*n;return e[r]<e[o]||e[r]===e[o]&&i[t]<=i[n]}function W(e,t,n){for(var i=e.heap[n],r=n<<1;r<=e.heap_len&&(r<e.heap_len&&G(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!G(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i}function Y(e,t,n){var i,r,o,a,s=0;if(0!==e.last_lit)for(;i=e.pending_buf[e.d_buf+2*s]<<8|e.pending_buf[e.d_buf+2*s+1],r=e.pending_buf[e.l_buf+s],s++,0==i?k(e,r,t):(k(e,(o=R[r])+d+1,t),0!==(a=M[o])&&_(e,r-=O[o],a),k(e,o=N(--i),n),0!==(a=x[o])&&_(e,i-=L[o],a)),s<e.last_lit;);k(e,m,t)}function X(e,t){var n,i,r,o=t.dyn_tree,a=t.stat_desc.static_tree,s=t.stat_desc.has_stree,l=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=g,n=0;n<l;n++)0!==o[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):o[2*n+1]=0;for(;e.heap_len<2;)o[2*(r=e.heap[++e.heap_len]=d<2?++d:0)]=1,e.depth[r]=0,e.opt_len--,s&&(e.static_len-=a[2*r+1]);for(t.max_code=d,n=e.heap_len>>1;1<=n;n--)W(e,o,n);for(r=l;n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],W(e,o,1),i=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=i,o[2*r]=o[2*n]+o[2*i],e.depth[r]=(e.depth[n]>=e.depth[i]?e.depth[n]:e.depth[i])+1,o[2*n+1]=o[2*i+1]=r,e.heap[1]=r++,W(e,o,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e,t){for(var n,i,r,o,a,s=t.dyn_tree,l=t.max_code,d=t.stat_desc.static_tree,c=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,u=t.stat_desc.extra_base,f=t.stat_desc.max_length,p=0,m=0;m<=v;m++)e.bl_count[m]=0;for(s[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<g;n++)f<(m=s[2*s[2*(i=e.heap[n])+1]+1]+1)&&(m=f,p++),s[2*i+1]=m,l<i||(e.bl_count[m]++,o=0,u<=i&&(o=h[i-u]),a=s[2*i],e.opt_len+=a*(m+o),c&&(e.static_len+=a*(d[2*i+1]+o)));if(0!==p){do{for(m=f-1;0===e.bl_count[m];)m--}while(e.bl_count[m]--,e.bl_count[m+1]+=2,e.bl_count[f]--,0<(p-=2));for(m=f;0!==m;m--)for(i=e.bl_count[m];0!==i;)l<(r=e.heap[--n])||(s[2*r+1]!==m&&(e.opt_len+=(m-s[2*r+1])*s[2*r],s[2*r+1]=m),i--)}}(e,t),j(o,d,e.bl_count)}function Z(e,t,n){var i,r,o=-1,a=t[1],s=0,l=7,d=4;for(0===a&&(l=138,d=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)r=a,a=t[2*(i+1)+1],++s<l&&r===a||(s<d?e.bl_tree[2*r]+=s:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[2*y]++):s<=10?e.bl_tree[2*E]++:e.bl_tree[2*b]++,o=r,d=(s=0)===a?(l=138,3):r===a?(l=6,3):(l=7,4))}function q(e,t,n){var i,r,o=-1,a=t[1],s=0,l=7,d=4;for(0===a&&(l=138,d=3),i=0;i<=n;i++)if(r=a,a=t[2*(i+1)+1],!(++s<l&&r===a)){if(s<d)for(;k(e,r,e.bl_tree),0!=--s;);else 0!==r?(r!==o&&(k(e,r,e.bl_tree),s--),k(e,y,e.bl_tree),_(e,s-3,2)):s<=10?(k(e,E,e.bl_tree),_(e,s-3,3)):(k(e,b,e.bl_tree),_(e,s-11,7));o=r,d=(s=0)===a?(l=138,3):r===a?(l=6,3):(l=7,4)}}i(L);var Q=!1;function J(e,t,n,i){_(e,(o<<1)+(i?1:0),3),i=t,t=n,n=!0,z(e=e),n&&(F(e,t),F(e,~t)),r.arraySet(e.pending_buf,e.window,i,t,e.pending),e.pending+=t}n._tr_init=function(e){Q||(function(){for(var e,t,n,i=new Array(v+1),r=0,o=0;o<a-1;o++)for(O[o]=r,e=0;e<1<<M[o];e++)R[r++]=o;for(R[r-1]=o,o=n=0;o<16;o++)for(L[o]=n,e=0;e<1<<x[o];e++)A[n++]=o;for(n>>=7;o<h;o++)for(L[o]=n<<7,e=0;e<1<<x[o]-7;e++)A[256+n++]=o;for(t=0;t<=v;t++)i[t]=0;for(e=0;e<=143;)S[2*e+1]=8,e++,i[8]++;for(;e<=255;)S[2*e+1]=9,e++,i[9]++;for(;e<=279;)S[2*e+1]=7,e++,i[7]++;for(;e<=287;)S[2*e+1]=8,e++,i[8]++;for(j(S,c+1,i),e=0;e<h;e++)T[2*e+1]=5,T[2*e]=V(e,5);P=new D(S,M,d+1,c,v),C=new D(T,x,0,h,v),B=new D(new Array(0),w,0,u,p)}(),Q=!0),e.l_desc=new H(e.dyn_ltree,P),e.d_desc=new H(e.dyn_dtree,C),e.bl_desc=new H(e.bl_tree,B),e.bi_buf=0,e.bi_valid=0,U(e)},n._tr_stored_block=J,n._tr_flush_block=function(e,t,n,i){var r,o,a=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function(e){for(var t=4093624447,n=0;n<=31;n++,t>>>=1)if(1&t&&0!==e.dyn_ltree[2*n])return s;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return l;for(n=32;n<d;n++)if(0!==e.dyn_ltree[2*n])return l;return s}(e)),X(e,e.l_desc),X(e,e.d_desc),a=function(e){var t;for(Z(e,e.dyn_ltree,e.l_desc.max_code),Z(e,e.dyn_dtree,e.d_desc.max_code),X(e,e.bl_desc),t=u-1;3<=t&&0===e.bl_tree[2*I[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=r&&(r=o)):r=o=n+5,n+4<=r&&-1!==t?J(e,t,n,i):4===e.strategy||o===r?(_(e,2+(i?1:0),3),Y(e,S,T)):(_(e,4+(i?1:0),3),function(e,t,n,i){var r;for(_(e,t-257,5),_(e,n-1,5),_(e,i-4,4),r=0;r<i;r++)_(e,e.bl_tree[2*I[r]+1],3);q(e,e.dyn_ltree,t-1),q(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),Y(e,e.dyn_ltree,e.dyn_dtree)),U(e),i&&z(e)},n._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(R[n]+d+1)]++,e.dyn_dtree[2*N(t)]++),e.last_lit===e.lit_bufsize-1},n._tr_align=function(e){_(e,2,3),k(e,m,S),16===(e=e).bi_valid?(F(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}},{"../utils/common":3}],15:[function(e,t,n){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(e,t,n){var i={};(0,e("./lib/utils/common").assign)(i,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=i},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")})}.call(this,i(134)(e),i(135))},function(e,t){e.exports=function(e){var t;return e.webpackPolyfill||((t=Object.create(e)).children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1),t}},function(e,t){var n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var c=n(13),h=n(15),u=n(95),f=n(68);n(69)("match",1,function(i,r,l,d){return[function(e){var t=i(this),n=null==e?void 0:e[r];return void 0!==n?n.call(e,t):new RegExp(e)[r](String(t))},function(e){var t=d(l,e,this);if(t.done)return t.value;var n=c(e),i=String(this);if(!n.global)return f(n,i);for(var r=n.unicode,o=[],a=n.lastIndex=0;null!==(s=f(n,i));){var s=String(s[0]);""===(o[a]=s)&&(n.lastIndex=u(i,h(n.lastIndex),r)),a++}return 0===a?null:o}]})},function(e,t,n){"use strict";var i=n(96);n(1)({target:"RegExp",proto:!0,forced:i!==/./.exec},{exec:i})},function(e,t,n){n(30)("Uint8",1,function(i){return function(e,t,n){return i(this,e,t,n)}},!0)},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,n){"use strict";var u=n(46),f=n(78),p=n(62),m=n(25),g=n(74),r=Object.assign;e.exports=!r||n(9)(function(){var e={},t={},n=Symbol(),i="abcdefghijklmnopqrst";return e[n]=7,i.split("").forEach(function(e){t[e]=e}),7!=r({},e)[n]||Object.keys(r({},t)).join("")!=i})?function(e,t){for(var n=m(e),i=arguments.length,r=1,o=f.f,a=p.f;r<i;)for(var s,l=g(arguments[r++]),d=o?u(l).concat(o(l)):u(l),c=d.length,h=0;h<c;)a.call(l,s=d[h++])&&(n[s]=l[s]);return n}:r},function(e,t,n){"use strict";var h=n(35),i=n(1),u=n(25),f=n(115),p=n(83),m=n(15),g=n(142),v=n(84);i(i.S+i.F*!n(87)(function(e){Array.from(e)}),"Array",{from:function(e){var t,n,i,r,o=u(e),a="function"==typeof this?this:Array,s=arguments.length,l=1<s?arguments[1]:void 0,d=void 0!==l,c=0,e=v(o);if(d&&(l=h(l,2<s?arguments[2]:void 0,2)),null==e||a==Array&&p(e))for(n=new a(t=m(o.length));c<t;c++)g(n,c,d?l(o[c],c):o[c]);else for(r=e.call(o),n=new a;!(i=r.next()).done;c++)g(n,c,d?f(r,l,[i.value,c],!0):i.value);return n.length=c,n}})},function(e,t,n){"use strict";var i=n(10),r=n(45);e.exports=function(e,t,n){t in e?i.f(e,t,r(0,n)):e[t]=n}},function(e,t,n){n(30)("Int8",1,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){var i=n(1);i(i.G+i.W+i.F*!n(80).ABV,{DataView:n(106).DataView})},function(e,t,n){"use strict";var r=n(27),o=n(37);e.exports=function(e){var t=String(o(this)),n="",i=r(e);if(i<0||i==1/0)throw RangeError("Count can't be negative");for(;0<i;(i>>>=1)&&(t+=t))1&i&&(n+=t);return n}},function(e,t,n){var i=n(6),o=n(90),r=n(10).f,a=n(48).f,s=n(114),l=n(67),d=p=i.RegExp,c=p.prototype,h=/a/g,u=/a/g,f=new p(h)!==h;if(n(8)&&(!f||n(9)(function(){return u[n(7)("match")]=!1,p(h)!=h||p(u)==u||"/a/i"!=p(h,"i")}))){for(var p=function(e,t){var n=this instanceof p,i=s(e),r=void 0===t;return!n&&i&&e.constructor===p&&r?e:o(f?new d(i&&!r?e.source:e,t):d((i=e instanceof p)?e.source:e,i&&r?l.call(e):t),n?this:c,p)},m=a(d),g=0;m.length>g;)!function(t){t in p||r(p,t,{configurable:!0,get:function(){return d[t]},set:function(e){d[t]=e}})}(m[g++]);(c.constructor=p).prototype=c,n(20)(i,"RegExp",p)}n(88)("RegExp")},function(e,t,n){n(30)("Float64",8,function(i){return function(e,t,n){return i(this,e,t,n)}})},function(e,t,n){var i=n(1);i(i.S,"Number",{isInteger:n(149)})},function(e,t,n){var i=n(14),r=Math.floor;e.exports=function(e){return!i(e)&&isFinite(e)&&r(e)===e}},function(e,t,n){var i=n(1),n=n(151);i(i.S+i.F*(Number.parseFloat!=n),"Number",{parseFloat:n})},function(e,t,n){var i=n(6).parseFloat,r=n(91).trim;e.exports=1/i(n(111)+"-0")!=-1/0?function(e){var t=r(String(e),3),e=i(t);return 0===e&&"-"==t.charAt(0)?-0:e}:i},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t,n){"use strict";n(92)("link",function(t){return function(e){return t(this,"a","href",e)}})},function(e,t,n){"use strict";n.r(t),n.d(t,"Viewer",function(){return Qn}),n.d(t,"COMMON",function(){return ye}),n.d(t,"SETTING",function(){return Ue}),n.d(t,"DecalGeometry",function(){return f}),n.d(t,"NdsCoordSystem",function(){return be}),n.d(t,"CTMLoader",function(){return oe}),n.d(t,"BIMJSONLoader",function(){return se}),n.d(t,"BIMObjectLoader",function(){return Fe}),n.d(t,"BIMXHRLoader",function(){return He}),n.d(t,"BIMLoader",function(){return D}),n.d(t,"SDFCreater",function(){return _}),n.d(t,"BrepManager",function(){return Ne}),n.d(t,"MaterialsSetting",function(){return le}),n.d(t,"NdsMeshManager",function(){return I}),n.d(t,"NdsGeometry",function(){return ae}),n.d(t,"NdsBodyNode",function(){return De}),n.d(t,"NdsModel",function(){return ze}),n.d(t,"BVHCreater",function(){return K}),n.d(t,"NdsModelBvh",function(){return T}),n.d(t,"NdsMeshSet",function(){return S}),n.d(t,"NdsLeafBodyAttri",function(){return b}),n.d(t,"NdsCoordSystemAttri",function(){return M}),n.d(t,"PropertyManager",function(){return Zt}),n.d(t,"MeasureBase",function(){return Xe}),n.d(t,"SelectionManager",function(){return Jt}),n.d(t,"Extension",function(){return zn}),n.d(t,"ExtensionManager",function(){return Gn});n(28),n(29),n(0),n(126),n(38),n(5),n(21),n(16),n(18),n(89),n(31),n(58),n(39),n(132),n(2),n(3),n(112),n(32),n(4),n(93),n(94),n(51),n(17),n(22);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}yt=window,t=function(e){},"object"===("undefined"==typeof exports?"undefined":r(exports))&&void 0!==e?t(exports):"function"==typeof define&&n(66)?define(["exports"],t):t(yt.NDS={});n(133),n(138),n(59);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e){function d(){}function c(e,t,n,i,r,o,a,s,l,d){for(var c,h,u=0,f=r;f!==a;f+=o)for(h=s;h!==d;h+=l,u++)c=t[u],e[4*(h+i*f)+3]=255,e[4*(h+i*f)+2]=n[3*c+0],e[4*(h+i*f)+1]=n[3*c+1],e[4*(h+i*f)+0]=n[3*c+2];return e}function h(e,t,n,i,r,o,a,s,l,d){for(var c,h,u=0,f=r;f!==a;f+=o)for(h=s;h!==d;h+=l,u+=2)c=t[u+0]|t[u+1]<<8,e[4*(h+i*f)+0]=(31744&c)>>7,e[4*(h+i*f)+1]=(992&c)>>2,e[4*(h+i*f)+2]=(31&c)>>3,e[4*(h+i*f)+3]=32768&c?0:255;return e}function u(e,t,n,i,r,o,a,s,l,d){for(var c,h=0,u=r;u!==a;u+=o)for(c=s;c!==d;c+=l,h+=3)e[4*(c+i*u)+3]=255,e[4*(c+i*u)+2]=t[h+0],e[4*(c+i*u)+1]=t[h+1],e[4*(c+i*u)+0]=t[h+2];return e}function f(e,t,n,i,r,o,a,s,l,d){for(var c,h=0,u=r;u!==a;u+=o)for(c=s;c!==d;c+=l,h+=4)e[4*(c+i*u)+2]=t[h+0],e[4*(c+i*u)+1]=t[h+1],e[4*(c+i*u)+0]=t[h+2],e[4*(c+i*u)+3]=t[h+3];return e}function p(e,t,n,i,r,o,a,s,l,d){for(var c,h,u=0,f=r;f!==a;f+=o)for(h=s;h!==d;h+=l,u++)c=t[u],e[4*(h+i*f)+0]=c,e[4*(h+i*f)+1]=c,e[4*(h+i*f)+2]=c,e[4*(h+i*f)+3]=255;return e}function m(e,t,n,i,r,o,a,s,l,d){for(var c,h=0,u=r;u!==a;u+=o)for(c=s;c!==d;c+=l,h+=2)e[4*(c+i*u)+0]=t[h+0],e[4*(c+i*u)+1]=t[h+0],e[4*(c+i*u)+2]=t[h+0],e[4*(c+i*u)+3]=t[h+1];return e}d.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},d.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48},d.prototype.open=function(e,t){var n=this,i=new XMLHttpRequest;i.overrideMimeType("text/plain"),i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(n.load(new Uint8Array(i.response)),t&&t.call(n))},i.send(null)},d.prototype.load=function(e){var t=0;if(e.length<18)throw new Error("Targa::load() - Not enough data to contain header");if(this.header={idLength:e[t++],colorMapType:e[t++],imageType:e[t++],colorMapIndex:e[t++]|e[t++]<<8,colorMapLength:e[t++]|e[t++]<<8,colorMapDepth:e[t++],offsetX:e[t++]|e[t++]<<8,offsetY:e[t++]|e[t++]<<8,width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixelDepth:e[t++],flags:e[t++]},this.header.hasEncoding=this.header.imageType===d.Type.RLE_INDEXED||this.header.imageType===d.Type.RLE_RGB||this.header.imageType===d.Type.RLE_GREY,this.header.hasColorMap=this.header.imageType===d.Type.RLE_INDEXED||this.header.imageType===d.Type.INDEXED,this.header.isGreyColor=this.header.imageType===d.Type.RLE_GREY||this.header.imageType===d.Type.GREY,function(e){if(e.imageType===d.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(e.hasColorMap){if(256<e.colorMapLength||24!==e.colorMapSize||1!==e.colorMapType)throw new Error("Targa::checkHeader() - Invalid colormap for indexed type")}else if(e.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(e.width<=0||e.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==e.pixelDepth&&16!==e.pixelDepth&&24!==e.pixelDepth&&32!==e.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+e.pixelDepth+'"')}(this.header),(t+=this.header.idLength)>=e.length)throw new Error("Targa::load() - No data");this.header.hasColorMap&&(r=this.header.colorMapLength*(this.header.colorMapDepth>>3),this.palette=e.subarray(t,t+r),t+=r);var n=this.header.pixelDepth>>3,i=this.header.width*this.header.height,r=i*n;this.header.hasEncoding?this.imageData=function(e,t,n,i){for(var r,o,a,s=new Uint8Array(i),l=new Uint8Array(n),d=0;d<i;)if(o=1+(127&(r=e[t++])),128&r){for(a=0;a<n;++a)l[a]=e[t++];for(a=0;a<o;++a)s.set(l,d),d+=n}else for(o*=n,a=0;a<o;++a)s[d++]=e[t++];return s}(e,t,n,r):this.imageData=e.subarray(t,t+(this.header.hasColorMap?i:r))},d.prototype.getImageData=function(e){var t,n,i,r,o,a=this.header.width,s=this.header.height,l=(this.header.flags&d.Origin.MASK)>>d.Origin.SHIFT;switch(e=e||(document?document.createElement("canvas").getContext("2d").createImageData(a,s):{width:a,height:s,data:new Uint8ClampedArray(a*s*4)}),s=l===d.Origin.TOP_LEFT||l===d.Origin.TOP_RIGHT?(i=0,r=1,s):(i=s-1,r=-1),l=l===d.Origin.TOP_LEFT||l===d.Origin.BOTTOM_LEFT?(t=0,n=1,a):(t=a-1,n=-1),this.header.pixelDepth){case 8:o=this.header.isGreyColor?p:c;break;case 16:o=this.header.isGreyColor?m:h;break;case 24:o=u;break;case 32:o=f}return o(e.data,this.imageData,this.palette,a,i,r,s,t,n,l),e},d.prototype.getCanvas=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=t.createImageData(this.header.width,this.header.height);return e.width=this.header.width,e.height=this.header.height,t.putImageData(this.getImageData(n),0,0),e},d.prototype.getDataURL=function(e){return this.getCanvas().toDataURL(e||"image/png")};var t={};"undefined"==typeof exports?"function"==typeof define&&"object"===o(n(66))&&n(66)?define(function(){return d}):t.exports="undefined"!=typeof window?window:e:t.exports=exports,t.exports&&(t.exports.TGA=d)}(void 0);n(53);var Ue={REVISION:"01",toolbarButtonClickedBkgColor:"",toolbarOpacity:.2,dialogOpacity:.2,bodyOpacity:.4,lineOpacity:.2,OES_element_index_uint:!1,avoidCaching:!0,lineSegAnnotationGridCount:200,enableBroadcast:!1,broadcastMajor:!1};Ue.selectedMaterial=new THREE.MeshStandardMaterial({color:16763200,metalness:.2,roughness:1,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:2,skinning:!1}),Ue.BIMselectedMaterial=new THREE.MeshBasicMaterial({opacity:.7,color:4168151,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0}),Ue.selectedColor=new THREE.Color(16776960),Ue.selectedLineMaterial=new THREE.LineBasicMaterial({color:16776960}),Ue.selectedFaceMaterial=new THREE.MeshBasicMaterial({opacity:.8,color:979390,side:THREE.DoubleSide,transparent:!0}),Ue.preSelectedFaceMaterial=new THREE.MeshBasicMaterial({opacity:.8,color:65535,side:THREE.DoubleSide,transparent:!0}),Ue.selectedEdgeMaterial=new THREE.LineBasicMaterial({color:16744512,opacity:.9,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:1}),Ue.preSelectedEdgeMaterial=new THREE.LineBasicMaterial({color:65535,opacity:.9,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:1}),Ue.selectedVertexMaterial=new THREE.MeshBasicMaterial({color:16711680,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1}),Ue.preSelectedVertexMaterial=new THREE.MeshBasicMaterial({color:65535,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1}),Ue.dashedMaterial=new THREE.ShaderMaterial({uniforms:{lineStyle:{value:-1},dashSize:{value:12},dashNum:{value:1},grapSize:{value:3},pointSize:{value:.5},pointNum:{value:1},opacity:{value:.8},diffuse:{value:new THREE.Color(16711680)}},linewidth:1,transparent:!0,fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float dashNum;","uniform float pointNum;","uniform float grapSize;","uniform float pointSize;","varying float vLineDistance;","#include <common>","#include <color_pars_fragment>","#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","float totalSize = dashSize * dashNum + grapSize * (dashNum + pointNum) + pointSize * pointNum;","float modSize = mod( vLineDistance, totalSize );","bool grap = false;","for(float i = 1.0; i< 4.0; ++i){","if(i > dashNum){","break;","}","if(modSize < i * (grapSize + dashSize) && modSize > i * (grapSize + dashSize) - grapSize){","grap = true;","break;","}","}","if ( grap ) {","discard;","}","float dashlength = dashNum * (grapSize + dashSize);","for(float i = 1.0;i <4.0; ++i){","if(i > pointNum){","break;","}","if(modSize < i * (grapSize + pointSize) + dashlength && ","modSize > i * (grapSize + pointSize) - grapSize + dashlength){","grap = true;","break;","}","}","if ( grap ) {","discard;","}","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","#include <logdepthbuf_fragment>","#include <color_fragment>","outgoingLight = diffuseColor.rgb;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#include <premultiplied_alpha_fragment>","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>","}"].join("\n"),vertexShader:["attribute float lineDistance;","varying float vLineDistance;","#include <common>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <color_vertex>","vLineDistance =  lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","#include <fog_vertex>","}"].join("\n")}),Ue.enableSelect=!1,Ue.autoSwitchFirstPersonView=!1,Ue.tangentEdgeVisible=!0,Ue.enableArrowKeyOp=!0,Ue.dynamicRotateCenter=!0,Ue.loadWorkerUrl="js/core/loaders/BIMCTMWorker.js",Ue.BreploadWorkerUrl="js/core/loaders/BrepLoadWorker.js",Ue.enableOutlineEffect=!1,Ue.enableBodyVolumeMeasure=!1,Ue.enablePreSelectBrep=!1,Ue.enableTextRenderingBothSide=!0,Ue.selectObjectWithPropertyOnly=!1,Ue.enableDirectMove=!1,Ue.enableDirectRotate=!1,Ue.inAssemblyContext=!1,Ue.inBIMContext=!1;var ue=function(n){var l=this,i=null;l.viewer=n;var r=0,o=0,a=0,s=0,d=!1;this.visible=!1;var c=l.uiTreeRoot=null;function h(e){return document.getElementById(e)}function u(e){null!=e&&(e.style.left="1px",e.style.top="1px")}window.onresize=function(){u(h("modelbrowserdialog"))},document.onmousemove=function(e){var t,n=(e=e||window.event).pageX,i=e.pageY;d&&(t=a+n-r,e=s+i-o,h("modelbrowserdialog").style.left=t+"px",h("modelbrowserdialog").style.top=e+"px",n=document.documentElement.clientWidth,i=document.documentElement.clientHeight,n=n-h("modelbrowserdialog").offsetWidth,i=i-h("modelbrowserdialog").offsetHeight,t=Math.min(Math.max(0,t),n),e=Math.min(Math.max(0,e),i),h("modelbrowserdialog").style.left=t+"px",h("modelbrowserdialog").style.top=e+"px")},this.onClose=function(e){0};function f(e,t){e=new THREE.Vector2(e.clientX,e.clientY),"js"===l.viewer.modelInfo[0].type&&Ue.enableSelect&&l.viewer.enableInternalRMB&&(l.viewer.selectionManager.clearSelection(),l.viewer.selectionManager.selectObject(t.object3d),l.viewer.render(),l.viewer.showModelBroserMenu(!1),l.viewer.showModelBroserMenu(!0,e.x,e.y))}function p(e){2===e.button?f(e,this):0===e.button&&"js"===l.viewer.modelInfo[0].type&&(l.viewer.selectionManager.clearSelection(),l.viewer.restoreOriginalMeshes(),l.viewer.selectionManager.selectObject(e.target.object3d),l.viewer.render())}function m(e){var t;0===e.button?(0<=(t=this.group.className).indexOf("collapsed")?t=t.replace(/collapsed/g,"expanded"):0<=t.indexOf("expanded")&&(t=t.replace(/expanded/g,"collapsed")),this.group.className=t):2===e.button&&f(e,this)}this.getUiNodeByObject3d=function(e,t){var n=null;if(t.object3d==e)n=t;else for(var i=0;i<t.children.length;i++)if("group"==t.children[i].localName||"leaf"==t.children[i].localName){var r=l.getUiNodeByObject3d(e,t.children[i]);if(r){n=r;break}}return n},this.setGroupClassName=function(e,t){var n=e.className;"dim"==t?0<=n.indexOf("visible")?n=n.replace(/visible/g,t):n.indexOf("dim")<0&&(n=n+" "+t):"visible"==t?0<=n.indexOf("dim")?n=n.replace(/dim/g,t):n.indexOf("visible")<0&&(n=n+" "+t):"selected"==t?n.indexOf("selected")<0&&(n=n+" "+t):"unselected"==t?0<=n.indexOf("selected")&&(n=n.replace(/selected/g,"")):"collapsed"==t?0<=n.indexOf("expanded")?n=n.replace(/expanded/,"collapsed"):n.indexOf("collapsed")<0&&(n+=" collapsed"):"expanded"==t&&(0<=n.indexOf("collapsed")?n=n.replace(/collapsed/,"expanded"):n.indexOf("expanded")<0&&(n+=" expanded")),e.className=n;for(var i=0;i<e.children.length;i++)"group"==e.children[i].localName?l.setGroupClassName(e.children[i],t):"leaf"==e.children[i].localName&&(n=e.children[i].className,"dim"==t?0<=n.indexOf("visible")?n=n.replace(/visible/g,t):n.indexOf("dim")<0&&(n=n+" "+t):"visible"==t?0<=n.indexOf("dim")?n=n.replace(/dim/g,t):n.indexOf("visible")<0&&(n=n+" "+t):"selected"==t?n.indexOf("selected")<0&&(n=n+" "+t):"unselected"==t&&0<=n.indexOf("selected")&&(n=n.replace(/selected/g,"")),e.children[i].className=n)},this.expandParent=function(e){e&&"group"==e.localName&&(0<=e.className.indexOf("collapsed")?e.className=e.className.replace(/collapsed/g,"expanded"):e.className.indexOf("expanded")<0&&(e.className=e.className+" expanded"),e.parentNode&&l.expandParent(e.parentNode))};var g=null,v=null;this.getTreeNodeByClickModel=function(e){g&&(g.className="headerunselected");for(var t=$("label"),n=t.length-1;0<=n;n--)t[n].object3d.uuid==e.uuid&&(g=t[n].parentElement);if(g){for(var i=$("group"),n=i.length-1;0<=n;n--)0<=i[n].className.indexOf("expanded")&&(i[n].className=i[n].className.replace(/expanded/g,"collapsed"));for(var r=$(g).parents(),n=r.length-1;0<=n;n--)"group"==r[n].localName&&l.viewer.modelBrowserDlg.expandParent(r[n]);g.className="headerselected",v=g}},this.hideTreeNodeByObject=function(e){for(var t=$("label"),n=null,i=t.length-1;0<=i;i--)if(t[i].object3d.uuid==e.uuid){n=t[i];break}if(n){var r=n.parentNode.children[1];r.ischeckboxon=!1,r.className="icon-checkbox-off";for(var o=$(n).parents("group").children("header").find("checkbox"),i=o.length-1;0<=i;i--){var a=o[i].object3d;!a.visible||l.viewer.isObjectOrSomeChildHidden(a)?(o[i].className="icon-checkbox-off",o[i].ischeckboxon=!1):(o[i].className="icon-checkbox-on",o[i].ischeckboxon=!0)}var s=$(r.group).find("checkbox");if(r.ischeckboxon)for(i=s.length-1;0<=i;i--)s[i].className="icon-checkbox-on",s[i].ischeckboxon=!0;else for(i=s.length-1;0<=i;i--)s[i].className="icon-checkbox-off",s[i].ischeckboxon=!1}},this.showAllTreeNode=function(){for(var e=$("checkbox"),t=0;t<e.length;t++)e[t].className="icon-checkbox-on",e[t].ischeckboxon=!0};function y(e){(e=e.target).ischeckboxon=!e.ischeckboxon,l.viewer.showObjectAtObjectLevel(e.object3d,e.ischeckboxon);var t=$(e).parents("group").children("header").find("checkbox");if(e.ischeckboxon&&t)for(var n=t.length-1;0<=n;n--){var i=t[n].object3d;!i.visible||l.viewer.isObjectOrSomeChildHidden(i)?(t[n].className="icon-checkbox-off",t[n].ischeckboxon=!1):(t[n].className="icon-checkbox-on",t[n].ischeckboxon=!0)}var r=$(e.group).find("checkbox");if(e.ischeckboxon)for(n=r.length-1;0<=n;n--)r[n].className="icon-checkbox-on",r[n].ischeckboxon=!0;else for(n=r.length-1;0<=n;n--)r[n].className="icon-checkbox-off",r[n].ischeckboxon=!1;l.viewer.render()}function E(e,t,n){var i=t.children.length,r=null,r=l.viewer.isLeaf(t)?document.createElement("leaf"):document.createElement("group");t.treeType&&"Root"==t.treeType&&(r.style.left="4px",l.uiTreeRoot=r),r.object3d=t,r.className="collapsed",n&&(r.className="expanded");var o=document.createElement("header");o.className="headerunselected",r.appendChild(o),(n=document.createElement("icon")).object3d=t,n.group=r,n.addEventListener("mouseup",m,!1),o.appendChild(n),(n=document.createElement("checkbox")).group=r,!(n.object3d=t).visible||l.viewer.isObjectOrSomeChildHidden(t)?(n.className="icon-checkbox-off",n.ischeckboxon=!1):(n.className="icon-checkbox-on",n.ischeckboxon=!0),n.addEventListener("mouseup",y,!1),o.appendChild(n),(n=document.createElement("label")).object3d=t,n.group=r,n.addEventListener("mouseup",p,!1),t.name?(n.textContent=t.name,r.name=t.name):(n.textContent="Object3D",r.name="Object3D"),o.appendChild(n),e.appendChild(r);for(var a=0;a<i;a++)l.viewer.isLeaf(t)||E(r,t.children[a])}function b(){var e=document.createElement("div");e.className="treeview";var t=l.viewer.getModelTree();return t.treeType="Root",E(e,t,!0),n.addEventListener("selectObject",function(e){e=l.getUiNodeByObject3d(e.object,l.uiTreeRoot);l.setGroupClassName(e,"selected")}),n.addEventListener("clearSelection",function(e){l.setGroupClassName(l.uiTreeRoot,"unselected")}),n.addEventListener("isolateSelectedObjects",function(e){l.setGroupClassName(l.uiTreeRoot,"dim");for(var t=0;t<e.objects.length;t++){var n=l.getUiNodeByObject3d(e.objects[t],l.uiTreeRoot);l.setGroupClassName(n,"visible")}}),n.addEventListener("showAllModel",function(e){l.setGroupClassName(l.uiTreeRoot,"visible")}),n.addEventListener("exitIsolate",function(e){}),document.getElementById("modelbrowserdialog_serch").oninput=w,c=window.setInterval(function(){x!==M&&(l.viewer.showAllModel(),""!==M?function(e,t){var s=[];(function e(t,n,i){var r=n.name.toLowerCase();if(!i&&0<=r.indexOf(t)){s.push(n.object3d);r=n.parentNode;l.expandParent(r)}else for(var o=0;o<n.children.length;o++){var a=n.children[o];"group"!=a.localName&&"leaf"!=a.localName||e(t,a,!1)}})(e,t,!0);for(var n=0;n<s.length;n++)l.viewer.selectionManager.selectObject(s[n]);l.viewer.isolateSelectedObjects()}(M,l.uiTreeRoot):l.setGroupClassName(l.uiTreeRoot,"collapsed"),x=M)},500),e}var M="",x="",w=function(e){e.preventDefault(),e.stopPropagation(),M=(M=e.target.value).toLowerCase()},I=null;this.show=function(e){var t;I||((i=document.createElement("div")).onclick=function(){Ue.enableSelect&&l.viewer.enableInternalRMB&&l.viewer.showModelBroserMenu(!1)},document.body.appendChild(i),t='<div class="modelbrowserdialog" id="modelbrowserdialog">',t+='<div class="modelbrowserdialog_head" id="newdimmove_part">'+e+"</div>",t+='<div class="newdimDlgBtnClose" id="modelbrowserclose">×</div>',t+='<input class="modelbrowserdialog_serch" id="modelbrowserdialog_serch"  type="search" placeholder="按名称过滤"></input>',t+='<div class="modelbrowserdialog_content" id="nds-mbdlg-content">',t+="</div>",i.innerHTML=t+="</div>",e=document.getElementById("nds-mbdlg-content"),t=b(),I=t,e.appendChild(t),l.viewer.addEventListener("selectObject",function(e){l.getTreeNodeByClickModel(e.object)}),l.viewer.addEventListener("clearSelection",function(e){v&&(v.className="headerunselected")}),h("modelbrowserclose").onclick=function(){h("modelbrowserdialog").style.display="none",l.visible=!1,window.clearTimeout(c)},h("newdimmove_part").addEventListener("mousedown",function(e){e=e||window.event;r=e.pageX,o=e.pageY,a=h("modelbrowserdialog").offsetLeft,s=h("modelbrowserdialog").offsetTop,d=!0}),h("newdimmove_part").addEventListener("mouseup",function(){d=!1})),h("modelbrowserdialog").style.display="block",u(h("modelbrowserdialog")),l.visible=!0}},fe=function(e,t){THREE.Camera.call(this),this.fov=45,this.near=.5,this.far=1e4,this.aspect=e/t,this.orthoNear=-200,this.perpNear=.5,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.target=new THREE.Vector3(0,0,0),this.worldup=new THREE.Vector3(0,1,0),this.position.set(0,0,1),this.orthographicCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=new THREE.PerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.updateMatrixWorld(!0),this.zoom=1,this.isPerspective=!0,this.zoomToFitRatio=5,this.orginalCameraInfo=void 0,this.toPerspective()};fe.ORTHO_FOV=2*Math.atan(.5)*180/Math.PI,fe.prototype=Object.create(THREE.Camera.prototype),fe.prototype.clone=function(){var e=new fe(2*this.right,2*this.top);return THREE.Camera.prototype.clone.call(this,e),e.position.copy(this.position),e.up.copy(this.up),this.target&&(e.target=this.target.clone()),this.worldup&&(e.worldup=this.worldup.clone()),e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.fov=this.fov,e.aspect=this.aspect,e.zoom=this.zoom,e.orthoNear=this.orthoNear,e.perpNear=this.perpNear,e.isPerspective=this.isPerspective,this.updateProjectionMatrix(),e},fe.prototype.IsPerspective=function(){return this.isPerspective},fe.prototype.__computeFovPosition=function(e){if(Math.abs(this.fov-e)<=1e-4)return this.position.clone();var t=this.target.clone().sub(this.position),n=THREE.Math.degToRad(this.fov),e=THREE.Math.degToRad(e),e=t.length()*Math.tan(.5*n)/Math.tan(.5*e),e=t.normalize().multiplyScalar(-e);return this.target.clone().add(e)},fe.prototype.toPerspective=function(){!this.isPerspective&&this.saveFov&&(this.fov=this.saveFov,this.near=this.perpNear,2e3<this.far/this.near&&(this.near=this.far/2e3)),this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov/this.zoom,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0},fe.prototype.toOrthographic=function(){var e,t,n;this.isPerspective&&(this.saveFov=this.fov,e=this.fov,this.fov=e,this.near=this.orthoNear),this.orthoScale=this.target.clone().sub(this.position).length(),this.aspect<1?t=(n=.5*this.orthoScale)/this.aspect:n=(t=.5*this.orthoScale)*this.aspect,this.left=this.orthographicCamera.left=-n,this.right=this.orthographicCamera.right=n,this.top=this.orthographicCamera.top=t,this.bottom=this.orthographicCamera.bottom=-t,this.orthographicCamera.near=this.near,this.orthographicCamera.far=this.far,this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthographicCamera.projectionMatrix,this.isPerspective=!1},fe.prototype.updateProjectionMatrix=function(){this.isPerspective?this.toPerspective():this.toOrthographic()},fe.prototype.setSize=function(e,t){this.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},fe.prototype.setFov=function(e){this.fov=e,this.updateProjectionMatrix()},fe.prototype.setLens=function(e,t){void 0===t&&(t=24);e=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(e),e},fe.prototype.setCameraTarget=function(e){this.lookAt({x:e.x,y:e.y,z:e.z}),this.target=e},fe.prototype.getCameraTarget=function(){return this.target},fe.prototype.adjustNearFar=function(e,t){this.isPerspective?(this.far=t,this.near=.5,2e3<this.far/this.near&&(this.near=this.far/2e3)):(this.near=-t,this.far=t),this.updateProjectionMatrix()},fe.prototype.setFarNear=function(e,t){this.far=e,this.near=t},fe.prototype.setOrthoNear=function(e){e=e.min.distanceTo(e.max);-e<this.orthoNear&&(this.orthoNear=-e,this.isPerspective||(this.near=30*this.orthoNear))},fe.prototype.setZoomToFitRatio=function(e){this.zoomToFitRatio=e},fe.prototype.getZoomToFitRatio=function(){return this.zoomToFitRatio},fe.prototype.setOrginalCameraInfo=function(e){this.orginalCameraInfo=e},fe.prototype.getOrginalCameraInfo=function(){return this.orginalCameraInfo},fe.prototype.setCastRay=function(e,t,n){var i;this.isPerspective?((i=new THREE.Vector3(t,n,.5)).unproject(this),e.ray.origin=this.position.clone(),e.ray.direction=i.sub(this.position).normalize().clone()):(e.ray.origin.set(t,n,-1).unproject(this),e.ray.direction.set(0,0,-1).transformDirection(this.matrixWorld))};n(11),n(12),n(23);function y(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.DoubleSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}}var ye={REVISION:"01",StringTable:void 0,setLanguage:function(e){this.language=e,ye.StringTable=new StringTable(e)},getLanguage:function(){var e=this.language,t=(e=e||"en").split("-");e=1<t.length?t[0].toLowerCase()+"-"+t[1].toUpperCase():t[0].toLowerCase();var n=["en","zh-HANS","encn"];return e=-1===n.indexOf(e)?-1<e.indexOf("zh-CN")||-1<e.indexOf("zh-TW")?"zh-HANS":1<t.length&&-1<n.indexOf(t[0])?t[0]:"en":e},translateString:function(e){return ye.StringTable.translate(e)},getStyle:function(e,t){if(e.style[t])return e.style[t];if(e.currentStyle)return e.currentStyle[t];if(document.defaultView&&document.defaultView.getComputedStyle){t=(t=t.replace(/[A-Z]/g,"-$1")).toLowerCase();e=document.defaultView.getComputedStyle(e,"");return e&&e.getPropertyValue(t)}return null},onAutoHide:function(e){function t(){clearTimeout(i)}var n=e.domElement;n.addEventListener("mouseenter",t);var i=setTimeout(function(){n.removeEventListener("mouseenter",t),e.setVisibility(!1)},300)},onShowTooltip:function(e){var t=e.event.type,n=e.target.subElements.tooltip;switch(t){case"mouseenter":n.setVisibility(!0);break;case"mouseleave":n.setVisibility(!1);break;case"mouseover":n.setVisibility(!0);break;case"mouseout":n.setVisibility(!1)}},map:function(e,t){this.key=e,this.value=t},getExtName:function(e){var t=e.lastIndexOf("."),n=e.length;return e.substring(t+1,n)},sleep:function(e){for(var t=new Date,n=t.getTime()+e;;)if((t=new Date).getTime()>n)return},isEmptyObject:function(e){for(var t in e)return!1;return!0},getObjectSize:function(e){var t,n=0;for(t in e)++n;return n},disposeObject:function(e){if(0==e.children.length)return e.geometry&&e.geometry.dispose(),void(e.material&&e.material.dispose());for(var t=0;t<e.children.length;t++)this.disposeObject(e.children[t])},encodeURL:function(e){if(null==e)return null;if(Array.isArray(e))for(var t=0;t<e.length;++t)e[t]=e[t].replace(/&/g,"%26"),e[t]=e[t].replace(/#/g,"%23");else e=(e=e.replace(/&/g,"%26")).replace(/#/g,"%23");return e},isIOSDevice:function(){var e=navigator.userAgent.toLowerCase();return/ip(ad|hone|od)/.test(e)||-1!==e.indexOf("macintosh")},isAndroidDevice:function(){return-1!==navigator.userAgent.toLowerCase().indexOf("android")},isIpadDevice:function(){return-1!==navigator.userAgent.toLowerCase().indexOf("ipad")},isMobileDevice:function(){return this.platform?"mobile"==this.platform||"pc"!=this.platform&&(ye.isIOSDevice()||ye.isAndroidDevice()):ye.isIOSDevice()||ye.isAndroidDevice()},setMobileDevice:function(e){this.platform=e},easeClamp:function(e,t,n){return e<=t?0:n<=e?1:.5*(Math.sin(((e-t)/(n-t)-.5)*Math.PI)+1)},linearClamp:function(e,t,n){return e<=t?0:n<=e?1:(e-t)/(n-t)},linearInterp:function(e,t,n){return t*(1-e)+n*e},round1:function(e){return Math.round(10*e)/10},round2:function(e){return Math.round(100*e)/100},getUniqueId:function(){var e=Date.now().toString(16);return e+=Math.random().toString(16).substr(3,4)}},pe=function(f){var v=this,y=(this.viewer=f).viewBox,r=.5,o=!1,p=null,m=null,g=null,E=null,b=null,M=1.5;function l(){v.resetOperationMode(),v.viewer.dispatchEvent({type:"ZoomFitEvent"})}this.setCameraSize=function(e,t){f.camera.setSize(e,t),f.camera.updateProjectionMatrix()},this.center=function(){return this.viewer.camera.getCameraTarget()},this.setZoomSpeed=function(e){M=e},this.setRotateSpeed=function(e){0},this.StandardView={front:{from:[0,0,1],to:[0,0,0],up:[0,1,0]},back:{from:[0,0,-1],to:[0,0,0],up:[0,1,0]},left:{from:[-1,0,0],to:[0,0,0],up:[0,1,0]},right:{from:[1,0,0],to:[0,0,0],up:[0,1,0]},top:{from:[0,1,0],to:[0,0,0],up:[0,0,-1]},bottom:{from:[0,-1,0],to:[0,0,0],up:[0,0,1]},frontRight:{from:[1,0,1],to:[0,0,0],up:[0,1,0]},leftFront:{from:[-1,0,1],to:[0,0,0],up:[0,1,0]},backLeft:{from:[-1,0,-1],to:[0,0,0],up:[0,1,0]},rightBack:{from:[1,0,-1],to:[0,0,0],up:[0,1,0]},frontUpLeft:{from:[-.5773502691896258,.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomRightFront:{from:[.5773502691896258,-.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},rightUpFront:{from:[.5773502691896258,.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomFrontLeft:{from:[-.5773502691896258,-.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},backUpRight:{from:[.5773502691896258,.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},leftUpBack:{from:[-.5773502691896258,.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomBackRight:{from:[.5773502691896258,-.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomLeftBack:{from:[-.5773502691896258,-.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]}},this.setViewBox=function(e){(y=e)&&this.updateViewBoxCamDir()},this.setRotateCenter=function(e){b=e},this.getRotateCenter=function(){return b},this.setCameraInfo=function(e,t){null!=e?f.camera.setOrginalCameraInfo({center:new THREE.Vector3(e.target.x,e.target.y,e.target.z),up:new THREE.Vector3(e.up.x,e.up.y,e.up.z),position:new THREE.Vector3(e.position.x,e.position.y,e.position.z),fov:e.fov,near:e.near,far:e.far,isPerspective:e.isPerspective,width:e.width,height:e.height,modelScreenBBox:e.modelScreenBBox}):(f.camera.setOrginalCameraInfo(void 0),f.controls.SetBoundingBoxUpdated(!1),f.camera.up.set(0,1,0),(e=new THREE.Matrix4).lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,f.camera.up),f.camera.quaternion.setFromRotationMatrix(e)),t&&f.resetCamera({useOrginal:!0})},this.getCameraInfo=function(){var e={},t=f.camera;e.fov=t.fov,e.near=t.near,e.far=t.far,e.position={x:t.position.x,y:t.position.y,z:t.position.z},e.up={x:t.up.x,y:t.up.y,z:t.up.z};t=f.camera.getCameraTarget();e.target={x:t.x,y:t.y,z:t.z},e.isPerspective=f.camera.isPerspective;t=f.renderer.getPixelRatio();return e.width=f.renderer.domElement.width/t,e.height=f.renderer.domElement.height/t,e.modelScreenBBox=f.computeModelScreenBBox(),e},this.setAutoRotateSpeed=function(e){r=e},this.setAutoRotationEnabled=function(e){e?o||(o=!0,p=Date.now(),this.autoRotation()):o=!1},this.toggleAutoRotation=function(e){var t=o;o=!o,(o=void 0!==e?e:o)&&!t&&(p=Date.now(),this.autoRotation())},this.autoRotation=function(){var e,t,n,i;Ue.enableBroadcast&&!Ue.broadcastMajor||o&&(requestAnimationFrame(function(){v.autoRotation()}),1e3/30<=(n=(i=Date.now())-p)&&(p=i-n%(1e3/30),e=f.controls.getBoundingBox().getCenter(),(t=new THREE.Vector3).subVectors(f.camera.position,e),i=new THREE.Vector3(0,1,0),(n=new THREE.Quaternion).setFromAxisAngle(i,r*Math.PI/180),t.applyQuaternion(n),(i=new THREE.Vector3).subVectors(f.camera.getCameraTarget(),e),i.applyQuaternion(n),f.camera.getCameraTarget().addVectors(e,i),f.camera.up.applyQuaternion(n),f.camera.position.addVectors(e,t),f.camera.setCameraTarget(f.camera.getCameraTarget()),f.render(),y&&v.updateViewBoxCamQuaternion(n)))},this.look=function(e){var t=[1,1,1],n=[0,0,0],i=[0,1,0];"hall"==f.getModelOperationMode()&&(t=[0,0,1]),void 0!==e&&(void 0!==e.type&&void 0!==v.StandardView[e.type]?(t=v.StandardView[e.type].from,n=v.StandardView[e.type].to,i=v.StandardView[e.type].up):(void 0!==e.from&&(t=e.from),void 0!==e.to&&(n=e.to)),void 0!==e.up&&(i=e.up));var r=new THREE.Vector3,o=new THREE.Vector3,a=new THREE.Vector3,t=o.fromArray(n).sub(r.fromArray(t));t.normalize();i={dir:t,up:a.fromArray(i),callback:e.callback,sphericalTransition:e.sphericalTransition,animationSpeed:e.animationSpeed};void 0!==e&&void 0!==e.smoothTranslation?v.zoomExtents(e.smoothTranslation,e.useOrginal,i,!0):v.zoomExtents(void 0,e.useOrginal,i,!0)},this.zoomExtents=function(e,t,n,i){var r=new THREE.Vector3,o=new THREE.Vector3,a={flag:!0},s=f.controls.IsBoundingBoxUpdated();if(0<f.isolateMeshes.length&&(null==i||0==i))f.computeMeshesBoundingBox(f.isolateMeshes,r,o,a);else if(s)f.controls.getExplosionBoundingBox()?(r.copy(f.controls.getExplosionBoundingBox().min),o.copy(f.controls.getExplosionBoundingBox().max)):(r.copy(f.controls.getBoundingBox().min),o.copy(f.controls.getBoundingBox().max));else{if(f.computeBoundingBox(f.scene,r,o,a),r.x>o.x||r.y>o.y||r.z>o.z)return;f.controls.setBoundingBox(r,o)}i=new THREE.Vector3;i.x=.5*(o.x+r.x),i.y=.5*(o.y+r.y),i.z=.5*(o.z+r.z);a=new THREE.Vector3;(a=a.subVectors(o,r)).length()<1e-6&&a.set(1,1,1);o=.5*a.length()/Math.sin(Math.PI/180*f.camera.fov*.5);f.camera.IsPerspective()&&f.camera.aspect<1&&(o/=f.camera.aspect),0==o&&(o=1e-4),1!=Number(f.disratio)&&(o*=Number(f.disratio)),f.controls.getExplosionBoundingBox()||(f.camera.far=5*o,f.camera.setZoomToFitRatio(5),f.camera.far<1e3&&(f.camera.setZoomToFitRatio(1e3/o),f.camera.far=1e3),2e3<f.camera.far/f.camera.near&&(f.camera.near=f.camera.far/2e3),f.camera.near>.25*a.length()&&(f.camera.near=.25*a.length()),f.camera.perpNear>.25*a.length()&&(f.camera.perpNear=.25*a.length()));r=null,a=null;n?((r=n.dir.clone().normalize()).multiplyScalar(o),a=i.clone().sub(r)):((r=new THREE.Vector3(0,0,1).applyQuaternion(f.camera.quaternion)).multiplyScalar(o),(a=new THREE.Vector3).addVectors(i,r)),s||(f.groundShadow.updateGroundTransform(f.camera,f.controls.getBoundingBox()),f.is2DModel?f.camera.setOrthoNear(f.modelRootObject.boundingBox.clone()):f.camera.setOrthoNear(f.controls.getBoundingBox()),f.camera.getOrginalCameraInfo()||f.camera.setOrginalCameraInfo({center:i.clone(),up:n?n.up.clone():new THREE.Vector3(0,1,0),position:a})),!0===t&&f.camera.getOrginalCameraInfo()&&(i.copy(f.camera.getOrginalCameraInfo().center),a.copy(f.camera.getOrginalCameraInfo().position),f.camera.getOrginalCameraInfo().fov&&(f.camera.fov=f.camera.getOrginalCameraInfo().fov),f.camera.getOrginalCameraInfo().near&&f.camera.IsPerspective()==f.camera.getOrginalCameraInfo().isPerspective&&(f.camera.near=f.camera.getOrginalCameraInfo().near),f.camera.getOrginalCameraInfo().far&&f.camera.IsPerspective()==f.camera.getOrginalCameraInfo().isPerspective&&(f.camera.far=f.camera.getOrginalCameraInfo().far)),f.camera.updateProjectionMatrix(),f.camera.updateMatrixWorld(!0),void 0===e||e?(e={center:i,up:(n||f.camera).up.clone(),position:a},!0===t&&f.camera.getOrginalCameraInfo()&&f.camera.getOrginalCameraInfo().up&&(e.up=f.camera.getOrginalCameraInfo().up),n&&n.animationSpeed&&(e.animationSpeed=n.animationSpeed),n&&!0===n.sphericalTransition?v.sphericalTransition(e,n.callback):f.startSmoothTranslation(e,l)):(!0===t&&f.camera.getOrginalCameraInfo()&&f.camera.getOrginalCameraInfo().up&&f.camera.up.copy(f.camera.getOrginalCameraInfo().up),f.camera.position.copy(a),f.camera.setCameraTarget(i),f.camera.updateProjectionMatrix(),f.camera.updateMatrixWorld(!0),y&&v.updateViewBoxCamDir(),f.render(),l()),Ue.autoSwitchFirstPersonView&&"FirstPerson"==f.getModelOperationMode()&&f.setModelOperationModeInternal(f.originalModelOperationMode)},this.sphericalTransition=function(e,l){var d,c,t,n,h,u,i,r,o,a,s;p=Date.now(),m=0,null==g&&(d=new THREE.Quaternion,c=new THREE.Quaternion,t=new THREE.Quaternion,n=new THREE.Quaternion,h=f.camera.getCameraTarget().clone().sub(f.camera.position).length(),u=e.center.clone().sub(e.position).length(),i=e.center.clone().sub(e.position).normalize(),a=(o=(r=f.camera.getCameraTarget().clone().sub(f.camera.position).normalize()).clone().cross(f.camera.up).normalize()).clone().cross(r).normalize(),(s=new THREE.Matrix4).set(r.x,a.x,o.x,0,r.y,a.y,o.y,0,r.z,a.z,o.z,0,0,0,0,1),d.setFromRotationMatrix(s),a=(o=(r=i).clone().cross(e.up).normalize()).clone().cross(r).normalize(),s.set(r.x,a.x,o.x,0,r.y,a.y,o.y,0,r.z,a.z,o.z,0,0,0,0,1),t.setFromAxisAngle(r,0),n.setFromAxisAngle(a,0),c.setFromRotationMatrix(s),c.multiply(t).multiply(n).normalize(),function e(t,n){if(!Ue.enableBroadcast||Ue.broadcastMajor){var i=f.camera.position.distanceToSquared(t.position),r=new THREE.Vector3;if(r.subVectors(f.camera.up,t.up),r=i<1e-6&&Math.abs(r.x)<1e-5&&Math.abs(r.y)<1e-5&&Math.abs(r.z)<1e-5,!f.getEnableSmoothTranslation()||1<=m||r){m=1,f.camera.position.copy(t.position),f.camera.up.copy(t.up),f.camera.setCameraTarget(t.center.clone()),f.camera.lookAt(v.center()),f.camera.updateMatrixWorld(!0),f.camera.updateProjectionMatrix(),f.render(),y&&(a=t.center.clone().sub(t.position),(s=y.center.clone().sub(a).normalize()).multiplyScalar(y.viewScale),y.camera.position.copy(s),y.camera.up.copy(t.up),y.camera.lookAt(y.center),y.render()),null!=g&&cancelAnimationFrame(g),g=null,y&&y.render();var o=f.getLoadingManager();return void 0!==o.onSmoothTranslationDone&&o.onSmoothTranslationDone(),void(n&&n())}var a=ye.linearClamp(m,0,1),s=1-a,o=Date.now(),n=o-p;p=o,t.animationSpeed?m+=n/t.animationSpeed:m+=n/500,o=new THREE.Matrix4,(n=d.clone()).slerp(c,a),o.makeRotationFromQuaternion(n),n=ye.linearInterp(a,h,u),o=o.elements,s=f.camera.getCameraTarget().clone().multiplyScalar(s).add(t.center.clone().multiplyScalar(a)),a=t.center.clone().sub(new THREE.Vector3(o[0],o[1],o[2]).multiplyScalar(n)),n=new THREE.Vector3(o[4],o[5],o[6]),f.camera.position.copy(a),f.camera.up.copy(n),f.camera.setCameraTarget(s),f.camera.updateProjectionMatrix(),f.render(),y&&(a=y.center.clone().sub(new THREE.Vector3(o[0],o[1],o[2]).multiplyScalar(y.viewScale)),y.camera.position.copy(a),y.camera.up.copy(n),y.camera.lookAt(y.center),y.render()),g=requestAnimationFrame(function(){e(t,l)})}}(e,l))},this.startSmoothTranslation=function(e,t){p=Date.now(),m=0,null!=g&&(cancelAnimationFrame(g),g=null),v.smoothTranslation(e,t)},this.isSmoothTranslationDone=function(){return null==g},this.smoothTranslation=function(e,t){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&e){var n=f.camera.position.distanceToSquared(e.position),i=new THREE.Vector3;i.subVectors(f.camera.up,e.up);var r,o=e.center.clone().sub(e.position);y&&(r=y.center.clone().sub(o).normalize()).multiplyScalar(y.viewScale);var a=n<1e-6&&Math.abs(i.x)<1e-5&&Math.abs(i.y)<1e-5&&Math.abs(i.z)<1e-5;if(!f.getEnableSmoothTranslation()||1<=m||a){m=1,f.camera.position.copy(e.position),f.camera.up.copy(e.up),f.camera.setCameraTarget(e.center.clone()),f.camera.lookAt(v.center()),f.camera.updateMatrixWorld(!0),f.camera.updateProjectionMatrix(),f.render(),y&&(y.camera.position.copy(r),y.camera.up.copy(e.up),y.camera.lookAt(y.center),v.updateViewBoxCamDir()),null!=g&&cancelAnimationFrame(g),g=null,y&&y.render();var s=f.getLoadingManager();return void 0!==s.onSmoothTranslationDone&&s.onSmoothTranslationDone(),void(t&&t())}o=ye.linearClamp(m,0,1),n=1-o,i=Date.now(),a=i-p;p=i,e.animationSpeed?m+=a/e.animationSpeed:m+=a/1e3;s=f.camera.getCameraTarget().clone().multiplyScalar(n).add(e.center.clone().multiplyScalar(o)),i=f.camera.position.clone().multiplyScalar(n).add(e.position.clone().multiplyScalar(o)),a=f.camera.up.clone().multiplyScalar(n).add(e.up.clone().multiplyScalar(o));f.camera.position.copy(i),f.camera.up.copy(a),f.camera.setCameraTarget(s),f.camera.updateProjectionMatrix(),f.camera.updateMatrixWorld(!0),f.render(),y&&((i=y.camera.position.clone().multiplyScalar(n).add(r.clone().multiplyScalar(o))).normalize(),i.multiplyScalar(y.viewScale),y.camera.position.copy(i),y.camera.up.copy(a),y.camera.lookAt(y.center),y.render()),g=requestAnimationFrame(function(){v.smoothTranslation(e,t)})}},this.resetOperationMode=function(){var e=f.getModelOperationMode();Ue.autoSwitchFirstPersonView&&"FirstPerson"==e&&(f.controls.getBoundingBox().containsPoint(f.camera.position)||f.setModelOperationModeInternal(f.originalModelOperationMode))},this.zoomToObject=function(e,t){var n=new THREE.Vector3,i=new THREE.Vector3,r=0,o=f.controls.IsBoundingBoxUpdated();f.computeBoundingBox(e,n,i,{flag:!0});var a=new THREE.Vector3;a.x=.5*(i.x+n.x),a.y=.5*(i.y+n.y),a.z=.5*(i.z+n.z);e=new THREE.Vector3;(r=.5*(e=e.subVectors(i,n)).length())<1e-6||(r=r/Math.sin(Math.PI/180*f.camera.fov*.5),f.camera.IsPerspective()&&f.camera.aspect<1&&(r/=f.camera.aspect),0==r&&(r=1e-4),f.controls.getExplosionBoundingBox()||(f.camera.far<5*r&&(f.camera.far=5*r),f.camera.setZoomToFitRatio(5),f.camera.far<1e3&&(f.camera.setZoomToFitRatio(1e3/r),f.camera.far=1e3),2e3<f.camera.far/f.camera.near&&(f.camera.near=f.camera.far/2e3),f.camera.near>.5*e.length()&&(f.camera.near=.25*e.length())),(e=new THREE.Vector3(0,0,1).applyQuaternion(f.camera.quaternion)).multiplyScalar(r),(r=new THREE.Vector3).addVectors(a,e),o||(f.groundShadow.updateGroundTransform(f.camera,f.controls.getBoundingBox()),f.camera.setOrthoNear(f.controls.getBoundingBox()),f.camera.getOrginalCameraInfo()||f.camera.setOrginalCameraInfo({center:a.clone(),up:new THREE.Vector3(0,1,0),position:r})),f.camera.updateProjectionMatrix(),void 0===t||t?(t={center:a,up:f.camera.up,position:r},v.startSmoothTranslation(t,l)):(f.camera.position.copy(r),f.camera.setCameraTarget(a),f.render(),l()),a=f.controls.getBoundingBox().containsPoint(r),r=f.getModelOperationMode(),Ue.autoSwitchFirstPersonView&&"hall"!=r&&(a?"FirstPerson"!=r&&f.setModelOperationModeInternal("FirstPerson"):"FirstPerson"==r&&f.setModelOperationModeInternal(f.originalModelOperationMode)))},this.setModelUpDirection=function(e,t){0<f.getExplodeFactor()&&(f.Optoolbar?f.Optoolbar.resetExplosion():f.explodeModel(0)),f.initModelUpDirection(e),f.scene.updateMatrixWorld(!0),f.controls.SetBoundingBoxUpdated(!1),f.scene.remove(f.lightControls._scene),f.scene.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))}),f.scene.add(f.lightControls._scene),null!=f.modelSceneOrgin&&f.modelSceneOrgin!=f.scene&&(f.modelSceneOrgin.updateMatrixWorld(!0),f.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))})),0!=t&&(e=f.camera.getOrginalCameraInfo(),f.camera.setOrginalCameraInfo(void 0),f.camera.up.set(0,1,0),(t=new THREE.Matrix4).lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,f.camera.up),f.camera.quaternion.setFromRotationMatrix(t),f.resetCamera({useOrginal:!0}),e&&null!=e.fov&&f.camera.setOrginalCameraInfo(e))},this.onOperationModeChange=function(e){f.camera.setOrginalCameraInfo(void 0),f.camera.up.set(0,1,0);var t=new THREE.Matrix4;t.lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,f.camera.up),f.camera.quaternion.setFromRotationMatrix(t);var n=.5*Math.PI-f.camera.up.angleTo(new THREE.Vector3(1,1,1).normalize()),i=f.getModelOperationVerticalRotationRange();null!=i&&Math.abs(i.y)*Math.PI/180<n&&(Math.abs(i.y)<4.5?t.lookAt(new THREE.Vector3(1,0,1),new THREE.Vector3,f.camera.up):t.lookAt(new THREE.Vector3(1,.1,1),new THREE.Vector3,f.camera.up),f.camera.quaternion.setFromRotationMatrix(t)),0!=e&&f.resetCamera({useOrginal:!0})},this.rotateByTrackBall=function(e,t,n){var i,r,o,a=this.viewer.renderer.getPixelRatio(),s=2*Math.PI*(e.pointer.x-e.pointerOld.x)*a/this.viewer.renderer.domElement.width,l=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*a/this.viewer.renderer.domElement.height;this.viewer.camera.updateMatrixWorld(!0),t.length()&&(i=null,i=n?this.center().clone():this.viewer.controls.getBoundingBox().getCenter(),null!=b&&(i=b),(o=new THREE.Vector3).subVectors(this.viewer.camera.position,i),(new THREE.Vector3).copy(o).normalize(),new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,(r=new THREE.Vector3(0,0,0)).unproject(this.viewer.camera),(a=new THREE.Vector3(10,0,0)).unproject(this.viewer.camera),a.sub(r).normalize(),(t=new THREE.Vector3(0,10,0)).unproject(this.viewer.camera),t.sub(r).normalize(),(r=new THREE.Quaternion).setFromAxisAngle(t,-s),(s=new THREE.Quaternion).setFromAxisAngle(a,l),o.applyQuaternion(r),o.applyQuaternion(s),(a=new THREE.Vector3).addVectors(i,o),(l=new THREE.Vector3).subVectors(this.center(),i),o=this.center().clone(),!0!==n&&(l.applyQuaternion(r),l.applyQuaternion(s),o.addVectors(i,l)),this.viewer.camera.up.applyQuaternion(r),this.viewer.camera.up.applyQuaternion(s),this.viewer.camera.position.copy(a),this.center().copy(o),this.adjustNearAndFar(),this.viewer.camera.lookAt(this.center()),this.viewer.camera.updateMatrixWorld(!0),e.render(),y&&v.updateViewBoxCamDir())},this.rotateByHall=function(e,t){var n=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*n/this.viewer.renderer.domElement.width,r=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*n/this.viewer.renderer.domElement.height;this.viewer.camera.updateMatrixWorld(!0);var o=new THREE.Vector3(0,0,1);if(o.unproject(this.viewer.camera),!isFinite(o.x)||!isFinite(o.y)||!isFinite(o.z))return!1;var a=new THREE.Vector3(.25,0,1);if(a.unproject(this.viewer.camera),!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))return!1;a.sub(o).normalize();var s=null,s=t?this.center().clone():this.viewer.controls.getBoundingBox().getCenter();0!=i&&(r*=.25);var l=new THREE.Quaternion;l.setFromAxisAngle(THREE.Object3D.DefaultUp,-i);n=new THREE.Quaternion;n.setFromAxisAngle(a,r);o=new THREE.Vector3;o.subVectors(this.viewer.camera.position,s),o.applyQuaternion(l),o.applyQuaternion(n);t=new THREE.Vector3;t.subVectors(this.center(),s),t.applyQuaternion(l),t.applyQuaternion(n);i=(new THREE.Vector3).subVectors((new THREE.Vector3).addVectors(s,o),(new THREE.Vector3).addVectors(s,t));i.normalize();a=i.angleTo(THREE.Object3D.DefaultUp),r=this.viewer.getModelOperationVerticalRotationRange(),n=.06*Math.PI;null!=r&&(n=Math.max(n,.5*Math.PI-Math.abs(r.y)*Math.PI/180));i=.94*Math.PI;null!=r&&(i=Math.min(i,.5*Math.PI+Math.abs(r.x)*Math.PI/180)),(a<n||i<a)&&(t.subVectors(this.center(),s),t.applyQuaternion(l),o.subVectors(this.viewer.camera.position,s),o.applyQuaternion(l)),this.center().addVectors(s,t),this.viewer.camera.position.addVectors(s,o),this.adjustNearAndFar(),this.viewer.camera.lookAt(this.center()),e.render(),y&&v.updateViewBoxCamDir()},this.rotateByBim=function(e,t){var n=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*n/this.viewer.renderer.domElement.width,r=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*n/this.viewer.renderer.domElement.height,o=new THREE.Vector3(0,1,0);this.viewer.camera.updateMatrixWorld(!0);var a=new THREE.Vector3(0,0,0);if(a.unproject(this.viewer.camera),!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))return!1;var s=new THREE.Vector3(10,0,0);if(s.unproject(this.viewer.camera),!isFinite(s.x)||!isFinite(s.y)||!isFinite(s.z))return!1;s.sub(a).normalize();var l=this.viewer.camera.position.clone(),d=this.center().clone(),c=this.viewer.camera.up.clone(),h=null,h=t?this.center().clone():this.viewer.controls.getBoundingBox().getCenter();null!=b&&(h=b);var u=new THREE.Vector3;u.subVectors(this.viewer.camera.position,h);var f=new THREE.Quaternion;f.setFromAxisAngle(o,-i);var p=new THREE.Quaternion;p.setFromAxisAngle(s,r),u.applyQuaternion(p),u.applyQuaternion(f);var m=new THREE.Vector3;m.addVectors(h,u);var g=new THREE.Vector3;g.subVectors(this.center(),h);n=this.center().clone();!0!==t&&(g.applyQuaternion(p),g.applyQuaternion(f),n.addVectors(h,g)),this.viewer.camera.up.applyQuaternion(p),this.viewer.camera.up.applyQuaternion(f),this.viewer.camera.position.copy(m),this.center().copy(n),this.viewer.camera.lookAt(this.center()),this.viewer.camera.updateMatrixWorld(!0),a.set(0,0,0),a.unproject(this.viewer.camera),s.set(10,0,0),s.unproject(this.viewer.camera),s.sub(a).normalize();i=new THREE.Vector3(0,10,0);i.unproject(this.viewer.camera),i.sub(a).normalize();r=!0,p=this.viewer.getModelOperationVerticalRotationRange(),m=Math.min(Math.PI,Math.abs(p.x)*Math.PI/180),n=Math.min(Math.PI,Math.abs(p.y)*Math.PI/180),a=o.angleTo(i);1e-6<a&&((p=new THREE.Vector3).crossVectors(i,o),p.normalize(),p.dot(s)<0?m<a&&(r=!1):n<a&&(r=!1)),this.adjustNearAndFar(),r||(this.viewer.camera.up.copy(c),this.viewer.camera.up.applyQuaternion(f),u.subVectors(l,h),u.applyQuaternion(f),this.viewer.camera.position.addVectors(h,u),!0!==t&&(g.subVectors(d,h),g.applyQuaternion(f)),this.center().addVectors(h,g),this.viewer.camera.lookAt(this.center())),e.render(),y&&v.updateViewBoxCamDir()},this.rotateByFirstPerson=function(e,t){var n=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*n/this.viewer.renderer.domElement.width,r=-.5*Math.PI*(e.pointer.y-e.pointerOld.y)*n/this.viewer.renderer.domElement.height;this.viewer.camera.updateMatrixWorld(!0);var o=this.viewer.camera.position,a=this.center(),s=this.viewer.camera.up;1e-7<s.distanceTo(new THREE.Vector3(0,1,0))&&s.set(0,1,0);var l=new THREE.Vector3;l.subVectors(a,o),l.applyAxisAngle(s,-i);var d=l.clone().normalize(),n=d.clone();d.negate();i=new THREE.Vector3;d.equals(s)||n.equals(s)?i.set(1,0,0):(i.crossVectors(s,d),i.normalize()),e.latAngle-=r,e.latAngle>-.25*Math.PI&&e.latAngle<.25*Math.PI?l.applyAxisAngle(i,r):e.latAngle+=r,a.addVectors(o,l),this.adjustNearAndFar(),this.viewer.camera.lookAt(a),e.render(),y&&v.updateViewBoxCamDir()},this.calFarthestDistToCamera=function(){var e=this.viewer.controls.getExplosionBoundingBox(),t=(e=null==e||null==e?this.viewer.controls.getBoundingBox():e).getCenter(),e=.5*(new THREE.Vector3).subVectors(e.max,e.min).length(),t=this.viewer.camera.position.distanceTo(t);return t+=e},this.pan=function(e,t,n){var i=[e.downModelPnt.x,e.downModelPnt.y,e.downModelPnt.z],i=this.viewer.modelCoordToClientCoord(i),i=[i[0]+t.x,i[1]-t.y,i[2]],i=this.viewer.clientCoordToModelCoord(i),i=new THREE.Vector3(i[0],i[1],i[2]).clone();i.sub(e.downModelPnt),this.viewer.camera.position.add(i),this.center().add(i),!1!==n&&e.render()},this.moveForwardBack=function(e,t,n){var i=this.center(),r=this.viewer.camera.position,o=(r.distanceTo(i),new THREE.Vector3);o.subVectors(i,r);r=.03;this.viewer.controls.getBoundingBox().containsPoint(this.viewer.camera.position)&&(r=.01),o.multiplyScalar(r),0==t&&o.negate(),this.viewer.camera.position.add(o),this.center().add(o),!1!==n&&f.render()},this.adjustNearAndFar=function(){var e,t,n;this.viewer.is2DModel||(t=this.viewer.controls.getBoundingBox(),e=new THREE.Vector3,t.getCenter(e),n=t.min.distanceTo(t.max),t=this.viewer.camera.position.clone(),n=Math.abs(e.distanceTo(t))+1.2*n,this.viewer.camera.adjustNearFar(n,n))},this.zoom=function(e,t,n,i){if(this.viewer.is2DViewer)(o=this.camDisTo2DViewer())<this.viewer.camera.near+.1&&t.z<0||(t.multiplyScalar(1e-4*o),t.length()>o||(t.applyMatrix3(e.normalMatrix.getNormalMatrix(this.viewer.camera.matrix)),r=this.viewer.camera.IsPerspective(),this.viewer.camera.position.add(t),r&&this.center().add(t),this.adjustNearAndFar(),this.viewer.camera.updateProjectionMatrix(),!1!==i&&e.render()));else{if(n){if(this.zoomByMouse(e,t,n,i))return}else if("hall"==this.viewer.getModelOperationMode())return void(0!=t.z&&(0<t.z?t.z=30:t.z=-30,this.zoomByMouse(e,t,{offsetX:0,offsetY:0},i)));var r=this.viewer.camera.IsPerspective(),o=this.viewer.camera.position.distanceTo(this.center());t.multiplyScalar(1e-4*(o*=M/1.5)),t.applyMatrix3(e.normalMatrix.getNormalMatrix(this.viewer.camera.matrix)),this.viewer.camera.position.add(t),r&&this.center().add(t),this.adjustNearAndFar(),this.viewer.camera.updateProjectionMatrix(),0<t.z&&((t=this.calFarthestDistToCamera())>this.viewer.camera.far&&(this.viewer.camera.far=t)),!1!==i&&e.render()}},this.zoomByMouse=function(e,t,n,i){var r=this.viewer.renderer.domElement,o=this.viewer.renderer.getPixelRatio(),a=n.offsetX||n.clientX-this.viewer.container.getBoundingClientRect().left,s=n.offsetY||n.clientY-this.viewer.container.getBoundingClientRect().top;n.srcElement&&n.srcElement!==this.viewer.renderer.domElement&&(a=n.clientX-this.viewer.container.getBoundingClientRect().left,s=n.clientY-this.viewer.container.getBoundingClientRect().top),null==n.srcElement&&n.target&&n.target!==this.viewer.renderer.domElement&&(a=n.clientX-this.viewer.container.getBoundingClientRect().left,s=n.clientY-this.viewer.container.getBoundingClientRect().top);var l=this.viewer.camera.position.clone();l.sub(this.center());var d=l.length();l.multiplyScalar(.7),l.add(this.center()),l.project(this.viewer.camera);var c=new THREE.Vector3(a*o/r.width*2-1,2*-(s*o/r.height)+1,l.z),h=this.viewer.camera.IsPerspective(),n=this.viewer.getModelOperationMode();if("hall"==n&&((u=this.viewer.controls.getBoundingBox().getCenter()).project(this.viewer.camera),c.copy(u)),c.unproject(this.viewer.camera),!isFinite(c.x)||!isFinite(c.y)||!isFinite(c.z))return!1;a=this.viewer.camera.position.clone();a.sub(this.center());a.length();s=this.center().clone();s.sub(c);var o=M,r=t.z,l=this.viewer.controls.getBoundingBox(),u=l.containsPoint(this.viewer.camera.position);u&&r<0&&(o*=.6),Ue.autoSwitchFirstPersonView&&"hall"!=n&&(u?"FirstPerson"!=n&&(this.viewer.setModelOperationModeInternal("FirstPerson"),e.latAngle=0):"FirstPerson"==n&&this.viewer.setModelOperationModeInternal(this.viewer.originalModelOperationMode));c=this.viewer.camera.position.clone(),t=this.center().clone(),u=new THREE.Vector3;u.x=(a.x+s.x)*o/r,u.y=(a.y+s.y)*o/r,u.z=(a.z+s.z)*o/r;n=new THREE.Vector3;n.x=s.x*o/r,n.y=s.y*o/r,n.z=s.z*o/r,c.add(u),t.add(n);l=.8*l.min.distanceTo(l.max);d<l&&(d=l);l=new THREE.Vector3;return l.subVectors(t,c),l.normalize(),l.multiplyScalar(d),h&&t.addVectors(c,l),this.adjustNearAndFar(),h?(this.viewer.camera.position.copy(c),this.center().copy(t)):((h=c.clone()).sub(t),0<=h.dot(a)&&(this.viewer.camera.position.copy(c),this.center().copy(t))),0<r&&((r=this.calFarthestDistToCamera())>this.viewer.camera.far&&(this.viewer.camera.far=r)),this.viewer.camera.updateProjectionMatrix(),!1!==i&&e.render(),!0},this.set2DViewerInfo=function(e){var t,n;null!=e.center&&f.viewer2DInfo.center.copy(e.center),null!=e.yDir&&(f.viewer2DInfo.yDir.copy(e.yDir),(n=new THREE.Vector3).copy(e.yDir),f.camera.up.copy(n)),null!=e.normal&&(e.normal.normalize(),f.viewer2DInfo.normal.copy(e.normal),(t=new THREE.Vector3).copy(e.normal),(n=new THREE.Vector3).copy(t),n.multiplyScalar(-1),null!=e.distance?(f.viewer2DInfo.distance=e.distance,t.multiplyScalar(e.distance)):t.multiplyScalar(100),(e=new THREE.Vector3(0,0,0)).copy(f.viewer2DInfo.center),e.add(t),f.camera.position.copy(e),(e=new THREE.Vector3).copy(f.camera.position),e.add(n),f.camera.lookAt(e)),f.camera.updateProjectionMatrix()},this.camDisTo2DViewer=function(){var e=f.viewer2DInfo.normal.x,t=f.viewer2DInfo.normal.y,n=f.viewer2DInfo.normal.z,i={a:0,b:0,c:0};i.a=f.viewer2DInfo.center.x,i.b=f.viewer2DInfo.center.y,i.c=f.viewer2DInfo.center.z;var r=-(e*i.a+t*i.b+n*i.c),i={a:0,b:0,c:0};return i.a=f.camera.position.x,i.b=f.camera.position.y,i.c=f.camera.position.z,Math.abs(e*i.a+t*i.b+n*i.c+r)/Math.sqrt(e*e+t*t+n*n)},this.updateViewBoxCamQuaternion=function(e){y.camera.up.applyQuaternion(e),y.camera.position.applyQuaternion(e),y.camera.lookAt(y.center);e=new THREE.Vector3;e.subVectors(f.camera.getCameraTarget(),f.camera.position),e.normalize(),y.updateCurrentFace(e),requestAnimationFrame(y.render)},this.updateViewBoxCamDir=function(e){void 0===e&&((e=new THREE.Vector3).subVectors(f.camera.getCameraTarget(),f.camera.position),e.normalize()),y.camera.position.subVectors(y.center,e),y.camera.position.multiplyScalar(y.viewScale),y.camera.up.copy(f.camera.up),y.camera.lookAt(y.center),y.updateCurrentFace(e),y.render()},this.lookByFace=function(e){var t=new THREE.Vector3(0,0,0),n=v.getDestByFace(e),e=t.clone().sub(n.dir);e.normalize();n=n.up.clone(),n={from:e.toArray(),to:t.toArray(),up:n.toArray(),sphericalTransition:!0};this.look(n)},this.getView=function(){return this.viewer.camera.getWorldDirection()},this.getDestByFace=function(e){var t,n,i,r,o,a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(1,-0,0),l=new THREE.Vector3(0,0,-1);null==E&&(t=new THREE.Vector3(0,-1,0),d=new THREE.Vector3(0,1,0),n=new THREE.Vector3(0,0,-1),i=new THREE.Vector3(0,0,1),h=new THREE.Vector3(1,0,0),r=new THREE.Vector3(-1,0,0),o=new THREE.Vector3,(E={}).top=t,E.bottom=d,E.front=n,E.back=i,E.left=h,E.right=r,E["top,front"]=o.addVectors(t,n).clone(),E["top,right"]=o.addVectors(t,r).clone(),E["top,left"]=o.addVectors(t,h).clone(),E["top,back"]=o.addVectors(t,i).clone(),E["bottom,front"]=o.addVectors(d,n).clone(),E["bottom,right"]=o.addVectors(d,r).clone(),E["bottom,left"]=o.addVectors(d,h).clone(),E["bottom,back"]=o.addVectors(d,i).clone(),E["left,front"]=o.addVectors(h,n).clone(),E["front,right"]=o.addVectors(n,r).clone(),E["right,back"]=o.addVectors(r,i).clone(),E["back,left"]=o.addVectors(i,h).clone(),E["front,top,right"]=o.addVectors(n,t).add(r).clone(),E["back,top,right"]=o.addVectors(i,t).add(r).clone(),E["front,top,left"]=o.addVectors(n,t).add(h).clone(),E["back,top,left"]=o.addVectors(i,t).add(h).clone(),E["front,bottom,right"]=o.addVectors(n,d).add(r).clone(),E["back,bottom,right"]=o.addVectors(i,d).add(r).clone(),E["front,bottom,left"]=o.addVectors(n,d).add(h).clone(),E["back,bottom,left"]=o.addVectors(i,d).add(h).clone());var d=E[e].clone().normalize(),c=a,h=d.clone().negate();if(1-Math.abs(h.dot(a))<1e-5)for(var e=this.getView().normalize(),u=[l.clone(),l.clone().negate(),s.clone(),s.clone().negate()],f=0<h.dot(a)?1:-1,p=e.clone().add(this.viewer.camera.up.clone().multiplyScalar(f)).normalize(),m=-2,g=0;g<4;g++){var v=p.dot(u[g]);m<v&&(m=v,c=u[g].multiplyScalar(f))}return{dir:d.clone(),up:c.clone()}}};n(70);(y.prototype=Object.create(THREE.MeshBasicMaterial.prototype)).constructor=y;function E(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}}(E.prototype=Object.create(THREE.LineBasicMaterial.prototype)).constructor=E;function u(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var a,e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),n={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(a in this.activePlane=n.XYZE,n.YZ.rotation.set(0,Math.PI/2,0),n.XZ.rotation.set(-Math.PI/2,0,0),n)n[a].name=a,this.planes.add(n[a]),this.planes[a]=n[a];t=function(e,t){for(var n in e)for(a=e[n].length;a--;){var i=e[n][a][0],r=e[n][a][1],o=e[n][a][2];i.name=n,r&&i.position.set(r[0],r[1],r[2]),o&&i.rotation.set(o[0],o[1],o[2]),t.add(i)}};t(this.handleGizmos,this.handles),t(this.pickerGizmos,this.pickers),this.traverse(function(e){var t;e instanceof THREE.Mesh&&(e.updateMatrix(),(t=e.geometry.clone()).applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1))})},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})}}var s=new y({visible:!1,transparent:!1});((u.prototype=Object.create(THREE.Object3D.prototype)).constructor=u).prototype.update=function(t,n){var i=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,1,0),o=new THREE.Matrix4;this.traverse(function(e){-1!==e.name.search("E")?e.quaternion.setFromRotationMatrix(o.lookAt(n,i,r)):-1===e.name.search("X")&&-1===e.name.search("Y")&&-1===e.name.search("Z")||e.quaternion.setFromEuler(t)})};function Z(e){u.call(this);var t=!0,n=!0,i=!0;e&&(t=0<=e.indexOf("translateX"),n=0<=e.indexOf("translateY"),i=0<=e.indexOf("translateZ"));var r=new THREE.Geometry,o=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));o.position.y=.5,o.updateMatrix(),r.merge(o.geometry,o.matrix);var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3)),(e=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),(o=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={},t&&(this.handleGizmos.X=[[new THREE.Mesh(r,new y({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new E({color:16711680}))]]),n&&(this.handleGizmos.Y=[[new THREE.Mesh(r,new y({color:65280})),[0,.5,0]],[new THREE.Line(e,new E({color:65280}))]]),i&&(this.handleGizmos.Z=[[new THREE.Mesh(r,new y({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(o,new E({color:255}))]]),t&&n&&i&&(this.handleGizmos.XY=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:16776960,opacity:.25})),[.15,.15,0]]],this.handleGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],this.handleGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]),this.pickerGizmos={},t&&(this.pickerGizmos.X=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[.6,0,0],[0,0,-Math.PI/2]]]),n&&(this.pickerGizmos.Y=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,.6,0]]]),i&&(this.pickerGizmos.Z=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,0,.6],[Math.PI/2,0,0]]]),t&&n&&i&&(this.pickerGizmos.XYZ=[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),s)]],this.pickerGizmos.XY=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),s),[.2,.2,0]]],this.pickerGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),s),[0,.2,.2],[0,Math.PI/2,0]]],this.pickerGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),s),[.2,0,.2],[-Math.PI/2,0,0]]]),this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()}(Z.prototype=Object.create(u.prototype)).constructor=Z;function q(){function e(e,t,n){var i=new THREE.BufferGeometry,r=[];n=n||1;for(var o=0;o<=64*n;++o)"x"===t&&r.push(0,Math.cos(o/32*Math.PI)*e,Math.sin(o/32*Math.PI)*e),"y"===t&&r.push(Math.cos(o/32*Math.PI)*e,0,Math.sin(o/32*Math.PI)*e),"z"===t&&r.push(Math.sin(o/32*Math.PI)*e,Math.cos(o/32*Math.PI)*e,0);return i.addAttribute("position",new THREE.Float32BufferAttribute(r,3)),i}u.call(this),this.handleGizmos={X:[[new THREE.Line(new e(.7,"x",.5),new E({color:16711680}))]],Y:[[new THREE.Line(new e(.7,"y",.5),new E({color:65280}))]],Z:[[new THREE.Line(new e(.7,"z",.5),new E({color:255}))]],XYZE:[[new THREE.Line(new e(.7,"z",1),new E({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.7,.12,4,12,Math.PI),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.7,.12,4,12,Math.PI),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.7,.12,4,12,Math.PI),s),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){u.prototype.update.apply(this,arguments);this.handles,this.pickers;var n=new THREE.Matrix4,i=new THREE.Euler(0,0,1),r=new THREE.Quaternion,o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,d=new THREE.Quaternion,c=new THREE.Quaternion,h=t.clone();i.copy(this.planes.XY.rotation),r.setFromEuler(i),n.makeRotationFromQuaternion(r).getInverse(n),h.applyMatrix4(n),this.traverse(function(e){r.setFromEuler(i),"X"===e.name&&(l.setFromAxisAngle(o,Math.atan2(-h.y,h.z)),r.multiplyQuaternions(r,l),e.quaternion.copy(r)),"Y"===e.name&&(d.setFromAxisAngle(a,Math.atan2(h.x,h.z)),r.multiplyQuaternions(r,d),e.quaternion.copy(r)),"Z"===e.name&&(c.setFromAxisAngle(s,Math.atan2(h.y,h.x)),r.multiplyQuaternions(r,c),e.quaternion.copy(r))})},this.init()}(q.prototype=Object.create(u.prototype)).constructor=q;function Q(){var n=this;THREE.Object3D.call(this),this._gizmoTranslate=new Z,this._gizmoRotate=new q,this.add(this._gizmoTranslate),this.add(this._gizmoRotate),this._translatePickers=this._gizmoTranslate.pickers,this._rotatePickers=this._gizmoRotate.pickers,this.activePlane=this._gizmoTranslate.activePlane,this.highlight=function(e,t){"translate"==t?(this._gizmoRotate.highlight(null),this._gizmoTranslate.highlight(e)):"rotate"==t&&(this._gizmoTranslate.highlight(null),this._gizmoRotate.highlight(e))},this.setActivePlane=function(e,t){"translate"==n.pickType?(this._gizmoTranslate.setActivePlane(e,t),this.activePlane=this._gizmoTranslate.activePlane):"rotate"==n.pickType&&(this._gizmoRotate.setActivePlane(e,t),this.activePlane=this._gizmoRotate.activePlane)},this.update=function(e,t){this._gizmoTranslate.update(e,t),this._gizmoRotate.update(e,t)}}(Q.prototype=Object.create(THREE.Object3D.prototype)).constructor=Q;function J(){u.call(this);var e=new THREE.Geometry,t=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));t.position.y=.5,t.updateMatrix(),e.merge(t.geometry,t.matrix);var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),(t=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(e,new y({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(n,new E({color:16711680}))]],Y:[[new THREE.Mesh(e,new y({color:65280})),[0,.5,0]],[new THREE.Line(i,new E({color:65280}))]],Z:[[new THREE.Mesh(e,new y({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(t,new E({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new y({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),s)]]},this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()}(J.prototype=Object.create(u.prototype)).constructor=J;function P(o,a,e){THREE.Object3D.call(this),a=void 0!==a?a:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null,this.pickType=null,this.newPosition=new THREE.Vector3;var t,i=this,r="translate",s=!1,l={translate:new Z(e),rotate:new q,both:new Q,scale:new J};for(t in l){var n=l[t];n.visible=t===r,this.add(n)}var d={type:"change"},c={type:"mouseDown"},h={type:"mouseUp",mode:r},u={type:"objectChange"},f=new THREE.Raycaster,p=new THREE.Vector2,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,E=1,b=new THREE.Matrix4,M=new THREE.Vector3,x=new THREE.Matrix4,w=new THREE.Vector3,I=new THREE.Quaternion,S=new THREE.Vector3(1,0,0),T=new THREE.Vector3(0,1,0),A=new THREE.Vector3(0,0,1),R=new THREE.Quaternion,O=new THREE.Quaternion,P=new THREE.Quaternion,C=new THREE.Quaternion,B=new THREE.Quaternion,L=new THREE.Vector3,D=new THREE.Vector3,H=new THREE.Matrix4,N=new THREE.Matrix4,F=new THREE.Vector3,_=new THREE.Vector3,k=new THREE.Euler,V=new THREE.Matrix4,j=new THREE.Vector3,U=new THREE.Euler;function z(e){var t,n;i.visible&&(Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===i.object||!0===s||void 0!==e.button&&0!==e.button||(n=e.changedTouches?e.changedTouches[0]:e,t=null,"both"!=r?t=X(n,l[r].pickers.children):(t=X(n,l[r]._rotatePickers.children))?i.pickType="rotate":(t=X(n,l[r]._translatePickers.children))&&(i.pickType="translate"),n=null,t&&(n=t.object.name,e.preventDefault()),i.axis!==n&&(i.axis=n,i.update(),i.dispatchEvent(d))))}function G(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&i.visible&&void 0!==i.object&&!0!==s&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var n=null;if("both"!=r?n=X(t,l[r].pickers.children):(n=X(t,l[r]._rotatePickers.children))?i.pickType="rotate":(n=X(t,l[r]._translatePickers.children))&&(i.pickType="translate"),n){if(e.preventDefault(),e.stopPropagation(),i.dispatchEvent(c),!i.visible)return;i.axis=n.object.name,i.update(),M.copy(j).sub(_).normalize(),l[r].setActivePlane(i.axis,M);t=X(t,[l[r].activePlane]);t&&(L.copy(i.object.position),D.copy(i.object.scale),H.extractRotation(i.object.matrix),V.extractRotation(i.object.matrixWorld),N.extractRotation(i.object.parent.matrixWorld),F.setFromMatrixScale(x.getInverse(i.object.parent.matrixWorld)),g.copy(t.point))}}s=!0}}function W(e){var t;Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===i.object||null===i.axis||!1===s||void 0!==e.button&&0!==e.button||!1!==(t=X(e.changedTouches?e.changedTouches[0]:e,[l[r].activePlane]))&&(e.preventDefault(),e.stopPropagation(),i.visible&&(m.copy(t.point),"translate"===r||"translate"==i.pickType?(m.sub(g),m.multiply(F),"local"===i.space&&(m.applyMatrix4(x.getInverse(V)),-1===i.axis.search("X")&&(m.x=0),-1===i.axis.search("Y")&&(m.y=0),-1===i.axis.search("Z")&&(m.z=0),m.applyMatrix4(H),i.object.position.copy(L),i.object.position.add(m),i.newPosition=i.object.position.clone()),"world"!==i.space&&-1===i.axis.search("XYZ")||(-1===i.axis.search("X")&&(m.x=0),-1===i.axis.search("Y")&&(m.y=0),-1===i.axis.search("Z")&&(m.z=0),m.applyMatrix4(x.getInverse(N)),i.object.position.copy(L),i.object.position.add(m)),null!==i.translationSnap&&("local"===i.space&&i.object.position.applyMatrix4(x.getInverse(V)),-1!==i.axis.search("X")&&(i.object.position.x=Math.round(i.object.position.x/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Y")&&(i.object.position.y=Math.round(i.object.position.y/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Z")&&(i.object.position.z=Math.round(i.object.position.z/i.translationSnap)*i.translationSnap),"local"===i.space&&i.object.position.applyMatrix4(V))):"scale"===r?(m.sub(g),m.multiply(F),"local"===i.space&&("XYZ"===i.axis?(E=1+m.y/Math.max(D.x,D.y,D.z),i.object.scale.x=D.x*E,i.object.scale.y=D.y*E,i.object.scale.z=D.z*E):(m.applyMatrix4(x.getInverse(V)),"X"===i.axis&&(i.object.scale.x=D.x*(1+m.x/D.x)),"Y"===i.axis&&(i.object.scale.y=D.y*(1+m.y/D.y)),"Z"===i.axis&&(i.object.scale.z=D.z*(1+m.z/D.z))))):"rotate"!==r&&"rotate"!=i.pickType||(m.sub(_),m.multiply(F),w.copy(g).sub(_),w.multiply(F),"E"===i.axis?(m.applyMatrix4(x.getInverse(b)),w.applyMatrix4(x.getInverse(b)),v.set(Math.atan2(m.z,m.y),Math.atan2(m.x,m.z),Math.atan2(m.y,m.x)),y.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),I.setFromRotationMatrix(x.getInverse(N)),B.setFromAxisAngle(M,v.z-y.z),R.setFromRotationMatrix(V),I.multiplyQuaternions(I,B),I.multiplyQuaternions(I,R),i.object.quaternion.copy(I)):"XYZE"===i.axis?(B.setFromEuler(m.clone().cross(w).normalize()),I.setFromRotationMatrix(x.getInverse(N)),O.setFromAxisAngle(B,-m.clone().angleTo(w)),R.setFromRotationMatrix(V),I.multiplyQuaternions(I,O),I.multiplyQuaternions(I,R),i.object.quaternion.copy(I)):"local"===i.space?(m.applyMatrix4(x.getInverse(V)),w.applyMatrix4(x.getInverse(V)),v.set(Math.atan2(m.z,m.y),Math.atan2(m.x,m.z),Math.atan2(m.y,m.x)),y.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),R.setFromRotationMatrix(H),null!==i.rotationSnap?(O.setFromAxisAngle(S,Math.round((v.x-y.x)/i.rotationSnap)*i.rotationSnap),P.setFromAxisAngle(T,Math.round((v.y-y.y)/i.rotationSnap)*i.rotationSnap),C.setFromAxisAngle(A,Math.round((v.z-y.z)/i.rotationSnap)*i.rotationSnap)):(O.setFromAxisAngle(S,v.x-y.x),P.setFromAxisAngle(T,v.y-y.y),C.setFromAxisAngle(A,v.z-y.z)),"X"===i.axis&&R.multiplyQuaternions(R,O),"Y"===i.axis&&R.multiplyQuaternions(R,P),"Z"===i.axis&&R.multiplyQuaternions(R,C),i.object.quaternion.copy(R)):"world"===i.space&&(v.set(Math.atan2(m.z,m.y),Math.atan2(m.x,m.z),Math.atan2(m.y,m.x)),y.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),I.setFromRotationMatrix(x.getInverse(N)),null!==i.rotationSnap?(O.setFromAxisAngle(S,Math.round((v.x-y.x)/i.rotationSnap)*i.rotationSnap),P.setFromAxisAngle(T,Math.round((v.y-y.y)/i.rotationSnap)*i.rotationSnap),C.setFromAxisAngle(A,Math.round((v.z-y.z)/i.rotationSnap)*i.rotationSnap)):(O.setFromAxisAngle(S,v.x-y.x),P.setFromAxisAngle(T,v.y-y.y),C.setFromAxisAngle(A,v.z-y.z)),R.setFromRotationMatrix(V),"X"===i.axis&&I.multiplyQuaternions(I,O),"Y"===i.axis&&I.multiplyQuaternions(I,P),"Z"===i.axis&&I.multiplyQuaternions(I,C),I.multiplyQuaternions(I,R),i.object.quaternion.copy(I))),i.update(),i.dispatchEvent(d),i.dispatchEvent(u)))}function Y(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(e.preventDefault(),i.visible&&(void 0!==e.button&&0!==e.button||(s&&null!==i.axis&&(h.mode=r,i.dispatchEvent(h),s=!1,i.dispatchEvent(u)),s=!1,"TouchEvent"in window&&e instanceof TouchEvent?(i.axis=null,i.update(),i.dispatchEvent(d)):z(e))))}function X(e,t){var n=a.getBoundingClientRect(),i=n.width,r=n.height;null!=a.clientWidth&&null!=a.clientHeight&&(10<Math.abs(i-a.clientWidth)&&(i=a.clientWidth),10<Math.abs(r-a.clientHeight)&&(r=a.clientHeight));i=(e.clientX-n.left)/i,r=(e.clientY-n.top)/r;p.set(2*i-1,-2*r+1),o.setCastRay(f,p.x,p.y);t=f.intersectObjects(t,!0);return t[0]||!1}ye.isMobileDevice()?(a.addEventListener("touchstart",G,!1),a.addEventListener("touchmove",z,!1),a.addEventListener("touchmove",W,!1),a.addEventListener("touchend",Y,!1),a.addEventListener("touchcancel",Y,!1)):(a.addEventListener("mousedown",G,!1),a.addEventListener("mousemove",z,!1),a.addEventListener("mousemove",W,!1),a.addEventListener("mouseup",Y,!1)),this.isDragging=function(){return s},this.isSelected=function(){return null!=i.axis},this.setOldPosition=function(e){e&&L.copy(e)},this.getOldPosition=function(){return L},this.dispose=function(){ye.isMobileDevice()?(a.removeEventListener("touchstart",G),a.removeEventListener("touchmove",z),a.removeEventListener("touchmove",W),a.removeEventListener("touchend",Y),a.removeEventListener("touchcancel",Y),a.removeEventListener("touchleave",Y)):(a.removeEventListener("mousedown",G),a.removeEventListener("mousemove",z),a.removeEventListener("mousemove",W),a.removeEventListener("mouseup",Y),a.removeEventListener("mouseout",Y))},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return r},this.setMode=function(e){for(var t in"scale"===(r=e||r)&&(i.space="local"),l)l[t].visible=t===r;this.update(),i.dispatchEvent(d)},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e,this.update(),i.dispatchEvent(d)},this.setSpace=function(e){i.space=e,this.update(),i.dispatchEvent(d)},this.update=function(){var e,t,n;void 0!==i.object&&(i.object.updateMatrixWorld(),_.setFromMatrixPosition(i.object.matrixWorld),k.setFromRotationMatrix(x.extractRotation(i.object.matrixWorld)),o.updateMatrixWorld(),j.setFromMatrixPosition(o.matrixWorld),U.setFromRotationMatrix(x.extractRotation(o.matrixWorld)),o.updateMatrix(),e=o.getCameraTarget(),t=o.position,(n=new THREE.Vector3).subVectors(e,t),e=_.clone(),t=o.isPerspective?e.sub(t).dot(n.normalize()):1.2*n.length(),n=o.fov,n=120*(2*t*Math.tan(THREE.Math.degToRad(.5*n)))/a.height*i.size,ye.isMobileDevice()&&(n*=3),this.position.copy(_),this.scale.set(n,n,n),M.copy(j).sub(_).normalize(),"local"===i.space?l[r].update(k,M):"world"===i.space&&l[r].update(new THREE.Euler,M),l[r].highlight(i.axis,i.pickType))}}(P.prototype=Object.create(THREE.Object3D.prototype)).constructor=P;function Y(t,n,i,e){var r=i.camera,o=e._scene,a=null,s=null,l=(new THREE.Plane,new THREE.Raycaster),d=new THREE.Vector2,c=(new THREE.Vector3,null),h=!1,u=!1,f=!1,p=!0;this._enabled=!0;var m=1,g=this,v=!1,y=null;function E(){n.addEventListener("mousemove",x,!1),n.addEventListener("mousedown",M,!1),n.addEventListener("mouseup",w,!1),null==a&&((a=new P(r,n)).setMode("translate"),a.setSpace("local"),a.setSize(m),o.add(a),a.addEventListener("change",function(){a.update(),s.update(),i.render()})),null==s&&((s=new P(r,n)).setMode("both"),s.setSpace("local"),s.setSize(m),o.add(s),s.addEventListener("change",function(){s.update(),a.update(),i.render()})),v=!0}function b(){null!=a&&a.detach(a.object),null!=s&&s.detach(s.object),n.removeEventListener("mousemove",x,!1),n.removeEventListener("mousedown",M,!1),n.removeEventListener("mouseup",w,!1),v=!1}function M(e){h=!(u=!0),y=n.style.cursor,e.preventDefault(),e.stopPropagation(),r instanceof fe?r.setCastRay(l,d.x,d.y):l.setFromCamera(d,r);e=l.intersectObjects(t);0<e.length&&(c=e[0].object,n.style.cursor="move",g.dispatchEvent({type:"mousedown",object:c}))}function x(e){e.preventDefault(),e.stopPropagation();var t=n.getBoundingClientRect();d.x=(e.clientX-t.left)/t.width*2-1,d.y=2*-((e.clientY-t.top)/t.height)+1,u&&(h=!0,s.update(),a.update(),i.render())}function w(e){null!=e&&e.preventDefault(),h?(g.dispatchEvent({type:"mouseup",object:c}),u=!1):(a.detach(a.object),s.detach(s.object),null!=c&&g.attachTo(c)),i.render(),c=null,n.style.cursor=y,u=!1}this.isActive=function(){return v},this.getCurrAttachObj=function(){return f?a.object:p?s.object:void 0},this.setSize=function(e){m=e,null!=a&&a.setSize(e),null!=s&&s.setSize(e),this.update(),i.render()},this.addEventListener=function(e,t,n){"rotate"==e?s.addEventListener(t,n):"transform"==e?a.addEventListener(t,n):"both"==e&&(s.addEventListener(t,n),a.addEventListener(t,n))},this.getRotateControls=function(){return s},this.getTransformControls=function(){return a},this.attachTo=function(e){a.detach(a.object),s.detach(s.object),null!=e&&e instanceof THREE.Sprite&&("pointlightctrl"==e.name||"hemilightctrl"==e.name?(p=!(f=!0),a.attach(e.parent)):"dirlightctrl"!=e.name&&"spotlightctrl"!=e.name||(p=!(f=!1),s.attach(e.parent))),i.render()},this.detach=function(){null!=a&&a.detach(a.object),null!=s&&s.detach(s.object)},this.update=function(){null!=a&&(a.update(),a.updateMatrixWorld(!0)),null!=s&&(s.update(),s.updateMatrixWorld(!0))},this.setTransformEnabled=function(e){f=e},this.setRotateEnabled=function(e){p=e},this.setEnabled=function(e){e?this._enabled||E():this._enabled&&b(),this._enabled=e},this.activate=E,this.deactivate=b,this.dispose=function(){b()},this.isSelected=function(){return null!=c||(!(null==a||!a.isSelected())||!(null==s||!s.isSelected()))}}(Y.prototype=Object.create(THREE.EventDispatcher.prototype)).constructor=Y;var me=function(e){THREE.EventDispatcher.call(this);var t=void 0!==(t=e.renderer.domElement)?t:document,n=this,i=null,r=new THREE.Box3,o=void 0,a=!1;this.viewer=e,this.enabled=!0,this.render=function(e){n.dispatchEvent(e||{type:"render"})},this.update=function(){null!=i&&i.update()},this.onOpRender=function(e){n.render(e)},this.onOpEvent=function(e){n.dispatchEvent({type:"event",event:e})},this.setOperator=function(e){n.releaseOperator(),e.create(),e.addEventListener("render",n.onOpRender),e.addEventListener("mouseEvent",n.onOpEvent),e.addEventListener("event",n.onOpEvent),i=e,this.viewer.clearCenterCross&&(this.viewer.clearCenterCross(),"OpOrbit"==e.type&&"FirstPerson"==this.viewer.getModelOperationMode()&&this.viewer.drawCenterCross())},this.getOperator=function(){return i},this.releaseOperator=function(){var e=i;null!=e&&(e.release(),e.removeEventListener("render",n.onOpRender),e.removeEventListener("mouseEvent",n.onOpEvent),e.removeEventListener("event",n.onOpEvent),e=null)},this.setBoundingBox=function(e,t){r.set(e,t),a=!0,n.resetExplosionBoundingBox()},this.getBoundingBox=function(){return r},this.IsBoundingBoxUpdated=function(){return a},this.SetBoundingBoxUpdated=function(e){a=e},this.setExplosionBoundingBox=function(e,t){(o=void 0===o?new THREE.Box3:o).set(e,t)},this.getExplosionBoundingBox=function(){return o},this.resetExplosionBoundingBox=function(){o=void 0}};me.prototype=Object.create(THREE.EventDispatcher.prototype);var ge=function(d){var c=d.lights,o=d.camera,e=d.scene;this.viewer=d;var h=new THREE.Group;h.name="lightctrls",e.add(h);var l,a=null,a=d.canvas2D||d.canvas3D,u=[],f=null,p=null,m=null,g=null,v=null,y=null,E=null,b=null,M=null,x=null,w=null,I=null,S=null,T=null,e=c.length,n=!1,t=.7,s=(a.width,a.height),A=new Array(e),i=null,R=2,O=.7,P=1e3,C=this;this._scene=h;for(var r,B=new THREE.TextureLoader(new THREE.LoadingManager),L=0;L<c.length;L++)c[L]._enabled=!0,c[L]._visible=!0,c[L]._iconVisible=!1,h.add(c[L]),null!=c[L]._followCamera&&1==c[L]._followCamera&&(r=new F(L),c[L]._followCameraListener=r,c[L].oldDir=c[L].target.getWorldPosition(),c[L].oldDir.sub(c[L].getWorldPosition()),c[L].oldDir.normalize(),C.viewer.addFrameListener(r));function D(e){if(null==e)return-1;for(var t=0;t<e.children.length;t++)if(e.children[t]instanceof THREE.Sprite)return t;return-1}function H(e){if(null==e)return-1;for(var t=0;t<e.children.length;t++)if("spotframe"==e.children[t].name)return t;return-1}function N(){this.run=function(){new THREE.Vector3;a.width,s=a.height;for(var e,t=0;t<A.length;t++)c[t]._enabled&&c[t]._iconVisible&&(0<=(e=D(A[t]))&&(e=A[t].children[e],r=A[t].position.distanceTo(o.position)/30,"hemilightctrl"==e.name&&(r*=1.6),e.scale.x=e.scale.y=r=r/(s/1e3)*O,e.updateMatrixWorld(!0)));for(var n,i,r,t=0;t<A.length;t++)c[t]._enabled&&c[t]._iconVisible&&(n=-1,(i=null)!=A[t]&&"spotlightgroup"==A[t].name?n=H(A[t]):null!=A[t]&&"dirlightgroup"==A[t].name&&(n=function(e){if(null==e)return-1;for(var t=0;t<e.children.length;t++)if("sundir"==e.children[t].name)return t;return-1}(A[t])),0<=n&&(i=A[t].children[n],r=A[t].position.distanceTo(o.position)/30,i.scale.x=i.scale.y=i.scale.z=r=r/(s/1e3)*O,i.updateMatrixWorld(!0)));null!=T&&T.update()}}function F(r){this.run=function(){var e,t,n,i;d.controls instanceof me&&"DirectionalLight"==c[r].type&&(e=o.getWorldDirection(),i=o.up.clone(),e.normalize(),i.normalize(),e.negate(),i.multiplyScalar(.9),(t=new THREE.Vector3).addVectors(e,i),t.normalize(),t.negate(),(i=c[r])._iconVisible&&((n=A[r]).matrix.identity(),n.matrix.decompose(new THREE.Vector3,n.quaternion,n.scale),n.updateMatrixWorld(!0)),n=i.target,i=i.position,n.position.set(i.x+t.x,i.y+t.y,i.z+t.z),n.updateMatrixWorld(!0))}}function _(){(T=new Y(u,a,d,C)).setSize(t),i=new N,C.viewer.addFrameListener(i);var e=D(A[0]);0<e&&T.attachTo(A[0].children[e]),d.render()}function k(){var e=new THREE.MeshBasicMaterial({color:6710886,wireframe:!0}),t=new THREE.CylinderGeometry(.1,.6,.8,20,0,!0),e=new THREE.Mesh(t,e);return e.position.set(0,0,0),e.name="spotframe",e}function V(e){null==S&&(S=new THREE.SpriteMaterial({map:I,side:THREE.DoubleSide,transparent:!0}));var t=c[e],n=new THREE.Sprite(S);n.name="spotlightctrl",u.push(n);var i=k();A[e]=new THREE.Group,A[e].name="spotlightgroup",A[e].index=e,A[e].position.copy(t.position);var r=t.position.x,o=t.position.y,a=t.position.z,s=t.target.position.x,l=t.target.position.y,d=t.target.position.z,o=new THREE.Vector3(s-r,l-o,d-a);o.normalize();d=new THREE.Quaternion,a=new THREE.Vector3(0,-1,0);t.position.set(0,0,0),t.target.position.set(0,-1,0),A[e].add(n),A[e].add(i),A[e].add(t.target),A[e].add(t),d.setFromUnitVectors(a,o);o=A[e].quaternion;o.multiplyQuaternions(d,o),o.normalize(),A[e].setRotationFromQuaternion(o),h.add(A[e]),c[e]._iconVisible=!0,A[e].updateMatrixWorld(!0)}function j(e){null==v&&(v=new THREE.SpriteMaterial({map:y,side:THREE.DoubleSide,transparent:!0}));var t=c[e],n=new THREE.Sprite(v);n.name="pointlightctrl",u.push(n),A[e]=new THREE.Group,A[e].name="pointlightgroup",A[e].position.copy(t.position),t.position.set(0,0,0),A[e].add(n),A[e].add(t),h.add(A[e]),c[e]._iconVisible=!0,A[e].updateMatrixWorld(!0)}function U(e){null==b&&(b=new THREE.SpriteMaterial({map:M,side:THREE.DoubleSide,transparent:!0}));var t=c[e],n=new THREE.Sprite(b);n.name="hemilightctrl",u.push(n),A[e]=new THREE.Group,A[e].name="hemilightgroup",A[e].position.copy(t.position),t.position.set(0,0,0),A[e].add(n),A[e].add(t),h.add(A[e]),c[e]._iconVisible=!0,A[e].updateMatrixWorld(!0)}function z(e){null==f&&(f=new THREE.SpriteMaterial({map:p,side:THREE.DoubleSide,transparent:!0}));var t=c[e],n=new THREE.Sprite(f);n.name="dirlightctrl",u.push(n);var i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0));var r=t.position.x,o=t.position.y,a=t.position.z,s=t.target.position.x,l=t.target.position.y,d=t.target.position.z,d=new THREE.Vector3(s-r,l-o,d-a);(d=d.normalize()).x*=R,d.y*=R,d.z*=R,i.vertices.push(new THREE.Vector3(d.x,d.y,d.z));a=new THREE.LineBasicMaterial({linewidth:1,color:16776960}),a=new THREE.Line(i,a);a.name="sundir",t.target.position.copy(d),A[e]=new THREE.Group,A[e].name="dirlightgroup",A[e].index=e,A[e].position.copy(t.position),t.position.set(0,0,0),A[e].add(n),A[e].add(t.target),A[e].add(t),A[e].add(a),h.add(A[e]),c[e]._iconVisible=!0,A[e].updateMatrixWorld(!0)}function G(e){for(var t=0;t<u.length;t++)if(e==u[t]){u.splice(t,1);break}}function W(e){for(var t=0;t<c.length;t++)if(e==c[t])return t}this.loadTextures=function(e){p=B.load("./img/sun.png",function(){M=B.load("./img/hemi.png",function(){y=B.load("./img/lamp.png",function(){I=B.load("./img/spotlight.png",function(){null!=e&&e()})})})})},this.resetPosition=function(){var e=d.controls.getBoundingBox(),t=e.min.x,n=e.min.y,i=e.min.z,r=e.max.x,o=e.max.y,e=e.max.z,a=new Array(3);a[0]=o-n,a[1]=r-t,a[2]=e-i;for(var s=1,l=0;l<3;l++)a[l]>s&&(s=a[l]);P=4*s,s/=10,C.setDirLength(2),c[0]._iconVisible?(A[0].position.set(t+(r-t)/2,o+s,i-s),A[0].updateMatrixWorld(!0)):(c[0].position.set(t+(r-t)/2,o+s,i-s),c[0].updateMatrixWorld(!0)),c[1]._iconVisible?(A[1].position.set(r+s,o+s,i+(e-i)/2),A[1].updateMatrixWorld(!0)):(c[1].position.set(r+s,o+s,i+(e-i)/2),c[1].updateMatrixWorld(!0)),c[2]._iconVisible?(A[2].position.set(t-s,o+s,i+(e-i)/2),A[2].updateMatrixWorld(!0)):(c[2].position.set(t-s,o+s,i+(e-i)/2),c[2].updateMatrixWorld(!0)),c[2]._distance=50,c[2].distance=c[2]._distance/100*P,d.render()},this.setIconVisible=function(e,t){if(null==e||!e._enabled)return!1;null==T&&(_(),T.isActive()||T.activate());var n=W(e),i=e.type;if(e._iconVisible!=t){if(t)switch(i){case"DirectionalLight":z(n);break;case"SpotLight":V(n);break;case"HemisphereLight":U(n);break;case"PointLight":j(n)}else{h.remove(A[n]);var r=D(A[n]),o=A[n].children[r],r=T.getCurrAttachObj();A[n]==r&&T.detach(),G(o),e.position.copy(A[n].position),"DirectionalLight"!=i&&"SpotLight"!=i||(i=e.target.getWorldPosition(),e.target.position.copy(i),h.add(e.target),e.target.updateMatrixWorld(!0)),h.add(e),e.updateMatrixWorld(!0),e._iconVisible=t}d.render()}},this.setIconSize=function(e){O=e},this.setControlsSize=function(e){t=e,T.setSize(t)},this.setDirLength=function(e){R=e},this.getLightsCount=function(){return c.length},this.setVisible=function(e){if(e==n)return!1;for(var t=0;t<c.length;t++)c[t]._enabled&&this.setIconVisible(c[t],e);return(n=e)?null==T||T.isActive()||T.activate():null!=T&&T.isActive()&&T.deactivate(),!0},this.getVisible=function(){for(var e=!1,t=0;t<c.length;t++)if(c[t]._iconVisible){e=!0;break}return e},this.dispose=function(){for(var e,t=0;t<c.length;t++)h.remove(A[t]),c[t].position.copy(A[t].position),"DirectionalLight"!=c[t].type&&"SpotLight"!=c[t].type||(e=c[t].target.getWorldPosition(),c[t].target.position.copy(e)),h.add(c[t]);u.splice(0,u.length),d.render()},this.switchLight=function(e,t){if(e<0||e>=c.length)return!1;if(!c[e]._enabled)return!1;if(c[e].type!=t){"DirectionalLight"==c[e].type&&c[e]._followCamera&&(C.viewer.removeFrameListener(c[e]._followCameraListener),c[e]._followCamera=null);var n=null;c[e]._iconVisible?(n=A[e].position,h.remove(A[e]),i=D(A[e]),G(A[e].children[i])):(h.remove(c[e]),n=c[e].position);var i,r=c[e]._iconVisible;switch(t){case"DirectionalLight":c[e]=new THREE.DirectionalLight(16777215,1),c[e]._enabled=!0,c[e]._visible=!0,c[e]._iconVisible=!1,c[e]._followCamera=!1,c[e].position.copy(n),r?z(e):h.add(c[e]);break;case"PointLight":c[e]=new THREE.PointLight(16777215),c[e]._enabled=!0,c[e]._visible=!0,c[e]._iconVisible=!1,c[e]._distance=50,c[e].distance=.5*P,c[e].position.copy(n),r?j(e):h.add(c[e]);break;case"HemisphereLight":c[e]=new THREE.HemisphereLight(16777215,16777215,1),c[e]._enabled=!0,c[e]._visible=!0,c[e]._iconVisible=!1,c[e].position.copy(n),r?U(e):h.add(c[e]);break;case"SpotLight":c[e]=new THREE.SpotLight(16777215,1),c[e]._enabled=!0,c[e]._visible=!0,c[e]._iconVisible=!1,c[e]._distance=50,c[e].distance=.5*P,c[e].position.copy(n),c[e].target.position.set(n.x,n.y-1,n.z),r?V(e):h.add(c[e])}c[e]._iconVisible&&(T.detach(),i=D(A[e]),T.attachTo(A[e].children[i])),d.render()}return!0},this.getLight=function(e){return e<0||e>=c.length?null:c[e]},this.showLightGizmo=function(e){var t,n;e._enabled&&e._iconVisible&&(t=W(e),n=D(A[t]),n=A[t].children[n],e._enabled?T.attachTo(n):T.detach())},this.getLightEnabled=function(e){if(null!=e)return e._enabled},this.setLightVisible=function(e,t){if(null==e)return!1;if(e._visible==t)return!0;e._visible=t;var n=W(e),i=e.type;if(t){switch(i){case"DirectionalLight":null==f&&(f=new THREE.SpriteMaterial({map:p,side:THREE.DoubleSide,transparent:!0})),(a=new THREE.Sprite(f)).name="dirlightctrl";break;case"HemisphereLight":null==b&&(b=new THREE.SpriteMaterial({map:M,side:THREE.DoubleSide,transparent:!0})),(a=new THREE.Sprite(b)).name="hemilightctrl";break;case"PointLight":null==v&&(v=new THREE.SpriteMaterial({map:y,side:THREE.DoubleSide,transparent:!0})),(a=new THREE.Sprite(v)).name="pointlightctrl";break;case"SpotLight":null==S&&(S=new new THREE.SpriteMaterial({map:I,side:THREE.DoubleSide,transparent:!0})),(a=new THREE.Sprite(S)).name="spotlightctrl";var r=k();A[n].add(r)}o=D(A[n]);A[n].remove(A[n].children[o]),A[n].add(a),A[n].add(e),u.push(a)}else{A[n].remove(e);var o=D(A[n]);G(A[n].children[o]);var a=null;switch(i){case"DirectionalLight":null==g&&(g=new THREE.SpriteMaterial({map:m,side:THREE.DoubleSide,transparent:!0})),a=new THREE.Sprite(g);break;case"HemisphereLight":null==x&&(x=new THREE.SpriteMaterial({map:w,side:THREE.DoubleSide,transparent:!0})),a=new THREE.Sprite(x);break;case"PointLight":null==E&&(E=new THREE.SpriteMaterial({map:void 0,side:THREE.DoubleSide,transparent:!0})),a=new THREE.Sprite(E);break;case"SpotLight":null==l&&(l=new THREE.SpriteMaterial({map:void 0,side:THREE.DoubleSide,transparent:!0}));var a=new THREE.Sprite(l),s=H(A[n]);A[n].remove(A[n].children[s])}T.getCurrAttachObj()==A[n]&&T.detach();var o=D(A[n]);A[n].remove(A[n].children[o]),A[n].add(a)}},this.setLightEnabled=function(e,t){if(null==e)return!1;var n=W(e);if(e._enabled!=t){e._enabled=t;var i,r,o=e.type;switch(o){case"DirectionalLight":t?(e._iconVisible?h.add(A[n]):(h.add(e),h.add(e.target)),e._followCamera&&(i=new F(n),C.viewer.addFrameListener(i),e._followCameraListener=i)):(e._followCamera&&C.viewer.removeFrameListener(e._followCameraListener),e._iconVisible?h.remove(A[n]):(h.remove(e),h.remove(e.target)));break;case"PointLight":case"SpotLight":case"HemisphereLight":t?e._iconVisible?h.add(A[n]):(h.add(e),"SpotLight"==o&&h.add(e.target)):e._iconVisible?h.remove(A[n]):(h.remove(e),"SpotLight"==o&&h.remove(e.target))}t&&e._iconVisible?(r=D(A[n]),T.attachTo(A[n].children[r])):!t&&e._iconVisible&&null!=T&&T.getCurrAttachObj()==A[n]&&T.detach(),t&&C.setIconVisible(e,!0),d.render()}return!0},this.getPointLightParam=function(e){var t={};if(null!=e&&"PointLight"==e.type)return t.color=e.color.getHex(),t.intensity=e.intensity,t.distance=e._distance,t.position={},t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.iconVisible=e._iconVisible,t},this.setPointLightParam=function(e,t){if(void 0===t||null==e)return!1;if(null==e)return!1;if(!e._enabled)return!1;if("PointLight"!=e.type)return!1;var n,i,r,o=!1,a=W(e);return e._visible&&(null!=t.color&&"null"!=t.color&&(n=parseInt(t.color),e.color=new THREE.Color(n),o=!0),null!=t.intensity&&"null"!=t.intensity&&(n=parseFloat(t.intensity),e.intensity=n,o=!0),null!=t.distance&&"null"!=t.distance&&(i=parseFloat(t.distance),e._distance=i,e.distance=i/100*P+.1,o=!0),null!=t.position&&"null"!=t.position&&(i=null,i="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,e._iconVisible?(A[a].position.set(i.x,i.y,i.z),A[a].updateMatrixWorld(!0)):(e.position.set(i.x,i.y,i.z),e.updateMatrixWorld(!0)),o=!0)),null!=t.visible&&"null"!=t.visible&&(r=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?r=!0:"false"==t.visible&&(r=!1):r=t.visible,this.setLightVisible(e,r),o=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(r=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?r=!0:"false"==t.iconVisible&&(r=!1):r=t.iconVisible,this.setIconVisible(e,r),o=!0),d.render(),o},this.getDirLightParam=function(e){var t={};if(null!=e&&"DirectionalLight"==e.type)return t.color=e.color.getHex(),t.intensity=e.intensity,t.followCamera=e._followCamera,t.position={},t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.target={},t.target.x=e.target.position.x,t.target.y=e.target.position.y,t.target.z=e.target.position.z,t.iconVisible=e._iconVisible,t},this.setDirLightParam=function(e,t){if(void 0===t||null==e)return!1;if(null==e)return!1;var n=W(e);if(!e._enabled)return!1;if("DirectionalLight"!=e.type)return!1;var i,r,o,a,s,l=!1;return e._visible&&(null!=t.color&&"null"!=t.color&&(i=parseInt(t.color),e.color=new THREE.Color(i),l=!0),null!=t.intensity&&"null"!=t.intensity&&(o=parseFloat(t.intensity),e.intensity=o,l=!0),null!=t.followCamera&&"null"!=t.followCamera&&(i=null,"[object String]"===Object.prototype.toString.call(t.followCamera)?"true"==t.followCamera?i=!0:t.followCamera:i=t.followCamera,i?e._followCamera||(r=new F(n),e._followCameraListener=r,e.oldDir=e.target.getWorldPosition(),e.oldDir.sub(e.getWorldPosition()),e.oldDir.normalize(),C.viewer.addFrameListener(r),d.render()):e._followCamera&&(C.viewer.removeFrameListener(e._followCameraListener),o=new THREE.Vector3,void 0===e.oldDir&&(e.oldDir=e.target.getWorldPosition(),e.oldDir.sub(e.getWorldPosition()),e.oldDir.normalize()),o.addVectors(e.getWorldPosition(),e.oldDir),e.target.position.copy(o),e.target.updateMatrixWorld(!0),e._iconVisible&&(r=T.getCurrAttachObj()==A[n],h.remove(A[n]),0<=(o=D(A[n]))&&G(A[n].children[o]),e.position.copy(A[n].position),z(n),r&&0<=(o=D(A[n]))&&(o=A[n].children[o],T.attachTo(o)))),e._followCamera=i,l=!0),null!=t.position&&"null"!=t.position&&(a=null,a="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,e._iconVisible?(A[n].position.set(a.x,a.y,a.z),A[n].updateMatrixWorld(!0)):(e.position.set(a.x,a.y,a.z),e.updateMatrixWorld(!0)),l=!0),null!=t.target&&"null"!=t.target&&(a=null,a="[object String]"===Object.prototype.toString.call(t.target)?JSON.parse(t.target):t.target,e._iconVisible?(n=A[n].position,e.target.position.set(a.x-n.x,a.y-n.y,a.z-n.z)):e.target.position.set(a.x,a.y,a.z),e.target.updateMatrixWorld(!0),l=!0)),null!=t.visible&&"null"!=t.visible&&(s=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?s=!0:"false"==t.visible&&(s=!1):s=t.visible,this.setLightVisible(e,s),l=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(s=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?s=!0:"false"==t.iconVisible&&(s=!1):s=t.iconVisible,this.setIconVisible(e,s),l=!0),d.render(),l},this.getSpotLightParam=function(e){var t={};if(null!=e&&"SpotLight"==e.type)return t.color=e.color.getHex(),t.intensity=e.intensity,t.distance=e._distance,t.angle=e.angle,t.penumbra=e.penumbra,t.position={},t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.target={},t.target.x=e.target.position.x,t.target.y=e.target.position.y,t.target.z=e.target.position.z,t.iconVisible=e._iconVisible,t},this.setSpotLightParam=function(e,t){if(void 0===t||null==e)return!1;if(null==e)return!1;if(!e._enabled)return!1;if("SpotLight"!=e.type)return!1;var n,i,r,o,a,s=W(e),l=!1;return e._visible&&(null!=t.color&&"null"!=t.color&&(n=parseInt(t.color),e.color=new THREE.Color(n),l=!0),null!=t.intensity&&"null"!=t.intensity&&(i=parseFloat(t.intensity),e.intensity=i,l=!0),null!=t.distance&&"null"!=t.distance&&(i=parseFloat(t.distance),e._distance=i,e.distance=i/100*P+.1,l=!0),null!=t.angle&&"null"!=t.angle&&(r=parseFloat(t.angle),e.angle=r,l=!0),null!=t.penumbra&&"null"!=t.penumbra&&(r=parseFloat(t.penumbra),e.penumbra=r,l=!0),null!=t.position&&"null"!=t.position&&(o=null,o="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,e._iconVisible?(A[s].position.set(o.x,o.y,o.z),A[s].updateMatrixWorld(!0)):(e.position.set(o.x,o.y,o.z),e.updateMatrixWorld(!0)),l=!0),null!=t.target&&"null"!=t.target&&(o=null,o="[object String]"===Object.prototype.toString.call(t.target)?JSON.parse(t.target):t.target,e._iconVisible?(s=A[s].position,e.target.position.set(o.x-s.x,o.y-s.y,o.z-s.z)):e.target.position.set(o.x,o.y,o.z),e.target.updateMatrixWorld(!0),l=!0)),null!=t.visible&&"null"!=t.visible&&(a=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?a=!0:"false"==t.visible&&(a=!1):a=t.visible,this.setLightVisible(e,a),l=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(a=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?a=!0:"false"==t.iconVisible&&(a=!1):a=t.iconVisible,this.setIconVisible(e,a),l=!0),d.render(),l},this.getHemiLightParam=function(e){var t={};if(null!=e&&"HemisphereLight"==e.type)return t.skyColor=e.color.getHex(),t.groundColor=e.groundColor.getHex(),t.intensity=e.intensity,t.position={},t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.iconVisible=e._iconVisible,t},this.setHemiLightParam=function(e,t){if(void 0===t||null==e)return!1;if(null==e)return!1;if(!e._enabled)return!1;if("HemisphereLight"!=e.type)return!1;var n,i,r,o=!1,a=W(e);return e._visible&&(null!=t.skyColor&&"null"!=t.skyColor&&(n=parseInt(t.skyColor),e.color=new THREE.Color(n),o=!0),null!=t.groundColor&&"null"!=t.groundColor&&(n=parseInt(t.groundColor),e.groundColor=new THREE.Color(n),o=!0),null!=t.intensity&&"null"!=t.intensity&&(i=parseFloat(t.intensity),e.intensity=i,o=!0),null!=t.position&&"null"!=t.position&&(i=null,i="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,e._iconVisible?(A[a].position.set(i.x,i.y,i.z),A[a].updateMatrixWorld(!0)):(e.position.set(i.x,i.y,i.z),e.updateMatrixWorld(!0)),o=!0)),null!=t.visible&&"null"!=t.visible&&(r=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?r=!0:"false"==t.visible&&(r=!1):r=t.visible,this.setLightVisible(e,r),o=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(r=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?r=!0:"false"==t.iconVisible&&(r=!1):r=t.iconVisible,this.setIconVisible(e,r),o=!0),d.render(),o},this.setLightParam=function(e,t){if(null==e||null==t)return!1;switch(e.type){case"DirectionalLight":return setDirLightParam(e,t);case"SpotLight":return setSpotLightParam(e,t);case"PointLight":return setPointLightParam(e,t);case"HemisphereLight":return setHemiLightParam(e,t)}},this.isLightEditControlSelected=function(){return!(null==T||!T.isActive())&&T.isSelected()}},ve=function(e){THREE.EventDispatcher.call(this);var t=this,n=null;this.viewer=e,this.render=function(){t.dispatchEvent({type:"render"})},this.update=function(){null!=n&&n.update()},this.onOpRender=function(){t.render()},this.onOpEvent=function(e){t.dispatchEvent({type:"event",event:e})},this.setOperator=function(e){t.releaseOperator(),e.create(),e.addEventListener("render",t.onOpRender),e.addEventListener("mouseEvent",t.onOpEvent),e.addEventListener("event",t.onOpEvent),n=e},this.getOperator=function(){return n},this.releaseOperator=function(){var e=n;null!=e&&(e.release(),e.removeEventListener("render",t.onOpRender),e.removeEventListener("mouseEvent",t.onOpEvent),e.removeEventListener("event",t.onOpEvent),e=null)}};ve.prototype=Object.create(THREE.EventDispatcher.prototype);var Ee=function(e,t){var y=this,d=(this.viewer=e).cameraControl,c=e.camera,u=e.viewBoxDiv;this.viewCubeMenuOpen=!1;var f={};this.boxSize=void 0===t?235:t,y.currentFace="front";var p,m,g,v,E,b,M,x,w,I,S,r=["top,front","top,right","top,left","top,back","bottom,front","bottom,right","bottom,left","bottom,back","left,front","front,right","right,back","back,left"],o=["front,top,right","back,top,right","front,top,left","back,top,left","front,bottom,right","back,bottom,right","front,bottom,left","back,bottom,left"],T=null;u.getBoundingClientRect();y.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),this.originCamInfo={};var A,R,O,P,C,B,L,a=[],D=[],s=[],H=[],h=[],l=null,N=null,F=null,_=0,i=0,k=!0,V=!1,n=!1,j=!1,U=!1,z=!1,G=[];this.width=0,this.height=0,this.animSpeed=500,this.animate=!0,this.compass=!1,this.viewScaleFactorCompass=1.5,this.viewScale=1,this.draggable=!1,this.wantHomeButton=!1,this.wantRollArrows=!0,this.wantContextMenu=!1,this.inactiveOpacity=.5;function W(e){return{x:(e=e.getBoundingClientRect()).left,y:e.top,w:e.width,h:e.height}}function Y(e){e.preventDefault(),e.stopPropagation(),n=document.pointerLockElement===u||document.mozPointerLockElement===u||document.webkitPointerLockElement===u}function X(e){return e}this.getView=function(){return y.center.clone().sub(y.camera.position)};function Z(){u.style.opacity="1.0",z=!1,requestAnimationFrame(y.render)}function q(e){var t;z||y.viewCubeMenuOpen||(t=Math.max(4*Math.abs((e.clientX-L.x)/L.w-.5)-1,0),e=Math.max(4*Math.abs((e.clientY-L.y)/L.h-.5)-1,0),e=Math.max(0,Math.min(Math.sqrt(t*t+e*e),1)),u.style.opacity=1-e*(1-y.inactiveOpacity))}function Q(){u.style.opacity=y.inactiveOpacity,z=!0,y.render()}function J(e,t,n){var i=new THREE.Vector3;return i.copy(e),i=i.unproject(t),new THREE.Raycaster(t.position,i.sub(t.position).normalize()).intersectObjects(n)}function K(e,t){var n=e.clientX-t.x,e=e.clientY-t.y,n=n/t.w*2-1,e=(t.h-e)/t.h*2-1;return new THREE.Vector3(n,e,.5)}var $=function(e){var t=new Image;t.crossOrigin="anonymous";var n=new THREE.Texture(t);return t.onload=function(){n.needsUpdate=!0,11<=++i&&requestAnimationFrame(y.render)},t.src=e,n},ee=function(){var e,t,n=[],i=[];for(n[0]=ce(0,0),n[1]=ce(0,Math.PI/2),n[2]=ce(0,-Math.PI/2),n[3]=ce(0,Math.PI),n[4]=ce(Math.PI/2,0),n[5]=ce(Math.PI/2,Math.PI/2),n[6]=ce(Math.PI/2,-Math.PI/2),n[7]=ce(Math.PI/2,Math.PI),i[0]=de(0,0,0),i[1]=de(0,Math.PI/2,0),i[2]=de(0,-Math.PI/2,0),i[3]=de(0,Math.PI,0),i[4]=de(Math.PI/2,0,0),i[5]=de(Math.PI/2,Math.PI/2,0),i[6]=de(Math.PI/2,-Math.PI/2,0),i[7]=de(Math.PI/2,Math.PI,0),i[8]=de(0,0,Math.PI/2),i[9]=de(0,0,-Math.PI/2),i[10]=de(-Math.PI/2,0,-Math.PI/2),i[11]=de(-Math.PI,0,-Math.PI/2),a.push(le(0,0)),a[0].name="front",s.push(a[0]),h.push(a[0]),g.add(a[0]),a.push(le(0,Math.PI/2)),a[1].name="right",s.push(a[1]),h.push(a[1]),g.add(a[1]),a.push(le(0,Math.PI)),a[2].name="back",s.push(a[2]),h.push(a[2]),g.add(a[2]),a.push(le(0,-Math.PI/2)),a[3].name="left",s.push(a[3]),h.push(a[3]),g.add(a[3]),a.push(le(Math.PI/2,0)),a[4].name="bottom",s.push(a[4]),h.push(a[4]),g.add(a[4]),a.push(le(-Math.PI/2,0)),a[5].name="top",s.push(a[5]),h.push(a[5]),g.add(a[5]),e=a.length,t=0;t<n.length;t++)a.push(n[t]),a[e+t].name=o[t],g.add(a[e+t]),s.push(a[e+t]),h.push(a[e+t]);for(e=a.length,t=0;t<i.length;t++)a.push(i[t]),a[e+t].name=r[t],g.add(a[e+t]),s.push(a[e+t]),h.push(a[e+t])};function te(e,t){var n={};return 0===e.type.indexOf("touch")?0<e.changedTouches.length?(n.clientX=e.changedTouches[0].clientX,n.clientY=e.changedTouches[0].clientY,n.pageX=e.changedTouches[0].pageX,n.pageY=e.changedTouches[0].pageY,n.screenX=e.changedTouches[0].screenX,n.screenY=e.changedTouches[0].screenY,n.movementX=n.screenX-t.prevX,n.movementY=n.screenY-t.prevY):n=t.prevCoords:(n.clientX=e.clientX,n.clientY=e.clientY,n.pageX=e.pageX,n.pageY=e.pageY,n.screenX=e.screenX,n.screenY=e.screenY,n.which=e.which,V?(n.movementX=e.movementX||e.mozMovementX||e.webkitMovementX||0,n.movementY=e.movementY||e.mozMovementY||e.webkitMovementY||0):(n.movementX=n.screenX-t.prevX,n.movementY=n.screenY-t.prevY)),t.prevX=n.screenX,t.prevY=n.screenY,t.prevCoords=n}function ne(e){if(e.preventDefault(),e.stopPropagation(),y.animSpeed<=0)return document.removeEventListener("mousemove",ne,!1),document.removeEventListener("touchmove",ne,!1),void avp.logger.error("animSpeed cannot be 0 or less");d.currentlyAnimating||(e=te(e,y),V&&j&&(j=!1,e.movementX=e.movementY=0),n&&(300<e.movementX||300<e.movementY)&&(e.movementX=0,e.movementY=0),e.movementX!==e.movementY||0!==e.movementX?(U=!(k=!1),d.showPivot(!0),d.currentCursor=new THREE.Vector2(e.pageX,e.pageY),d.orbit(d.currentCursor,d.startCursor,new THREE.Vector3(-e.movementX,e.movementY,0),d.startState),y.camera.lookAt(y.center),requestAnimationFrame(y.render)):d.currentlyAnimating=!1)}function ie(e){e||(u.removeEventListener("mouseup",oe,!1),u.removeEventListener("touchend",oe,!1)),document.removeEventListener("mousemove",ne,!1),document.removeEventListener("touchmove",ne,!1),u.addEventListener("mousemove",se,!1),n&&document.exitPointerLock()}var re=function(e){ye.isMobileDevice()&&y.processMouseMove(e),e.preventDefault(),e.stopPropagation(),L=W(u),u.removeEventListener("mousemove",se,!1),u.addEventListener("mouseup",oe,!1),u.addEventListener("touchend",oe,!1)};this.getDestByFace=function(e){var t,n,i,r,o,a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(1,-0,0),l=new THREE.Vector3(0,0,-1);null==T&&(t=new THREE.Vector3(0,-1,0),d=new THREE.Vector3(0,1,0),n=new THREE.Vector3(0,0,-1),i=new THREE.Vector3(0,0,1),h=new THREE.Vector3(1,0,0),r=new THREE.Vector3(-1,0,0),o=new THREE.Vector3,(T={}).top=t,T.bottom=d,T.front=n,T.back=i,T.left=h,T.right=r,T["top,front"]=o.addVectors(t,n).clone(),T["top,right"]=o.addVectors(t,r).clone(),T["top,left"]=o.addVectors(t,h).clone(),T["top,back"]=o.addVectors(t,i).clone(),T["bottom,front"]=o.addVectors(d,n).clone(),T["bottom,right"]=o.addVectors(d,r).clone(),T["bottom,left"]=o.addVectors(d,h).clone(),T["bottom,back"]=o.addVectors(d,i).clone(),T["left,front"]=o.addVectors(h,n).clone(),T["front,right"]=o.addVectors(n,r).clone(),T["right,back"]=o.addVectors(r,i).clone(),T["back,left"]=o.addVectors(i,h).clone(),T["front,top,right"]=o.addVectors(n,t).add(r).clone(),T["back,top,right"]=o.addVectors(i,t).add(r).clone(),T["front,top,left"]=o.addVectors(n,t).add(h).clone(),T["back,top,left"]=o.addVectors(i,t).add(h).clone(),T["front,bottom,right"]=o.addVectors(n,d).add(r).clone(),T["back,bottom,right"]=o.addVectors(i,d).add(r).clone(),T["front,bottom,left"]=o.addVectors(n,d).add(h).clone(),T["back,bottom,left"]=o.addVectors(i,d).add(h).clone());var d=T[e].clone().normalize(),c=a,h=d.clone().negate();if(1-Math.abs(h.dot(a))<1e-5)for(var e=this.getView().normalize(),u=[l.clone(),l.clone().negate(),s.clone(),s.clone().negate()],f=0<h.dot(a)?1:-1,p=e.clone().add(y.camera.up.clone().multiplyScalar(f)).normalize(),m=-2,g=0;g<4;g++){var v=p.dot(u[g]);m<v&&(m=v,c=u[g].multiplyScalar(f))}return{dir:d.clone(),up:c.clone()}},this.getOrientation=function(){var e=ye.round1(c.up.x),t=ye.round1(c.up.y),n=ye.round1(c.up.z),i=new THREE.Vector3(0,0,-1),r=new THREE.Vector3(0,1,0),o=i.clone().cross(r).normalize();i.x=ye.round1(i.x),i.y=ye.round1(i.y),i.z=ye.round1(i.z),r.x=ye.round1(r.x),r.y=ye.round1(r.y),r.z=ye.round1(r.z),o.x=ye.round1(o.x),o.y=ye.round1(o.y),o.z=ye.round1(o.z);var a=o.clone().multiplyScalar(-1),s=r.clone().multiplyScalar(-1),l=i.clone().multiplyScalar(-1);switch(y.currentFace){case"front":if(r.x==e&&r.y==t&&r.z==n)return"up";if(s.x==e&&s.y==t&&s.z==n)return"down";if(o.x==e&&o.y==t&&o.z==n)return"right";if(a.x==e&&a.y==t&&a.z==n)return"left";break;case"right":if(r.x==e&&r.y==t&&r.z==n)return"up";if(s.x==e&&s.y==t&&s.z==n)return"down";if(l.x==e&&l.y==t&&l.z==n)return"left";if(i.x==e&&i.y==t&&i.z==n)return"right";break;case"left":if(r.x==e&&r.y==t&&r.z==n)return"up";if(s.x==e&&s.y==t&&s.z==n)return"down";if(i.x==e&&i.y==t&&i.z==n)return"left";if(l.x==e&&l.y==t&&l.z==n)return"right";break;case"back":if(r.x==e&&r.y==t&&r.z==n)return"up";if(s.x==e&&s.y==t&&s.z==n)return"down";if(a.x==e&&a.y==t&&a.z==n)return"right";if(o.x==e&&o.y==t&&o.z==n)return"left";break;case"top":if(l.x==e&&l.y==t&&l.z==n)return"down";if(i.x==e&&i.y==t&&i.z==n)return"up";if(o.x==e&&o.y==t&&o.z==n)return"right";if(a.x==e&&a.y==t&&a.z==n)return"left";break;case"bottom":if(i.x==e&&i.y==t&&i.z==n)return"down";if(l.x==e&&l.y==t&&l.z==n)return"up";if(o.x==e&&o.y==t&&o.z==n)return"right";if(a.x==e&&a.y==t&&a.z==n)return"left"}};var oe=function(e){if(ye.isMobileDevice()&&y.processMouseMove({type:"noIntersect"}),e.preventDefault(),e.stopPropagation(),d.isSmoothTranslationDone()){var t=te(e,y);L=W(u);var n=K(t,L),i=J(n,y.camera,h),r=J(n,b,D),o=J(n,b,H),t=y.isFaceView();if(0<i.length&&(l=i[0].object.name,a=y.viewer.getModelOperationMode(),n=y.viewer.getModelOperationVerticalRotationRange(),"FirstPerson"==a?"top"!=l&&"bottom"!=l&&(y.mouseMoveSave=e,y.cubeRotateTo(l)):"hall"==a?(i=!0,"bottom"==l&&n.x<90&&(i=!1),("bottom,front"==l||"bottom,right"==l||"bottom,left"==l||"bottom,back"==l||"front,bottom,right"==l||"back,bottom,right"==l||"front,bottom,left"==l||"back,bottom,left"==l)&&n.x<45&&(i=!1),("top,front"==l||"top,right"==l||"top,left"==l||"top,back"==l||"front,top,right"==l||"back,top,right"==l||"front,top,left"==l||"back,top,left"==l)&&n.y<45&&(i=!1),(i="top"==l&&n.y<90?!1:i)&&(y.mouseMoveSave=e,y.cubeRotateTo(l))):(y.mouseMoveSave=e,y.cubeRotateTo(l))),0<r.length&&t){var a,s=y.getOrientation(),l=y.currentFace;switch(y.currentFace){case"front":switch(s){case"up":r[0].object===D[0]?y.currentFace="top":r[0].object===D[1]?y.currentFace="bottom":r[0].object===D[2]?y.currentFace="right":r[0].object===D[3]&&(y.currentFace="left");break;case"right":r[0].object===D[0]?y.currentFace="right":r[0].object===D[1]?y.currentFace="left":r[0].object===D[2]?y.currentFace="bottom":r[0].object===D[3]&&(y.currentFace="top");break;case"down":r[0].object===D[0]?y.currentFace="bottom":r[0].object===D[1]?y.currentFace="top":r[0].object===D[2]?y.currentFace="left":r[0].object===D[3]&&(y.currentFace="right");break;case"left":r[0].object===D[0]?y.currentFace="left":r[0].object===D[1]?y.currentFace="right":r[0].object===D[2]?y.currentFace="top":r[0].object===D[3]&&(y.currentFace="bottom")}break;case"right":switch(s){case"up":r[0].object===D[0]?y.currentFace="top":r[0].object===D[1]?y.currentFace="bottom":r[0].object===D[2]?y.currentFace="back":r[0].object===D[3]&&(y.currentFace="front");break;case"right":r[0].object===D[0]?y.currentFace="back":r[0].object===D[1]?y.currentFace="front":r[0].object===D[2]?y.currentFace="bottom":r[0].object===D[3]&&(y.currentFace="top");break;case"down":r[0].object===D[0]?y.currentFace="bottom":r[0].object===D[1]?y.currentFace="top":r[0].object===D[2]?y.currentFace="front":r[0].object===D[3]&&(y.currentFace="back");break;case"left":r[0].object===D[0]?y.currentFace="front":r[0].object===D[1]?y.currentFace="back":r[0].object===D[2]?y.currentFace="top":r[0].object===D[3]&&(y.currentFace="bottom")}break;case"left":switch(s){case"up":r[0].object===D[0]?y.currentFace="top":r[0].object===D[1]?y.currentFace="bottom":r[0].object===D[2]?y.currentFace="front":r[0].object===D[3]&&(y.currentFace="back");break;case"right":r[0].object===D[0]?y.currentFace="front":r[0].object===D[1]?y.currentFace="back":r[0].object===D[2]?y.currentFace="bottom":r[0].object===D[3]&&(y.currentFace="top");break;case"down":r[0].object===D[0]?y.currentFace="bottom":r[0].object===D[1]?y.currentFace="top":r[0].object===D[2]?y.currentFace="back":r[0].object===D[3]&&(y.currentFace="front");break;case"left":r[0].object===D[0]?y.currentFace="back":r[0].object===D[1]?y.currentFace="front":r[0].object===D[2]?y.currentFace="top":r[0].object===D[3]&&(y.currentFace="bottom")}break;case"back":switch(s){case"up":r[0].object===D[0]?y.currentFace="top":r[0].object===D[1]?y.currentFace="bottom":r[0].object===D[2]?y.currentFace="left":r[0].object===D[3]&&(y.currentFace="right");break;case"right":r[0].object===D[0]?y.currentFace="left":r[0].object===D[1]?y.currentFace="right":r[0].object===D[2]?y.currentFace="bottom":r[0].object===D[3]&&(y.currentFace="top");break;case"down":r[0].object===D[0]?y.currentFace="bottom":r[0].object===D[1]?y.currentFace="top":r[0].object===D[2]?y.currentFace="right":r[0].object===D[3]&&(y.currentFace="left");break;case"left":r[0].object===D[0]?y.currentFace="right":r[0].object===D[1]?y.currentFace="left":r[0].object===D[2]?y.currentFace="top":r[0].object===D[3]&&(y.currentFace="bottom")}break;case"top":switch(s){case"up":r[0].object===D[0]?y.currentFace="back":r[0].object===D[1]?y.currentFace="front":r[0].object===D[2]?y.currentFace="right":r[0].object===D[3]&&(y.currentFace="left");break;case"right":r[0].object===D[0]?y.currentFace="right":r[0].object===D[1]?y.currentFace="left":r[0].object===D[2]?y.currentFace="front":r[0].object===D[3]&&(y.currentFace="back");break;case"down":r[0].object===D[0]?y.currentFace="front":r[0].object===D[1]?y.currentFace="back":r[0].object===D[2]?y.currentFace="left":r[0].object===D[3]&&(y.currentFace="right");break;case"left":r[0].object===D[0]?y.currentFace="left":r[0].object===D[1]?y.currentFace="right":r[0].object===D[2]?y.currentFace="back":r[0].object===D[3]&&(y.currentFace="front")}break;case"bottom":switch(s){case"up":r[0].object===D[0]?y.currentFace="front":r[0].object===D[1]?y.currentFace="back":r[0].object===D[2]?y.currentFace="right":r[0].object===D[3]&&(y.currentFace="left");break;case"right":r[0].object===D[0]?y.currentFace="right":r[0].object===D[1]?y.currentFace="left":r[0].object===D[2]?y.currentFace="back":r[0].object===D[3]&&(y.currentFace="front");break;case"down":r[0].object===D[0]?y.currentFace="back":r[0].object===D[1]?y.currentFace="front":r[0].object===D[2]?y.currentFace="left":r[0].object===D[3]&&(y.currentFace="right");break;case"left":r[0].object===D[0]?y.currentFace="left":r[0].object===D[1]?y.currentFace="right":r[0].object===D[2]?y.currentFace="front":r[0].object===D[3]&&(y.currentFace="back")}}"hall"!=(a=y.viewer.getModelOperationMode())&&"FirstPerson"!=a||"top"!=y.currentFace&&"bottom"!=y.currentFace?y.cubeRotateTo(y.currentFace):y.currentFace=l}("normal"==(a=y.viewer.getModelOperationMode())||"bim"==a)&&0<o.length&&t&&(!y.wantRollArrows||o[0].object!==H[R]&&o[0].object!==H[O]||(a=o[0].object===H[O],t={center:y.center.clone(),position:y.camera.position.clone(),worldUp:new THREE.Vector3(0,1,0)},o=y.center.clone().sub(y.camera.position).normalize(),a?t.up=y.camera.up.clone().cross(o):(t.up=y.camera.up.clone().multiplyScalar(-1),t.up.cross(o)),t.up.normalize(),t={from:t.position.toArray(),to:t.center.toArray(),up:t.up.toArray(),animationSpeed:1e3},d.look(t))),ie(!1)}else ie(!1)};this.cubeRotateTo=function(e){y.currentFace=e;var t=y.getDestByFace(e),n=y.center.clone().sub(t.dir);n.normalize();e=t.up.clone(),t=null;ye.isMobileDevice()||(t=function(){y.mouseMoveSave&&y.processMouseMove(y.mouseMoveSave)});t={from:n.toArray(),to:y.center.toArray(),up:e.toArray(),callback:t,sphericalTransition:!0};d.look(t)},this.processMouseMove=function(e){var t,n,i;if(d.isSmoothTranslationDone()){if(y.mouseMoveSave=null,i=ye.isMobileDevice()&&"noIntersect"==e.type?(t=[],n=[],[]):(i=te(e,y),i=K(i,L),t=J(i,y.camera,s),n=J(i,b,D),J(i,b,H)),l&&!U&&(l.material.color.setHex(14540253),l=null,requestAnimationFrame(y.render)),0<n.length&&!U){l=n[0].object;for(var r=A.children.length;0<=--r;)if(l===D[r]){(l=A.children[r]).material.color.setHex(45055);break}requestAnimationFrame(y.render)}N&&!U&&(N.material.opacity=0,N=null,requestAnimationFrame(y.render)),0<t.length&&!U&&((N=t[0].object).material.opacity=.3,requestAnimationFrame(y.render)),0<i.length&&!U?F!==i[0].object&&(y.wantHomeButton&&i[0].object===H[C]?(F=i[0].object,H[C].material.map=G[0]):y.wantRollArrows&&i[0].object===H[R]?(F=i[0].object,H[P].material.map=G[1]):y.wantRollArrows&&i[0].object===H[O]?(F=i[0].object,H[P].material.map=G[2]):y.wantContextMenu&&i[0].object===H[B]?(F=i[0].object,H[B].material.map=G[6]):y.wantHomeButton&&F===H[C]?(F=null,H[C].material.map=G[3]):!y.wantRollArrows||F!==H[R]&&F!==H[O]&&F!==H[P]?y.wantContextMenu&&F===H[B]&&(F=null,H[B].material.map=G[5]):(F=null,H[P].material.map=G[4]),requestAnimationFrame(y.render)):null===F||U||(y.wantHomeButton&&F===H[C]?(F=null,H[C].material.map=G[3]):!y.wantRollArrows||F!==H[R]&&F!==H[O]&&F!==H[P]?y.wantContextMenu&&F===H[B]&&(F=null,H[B].material.map=G[5]):(F=null,H[P].material.map=G[4]),requestAnimationFrame(y.render))}};function ae(){L=W(u),y.width=u.offsetWidth,y.height=u.offsetHeight,y.width,y.height,y.camera.aspect=y.width/y.height,y.camera.updateProjectionMatrix(),y.camera.topFov=y.camera.bottomFov=y.camera.fov/2,y.camera.leftFov=y.camera.rightFov=y.camera.aspect*y.camera.fov/2,y.renderer&&(y.renderer.setSize(y.width,y.height),y.render())}var se=function(e){L=W(u),y.processMouseMove(e)},le=function(e,t){var n=.3*_,i=.225*_+n,r=new THREE.Geometry,o=new THREE.Vector3(0,0,0),a=new THREE.Vector3(n,-n,i),s=new THREE.Vector3(n,n,i),l=new THREE.Vector3(-n,n,i),i=new THREE.Vector3(-n,-n,i);return r.vertices.push(o),r.vertices.push(a),r.vertices.push(s),r.vertices.push(l),r.vertices.push(i),r.faces.push(new THREE.Face3(1,2,3)),r.faces.push(new THREE.Face3(1,3,4)),r.applyMatrix((new THREE.Matrix4).makeRotationX(e)),r.applyMatrix((new THREE.Matrix4).makeRotationY(t)),r.computeFaceNormals(),r.computeVertexNormals(),t=new THREE.MeshBasicMaterial({overdraw:!0,opacity:0,color:45055,transparent:!0}),new THREE.Mesh(r,t)},de=function(e,t,n){var i=.3*_,r=.225*_+i,o=new THREE.Geometry,a=new THREE.Vector3(i,r,r),s=new THREE.Vector3(-i,r,r),l=new THREE.Vector3(-i,i,r),d=new THREE.Vector3(i,i,r),c=new THREE.Vector3(i,r,i),h=new THREE.Vector3(-i,r,i),u=new THREE.Vector3(-i,r,r),r=new THREE.Vector3(i,r,r);return o.vertices.push(a),o.vertices.push(s),o.vertices.push(l),o.vertices.push(d),o.vertices.push(c),o.vertices.push(h),o.vertices.push(u),o.vertices.push(r),o.faces.push(new THREE.Face3(0,1,2)),o.faces.push(new THREE.Face3(0,2,3)),o.faces.push(new THREE.Face3(4,5,6)),o.faces.push(new THREE.Face3(4,6,7)),o.applyMatrix((new THREE.Matrix4).makeRotationX(e)),o.applyMatrix((new THREE.Matrix4).makeRotationY(t)),o.applyMatrix((new THREE.Matrix4).makeRotationZ(n)),o.computeFaceNormals(),o.computeVertexNormals(),n=new THREE.MeshBasicMaterial({overdraw:!0,opacity:0,color:45055,transparent:!0}),new THREE.Mesh(o,n)},ce=function(e,t){var n=.3*_,i=.225*_+n,r=new THREE.Geometry,o=new THREE.Vector3(i,i,i),a=new THREE.Vector3(n,i,i),s=new THREE.Vector3(n,n,i),l=new THREE.Vector3(i,n,i),d=new THREE.Vector3(i,i,n),c=new THREE.Vector3(i,i,i),h=new THREE.Vector3(i,n,i),u=new THREE.Vector3(i,n,n),f=new THREE.Vector3(i,i,i),p=new THREE.Vector3(i,i,n),m=new THREE.Vector3(n,i,n),i=new THREE.Vector3(n,i,i);return r.vertices.push(o),r.vertices.push(a),r.vertices.push(s),r.vertices.push(l),r.vertices.push(d),r.vertices.push(c),r.vertices.push(h),r.vertices.push(u),r.vertices.push(f),r.vertices.push(p),r.vertices.push(m),r.vertices.push(i),r.faces.push(new THREE.Face3(0,1,2)),r.faces.push(new THREE.Face3(0,2,3)),r.faces.push(new THREE.Face3(4,5,6)),r.faces.push(new THREE.Face3(4,6,7)),r.faces.push(new THREE.Face3(8,9,10)),r.faces.push(new THREE.Face3(8,10,11)),r.applyMatrix((new THREE.Matrix4).makeRotationX(e)),r.applyMatrix((new THREE.Matrix4).makeRotationY(t)),r.computeFaceNormals(),r.computeVertexNormals(),t=new THREE.MeshBasicMaterial({overdraw:!0,opacity:0,color:45055,transparent:!0}),new THREE.Mesh(r,t)};this.render=function(){he();var e=y.renderer;e&&(e.clear(),e.render(p,y.camera),e.render(m,y.camera),e.render(v,y.camera),e.render(g,y.camera),e.render(E,b))},this.isFaceView=function(){var e=!1,t=new THREE.Vector3(0,-1,0),n=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,-1),r=new THREE.Vector3(0,0,1),o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(-1,0,0),s=new THREE.Vector3;return s.subVectors(y.center,y.camera.position),s.normalize(),e=s.equals(t)||s.equals(n)||s.equals(i)||s.equals(r)||s.equals(o)||s.equals(a)?!0:e};var he=function(){k=y.isFaceView(),(ye.isMobileDevice()?k&&d.isSmoothTranslationDone()?fe:ue:k&&!z&&d.isSmoothTranslationDone()?fe:ue)(),(z?pe:me)(),(z?ge:ve)()},ue=function(){E.remove(A),H[P].material.opacity=0,H[B].material.opacity=0},fe=function(){E.add(A);var e=y.wantRollArrows?1:0;H[P].material.opacity=e,H[B].material.opacity=e;e=y.viewer.getModelOperationMode();"hall"==e||"FirstPerson"==e?(H[P].material.opacity=0,f.up.visible=!1,f.down.visible=!1):(f.up.visible=!0,f.down.visible=!0)},pe=function(){S.material.opacity=0},me=function(){S.material.opacity=y.wantContextMenu?1:0},ge=function(){w.material.opacity=0},ve=function(){w.material.opacity=y.wantHomeButton?1:0};this.refreshCube=function(){ae()},this.setSize=function(e,t){if(y.width=e,y.height=t,1<u.children.length)for(var n=1;n<u.children.length;n++)u.children[n].style.bottom=(y.height/5).toString()+"px";ae()},this.useTransparency=function(e){(z=e)?(u.onmouseover=Z,u.onmousemove=q,u.onmouseout=Q,Q()):(u.onmouseover=null,u.onmouseout=null,u.onmousemove=null,u.style.opacity="1.0")},this.dtor=function(){this.renderer=null},this.updateCurrentFace=function(e){var t=new THREE.Vector3(0,-1,0),n=new THREE.Vector3(0,1,0),i=(new THREE.Vector3(0,0,-1),new THREE.Vector3(0,0,1)),r=new THREE.Vector3(1,0,0),o=new THREE.Vector3(-1,0,0);e||((e=new THREE.Vector3).subVectors(y.center,y.camera.position),e.normalize()),e.equals(t)?y.currentFace="top":e.equals(n)?y.currentFace="bottom":e.equals(r)?y.currentFace="left":e.equals(o)?y.currentFace="right":e.equals(i)?y.currentFace="back":y.currentFace="front"},this.enableViewBox=function(e){e?(u.addEventListener("touchstart",re,!1),u.addEventListener("mousedown",re,!1),u.addEventListener("mousemove",se,!1),u.onmouseover=Z,u.onmousemove=q,u.onmouseout=Q):(u.removeEventListener("touchstart",re,!1),u.removeEventListener("mousedown",re,!1),u.removeEventListener("mousemove",se,!1),u.onmouseover=null,u.onmousemove=null,u.onmouseout=null)},function(){var e=u.getBoundingClientRect();y.width=e.width,y.height=e.height,L=W(u),y.width,y.height;var t=1;0!=y.width&&0!=y.height&&(t=y.height/y.width),(b=new THREE.PerspectiveCamera(70,t,1,1e4)).position.set(0,0,500),p=new THREE.Scene,m=new THREE.Scene,g=new THREE.Scene,v=new THREE.Scene,E=new THREE.Scene,k=!0,_=y.boxSize,y.viewScale=700,(h=new THREE.Vector3(1,1,1)).normalize(),h.multiplyScalar(y.viewScale),y.camera.position.copy(h),y.center=new THREE.Vector3(0,0,0),y.camera.up.set(0,1,0),y.camera.lookAt(y.center),y.originCamInfo.position=h,y.originCamInfo.center=y.center.clone(),y.originCamInfo.up=new THREE.Vector3(0,1,0);var n=THREE.LinearFilter,i="./img/viewbox/",r=i+(ye.getLanguage()+"/"),o=".png",a=[r+"left"+o,r+"right"+o,r+"up"+o,r+"down"+o,r+"front"+o,r+"back"+o],s=(new THREE.CubeTextureLoader).load(a);s.format=THREE.RGBFormat,s.minFilter=s.maxFilter=n;var l=THREE.ShaderLib.cube,d=new THREE.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:THREE.UniformsUtils.clone(l.uniforms),depthWrite:!1});d.uniforms.tCube.value=s;var c=new THREE.BoxGeometry(_,_,_,4,4,4),e=new THREE.BoxGeometry(_+1,_+1,_+1,4,4,4);(M=new THREE.Mesh(c,d)).position.set(0,0,0),m.add(M);t=$(X(i+"VCedge1.png"));t.minFilter=t.maxFilter=n,(x=new THREE.Mesh(e,new THREE.MeshBasicMaterial({map:t,overdraw:!1,transparent:!0,flatShading:!1}))).position.set(0,0,0),v.add(x);var h=_,r=new THREE.Geometry,o=new THREE.Vector3(-30,0,0),a=new THREE.Vector3(30,0,0),l=new THREE.Vector3(0,-30,0);r.vertices.push(o),r.vertices.push(a),r.vertices.push(l),r.faces.push(new THREE.Face3(1,0,2)),r.computeFaceNormals();s=new THREE.MeshBasicMaterial({overdraw:!0,color:14540253,transparent:!1,opacity:1,flatShading:!0}),c=new THREE.MeshBasicMaterial({overdraw:!0,color:14540253,transparent:!1,opacity:1,flatShading:!0}),d=new THREE.MeshBasicMaterial({overdraw:!0,color:14540253,transparent:!1,opacity:1,flatShading:!0}),n=new THREE.MeshBasicMaterial({overdraw:!0,color:14540253,transparent:!1,opacity:1,flatShading:!0}),e=new THREE.PlaneBufferGeometry(.5*_,.3*_,2,2),t=new THREE.MeshBasicMaterial({transparent:!0,opacity:0});f.up=s;o=new THREE.Mesh(r,s),a=new THREE.Mesh(e,t);o.position.set(0,h,0),a.position.set(0,.9*h,.1),f.down=c;l=new THREE.Mesh(r,c),s=new THREE.Mesh(e,t);l.position.set(0,-h,0),s.position.set(0,.9*-h,.1),l.rotation.z+=Math.PI,s.rotation.z+=Math.PI,f.right=d;c=new THREE.Mesh(r,d),d=new THREE.Mesh(e,t);c.position.set(h,0,0),d.position.set(.9*h,0,.1),c.rotation.z-=Math.PI/2,d.rotation.z-=Math.PI/2,f.left=n;n=new THREE.Mesh(r,n),t=new THREE.Mesh(e,t);n.position.set(-h,0,0),t.position.set(.9*-h,0,.1),n.rotation.z+=Math.PI/2,t.rotation.z+=Math.PI/2,(A=new THREE.Object3D).position.set(0,0,0),A.add(o),A.add(l),A.add(c),A.add(n),E.add(a),E.add(s),E.add(d),E.add(t),E.add(A),D.push(a),D.push(s),D.push(d),D.push(t);a=new THREE.PlaneBufferGeometry(_/2,_/2,2,2),s=new THREE.MeshBasicMaterial({map:$(X(i+"VChome.png")),transparent:!0,flatShading:!0});(w=new THREE.Mesh(a,s)).position.set(1.4*-_,1.4*_,0),C=H.length,E.add(w),H.push(w);d=new THREE.PlaneBufferGeometry(1.5*_,1.5*_,2,2),t=new THREE.MeshBasicMaterial({map:$(X(i+"VCarrows.png")),flatShading:!0,transparent:!0}),a=new THREE.Mesh(d,t);a.position.set(.5*_+20,.5*_+20,0);s=new THREE.PlaneBufferGeometry(.6*_,.45*_,2,2),d=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),t=new THREE.Mesh(s,d);t.position.set(.5*_+20,_+20,.1);s=new THREE.PlaneBufferGeometry(.45*_,.6*_,2,2),d=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),d=new THREE.Mesh(s,d);d.position.set(_+20,.5*_+20,.1),E.add(a),E.add(t),E.add(d),R=H.length,H.push(t),O=H.length,H.push(d),P=H.length,H.push(a);d=new THREE.PlaneBufferGeometry(_/2.3,_/2.3,2,2),a=new THREE.MeshBasicMaterial({map:$(X(i+"VCcontext.png")),transparent:!0,flatShading:!0});(S=new THREE.Mesh(d,a)).position.set(_,-_,0),B=H.length,E.add(S),H.push(S);d=new THREE.Geometry;d.vertices.push(new THREE.Vector3(0,0,0)),d.vertices.push(new THREE.Vector3(-_/2,-_/2-20,-_/2)),d.vertices.push(new THREE.Vector3(_/2,-_/2-20,-_/2)),d.vertices.push(new THREE.Vector3(_/2,-_/2-20,_/2)),d.vertices.push(new THREE.Vector3(-_/2,-_/2-20,_/2)),d.faces.push(new THREE.Face3(4,3,2)),d.faces.push(new THREE.Face3(4,2,1)),a=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5}),I=new THREE.Mesh(d,a),p.add(I),ee(),y.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!1}),y.useTransparency(!0),y.setSize(y.width,y.height),y.camera.topFov=y.camera.bottomFov=y.camera.fov/2,y.camera.leftFov=y.camera.rightFov=y.camera.aspect*y.camera.fov/2,y.renderer.autoClear=!1,y.renderer.setSize(y.width,y.height),y.renderer.sortObjects=!1,u.appendChild(y.renderer.domElement),u.addEventListener("touchstart",re,!1),u.addEventListener("mousedown",re,!1),u.addEventListener("mousemove",se,!1),(V=!1)&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,u.requestPointerLock=u.requestPointerLock||u.mozRequestPointerLock||u.webkitRequestPointerLock,document.addEventListener("pointerlockchange",Y,!1),document.addEventListener("mozpointerlockchange",Y,!1),document.addEventListener("webkitpointerlockchange",Y,!1)),G.push($(X(i+"VChomeS.png"))),G.push($(X(i+"VCarrowsS0.png"))),G.push($(X(i+"VCarrowsS1.png"))),G.push($(X(i+"VChome.png"))),G.push($(X(i+"VCarrows.png"))),G.push($(X(i+"VCcontext.png"))),G.push($(X(i+"VCcontextS.png")))}()},be=function(o,a){THREE.Object3D.call(this);var e=new THREE.Geometry,t=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));t.position.y=.5,t.updateMatrix(),e.merge(t.geometry,t.matrix);var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3));t={};t.X=[[new THREE.Mesh(e,new y({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(n,new E({color:16711680}))]],t.Y=[[new THREE.Mesh(e,new y({color:65280})),[0,.5,0]],[new THREE.Line(i,new E({color:65280}))]],t.Z=[[new THREE.Mesh(e,new y({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(r,new E({color:255}))]];e=new y({visible:!1,transparent:!1}),r={};r.X=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),e),[.6,0,0],[0,0,-Math.PI/2]]],r.Y=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),e),[0,.6,0]]],r.Z=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),e),[0,0,.6],[Math.PI/2,0,0]]],this.axes=new THREE.Object3D,this.pickers=new THREE.Object3D;e=function(e,t){for(var n in e)for(var i=e[n].length;i--;){var r=e[n][i][0],o=e[n][i][1],a=e[n][i][2];r.name=n,o&&r.position.set(o[0],o[1],o[2]),a&&r.rotation.set(a[0],a[1],a[2]),t.add(r)}};e(t,this.axes),e(r,this.pickers),this.add(this.axes),this.add(this.pickers);var s=this,r=void 0!==a?a:document;this.size=1,this.type="CoordSystem",this.pickedAxis=null,this.axis=null,this.parentNode=void 0,this.visible=!1;var l=new THREE.Raycaster,d=new THREE.Vector2,c=new THREE.Vector3,h=new THREE.Quaternion,u=new THREE.Vector3;new THREE.Vector3;function f(e){var t,n;s.visible&&(Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===s.parentNode||void 0!==e.button&&0!==e.button||(0!==(t=e.changedTouches?e.changedTouches[0]:e).button&&void 0!==t.button||(n=null,(n=v(t,s.pickers.children))?(e.preventDefault(),e.stopPropagation(),s.axis=n.object.name,s.update()):s.axis=null)))}function p(e){}function m(e){}function g(e){var t,n;s.visible&&(Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===s.parentNode||void 0!==e.button&&0!==e.button||(n=t=null,(t=v(e.changedTouches?e.changedTouches[0]:e,s.pickers.children))&&(n=t.object.name,e.preventDefault()),s.pickedAxis!==n&&(s.pickedAxis=n,s.update())))}function v(e,t){var n=a.getBoundingClientRect(),i=n.width,r=n.height;null!=a.clientWidth&&null!=a.clientHeight&&(10<Math.abs(i-a.clientWidth)&&(i=a.clientWidth),10<Math.abs(r-a.clientHeight)&&(r=a.clientHeight));i=(e.clientX-n.left)/i,r=(e.clientY-n.top)/r;d.set(2*i-1,-2*r+1),o.setCastRay(l,d.x,d.y);t=l.intersectObjects(t,!0);return t[0]||!1}ye.isMobileDevice()?(r.addEventListener("touchstart",f,!1),r.addEventListener("touchmove",g,!1),r.addEventListener("touchmove",m,!0),r.addEventListener("touchend",p,!1),r.addEventListener("touchcancel",p,!1)):(r.addEventListener("mousedown",f,!1),r.addEventListener("mousemove",g,!1),r.addEventListener("mousemove",m,!0),r.addEventListener("mouseup",p,!1)),this.dispose=function(){ye.isMobileDevice()?(a.removeEventListener("touchstart",f),a.removeEventListener("touchmove",g),a.removeEventListener("touchmove",m),a.removeEventListener("touchend",p),a.removeEventListener("touchcancel",p)):(a.removeEventListener("mousedown",f),a.removeEventListener("mousemove",g),a.removeEventListener("mousemove",m),a.removeEventListener("mouseup",p))},this.isSelected=function(){return null!=this.axis},this.attach=function(e){this.parentNode=e,this.visible=!0,this.name=e.uuid,this.update()},this.detach=function(){this.parentNode=void 0,this.visible=!1,this.pickedAxis=null,this.axis=null},this.setSize=function(e){s.size=e,this.update()},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})},this.axisVisible=function(t,n){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===n&&t?e.visible=!0:e.visible=!1)})},this.getAxisVisible=function(t){var n=!1;return this.traverse(function(e){e.material&&e.material.highlight&&e.name===t&&(n=e.visible)}),n},this.update=function(){if(void 0!==s.parentNode){s.visible=s.parentNode.visible;var e=s.parentNode.getModel();if("explodeObject"==s.name){var t=e.viewer.controls.getBoundingBox();t||renturn;var n=t.getCenter();if(!n)return;c=n.clone()}else{if(!s.parentNode.worldMatrix)return;s.parentNode.worldMatrix.decompose(c,h,u)}o.updateMatrix();var i=o.getCameraTarget(),t=o.position,n=new THREE.Vector3;n.subVectors(i,t);i=c.clone(),t=o.isPerspective?i.sub(t).dot(n.normalize()):1.2*n.length(),n=o.fov,t=2*t*Math.tan(THREE.Math.degToRad(.5*n)),n=e.viewer.renderer.domElement.height,n=70*t*e.viewer.renderer.getPixelRatio()/n;ye.isMobileDevice()&&(n*=3),n*=s.size,s.position.copy(c),s.quaternion.copy(h),s.scale.set(n,n,n),s.updateMatrixWorld(!0),this.highlight(s.axis)}}};be.prototype=Object.create(THREE.Object3D.prototype),be.prototype.constructor=be;function a(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.renderToColor=!1}var Me={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},xe={uniforms:{tDiffuse:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + RESOLUTION*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + RESOLUTION*(Y))","#endif","#define BLUR_RADIUS (3.0 * SIGMA + 0.5)","#define SIGMASQ2 (2.0 * SIGMA * SIGMA)","#define GAUSS_EXP(X) ( exp(-(X)*(X)/SIGMASQ2) )","void main() {","vec4 sum = vec4( 0.0 );","float total = 0.0;","for (float x=-BLUR_RADIUS; x<=BLUR_RADIUS; x+=1.0) {","float ratio = GAUSS_EXP(x);","sum += texture2D(tDiffuse, GET_UV(x)) * ratio;","total += ratio;","}","sum /= total;","gl_FragColor = sum;","}"].join("\n")},we={uniforms:{tDiffuse:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + RESOLUTION*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + RESOLUTION*(Y))","#endif","void main() {","vec4 sum = texture2D(tDiffuse, GET_UV(0.0));","#if BLUR_LEVEL == 1","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.882496903;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.882496903;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.60653066;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.60653066;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.324652467;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.324652467;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.135335283;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.135335283;","sum *= 0.204163689;","#elif BLUR_LEVEL == 2","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.960005441;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.960005441;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.849365817;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.849365817;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.692569324;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.692569324;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.520450121;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.520450121;","sum += texture2D(tDiffuse, GET_UV(-5.0)) * 0.360447789;","sum += texture2D(tDiffuse, GET_UV(5.0)) * 0.360447789;","sum += texture2D(tDiffuse, GET_UV(-6.0)) * 0.230066299;","sum += texture2D(tDiffuse, GET_UV(6.0)) * 0.230066299;","sum += texture2D(tDiffuse, GET_UV(-7.0)) * 0.135335283;","sum += texture2D(tDiffuse, GET_UV(7.0)) * 0.135335283;","sum *= 0.117695797;","#elif BLUR_LEVEL == 3","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.988235431;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.988235431;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.953765659;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.953765659;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.898967069;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.898967069;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.827497567;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.827497567;","sum += texture2D(tDiffuse, GET_UV(-5.0)) * 0.743893062;","sum += texture2D(tDiffuse, GET_UV(5.0)) * 0.743893062;","sum += texture2D(tDiffuse, GET_UV(-6.0)) * 0.653093155;","sum += texture2D(tDiffuse, GET_UV(6.0)) * 0.653093155;","sum += texture2D(tDiffuse, GET_UV(-7.0)) * 0.559964631;","sum += texture2D(tDiffuse, GET_UV(7.0)) * 0.559964631;","sum += texture2D(tDiffuse, GET_UV(-8.0)) * 0.468885606;","sum += texture2D(tDiffuse, GET_UV(8.0)) * 0.468885606;","sum += texture2D(tDiffuse, GET_UV(-9.0)) * 0.383437025;","sum += texture2D(tDiffuse, GET_UV(9.0)) * 0.383437025;","sum += texture2D(tDiffuse, GET_UV(-10.0)) * 0.30622598;","sum += texture2D(tDiffuse, GET_UV(10.0)) * 0.30622598;","sum += texture2D(tDiffuse, GET_UV(-11.0)) * 0.238842089;","sum += texture2D(tDiffuse, GET_UV(11.0)) * 0.238842089;","sum *= 0.06646455;","#endif","gl_FragColor = sum;","}"].join("\n")},Ie=(["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),["uniform sampler2D tDiffuse;","varying vec2 vUv;","#define repeats 40.0","vec3 texture(vec2 uv) {","return texture2D(tDiffuse,uv).rgb;","}","float grid(float var, float size) {","return floor(var*size)/size;","}","float rand(vec2 co){","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","vec3 blurred_image = vec3(0.0);","for(float i=0.0;i<repeats;i++){","vec2 q = vec2(cos(degrees((i/repeats)*360.0)),sin(degrees((i/repeats)*360.0))) *  (rand(vec2(i,vUv.x+vUv.y))+BLUR_AMOUNT);","vec2 uv2 = vUv+(q*BLUR_AMOUNT);","blurred_image += texture(uv2)/2.0;","q = vec2(cos(degrees((i/repeats)*360.0)),sin(degrees((i/repeats)*360.0))) *  (rand(vec2(i+2.,vUv.x+vUv.y+24.0))+BLUR_AMOUNT);","uv2 = vUv+(q*BLUR_AMOUNT);","blurred_image += texture(uv2)/2.0;","}","blurred_image /= repeats;","gl_FragColor = vec4(blurred_image,1.0);","}"].join("\n"),new THREE.Vector2(1/1024,1/512),["varying vec2 vUv;","void main() {","   vUv= uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_SPAN_MAX     8.0","#define FXAA_EDGE_THRESHOLD_MIN (1.0/24.0)","#define FXAA_EDGE_THRESHOLD (1.0/8.0)","#define FXAA_SEARCH_THRESHOLD (1.0/4.0)","#define FXAA_SEARCH_STEPS 16","#define FXAA_SUBPIX_TRIM (1.0/4.0)","#define FXAA_SUBPIX_TRIM_SCALE (1.0/(1.0 - FXAA_SUBPIX_TRIM))","#define FXAA_SUBPIX_CAP (3.0/4.0)","float FxaaLuma(vec3 rgb){","    return rgb.y*(0.587/0.299) + rgb.x;","}","vec3 FxaaLerp3(vec3 a, vec3 b, float amountOfA) {","   return (vec3(-amountOfA) * b) +","           ((a * vec3(amountOfA)) + b); }","void main() {","vec3 rgbN = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 0.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 0.0 ) ) * resolution ).xyz;","vec3 rgbW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 0.0 ) ) * resolution ).xyz;","vec3 rgbS = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 0.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float lumaN = FxaaLuma(rgbN);","float lumaE = FxaaLuma(rgbE);","float lumaW = FxaaLuma(rgbW);","float lumaS = FxaaLuma(rgbS);","float lumaM  = FxaaLuma(rgbM);","float lumaMin = min( lumaM, min( min( lumaN, lumaW ), min( lumaS, lumaE ) ) );","float lumaMax = max( lumaM, max( max( lumaN, lumaW) , max( lumaS, lumaE ) ) );","float range = lumaMax -lumaMin;","if(range< max(FXAA_EDGE_THRESHOLD_MIN, lumaMax * FXAA_EDGE_THRESHOLD)) {","   gl_FragColor = rgbaM; return;","}","vec3 rgbL = rgbN + rgbW + rgbM + rgbE + rgbS;","float lumaL = (lumaN + lumaW + lumaE + lumaS) * 0.25;","float rangeL = abs(lumaL - lumaM);","float blendL = max(0.0, (rangeL / range) - FXAA_SUBPIX_TRIM) * FXAA_SUBPIX_TRIM_SCALE;","blendL = min(FXAA_SUBPIX_CAP, blendL);","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","float opacity  = rgbaM.w;","rgbL += (rgbNW + rgbNE + rgbSW + rgbSE);","rgbL *= vec3(1.0/9.0);","float lumaNW = FxaaLuma( rgbNW);","float lumaNE = FxaaLuma( rgbNE);","float lumaSW = FxaaLuma( rgbSW);","float lumaSE = FxaaLuma( rgbSE);","float edgeVert = abs((0.25 * lumaNW) + (-0.5 * lumaN) + (0.25 * lumaNE)) +","                 abs((0.50 * lumaW ) + (-1.0 * lumaM) + (0.50 * lumaE )) +","                 abs((0.25 * lumaSW) + (-0.5 * lumaS) + (0.25 * lumaSE));","float edgeHorz = abs((0.25 * lumaNW) + (-0.5 * lumaW) + (0.25 * lumaSW)) +","                 abs((0.50 * lumaN ) + (-1.0 * lumaM) + (0.50 * lumaS )) +","                 abs((0.25 * lumaNE) + (-0.5 * lumaE) + (0.25 * lumaSE));","bool horzSpan = edgeHorz >= edgeVert;","float lengthSign = horzSpan ? -resolution.y : -resolution.x;","if(!horzSpan){","    lumaN = lumaW;","    lumaS = lumaE;","}","float gradientN = abs(lumaN - lumaM);","float gradientS = abs(lumaS - lumaM);","lumaN = (lumaN + lumaM) * 0.5;","lumaS = (lumaS + lumaM) * 0.5;","bool pairN = gradientN >= gradientS;","if(!pairN){","   lumaN = lumaS;","   gradientN = gradientS;","   lengthSign *= -1.0;","}","vec2 posN;","posN.x = vUv.x + (horzSpan ? 0.0 : lengthSign * 0.5);","posN.y = vUv.y + (horzSpan ? lengthSign * 0.5 : 0.0);","gradientN *= FXAA_SEARCH_THRESHOLD;","vec2 posP = posN;","vec2 offNP = horzSpan ? vec2(resolution.x, 0.0) : vec2(0.0, resolution.y);","float lumaEndN = lumaN;","float lumaEndP = lumaN;","bool doneN = false;","bool doneP = false;","posN += offNP * vec2(-1.0, -1.0);","posP += offNP * vec2( 1.0,  1.0);","for(int i = 0; i < FXAA_SEARCH_STEPS; i++) {","    if(!doneN) lumaEndN = FxaaLuma(texture2D( tDiffuse, posN.xy).xyz);","    if(!doneP) lumaEndP = FxaaLuma(texture2D( tDiffuse, posP.xy).xyz);","    doneN = doneN || (abs(lumaEndN - lumaN) >= gradientN);","    doneP = doneP || (abs(lumaEndP - lumaN) >= gradientN);","    if(doneN && doneP) break;","    if(!doneN) posN -= offNP;","    if(!doneP) posP += offNP;","}","float dstN = horzSpan ? vUv.x - posN.x : vUv.y - posN.y;","float dstP = horzSpan ? posP.x - vUv.x : posP.y - vUv.y;","bool directionN = dstN < dstP;","lumaEndN = directionN ? lumaEndN : lumaEndP;","if(((lumaM - lumaN) < 0.0) == ((lumaEndN - lumaN) < 0.0))","   lengthSign = 0.0;","float spanLength = (dstP + dstN);","dstN = directionN ? dstN : dstP;","float subPixelOffset = (0.5 + (dstN * (-1.0/spanLength))) * lengthSign;","vec3 rgbF = texture2D(tDiffuse, vec2(","               vUv.x + (horzSpan ? 0.0 : subPixelOffset),","               vUv.y + (horzSpan ? subPixelOffset : 0.0))).xyz;","gl_FragColor = vec4(FxaaLerp3(rgbL, rgbF, blendL), opacity);","}"].join("\n"),{uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")}),Se={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vPos;","varying vec4 vPosPos;","void main() {","vPos = uv;","vPosPos.xy = uv + vec2(-0.5, -0.5) * resolution;","vPosPos.zw = uv + vec2( 0.5,  0.5) * resolution;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define FXAA_EDGE_SHARPNESS (8.0)","#define FXAA_EDGE_THRESHOLD (0.125)","#define FXAA_EDGE_THRESHOLD_MIN (0.05)","#define FXAA_RCP_FRAME_OPT (0.50)","#define FXAA_RCP_FRAME_OPT2 (2.0)","uniform sampler2D tDiffuse;","uniform highp vec2 resolution;","varying vec2 vPos;","varying vec4 vPosPos;","float FxaaLuma(vec3 rgb) {","return dot(rgb, vec3(0.299, 0.587, 0.114));","}","void main() {","float lumaNw = FxaaLuma(texture2D(tDiffuse, vPosPos.xy).rgb);","float lumaSw = FxaaLuma(texture2D(tDiffuse, vPosPos.xw).rgb);","float lumaNe = FxaaLuma(texture2D(tDiffuse, vPosPos.zy).rgb) + 1.0/384.0;","float lumaSe = FxaaLuma(texture2D(tDiffuse, vPosPos.zw).rgb);","vec3 rgbM = texture2D(tDiffuse, vPos.xy).rgb;","float lumaM = FxaaLuma(rgbM.rgb);","float lumaMax = max(max(lumaNe, lumaSe), max(lumaNw, lumaSw));","float lumaMin = min(min(lumaNe, lumaSe), min(lumaNw, lumaSw));","float lumaMaxSubMinM = max(lumaMax, lumaM) - min(lumaMin, lumaM);","float lumaMaxScaledClamped = max(FXAA_EDGE_THRESHOLD_MIN, lumaMax * FXAA_EDGE_THRESHOLD);","if (lumaMaxSubMinM < lumaMaxScaledClamped) {","gl_FragColor = vec4(rgbM, 1.0);","return;","}","float dirSwMinusNe = lumaSw - lumaNe;","float dirSeMinusNw = lumaSe - lumaNw;","vec2 dir1 = normalize(vec2(dirSwMinusNe + dirSeMinusNw, dirSwMinusNe - dirSeMinusNw));","vec3 rgbN1 = texture2D(tDiffuse, vPos.xy - dir1 * FXAA_RCP_FRAME_OPT*resolution).rgb;","vec3 rgbP1 = texture2D(tDiffuse, vPos.xy + dir1 * FXAA_RCP_FRAME_OPT*resolution).rgb;","float dirAbsMinTimesC = min(abs(dir1.x), abs(dir1.y)) * FXAA_EDGE_SHARPNESS;","vec2 dir2 = clamp(dir1.xy / dirAbsMinTimesC, -2.0, 2.0);","vec3 rgbN2 = texture2D(tDiffuse, vPos.xy - dir2 * FXAA_RCP_FRAME_OPT2*resolution).rgb;","vec3 rgbP2 = texture2D(tDiffuse, vPos.xy + dir2 * FXAA_RCP_FRAME_OPT2*resolution).rgb;","vec3 rgbA = rgbN1 + rgbP1;","vec3 rgbB = ((rgbN2 + rgbP2) * 0.25) + (rgbA * 0.25);","float lumaB = FxaaLuma(rgbB);","if ((lumaB < lumaMin) || (lumaB > lumaMax))","gl_FragColor = vec4(rgbA * 0.5, 1.0);","else","gl_FragColor = vec4(rgbB, 1.0);","}"].join("\n")},Te=new THREE.ShaderMaterial({defines:{MAX_RADIUS:4},uniforms:{tDiffuse:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"#include <common>        varying vec2 vUv;        uniform sampler2D tDiffuse;        uniform vec2 texSize;        uniform vec2 direction;        uniform float kernelRadius;                float gaussianPdf(in float x, in float sigma) {            return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;        }        void main() {            vec2 invSize = 1.0 / texSize;            float weightSum = gaussianPdf(0.0, kernelRadius);            vec3 diffuseSum = texture2D( tDiffuse, vUv).rgb * weightSum;            vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS) * 0.5;            vec2 uvOffset = delta;            for( int i = 1; i <= MAX_RADIUS; i ++ ) {                float w = gaussianPdf(uvOffset.x, kernelRadius);                vec3 sample1 = texture2D( tDiffuse, vUv + uvOffset).rgb;                vec3 sample2 = texture2D( tDiffuse, vUv - uvOffset).rgb;                diffuseSum += ((sample1 + sample2) * w);                weightSum += (2.0 * w);                uvOffset += delta;            }            float alpha = texture2D( tDiffuse, vUv).a;            gl_FragColor = vec4(diffuseSum/weightSum, alpha);        }"}),Ae={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","bool IsSelected (vec3 color) {"," return (color.g<1e-8 && color.b < 1e-8 && color.r > 1e-3);","}","void main() {","float Alpha = 0.0;","vec2 texel = vec2( 0.5 / resolution.x, 0.5 / resolution.y );","texel = texel * vec2(2.0,2.0); ","bool Selected = false;","for( int i = -1; i <= 1;++i ) {","for (int j = -1; j <= 1; ++j){","Selected = IsSelected(texture2D( tDiffuse, vUv + texel * vec2( i,j ) ).rgb);","if (Selected) break;","}","if (Selected) break;","}","if(Selected)","Alpha = 1.0;","vec4 color = texture2D( tDiffuse, vUv);","float l = linearToRelativeLuminance( color.rgb );","gl_FragColor = vec4( l, l, l, Alpha );","}"].join("\n")},Re=new THREE.ShaderMaterial({uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2},selectColor:{value:new THREE.Color}},vertexShader:["varying vec2 vUv;","void main() { ","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","uniform vec3 selectColor;","varying vec2 vUv;","void main() {","vec2 texel = vec2( 1.0 / resolution.x, 1.0 / resolution.y );","texel = texel * vec2(0.3,0.3); ","vec3 colorDest = vec3(0.0,0.0,0.0);","const mat3 Gx = mat3( -1, -2, -1, 0, 0, 0, 1, 2, 1 );","const mat3 Gy = mat3( -1, 0, 1, -2, 0, 2, -1, 0, 1 );","float tx0y0 = texture2D( tDiffuse, vUv + texel * vec2( -1, -1 ) ).r;","float tx0y1 = texture2D( tDiffuse, vUv + texel * vec2( -1,  0 ) ).r;","float tx0y2 = texture2D( tDiffuse, vUv + texel * vec2( -1,  1 ) ).r;","float tx1y0 = texture2D( tDiffuse, vUv + texel * vec2(  0, -1 ) ).r;","float tx1y1 = texture2D( tDiffuse, vUv + texel * vec2(  0,  0 ) ).r;","float tx1y2 = texture2D( tDiffuse, vUv + texel * vec2(  0,  1 ) ).r;","float tx2y0 = texture2D( tDiffuse, vUv + texel * vec2(  1, -1 ) ).r;","float tx2y1 = texture2D( tDiffuse, vUv + texel * vec2(  1,  0 ) ).r;","float tx2y2 = texture2D( tDiffuse, vUv + texel * vec2(  1,  1 ) ).r;","float valueGx = Gx[0][0] * tx0y0 + Gx[1][0] * tx1y0 + Gx[2][0] * tx2y0 + ","Gx[0][1] * tx0y1 + Gx[1][1] * tx1y1 + Gx[2][1] * tx2y1 + ","Gx[0][2] * tx0y2 + Gx[1][2] * tx1y2 + Gx[2][2] * tx2y2; ","float valueGy = Gy[0][0] * tx0y0 + Gy[1][0] * tx1y0 + Gy[2][0] * tx2y0 + ","Gy[0][1] * tx0y1 + Gy[1][1] * tx1y1 + Gy[2][1] * tx2y1 + ","Gy[0][2] * tx0y2 + Gy[1][2] * tx1y2 + Gy[2][2] * tx2y2; ","float G = sqrt( ( valueGx * valueGx ) + ( valueGy * valueGy ) );","float Alpha = 1.0;","float select = texture2D( tDiffuse, vUv ).a;","if(G < 0.95) ","{","discard;","}","if( abs(select - 1.0) < 1e-6)","{","colorDest = selectColor;","}","gl_FragColor = vec4( colorDest, Alpha );","}"].join("\n"),blending:THREE.NormalBlending,depthTest:!1,depthWrite:!1,transparent:!0}),N={vertexShader:["void main() {\n","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","vec4 r = vec4( fract( v * PackFactors ), v );","r.yzw -= r.xyz * ShiftRight8; // tidy overflow","return r * PackUpscale;","}","float unpackRGBAToDepth( const in vec4 v ) {","return dot( v, UnpackFactors );","}","void main() {","gl_FragColor = packDepthToRGBA( gl_FragCoord.z);","}"].join("\n")};["varying vec4 mvPosition;","void main() {","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tmvPosition = ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tmvPosition = modelViewMatrix * vec4( position, 1.0 );\n#endif\n","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),["uniform float cameraNear;","uniform float cameraFar;","varying vec4 mvPosition;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","depth =smoothstep( cameraNear, cameraFar, depth );","gl_FragColor = vec4( mvPosition.xyz, depth);","}"].join("\n"),["varying vec3 vNormal;","void main() {","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tvNormal =  normalize( mat3(ndsModelViewMatrix) * normal );\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tvNormal =  normalize( mat3(modelViewMatrix) * normal );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),["varying vec3 vNormal;","void main() {","gl_FragColor = vec4( normalize(vNormal).xyz, 1.0);","}"].join("\n"),new THREE.Vector2(512,512),new THREE.Vector3(1,0,1),["varying vec2 vUv;","varying vec2 vExtent; ","vec2 getExtent() {","    vec2 extent;","    float a = projectionMatrix[2][2];","    float b = projectionMatrix[3][2];","    float nearOrthographic = (b + 1.0) / a;","    float farOrthographic = (b - 1.0) / a;","    float nearPerspective = b / (a - 1.0);","    float farPerspective = b / (a + 1.0);","    extent[0] = projectionMatrix[3][3] * nearOrthographic - projectionMatrix[2][3] * nearPerspective;","    extent[1] = projectionMatrix[3][3] * farOrthographic - projectionMatrix[2][3] * farPerspective;","    extent[1] -= extent[0];","    return extent;"," }","void main() {","vUv = uv;","vExtent = getExtent();","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["varying vec2 vUv;","varying vec2 vExtent; ","uniform sampler2D tDiffuse;","uniform sampler2D tPosition;","uniform sampler2D tNormal;","uniform vec2 vSize;","uniform float fOccluderBias;","uniform vec3 vAttenuation;","uniform float fDistScale;","uniform float fOnlyAo;","uniform float fLumInfluence;","uniform float fRadiusNear;","uniform float fRadiusFar;","uniform float fIntensity;","#define nRadial 5 ","#define nAngular 5 ","#define minResolution 2e-4 ","float SamplePixels (vec3 srcPosition, vec3 srcNormal, vec2 uv)","{","   vec3 dstPosition = texture2D(tPosition, uv).xyz;","   vec3 positionVec = dstPosition - srcPosition;","   float len = length(positionVec);","   float intensity = fIntensity * max((dot(positionVec, srcNormal)- minResolution* vExtent[1])/len- fOccluderBias, 0.0);","   float dist  = fDistScale * len / vExtent[1];","   float attenuation = 1.0 / (vAttenuation.x + (vAttenuation.y * dist) + vAttenuation.z*dist*dist);","   return intensity * attenuation ;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","return ( noise * 2.0  - 1.0 );","}","float getRandomAngle(vec2 pos) {","vec2 rnd = rand(pos);","return atan(rnd.y, rnd.x);","}","void main ()","{","   vec3 srcPosition = texture2D(tPosition, vUv).xyz;","   float srcDepth = texture2D(tPosition, vUv).w;","   vec3 srcNormal = texture2D(tNormal, vUv).xyz;","   float ao = 0.0;"," float radiusMax = fRadiusNear + (fRadiusFar- fRadiusNear) * srcDepth;"," float radiusMin = radiusMax/float(nRadial);"," float angleStep = 6.2831853/float(nAngular);","  vec2 texelSize= 1.0/vSize;"," float angle = getRandomAngle(vUv);","   for (int i = 0; i < nRadial; ++i)","   {","       float radius = radiusMin*float(i+1);","       for(int j=0; j< nAngular; ++j){","           vec2 offset = radius * vec2(cos(angle),sin(angle));","           offset *= texelSize; ","           ao += SamplePixels(srcPosition, srcNormal, vUv + offset);","           angle += angleStep;","       }","       angle -= angleStep/2.0;","   }","   ao /= float(nRadial * nAngular);","\tao *= float(srcDepth < 1.0);","   ao = clamp(ao, 0.0, 1.0);","\tgl_FragColor.r = ao;","   gl_FragColor.a = 1.0;","}"].join("\n"),new THREE.Vector2(512,512),["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tDiffuseOrginal;","uniform sampler2D tSSAOMap;","uniform vec2 vSize;","uniform float fOnlyAo;","uniform float fLumInfluence;","#define uFilterRadius 3","void main ()","{"," float occlusion = 0.0;"," float count = 0.0;"," vec2 texelSize= 1.0/vSize;"," for(int x= -uFilterRadius; x<= uFilterRadius; ++ x){","    for(int y = -uFilterRadius; y<= uFilterRadius; ++y){","        vec2 offset = vec2(x,y);","        float occulusionSample = texture2D(tSSAOMap, vUv + offset*texelSize).r;","        float weight = 1.0 / (1.0 + dot(offset, offset));","        occlusion += weight * occulusionSample;","        count += weight;","    }","}","occlusion /= count;","occlusion = clamp(occlusion, 0.0, 1.0);","occlusion = 1.0 - occlusion;","vec4 texelValue = texture2D(tDiffuseOrginal,vUv).rgba;","vec3 color = texelValue.rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 aoResult = vec3( mix( vec3( occlusion ), vec3( 1.0 ), luminance * fLumInfluence ) );","if ( fOnlyAo == 1.0 )","\tgl_FragColor.xyz= aoResult;","else if ( fOnlyAo == 2.0 )","   gl_FragColor.xyz = color;","else","{","   gl_FragColor.xyz = color * aoResult;","}","gl_FragColor.w = texelValue.a;","}"].join("\n"),n(24);a.prototype={constructor:a,setSize:function(e,t){},render:function(e,t,n,i,r){console.error("Pass: .render() must be implemented in derived pass.")}};function l(e,t){a.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}l.prototype=Object.create(a.prototype),Object.assign(l.prototype,{render:function(e,t,n,i,r){var o,a,s=e.context,l=e.state;l.buffers.color.setMask(!1),l.buffers.depth.setMask(!1),l.buffers.color.setLocked(!0),l.buffers.depth.setLocked(!0),a=this.inverse?(o=0,1):(o=1,0),l.buffers.stencil.setTest(!0),l.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),l.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),l.buffers.stencil.setClear(a),e.render(this.scene,this.camera,n,this.clear),e.render(this.scene,this.camera,t,this.clear),l.buffers.color.setLocked(!1),l.buffers.depth.setLocked(!1),l.buffers.stencil.setFunc(s.EQUAL,1,4294967295),l.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP)}});function d(){a.call(this),this.needsSwap=!1}d.prototype=Object.create(a.prototype),Object.assign(d.prototype,{render:function(e,t,n,i,r){e.state.buffers.stencil.setTest(!1)}});var Oe=function(e,t){a.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};Oe.prototype=Object.assign(Object.create(a.prototype),{constructor:Oe,render:function(e,t,n,i,r,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.quad.material=this.material,this.renderToColor&&i?e.render(this.scene,this.camera,i,this.clear):this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}});var Pe=function(e,t,n){var i;this.renderer=e,void 0===t&&(i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},e=e.getSize(),(t=new THREE.WebGLRenderTarget((n||e).width,(n||e).height,i)).texture.name="EffectComposer.rt1"),this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.colorTarget=n||null,this.passes=[],void 0===Me&&console.error("EffectComposer relies on CopyShader"),void 0===Oe&&console.error("EffectComposer relies on ShaderPass"),this.copyPass=new Oe(Me)};Object.assign(Pe.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;for(var t,n,i=!1,r=this.passes.length,o=0;o<r;o++)!1!==(n=this.passes[o]).enabled&&(n.render(this.renderer,this.writeBuffer,this.readBuffer,this.colorTarget,e,i),n.needsSwap&&(i&&((t=this.renderer.context).stencilFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),t.stencilFunc(t.EQUAL,1,4294967295)),this.swapBuffers()),n instanceof l?i=!0:n instanceof d&&(i=!1))},reset:function(e){var t;void 0===e&&(t=this.renderer.getSize(),(e=this.renderTarget1.clone()).setSize(t.width,t.height)),this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var n=0;n<this.passes.length;n++)this.passes[n].setSize(e,t)},setColorTarget:function(e){this.colorTarget&&this.colorTarget.dispose(),this.colorTarget=e,this.renderTarget1.setSize(e.width,e.height),this.renderTarget2.setSize(e.width,e.height);for(var t=0;t<this.passes.length;t++)this.passes[t].setSize(e.width,e.height)}});t=function(e,t,n,i,r){a.call(this),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=i,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1};t.prototype=Object.assign(Object.create(a.prototype),{constructor:t,render:function(e,t,n,i,r){var o,a,s=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(o=e.getClearColor().getHex(),a=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:n,this.clear),this.clearColor&&e.setClearColor(o,a),this.scene.overrideMaterial=null,e.autoClear=s}});var Ce=function(e,t,n,i,r,o){a.call(this),this.scene=e,this.camera=t,this.viewer=n,this.overrideMaterial=i,this.overrideMaterial||(this.overrideMaterial=new THREE.MeshLambertMaterial({color:0,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})),this.clearColor=r,this.clearColor||(this.clearColor=new THREE.Color(16777215)),this.clearAlpha=void 0!==o?o:1,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this.selectedMaterial=new THREE.MeshLambertMaterial({color:16711680,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})};Ce.prototype=Object.assign(Object.create(a.prototype),{constructor:t,render:function(e,t,n,i,r){var o=e.autoClear;e.autoClear=!1;var a=this.viewer.scene.overrideMaterial;this.scene.overrideMaterial=this.overrideMaterial;var s,l,d,c=(new this.overrideMaterial.constructor).copy(this.overrideMaterial);this.viewer.ndsModel.setOverrideMaterial(this.overrideMaterial,c,!1),this.clearColor&&(s=e.getClearColor().getHex(),l=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),this.viewer.ndsModel.backupDirty(),this.viewer.ndsModel.backupAllBodyFlag(),this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.meshManager.selectedMaterial&&(d=this.viewer.ndsModel.meshManager.selectedMaterial.clone(),this.viewer.ndsModel.meshManager.selectedMaterial=this.selectedMaterial);for(var h=0;h<this.viewer.scene.children.length;++h)"Object3D"==this.viewer.scene.children[h].type&&(this.viewer.scene.children[h].oldVisible=this.viewer.scene.children[h].visible,this.viewer.scene.children[h].visible=!1);e.render(this.scene,this.camera,n,this.clear),this.clearColor&&e.setClearColor(s,l),this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.ndsModel.resetAllBodyFlag(),this.viewer.ndsModel.resetDirty(),this.viewer.ndsModel.meshManager.selectedMaterial&&(this.viewer.ndsModel.meshManager.selectedMaterial=d);for(var u=0;u<this.viewer.scene.children.length;++u)"Object3D"==this.viewer.scene.children[u].type&&(this.viewer.scene.children[u].visible=this.viewer.scene.children[u].oldVisible);this.scene.overrideMaterial=a,e.autoClear=o}});var Be=function(e,t,n,i,r){this.viewer=e,this.renderScene=n,this.renderCamera=i,this.selectedObjects=void 0!==r?r:[],this.tempSelectedObjects=[],this.tempScene=new THREE.Scene,this.visibleEdgeColor=new THREE.Color(0,1,0),this.edgeThickness=3,this.edgeStrength=3,this.downSampleRatio=2,a.call(this),this.resolution=void 0!==t?new THREE.Vector2(t.x,t.y):new THREE.Vector2(256,256);i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},r=Math.round(this.resolution.x/this.downSampleRatio),t=Math.round(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new THREE.MeshBasicMaterial({color:255}),this.maskBufferMaterial.side=THREE.DoubleSide,this.maskBufferMaterialCopy=(new this.maskBufferMaterial.constructor).copy(this.maskBufferMaterial),this.tempScene.overrideMaterial=this.maskBufferMaterial,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,i),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(r,t,i),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(r,t,i),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(r,t,i),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(r,t),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.overlayMaterial=this.getOverlayMaterial(),void 0===Me&&console.error("OutlinePass relies on CopyShader");t=Me;this.copyUniforms=THREE.UniformsUtils.clone(t.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.tempPulseColor1=new THREE.Color,this.tempPulseColor2=new THREE.Color,this.textureMatrix=new THREE.Matrix4};Be.prototype=Object.assign(Object.create(a.prototype),{constructor:Be,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(e,t){this.renderTargetMaskBuffer.setSize(e,t);e=Math.round(e/this.downSampleRatio),t=Math.round(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(e,t),this.renderTargetBlurBuffer1.setSize(e,t),this.renderTargetEdgeBuffer1.setSize(e,t),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(e,t)},changeVisibilityOfNonSelectedObjects:function(o){var a=[];function e(e){(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh||e instanceof THREE.Line||e instanceof THREE.LineSegments)&&a.push(e)}for(var t=0,n=this.selectedObjects.length;t<n;t++)this.selectedObjects[t].traverse(e);this.renderScene.traverse(function(e){if(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh||e instanceof THREE.Line||e instanceof THREE.LineSegments){for(var t,n=!1,i=0,r=a.length;i<r;i++)if(a[i].id===e.id){n=!0;break}n||(t=e.visible,o&&!e.bVisible||(e.visible=o),e.bVisible=t)}})},render:function(e,t,n,i,r){if(0!==this.selectedObjects.length||0!==this.tempSelectedObjects.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var o=e.autoClear;if(e.autoClear=!1,r&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(16777215,1),this.viewer.ndsModel){this.viewer.ndsModel.backupAllBodyFlag(),this.viewer.ndsModel.hideAllBodies();for(var a=0,s=this.renderScene.children.length;a<s;a++)this.renderScene.children[a]!=this.viewer.ndsModel&&(this.renderScene.children[a].oldVisible=this.renderScene.children[a].visible,this.renderScene.children[a].visible=!1);for(a=0,s=this.selectedObjects.length;a<s;a++)this.viewer.ndsModel.showBody(this.selectedObjects[a]);this.viewer.ndsModel.backupDirty(),this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.renderScene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.maskBufferMaterial,this.maskBufferMaterialCopy,!1)}else this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.maskBufferMaterial;if(0<this.tempSelectedObjects.length)for(var l=0,s=this.tempSelectedObjects.length;l<s;l++)this.tempScene.children.push(this.tempSelectedObjects[l]);if(e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),e.render(this.tempScene,this.renderCamera,this.renderTargetMaskBuffer,!1),0<this.tempSelectedObjects.length&&(this.tempScene.children.length=0),this.viewer.ndsModel){this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.ndsModel.resetAllBodyFlag(),this.viewer.ndsModel.resetDirty();for(a=0,s=this.renderScene.children.length;a<s;a++)this.renderScene.children[a]!=this.viewer.ndsModel&&(this.renderScene.children[a].visible=this.renderScene.children[a].oldVisible)}else this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0);this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.visibleEdgeColor,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Be.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.render(this.scene,this.camera,this.renderTargetBlurBuffer1,!0),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Be.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,r&&e.context.enable(e.context.STENCIL_TEST),this.viewer.ndsModel?e.render(this.scene,this.camera,n,!1):e.render(this.scene,this.camera),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=o}},getEdgeDetectionMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec3 edgeColor;\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\t\t\t\t}"})},getSeperableBlurMaterial:function(e){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\t\t\t\tuniform sampler2D colorTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\tuniform float kernelRadius;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, kernelRadius);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\t\t\t\t\tvec2 uvOffset = delta;\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\t\t\t\t\t\tfloat w = gaussianPdf(uvOffset.x, kernelRadius);\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\t\t\t\t\t\tweightSum += (2.0 * w);\t\t\t\t\t\tuvOffset += delta;\t\t\t\t\t}\t\t\t\t\tfloat alpha = texture2D( colorTexture, vUv).a;\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, alpha);\t\t\t\t}"})},getOverlayMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeStrength:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform sampler2D edgeTexture1;\t\t\t\tuniform float edgeStrength;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tvec4 edgeValue = texture2D(edgeTexture1, vUv);\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\t\t\t\t\tgl_FragColor = finalColor;\t\t\t\t}",blending:THREE.NormalBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),Be.BlurDirectionX=new THREE.Vector2(1,0),Be.BlurDirectionY=new THREE.Vector2(0,1);var Le=function(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,defines:THREE.UniformsUtils.clone(e.defines)}),this.renderToScreen=!1,this.enabled=!0,this.clear=!1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);var n=new THREE.BufferGeometry,t=new Float32Array(9);t[0]=-1,t[1]=-1,t[2]=0,t[3]=3,t[4]=-1,t[5]=0,t[6]=-1,t[7]=3,t[8]=0;e=new Float32Array(6);e[0]=0,e[1]=0,e[2]=2,e[3]=0,e[4]=0,e[5]=2,n.addAttribute("position",new THREE.BufferAttribute(t,3)),n.addAttribute("uv",new THREE.BufferAttribute(e,2)),this.quad=new THREE.Mesh(n,this.material),this.scene=new THREE.Scene,this.scene.add(this.quad)};Le.prototype={render:function(e,t,n,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n),this.renderToScreen||!t?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)},dispose:function(){this.material.dispose(),this.quad.geometry.dispose()}};n(141),n(116),n(40),n(60);var f=function(l,e,t,n,i){THREE.Geometry.call(this),this.uvs=[];var r=t.length(),o=n.length(),a=t.clone();a.normalize();var s=n.clone();s.normalize();var d=new THREE.Vector3;if(d.crossVectors(a,s),l.hasOwnProperty("geometry")){var c=new THREE.Box3;c.setFromObject(l);var h=new Array,t=c.min.clone();h.push(t);n=c.max.clone();h.push(n);c=new THREE.Vector3;c.set(n.x,t.y,t.z),h.push(c);c=new THREE.Vector3;c.set(n.x,n.y,t.z),h.push(c);c=new THREE.Vector3;c.set(t.x,n.y,t.z),h.push(c);c=new THREE.Vector3;c.set(t.x,t.y,n.z),h.push(c);c=new THREE.Vector3;c.set(n.x,t.y,n.z),h.push(c);c=new THREE.Vector3;c.set(t.x,n.y,n.z),h.push(c);for(var u=1e8,f=-1e8,p=0;p<h.length;p++){var m=new THREE.Vector3;m.subVectors(h[p],e);m=m.dot(d);m<u&&(u=m),f<m&&(f=m)}t=e.clone();t.addScaledVector(d,f);n=e.clone();n.addScaledVector(d,u);c=f-u;null!=i&&"ProjBoth"==i&&(c*=2.1),this.dimensions=new THREE.Vector3(r,o,c),this.cube=new THREE.Mesh(new THREE.BoxGeometry(r,o,c),new THREE.MeshBasicMaterial);c=new THREE.Matrix4;c.makeBasis(a,s,d),null!=i&&"ProjBackward"==i?c.setPosition(n):c.setPosition(t),this.cube.applyMatrix(c),this.iCubeMatrix=(new THREE.Matrix4).getInverse(this.cube.matrix),this.faceIndices=["a","b","c","d"],this.clipFace=function(e,t){var r=.5*Math.abs(this.dimensions.clone().dot(t));function n(e,t,n){var i=e.vertex.dot(n)-r,n=i/(i-(t.vertex.dot(n)-r));return new THREE.DecalVertex(new THREE.Vector3(e.vertex.x+n*(t.vertex.x-e.vertex.x),e.vertex.y+n*(t.vertex.y-e.vertex.y),e.vertex.z+n*(t.vertex.z-e.vertex.z)),new THREE.Vector3(e.normal.x+n*(t.normal.x-e.normal.x),e.normal.y+n*(t.normal.y-e.normal.y),e.normal.z+n*(t.normal.z-e.normal.z)))}if(0===e.length)return[];for(var i=[],o=0;o<e.length;o+=3){var a,s,l,d=0<e[o+0].vertex.dot(t)-r,c=0<e[o+1].vertex.dot(t)-r,h=0<e[o+2].vertex.dot(t)-r;switch((d?1:0)+(c?1:0)+(h?1:0)){case 0:i.push(e[o]),i.push(e[o+1]),i.push(e[o+2]);break;case 1:if(d&&(a=e[o+1],s=e[o+2],l=n(e[o],a,t),nV4=n(e[o],s,t)),c){a=e[o],s=e[o+2],l=n(e[o+1],a,t),nV4=n(e[o+1],s,t),i.push(l),i.push(s.clone()),i.push(a.clone()),i.push(s.clone()),i.push(l.clone()),i.push(nV4);break}h&&(a=e[o],s=e[o+1],l=n(e[o+2],a,t),nV4=n(e[o+2],s,t)),i.push(a.clone()),i.push(s.clone()),i.push(l),i.push(nV4),i.push(l.clone()),i.push(s.clone());break;case 2:d||(s=n(a=e[o].clone(),e[o+1],t),l=n(a,e[o+2],t),i.push(a),i.push(s),i.push(l)),c||(s=n(a=e[o+1].clone(),e[o+2],t),l=n(a,e[o],t),i.push(a),i.push(s),i.push(l)),h||(s=n(a=e[o+2].clone(),e[o],t),l=n(a,e[o+1],t),i.push(a),i.push(s),i.push(l))}}return i},this.pushVertex=function(e,t,n){t=l.geometry.vertices[t].clone();t.applyMatrix4(l.matrixWorld),t.applyMatrix4(this.iCubeMatrix),e.push(new THREE.DecalVertex(t,n.clone()))},this.pushVertexBufferGeometry=function(e,t){var n=l.geometry.attributes.position.array,i=l.geometry.attributes.normal.array,r=new THREE.Vector3,o=new THREE.Vector3;r.fromArray(n,3*t),o.fromArray(i,3*t),r.applyMatrix4(l.matrixWorld),r.applyMatrix4(this.iCubeMatrix),e.push(new THREE.DecalVertex(r,o))},this.computeDecal=function(){var e=[];if(l.geometry instanceof THREE.Geometry)for(var t=0;t<l.geometry.faces.length;t++){var n=l.geometry.faces[t];this.pushVertex(o=[],n[this.faceIndices[0]],n.vertexNormals[0]),this.pushVertex(o,n[this.faceIndices[1]],n.vertexNormals[1]),this.pushVertex(o,n[this.faceIndices[2]],n.vertexNormals[2]),o=this.clipFace(o,new THREE.Vector3(1,0,0)),o=this.clipFace(o,new THREE.Vector3(-1,0,0)),o=this.clipFace(o,new THREE.Vector3(0,1,0)),o=this.clipFace(o,new THREE.Vector3(0,-1,0)),o=this.clipFace(o,new THREE.Vector3(0,0,1)),o=this.clipFace(o,new THREE.Vector3(0,0,-1));for(var i=0;i<o.length;i++){var r=o[i];this.uvs.push(new THREE.Vector2(.5+r.vertex.x/this.dimensions.x,.5+r.vertex.y/this.dimensions.y)),o[i].vertex.applyMatrix4(this.cube.matrix)}0!==o.length&&(e=e.concat(o))}else if(l.geometry instanceof THREE.BufferGeometry)for(var o,a=l.geometry.index.array,t=0;t<a.length/3;t++){this.pushVertexBufferGeometry(o=[],a[3*t]),this.pushVertexBufferGeometry(o,a[3*t+1]),this.pushVertexBufferGeometry(o,a[3*t+2]),o=this.clipFace(o,new THREE.Vector3(1,0,0)),o=this.clipFace(o,new THREE.Vector3(-1,0,0)),o=this.clipFace(o,new THREE.Vector3(0,1,0)),o=this.clipFace(o,new THREE.Vector3(0,-1,0)),o=this.clipFace(o,new THREE.Vector3(0,0,1)),o=this.clipFace(o,new THREE.Vector3(0,0,-1));for(i=0;i<o.length;i++){r=o[i];this.uvs.push(new THREE.Vector2(.5+r.vertex.x/this.dimensions.x,.5+r.vertex.y/this.dimensions.y)),o[i].vertex.applyMatrix4(this.cube.matrix)}0!==o.length&&(e=e.concat(o))}for(var s=0;s<e.length;s+=3)this.vertices.push(e[s].vertex,e[s+1].vertex,e[s+2].vertex),(n=new THREE.Face3(s,s+1,s+2)).vertexNormals.push(e[s+0].normal),n.vertexNormals.push(e[s+1].normal),n.vertexNormals.push(e[s+2].normal),this.faces.push(n),this.faceVertexUvs[0].push([this.uvs[s],this.uvs[s+1],this.uvs[s+2]]);this.verticesNeedUpdate=!0,this.elementsNeedUpdate=!0,this.morphTargetsNeedUpdate=!0,this.uvsNeedUpdate=!0,this.normalsNeedUpdate=!0,this.colorsNeedUpdate=!0,this.computeFaceNormals()},this.computeDecal()}};f.prototype=Object.create(THREE.Geometry.prototype),f.prototype.constructor=f;n(52),n(41),n(143),n(144);var ke=ke||{};ke.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053},ke.Flags={NORMALS:1},ke.File=function(e){this.load(e)},ke.File.prototype.load=function(e){this.header=new ke.FileHeader(e),this.body=new ke.FileBody(this.header),this.getReader().read(e,this.body)},ke.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case ke.CompressionMethod.RAW:e=new ke.ReaderRAW;break;case ke.CompressionMethod.MG1:e=new ke.ReaderMG1;break;case ke.CompressionMethod.MG2:e=new ke.ReaderMG2}return e},ke.FileHeader=function(e){e.readInt32(),this.fileFormat=e.readInt32(),this.compressionMethod=e.readInt32(),this.vertexCount=e.readInt32(),this.triangleCount=e.readInt32(),this.uvMapCount=e.readInt32(),this.attrMapCount=e.readInt32(),this.flags=e.readInt32(),this.comment=e.readString()},ke.FileHeader.prototype.hasNormals=function(){return this.flags&ke.Flags.NORMALS},ke.FileBody=function(e){var t=3*e.triangleCount,n=3*e.vertexCount,i=e.hasNormals()?3*e.vertexCount:0,r=2*e.vertexCount,o=4*e.vertexCount,a=0,s=new ArrayBuffer(4*(t+n+i+r*e.uvMapCount+o*e.attrMapCount));if(this.indices=new Uint32Array(s,0,t),this.vertices=new Float32Array(s,4*t,n),e.hasNormals()&&(this.normals=new Float32Array(s,4*(t+n),i)),e.uvMapCount)for(this.uvMaps=[],a=0;a<e.uvMapCount;++a)this.uvMaps[a]={uv:new Float32Array(s,4*(t+n+i+a*r),r)};if(e.attrMapCount)for(this.attrMaps=[],a=0;a<e.attrMapCount;++a)this.attrMaps[a]={attr:new Float32Array(s,4*(t+n+i+r*e.uvMapCount+a*o),o)}},ke.FileMG2Header=function(e){e.readInt32(),this.vertexPrecision=e.readFloat32(),this.normalPrecision=e.readFloat32(),this.lowerBoundx=e.readFloat32(),this.lowerBoundy=e.readFloat32(),this.lowerBoundz=e.readFloat32(),this.higherBoundx=e.readFloat32(),this.higherBoundy=e.readFloat32(),this.higherBoundz=e.readFloat32(),this.divx=e.readInt32(),this.divy=e.readInt32(),this.divz=e.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz},ke.ReaderRAW=function(){},ke.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},ke.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32(),e.readArrayInt32(t)},ke.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32(),e.readArrayFloat32(t)},ke.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32(),e.readArrayFloat32(t)},ke.ReaderRAW.prototype.readUVMaps=function(e,t){for(var n=0;n<t.length;++n)e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString(),e.readArrayFloat32(t[n].uv)},ke.ReaderRAW.prototype.readAttrMaps=function(e,t){for(var n=0;n<t.length;++n)e.readInt32(),t[n].name=e.readString(),e.readArrayFloat32(t[n].attr)},ke.ReaderMG1=function(){},ke.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},ke.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var n=new ke.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length),ke.restoreIndices(t,t.length)},ke.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();t=new ke.InterleavedStream(t,1);LZMA.decompress(e,e,t,t.data.length)},ke.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();t=new ke.InterleavedStream(t,3);LZMA.decompress(e,e,t,t.data.length)},ke.ReaderMG1.prototype.readUVMaps=function(e,t){for(var n=0;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString(),e.readInt32();var i=new ke.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,i,i.data.length)}},ke.ReaderMG1.prototype.readAttrMaps=function(e,t){for(var n=0;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),e.readInt32();var i=new ke.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,i,i.data.length)}},ke.ReaderMG2=function(){},ke.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new ke.FileMG2Header(e),this.readVertices(e,t.vertices),this.readIndices(e,t.indices),t.normals&&this.readNormals(e,t),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},ke.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var n=new ke.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length);e=this.readGridIndices(e,t);ke.restoreVertices(t,this.MG2Header,e,this.MG2Header.vertexPrecision)},ke.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32(),e.readInt32();var n=new Uint32Array(t.length/3),t=new ke.InterleavedStream(n,1);return LZMA.decompress(e,e,t,t.data.length),ke.restoreGridIndices(n,n.length),n},ke.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var n=new ke.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length),ke.restoreIndices(t,t.length)},ke.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var n=new ke.InterleavedStream(t.normals,3);LZMA.decompress(e,e,n,n.data.length);n=ke.calcSmoothNormals(t.indices,t.vertices);ke.restoreNormals(t.normals,n,this.MG2Header.normalPrecision)},ke.ReaderMG2.prototype.readUVMaps=function(e,t){for(var n=0;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString();var i=e.readFloat32();e.readInt32();var r=new ke.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,r,r.data.length),ke.restoreMap(t[n].uv,2,i)}},ke.ReaderMG2.prototype.readAttrMaps=function(e,t){for(var n=0;n<t.length;++n){e.readInt32(),t[n].name=e.readString();var i=e.readFloat32();e.readInt32();var r=new ke.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,r,r.data.length),ke.restoreMap(t[n].attr,4,i)}},ke.restoreIndices=function(e,t){var n=3;for(0<t&&(e[2]+=e[0],e[1]+=e[0]);n<t;n+=3)e[n]+=e[n-3],e[n]===e[n-3]?e[n+1]+=e[n-2]:e[n+1]+=e[n],e[n+2]+=e[n]},ke.restoreIndices2=function(e,t,n){var i=3;for(0<n&&(e[t+2]+=e[t+0],e[t+1]+=e[t+0]);i<n;i+=3)e[t+i]+=e[t+i-3],e[t+i]===e[t+i-3]?e[t+i+1]+=e[t+i-2]:e[t+i+1]+=e[t+i],e[t+i+2]+=e[t+i]},ke.restoreGridIndices=function(e,t){for(var n=1;n<t;++n)e[n]+=e[n-1]},ke.restoreVertices=function(e,t,n,i){for(var r,o,a,s,l,d=new Uint32Array(e.buffer,e.byteOffset,e.length),c=t.divx,h=c*t.divy,u=2147483647,f=0,p=0,m=0,g=n.length;p<g;m+=3)a=r=n[p++],a-=~~((l=~~(a/h))*h),a-=~~((s=~~(a/c))*c),o=d[m],r===u&&(o+=f),e[m]=t.lowerBoundx+a*t.sizex+i*o,e[m+1]=t.lowerBoundy+s*t.sizey+i*d[m+1],e[m+2]=t.lowerBoundz+l*t.sizez+i*d[m+2],u=r,f=o},ke.restoreNormals=function(e,t,n){for(var i,r,o,a,s,l,d=new Uint32Array(e.buffer,e.byteOffset,e.length),c=0,h=e.length,u=1.5707963267948966;c<h;c+=3)a=d[c]*n,0===(l=d[c+1])?(e[c]=t[c]*a,e[c+1]=t[c+1]*a,e[c+2]=t[c+2]*a):(s=l<=4?(d[c+2]-2)*u:(4*d[c+2]/l-2)*u,l*=n*u,i=(o=a*Math.sin(l))*Math.cos(s),r=o*Math.sin(s),o=a*Math.cos(l),s=t[c+1],a=t[c]-t[c+2],1e-20<(l=Math.sqrt(2*s*s+a*a))&&(a/=l,s/=l),e[c]=t[c]*o+(t[c+1]*s-t[c+2]*a)*r-s*i,e[c+1]=t[c+1]*o-(t[c+2]+t[c])*s*r+a*i,e[c+2]=t[c+2]*o+(t[c]*a+t[c+1]*s)*r+s*i)},ke.restoreMap=function(e,t,n){for(var i,r,o,a=new Uint32Array(e.buffer,e.byteOffset,e.length),s=0,l=e.length;s<t;++s)for(i=0,o=s;o<l;o+=t)i+=1&(r=a[o])?-(r+1>>1):r>>1,e[o]=i*n},ke.calcSmoothNormals=function(e,t){for(var n,i,r,o,a,s,l,d,c,h,u,f=new Float32Array(t.length),p=0,m=e.length;p<m;)n=3*e[p++],i=3*e[p++],r=3*e[p++],a=t[i]-t[n],d=t[r]-t[n],s=t[1+i]-t[1+n],c=t[1+r]-t[1+n],l=t[2+i]-t[2+n],o=s*(h=t[2+r]-t[2+n])-l*c,h=l*d-a*h,d=a*c-s*d,1e-10<(u=Math.sqrt(o*o+h*h+d*d))&&(o/=u,h/=u,d/=u),f[n]+=o,f[1+n]+=h,f[2+n]+=d,f[i]+=o,f[1+i]+=h,f[2+i]+=d,f[r]+=o,f[1+r]+=h,f[2+r]+=d;for(p=0,m=f.length;p<m;p+=3)1e-10<(u=Math.sqrt(f[p]*f[p]+f[p+1]*f[p+1]+f[p+2]*f[p+2]))&&(f[p]/=u,f[p+1]/=u,f[p+2]/=u);return f},ke.isLittleEndian=(yt=new ArrayBuffer(2),t=new Uint8Array(yt),yt=new Uint16Array(yt),(t[0]=1)===yt[0]),ke.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.offset=ke.isLittleEndian?3:0,this.count=4*t,this.len=this.data.length},ke.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count&&(this.offset-=this.count+(ke.isLittleEndian?1:-1)))},ke.BIMStream=function(e,t,n){this.data=e,this.offset=t,this.count=n,this.len=this.data.length},ke.BIMStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset=0)},ke.Stream=function(e){this.data=e,this.dataView=new DataView(e.buffer),this.offset=0},ke.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23),ke.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126),ke.Stream.prototype.readByte=function(){return 255&this.data[this.offset++]},ke.Stream.prototype.readUInt8=function(){var e=this.dataView.getUint8(this.offset,!0);return this.offset+=1,e},ke.Stream.prototype.readInt32=function(){var e=this.dataView.getInt32(this.offset,!0);return this.offset+=4,e},ke.Stream.prototype.readInt64=function(){var e=this.dataView.getBigInt64(this.offset,!0);return this.offset+=8,Number(e)},ke.Stream.prototype.readInt16=function(){var e=this.dataView.getInt16(this.offset,!0);return this.offset+=2,e},ke.Stream.prototype.readUInt16=function(){var e=this.dataView.getUint16(this.offset,!0);return this.offset+=2,e},ke.Stream.prototype.readFloat32=function(){var e=this.dataView.getFloat32(this.offset,!0);return this.offset+=4,e},ke.Stream.prototype.readFloat64=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},ke.Stream.prototype.readString=function(){var e=this.readInt32();return this.offset+=e,String.fromCharCode.apply(null,this.data.subarray(this.offset-e,this.offset))},ke.Stream.prototype.readTexture=function(){for(var e=this.readByte(),t=[],n=0;n<8;n++){var i=4*n;e&Math.pow(2,n)?(t[i]=0,t[1+i]=0,t[2+i]=0,t[3+i]=255):(t[i]=255,t[1+i]=255,t[2+i]=255,t[3+i]=0)}return t},ke.Stream.prototype.readGuid=function(){for(var e,t="";t+=e=String.fromCharCode(this.readByte()),0!==e.charCodeAt(0););return t.substring(0,t.length-1)},ke.Stream.prototype.readArrayInt32=function(e){for(var t=0,n=e.length;t<n;)e[t++]=this.readInt32();return e},ke.Stream.prototype.readArrayFloat32=function(e){for(var t=0,n=e.length;t<n;)e[t++]=this.readFloat32();return e};var g=g||{};g.OutWindow=function(){this._windowSize=0},g.OutWindow.prototype.create=function(e){this._buffer&&this._windowSize===e||(this._buffer=[]),this._windowSize=e,this._pos=0,this._streamPos=0},g.OutWindow.prototype.flush=function(){var e=this._pos-this._streamPos;if(0!==e){for(;e--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0),this._streamPos=this._pos}},g.OutWindow.prototype.releaseStream=function(){this.flush(),this._stream=null},g.OutWindow.prototype.setStream=function(e){this.releaseStream(),this._stream=e},g.OutWindow.prototype.init=function(e){e||(this._streamPos=0,this._pos=0)},g.OutWindow.prototype.copyBlock=function(e,t){var n=this._pos-e-1;for(n<0&&(n+=this._windowSize);t--;)n>=this._windowSize&&(n=0),this._buffer[this._pos++]=this._buffer[n++],this._pos>=this._windowSize&&this.flush()},g.OutWindow.prototype.putByte=function(e){this._buffer[this._pos++]=e,this._pos>=this._windowSize&&this.flush()},g.OutWindow.prototype.getByte=function(e){e=this._pos-e-1;return e<0&&(e+=this._windowSize),this._buffer[e]},g.RangeDecoder=function(){},g.RangeDecoder.prototype.setStream=function(e){this._stream=e},g.RangeDecoder.prototype.releaseStream=function(){this._stream=null},g.RangeDecoder.prototype.init=function(){var e=5;for(this._code=0,this._range=-1;e--;)this._code=this._code<<8|this._stream.readByte()},g.RangeDecoder.prototype.decodeDirectBits=function(e){for(var t,n=0,i=e;i--;)this._range>>>=1,t=this._code-this._range>>>31,this._code-=this._range&t-1,n=n<<1|1-t,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return n},g.RangeDecoder.prototype.decodeBit=function(e,t){var n=e[t],i=(this._range>>>11)*n;return(2147483648^this._code)<(2147483648^i)?(this._range=i,e[t]+=2048-n>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0):(this._range-=i,this._code-=i,e[t]-=n>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),1)},g.initBitModels=function(e,t){for(;t--;)e[t]=1024},g.BitTreeDecoder=function(e){this._models=[],this._numBitLevels=e},g.BitTreeDecoder.prototype.init=function(){g.initBitModels(this._models,1<<this._numBitLevels)},g.BitTreeDecoder.prototype.decode=function(e){for(var t=1,n=this._numBitLevels;n--;)t=t<<1|e.decodeBit(this._models,t);return t-(1<<this._numBitLevels)},g.BitTreeDecoder.prototype.reverseDecode=function(e){for(var t,n=1,i=0,r=0;r<this._numBitLevels;++r)n=n<<1|(t=e.decodeBit(this._models,n)),i|=t<<r;return i},g.reverseDecode2=function(e,t,n,i){for(var r,o=1,a=0,s=0;s<i;++s)o=o<<1|(r=n.decodeBit(e,t+o)),a|=r<<s;return a},g.LenDecoder=function(){this._choice=[],this._lowCoder=[],this._midCoder=[],this._highCoder=new g.BitTreeDecoder(8),this._numPosStates=0},g.LenDecoder.prototype.create=function(e){for(;this._numPosStates<e;++this._numPosStates)this._lowCoder[this._numPosStates]=new g.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new g.BitTreeDecoder(3)},g.LenDecoder.prototype.init=function(){var e=this._numPosStates;for(g.initBitModels(this._choice,2);e--;)this._lowCoder[e].init(),this._midCoder[e].init();this._highCoder.init()},g.LenDecoder.prototype.decode=function(e,t){return 0===e.decodeBit(this._choice,0)?this._lowCoder[t].decode(e):0===e.decodeBit(this._choice,1)?8+this._midCoder[t].decode(e):16+this._highCoder.decode(e)},g.Decoder2=function(){this._decoders=[]},g.Decoder2.prototype.init=function(){g.initBitModels(this._decoders,768)},g.Decoder2.prototype.decodeNormal=function(e){for(var t=1;(t=t<<1|e.decodeBit(this._decoders,t))<256;);return 255&t},g.Decoder2.prototype.decodeWithMatchByte=function(e,t){var n,i,r=1;do{if(n=t>>7&1,t<<=1,r=r<<1|(i=e.decodeBit(this._decoders,(1+n<<8)+r)),n!==i){for(;r<256;)r=r<<1|e.decodeBit(this._decoders,r);break}}while(r<256);return 255&r},g.LiteralDecoder=function(){},g.LiteralDecoder.prototype.create=function(e,t){var n;if(!this._coders||this._numPrevBits!==t||this._numPosBits!==e)for(this._numPosBits=e,this._posMask=(1<<e)-1,this._numPrevBits=t,this._coders=[],n=1<<this._numPrevBits+this._numPosBits;n--;)this._coders[n]=new g.Decoder2},g.LiteralDecoder.prototype.init=function(){for(var e=1<<this._numPrevBits+this._numPosBits;e--;)this._coders[e].init()},g.LiteralDecoder.prototype.getDecoder=function(e,t){return this._coders[((e&this._posMask)<<this._numPrevBits)+((255&t)>>>8-this._numPrevBits)]},g.Decoder=function(){this._outWindow=new g.OutWindow,this._rangeDecoder=new g.RangeDecoder,this._isMatchDecoders=[],this._isRepDecoders=[],this._isRepG0Decoders=[],this._isRepG1Decoders=[],this._isRepG2Decoders=[],this._isRep0LongDecoders=[],this._posSlotDecoder=[],this._posDecoders=[],this._posAlignDecoder=new g.BitTreeDecoder(4),this._lenDecoder=new g.LenDecoder,this._repLenDecoder=new g.LenDecoder,this._literalDecoder=new g.LiteralDecoder,this._dictionarySize=-1,this._dictionarySizeCheck=-1,this._posSlotDecoder[0]=new g.BitTreeDecoder(6),this._posSlotDecoder[1]=new g.BitTreeDecoder(6),this._posSlotDecoder[2]=new g.BitTreeDecoder(6),this._posSlotDecoder[3]=new g.BitTreeDecoder(6)},g.Decoder.prototype.setDictionarySize=function(e){return!(e<0)&&(this._dictionarySize!==e&&(this._dictionarySize=e,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096))),!0)},g.Decoder.prototype.setLcLpPb=function(e,t,n){var i=1<<n;return!(8<e||4<t||4<n)&&(this._literalDecoder.create(t,e),this._lenDecoder.create(i),this._repLenDecoder.create(i),this._posStateMask=i-1,!0)},g.Decoder.prototype.init=function(){var e=4;for(this._outWindow.init(!1),g.initBitModels(this._isMatchDecoders,192),g.initBitModels(this._isRep0LongDecoders,192),g.initBitModels(this._isRepDecoders,12),g.initBitModels(this._isRepG0Decoders,12),g.initBitModels(this._isRepG1Decoders,12),g.initBitModels(this._isRepG2Decoders,12),g.initBitModels(this._posDecoders,114),this._literalDecoder.init();e--;)this._posSlotDecoder[e].init();this._lenDecoder.init(),this._repLenDecoder.init(),this._posAlignDecoder.init(),this._rangeDecoder.init()},g.Decoder.prototype.decode=function(e,t,n){var i,r,o,a,s=0,l=0,d=0,c=0,h=0,u=0,f=0;for(this._rangeDecoder.setStream(e),this._outWindow.setStream(t),this.init();n<0||u<n;)if(a=u&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(s<<4)+a))o=this._literalDecoder.getDecoder(u++,f),f=7<=s?o.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(l)):o.decodeNormal(this._rangeDecoder),this._outWindow.putByte(f),s=s<4?0:s-(s<10?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,s))(i=0)===this._rangeDecoder.decodeBit(this._isRepG0Decoders,s)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(s<<4)+a)&&(s=s<7?9:11,i=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,s)?r=d:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,s)?r=c:(r=h,h=c),c=d),d=l,l=r),0===i&&(i=2+this._repLenDecoder.decode(this._rangeDecoder,a),s=s<7?8:11);else if(h=c,c=d,d=l,i=2+this._lenDecoder.decode(this._rangeDecoder,a),s=s<7?7:10,4<=(o=this._posSlotDecoder[i<=5?i-2:3].decode(this._rangeDecoder))){if(l=(2|1&o)<<(a=(o>>1)-1),o<14)l+=g.reverseDecode2(this._posDecoders,l-o-1,this._rangeDecoder,a);else if(l+=this._rangeDecoder.decodeDirectBits(a-4)<<4,(l+=this._posAlignDecoder.reverseDecode(this._rangeDecoder))<0){if(-1===l)break;return!1}}else l=o;if(u<=l||l>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(l,i),u+=i,f=this._outWindow.getByte(0)}return this._outWindow.flush(),this._outWindow.releaseStream(),this._rangeDecoder.releaseStream(),!0},g.Decoder.prototype.setDecoderProperties=function(e){var t;return!(e.size<5)&&(t=e.readByte(),!!this.setLcLpPb(t%9,(t=~~(t/9))%5,~~(t/5))&&(t=e.readByte(),t|=e.readByte()<<8,t|=e.readByte()<<16,t+=16777216*e.readByte(),this.setDictionarySize(t)))},g.decompress=function(e,t,n,i){var r=new g.Decoder;if(!r.setDecoderProperties(e))throw"Incorrect stream properties";if(!r.decode(t,n,i))throw"Error in data stream";return!0};var oe=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};THREE.Loader.call(this,e&&e.showStatus),e&&(this.objectIdType=void 0!==e.objectIdType?e.objectIdType:1,this.materialIdType=void 0!==e.materialIdType?e.materialIdType:1,this.geomIdType=void 0!==e.geomIdType?e.geomIdType:1,this.instanceIdType=void 0!==e.instanceIdType?e.instanceIdType:1)};oe.prototype=Object.create(THREE.Loader.prototype),oe.prototype.loadParts=function(e,l,d){d=d||{};var c=this,h=new XMLHttpRequest,u=d.basePath||this.extractUrlBase(e);h.onreadystatechange=function(){if(4===h.readyState&&(200===h.status||0===h.status)){for(var t=JSON.parse(h.responseText),n=[],i=[],r=0,e=0,o=t.materials.length;e<o;e++)n[e]=c.createMaterial(t.materials[e],u);var a=u+t.data,s={useWorker:d.useWorker,offsets:t.offsets};c.load(a,function(e){r+=1,i.push(e),r===t.offsets.length&&l(i,n)},s)}},h.open("GET",e,!0),h.setRequestHeader("Content-Type","text/plain"),h.send(null)},oe.prototype.load=function(e,l,d,c,h,u){c=c||{};var t=l.lastIndexOf(".");"drc"==l.substring(t+1,l.length)&&(c.compress=!1);var f=this,p=void 0!==c.bufferlenth?c.bufferlenth:0,m=new XMLHttpRequest;Date.now(),performance.now().toFixed(0);if(m.onreadystatechange=function(){if(4===m.readyState){if(200===m.status||0===m.status){var e=new Uint8Array(m.response),r=!c.geometriesArray,o=r?c.ndsGeometriesArray:c.geometriesArray;if(c.compress){if(c.useWorker){var t=c.worker||new Worker(Ue.loadWorkerUrl);t.onmessage=function(e){var t=e.data,e=new ke.Stream(t.data);e.offset=t.offset,f.readBIMBuffer(e,d,o,h);var n=o.length;if(c.ndsGeometriesArray)for(var i=0;i<n;++i)r||c.ndsGeometriesArray[i].copy(c.geometriesArray[i]),c.ndsGeometriesArray[i].loaded=!0,c.ndsGeometriesArray[i].bufferChunkUrl=l;this.terminate(),u&&u()};var n={data:e,bufferlenth:p},i=navigator.userAgent.toLowerCase();return void(-1!==i.indexOf("chrome")||-1!==i.indexOf("firefox")?t.postMessage(n,[n.data.buffer]):t.postMessage(n))}t=new ArrayBuffer(p),t=((n=new ke.Stream(e)).readInt32(),new Uint8Array(t)),t=new ke.BIMStream(t,0,1);g.decompress(n,n,t,t.data.length);t=new ke.Stream(t.data);f.readBIMBuffer(t,d,o,h);var a=o.length;if(c.ndsGeometriesArray)for(var s=0;s<a;++s)r||c.ndsGeometriesArray[s].copy(c.geometriesArray[s]),c.ndsGeometriesArray[s].loaded=!0,c.ndsGeometriesArray[s].bufferChunkUrl=l;u&&u()}else{c.useWorker&&c.worker&&c.worker.terminate();n=new ke.Stream(e);try{f.readBIMBufferDraco(n,d,o,h)}catch(e){d(),h&&h()}}a=o.length;if(c.ndsGeometriesArray)for(s=0;s<a;++s)r||c.ndsGeometriesArray[s].copy(c.geometriesArray[s]),c.ndsGeometriesArray[s].loaded=!0,c.ndsGeometriesArray[s].bufferChunkUrl=l}else console.error("Couldn't load ["+l+"] ["+m.status+"]");u&&u()}else 3===m.readyState||m.readyState},m.open("GET",l,!0),e)for(var n in e)m.setRequestHeader(n,e[n]);m.responseType="arraybuffer",m.send(null)},oe.prototype.parseBvh=function(e,n,i){var t,r,o=this,a=void 0!==n.bufferlenth?n.bufferlenth:0;n.compress&&0<a?n.useWorker?((t=n.worker||new Worker("js/core/loaders/BIMCTMWorker.js")).onmessage=function(e){var t=e.data,e=(Date.now(),new ke.Stream(t.data));e.offset=t.offset,o.readBvh(e,n.bvh,i,n);Date.now()},t.postMessage({data:e})):(Date.now(),a=new ArrayBuffer(a),(r=new ke.Stream(e)).readInt32(),a=new Uint8Array(a),a=new ke.BIMStream(a,0,1),g.decompress(r,r,a,a.data.length),a=new ke.Stream(a.data),o.readBvh(a,n.bvh,i,n),Date.now()):(Date.now(),r=new ke.Stream(e),o.readBvh(r,n.bvh,i,n),Date.now())},oe.prototype.loadBvh=function(e,t,n,i){n=n||{};var r=this,o=new XMLHttpRequest,a=Date.now();if(Ue.avoidCaching&&(t=t+"?time="+a),o.onreadystatechange=function(){var e;4===o.readyState?200===o.status||0===o.status?(Date.now(),e=new Uint8Array(o.response),r.parseBvh(e,n,i)):console.error("Couldn't load ["+t+"] ["+o.status+"]"):3===o.readyState||o.readyState},o.open("GET",t,!0),e)for(var s in e)o.setRequestHeader(s,e[s]);o.responseType="arraybuffer",o.send(null)},oe.prototype.loadTexture=function(e,n,i,r){var o=this,a=void 0!==(i=i||{}).bufferlenth?i.bufferlenth:0,s=new XMLHttpRequest,t=Date.now();if(Ue.avoidCaching&&(n=n+"?time="+t),s.onreadystatechange=function(){var e,t;4===s.readyState?200===s.status||0===s.status?(e=new Uint8Array(s.response),i.compress&&0<a&&(Date.now(),t=new ArrayBuffer(a),(e=new ke.Stream(e)).readInt32(),t=new Uint8Array(t),t=new ke.BIMStream(t,0,1),g.decompress(e,e,t,t.data.length),t=new ke.Stream(t.data),r(o.readTexture(t)))):console.error("Couldn't load ["+n+"] ["+s.status+"]"):3===s.readyState||s.readyState},s.open("GET",n,!0),e)for(var l in e)s.setRequestHeader(l,e[l]);s.responseType="arraybuffer",s.send(null)},oe.prototype.loadShx=function(e,n,i,r){var o=void 0!==(i=i||{}).bufferlenth?i.bufferlenth:0,a=new XMLHttpRequest,t=Date.now();if(Ue.avoidCaching&&(n=n+"?time="+t),a.onreadystatechange=function(){var e,t;4===a.readyState?200===a.status||0===a.status?(e=new Uint8Array(a.response),i.compress&&0<o&&(Date.now(),t=new ArrayBuffer(o),(e=new ke.Stream(e)).readInt32(),t=new Uint8Array(t),t=new ke.BIMStream(t,0,1),g.decompress(e,e,t,t.data.length),e=new ke.Stream(t.data),t=new Float32Array(o/4),r(e.readArrayFloat32(t)))):console.error("Couldn't load ["+n+"] ["+a.status+"]"):3===a.readyState||a.readyState},a.open("GET",n,!0),e)for(var s in e)a.setRequestHeader(s,e[s]);a.responseType="arraybuffer",a.send(null)},oe.prototype.computeGeometryFaceNormal=function(e){if(e instanceof THREE.Geometry)for(var t=new THREE.Vector3,n=new THREE.Vector3,i=new THREE.Vector3,r=0,o=e.faces.length;r<o;r++){var a,s,l,d=e.faces[r];!0===d.normal.equals(i)&&(a=e.vertices[d.a],s=e.vertices[d.b],l=e.vertices[d.c],t.subVectors(l,s),n.subVectors(a,s),t.cross(n),t.normalize(),d.normal=t.clone())}},oe.prototype.createModel=function(a,e){var t=function(){THREE.BufferGeometry.call(this),this.materials=[];var e,t,n=a.body.indices,i=a.body.vertices,r=a.body.normals,o=a.body.uvMaps;void 0!==o&&0<o.length&&(e=o[0].uv);o=a.body.attrMaps;void 0!==o&&0<o.length&&"Color"===o[0].name&&(t=o[0].attr),this.addAttribute("index",new THREE.BufferAttribute(n,1)),this.addAttribute("position",new THREE.BufferAttribute(i,3)),void 0!==r&&this.addAttribute("normal",new THREE.BufferAttribute(r,3)),void 0!==e&&this.addAttribute("uv",new THREE.BufferAttribute(e,2)),void 0!==t&&this.addAttribute("color",new THREE.BufferAttribute(t,4))};t.prototype=Object.create(THREE.BufferGeometry.prototype);t=new t;t.computeOffsets(),void 0===t.attributes.normal&&t.computeVertexNormals(),e(t)},oe.prototype.readTexture=function(e,t){e.readInt32();var n=e.readInt32();n++;for(var i=[],r=0;r<n;r++){for(var o=new Uint8Array(67108864),a=0,s=0;s<2097152;++s)for(var l=e.readTexture(),d=0;d<32;d++,a++)o[a]=l[d];l=new THREE.DataTexture(o,4096,4096);i.push(l)}return i},oe.prototype.readBIMBuffer=function(e,t,n,i){e.readString();var r=e.readInt32();1===r?this.readBIMBufferVersion1(e,t,n,i):2===r?this.readBIMBufferVersion2(e,t,n,i):3===r?this.readBIMBufferVersion3(e,t,n,i):4===r?this.readBIMBufferVersion4(e,t,n,i):5===r?this.readBIMBufferVersion5(e,t,n,i):6===r?this.readBIMBufferVersion6(e,t,n,i):7===r?this.readBIMBufferVersion7(e,t,n,i):8===r&&this.readBIMBufferVersion8(e,t,n,i)},oe.prototype.readBIMBufferDraco=function(e,t,n,i){for(var r,o,a,s,l,d=0,c=0,h=0,u=n.length,f=new Int8Array(u),p=new Int8Array(u),m=!1,g=0;g<u;++g)H=n[g],f[g]=H.index?0:1,p[g]=H.index&&!H.index.array?1:0,p[g]&&(m=!0);for(var v=[],g=0;g<u;++g){var y=e.readInt64();d+=8;var E=new this.DracoModule.DecoderBuffer;E.Init(e.data.slice(d,d+y),y);var b=new this.DracoModule.Decoder;d+=y,e.offset+=y;var M,x=b.GetEncodedGeometryType(E);x==this.DracoModule.TRIANGULAR_MESH?(M=new this.DracoModule.Mesh,b.DecodeBufferToMesh(E,M)):x==this.DracoModule.POINT_CLOUD&&(M=new this.DracoModule.PointCloud,b.DecodeBufferToPointCloud(E,M)),this.DracoModule.destroy(E);var w=[];if(x==this.DracoModule.POINT_CLOUD){var I=e.readInt32();d+=4;for(var S=0;S<I/4;++S)w.push(e.readInt32()),d+=4}var T,A=b.GetAttributeId(M,this.DracoModule.NORMAL);-1!=A&&(F=b.GetAttribute(M,A),T=new this.DracoModule.DracoFloat32Array,b.GetAttributeFloatForAllPoints(M,F,T));var R,O=b.GetAttributeId(M,this.DracoModule.TEX_COORD);-1!=O&&(_=b.GetAttribute(M,O),R=new this.DracoModule.DracoFloat32Array,b.GetAttributeFloatForAllPoints(M,_,R));var P,C=b.GetAttributeId(M,this.DracoModule.COLOR);-1!=C&&(k=b.GetAttribute(M,C),P=new this.DracoModule.DracoFloat32Array,b.GetAttributeFloatForAllPoints(M,k,P));var B=b.GetAttributeId(M,this.DracoModule.POSITION),L=b.GetAttribute(M,B),D=new this.DracoModule.DracoFloat32Array;b.GetAttributeFloatForAllPoints(M,L,D);var H=n[g],N=f[g],y=p[g];if(x==this.DracoModule.TRIANGULAR_MESH){var E=M.num_points(),F=-1==b.GetAttributeId(M,this.DracoModule.COLOR)?0:E,_=-1==b.GetAttributeId(M,this.DracoModule.TEX_COORD)?0:E,k=-1==b.GetAttributeId(M,this.DracoModule.NORMAL)?0:E,B=M.num_faces(),V=3,j=0<(F=0<F&&F!==E?0:F)?3:0,U=0<(_=0<_&&_!==E?0:_)?2:0,z=0<(k=0<k&&k!==E?0:k)?3:0,L=V+j+U+z;N?(r=new Float32Array(E*L),o=new THREE.InterleavedBuffer(r,L),Ee=new THREE.InterleavedBufferAttribute(o,V,0,!1),a=new THREE.InterleavedBufferAttribute(o,j,V,!1),s=new THREE.InterleavedBufferAttribute(o,U,V+j,!1),l=new THREE.InterleavedBufferAttribute(o,z,V+j+U,!1)):o=y?(H.attributes.position.data.array=new Float32Array(E*L),r=H.attributes.position.data.array,H.attributes.position.data):r=null,c=0,be=N?(ye=new(E<=65535?Uint16Array:Uint32Array)(3*B),new THREE.BufferAttribute(ye,1)):y?(H.index.array=new(E<=65535?Uint16Array:Uint32Array)(3*B),ye=H.index.array,H.index):ye=null;var G,W,h=0,Y=M.num_points(),X=-1==b.GetAttributeId(M,this.DracoModule.COLOR)?0:Y,Z=-1==b.GetAttributeId(M,this.DracoModule.TEX_COORD)?0:Y,q=-1==b.GetAttributeId(M,this.DracoModule.NORMAL)?0:Y,Q=M.num_faces(),J=new THREE.Vector3,K=new THREE.Vector3,$=0,ee=(V=3)+(j=0<X?3:0)+(U=0<Z?2:0)+(z=0<q?3:0),k=!1,B=!1;if(r?(0===F&&0<X&&(k=!0,ee-=j),0===_&&0<Z&&(B=!0,ee-=U),G=r,W=o):(W=N?(G=new Float32Array(Y*ee),new THREE.InterleavedBuffer(G,ee)):y?(H.attributes.position.data.array=new Float32Array(Y*ee),G=H.attributes.position.data.array,H.attributes.position.data):G=null,h=c=0),0<Y){for(S=0;S<Y;++S)for(Ie=0;Ie<V;++Ie)G&&(G[c+S*ee+Ie]=D.GetValue(S*V+Ie));N&&(H.attributes.position=r?Ee:new THREE.InterleavedBufferAttribute(W,V,0,!1)),$+=V}if(0<X)if(k)for(S=0;S<X;++S)for(Ie=0;Ie<j;++Ie)e.readByte();else{for(S=0;S<X;++S)for(Ie=0;Ie<j;++Ie)G?G[c+S*ee+$+Ie]=e.readByte()*(1/255):e.readByte();N&&(H.attributes.color=r?a:new THREE.InterleavedBufferAttribute(W,j,$,!1)),$+=j}if(0<Z)if(B)for(S=0;S<Z;++S)for(Ie=0;Ie<U;++Ie)e.readFloat32();else{for(S=0;S<Z;++S)for(Ie=0;Ie<U;++Ie)G?G[c+S*ee+$+Ie]=e.readFloat32():e.readFloat32();N&&(H.attributes.uv=r?s:new THREE.InterleavedBufferAttribute(W,U,$,!1)),$+=U}if(0<q){for(S=0;S<q;++S)for(Ie=0;Ie<z;++Ie)G&&(G[c+S*ee+$+Ie]=T.GetValue(S*z+Ie));N&&(H.attributes.normal=r?l:new THREE.InterleavedBufferAttribute(W,z,$,!1))}if(0<Q){var te=3*Q,ne=0;ne=r?(se=ye,we=be,c/ee):(we=N?(se=new(Y<=65535?Uint16Array:Uint32Array)(te),new THREE.BufferAttribute(se,1)):y?(H.index.array=new(Y<=65535?Uint16Array:Uint32Array)(te),se=H.index.array,H.index):se=null,0);for(var ie=new this.DracoModule.DracoInt32Array,re=0;re<Q;++re){b.GetFaceFromMesh(M,re,ie);var oe=3*re;se[oe]=ie.GetValue(0),se[1+oe]=ie.GetValue(1),se[2+oe]=ie.GetValue(2)}N&&(H.setIndex(we),H.drawRange.start=h,H.drawRange.count=te)}r&&(h+=3*Q,E*L<=(c+=Y*ee)&&(r=null,h=c=0))}else if(x==this.DracoModule.POINT_CLOUD){if(Y=M.num_points(),Q=w.length,N&&0<Y&&v.push(H),0<Y){var te=3*Y,ae=new Float32Array(te);for(re=0;re<te;++re)ae[re]=D.GetValue(re);N&&H.addAttribute("position",new THREE.BufferAttribute(ae,3))}if(0<Q){for(var se=new(Y<=65535?Uint16Array:Uint32Array)(Q),S=0;S<w.length;++S)se[S]=w[S];if(!1===Ue.OES_element_index_uint&&65535<Y&&0===nLineIndexSorted){var le=new Uint16Array(Q),de=0,ce=0,he=1,ue=0;for(re=0;re<Q-1;re+=2)se[re]<=65535*he&&se[re+1]<=65535*he?(ce+=2,le[re]=se[re]-de,le[re+1]=se[re+1]-de):(H.addDrawCall(ue,ce,de),ue=re,ce=0,re-=2,de+=65535*(++he-1));1!==he&&H.addDrawCall(ue,ce,de),H.setIndex(new THREE.BufferAttribute(le,1))}else N&&H.setIndex(new THREE.BufferAttribute(se,1))}}H.boundingBox||(J.equals(K)?(H.boundingBox=null,H.attributes.position&&H.computeBoundingBox()):H.boundingBox=new THREE.Box3(J,K)),this.DracoModule.destroy(D),-1!=C&&this.DracoModule.destroy(P),-1!=A&&this.DracoModule.destroy(T),-1!=O&&this.DracoModule.destroy(R),this.DracoModule.destroy(b),this.DracoModule.destroy(M),Ue.OES_element_index_uint,H.boundingSphere=null,N?t():y&&(r||t(H))}if(!m&&0<v.length){for(var fe=0,pe=0,S=0,me=v.length;S<me;++S)fe+=v[S].attributes.position.array.length,pe+=v[S].index.array.length;for(var ge=fe/3,ve=new Float32Array(fe),ye=new(ge<=65535?Uint16Array:Uint32Array)(pe),Ee=new THREE.BufferAttribute(ve,3),be=new THREE.BufferAttribute(ye,1),$=0,Me=0,S=0,me=v.length;S<me;++S){var xe=v[S].attributes.position,we=v[S].index;v[S].attributes.position=Ee,v[S].setIndex(be),v[S].drawRange.start=Me,v[S].drawRange.count=we.array.length;for(var ne=$/3,Ie=0,Se=we.array.length;Ie<Se;++Ie)ye[Me+Ie]=we.array[Ie]+ne;Me+=we.array.length;for(var Te=0,Ae=xe.array.length;Te<Ae;++Te)ve[$+Te]=xe.array[Te];$+=xe.array.length}}i&&i()},oe.prototype.readBIMBufferVersion7=function(e,t,n,i){for(var r=e.readInt32(),o=(e.readInt32(),e.readInt32()),a=[],s=(NDSWebViewer.Viewer.renderer.context,0);s<o;++s){var l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),h=e.readInt32(),u=e.readInt32(),f=new THREE.BufferGeometry,p=0<d?3:0,m=0<c?2:0,g=0<h?3:0,v=l/3;if(0<l&&(l=new Float32Array(l),e.readArrayFloat32(l),f.addAttribute("position",new THREE.BufferAttribute(l,3,0,!1))),0<d){for(var y=new Uint8Array(d),E=0;E<v;++E)y[12]=e.readByte(),y[13]=e.readByte(),y[14]=e.readByte(),y[15]=255;f.addAttribute("color",new THREE.BufferAttribute(y,p,0,!0))}if(0<c&&(c=new Float32Array(c),e.readArrayFloat32(c),f.addAttribute("uv",new THREE.BufferAttribute(c,m,0,!1))),0<h){var b=new Float32Array(h);if(4===u)for(var M=0;M<v;++M)b[3*M+0]=e.readFloat32(),b[3*M+1]=e.readFloat32(),b[3*M+2]=e.readFloat32();else{var x=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),w=void 0,I=1===u?1/255:1/65535;if(1===u)for(var S=0;S<v;++S){w=e.readByte(),--w;for(var T=0;T<g;++T){var A=e.readByte();b[3*S+T]=x[3*w+T]*A*I}}else if(2===u)for(var R=0;R<v;++R){w=e.readByte(),--w;for(var O=0;O<g;++O)b[3*R+O]=x[3*w+O]*e.readInt16()*I}}f.addAttribute("normal",new THREE.BufferAttribute(b,g,0,!1))}var P=e.readInt32(),C=e.readInt32(),B=e.readInt32();if(0<P){for(var L=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(P),D=0;D<P;++D)L[D]=e.readInt32();f.setIndex(new THREE.BufferAttribute(L,1)),f.attributes.normal}if(0<C){for(var H,N=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(C),F=f.getAttribute("position"),_=new Float32Array(F.count),k=new THREE.Vector3,V=new THREE.Vector3,j=new THREE.Vector3,U=0,z=0;z<C;z+=2)N[z]=e.readInt32(),N[z+1]=e.readInt32(),k.fromBufferAttribute(F,N[z]),V.fromBufferAttribute(F,N[z+1]),H=V.distanceTo(k),0!=z&&k.equals(j)?(_[N[z]]=_[U],_[N[z+1]]=H+_[N[z]]):_[N[z+1]]=H,j.copy(V),U=N[z+1];f.addAttribute("lineIndices",new THREE.BufferAttribute(N,1)),f.addAttribute("lineDistance",new THREE.BufferAttribute(_,1))}if(0<B){for(var G=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(B),W=0;W<B;++W)G[W]=e.readInt32();f.addAttribute("pointIndices",new THREE.BufferAttribute(G,1))}a[s]=f}for(var Y=new THREE.Vector3,X=new THREE.Vector3,Z=0;Z<r;++Z){var q=e.readInt32();Y.x=e.readFloat32(),Y.y=e.readFloat32(),Y.z=e.readFloat32(),X.x=e.readFloat32(),X.y=e.readFloat32(),X.z=e.readFloat32();var Q=e.readInt32(),J=e.readInt32(),K=e.readInt32(),$=n[Z];$.geomType;Q=a[Q];Q.attributes.position&&($.attributes.position=Q.attributes.position),Q.attributes.normal&&($.attributes.normal=Q.attributes.normal),Q.attributes.color&&($.attributes.color=Q.attributes.color),Q.attributes.lineDistance&&($.attributes.lineDistance=Q.attributes.lineDistance),Q.uv,Q.normal,Q.validEntities,0===q?($.isTriangles=!0,Q.index?($.setIndex(Q.index),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)):1===q?($.isLines=!0,Q.attributes.lineIndices?($.setIndex(Q.attributes.lineIndices),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)):2===q&&($.isPoints=!0,Q.attributes.pointIndices?($.setIndex(Q.attributes.pointIndices),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)),(!$.boundingBox||$.boundingBox.min.x>$.boundingBox.max.x||$.boundingBox.min.y>$.boundingBox.max.y||$.boundingBox.min.z>$.boundingBox.max.z)&&Y.equals(X)?($.boundingBox=null,$.attributes.position&&$.computeBoundingBox()):$.boundingBox.set(Y,X),0===q&&$.attributes.normal,$.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion8=function(e,t,n,i){for(var r=e.readInt32(),o=(e.readInt32(),e.readInt32()),a=[],s=(NDSWebViewer.Viewer.renderer.context,0);s<o;++s){var l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),h=e.readInt32(),u=e.readInt32(),f=new THREE.BufferGeometry,p=0<d?3:0,m=0<c?2:0,g=0<h?3:0,v=l/3;if(0<l&&(l=new Float32Array(l),e.readArrayFloat32(l),f.addAttribute("position",new THREE.BufferAttribute(l,3,0,!1))),0<d){for(var y=new Uint8Array(d),E=0;E<v;++E)y[12]=e.readByte(),y[13]=e.readByte(),y[14]=e.readByte(),y[15]=255;f.addAttribute("color",new THREE.BufferAttribute(y,p,0,!0))}if(0<c&&(c=new Float32Array(c),e.readArrayFloat32(c),f.addAttribute("uv",new THREE.BufferAttribute(c,m,0,!1))),0<h){var b=new Float32Array(h);if(4===u)for(var M=0;M<v;++M)b[3*M+0]=e.readFloat32(),b[3*M+1]=e.readFloat32(),b[3*M+2]=e.readFloat32();else{var x=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),w=void 0,I=1===u?1/255:1/65535;if(1===u)for(var S=0;S<v;++S){w=e.readByte(),--w;for(var T=0;T<g;++T){var A=e.readByte();b[3*S+T]=x[3*w+T]*A*I}}else if(2===u)for(var R=0;R<v;++R){w=e.readByte(),--w;for(var O=0;O<g;++O)b[3*R+O]=x[3*w+O]*e.readInt16()*I}}f.addAttribute("normal",new THREE.BufferAttribute(b,g,0,!1))}var P=e.readInt32(),C=e.readInt32(),B=e.readInt32();if(0<P){for(var L=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(P),D=0;D<P;++D)L[D]=65535<v?e.readInt32():256<v?e.readUInt16():e.readUInt8();f.setIndex(new THREE.BufferAttribute(L,1)),f.attributes.normal}if(0<C){for(var H,N=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(C),F=f.getAttribute("position"),_=new Float32Array(F.count),k=new THREE.Vector3,V=new THREE.Vector3,j=new THREE.Vector3,U=0,z=0;z<C;z+=2)N[z]=65535<v?e.readInt32():256<v?e.readUInt16():e.readUInt8(),N[z+1]=65535<v?e.readInt32():256<v?e.readUInt16():e.readUInt8(),k.fromBufferAttribute(F,N[z]),V.fromBufferAttribute(F,N[z+1]),H=V.distanceTo(k),0!=z&&k.equals(j)?(_[N[z]]=_[U],_[N[z+1]]=H+_[N[z]]):_[N[z+1]]=H,j.copy(V),U=N[z+1];f.addAttribute("lineIndices",new THREE.BufferAttribute(N,1)),f.addAttribute("lineDistance",new THREE.BufferAttribute(_,1))}if(0<B){for(var G=new(65535<v?Uint32Array:256<v?Uint16Array:Uint8Array)(B),W=0;W<B;++W)G[W]=65535<v?e.readInt32():256<v?e.readUInt16():e.readUInt8();f.addAttribute("pointIndices",new THREE.BufferAttribute(G,1))}a[s]=f}for(var Y=new THREE.Vector3,X=new THREE.Vector3,Z=0;Z<r;++Z){var q=e.readInt32();Y.x=e.readFloat32(),Y.y=e.readFloat32(),Y.z=e.readFloat32(),X.x=e.readFloat32(),X.y=e.readFloat32(),X.z=e.readFloat32();var Q=e.readInt32(),J=e.readInt32(),K=e.readInt32(),$=n[Z];$.geomType;Q=a[Q];Q.attributes.position&&($.attributes.position=Q.attributes.position),Q.attributes.normal&&($.attributes.normal=Q.attributes.normal),Q.attributes.color&&($.attributes.color=Q.attributes.color),Q.attributes.lineDistance&&($.attributes.lineDistance=Q.attributes.lineDistance),Q.uv,Q.normal,Q.validEntities,0===q?($.isTriangles=!0,Q.index?($.setIndex(Q.index),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)):1===q?($.isLines=!0,Q.attributes.lineIndices?($.setIndex(Q.attributes.lineIndices),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)):2===q&&($.isPoints=!0,Q.attributes.pointIndices?($.setIndex(Q.attributes.pointIndices),$.drawRange.start=J,$.drawRange.count=K):($.drawRange.start=-J,$.drawRange.count=-K)),(!$.boundingBox||$.boundingBox.min.x>$.boundingBox.max.x||$.boundingBox.min.y>$.boundingBox.max.y||$.boundingBox.min.z>$.boundingBox.max.z)&&Y.equals(X)?($.boundingBox=null,$.attributes.position&&$.computeBoundingBox()):$.boundingBox.set(Y,X),0===q&&$.attributes.normal,$.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion7_=function(e,t,n,i){for(var r=e.readInt32(),o=(e.readInt32(),e.readInt32()),a=[],s=0;s<o;++s){var l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),h=e.readInt32(),u=e.readInt32(),f=e.readInt32(),p={},m=0<d?3:0,g=0<c?2:0,v=0<h?3:0,y=0<u?1:0,E=l/3,b=new ArrayBuffer(4*l+4*d/3+4*c+4*h+4*u),M=3+(0<m?1:0)+g+v+y,x=M,w=4*M,I=new Float32Array(b),S=new Uint8Array(b),T=new Int32Array(b),A=new THREE.InterleavedBuffer(I,M),b=new THREE.InterleavedBuffer(w),x=new THREE.InterleavedBuffer(T,x);if(0<l){for(var R=0;R<E;++R){var O=R*M;I[0+O]=e.readFloat32(),I[1+O]=e.readFloat32(),I[2+O]=e.readFloat32()}p.position=new THREE.InterleavedBufferAttribute(A,3,0,!1)}if(0<d){for(var P=0;P<E;++P){var C=P*w+12;S[C]=e.readByte(),S[1+C]=e.readByte(),S[2+C]=e.readByte(),S[3+C]=255}p.color=new THREE.InterleavedBufferAttribute(b,m,12,!0)}if(0<c){for(var B=3+(0<m?1:0),L=0;L<E;++L){var D=L*M+B;I[D]=e.readFloat32(),I[1+D]=e.readFloat32()}p.uv=new THREE.InterleavedBufferAttribute(A,g,B,!1)}if(0<h){var H=3+(0<m?1:0)+g;if(4===f)for(var N=0;N<E;++N){var F=N*M+H;I[F]=e.readFloat32(),I[1+F]=e.readFloat32(),I[2+F]=e.readFloat32()}else{var _=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),k=void 0,V=1===f?1/255:1/65535;if(1===f)for(var j=0;j<E;++j){k=e.readByte(),--k;for(var U=j*M+H,z=0;z<v;++z){var G=e.readByte();I[U+z]=_[3*k+z]*G*V}}else if(2===f)for(var W=0;W<E;++W){k=e.readByte(),--k;for(var Y=W*M+H,X=0;X<v;++X)I[Y+X]=_[3*k+X]*e.readInt16()*V}}p.normal=new THREE.InterleavedBufferAttribute(A,v,H,!1)}if(0<u){for(var Z=3+(0<m?1:0)+g+v,q=0;q<E;++q)T[Z]=e.readInt32();p.validEntities=new THREE.InterleavedBufferAttribute(x,y,Z,!1)}var Q=e.readInt32(),J=e.readInt32(),K=e.readInt32();if(0<Q){p.faceIndices=new(65535<E?Uint32Array:256<E?Uint16Array:Uint8Array)(Q);for(var $=0;$<Q;++$)p.faceIndices[$]=e.readInt32()}if(0<J){p.lineIndices=new(65535<E?Uint32Array:256<E?Uint16Array:Uint8Array)(J);for(var ee=0;ee<J;++ee)p.lineIndices[ee]=e.readInt32()}if(0<K){p.pointIndices=new(65535<E?Uint32Array:256<E?Uint16Array:Uint8Array)(K);for(var te=0;te<K;++te)p.pointIndices[te]=e.readInt32()}a[s]=p}for(var ne=new THREE.Vector3,ie=new THREE.Vector3,re=0;re<r;++re){var oe=e.readInt32();ne.x=e.readFloat32(),ne.y=e.readFloat32(),ne.z=e.readFloat32(),ie.x=e.readFloat32(),ie.y=e.readFloat32(),ie.z=e.readFloat32();var ae=e.readInt32(),se=e.readInt32(),le=e.readInt32(),de=n[re],ae=a[ae];ae.position&&(de.attributes.position=ae.position),ae.color&&(de.attributes.color=ae.color),ae.uv&&(de.attributes.uv=ae.uv),ae.normal&&(de.attributes.normal=ae.normal),ae.validEntities&&(de.attributes.validEntity=ae.validEntities),0===oe?ae.faceIndices?(de.setIndex(new THREE.BufferAttribute(ae.faceIndices,1)),de.drawRange.start=se,de.drawRange.count=le):(de.drawRange.start=-se,de.drawRange.count=-le):1===oe?ae.lineIndices?(de.setIndex(new THREE.BufferAttribute(ae.lineIndices,1)),de.drawRange.start=se,de.drawRange.count=le):(de.drawRange.start=-se,de.drawRange.count=-le):2===oe&&(ae.pointIndices?(de.setIndex(new THREE.BufferAttribute(ae.pointIndices,1)),de.drawRange.start=se,de.drawRange.count=le):(de.drawRange.start=-se,de.drawRange.count=-le)),de.boundingBox||(ne.equals(ie)?(de.boundingBox=null,de.attributes.position&&de.computeBoundingBox()):de.boundingBox=new THREE.Box3(ne,ie)),0===oe&&null==de.attributes.normal&&de.computeVertexNormals(),de.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion6=function(e,t,n,i){for(var r,o,a,s,l,d,c,h,u,f,p,m,g,v=e.readInt32(),y=e.readInt32(),E=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),b=0,M=0,x=new Int8Array(v),w=new Int8Array(v),I=!1,S=0;S<v;++S)A=n[S],x[S]=A.index?0:1,w[S]=A.index&&!A.index.array?1:0,w[S]&&(I=!0);for(var T=[],S=0;S<v;++S){var A=n[S],R=e.readInt32(),O=x[S],P=w[S];if(100<=R){var C=e.readInt32(),B=e.readInt32(),L=e.readInt32(),D=e.readInt32(),H=e.readInt32(),N=(F=3)+(_=0<(B=0<B&&B!==C?0:B)?3:0)+(k=0<(L=0<L&&L!==C?0:L)?2:0)+(V=0<(D=0<D&&D!==C?0:D)?3:0);O?(u=new Float32Array(C*N),f=new THREE.InterleavedBuffer(u,N),be=new THREE.InterleavedBufferAttribute(f,F,0,!1),p=new THREE.InterleavedBufferAttribute(f,_,F,!1),m=new THREE.InterleavedBufferAttribute(f,k,F+_,!1),g=new THREE.InterleavedBufferAttribute(f,V,F+_+k,!1)):f=P?(A.attributes.position.data.array=new Float32Array(C*N),u=A.attributes.position.data.array,A.attributes.position.data):u=null,b=0,xe=O?(Ee=new(C<=65535?Uint16Array:Uint32Array)(3*H),new THREE.BufferAttribute(Ee,1)):P?(A.index.array=new(C<=65535?Uint16Array:Uint32Array)(3*H),Ee=A.index.array,A.index):Ee=null,M=0,--S}else{if(0===R){r=e.readInt32(),o=e.readInt32(),a=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),c=new THREE.Vector3,h=new THREE.Vector3,c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32();var F,_,k,V,j,U,z=0,G=(F=3)+(_=0<o?3:0)+(k=0<a?2:0)+(V=0<s?3:0),D=!1,H=!1;if(u?(0===B&&0<o&&(D=!0,G-=_),0===L&&0<a&&(H=!0,G-=k),j=u,U=f):(U=O?(j=new Float32Array(r*G),new THREE.InterleavedBuffer(j,G)):P?(A.attributes.position.data.array=new Float32Array(r*G),j=A.attributes.position.data.array,A.attributes.position.data):j=null,M=b=0),0<r){for(pe=0;pe<r;++pe)for(Re=0;Re<F;++Re)j?j[b+pe*G+Re]=e.readFloat32():e.readFloat32();O&&(A.attributes.position=u?be:new THREE.InterleavedBufferAttribute(U,F,0,!1)),z+=F}if(0<o)if(D)for(pe=0;pe<o;++pe)for(Re=0;Re<_;++Re)e.readByte();else{var W=1/255;for(pe=0;pe<o;++pe)for(Re=0;Re<_;++Re)j?j[b+pe*G+z+Re]=e.readByte()*W:e.readByte();O&&(A.attributes.color=u?p:new THREE.InterleavedBufferAttribute(U,_,z,!1)),z+=_}if(0<a)if(H)for(pe=0;pe<a;++pe)for(Re=0;Re<k;++Re)e.readFloat32();else{for(pe=0;pe<a;++pe)for(Re=0;Re<k;++Re)j?j[b+pe*G+z+Re]=e.readFloat32():e.readFloat32();O&&(A.attributes.uv=u?m:new THREE.InterleavedBufferAttribute(U,k,z,!1)),z+=k}if(0<s){if(4===d)for(re=0;re<s;++re)for(Re=0;Re<V;++Re)j?j[b+pe*G+z+Re]=e.readFloat32():e.readFloat32();else{var Y,W=1===d?1/255:1/65535;if(1===d)for(pe=0;pe<s;++pe)for(Y=e.readByte(),--Y,Re=0;Re<V;++Re){var X=e.readByte();j&&(j[b+pe*G+z+Re]=E[3*Y+Re]*X*W)}else if(2===d)for(pe=0;pe<s;++pe)for(Y=e.readByte(),--Y,Re=0;Re<V;++Re)j&&(j[b+pe*G+z+Re]=E[3*Y+Re]*e.readInt16()*W)}O&&(A.attributes.normal=u?g:new THREE.InterleavedBufferAttribute(U,V,z,!1))}if(0<l){var Z=e.readInt32(),q=3*l,Q=0;if(Q=u?(oe=Ee,Te=xe,b/G):(Te=O?(oe=new(r<=65535?Uint16Array:Uint32Array)(q),new THREE.BufferAttribute(oe,1)):P?(A.index.array=new(r<=65535?Uint16Array:Uint32Array)(q),oe=A.index.array,A.index):oe=null,0),1===Z)for(re=0;re<q;++re)oe?oe[M+re]=e.readByte():e.readByte();else if(2===Z)for(re=0;re<q;++re)oe?oe[M+re]=e.readInt16():e.readInt16();else if(4===Z)for(re=0;re<q;++re)oe?oe[M+re]=e.readInt32():e.readInt32();if(oe){ke.restoreIndices2(oe,M,q);for(var J=0;J<q;++J)oe[M+J]+=Q}O&&(A.setIndex(Te),A.drawRange.start=M,A.drawRange.count=q)}u&&(M+=3*l,C*N<=(b+=r*G)&&(u=null,M=b=0))}else if(1===R){if(r=e.readInt32(),l=e.readInt32(),O&&0<r&&T.push(A),c=new THREE.Vector3,h=new THREE.Vector3,c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),0<r){for(var K,q=3*r,$=new Float32Array(q),ee=new Float32Array(r),te=new THREE.Vector3,ne=new THREE.Vector3,ie=!1,re=0;re<r;++re)$[3*re]=e.readFloat32(),$[3*re+1]=e.readFloat32(),$[3*re+2]=e.readFloat32(),ne.copy(te),te.set($[3*re],$[3*re+1],$[3*re+2]),0!=re&&(re+1)%2!=0&&$[3*re]==$[3*(re-1)]&&$[3*re+1]==$[3*(re-1)+1]&&$[3*re+2]==$[3*(re-1)+2]&&(ee[re]=ee[re-1],ie=!0),(re+1)%2==0&&(K=te.distanceTo(ne),ie?(ee[re]=K+ee[re-1],ie=!1):ee[re]=K);"TextBufferGeometry"!=A.type&&O&&(A.addAttribute("position",new THREE.BufferAttribute($,3)),A.addAttribute("lineDistance",new THREE.BufferAttribute(ee,1)))}if(0<l){Z=e.readInt32();var oe=new(r<=65535?Uint16Array:Uint32Array)(l);if(1===Z)for(re=0;re<l;++re)oe[re]=e.readByte();else if(2===Z)for(re=0;re<l;++re)oe[re]=e.readInt16();else if(4===Z)for(re=0;re<l;++re)oe[re]=e.readInt32();if(0===y)for(re=1;re<l;++re)oe[re]+=oe[re-1];if(!1===Ue.OES_element_index_uint&&65535<r&&0===y){var ae=new Uint16Array(l),se=0,le=0,de=1,ce=0;for(re=0;re<l-1;re+=2)oe[re]<=65535*de&&oe[re+1]<=65535*de?(le+=2,ae[re]=oe[re]-se,ae[re+1]=oe[re+1]-se):(A.addDrawCall(ce,le,se),ce=re,le=0,re-=2,se+=65535*(++de-1));1!==de&&A.addDrawCall(ce,le,se),A.setIndex(new THREE.BufferAttribute(ae,1))}else O&&A.setIndex(new THREE.BufferAttribute(oe,1))}}A.boundingBox||(c.equals(h)?(A.boundingBox=null,A.attributes.position&&A.computeBoundingBox()):A.boundingBox=new THREE.Box3(c,h)),0===R&&null==A.attributes.normal&&A.computeVertexNormals(),!1===Ue.OES_element_index_uint&&0===R&&65535<r&&A.computeOffsets(),A.boundingSphere=null,O?t():P&&(u||t(A))}}if(!I&&0<T.length){for(var he=0,ue=0,fe=0,pe=0,me=T.length;pe<me;++pe)he+=T[pe].attributes.position.array.length,fe+=T[pe].attributes.lineDistance.array.length,ue+=T[pe].index.array.length;for(var ge=he/3,ve=new Float32Array(he),ye=new Float32Array(fe),Ee=new(ge<=65535?Uint16Array:Uint32Array)(ue),be=new THREE.BufferAttribute(ve,3),Me=new THREE.BufferAttribute(ye,1),xe=new THREE.BufferAttribute(Ee,1),z=0,we=0,Ie=0,pe=0,me=T.length;pe<me;++pe){var Se=T[pe].attributes.position,Te=T[pe].index,Ae=T[pe].attributes.lineDistance;T[pe].attributes.position=be,T[pe].attributes.lineDistance=Me,T[pe].setIndex(xe),T[pe].drawRange.start=we,T[pe].drawRange.count=Te.array.length;for(var Q=z/3,Re=0,Oe=Te.array.length;Re<Oe;++Re)Ee[we+Re]=Te.array[Re]+Q;we+=Te.array.length;for(var J=0,Pe=Se.array.length;J<Pe;++J)ve[z+J]=Se.array[J];z+=Se.array.length;for(J=0,Pe=Ae.array.length;J<Pe;++J)ye[Ie+J]=Ae.array[J];Ie+=Ae.array.length}}i&&i()},oe.prototype.readBIMBufferVersion5=function(e,t,n,i){for(var r,o,a,s,l,d,c,h,u=e.readInt32(),f=e.readInt32(),p=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),m=new Int8Array(u),g=new Int8Array(u),v=!1,y=0,E=0;E<n.length;++E)(o=n[E])&&o.isRawMeshEdge||(o?(m[y]=o.index?0:1,g[y]=o.index&&!o.index.array?1:0,g[y]&&(v=!0)):(m[y]=0,g[y]=0),y++);for(var b,M,x,w,I,S=[],T=0,E=0;E<u;++E){o=n[T],T++;var A=e.readInt32(),R=m[E],O=g[E];if(0===A){a=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),ce=e.readInt32(),M=e.readInt32(),x=e.readInt32(),c=e.readInt32(),h=e.readInt32(),w=new THREE.Vector3,I=new THREE.Vector3,w.x=e.readFloat32(),w.y=e.readFloat32(),w.z=e.readFloat32(),I.x=e.readFloat32(),I.y=e.readFloat32(),I.z=e.readFloat32();var P=0,C=(ae=3)+(se=0<s?3:0)+(le=0<l?2:0)+(de=0<d?3:0);if(J=R?(Q=new Float32Array(a*C),new THREE.InterleavedBuffer(Q,C)):O?(o.attributes.position.data.array=new Float32Array(a*C),Q=o.attributes.position.data.array,o.attributes.position.data):Q=null,0<a){for(Te=0;Te<a;++Te)for(Ne=0;Ne<ae;++Ne)Q?Q[0+Te*C+Ne]=e.readFloat32():e.readFloat32();R&&(o.attributes.position=new THREE.InterleavedBufferAttribute(J,ae,0,!1)),P+=ae}if(0<s){var B=1/255;for(Te=0;Te<s;++Te)for(Ne=0;Ne<se;++Ne)Q?Q[0+Te*C+P+Ne]=e.readByte()*B:e.readByte();R&&(o.attributes.color=new THREE.InterleavedBufferAttribute(J,se,P,!1)),P+=se}if(0<l){for(!1,Te=0;Te<l;++Te)for(Ne=0;Ne<le;++Ne)Q?Q[0+Te*C+P+Ne]=e.readFloat32():e.readFloat32();R&&(o.attributes.uv=new THREE.InterleavedBufferAttribute(J,le,P,!1)),P+=le}if(0<d){if(4===h)for(N=0;N<d;++N)for(Ne=0;Ne<de;++Ne)Q?Q[0+Te*C+P+Ne]=e.readFloat32():e.readFloat32();else{B=1===h?1/255:1/65535;if(1===h)for(Te=0;Te<d;++Te)for(ie=e.readByte(),--ie,Ne=0;Ne<de;++Ne){var L=e.readByte();Q&&(Q[0+Te*C+P+Ne]=p[3*ie+Ne]*L*B)}else if(2===h)for(Te=0;Te<d;++Te)for(ie=e.readByte(),--ie,Ne=0;Ne<de;++Ne)Q&&(Q[0+Te*C+P+Ne]=p[3*ie+Ne]*e.readInt16()*B)}R&&(o.attributes.normal=new THREE.InterleavedBufferAttribute(J,de,P,!1))}if(0<M){for(var D=M*ce,H=new Float32Array(D),N=0;N<D;N++)H[N]=e.readInt32();o.addAttribute("skinIndex",new THREE.BufferAttribute(H,ce))}if(0<x){var F=x*ce,_=new Float32Array(F);for(N=0;N<F;N++)_[N]=e.readFloat32();o.addAttribute("skinWeight",new THREE.BufferAttribute(_,ce))}if(0<c){b=e.readInt32();var k=3*c,V=0;if(He=R?(z=new(a<=65535?Uint16Array:Uint32Array)(k),new THREE.BufferAttribute(z,1)):O?(o.index.array=new(a<=65535?Uint16Array:Uint32Array)(k),z=o.index.array,o.index):z=null,V=0,1===b)for(N=0;N<k;++N)z?z[0+N]=e.readByte():e.readByte();else if(2===b)for(N=0;N<k;++N)z?z[0+N]=e.readInt16():e.readInt16();else if(4===b)for(N=0;N<k;++N)z?z[0+N]=e.readInt32():e.readInt32();if(z){ke.restoreIndices2(z,0,k);for(var j=0;j<k;++j)z[0+j]+=V}R&&(o.setIndex(He),o.drawRange.start=0,o.drawRange.count=k)}}else if(1===A){if(a=e.readInt32(),q=e.readInt32(),R&&0<a&&S.push(o),w=new THREE.Vector3,I=new THREE.Vector3,w.x=e.readFloat32(),w.y=e.readFloat32(),w.z=e.readFloat32(),I.x=e.readFloat32(),I.y=e.readFloat32(),I.z=e.readFloat32(),0<a){var k=3*a,U=new Float32Array(k);for(N=0;N<k;++N)U[N]=e.readFloat32();"TextBufferGeometry"!=o.type&&R&&o.addAttribute("position",new THREE.BufferAttribute(U,3))}if(0<q){b=e.readInt32();var z=new(a<=65535?Uint16Array:Uint32Array)(q);if(1===b)for(N=0;N<q;++N)z[N]=e.readByte();else if(2===b)for(N=0;N<q;++N)z[N]=e.readInt16();else if(4===b)for(N=0;N<q;++N)z[N]=e.readInt32();if(0===f)for(N=1;N<q;++N)z[N]+=z[N-1];if(!1===Ue.OES_element_index_uint&&65535<a&&0===f){var G=new Uint16Array(q),W=0,Y=0,X=1,Z=0;for(N=0;N<q-1;N+=2)z[N]<=65535*X&&z[N+1]<=65535*X?(Y+=2,G[N]=z[N]-W,G[N+1]=z[N+1]-W):(o.addDrawCall(Z,Y,W),Z=N,Y=0,N-=2,W+=65535*(++X-1));1!==X&&o.addDrawCall(Z,Y,W),o.setIndex(new THREE.BufferAttribute(G,1))}else R&&o.setIndex(new THREE.BufferAttribute(z,1))}else if(R&&0<a){var q=2*a-2,z=new(a<=65535?Uint16Array:Uint32Array)(q);for(N=0;N<a-1;N++)z[2*N]=N,z[2*N+1]=N+1;o.setIndex(new THREE.BufferAttribute(z,1))}}else if(2===A){if(0<(a=e.readInt32())){k=3*a,U=new Float32Array(k);for(N=0;N<k;++N)U[N]=e.readFloat32();o instanceof NdsPointGeometry&&(o.vertices=U)}}else if(3===A){a=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),q=e.readInt32(),h=e.readInt32(),w=new THREE.Vector3,I=new THREE.Vector3,w.x=e.readFloat32(),w.y=e.readFloat32(),w.z=e.readFloat32(),I.x=e.readFloat32(),I.y=e.readFloat32(),I.z=e.readFloat32();var Q,J,K,$,ee,te,ne,P=0,C=(ae=3)+(se=0<s?3:0)+(le=0<l?2:0)+(de=0<d?3:0),k=0;if(0<a)for(k=3*a,K=new Float32Array(k),Te=0;Te<k;++Te)K[Te]=e.readFloat32();if(0<s){B=1/255;for(k=3*s,$=new Float32Array(k),Te=0;Te<k;++Te)$[Te]=e.readByte()*B}if(0<l)for(k=2*l,ee=new Float32Array(k),Te=0;Te<k;++Te)ee[Te]=e.readByte()*B;if(0<d)if(k=3*d,te=new Float32Array(k),4===h)for(Te=0;Te<k;++Te)te[Te]=e.readFloat32();else{var ie,B=1===h?1/255:1/65535;if(1===h)for(Te=0;Te<d;++Te)for(ie=e.readByte(),--ie,Ne=0;Ne<3;++Ne)te[3*Te+Ne]=p[3*ie+Ne]*e.readByte()*B;else if(2===h)for(Te=0;Te<d;++Te)for(ie=e.readByte(),--ie,Ne=0;Ne<3;++Ne)te[3*Te+Ne]=p[3*ie+Ne]*e.readInt16()*B}if(0<c){b=e.readInt32();var re=3*c,oe=new(a<=65535?Uint16Array:Uint32Array)(re);if(1===b)for(N=0;N<re;++N)oe[N]=e.readByte();else if(2===b)for(N=0;N<re;++N)oe[N]=e.readInt16();else if(4===b)for(N=0;N<re;++N)oe[N]=e.readInt32()}if(0<q)if(b=e.readInt32(),ne=new(a<=65535?Uint16Array:Uint32Array)(q),1===b)for(N=0;N<q;++N)ne[N]=e.readByte();else if(2===b)for(N=0;N<q;++N)ne[N]=e.readInt16();else if(4===b)for(N=0;N<q;++N)ne[N]=e.readInt32();if(0<c){var ae,se,le,de,C=(ae=3)+(se=0<s?3:0)+(le=0<l?2:0)+(de=3),ce=3*c;if(R?(Q=new Float32Array(ce*C),J=new THREE.InterleavedBuffer(Q,C),z=new(ce<=65535?Uint16Array:Uint32Array)(ce),He=new THREE.BufferAttribute(z,1)):O&&(o.attributes.position.data.array=new Float32Array(ce*C),Q=o.attributes.position.data.array,J=o.attributes.position.data,o.index.array=new(ce<=65535?Uint16Array:Uint32Array)(ce),z=o.index.array,He=o.index),R||O){var he,ue,fe,pe,me,P=0,ge=new THREE.Vector3,ve=new THREE.Vector3,ye=new THREE.Vector3,Ee=new THREE.Vector3,be=new THREE.Vector3,Me=new THREE.Vector3,xe=new Float32Array(3);for(N=0;N<c;++N){if(0<d)for(var we=0;we<3;++we)xe[we]=te[3*N+we];else fe=oe[3*N+0],pe=oe[3*N+1],me=oe[3*N+2],ge.set(K[3*fe],K[3*fe+1],K[3*fe+2]),ve.set(K[3*pe],K[3*pe+1],K[3*pe+2]),ye.set(K[3*me],K[3*me+1],K[3*me+2]),Ee.subVectors(ve,ge),be.subVectors(ye,ge),Me.crossVectors(Ee,be),Me.normalize(),Me.toArray(xe);for(r=0;r<3;++r){ue=oe[3*N+r],z[he=3*N+r]=he;for(we=0;we<ae;++we)Q[he*C+we]=K[ue*ae+we];if(0<se){P=ae;for(we=0;we<se;++we)Q[he*C+P+we]=$[ue*se+we]}if(0<le){P=ae+se;for(we=0;we<le;++we)Q[he*C+P+we]=ee[ue*le+we]}P=ae+se+le;for(we=0;we<de;++we)Q[he*C+P+we]=xe[we]}}R&&(o.attributes.position=new THREE.InterleavedBufferAttribute(J,ae,0,!1),0<se&&(P=ae,o.attributes.color=new THREE.InterleavedBufferAttribute(J,se,P,!1)),0<le&&(P=ae+se,o.attributes.uv=new THREE.InterleavedBufferAttribute(J,le,P,!1)),0<de&&(P=ae+se+le,o.attributes.normal=new THREE.InterleavedBufferAttribute(J,de,P,!1)),o.setIndex(He),o.drawRange.start=0,o.drawRange.count=ce)}}o=n[T],T++,q&&R&&(o.addAttribute("position",new THREE.BufferAttribute(K,3)),He=new THREE.BufferAttribute(ne,1),o.setIndex(He),o.drawRange.start=0,o.drawRange.count=q)}o&&(2!=A&&(o.boundingBox||(w.equals(I)?(o.boundingBox=null,o.attributes.position&&o.computeBoundingBox()):o.boundingBox=new THREE.Box3(w,I))),0===A&&void 0!==o.attributes&&null==o.attributes.normal&&"TextBufferGeometry"!=o.type&&o.computeVertexNormals(),!1===Ue.OES_element_index_uint&&0===A&&65535<a&&o.computeOffsets(),o.boundingSphere=null,R?t():O&&t(o))}if(!v&&0<S.length){for(var Ie=0,Se=0,Te=0,Ae=S.length;Te<Ae;++Te)Ie+=S[Te].attributes.position.array.length,Se+=S[Te].index.array.length;for(var Re=Ie/3,Oe=new Float32Array(Ie),Pe=new(Re<=65535?Uint16Array:Uint32Array)(Se),Ce=new THREE.BufferAttribute(Oe,3),Be=new THREE.BufferAttribute(Pe,1),P=0,Le=0,Te=0,Ae=S.length;Te<Ae;++Te){var De=S[Te].attributes.position,He=S[Te].index;S[Te].attributes.position=Ce,S[Te].setIndex(Be),S[Te].drawRange.start=Le,S[Te].drawRange.count=He.array.length;for(var V=P/3,Ne=0,Fe=He.array.length;Ne<Fe;++Ne)Pe[Le+Ne]=He.array[Ne]+V;Le+=He.array.length;for(var j=0,_e=De.array.length;j<_e;++j)Oe[P+j]=De.array[j];P+=De.array.length}}i&&i()},oe.prototype.readBIMBufferVersion4=function(e,t,n,i){for(var r,o,a,s,l,d,c,h,u,f,p=e.readInt32(),m=e.readInt32(),g=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),v=0;v<p;++v){if(r=n[v],0===(h=e.readInt32())){if(o=e.readInt32(),a=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),u=new THREE.Vector3,f=new THREE.Vector3,u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),f.x=e.readFloat32(),f.y=e.readFloat32(),f.z=e.readFloat32(),0<o){for(var y=3*o,E=new Float32Array(y),b=0;b<y;++b)E[b]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(E,3))}if(0<a){var y=3*a,M=new Float32Array(y),x=1/255;for(b=0;b<y;++b)M[b]=e.readByte()*x;r.addAttribute("color",new THREE.BufferAttribute(M,3))}if(0<s){var y=2*s,w=new Float32Array(y);for(b=0;b<y;++b)w[b]=e.readFloat32();r.addAttribute("uv",new THREE.BufferAttribute(w,2))}if(0<l)if(4===c){var y=3*l,I=new Float32Array(y);for(b=0;b<y;++b)I[b]=e.readFloat32();r.addAttribute("normal",new THREE.BufferAttribute(I,3))}else{var S,x=1===c?1/255:1/65535,I=new Float32Array(3*l);if(1===c)for(b=0;b<l;++b){S=e.readByte(),--S;var T=e.readByte();I[3*b]=g[3*S]*T*x,T=e.readByte(),I[3*b+1]=g[3*S+1]*T*x,T=e.readByte(),I[3*b+2]=g[3*S+2]*T*x}else if(2===c)for(b=0;b<l;++b)S=e.readByte(),--S,I[3*b]=g[3*S]*e.readInt16()*x,I[3*b+1]=g[3*S+1]*e.readInt16()*x,I[3*b+2]=g[3*S+2]*e.readInt16()*x;r.addAttribute("normal",new THREE.BufferAttribute(I,3))}if(0<d){var A=e.readInt32(),y=3*d,R=new(o<=65535?Uint16Array:Uint32Array)(y);if(1===A)for(b=0;b<y;++b)R[b]=e.readByte();else if(2===A)for(b=0;b<y;++b)R[b]=e.readInt16();else if(4===A)for(b=0;b<y;++b)R[b]=e.readInt32();ke.restoreIndices(R,R.length),r.setIndex(new THREE.BufferAttribute(R,1))}}else if(1===h){if(o=e.readInt32(),d=e.readInt32(),u=new THREE.Vector3,f=new THREE.Vector3,u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),f.x=e.readFloat32(),f.y=e.readFloat32(),f.z=e.readFloat32(),0<o){y=3*o,E=new Float32Array(y);for(b=0;b<y;++b)E[b]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(E,3))}if(0<d){A=e.readInt32();R=new(o<=65535?Uint16Array:Uint32Array)(d);if(1===A)for(b=0;b<d;++b)R[b]=e.readByte();else if(2===A)for(b=0;b<d;++b)R[b]=e.readInt16();else if(4===A)for(b=0;b<d;++b)R[b]=e.readInt32();if(0===m)for(b=1;b<d;++b)R[b]+=R[b-1];if(!1===Ue.OES_element_index_uint&&65535<o&&0===m){var O=new Uint16Array(d),P=0,C=0,B=1,L=0;for(b=0;b<d-1;b+=2)R[b]<=65535*B&&R[b+1]<=65535*B?(C+=2,O[b]=R[b]-P,O[b+1]=R[b+1]-P):(r.addDrawCall(L,C,P),L=b,C=0,b-=2,P+=65535*(++B-1));1!==B&&r.addDrawCall(L,C,P),r.setIndex(new THREE.BufferAttribute(O,1))}else r.setIndex(new THREE.BufferAttribute(R,1))}}r.boundingBox||(u.equals(f)?r.attributes.position&&r.computeBoundingBox():r.boundingBox=new THREE.Box3(u,f)),0===h&&null==r.attributes.normal&&r.computeVertexNormals(),!1===Ue.OES_element_index_uint&&0===h&&65535<o&&r.computeOffsets(),r.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion3=function(e,t,n,i){for(var r,o,a,s,l,d,c,h,u,f=e.readInt32(),p=e.readInt32(),m=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),g=0;g<f;++g){if(r=n[g],0===(c=e.readInt32())){if(o=e.readInt32(),a=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),h=new THREE.Vector3,u=new THREE.Vector3,h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),0<o){for(var v=3*o,y=new Float32Array(v),E=0;E<v;++E)y[E]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(y,3))}if(0<a){var v=2*a,b=new Float32Array(v);for(E=0;E<v;++E)b[E]=e.readFloat32();r.addAttribute("uv",new THREE.BufferAttribute(b,2))}if(0<s)if(4===d){var v=3*s,M=new Float32Array(v);for(E=0;E<v;++E)M[E]=e.readFloat32();r.addAttribute("normal",new THREE.BufferAttribute(M,3))}else{var x,w=1===d?1/255:1/65535,M=new Float32Array(3*s);if(1===d)for(E=0;E<s;++E){x=e.readByte(),--x;var I=e.readByte();M[3*E]=m[3*x]*I*w,I=e.readByte(),M[3*E+1]=m[3*x+1]*I*w,I=e.readByte(),M[3*E+2]=m[3*x+2]*I*w}else if(2===d)for(E=0;E<s;++E)x=e.readByte(),--x,M[3*E]=m[3*x]*e.readInt16()*w,M[3*E+1]=m[3*x+1]*e.readInt16()*w,M[3*E+2]=m[3*x+2]*e.readInt16()*w;r.addAttribute("normal",new THREE.BufferAttribute(M,3))}if(0<l){var S=e.readInt32(),v=3*l,T=new(o<=65535?Uint16Array:Uint32Array)(v);if(1===S)for(E=0;E<v;++E)T[E]=e.readByte();else if(2===S)for(E=0;E<v;++E)T[E]=e.readInt16();else if(4===S)for(E=0;E<v;++E)T[E]=e.readInt32();ke.restoreIndices(T,T.length),r.setIndex(new THREE.BufferAttribute(T,1))}}else if(1===c){if(o=e.readInt32(),l=e.readInt32(),h=new THREE.Vector3,u=new THREE.Vector3,h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),0<o){v=3*o,y=new Float32Array(v);for(E=0;E<v;++E)y[E]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(y,3))}if(0<l){S=e.readInt32();T=new(o<=65535?Uint16Array:Uint32Array)(l);if(1===S)for(E=0;E<l;++E)T[E]=e.readByte();else if(2===S)for(E=0;E<l;++E)T[E]=e.readInt16();else if(4===S)for(E=0;E<l;++E)T[E]=e.readInt32();if(0===p)for(E=1;E<l;++E)T[E]+=T[E-1];if(!1===Ue.OES_element_index_uint&&65535<o&&0===p){var A=new Uint16Array(l),R=0,O=0,P=1,C=0;for(E=0;E<l-1;E+=2)T[E]<=65535*P&&T[E+1]<=65535*P?(O+=2,A[E]=T[E]-R,A[E+1]=T[E+1]-R):(r.addDrawCall(C,O,R),C=E,O=0,E-=2,R+=65535*(++P-1));1!==P&&r.addDrawCall(C,O,R),r.setIndex(new THREE.BufferAttribute(A,1))}else r.setIndex(new THREE.BufferAttribute(T,1))}}r.boundingBox||(h.equals(u)?r.attributes.position&&r.computeBoundingBox():r.boundingBox=new THREE.Box3(h,u)),0===c&&null==r.attributes.normal&&r.computeVertexNormals(),!1===Ue.OES_element_index_uint&&0===c&&65535<o&&r.computeOffsets(),r.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion2=function(e,t,n,i){for(var r,o,a,s,l,d,c,h=e.readInt32(),u=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),f=0;f<h;++f){if(r=n[f],0===(l=e.readInt32())){if(o=e.readInt32(),e.readInt32(),a=e.readInt32(),s=e.readInt32(),x=e.readInt32(),d=new THREE.Vector3,c=new THREE.Vector3,d.x=e.readFloat32(),d.y=e.readFloat32(),d.z=e.readFloat32(),c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),0<o){for(var p=3*o,m=new Float32Array(p),g=0;g<p;++g)m[g]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(m,3))}if(0<a)if(4===x){var p=3*a,v=new Float32Array(p);for(g=0;g<p;++g)v[g]=e.readFloat32();r.addAttribute("normal",new THREE.BufferAttribute(v,3))}else{var y,E=1===x?1/255:1/65535,v=new Float32Array(3*a);if(1===x)for(g=0;g<a;++g){y=e.readByte(),--y;var b=e.readByte();v[3*g]=u[3*y]*b*E,b=e.readByte(),v[3*g+1]=u[3*y+1]*b*E,b=e.readByte(),v[3*g+2]=u[3*y+2]*b*E}else if(2===x)for(g=0;g<a;++g)y=e.readByte(),--y,v[3*g]=u[3*y]*e.readInt16()*E,v[3*g+1]=u[3*y+1]*e.readInt16()*E,v[3*g+2]=u[3*y+2]*e.readInt16()*E;r.addAttribute("normal",new THREE.BufferAttribute(v,3))}if(x=e.readInt32(),0<s){var p=3*s,M=new(o<=65535?Uint16Array:Uint32Array)(p);if(1===x)for(g=0;g<p;++g)M[g]=e.readByte();else if(2===x)for(g=0;g<p;++g)M[g]=e.readInt16();else if(4===x)for(g=0;g<p;++g)M[g]=e.readInt32();ke.restoreIndices(M,M.length),r.setIndex(new THREE.BufferAttribute(M,1))}}else if(1===l){if(o=e.readInt32(),s=e.readInt32(),d=new THREE.Vector3,c=new THREE.Vector3,d.x=e.readFloat32(),d.y=e.readFloat32(),d.z=e.readFloat32(),c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),0<o){p=3*o,m=new Float32Array(p);for(g=0;g<p;++g)m[g]=e.readFloat32();r.addAttribute("position",new THREE.BufferAttribute(m,3))}if(0<s){var x=e.readInt32(),M=new(o<=65535?Uint16Array:Uint32Array)(s);if(1===x)for(g=0;g<s;++g)M[g]=e.readByte();else if(2===x)for(g=0;g<s;++g)M[g]=e.readInt16();else if(4===x)for(g=0;g<s;++g)M[g]=e.readInt32();for(g=1;g<s;++g)M[g]+=M[g-1];if(!1===Ue.OES_element_index_uint&&65535<o){var w=new Uint16Array(s),I=0,S=0,T=1,A=0;for(g=0;g<s-1;g+=2)M[g]<=65535*T&&M[g+1]<=65535*T?(S+=2,w[g]=M[g]-I,w[g+1]=M[g+1]-I):(r.addDrawCall(A,S,I),A=g,S=0,g-=2,I+=65535*(++T-1));1!==T&&r.addDrawCall(A,S,I),r.setIndex(new THREE.BufferAttribute(w,1))}else r.setIndex(new THREE.BufferAttribute(M,1))}}r.boundingBox||(d.equals(c)?r.computeBoundingBox():r.boundingBox=new THREE.Box3(d,c)),0===l&&null==r.attributes.normal&&r.computeVertexNormals(),!1===Ue.OES_element_index_uint&&0===l&&65535<o&&r.computeOffsets(),r.boundingSphere=null,t()}i&&i()},oe.prototype.readBIMBufferVersion1=function(e,t,n,i){for(var r,o,a,s,l,d,c,h,u,f,p,m,g,v,y,E,b,M,x=e.readInt32(),w=[],I=[],S=0;S<x;++S){for(w=[],I=[],(p=n[S]).faceVertexUvs[0]=[],m=e.readInt32(),g=e.readInt32(),v=e.readInt32(),y=e.readInt32(),E=m<=255?1:m<=65535?2:4,b=g<=255?1:g<=65535?2:4,M=v<=255?1:v<=65535?2:4,r=0;r<m;++r)(c=new THREE.Vector3).x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),p.vertices.push(c);for(r=0;r<g;++r)(f=new THREE.Vector2).x=e.readFloat32(),f.y=e.readFloat32(),I.push(f);for(r=0;r<v;++r)(u=new THREE.Vector3).x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),w.push(u);for(o=0;o<y;++o){if(s=(h=e.readByte())&8,l=h&16,d=h&32,h=new THREE.Face3,1==E?(h.a=e.readByte(),h.b=e.readByte(),h.c=e.readByte()):2==E?(h.a=e.readInt16(),h.b=e.readInt16(),h.c=e.readInt16()):(h.a=e.readInt32(),h.b=e.readInt32(),h.c=e.readInt32()),a=p.faces.length,0!=s)for(r=0;r<1;r++)p.faceVertexUvs[r][a]=[],1==b?(p.faceVertexUvs[r][a].push(I[e.readByte()]),p.faceVertexUvs[r][a].push(I[e.readByte()]),p.faceVertexUvs[r][a].push(I[e.readByte()])):2==b?(p.faceVertexUvs[r][a].push(I[e.readInt16()]),p.faceVertexUvs[r][a].push(I[e.readInt16()]),p.faceVertexUvs[r][a].push(I[e.readInt16()])):(p.faceVertexUvs[r][a].push(I[e.readInt32()]),p.faceVertexUvs[r][a].push(I[e.readInt32()]),p.faceVertexUvs[r][a].push(I[e.readInt32()]));l&&(h.normal=1==M?w[e.readByte()]:2==M?w[e.readInt16()]:w[e.readInt32()]),d&&(1==M?(h.vertexNormals.push(w[e.readByte()]),h.vertexNormals.push(w[e.readByte()]),h.vertexNormals.push(w[e.readByte()])):2==M?(h.vertexNormals.push(w[e.readInt16()]),h.vertexNormals.push(w[e.readInt16()]),h.vertexNormals.push(w[e.readInt16()])):(h.vertexNormals.push(w[e.readInt32()]),h.vertexNormals.push(w[e.readInt32()]),h.vertexNormals.push(w[e.readInt32()]))),p.faces.push(h)}this.computeGeometryFaceNormal(p),p.computeBoundingBox(),t()}i&&i()},oe.prototype.parseString=function(e,t,n){for(var i=new Uint8Array(e,t,n),r="",o=0;o<n;o++)r+=String.fromCharCode(i[t+o]);return r},oe.prototype.parseUChar8=function(e,t){return new Uint8Array(e,t,1)[0]},oe.prototype.parseUInt32=function(e,t){return new Uint32Array(e,t,1)[0]},oe.prototype.parseUInt16=function(e,t){return new Uint16Array(e,t,1)[0]},oe.prototype.parseInt32=function(e,t){e=new Uint8Array(e,t,4),t=255&e[0];return t|=(255&e[1])<<8,(t|=(255&e[2])<<16)|(255&e[3])<<24},oe.prototype.parseInt16=function(e,t){t=new Uint8Array(e,t,2);return 255&t[0]|(255&t[1])<<8},oe.prototype.parseFloat32Lzma=function(e,t){e=new Uint8Array(e,t,4),t=255&e[0];return t|=(255&e[1])<<8,(t|=(255&e[2])<<16)|(255&e[3])<<24},oe.prototype.readUuid=function(e){for(var t=[e.readInt32()>>>0,e.readInt32()>>>0,e.readInt32()>>>0,e.readInt32()>>>0],n="",i=0,i=0;i<4;++i){var r=t[i].toString(16);r.length<8&&(n+="00000000".slice(0,8-r.length)),n+=r}return n},oe.prototype.readUuid3=function(e){return(e.readInt32()>>>0).toString()},oe.prototype.readBvhV1=function(e,t){var n=e.readInt32();t.setNumNodes(n);for(var i,r,o=new Float32Array(6),a=0,s=0;s<n;++s){for(var l=0;l<6;++l)o[l]=e.readFloat32();i=e.readInt32(),a=e.readInt32(),r=e.readInt32(),t.setNode(s,o,i,a,r)}for(var d,c,a=e.readInt32(),h=new Int32Array(a),u=0;u<a;++u)h[u]=e.readInt32();t.setMeshIds(h),t.meshManager.setNumMeshes(a);for(u=0;u<a;++u){for(var f=this.readUuid(e),p=e.readInt32(),l=0;l<6;++l)o[l]=e.readFloat32();e.readInt32(),d=e.readInt32(),c=e.readInt32(),e.readInt32(),t.meshManager.setMeshFromGeomUuid(u,o,f,p,d,c)}for(var m=e.readInt32(),g=new THREE.Matrix4,v=0;v<m;++v)g.set(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());for(var y,E=e.readInt32(),b=[],l=0;l<E;++l)y=this.readUuid(e),b.push(y);t.meshManager.setMaterialUuids(b);for(var M,x=e.readInt32(),w=[],I=0;I<x;++I)M=this.readUuid(e),w.push(M);var S=e.readInt32();t.meshManager.setNumLineSegments(S);for(var T=0;T<S;++T)f=this.readUuid(e),e.readInt32(),c=e.readInt32(),e.readInt32(),t.meshManager.setLineSegmentsFromGeomUuid(T,f,c);t.meshManager.setBodyUuids(w)},oe.prototype.readBvhV2=function(e,t,n){var i=e.readInt32();t.setNumNodes(i);for(var r,o,a=new Float32Array(6),s=0,l=0;l<i;++l){for(var d=0;d<6;++d)a[d]=e.readFloat32();r=e.readInt32(),s=e.readInt32(),o=e.readInt32(),t.setNode(l,a,r,s,o)}for(var c,h,s=e.readInt32(),u=new Int32Array(s),f=0;f<s;++f)u[f]=e.readInt32();t.setMeshIds(u),t.meshManager.setNumMeshes(s);for(f=0;f<s;++f){for(var p=2<n?this.readUuid3(e):this.readUuid(e),m=e.readInt32(),d=0;d<6;++d)a[d]=e.readFloat32();e.readInt32(),c=e.readInt32(),h=e.readInt32(),e.readInt32(),t.meshManager.setMeshFromGeomUuid(f,a,p,m,c,h)}for(var g=e.readInt32(),v=new THREE.Matrix4,y=0;y<g;++y)v.set(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());for(var E,b=e.readInt32(),M=[],d=0;d<b;++d)E=2<n?this.readUuid3(e):this.readUuid(e),M.push(E);t.meshManager.setMaterialUuids(M);for(var x,w=e.readInt32(),I=[],S=0;S<w;++S)x=2<n?this.readUuid3(e):this.readUuid(e),I.push(x);var T=e.readInt32();t.meshManager.setNumLineSegments(T);for(var A=0;A<T;++A)p=2<n?this.readUuid3(e):this.readUuid(e),e.readInt32(),c=e.readInt32(),h=e.readInt32(),e.readInt32(),t.meshManager.setLineSegmentsFromGeomUuid(A,p,h,c);t.meshManager.setBodyUuids(I)},oe.prototype.readBvhV3=function(e,t){var n=e.readInt32();t.setNumNodes(n);for(var i,r,o,a,s,l,d=new Float32Array(6),c=0,h=0;h<n;++h){e.readInt32();for(var u=0;u<6;++u)d[u]=e.readFloat32();i=e.readInt32(),c=e.readInt32(),a=e.readInt32(),r=e.readInt32(),s=e.readInt32(),o=e.readInt32(),l=e.readInt32(),t.setNode(h,d,i,c,a,r,s,o,l)}for(var f,p=e.readInt32(),m=[],u=0;u<p;++u)f=0===this.materialIdType?this.readUuid3(e):this.readUuid(e),m.push(f);t.meshManager.setMaterialUuids(m);for(var g,v=e.readInt32(),y=[],E=0;E<v;++E)g=0===this.objectIdType?this.readUuid3(e):this.readUuid(e),y.push(g);for(var b,M,c=e.readInt32(),x=new Int32Array(c),w=0;w<c;++w)x[w]=w;t.setMeshIds(x),t.meshManager.setNumMeshes(c,!0,!1);for(var I=0;I<c;++I){for(var S=e.readInt32(),T=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),A=e.readInt32(),u=0;u<6;++u)d[u]=e.readFloat32();b=e.readInt32(),M=e.readInt32(),e.readInt32(),t.meshManager.setMeshFromGeomUuid(I,d,T,A,b,M,S,-1)}var R=e.readInt32();t.meshManager.setNumLineSegments(R,!0,!1);for(var O=0;O<R;++O)S=e.readInt32(),T=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),b=e.readInt32(),M=e.readInt32(),e.readInt32(),t.meshManager.setLineSegmentsFromGeomUuid(O,T,M,b,S,-1);var P=e.readInt32();t.meshManager.setNumTexts(P,!0,!1);for(var C=0;C<P;++C)S=e.readInt32(),T=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),b=e.readInt32(),M=e.readInt32(),e.readInt32(),t.meshManager.setTextFromGeomUuid(C,T,M,b,S,-1);t.meshManager.setBodyUuids(y)},oe.prototype.readBvhV4=function(e,t){var n=e.readInt32(),i=e.readByte();t.setNumNodes(n);for(var r,o,a,s,l,d,c=new Float32Array(6),h=0,u=0;u<n;++u){e.readInt32();for(var f=0;f<6;++f)c[f]=e.readFloat32();r=e.readInt32(),h=e.readInt32(),s=e.readInt32(),o=e.readInt32(),l=e.readInt32(),a=e.readInt32(),d=e.readInt32(),t.setNode(u,c,r,h,s,o,l,a,d)}var p=null;if(1===i)for(var m=e.readInt32(),p=new Float32Array(16*m),u=0;u<m;++u)for(f=0;f<16;++f)p[16*u+f]=e.readFloat32();for(var g,v=e.readInt32(),y=[],f=0;f<v;++f)g=0===this.materialIdType?this.readUuid3(e):this.readUuid(e),y.push(g);t.meshManager.setMaterialUuids(y);for(var E,b=e.readInt32(),M=[],x=0;x<b;++x)E=0===this.objectIdType?this.readUuid3(e):this.readUuid(e),M.push(E);for(var w,I,S,h=e.readInt32(),T=new Int32Array(h),A=0;A<h;++A)T[A]=A;t.setMeshIds(T),t.meshManager.setNumMeshes(h,!0,1===i);for(var R=0;R<h;++R){for(var O=e.readInt32(),P=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),C=e.readInt32(),f=0;f<6;++f)c[f]=e.readFloat32();w=e.readInt32(),I=e.readInt32(),e.readInt32(),S=-1,1===i&&(S=e.readInt32()),t.meshManager.setMeshFromGeomUuid(R,c,P,C,w,I,O,S)}var B=e.readInt32();t.meshManager.setNumLineSegments(B,!0,1===i);for(var L=0;L<B;++L)O=e.readInt32(),P=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),w=e.readInt32(),I=e.readInt32(),e.readInt32(),S=-1,1===i&&(S=e.readInt32()),t.meshManager.setLineSegmentsFromGeomUuid(L,P,I,w,O,S);var D=e.readInt32();t.meshManager.setNumTexts(D,!0,1===i);for(var H=0;H<D;++H)O=e.readInt32(),P=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),w=e.readInt32(),I=e.readInt32(),e.readInt32(),S=-1,1===i&&(S=e.readInt32()),t.meshManager.setTextFromGeomUuid(H,P,I,w,O,S);t.meshManager.setBodyUuids(M),1===i&&t.meshManager.setMatrixes(p)},oe.prototype.readBvh=function(e,t,n){e.readString();var i=e.readInt32();4===(t.version=i)?this.readBvhV4(e,t):1==i?this.readBvhV1(e,t):1<i&&this.readBvhV2(e,t,i),n&&n()},oe.prototype.DracoModule=DracoDecoderModule();function w(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}n(120);w.prototype={constructor:w,load:function(e,t,n,i){var r=this,o=new THREE.Texture,a=new THREE.FileLoader(this.manager);return a.setResponseType("arraybuffer"),a.load(e,function(e){o.image=r.parse(e),o.needsUpdate=!0,void 0!==t&&t(o)},n,i),o},parse:function(e){e.length<19&&console.error("TGALoader: Not enough data to contain header.");var t=new Uint8Array(e),n=0,m={id_length:t[n++],colormap_type:t[n++],image_type:t[n++],colormap_index:t[n++]|t[n++]<<8,colormap_length:t[n++]|t[n++]<<8,colormap_size:t[n++],origin:[t[n++]|t[n++]<<8,t[n++]|t[n++]<<8],width:t[n++]|t[n++]<<8,height:t[n++]|t[n++]<<8,pixel_size:t[n++],flags:t[n++]};!function(e){switch(e.image_type){case 1:case 9:(256<e.colormap_length||24!==e.colormap_size||1!==e.colormap_type)&&console.error("TGALoader: Invalid type colormap data for indexed type.");break;case 2:case 3:case 10:case 11:e.colormap_type&&console.error("TGALoader: Invalid type colormap data for colormap type.");break;case 0:console.error("TGALoader: No data.");default:console.error('TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('TGALoader: Invalid pixel size "%s".',e.pixel_size)}(m),m.id_length+18>e.length&&console.error("TGALoader: No data."),n+=m.id_length;var i=!1,r=!1,h=!1;switch(m.image_type){case 9:r=i=!0;break;case 1:r=!0;break;case 10:i=!0;break;case 2:break;case 11:h=i=!0;break;case 3:h=!0}t=function(e,t,n,i,r){var o,a=n.pixel_size>>3,s=n.width*n.height*a;if(t&&(o=r.subarray(i,i+=n.colormap_length*(n.colormap_size>>3))),e)for(var l,d,c,h=new Uint8Array(s),u=0,f=new Uint8Array(a);u<s;)if(d=1+(127&(l=r[i++])),128&l){for(c=0;c<a;++c)f[c]=r[i++];for(c=0;c<d;++c)h.set(f,u+c*a);u+=a*d}else{for(d*=a,c=0;c<d;++c)h[u+c]=r[i++];u+=d}else h=r.subarray(i,i+=t?n.width*n.height:s);return{pixel_data:h,palettes:o}}(i,r,m,n,t),t=function(e,t,n,i){var r,o,a,s,l,d,c=new Uint8Array(e*t*4);switch((48&m.flags)>>4){default:case 2:l=e,o=r=0,s=a=1,d=t;break;case 0:r=0,l=e,o=t-(a=1),d=s=-1;break;case 3:r=e-1,l=a=-1,o=0,s=1,d=t;break;case 1:r=e-1,o=t-1,d=s=l=a=-1}if(h)switch(m.pixel_size){case 8:!function(e,t,n,i,r,o,a,s){for(var l,d,c=0,h=m.width,u=t;u!==i;u+=n)for(d=r;d!==a;d+=o,c++)l=s[c],e[4*(d+h*u)+0]=l,e[4*(d+h*u)+1]=l,e[4*(d+h*u)+2]=l,e[4*(d+h*u)+3]=255}(c,o,s,d,r,a,l,n);break;case 16:!function(e,t,n,i,r,o,a,s){for(var l,d=0,c=m.width,h=t;h!==i;h+=n)for(l=r;l!==a;l+=o,d+=2)e[4*(l+c*h)+0]=s[d+0],e[4*(l+c*h)+1]=s[d+0],e[4*(l+c*h)+2]=s[d+0],e[4*(l+c*h)+3]=s[d+1]}(c,o,s,d,r,a,l,n);break;default:console.error("TGALoader: Format not supported.")}else switch(m.pixel_size){case 8:!function(e,t,n,i,r,o,a,s,l){for(var d,c,h=l,u=0,f=m.width,p=t;p!==i;p+=n)for(c=r;c!==a;c+=o,u++)d=s[u],e[4*(c+f*p)+3]=255,e[4*(c+f*p)+2]=h[3*d+0],e[4*(c+f*p)+1]=h[3*d+1],e[4*(c+f*p)+0]=h[3*d+2]}(c,o,s,d,r,a,l,n,i);break;case 16:!function(e,t,n,i,r,o,a,s){for(var l,d,c=0,h=m.width,u=t;u!==i;u+=n)for(d=r;d!==a;d+=o,c+=2)l=s[c+0]+(s[c+1]<<8),e[4*(d+h*u)+0]=(31744&l)>>7,e[4*(d+h*u)+1]=(992&l)>>2,e[4*(d+h*u)+2]=(31&l)>>3,e[4*(d+h*u)+3]=32768&l?0:255}(c,o,s,d,r,a,l,n);break;case 24:!function(e,t,n,i,r,o,a,s){for(var l,d=0,c=m.width,h=t;h!==i;h+=n)for(l=r;l!==a;l+=o,d+=3)e[4*(l+c*h)+3]=255,e[4*(l+c*h)+2]=s[d+0],e[4*(l+c*h)+1]=s[d+1],e[4*(l+c*h)+0]=s[d+2]}(c,o,s,d,r,a,l,n);break;case 32:!function(e,t,n,i,r,o,a,s){for(var l,d=0,c=m.width,h=t;h!==i;h+=n)for(l=r;l!==a;l+=o,d+=4)e[4*(l+c*h)+2]=s[d+0],e[4*(l+c*h)+1]=s[d+1],e[4*(l+c*h)+0]=s[d+2],e[4*(l+c*h)+3]=s[d+3]}(c,o,s,d,r,a,l,n);break;default:console.error("TGALoader: Format not supported.")}return c}(m.width,m.height,t.pixel_data,t.palettes);return{width:m.width,height:m.height,data:t,magFilter:THREE.NearestFilter,minFilter:THREE.NearestFilter}}};n(33);NDS.BODYFLAG={NONE_FLAG:0,SELECTED_FLAG:1,HIDDEN_FLAG:2,ISOLATED_FLAG:4,TRANSPARENT_FLAG:8,PRESELECTED_FLAG:16,DRAGGED_FLAG:32,ORIGINALTRANSPARENT_FLAG:64};function c(){this.bodyFlag=NDS.BODYFLAG.NONE_FLAG,this.bbox=new THREE.Box3,this.coords=[]}var b=function(){this.bodyFlag=NDS.BODYFLAG.NONE_FLAG,this.bodyMeshIds=[],this.bodyLineSegIds=[],this.bodyTextIds=[],this.bodyBbox=[],this.bodyTranslate=[0,0,0],this.bodyDragTranslate=[0,0,0],this.bodyOpacity=1,this.userMaterial=null},M=function(){this.bodyFlag=NDS.BODYFLAG.NONE_FLAG,this.renderObject=null};NDS.COMPONENT_ELEMENT_FLAG={NONE_FLAG:0,COORDINATE_VISIBLE_FLAG:1,REFPLANE_VISIBLE_FLAG:2,REFAXIS_VISIBLE_FLAG:4,BODY_VISISBLE_FLAG:8};var De=function(){var n=this,i=arguments;this.uuid=null,this.name=null,this.type=null,this.visible=!0,this.fixed=!1,this.children=[],this.parent=null,this.matrix=null,this.worldMatrix=null,this.objectid=null,this.id=-1,this.leafBodyAttri=null,this.componentElementFlag=NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG,this.useBodyNodeMaterial=!1,this.add=function(e){if(1<i.length){for(var t=0;t<i.length;t++)n.add(i[t]);return n}return n.children.indexOf(e)<0&&(e.parent&&e.parent.remove(e),e.lastParent&&delete e.lastParent,(e.parent=n).children.push(e)),n},this.remove=function(e){if(1<arguments.length){for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}var n=this.children.indexOf(e);return-1!==n&&(e.lastParent=this,e.parent=null,this.children.splice(n,1)),this}};De.prototype={constructor:De,isFixed:function(){if(this.fixed)return!0;for(var e=this.parent;e;){if(e.fixed)return!0;e=e.parent}return!1},isSelected:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.SELECTED_FLAG)},isTransparent:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.TRANSPARENT_FLAG)},isOriginalTransparent:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.ORIGINALTRANSPARENT_FLAG)},isIsolated:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.ISOLATED_FLAG)},isHidden:function(){return!!this.leafBodyAttri&&(0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.HIDDEN_FLAG)||("Body"!=this.type||"Assembly"!=this.parent.type&&"Part"!=this.parent.type?"RefAxis"!=this.type||"Assembly"!=this.parent.type&&"Part"!=this.parent.type?"RefPlane"!=this.type||"Assembly"!=this.parent.type&&"Part"!=this.parent.type?"CoordSystem"==this.type&&("Assembly"==this.parent.type||"Part"==this.parent.type)&&0==this.parent.isComponentCoordinateSysVisible():0==this.parent.isComponentRefPlaneVisible():0==this.parent.isComponentRefAxisVisible():0==this.parent.isComponentBodyVisible()))},isPreSelected:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.PRESELECTED_FLAG)},isDragged:function(){return!!this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.DRAGGED_FLAG)},isReferenceEntity:function(){var e=this.type.toLowerCase();return"refplane"==e||"refaxis"==e||"refpoint"==e},isCoordinate:function(){return"coordsystem"==this.type.toLowerCase()},isChildOfNode:function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1},select:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.SELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.SELECTED_FLAG,this.updateReferenceEntityDisplayFlag());var e=this.getModel().viewer;if(this.pmiuuid&&!e.is2DModel&&e.pmiObject)for(var t=0;t<this.pmiuuid.length;++t){var n=this.pmiuuid[t],n=e.pmiObject.getObjectByName(n);if(n){var i=n.geometry.attributes.position.data;if(i){for(var r=0;r<i.count;++r)i.array[r*i.stride+4]<=1&&(i.array[r*i.stride+4]+=1.25);i.version++,i.updateRange.count=i.count}else n.material.oldcolor||(n.material.oldcolor=n.material.color.clone()),n.material.color.setRGB(1,.788,.25)}}},deSelect:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.SELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.SELECTED_FLAG,this.updateReferenceEntityDisplayFlag());var e=this.getModel().viewer;if(this.pmiuuid&&!e.is2DModel&&e.pmiObject)for(var t=0;t<this.pmiuuid.length;++t){var n=this.pmiuuid[t],n=e.pmiObject.getObjectByName(n);if(n){var i=n.geometry.attributes.position.data;if(i){for(var r=0;r<i.count;++r)1<i.array[r*i.stride+4]&&(i.array[r*i.stride+4]-=1.25);i.version++,i.updateRange.count=i.count}else n.material.color.copy(n.material.oldcolor)}}},preSelect:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.PRESELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.PRESELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},dePreSelect:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.PRESELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.PRESELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},hide:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.HIDDEN_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.HIDDEN_FLAG,this.updateReferenceEntityDisplayFlag(),this.visible=!1,"CoordSystem"==this.type&&this.leafBodyAttri.renderObject&&this.leafBodyAttri.renderObject.detach())},show:function(){var e,t;this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.HIDDEN_FLAG)&&(this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.HIDDEN_FLAG,this.updateReferenceEntityDisplayFlag(),this.visible=!0,"CoordSystem"==this.type&&(this.leafBodyAttri.renderObject?this.leafBodyAttri.renderObject.attach(this):(t=null,t=(e=this.getModel()).viewer.canvas2D||e.viewer.canvas3D,(t=new be(e.viewer.camera,t)).attach(this),this.leafBodyAttri.renderObject=t,e.viewer.scene.add(t))))},transparent:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.TRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.TRANSPARENT_FLAG)},originalTransparent:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.ORIGINALTRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.ORIGINALTRANSPARENT_FLAG)},opaque:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.TRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.TRANSPARENT_FLAG)},isolate:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.ISOLATED_FLAG)&&(this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.ISOLATED_FLAG)},deIsolate:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&NDS.BODYFLAG.ISOLATED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.ISOLATED_FLAG)},setDragged:function(e){this.leafBodyAttri&&(e?this.leafBodyAttri.bodyFlag|=NDS.BODYFLAG.DRAGGED_FLAG:this.leafBodyAttri.bodyFlag&=~NDS.BODYFLAG.DRAGGED_FLAG)},getMaterialBodyNodeUUid:function(){for(var e=null,t=this;null!=t;)t.useBodyNodeMaterial&&(e=t.uuid),t=t.parent;return e},getUseBodyNodeMaterial:function(){return this.useBodyNodeMaterial},getUserMaterial:function(){return this.leafBodyAttri?this.leafBodyAttri.userMaterial:null},setUserMaterial:function(e){this.leafBodyAttri&&(this.leafBodyAttri.userMaterial&&this.leafBodyAttri.userMaterial.dispose(),this.leafBodyAttri.userMaterial=e)},getModel:function(){if(this.ndsModel)return this.ndsModel;for(var e=this.parent;e;){if(e.ndsModel)return e.ndsModel;e=e.parent}return null},getLevel:function(){for(var e=0,t=this;t;){if(e++,t.ndsModel)return e;t=t.parent}return e},updateReferenceEntityDisplayFlag:function(){var e;"RefAxis"==this.type?(e=this.getModel())&&(e.referenceEntityDispManager.needUpdateRefAxisDispData=!0):"RefPlane"==this.type&&(e=this.getModel())&&(e.referenceEntityDispManager.needUpdateRefPlaneDispData=!0)},isComponentRefPlaneVisible:function(){return 0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)},isComponentRefAxisVisible:function(){return 0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)},isComponentCoordinateSysVisible:function(){return 0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)},isComponentBodyVisible:function(){return 0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)},setComponentRefPlaneVisibility:function(e){if("Part"==this.type||"Assembly"==this.type)if(e){0==(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)&&(this.componentElementFlag|=NDS.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG);for(var t=0;t<this.children.length;t++)"RefPlane"==(n=this.children[t]).type&&n.show()}else{0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)&&(this.componentElementFlag&=~NDS.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG);for(var n,t=0;t<this.children.length;t++)"RefPlane"==(n=this.children[t]).type&&n.hide()}},setComponentRefAxisVisibility:function(e){if(e){0==(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)&&(this.componentElementFlag|=NDS.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG);for(var t=0;t<this.children.length;t++)"RefAxis"==(n=this.children[t]).type&&n.show()}else{0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)&&(this.componentElementFlag&=~NDS.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG);for(var n,t=0;t<this.children.length;t++)"RefAxis"==(n=this.children[t]).type&&n.hide()}},setComponentCoordinateSysVisibility:function(e){if("Part"==this.type||"Assembly"==this.type||"Model"==this.type){var t=this.getModel();if(e){0==(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)&&(this.componentElementFlag|=NDS.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG);for(var n=0;n<this.children.length;n++)"CoordSystem"==(i=this.children[n]).type&&i.show()}else{0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)&&(this.componentElementFlag&=~NDS.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG);for(var i,n=0;n<this.children.length;n++)"CoordSystem"==(i=this.children[n]).type&&i.hide()}t.viewer.render()}},setComponentBodyVisibility:function(e){var t;if("Part"==this.type||"Assembly"==this.type)if(e)0==(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)&&(this.componentElementFlag|=NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG),(t=this.getModel())&&t.meshManager.resetGeomSameMaterialFlags();else if(0!=(this.componentElementFlag&NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)&&(this.componentElementFlag&=~NDS.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG),t=this.getModel())for(var n=0;n<this.children.length;n++){var i=this.children[n];"Body"==i.type&&t.meshManager.setGeomSameMaterialFlag(i)}}};n(98);function h(){var n=this;this.geoms=[],this.uuidToIdMap={},this.usedGpuMemory=0,this.usedGpuMemoryInstanced=0,this.usedGpuMemoryLineSeg=0,this.usedMemory=0,this.pointGeomsMap={},this.maxGpuMemory=419430400,this.maxMemory=1.25*this.maxGpuMemory,this.loadedVertexAttributes=new Set,this.stopLoading=!1,this.allGeomInMemory=!0,this.ignorePendingBufferChunks=!1,this.ignorePendingLineSegBufferChunks=!1,this.maxBufferChunksInLoading=4,this.bufferChunksInLoading=0,this.bufferChunksToLoad=[],this.bufferChunk={},this.dispose=function(){for(var e=0,t=n.geoms.length;e<t;++e)n.geoms[e].dispose(),n.geoms[e]=null;n.geoms=[]}}var ae=function(){this.uuid=ye.getUniqueId(),this.id=THREE.GeometryIdCount(),this.isNdsGeometry=!0,this.subGeomId=null,this.boundingBox=new THREE.Box3,this.boundingSphere=null,this.bufferLength=0,this.vertexColors=!1,this.useSharedGlBuffer=!1,this.index=null,this.attributes={},this.drawRange={start:0,count:1/0},this.loaded=!1,this.refMeshes=[],this.refMeshesSameMaterial=!0,this.refMeshesSameMaterialOriginal=!0,this.refLineSegs=[],this.dirty=!0,this.vao=null,this.modelMatrixBuffer=null,this.groups=[],this.morphAttributes={}};h.prototype={constructor:h,addGeom:function(e){var t=this.geoms.length;if(void 0===this.uuidToIdMap[e.uuid])this.uuidToIdMap[e.uuid]=[t],this.geoms.push(e);else{for(var n,i=0;i<this.uuidToIdMap[e.uuid].length;i++)if(n=this.uuidToIdMap[e.uuid][i],this.geoms[n].subGeomId==e.subGeomId)return t=n;this.geoms.push(e),this.uuidToIdMap[e.uuid].push(t)}return t},addPointGeom:function(e){void 0===this.pointGeomsMap[e.uuid]&&(this.pointGeomsMap[e.uuid]=e)},getPointGeomFromUuid:function(e){return this.pointGeomsMap[e]},getGeomFromId:function(e){if(!(e>=this.geoms.length||e<0))return this.geoms[e]},getGeomIdFromUuid:function(e,t){var n=this.uuidToIdMap[e];if(!(n=n||this.uuidToIdMap[e.toUpperCase()]))return-1;for(var i=0,i=0;i<n.length;++i)if(this.geoms[n[i]].subGeomId===t)return n[i];return-1},getGeomFromUuid:function(e,t){t=this.getGeomIdFromUuid(e,t);return-1<t?this.geoms[t]:null},useSmallMemory:function(){this.maxGpuMemory=83886080,this.maxMemory=1.25*this.maxGpuMemory},useMediumMemory:function(){this.maxGpuMemory=314572800,this.maxMemory=1.25*this.maxGpuMemory},useLargeMemory:function(){this.maxGpuMemory=629145600,this.maxMemory=1.25*this.maxGpuMemory},usePCMemory:function(){this.maxGpuMemory=2147483648,this.maxMemory=3*this.maxGpuMemory},unloadGeometry:function(e){var t;e.index.array&&(t=e.index.array.byteLength,e.attributes.position.data?t+=e.attributes.position.data.array.byteLength:t+=e.attributes.position.array.byteLength,this.usedMemory-=t,e.index.array=null,e.attributes.position.data?e.attributes.position.data.array=null:e.attributes.position.array=null)},reloadGeometry:function(e){e={url:e.bufferChunkUrl,parameters:this.bufferChunk[e.bufferChunkUrl]};e.parameters.loading||(e.parameters.loading=!0,this.bufferChunksInLoading>=this.maxBufferChunksInLoading||this.stopLoading?this.bufferChunksToLoad.push(e):this.loadBufferChunk(e))},loadBufferChunk:function(e){var n=this,t=e;function i(e){var t;e&&e.index.array&&(t=e.index.array.byteLength,t+=(e.attributes.position.array?e.attributes.position:e.attributes.position.data).array.byteLength,n.usedMemory+=t,n.usedMemory>n.maxMemory&&(n.stopLoading=!0),NDS.StartRenderTime=Date.now())}function r(){t.parameters.loading=!1}t.parameters.useWorker=!0,t.parameters.worker=new Worker(Ue.loadWorkerUrl),n.bufferChunksInLoading+=1,(new oe).load(null,t.url,i,t.parameters,t.callback||r,function e(){0<n.bufferChunksToLoad.length&&!n.stopLoading?((t=n.bufferChunksToLoad.shift()).parameters.useWorker=!0,t.parameters.worker=new Worker(Ue.loadWorkerUrl),(new oe).load(null,t.url,i,t.parameters,t.callback||r,e)):--n.bufferChunksInLoading})}};function p(e){this.meshManager=e,this.dirty=!0}p.prototype={constructor:p,getNumLineSegments:function(){return this.meshManager.getNumLineSegments()},getLineSegmentsWithState:function(e,t){return this.meshManager.getLineSegmentsWithState(e,t,2<arguments.length&&void 0!==arguments[2]&&arguments[2])},getLineSegments:function(e,t){t=this.meshManager.getLineSegmentsWithState(e,t,2<arguments.length&&void 0!==arguments[2]&&arguments[2]);return 1===t.state?t.lineSegments:null},isLineSegmentsLoaded:function(e){return this.meshManager.isLineSegmentsLoaded(e)},removeGeometry:function(){for(var e,t=0,n=this.getNumLineSegments();t<n;++t)this.meshManager.isLineSegmentsLoaded(t)&&((e=this.meshManager.geomManager.getGeomFromId(this.meshManager.lineSegGeomId[t])).index.indexBuffer&&e.index.array&&this.meshManager.geomManager.unloadGeometry(e))}};function m(e,t,n,i){this.meshId=e,this.materialId=t,this.programId=n,this.z=i}n(42);function v(e,t){return e.programId===t.programId?e.materialId===t.materialId?e.meshId-t.meshId:e.materialId-t.materialId:e.programId-t.programId}function x(e,t){return e-t}var I=function(e,t){var r=this;this.geomManager=e,this.ndsModel=t,this.nMeshes=0,this.matrixes=null,this.bboxes=[],this.geomId=[],this.matrixId=null,this.materialId=[],this.materialIdOriginal=[],this.materialUuids=[],this.bodyNodes=[],this.bodyUuids=[],this.meshObjectUuids=void 0,this.bodyUuid2IdMap={},this.materials={},this.mats=[],this.matsCopy=[],this.nLineSegments=0,this.lineSegGeomId=[],this.lineSegMatrixId=null,this.lineSegMaterialId=[],this.lineSegBodyNodes=[],this.lineSegBodyUuids=[],this.lineSegObjectUuids=void 0,this.lineSegMaterial=null,this.lineSegMaterialCopy=null,this.lineSegMaterialHidden=null,this.lineSegSelectedMaterialHidden=null,this.LINESEG_LOADED_FLAG=1,this.lineSegFlag=[],this.nTexts=0,this.textGeomId=[],this.textMatrixId=null,this.textMaterialId=[],this.textBodyNodes=[],this.textBodyUuids=[],this.textObjectUuids=void 0,this.geomUuid=[],this.subgeomId=[],this.lineSegGeomUuid=[],this.textGeomUuid=[],this.mesh=new THREE.Mesh,this.mesh.bbox=new THREE.Box3,this.lineSegments=new THREE.LineSegments,this.supportInstancedArrays=!1,this.supportInstancedArraysCopy=!1,this.instancedMeshIds=[],this.instancedLineSegInfos=[],this.instancedLineSegs=new Set,this.unInstancedLineSegIds=[],this.bNeedRecalculateInstanceMesh=!0,this.selectedMaterial=null,this.selectedLineSegMaterial=null,this.overrideMaterial=null,this.overrideMaterialCopy=null,this.useBodyIdMaterial=!1,this.meshMaterial=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide}),Array.prototype.extend=function(e){var t=this;e.forEach(function(e){t.push(e)},this)},Array.prototype.deletefromIds=function(e,t){var n=this;t&&e.sort(x).reverse(),e.forEach(function(e){n.splice(e,1)},this)},this.dispose=function(){for(var e=0,t=r.mats.length;e<t;++e)r.mats[e]&&r.mats[e].dispose(),r.mats[e]=null;r.mats=[];for(var n=0,i=r.matsCopy.length;n<i;++n)r.matsCopy[n]&&r.matsCopy[n].dispose(),r.matsCopy[n]=null;r.matsCopy=[]}};I.prototype={constructor:I,setMatrixes:function(e){this.matrixes=e},setNumMeshes:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.nMeshes=e,this.bboxes=new Float32Array(6*e),this.geomId=new Int32Array(e),this.materialId=new Int32Array(e),this.materialIdOriginal=new Int32Array(e),this.bodyNodes=new Array(e),this.bodyUuids=new Array(e),t&&(this.meshObjectUuids=new Array(e)),n&&(this.matrixId=new Int32Array(e))},expandMeshes:function(e){this.nMeshes+=e;var t=new Array;t.extend(this.bboxes),t.extend(new Array(6*e).fill(0)),this.bboxes=new Float32Array(t);t=new Array;t.extend(this.geomId),t.extend(new Array(e).fill(0)),this.geomId=new Int32Array(t);t=new Array;t.extend(this.materialId),t.extend(new Array(e).fill(0)),this.materialId=new Int32Array(t);t=new Array;t.extend(this.materialIdOriginal),t.extend(new Array(e).fill(0)),this.materialIdOriginal=new Int32Array(t);t=new Array;t.extend(this.bodyNodes),t.extend(new Array(e)),this.bodyNodes=t;t=new Array;t.extend(this.bodyUuids),t.extend(new Array(e)),this.bodyUuids=t,this.instancedMeshIds.length=0},deleteMeshes:function(n){n.sort(x).reverse(),this.nMeshes-=n.length;var e=new Array;e.extend(this.bboxes),e=e.filter(function(e,t){if(-1==n.indexOf(Math.floor(t/6)))return!0}),this.bboxes=new Float32Array(e);e=new Array;e.extend(this.geomId),e.deletefromIds(n),this.geomId=new Int32Array(e);e=new Array;e.extend(this.geomUuid),e.deletefromIds(n),this.geomUuid=e;e=new Array;e.extend(this.materialId),e.deletefromIds(n),this.materialId=new Int32Array(e);e=new Array;e.extend(this.materialIdOriginal),e.deletefromIds(n),this.materialIdOriginal=new Int32Array(e);e=new Array;e.extend(this.bodyNodes),e.deletefromIds(n),this.bodyNodes=e;e=new Array;e.extend(this.bodyUuids),e.deletefromIds(n),this.bodyUuids=e,this.bNeedRecalculateInstanceMesh=!0},setMeshFromGeomUuid:function(e,t,n,i,r,o,a,s){for(var l=0,l=0;l<6;++l)this.bboxes[6*e+l]=t[l];this.geomUuid[e]=n,this.subgeomId[e]=i,this.materialId[e]=r,this.materialIdOriginal[e]=r,this.bodyUuids[e]=o,this.meshObjectUuids&&(this.meshObjectUuids[e]=a),this.matrixId&&(this.matrixId[e]=s),this.bNeedRecalculateInstanceMesh=!0},setMaterialUuids:function(e){this.materialUuids=e},setMaterials:function(e){Object.assign(this.materials,e)},setBodyUuids:function(e){for(var t,n=0;n<this.nMeshes;n++)t=this.bodyUuids[n],this.bodyUuids[n]=e[t],this.meshObjectUuids&&(t=this.meshObjectUuids[n],this.meshObjectUuids[n]=e[t]);for(var i,n=0;n<this.nLineSegments;n++)i=this.lineSegBodyUuids[n],this.lineSegBodyUuids[n]=e[i],this.lineSegObjectUuids&&(i=this.lineSegObjectUuids[n],this.lineSegObjectUuids[n]=e[i]);for(var r,o=0;o<this.nTexts;++o)r=this.textBodyUuids[o],this.textBodyUuids[o]=e[r],this.textObjectUuids&&(r=this.textObjectUuids[o],this.textObjectUuids[o]=e[r]);for(var a=this.bodyUuids.length,s=0;s<a;++s)this.bodyUuid2IdMap[this.bodyUuids[s]]=s},collectGeomRefEntities:function(){for(var n=this,e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].refMeshes.length=0,this.geomManager.geoms[e].refLineSegs.length=0;for(var i,e=0;e<this.nMeshes;++e)-1<(i=this.geomId[e])&&this.geomManager.geoms[i].refMeshes.push(e);if(this.ndsModel.viewer.is2DModel)for(e=0;e<this.nLineSegments;++e)-1<this.lineSegGeomId[e]&&this.geomManager.geoms[this.lineSegGeomId[e]].refLineSegs.push(e);for(e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].refMeshes.sort(function(e,t){return n.materialId[e]-n.materialId[t]}),1<this.geomManager.geoms[e].refLineSegs.length&&this.geomManager.geoms[e].refLineSegs.sort(function(e,t){return n.lineSegMaterialId[e]-n.lineSegMaterialId[t]})},setMaterialInfor:function(){var e=0,t=this.mats.length;this.mats=[];var n=this.materialUuids.length;for(e=0;e<n;++e){var i=(i=this.materials[this.materialUuids[e]])||this.materials[this.materialUuids[e].toUpperCase()];this.mats.push(i?i.mat:null)}var r,o,a={};for(e=0;e<this.nMeshes;++e)-1<this.geomId[e]&&(s=this.geomManager.getGeomFromId(this.geomId[e])).vertexColors&&((o=a[this.materialId[e]])||((r=(new(r=this.mats[this.materialId[e]]).constructor).copy(r)).vertexColors=THREE.VertexColors,this.mats.push(r),++n,o=this.mats.length-1,a[this.materialId[e]]=o),this.materialId[e]=o,this.materialIdOriginal[e]=o);for(e=0;e<n;++e)this.mats[e]?this.mats.push((new this.mats[e].constructor).copy(this.mats[e])):this.mats.push(null);if(this.supportInstancedArrays)for(var s,l=this.mats.length/2,e=0;e<this.nMeshes;++e)-1<this.geomId[e]&&(1<(s=this.geomManager.getGeomFromId(this.geomId[e])).refMeshes.length&&!s.useSharedGlBuffer?(this.materialId[e]=this.materialIdOriginal[e]+l,s.updateModelMatrix=!0):this.materialId[e]=this.materialIdOriginal[e]);if(0<this.matsCopy.length&&this.mats.length!=t){var d=this.matsCopy[0].opacity;for(e=0;e<this.matsCopy.length;++e)this.matsCopy[e].dispose();for(e=this.matsCopy.length=0;e<this.mats.length;++e)this.mats[e]&&(this.matsCopy[e]=this.mats[e].clone(),this.matsCopy[e].uuid=this.mats[e].uuid,this.matsCopy[e].program=this.mats[e].program,this.matsCopy[e].needsUpdate=this.mats[e].needsUpdate,this.matsCopy[e].opacity=d,this.matsCopy[e].transparent=!0)}},mapGeomUuidToGeomId:function(){for(var e=0,e=0;e<this.nMeshes;++e)this.geomId[e]=this.geomManager.getGeomIdFromUuid(this.geomUuid[e],this.subgeomId[e]);for(e=0;e<this.nLineSegments;++e)this.lineSegGeomId[e]=this.geomManager.getGeomIdFromUuid(this.lineSegGeomUuid[e],0);for(e=0;e<this.nTexts;++e)this.textGeomId[e]=this.geomManager.getGeomIdFromUuid(this.textGeomUuid[e],0);for(this.collectGeomRefEntities(),e=0;e<this.geomManager.geoms.length;++e){var t=this.geomManager.geoms[e];if(1<t.refMeshes.length){t.refMeshesSameMaterial=!0,t.refMeshesSameMaterialOriginal=!0;for(var n=0;n<t.refMeshes.length-1;++n){var i=t.refMeshes[n],r=t.refMeshes[n+1];if(this.materialId[i]!=this.materialId[r]){t.refMeshesSameMaterial=!1,t.refMeshesSameMaterialOriginal=!1;break}}}}this.setMaterialInfor(),this.bNeedRecalculateInstanceMesh=!0},setMeshMaterialEnvMap:function(e,t){for(var n=0,i=this.mats.length;n<i;++n)this.mats[n]&&void 0!==this.mats[n].envMap&&(this.mats[n].envMap=e,void 0!==this.mats[n].combine&&(this.mats[n].combine=t),this.mats[n].needsUpdate=!0)},getMeshBBox:function(e,t){var n=this.bodyNodes[e],n=this.ndsModel.getBodyTranslate(n);t.min.fromArray(this.bboxes,6*e),t.max.fromArray(this.bboxes,6*e+3);(1e-7<Math.abs(n[0])||1e-7<Math.abs(n[1])||1e-7<Math.abs(n[2]))&&(t.min.x+=n[0],t.min.y+=n[1],t.min.z+=n[2],t.max.x+=n[0],t.max.y+=n[1],t.max.z+=n[2])},updateMeshBBox:function(e){var t,n;this.geomId[e]<0||(t=this.bodyNodes[e],(n=this.geomManager.getGeomFromId(this.geomId[e]).boundingBox.clone()).applyMatrix4(t.worldMatrix),this.bboxes[6*e]=n.min.x,this.bboxes[6*e+1]=n.min.y,this.bboxes[6*e+2]=n.min.z,this.bboxes[6*e+3]=n.max.x,this.bboxes[6*e+4]=n.max.y,this.bboxes[6*e+5]=n.max.z)},getMeshInfor:function(e,t){var n=this.bodyNodes[e],i=this.ndsModel.getBodyTranslate(n);-1<this.geomId[e]?t.geometry=this.geomManager.getGeomFromId(this.geomId[e]):t.geometry=null;e=this.materialId[e];e>=this.mats.length/2&&(t.geometry.refMeshesSameMaterial&&this.supportInstancedArrays&&!t.geometry.useSharedGlBuffer||(e-=this.mats.length/2)),t.material=this.mats[e],t.matrixWorld||(t.matrixWorld=new THREE.Matrix4);n=n.worldMatrix;t.matrixWorld.copy(n),t.matrixWorld.elements[12]+=i[0],t.matrixWorld.elements[13]+=i[1],t.matrixWorld.elements[14]+=i[2]},getSingleMesh:function(e){var t=this.supportInstancedArrays;this.supportInstancedArrays=!1;e=this.getMesh(e);return this.supportInstancedArrays=t,e},getMesh:function(e){if(!(this.geomId[e]<0)){var t=this.bodyNodes[e];if(!t.isHidden()&&(this.mesh.meshId=e,this.mesh.geometry=this.geomManager.getGeomFromId(this.geomId[e]),this.mesh.geometry.index&&this.mesh.geometry.index.array)){var n,i,r,o=t.getMaterialBodyNodeUUid(),a=t.getUserMaterial();a?((r=this.materialId[e])>=this.mats.length/2&&(this.mesh.geometry.refMeshesSameMaterial&&this.supportInstancedArrays&&!this.mesh.geometry.useSharedGlBuffer||(r-=this.mats.length/2)),i=this.mats[r],this.mesh.material=a.clone(),this.mesh.geometry.refMeshesSameMaterial=!1,0<this.ndsModel.transparentizedBodies.length&&t.isTransparent()?(this.mesh.material.transparent=!0,this.mesh.material.opacity=Ue.bodyOpacity):(t.isOriginalTransparent()?this.mesh.material.transparent=!0:this.mesh.material.transparent=i.transparent,this.mesh.material.opacity=i.opacity)):(!o||(o=this.ndsModel.bodyNodeUUidToMaterial[o])&&(n=o),n?(this.mesh.material=n.clone(),this.mesh.geometry.refMeshesSameMaterial=!1,0<this.ndsModel.transparentizedBodies.length&&t.isTransparent()&&(this.mesh.material.transparent=!0,this.mesh.material.opacity=Ue.bodyOpacity)):((r=this.materialId[e])>=this.mats.length/2&&(this.mesh.geometry.refMeshesSameMaterial&&this.supportInstancedArrays&&!this.mesh.geometry.useSharedGlBuffer||(r-=this.mats.length/2)),this.mesh.material=this.mats[r],0<this.ndsModel.transparentizedBodies.length&&t.isTransparent()&&(this.mesh.material=this.matsCopy[r])));var s=this.mesh.geometry.refMeshes.length;if(this.supportInstancedArrays&&1<s&&!this.mesh.geometry.useSharedGlBuffer&&this.mesh.geometry.refMeshesSameMaterial){if(this.mesh.instancedCount=s,!this.mesh.geometry.dirty&&!this.mesh.geometry.updateModelMatrix&&this.mesh.geometry.modelMatrixBuffer)return void(this.mesh.matrixWorlds=null);if(!this.mesh.geometry.vao&&!this.mesh.geometry.modelMatrixBuffer||this.mesh.geometry.updateModelMatrix){this.mesh.matrixWorlds=new Float32Array(16*s);for(var l=0;l<s;++l){var d=this.mesh.geometry.refMeshes[l],c=16*l;if(this.matrixes)for(var h=0;h<16;++h)this.mesh.matrixWorlds[c+h]=this.matrixes[16*this.matrixId[d]+h];else this.bodyNodes[d].worldMatrix.toArray(this.mesh.matrixWorlds,c);var u=this.ndsModel.getBodyTranslate(this.bodyNodes[d]);this.mesh.matrixWorlds[12+c]+=u[0],this.mesh.matrixWorlds[13+c]+=u[1],this.mesh.matrixWorlds[14+c]+=u[2]}this.mesh.geometry.updateModelMatrix=!1}else this.mesh.matrixWorlds=null;return this.mesh.geometry.dirty=!1,this.overrideMaterialCopy&&(this.mesh.material=this.overrideMaterialCopy),this.mesh}if(this.mesh.instancedCount=0,this.matrixes)for(h=0;h<16;++h)this.mesh.matrixWorld.elements[h]=this.matrixes[16*this.matrixId[e]+h];else this.mesh.matrixWorld.copy(t.worldMatrix);u=this.ndsModel.getBodyTranslate(t);return this.mesh.matrixWorld.elements[12]+=u[0],this.mesh.matrixWorld.elements[13]+=u[1],this.mesh.matrixWorld.elements[14]+=u[2],this.overrideMaterial&&(this.mesh.material=this.overrideMaterial,this.useBodyIdMaterial&&(this.mesh.material=this.overrideMaterialCopy,this.mesh.material.color.setHex(10*t.id))),this.mesh}}},getMeshOriginalMaterial:function(e){var t,n=this.bodyNodes[e],i=n.getMaterialBodyNodeUUid(),n=n.getUserMaterial();return n||(!i||(i=this.ndsModel.bodyNodeUUidToMaterial[i])&&(t=i),t||(e=this.materialId[e],this.mats[e]))},getText:function(e){if(!(this.textGeomId[e]<0)&&!this.textBodyNodes[e].isHidden()){var t=this.geomManager.getGeomFromId(this.textGeomId[e]);return"shxLoad"==t.textLoad?this.getLineText(e):"ttfLoad"==t.textLoad?this.getMeshText(e):void t.textLoad}},getLineText:function(e){var t=this.textBodyNodes[e];if(!t.isHidden()){this.lineSegments.geometry=this.geomManager.getGeomFromId(this.textGeomId[e]),this.lineSegments.material=this.materials["text:"+this.lineSegments.geometry.styleId].mat;var n=this.mats[this.textMaterialId[e]];this.lineSegments.material.uniforms.diffuse.value.copy(t.isSelected()?Ue.selectedColor:n.color),this.lineSegments.material.uniformsNeedUpdate=!0;var i=this.lineSegments.geometry.refMeshes.length;if(this.supportInstancedArrays&&1<i&&!this.lineSegments.geometry.useSharedGlBuffer&&this.lineSegments.geometry.refMeshesSameMaterial){if(this.lineSegments.instancedCount=i,!this.lineSegments.geometry.dirty&&!this.lineSegments.geometry.updateModelMatrix&&this.lineSegments.geometry.modelMatrixBuffer)return void(this.lineSegments.matrixWorlds=null);if(!this.lineSegments.geometry.vao&&!this.lineSegments.geometry.modelMatrixBuffer||this.lineSegments.geometry.updateModelMatrix){this.lineSegments.matrixWorlds=new Float32Array(16*i);for(var r=0;r<i;++r){var o=this.lineSegments.geometry.refMeshes[r],a=16*r;if(this.matrixes)for(var s=0;s<16;++s)this.lineSegments.matrixWorlds[a+s]=this.matrixes[16*this.textMatrixId[o]+s];else this.bodyNodes[o].worldMatrix.toArray(this.lineSegments.matrixWorlds,a);var l=this.ndsModel.getBodyTranslate(this.bodyNodes[o]);this.lineSegments.matrixWorlds[12+a]+=l[0],this.lineSegments.matrixWorlds[13+a]+=l[1],this.lineSegments.matrixWorlds[14+a]+=l[2]}this.lineSegments.geometry.updateModelMatrix=!1}else this.lineSegments.matrixWorlds=null;return this.lineSegments.geometry.dirty=!1,this.overrideMaterialCopy&&(this.lineSegments.material=this.overrideMaterialCopy),this.lineSegments}if(this.lineSegments.position.copy(this.lineSegments.geometry.position),this.lineSegments.quaternion.copy(this.lineSegments.geometry.quaternion),this.lineSegments.updateMatrix(),this.lineSegments.matrixWorldNeedsUpdate=!1,this.lineSegments.instancedCount=0,this.matrixes)for(s=0;s<16;++s)this.lineSegments.matrixWorld.elements[s]=this.matrixes[16*this.textMatrixId[e]+s];else this.lineSegments.matrixWorld.copy(t.worldMatrix);this.lineSegments.matrixWorld.multiply(this.lineSegments.matrix);l=this.ndsModel.getBodyTranslate(t);return this.lineSegments.matrixWorld.elements[12]+=l[0],this.lineSegments.matrixWorld.elements[13]+=l[1],this.lineSegments.matrixWorld.elements[14]+=l[2],this.lineSegments}},getMeshText:function(e){if(!(this.textGeomId[e]<0)){var t=this.textBodyNodes[e];if(!t.isHidden()){this.mesh.meshId=e,this.mesh.geometry=this.geomManager.getGeomFromId(this.textGeomId[e]),this.mesh.material=this.materials["text:"+this.mesh.geometry.styleId].mat;var n=this.mats[this.textMaterialId[e]];this.mesh.material.uniforms.diffuse.value.copy(t.isSelected()?Ue.selectedColor:n.color),this.mesh.material.uniformsNeedUpdate=!0;var i=this.mesh.geometry.refMeshes.length;if(this.supportInstancedArrays&&1<i&&!this.mesh.geometry.useSharedGlBuffer&&this.mesh.geometry.refMeshesSameMaterial){if(this.mesh.instancedCount=i,!this.mesh.geometry.dirty&&!this.mesh.geometry.updateModelMatrix&&this.mesh.geometry.modelMatrixBuffer)return void(this.mesh.matrixWorlds=null);if(!this.mesh.geometry.vao&&!this.mesh.geometry.modelMatrixBuffer||this.mesh.geometry.updateModelMatrix){this.mesh.matrixWorlds=new Float32Array(16*i);for(var r=0;r<i;++r){var o=this.mesh.geometry.refMeshes[r],a=16*r;if(this.matrixes)for(var s=0;s<16;++s)this.mesh.matrixWorlds[a+s]=this.matrixes[16*this.textMatrixId[o]+s];else this.bodyNodes[o].worldMatrix.toArray(this.mesh.matrixWorlds,a);var l=this.ndsModel.getBodyTranslate(this.bodyNodes[o]);this.mesh.matrixWorlds[12+a]+=l[0],this.mesh.matrixWorlds[13+a]+=l[1],this.mesh.matrixWorlds[14+a]+=l[2]}this.mesh.geometry.updateModelMatrix=!1}else this.mesh.matrixWorlds=null;return this.mesh.geometry.dirty=!1,this.overrideMaterialCopy&&(this.mesh.material=this.overrideMaterialCopy),this.mesh}if(this.mesh.position.copy(this.mesh.geometry.position),this.mesh.quaternion.copy(this.mesh.geometry.quaternion),this.mesh.updateMatrix(),this.mesh.matrixWorldNeedsUpdate=!1,this.mesh.instancedCount=0,this.matrixes)for(s=0;s<16;++s)this.mesh.matrixWorld.elements[s]=this.matrixes[16*this.textMatrixId[e]+s];else this.mesh.matrixWorld.copy(t.worldMatrix);this.mesh.matrixWorld.multiply(this.mesh.matrix);l=this.ndsModel.getBodyTranslate(t);return this.mesh.matrixWorld.elements[12]+=l[0],this.mesh.matrixWorld.elements[13]+=l[1],this.mesh.matrixWorld.elements[14]+=l[2],this.mesh}}},recalculateInstance:function(){var t=this;if(this.bNeedRecalculateInstanceMesh){this.instancedLineSegInfos.length=0;for(var e=this.unInstancedLineSegIds.length=0,n=this.geomManager.geoms.length;e<n;++e)if(1<this.geomManager.geoms[e].refMeshes.length&&this.instancedMeshIds.push(this.geomManager.geoms[e].refMeshes[0]),1<this.geomManager.geoms[e].refLineSegs.length){for(var i=this.geomManager.geoms[e],r=this.lineSegMaterialId[i.refLineSegs[0]],o=[],a=this.instancedLineSegInfos.length,s=0,l=i.refLineSegs.length;s<l;++s)o[o.length]=i.refLineSegs[s],r!==this.lineSegMaterialId[i.refLineSegs[s]]&&(r=this.lineSegMaterialId[i.refLineSegs[s]],1<o.length?(this.instancedLineSegInfos.push({instanceId:a,lineSegIds:o}),o.forEach(function(e){return t.instancedLineSegs.add(e)})):this.unInstancedLineSegIds.push(o[0]),o=[]);1<o.length?(this.instancedLineSegInfos.push({instanceId:a,lineSegIds:o}),o.forEach(function(e){return t.instancedLineSegs.add(e)})):1===o.length&&this.unInstancedLineSegIds.push(o[0])}else 1===this.geomManager.geoms[e].refLineSegs.length&&this.unInstancedLineSegIds.push(this.geomManager.geoms[e].refLineSegs[0]);this.unInstancedLineSegIds.sort(function(e,t){return e-t});for(var d=[],e=0,n=this.instancedMeshIds.length;e<n;++e){var c=this.instancedMeshIds[e],h=this.materialId[c],u=this.mats[h],u=u.program?u.program.id:1e4;d.push(new m(c,h,u,0))}d.sort(v);for(e=0,n=this.instancedMeshIds.length;e<n;++e)this.instancedMeshIds[e]=d[e].meshId;this.bNeedRecalculateInstanceMesh=!1}},resetLineInstance:function(){for(var e=0,t=this.geomManager.geoms.length;e<t;++e)if(1<this.geomManager.geoms[e].refLineSegs.length){for(var n=this.geomManager.geoms[e],i=this.lineSegMaterialId[n.refLineSegs[0]],r=[],o=0,a=n.refLineSegs.length;o<a;++o)r[r.length]=n.refLineSegs[o],i!==this.lineSegMaterialId[n.refLineSegs[o]]&&(i=this.lineSegMaterialId[n.refLineSegs[o]],1<r.length&&(n.dirty=!0),r=[]);1<r.length&&(n.dirty=!0)}},getNumInstancedLineSegs:function(){return this.recalculateInstance(),this.instancedLineSegInfos.length},getNumUnInstancedLineSegs:function(){return this.recalculateInstance(),this.unInstancedLineSegIds.length},getNumInstancedMeshes:function(){return this.recalculateInstance(),this.instancedMeshIds.length},getInstancedMesh:function(e){e=this.instancedMeshIds[e];if(this.geomManager.getGeomFromId(this.geomId[e]).refMeshesSameMaterial)return this.getMesh(e)},getInstancedLineSegWithState:function(e,t){e=this.instancedLineSegInfos[e];return this.getLineSegmentsWithState(e,t)},getInstancedLineSeg:function(e,t){e=this.instancedLineSegInfos[e],t=this.getLineSegmentsWithState(e,t);return 1===t.state?t.lineSegments:null},getUnInstancedLineSegWithState:function(e,t){return this.getLineSegmentsWithState(this.unInstancedLineSegIds[e],t,!0)},getUnInstancedLineSeg:function(e,t){t=this.getLineSegmentsWithState(this.unInstancedLineSegIds[e],t,!0);return 1===t.state?t.lineSegments:null},getInstancedLineSegId:function(e){return this.instancedLineSegInfos[e].lineSegIds[0]},getUnInstancedLineSegId:function(e){return this.unInstancedLineSegIds[e]},getInstancedMeshId:function(e){return this.instancedMeshIds[e]},setNumLineSegments:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.nLineSegments=e,this.lineSegGeomId=new Int32Array(e),this.lineSegMaterialId=new Int32Array(e),this.lineSegFlag=new Uint8Array(e),this.lineSegBodyUuids=new Array(e),this.lineSegBodyNodes=new Array(e),t&&(this.lineSegObjectUuids=new Array(e)),n&&(this.lineSegMatrixId=new Int32Array(e))},expandLineSegments:function(e){this.nLineSegments+=e;var t=new Array;t.extend(this.lineSegGeomId),t.extend(new Array(e).fill(0)),this.lineSegGeomId=new Int32Array(t);t=new Array;t.extend(this.lineSegMaterialId),t.extend(new Array(e).fill(0)),this.lineSegMaterialId=new Int32Array(t);t=new Array;t.extend(this.lineSegFlag),t.extend(new Array(e).fill(0)),this.lineSegFlag=new Uint8Array(t);t=new Array;t.extend(this.lineSegBodyNodes),t.extend(new Array(e)),this.lineSegBodyNodes=t;t=new Array;t.extend(this.lineSegBodyUuids),t.extend(new Array(e)),this.lineSegBodyUuids=t},deleteLineSegments:function(e){e.sort(x).reverse(),this.nLineSegments-=e.length;var t=new Array;t.extend(this.lineSegGeomId),t.deletefromIds(e),this.lineSegGeomId=new Int32Array(t);t=new Array;t.extend(this.lineSegGeomUuid),t.deletefromIds(e),this.lineSegGeomUuid=t;t=new Array;t.extend(this.lineSegMaterialId),t.deletefromIds(e),this.lineSegMaterialId=new Int32Array(t);t=new Array;t.extend(this.lineSegFlag),t.deletefromIds(e),this.lineSegFlag=new Uint8Array(t);t=new Array;t.extend(this.lineSegBodyUuids),t.deletefromIds(e),this.lineSegBodyUuids=t;t=new Array;t.extend(this.lineSegBodyNodes),t.deletefromIds(e),this.lineSegBodyNodes=t},setLineSegmentsFromGeomUuid:function(e,t,n,i,r,o){this.lineSegGeomUuid[e]=t,this.lineSegBodyUuids[e]=n,this.lineSegMaterialId[e]=i||-1,this.lineSegObjectUuids&&(this.lineSegObjectUuids[e]=r),this.lineSegMatrixId&&(this.lineSegMatrixId[e]=o)},mergeLineSegments:function(){for(var e,t,n=0;n<this.nLineSegments;++n){var i,r=this.lineSegBodyNodes[n];if(!(0<this.getNumBodyMeshs(r)))if(i=this.geomManager.getGeomFromId(this.lineSegGeomId[n])){var o=i.boundingBox.clone();if(6==r.leafBodyAttri.bodyBbox.length)for(var a=0;a<3;++a)o.min.getComponent(a)<r.leafBodyAttri.bodyBbox[a]&&(r.leafBodyAttri.bodyBbox[a]=o.min.getComponent(a)),o.max.getComponent(a)>r.leafBodyAttri.bodyBbox[3+a]&&(r.leafBodyAttri.bodyBbox[3+a]=o.max.getComponent(a));else for(a=0;a<3;++a)r.leafBodyAttri.bodyBbox[a]=o.min.getComponent(a),r.leafBodyAttri.bodyBbox[3+a]=o.max.getComponent(a)}}for(n=0;n<this.nLineSegments-1;++n)this.lineSegBodyNodes[n]===this.lineSegBodyNodes[n+1]&&this.lineSegMaterialId[n]===this.lineSegMaterialId[n+1]&&(e=this.lineSegGeomId[n],t=this.lineSegGeomId[n+1],i=this.geomManager.getGeomFromId(e),t=this.geomManager.getGeomFromId(t),i&&t&&(i.tangentEdgeObject&&!t.tangentEdgeObject||!i.tangentEdgeObject&&t.tangentEdgeObject||i.index===t.index&&i.drawRange.start+i.drawRange.count===t.drawRange.start&&(t.drawRange.start-=i.drawRange.count,t.drawRange.count+=i.drawRange.count,i.drawRange.count=0)))},getNumLineSegments:function(){return this.nLineSegments},isLineSegmentsLoaded:function(e){if(0!=(this.lineSegFlag[e]&this.LINESEG_LOADED_FLAG))return!0;var t=this.geomManager,n=t.getGeomFromId(this.lineSegGeomId[e]);return!!(n&&n.loaded&&n.index)&&(t.loadedVertexAttributes.has(n.index.uuid)||(t.usedMemory+=n.index.array.byteLength,t.usedGpuMemory+=n.index.array.byteLength,t.loadedVertexAttributes.add(n.index.uuid)),t.loadedVertexAttributes.has(n.attributes.position.uuid)||(t.usedMemory+=(n.attributes.position.array?n.attributes.position:n.attributes.position.data).array.byteLength,t.usedGpuMemory+=(n.attributes.position.array?n.attributes.position:n.attributes.position.data).array.byteLength,t.loadedVertexAttributes.add(n.attributes.position.uuid)),this.lineSegFlag[e]|=this.LINESEG_LOADED_FLAG,t.usedMemory>=.9*t.maxMemory&&(t.stopLoading=!0,t.allGeomInMemory=!1),!0)},getLineSegmentsWithState:function(e,t){var n,i=e.lineSegIds?(n=e).lineSegIds[0]:e,r={state:1,lineSegments:null,lineStyle:null};if(2<arguments.length&&void 0!==arguments[2]&&arguments[2]&&this.instancedLineSegs.has(i))return r.state=0,r;if(!this.isLineSegmentsLoaded(i))return r.state=-1,r;this.instanceMats||(this.instanceMats=new Map);var o=this.geomManager.getGeomFromId(this.lineSegGeomId[i]);if(0===o.drawRange.count)return r.state=0,r;if(!1===Ue.tangentEdgeVisible&&o.tangentEdgeObject)return r.state=0,r;var a=this.lineSegBodyNodes[i];if(a.isHidden())return r.state=0,r;this.lineSegments.geometry=o;e=null,o=this.lineSegMaterialId[i];if(-1<o&&((e=this.mats[o]).linewidth=1),!e||"LineBasicMaterial"!=e.type&&"ShaderMaterial"!=e.type){if(!this.lineSegMaterial){for(var s in this.materials)if("LineBasicMaterial"===this.materials[s].mat.type){this.lineSegMaterial=this.materials[s].mat;break}this.lineSegMaterial||(this.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}e=this.lineSegMaterial}if(n&&(this.instanceMats.has(e.uuid)||this.instanceMats.set(e.uuid,e.clone()),"ShaderMaterial"==(o=this.instanceMats.get(e.uuid)).type||o.color.equals(e.color)?"ShaderMaterial"!=o.type||o.uniforms.diffuse.value.equals(e.uniforms.diffuse.value)||(o.color&&o.color.copy(e.color),o.uniforms.diffuse.value.copy(e.color)):o.color.copy(e.color),a.isSelected()&&("ShaderMaterial"==o.type||o.color.equals(Ue.selectedColor)?"ShaderMaterial"!=o.type||o.uniforms.diffuse.value.equals(Ue.selectedColor)||(o.color&&o.color.copy(Ue.selectedColor),o.uniforms.diffuse.value.copy(Ue.selectedColor)):o.color.copy(Ue.selectedColor)),o.isInstanceMaterial=!0,e=o),t?(void 0===e.oldOpacity&&(e.oldOpacity=e.opacity,e.oldTransparent=e.transparent,e.oldDepthFunc=e.depthFunc,e.needsUpdate=!0,e.needsRefresh=!0),e.opacity=.2,e.transparent=!0,e.depthFunc=THREE.GreaterDepth):null!=e.oldOpacity&&(e.opacity=e.oldOpacity,e.transparent=e.oldTransparent,e.depthFunc=e.oldDepthFunc,e.needsUpdate=!0,e.needsRefresh=!0,e.oldOpacity=void 0,e.oldTransparent=void 0,e.oldDepthFunc=void 0),this.lineSegments.material=e,a.isSelected()&&(this.selectedLineSegMaterial=e.clone(),this.selectedLineSegMaterial.color&&this.selectedLineSegMaterial.color.copy(Ue.selectedColor),"ShaderMaterial"==this.selectedLineSegMaterial.type&&this.selectedLineSegMaterial.uniforms.diffuse.value.copy(Ue.selectedColor),t&&!this.lineSegSelectedMaterialHidden&&(this.lineSegSelectedMaterialHidden=this.selectedLineSegMaterial.clone(),this.lineSegSelectedMaterialHidden.uuid=this.selectedLineSegMaterial.uuid,this.lineSegSelectedMaterialHidden.program=this.selectedLineSegMaterial.program,this.lineSegSelectedMaterialHidden.needsUpdate=!0,this.lineSegSelectedMaterialHidden.opacity=.2,this.lineSegSelectedMaterialHidden.transparent=!0,this.lineSegSelectedMaterialHidden.depthFunc=THREE.GreaterDepth),this.lineSegments.material=t?this.lineSegSelectedMaterialHidden:this.selectedLineSegMaterial),a.isTransparent()&&this.lineSegMaterialCopy&&(n?(this.instancedLineSegMaterialCopy||(this.instancedLineSegMaterialCopy=this.lineSegMaterialCopy.clone()),this.lineSegments.material=this.instancedLineSegMaterialCopy):this.lineSegments.material=this.lineSegMaterialCopy),n&&!a.isSelected()){var l=n.lineSegIds.length;if(this.supportInstancedArrays&&1<l&&!this.lineSegments.geometry.useSharedGlBuffer){if(this.lineSegments.instancedCount=l,!this.lineSegments.geometry.dirty&&!this.lineSegments.geometry.updateModelMatrix&&n.modelMatrixBuffer)return this.lineSegments.matrixWorlds=null,r.state=2,r;if(!this.lineSegments.geometry.vao&&!n.modelMatrixBuffer||this.lineSegments.geometry.updateModelMatrix){this.lineSegments.matrixWorlds=new Float32Array(16*l);for(var d=0;d<l;++d){var c=n.lineSegIds[d],h=16*d;if(this.matrixes)for(var u=0;u<16;++u)this.lineSegments.matrixWorlds[h+u]=this.matrixes[16*this.lineSegMatrixId[c]+u];else this.lineSegBodyNodes[c].worldMatrix.toArray(this.lineSegments.matrixWorlds,h);var f=this.ndsModel.getBodyTranslate(this.lineSegBodyNodes[c]);this.lineSegments.matrixWorlds[12+h]+=f[0],this.lineSegments.matrixWorlds[13+h]+=f[1],this.lineSegments.matrixWorlds[14+h]+=f[2]}this.lineSegments.geometry.updateModelMatrix=!1}else this.lineSegments.matrixWorlds=null;return this.lineSegments.geometry.modelMatrixBuffer=n.modelMatrixBuffer,this.lineSegments.geometry.instanceInfo=n,this.lineSegments.geometry.dirty=!1,r.state=1,r.lineSegments=this.lineSegments,null!=e.uniforms&&null!=e.uniforms.lineTypeId&&this.ndsModel.viewer.lineTypes&&(r.lineStyle=this.ndsModel.viewer.lineTypes.getLineStyleInfo(this.lineSegments.geometry,e.uniforms.lineTypeId.value,e.uniforms.lineScale.value,e.color||e.uniforms.diffuse.value,a.isSelected())),r}}if(this.lineSegments.instancedCount=0,this.matrixes)for(u=0;u<16;++u)this.lineSegments.matrixWorld.elements[u]=this.matrixes[16*this.lineSegMatrixId[i]+u];else this.lineSegments.matrixWorld.copy(a.worldMatrix);f=this.ndsModel.getBodyTranslate(a);return this.lineSegments.matrixWorld.elements[12]+=f[0],this.lineSegments.matrixWorld.elements[13]+=f[1],this.lineSegments.matrixWorld.elements[14]+=f[2],null!=e.uniforms&&null!=e.uniforms.lineTypeId&&this.ndsModel.viewer.lineTypes&&(r.lineStyle=this.ndsModel.viewer.lineTypes.getLineStyleInfo(this.lineSegments.geometry,e.uniforms.lineTypeId.value,e.uniforms.lineScale.value,e.color||e.uniforms.diffuse.value,a.isSelected()),a.isSelected()),r.state=1,r.lineSegments=this.lineSegments,r},getLineSegments:function(e,t){t=this.getLineSegmentsWithState(e,t,2<arguments.length&&void 0!==arguments[2]&&arguments[2]);return 1===t.state?t.lineSegments:null},setNumTexts:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.nTexts=e,this.textGeomId=new Int32Array(e),this.textMaterialId=new Int32Array(e),this.textBodyUuids=new Array(e),this.textBodyNodes=new Array(e),t&&(this.textObjectUuids=new Array(e)),n&&(this.textMatrixId=new Int32Array(e))},setTextFromGeomUuid:function(e,t,n,i,r,o){this.textGeomUuid[e]=t,this.textBodyUuids[e]=n,this.textMaterialId[e]=i||-1,this.textObjectUuids&&(this.textObjectUuids[e]=r),this.textMatrixId&&(this.textMatrixId[e]=o)},getNumTexts:function(){return this.nTexts},intersect:function(e,t,n){if(this.geomId[e]<0)return null;var i=this.geomManager.getGeomFromId(this.geomId[e]),r=this.mats[this.materialId[e]];if(!i||!i.loaded||i.index&&null==i.index.array)return null;var o=this.bodyNodes[e];if(o.isHidden())return null;var a=o.worldMatrix.clone();if(this.matrixId)for(var s=0;s<16;++s)a.elements[s]=this.matrixes[16*this.matrixId[e]+s];var l=this.ndsModel.getBodyTranslate(o);a.elements[12]+=l[0],a.elements[13]+=l[1],a.elements[14]+=l[2];l=new THREE.Matrix4;l.getInverse(a);var d=new THREE.Ray;d.copy(t).applyMatrix4(l);var c={distance:1/0};c.point=new THREE.Vector3,c.face=new THREE.Face3,c.faceIndex=-1,c.meshId=-1,c.lineSegId=-1;var h=i.index;if(!h)return null;for(var u=i.attributes.position,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Face3,y=i.drawRange.start,E=i.drawRange.start+i.drawRange.count;y<E;y+=3){var b=h.getX(y),M=h.getX(y+1),x=h.getX(y+2);if(f.fromBufferAttribute(u,b),p.fromBufferAttribute(u,M),m.fromBufferAttribute(u,x),null!==(r.side===THREE.BackSide?d.intersectTriangle(m,p,f,!0,g):d.intersectTriangle(f,p,m,r.side!==THREE.DoubleSide,g))){g.applyMatrix4(a),v.a=b,v.b=M,v.c=x,v.normal=THREE.Triangle.normal(f,p,m);x=this.ndsModel.viewer.clipPlaneManager.getClipPlaneInfor();if(x)for(var w=x.clipGlobalPlaneObjects,I=x.clippingPlanes,S=!1,T=0;T<w.length;T++){var A=w[T].position,R=I[T].normal.clone();if(g.clone().sub(A).dot(R)<0){S=!0;break}}x=this.ndsModel.viewer.clipBoxManager.getBoxClipInfo();if(x.clipBoxActive&&(x.clipbox.containsPoint(g)||(S=!0)),!S){x=t.origin.distanceTo(g);if(x<c.distance&&(c.distance=x,c.point.copy(g),c.face.copy(v),c.faceIndex=y/3,c.meshId=e,c.lineSegId=-1,c.geomId=this.geomId[e],c.geomUuid=this.geomUuid[e],c.bodyNode=o,c.bodyUuid=o.uuid,n))break}}}return-1===c.meshId?null:c},intersectLineSegments:function(e,t,n,i,r){if(this.lineSegGeomId[e]<0)return null;var o=this.geomManager.getGeomFromId(this.lineSegGeomId[e]);if(0===o.drawRange.count||!o.loaded||o.index&&null==o.index.array)return null;var a=this.lineSegBodyNodes[e];if(a.isHidden())return null;var s=a.worldMatrix.clone();if(this.lineSegMatrixId)for(var l=0;l<16;++l)s.elements[l]=this.matrixes[16*this.lineSegMatrixId[e]+l];var d=this.ndsModel.getBodyTranslate(a);s.elements[12]+=d[0],s.elements[13]+=d[1],s.elements[14]+=d[2];var c=o.boundingBox.clone();if(Math.abs(c.min.x-c.max.x)<i&&(c.min.x-=i/2,c.max.x+=i/2),Math.abs(c.min.y-c.max.y)<i&&(c.min.y-=i/2,c.max.y+=i/2),c.applyMatrix4(s),(!r||!(t.origin.x<c.min.x-i||t.origin.x>c.max.x+i||t.origin.y<c.min.y-i||t.origin.y>c.max.y+i))&&(r||!1!==t.intersectsBox(c))){var h=new THREE.Vector3,c=new THREE.Quaternion;s.decompose(d,c,h);c=new THREE.Matrix4;c.getInverse(s);var u=new THREE.Ray;u.copy(t).applyMatrix4(c);var f={};f.distance=n,f.point=new THREE.Vector3,f.face=null,f.faceIndex=-1,f.meshId=-1,f.lineSegId=-1;var h=i/((h.x+h.y+h.z)/3),p=h*h,m=new THREE.Vector3,g=new THREE.Vector3,v=o.index,y=o.attributes.position;if(!v)return null;var E,b,M=new THREE.Vector3,x=new THREE.Vector3,w=new THREE.Vector3,h=new THREE.Plane(new THREE.Vector3(0,0,-1),0),I=new THREE.Vector3;u.intersectPlane(h,I);for(var S=new THREE.Vector3,T=new THREE.Vector3,A=o.drawRange.start,R=o.drawRange.start+o.drawRange.count;A<R;A+=2)if(E=v.getX(A),b=v.getX(A+1),S.fromBufferAttribute(y,E),T.fromBufferAttribute(y,b),r){var O=new THREE.Line3(S.clone(),T.clone());S.z=0,T.z=0,x.subVectors(I,S),w.subVectors(T,S);var P,C,B=w.dot(x)/w.dot(w);if(!(B<0||1<B||isNaN(B)))if(!(p<I.distanceToSquared(w.clone().multiplyScalar(B).add(S)))){if(P=this.ndsModel.viewer.clipPlaneManager.getClipPlaneInfor())for(var L=P.clipGlobalPlaneObjects,D=P.clippingPlanes,H=!1,N=0;N<L.length;N++){_=L[N].position,k=D[N].normal.clone().normalize();if(O.at(B).clone().applyMatrix4(s).sub(_).dot(k)<0){H=!0;break}}if((C=this.ndsModel.viewer.clipBoxManager.getBoxClipInfo()).clipBoxActive&&(C.clipbox.containsPoint(I)||(H=!0)),!H)return m=O.at(B),f.distance=u.origin.distanceTo(m),f.point.copy(m),f.point.applyMatrix4(s),f.index=A,f.face=null,f.faceIndex=-1,f.meshId=-1,f.lineSegId=e,f.geomId=this.lineSegGeomId[e],f.geomUuid=this.lineSegGeomUuid[e],f.bodyNode=a,f.bodyUuid=a.uuid,f}}else if(!(p<u.distanceSqToSegment(S,T,g,m))){if(P=this.ndsModel.viewer.clipPlaneManager.getClipPlaneInfor())for(var L=P.clipGlobalPlaneObjects,D=P.clippingPlanes,H=!1,F=0;F<L.length;F++){var _=L[F].position,k=D[F].normal.clone().normalize();if(m.clone().applyMatrix4(s).sub(_).dot(k)<0){H=!0;break}}(C=this.ndsModel.viewer.clipBoxManager.getBoxClipInfo()).clipBoxActive&&(C.clipbox.containsPoint(I)||(H=!0)),H||(g.applyMatrix4(s),(M=t.origin.distanceTo(g))<f.distance&&(f.distance=M,f.point.copy(m),f.point.applyMatrix4(s),f.index=A,f.face=null,f.faceIndex=-1,f.meshId=-1,f.lineSegId=e,f.geomId=this.lineSegGeomId[e],f.geomUuid=this.lineSegGeomUuid[e],f.bodyNode=a,f.bodyUuid=a.uuid))}return-1===f.lineSegId?null:f}},setGeomSameMaterialFlag:function(e){if(e.leafBodyAttri){var t=e.leafBodyAttri.bodyMeshIds;if(t)for(var n=0,i=t.length;n<i;++n){var r=t[n];-1<this.geomId[r]&&(1<(r=this.geomManager.getGeomFromId(this.geomId[r])).refMeshes.length&&(r.refMeshesSameMaterial=!1))}}},resetGeomSameMaterialFlags:function(){for(var e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].refMeshesSameMaterial=this.geomManager.geoms[e].refMeshesSameMaterialOriginal;for(e=0,t=this.ndsModel.wholeLeafBodyNodes.length;e<t;++e)if(this.ndsModel.wholeLeafBodyNodes[e].leafBodyAttri){var n=this.ndsModel.wholeLeafBodyNodes[e];if(n.isHidden()||n.isIsolated()||n.isDragged()||n.isSelected()||n.isTransparent()||n.getUserMaterial()||n.getUseBodyNodeMaterial()){var i=n.leafBodyAttri.bodyMeshIds;if(i)for(var r=0,o=i.length;r<o;++r){var a=i[r];-1<this.geomId[a]&&(1<(a=this.geomManager.getGeomFromId(this.geomId[a])).refMeshes.length&&(a.refMeshesSameMaterial=!1))}}}},isMeshSelected:function(e){return this.bodyNodes[e].isSelected()},isLineSegSelected:function(e){return this.lineSegBodyNodes[e].isSelected()},isTextSelected:function(e){return this.textBodyNodes[e].isSelected()},setSelectedMaterial:function(e,t){this.selectedMaterial=e,this.selectedLineSegMaterial=t},isMeshHidden:function(e){return this.bodyNodes[e].isHidden()},isLineHidden:function(e){return this.lineSegBodyNodes[e].isHidden()},isTextHidden:function(e){return this.textBodyNodes[e].isHidden()},RemoveElement:function(e,t){for(var n=1;-1<n;)-1<(n=e.indexOf(t))&&e.splice(n,1)},getNumBodyMeshs:function(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds.length:0},getBodyMesh:function(e,t){t=e.leafBodyAttri.bodyMeshIds[t];return this.getSingleMesh(t)},getBodyMeshId:function(e,t){return e.leafBodyAttri.bodyMeshIds[t]},getBodyMeshIdFromGeomUUid:function(e,t){for(var n=0,i=e.leafBodyAttri.bodyMeshIds.length;n<i;++n){var r=e.leafBodyAttri.bodyMeshIds[n];if(this.geomUuid[r]==t)return r}return-1},getNumBodyLineSegments:function(e){return e.leafBodyAttri?e.leafBodyAttri.bodyLineSegIds.length:0},getBodyLineSegments:function(e,t){t=e.leafBodyAttri.bodyLineSegIds[t];return this.getLineSegments(t)},getBodyLineSegmentsFromGeomUUid:function(e,t){for(var n=[],i=new Set,r=0,o=e.leafBodyAttri.bodyLineSegIds.length;r<o;++r){var a,s=e.leafBodyAttri.bodyLineSegIds[r];this.lineSegGeomUuid[s]!=t||i.has(s)||(n.length,a=this.getLineSegments(s),i.add(s),a&&(n[n.length]=a.clone()))}return 1===n.length?n[0]:1<n.length?n:null},getBodyNode:function(e){return this.bodyNodes[e]}};var S=function(e,t){this.bvh=e,this.node=t,this.loaded=!1,this.sorted=!1,this.renderOnce=!1,this.geoms=[],this.requireReload=!1,this.dirty=!0,this.visible=!0};S.prototype={constructor:S,isLoaded:function(){if(this.loaded)return!0;for(var e=this.bvh.getNumMeshes(this.node),t=[],n=0;n<e;++n){var i=this.bvh.getMeshId(this.node,n);if(!((o=this.bvh.meshManager.geomId[i])<0)){if(!(a=this.bvh.meshManager.geomManager.getGeomFromId(o))||!a.loaded)return!1;1===a.refMeshes.length&&t.push(a)}}this.geoms=t;for(var r=this.bvh.meshManager.geomManager,n=0;n<e;++n){var o,a,i=this.bvh.getMeshId(this.node,n);(o=this.bvh.meshManager.geomId[i])<0||null!=(a=r.getGeomFromId(o)).index&&(r.loadedVertexAttributes.has(a.index.uuid)||(r.usedMemory+=a.index.array.byteLength,r.usedGpuMemory+=a.index.array.byteLength,r.loadedVertexAttributes.add(a.index.uuid)),r.loadedVertexAttributes.has(a.attributes.position.uuid)||(r.usedMemory+=(a.attributes.position.array?a.attributes.position:a.attributes.position.data).array.byteLength,r.usedGpuMemory+=(a.attributes.position.array?a.attributes.position:a.attributes.position.data).array.byteLength,r.loadedVertexAttributes.add(a.attributes.position.uuid)))}return r.usedGpuMemory>=.9*r.maxGpuMemory&&(1===a.refMeshes.length&&(a.useSharedGlBuffer=!0,a.index.dynamic=!0,a.attributes.position.data.dynamic=!0),r.stopLoading=!0,r.allGeomInMemory=!1),this.loaded=!0},sortMeshes:function(e){for(var t=[],n=this.bvh.getNumMeshes(this.node),i=0;i<n;++i){var r=this.bvh.getMeshId(this.node,i),o=new THREE.Vector3;o.z=0;var a=this.bvh.meshManager.materialId[r],s=this.bvh.meshManager.mats[a],s=s.program?s.program.id:1e4;t.push(new m(r,a,s,o.z))}t.sort(v);var l=this.bvh.startMesh[this.node];this.bvh.meshIds||(this.bvh.meshIds=[]);for(i=0;i<n;++i)this.bvh.meshIds[l+i]=t[i].meshId;this.sorted=!0},sortMeshes2:function(e){for(var t=[],n=this.bvh.nMeshes[this.node],i=new THREE.Vector3,r=new THREE.Box3,o=0;o<n;++o){var a=this.bvh.getMeshId(this.node,o);this.bvh.meshManager.getMeshBBox(a,r),(i=r.getCenter()).applyMatrix4(e);var s=this.bvh.meshManager.materialId[a],l=this.bvh.meshManager.mats[s],l=l.program?l.program.id:1e4;t.push(new m(a,s,l,i.z))}t.sort(sortNdsMeshIdObject2);for(var d=this.bvh.startMesh[this.node],o=0;o<n;++o)this.bvh.meshIds[d+o]=t[o].meshId},isAllMeshHidden:function(){this.visible=!0;for(var e=this.bvh.getNumMeshes(this.node),t=0;t<e;++t){var n=this.bvh.getMeshId(this.node,t);if(!this.bvh.meshManager.isMeshHidden(n))return!1}for(var i=this.bvh.nLines?this.bvh.nLines[this.node]:0,t=0;t<i;++t){var r=this.bvh.getLineSegmentsId(this.node,t);if(!this.bvh.meshManager.isLineHidden(r))return!1}var o=this.bvh.nTexts?this.bvh.nTexts[this.node]:0;for(t=0;t<o;++t){var a=this.bvh.getTextId(this.node,t);if(!this.bvh.meshManager.isTextHidden(a))return!1}return!(this.visible=!1)},isVisible:function(e,t){var n,i=new THREE.Box3;if(this.bvh.getNodeBox(this.node,i),Ue.inBIMContext&&0<t.length&&((n=new THREE.Matrix4).fromArray(t),i.applyMatrix4(n)),0<this.bvh.meshManager.ndsModel.explodeFactor||this.bvh.meshManager.ndsModel.hasDraggedBodies()){for(var r=this.bvh.getNumMeshes(this.node),o=[0,0,0],a=[0,0,0],s=0;s<r;++s){var l=this.bvh.getMeshId(this.node,s),l=this.bvh.meshManager.bodyNodes[l],d=this.bvh.meshManager.ndsModel.getBodyTranslate(l);if(0===s)for(var c=0;c<3;++c)o[c]=d[c],a[c]=d[c];else for(c=0;c<3;++c)d[c]<o[c]?o[c]=d[c]:d[c]>a[c]&&(a[c]=d[c])}i.min.x+=o[0],i.min.y+=o[1],i.min.z+=o[2],i.max.x+=a[0],i.max.y+=a[1],i.max.z+=a[2]}return this.visible=e.intersectsBox(i),0==this.visible&&(this.dirty=!1),this.visible},removeGeometry:function(e){var t;0!==this.geoms.length&&this.geoms[0].index&&this.geoms[0].index.array&&(t=this.geoms[0],0===e&&!t.useSharedGlBuffer&&t.index.indexBuffer?this.bvh.meshManager.geomManager.unloadGeometry(t):0<e&&t.useSharedGlBuffer&&(this.requireReload=!0,this.bvh.meshManager.geomManager.unloadGeometry(t)))},reloadGeometry:function(){0!==this.geoms.length&&(this.requireReload=!1,this.renderOnce=!1,this.geoms[0].index.array||this.bvh.meshManager.geomManager.reloadGeometry(this.geoms[0]))},isReloadingGeometry:function(){return!(!(0<this.geoms.length&&this.geoms[0].useSharedGlBuffer)||this.geoms[0].index.array)},getNumMeshes:function(){return this.bvh.getNumMeshes(this.node)},getMesh:function(e){return this.bvh.getMesh(this.node,e)},getMeshId:function(e){return this.bvh.getMeshId(this.node,e)},includeTexts:function(){return!!this.bvh.nTexts},getNumTexts:function(){return this.bvh.getNumTexts(this.node)},getTextId:function(){return this.bvh.getTextId(this.node)},getText:function(e){return this.bvh.getText(this.node,e)},includeLineSegments:function(){return!!this.bvh.nLines},getNumLineSegments:function(){return this.bvh.getNumLineSegments(this.node)},getLineSegmentsWithState:function(e){return this.bvh.getLineSegmentsWithState(this.node,e,1<arguments.length&&void 0!==arguments[1]&&arguments[1],2<arguments.length&&void 0!==arguments[2]&&arguments[2])},getLineSegments:function(e){e=this.bvh.getLineSegmentsWithState(this.node,e,1<arguments.length&&void 0!==arguments[1]&&arguments[1],2<arguments.length&&void 0!==arguments[2]&&arguments[2]);return 1===e.state?e.lineSegments:null},intersect:function(e,t){for(var n=this.bvh.getNumMeshes(this.node),i=new THREE.Box3,r=0;r<n;++r){var o=this.bvh.getMeshId(this.node,r),a=this.bvh.meshManager.bodyNodes[o];this.bvh.meshManager.ndsModel.hasHiddenBodies&&a.isHidden()||(this.bvh.meshManager.getMeshBBox(o,i),e.intersectsBox(i)&&t.push(o))}}};var T=function(e){this.version=0,this.parent=-1,this.bboxes=[],this.leftChild=[],this.nMeshes=[],this.startMesh=[],this.nLines=null,this.startLine=null,this.nTexts=null,this.startText=null,this.nNodes=0,this.meshIds=[],this.lineIds=null,this.textIds=null,this.meshManager=e,this.nodeId2MeshSetIdMap={}};T.prototype={constructor:T,setNumNodes:function(e){this.nNodes=e,this.bboxes=new Float32Array(6*e),this.leftChild=new Int32Array(e),this.nMeshes=new Int32Array(e),this.startMesh=new Int32Array(e),4===this.version&&(this.nLines=new Int32Array(e),this.startLine=new Int32Array(e),this.nTexts=new Int32Array(e),this.startText=new Int32Array(e))},setNode:function(e,t,n,i,r,o,a,s,l){for(var d=0,d=0;d<6;++d)this.bboxes[6*e+d]=t[d];this.leftChild[e]=n,this.nMeshes[e]=i,this.startMesh[e]=r,this.nLines&&void 0!==o&&(this.nLines[e]=o,this.startLine[e]=a),this.nTexts&&void 0!==s&&(this.nTexts[e]=s,this.startText[e]=l)},buildMeshSets:function(){var e=[],t=0;if(4===this.version)for(t=0;t<this.nNodes;++t)(0<this.nMeshes[t]||0<this.nLines[t]||0<this.nTexts[t])&&(e.push(new S(this,t)),this.nodeId2MeshSetIdMap[t]=e.length-1);else for(t=0;t<this.nNodes;++t)-1===this.leftChild[t]&&(e.push(new S(this,t)),this.nodeId2MeshSetIdMap[t]=e.length-1);return e},getNodeBox:function(e,t){t=t||new THREE.Box3;return t.min.fromArray(this.bboxes,6*e),t.max.fromArray(this.bboxes,6*e+3),t},setMeshIds:function(e){this.meshIds=e},getNumMeshes:function(e){return this.nMeshes[e]},getMesh:function(e,t){t=this.startMesh[e]+t,t=this.meshIds?this.meshIds[t]:t;return this.meshManager.getMesh(t)},getMeshId:function(e,t){t=this.startMesh[e]+t;return this.meshIds?this.meshIds[t]:t},getNumTexts:function(e){return this.nTexts?this.nTexts[e]:-1},getTextId:function(e,t){return this.startText[e]+t},getText:function(e,t){if(this.startText){t=this.startText[e]+t;return this.meshManager.getText(t)}return null},getNumLineSegments:function(e){return this.nLines?this.nLines[e]:-1},getLineSegmentsId:function(e,t){return this.startLine[e]+t},getLineSegmentsWithState:function(e,t,n,i){if(this.startLine){t=this.startLine[e]+t;return this.meshManager.getLineSegmentsWithState(t,n,i)}return{state:-1,lineSegments:null}},getLineSegments:function(e,t,n,i){i=this.getLineSegmentsWithState(e,t,n,i);return 1===i.state?i.lineSegments:null},intersect:function(e){var t,n,i=[0],r=new THREE.Box3,o=[];if(0<this.nNodes)for(var a=0;a<i.length;++a)t=i[a],r.min.fromArray(this.bboxes,6*t),r.max.fromArray(this.bboxes,6*t+3),(this.meshManager.ndsModel.hasDraggedBodies()||0<this.meshManager.ndsModel.explodeFactor||0<this.meshManager.ndsModel.explodeFactorX||0<this.meshManager.ndsModel.explodeFactorY||0<this.meshManager.ndsModel.explodeFactorZ||Ue.inBIMContext||e.intersectsBox(r))&&(0<this.nMeshes[t]&&void 0!==(n=this.nodeId2MeshSetIdMap[t])&&o.push(n),-1!==this.leftChild[t]&&(i.push(this.leftChild[t]),i.push(this.leftChild[t]+1)));return o}};function A(e){this.ndsModel=e,this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0,this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0;var v=this;this.refPlanes=[],this.refAxises=[];var y=null,E=null,f=null,p=null,m=null,g=null,b=new THREE.Mesh,M=new THREE.Mesh,x=new THREE.Mesh,w=new THREE.LineSegments,I=new THREE.LineSegments,S=new THREE.LineSegments,T=new ae,A=new ae,R=new ae,O=new ae,P=new ae,C=new ae,B=new THREE.LineSegments,L=new THREE.LineSegments,D=new THREE.LineSegments,H=new ae,N=new ae,F=new ae;this.hasNormalPlane=!1,this.hasSelectedPlane=!1,this.hasPreselecedPlane=!1,this.hasNormalAxis=!1,this.hasSelectedAxis=!1,this.hasPreselectedAxis=!1,this.axisMaterial=new THREE.LineDashedMaterial({color:255,linewidth:2,dashSize:.003,gapSize:.002}),this.axisSelectedMaterial=new THREE.LineDashedMaterial({color:65280,linewidth:2,dashSize:.003,gapSize:.002}),this.axisPreSelectedMaterial=new THREE.LineDashedMaterial({color:65535,linewidth:2,dashSize:.003,gapSize:.002}),this.planeMaterial=new THREE.MeshBasicMaterial({color:15527167,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planeSelectedMaterial=new THREE.MeshBasicMaterial({color:16763200,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planePreSelectedMaterial=new THREE.MeshBasicMaterial({color:15527167,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planeEdgeMaterial=new THREE.LineBasicMaterial({color:5987327}),this.planeEdgeSelectedMaterial=new THREE.LineBasicMaterial({color:16776960}),this.planeEdgePreSelectedMaterial=new THREE.LineBasicMaterial({color:65535}),this.overrideMaterial=null,this.overrideMaterialCopy=null,this.useBodyIdMaterial=!1,this.getPlaneDispData=function(){var e={};if(!function(){if(v.needUpdateRefPlaneVertexBuffer){var e=v.refPlanes.length,t=4*e*3;y&&y.length==t||(y=new Float32Array(t),E=new THREE.BufferAttribute(y,3));for(var n=new THREE.Vector3,i=0;i<e;i++)for(var r=v.refPlanes[i].worldMatrix,o=v.refPlanes[i].leafBodyAttri.coords,a=0;a<4;a++)n.fromArray(o,3*a),n.applyMatrix4(r),y[3*(4*i+a)+0]=n.x,y[3*(4*i+a)+1]=n.y,y[3*(4*i+a)+2]=n.z;E.needsUpdate=!0,v.needUpdateRefPlaneVertexBuffer=!1}}(),this.needUpdateRefPlaneDispData){for(var t=this.refPlanes.length,n=4*t,i=0,r=0,o=0,a=0;a<t;a++)this.refPlanes[a].isHidden()||(this.refPlanes[a].isPreSelected()?o++:this.refPlanes[a].isSelected()?r++:i++);var s=null,l=null,d=null,c=null,h=null,u=null;0<i?(this.hasNormalPlane=!0,s=new(n<=65535?Uint16Array:Uint32Array)(6*i),c=new(n<=65535?Uint16Array:Uint32Array)(8*i),b.geometry=T,b.material=this.planeMaterial,T.attributes.position=E,T.index=new THREE.BufferAttribute(s,1),w.geometry=O,w.material=this.planeEdgeMaterial,O.attributes.position=E,O.index=new THREE.BufferAttribute(c,1),e.normalPlaneMesh=b,e.normalPlaneEdge=w):(this.hasNormalPlane=!1,b.geometry=null,T.index=null,T.attributes.position=null,w.geometry=null,O.index=null,O.attributes.position=null),0<r?(this.hasSelectedPlane=!0,l=new(n<=65535?Uint16Array:Uint32Array)(6*r),h=new(n<=65535?Uint16Array:Uint32Array)(8*r),M.geometry=A,M.material=this.planeSelectedMaterial,A.attributes.position=E,A.index=new THREE.BufferAttribute(l,1),I.geometry=P,I.material=this.planeEdgeSelectedMaterial,P.attributes.position=E,P.index=new THREE.BufferAttribute(h,1),e.selectedPlaneMesh=M,e.selectedPlaneEdge=I):(this.hasSelectedPlane=!1,M.geometry=null,A.index=null,A.attributes.position=null,I.geometry=null,P.index=null,P.attributes.position=null),0<o?(this.hasPreselecedPlane=!0,d=new(n<=65535?Uint16Array:Uint32Array)(6*o),u=new(n<=65535?Uint16Array:Uint32Array)(8*o),x.geometry=R,x.material=this.planePreSelectedMaterial,R.attributes.position=E,R.index=new THREE.BufferAttribute(d,1),S.geometry=C,S.material=this.planeEdgePreSelectedMaterial,C.attributes.position=E,C.index=new THREE.BufferAttribute(u,1),e.preselectedPlaneMesh=x,e.preselectedPlaneEdge=S):(this.hasPreselecedPlane=!1,x.geometry=null,R.index=null,R.attributes.position=null,S.geometry=null,C.index=null,C.attributes.position=null);for(var f=0,p=0,m=0,a=0;a<t;a++)if(!this.refPlanes[a].isHidden())if(this.refPlanes[a].isPreSelected()){d[6*f+0]=4*a+0,d[6*f+1]=4*a+1,d[6*f+2]=4*a+2,d[6*f+3]=4*a+2,d[6*f+4]=4*a+3,d[6*f+5]=4*a+0;for(var g=0;g<3;g++)u[8*f+2*g]=4*a+g,u[8*f+2*g+1]=4*a+g+1;u[8*f+6]=4*a+3,u[8*f+7]=4*a,f++}else if(this.refPlanes[a].isSelected()){l[6*p+0]=4*a+0,l[6*p+1]=4*a+1,l[6*p+2]=4*a+2,l[6*p+3]=4*a+2,l[6*p+4]=4*a+3,l[6*p+5]=4*a+0;for(g=0;g<3;g++)h[8*p+2*g]=4*a+g,h[8*p+2*g+1]=4*a+g+1;h[8*p+6]=4*a+3,h[8*p+7]=4*a,p++}else{s[6*m+0]=4*a+0,s[6*m+1]=4*a+1,s[6*m+2]=4*a+2,s[6*m+3]=4*a+2,s[6*m+4]=4*a+3,s[6*m+5]=4*a+0;for(g=0;g<3;g++)c[8*m+2*g]=4*a+g,c[8*m+2*g+1]=4*a+g+1;c[8*m+6]=4*a+3,c[8*m+7]=4*a,m++}this.needUpdateRefPlaneDispData=!1}else this.hasNormalPlane&&(e.normalPlaneMesh=b,e.normalPlaneEdge=w),this.hasSelectedPlane&&(e.selectedPlaneMesh=M,e.selectedPlaneEdge=I),this.hasPreselecedPlane&&(e.preselectedPlaneMesh=x,e.preselectedPlaneEdge=S);return e},this.getAxisDispData=function(){var e={};if(!function(){if(v.needUpdateRefAxisVertexBuffer){var e=v.refAxises.length,t=2*e*3,n=2*e;f&&f.length==t||(f=new Float32Array(t),p=new THREE.BufferAttribute(f,3),m=new Float32Array(n),g=new THREE.BufferAttribute(m,1));for(var i,r=new THREE.Vector3,o=new THREE.Vector3,a=0;a<e;a++){i=v.refAxises[a].worldMatrix,s=v.refAxises[a].leafBodyAttri.coords,r.fromArray(s,0),o.fromArray(s,3);var s=r.distanceTo(o);r.applyMatrix4(i),o.applyMatrix4(i),f[2*a*3]=r.x,f[2*a*3+1]=r.y,f[2*a*3+2]=r.z,f[3*(2*a+1)]=o.x,f[3*(2*a+1)+1]=o.y,f[3*(2*a+1)+2]=o.z,m[2*a]=0,m[2*a+1]=s}p.needsUpdate=!0,g.needsUpdate=!0,v.needUpdateRefAxisVertexBuffer=!1}}(),this.needUpdateRefAxisDispData){for(var t=this.refAxises.length,n=2*t,i=0,r=0,o=0,a=0;a<t;a++)this.refAxises[a].isHidden()||(this.refAxises[a].isPreSelected()?o++:this.refAxises[a].isSelected()?r++:i++);var s=null,l=null,d=null;0<i?(this.hasNormalAxis=!0,s=new(n<=65535?Uint16Array:Uint32Array)(2*i),B.geometry=H,B.material=this.axisMaterial,H.attributes.position=p,H.attributes.lineDistance=g,H.index=new THREE.BufferAttribute(s,1),e.normalAxisLines=B):(this.hasNormalAxis=!1,B.geometry=null,H.index=null,H.attributes.position=null,H.attributes.lineDistance=null),0<r?(this.hasSelectedAxis=!0,l=new(n<=65535?Uint16Array:Uint32Array)(2*r),L.geometry=N,L.material=this.axisSelectedMaterial,N.attributes.position=p,N.attributes.lineDistance=g,N.index=new THREE.BufferAttribute(l,1),e.selectedAxisLines=L):(this.hasSelectedAxis=!1,L.geometry=null,N.index=null,N.attributes.position=null,N.attributes.lineDistance=null),0<o?(this.hasPreselectedAxis=!0,d=new(n<=65535?Uint16Array:Uint32Array)(2*o),D.geometry=F,D.material=this.axisPreSelectedMaterial,F.attributes.position=p,F.attributes.lineDistance=g,F.index=new THREE.BufferAttribute(d,1),e.preselectedAxisLines=D):(this.hasPreselectedAxis=!1,D.geometry=null,F.index=null,F.attributes.position=null,F.attributes.lineDistance=null);for(var c=0,h=0,u=0,a=0;a<t;a++)this.refAxises[a].isHidden()||(this.refAxises[a].isPreSelected()?(d[2*c]=2*a,d[2*c+1]=2*a+1,c++):this.refAxises[a].isSelected()?(l[2*h]=2*a,l[2*h+1]=2*a+1,h++):(s[2*u]=2*a,s[2*u+1]=2*a+1,u++));this.needUpdateRefAxisDispData=!1}else this.hasNormalAxis&&(e.normalAxisLines=B),this.hasSelectedAxis&&(e.selectedAxisLines=L),this.hasPreselectedAxis&&(e.preselectedAxisLines=D);return e},this.addRefEntity=function(e){"RefAxis"==e.type?(this.refAxises.push(e),this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0):"RefPlane"==e.type&&(this.refPlanes.push(e),this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0)},this.removeRefEntity=function(e){var t;"RefAxis"==e.type?(-1<(t=this.refAxises.indexOf(e))&&this.refAxises.splice(t,1),this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0):"RefPlane"==e.type&&(-1<(t=this.refPlanes.indexOf(e))&&this.refPlanes.splice(t,1),this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0)}}function R(e,t){return e.z-t.z}function O(e,t){this.id=e,this.z=t}NDS.EXPLODEMODE={NORMAL:32,X:1,Y:2,Z:4,LEVEL:8,SELECTED:16};var ze=function(e){var t,o,a,s,l,d,c=this;function n(){}this.viewer=e,this.geomManager=new h,this.meshManager=new I(this.geomManager,this),this.referenceEntityDispManager=new A(this),this.meshSets=[],this.bvh=new T(this.meshManager),t=ae,e=THREE.BufferGeometry,n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t,this.lineSegmentsSet=new p(this.meshManager),this.SHADED_WITH_EDGES=1,this.SHADED=2,this.WIREFRAME=3,this.HIDDEN_LINE_REMOVE=4,this.HIDDEN_LINE_VISIBLE=5,this.drawMode=1,this.renderOnce=!1,this.renderMeshSetCount=0,this.spriteDirty=!0,this.rootBodyNode=null,this.bodyUuid2NodeMap={},this.meshUuid2GeomUuidMap={},this.fileguidTouuid={},this.objectidTouuid={},this.is2DModel=!1,this.wholeLeafBodyNodes=[],this.wholeRefEntityNodes=[],this.wholeCoordinateNodes=[],this.hasRawMesh=!1,this.bvhCreater=null,this.transparentBodies=[],this.transparentBodiesDirty=!1,this.transparentBodyChanged=!1,this.transparentizedBodies=[],this.selectedBodies=[],this.selectedBodiesDirty=!1,this.draggedBodies=[],this.hideBodies=[],this.preselectedObject=null,this.hasHiddenBodies=!1,this.referenceEntityDirty=!1,this.explodeFactor=0,this.explodeFactorX=0,this.explodeFactorY=0,this.explodeFactorZ=0,this.explodeMode=NDS.EXPLODEMODE.NORMAL,this.explodeLevel=0,this.explodeObject=null,this.leafNodeCount=0,this.bodyNodeUUidToMaterial={},this.ModelUpMatrix4=[],this.sortMeshSets=(o=[],a=new THREE.Vector3,s=new THREE.Box3,l=new THREE.Vector3,d=new THREE.Vector3,function(e,t){for(var n=o.length=0,i=e.length;n<i;++n){c.bvh.getNodeBox(c.meshSets[e[n]].node,s),s.getCenter(l),s.getSize(d);var r=.5*d.length(),r=Math.abs(r/(a.dot(t.pixelSizeVector)+t.pixelSizeVector.w));o.push(new O(e[n],r))}o.sort(function(e,t){return t.z-e.z});for(n=0,i=e.length;n<i;++n)e[n]=o[n].id}),this.needsFastRendering=!1,this.setDirty=function(e){function t(){o.needsFastRendering=!1,clearTimeout(r),r=null}var n,i,r=null,o=0<arguments.length&&void 0!==e?e:this;return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:200;!function(){for(n=0,i=o.meshSets.length;n<i;++n)o.meshSets[n].dirty=!0,o.meshSets[n].visible=!0;for(o.selectedBodiesDirty=!0,o.transparentBodiesDirty=!0,o.referenceEntityDirty=!0,n=0,i=o.geomManager.geoms.length;n<i;++n)o.geomManager.geoms[n].dirty=!0;o.lineSegmentsSet.dirty=!0,o.meshManager.dirty=!0,o.spriteDirty=!0}(),o.needsFastRendering||(o.needsFastRendering=!0,r&&clearTimeout(r),r=setTimeout(t,e))}}(this),this.backupDirty=function(){for(var e=0,t=this.meshSets.length;e<t;++e)this.meshSets[e].oldDirty=this.meshSets[e].dirty,this.meshSets[e].oldVisible=this.meshSets[e].visible;for(this.oldSelectedBodiesDirty=this.selectedBodiesDirty,this.oldTransparentBodiesDirty=this.transparentBodiesDirty,this.oldReferenceEntityDirty=this.referenceEntityDirty,e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].oldDirty=this.geomManager.geoms[e].dirty;this.lineSegmentsSet.oldDirty=this.lineSegmentsSet.dirty,this.meshManager.oldDirty=this.meshManager.dirty,this.oldSpriteDirty=this.spriteDirty},this.resetDirty=function(){for(var e=0,t=this.meshSets.length;e<t;++e)null!=this.meshSets[e].oldDirty&&(this.meshSets[e].dirty=this.meshSets[e].oldDirty),null!=this.meshSets[e].oldVisible&&(this.meshSets[e].visible=this.meshSets[e].oldVisible);for(this.selectedBodiesDirty=this.oldSelectedBodiesDirty,this.transparentBodiesDirty=this.oldTransparentBodiesDirty,this.referenceEntityDirty=this.oldReferenceEntityDirty,e=0,t=this.geomManager.geoms.length;e<t;++e)null!=this.geomManager.geoms[e].oldDirty&&(this.geomManager.geoms[e].dirty=this.geomManager.geoms[e].oldDirty);this.lineSegmentsSet.dirty=this.lineSegmentsSet.oldDirty,this.meshManager.dirty=this.meshManager.oldDirty,this.spriteDirty=this.oldSpriteDirty},this.dispose=function(){c.meshManager.dispose(),c.geomManager.dispose()}};function C(e,t){return e.z-t.z}function B(e,t){return t.z-e.z}ze.prototype={constructor:ze,getGeomManager:function(){return this.geomManager},getMeshManager:function(){return this.meshManager},getMeshSets:function(){return this.meshSets},buildMeshSets:function(){this.meshSets=this.bvh.buildMeshSets()},sortMeshSets2:function(e){for(var t,n,i,r=[],o=new THREE.Box3,a=0,s=e.length;a<s;++a)o.min.fromArray(this.bvh.bboxes,6*this.meshSets[e[a]].node),o.max.fromArray(this.bvh.bboxes,6*this.meshSets[e[a]].node+3),t=o.max.x-o.min.x,n=o.max.y-o.min.y,i=o.max.z-o.min.z,r.push(new O(e[a],t*n*i));r.sort(R);for(a=0,s=e.length;a<s;++a)e[a]=r[a].id},getRightBodyuuid:function(e,t){for(var n=0;n<t.length;++n)for(var i=this.bodyUuid2NodeMap[t[n]];i.parent;){if(i.parent.fileguid==e)return t[n];i=i.parent}return t[0]},getLineSegmentsSet:function(){return this.lineSegmentsSet},prepareForRendering:function(e,t){this.meshManager.supportInstancedArrays=e,this.meshManager.supportInstancedArraysCopy=e,this.meshManager.mapGeomUuidToGeomId();function n(e){if(e.unload=!0,e.visible=!1,0<e.children.length)for(var t=0;t<e.children.length;++t)n(e.children[t])}this.leafNodeCount=0,this.wholeLeafBodyNodes.length=0,this.wholeRefEntityNodes.length=0,this.wholeCoordinateNodes.length=0,this.bodyUuid2NodeMap={};for(var i=[this.rootBodyNode],r=0;r<i.length;++r){var o=i[r],a=(this.bodyUuid2NodeMap[o.uuid]=o).type.toLowerCase();if(0===o.children.length&&("part"!=a&&"assembly"!=a&&(o.id=this.meshManager.bodyUuid2IdMap[o.uuid],(null==o.id||o.id<0)&&(1==Ue.inAssemblyContext?o.id=this.leafNodeCount++:(this.meshManager.bodyUuid2IdMap[o.uuid]=this.meshManager.bodyUuids.length,this.meshManager.bodyUuids.push(o.uuid),o.id=this.meshManager.bodyUuid2IdMap[o.uuid]))),o.isReferenceEntity()?this.wholeRefEntityNodes.push(o):o.isCoordinate()?(this.wholeCoordinateNodes.push(o),null==o.worldMatrix&&(o.worldMatrix=this.calculateNodeWorldMatrix(o)),null==o.leafBodyAttri&&(o.leafBodyAttri=new M,o.visible||o.hide())):("part"!=a&&"assembly"!=a&&this.wholeLeafBodyNodes.push(o),null==o.worldMatrix&&(o.worldMatrix=this.calculateNodeWorldMatrix(o))),this.hasRawMesh||"rawmesh"!=a||(this.hasRawMesh=!0)),o.pmiuuid&&!t.is2DModel&&t.pmiObject){null==o.worldMatrix&&(o.worldMatrix=this.calculateNodeWorldMatrix(o));for(var s=0;s<o.pmiuuid.length;++s){var l=o.pmiuuid[s],l=t.pmiObject.getObjectByName(l);l&&"PMI"==l.type&&(l.matrix.multiply(o.worldMatrix),l.updateMatrixWorld(!0))}}this.objectidTouuid?t.unvisibleList&&-1!=t.unvisibleList.indexOf(o.objectid)&&n(o):(null==(a=this.meshManager.bodyUuid2IdMap[o.uuid])&&(this.meshManager.bodyUuid2IdMap[o.uuid]=this.meshManager.bodyUuids.length,this.meshManager.bodyUuids.push(o.uuid),a=this.meshManager.bodyUuid2IdMap[o.uuid]),t.useUnvisibleList&&t.unvisibleList&&-1!=t.unvisibleList.indexOf(a)&&n(o));for(var s=0,d=o.children.length;s<d;++s)i.push(o.children[s])}for(r=0;r<this.meshManager.nMeshes;++r){var c=this.meshManager.bodyUuids[r];if(u=this.bodyUuid2NodeMap[c])if(null==(this.meshManager.bodyNodes[r]=u).leafBodyAttri){u.leafBodyAttri=new b,null==u.worldMatrix&&(u.worldMatrix=this.calculateNodeWorldMatrix(u)),this.inIsolate()&&u.isolate(),u.leafBodyAttri.bodyMeshIds.push(r);for(s=0;s<6;++s)u.leafBodyAttri.bodyBbox[s]=this.meshManager.bboxes[6*r+s]}else if(-1==u.leafBodyAttri.bodyMeshIds.indexOf(r)){u.leafBodyAttri.bodyMeshIds.push(r);for(s=0;s<3;++s)this.meshManager.bboxes[6*r+s]<u.leafBodyAttri.bodyBbox[s]&&(u.leafBodyAttri.bodyBbox[s]=this.meshManager.bboxes[6*r+s]),this.meshManager.bboxes[6*r+3+s]>u.leafBodyAttri.bodyBbox[3+s]&&(u.leafBodyAttri.bodyBbox[3+s]=this.meshManager.bboxes[6*r+3+s])}}for(var h=[],r=0;r<this.meshManager.nLineSegments;++r){c=this.meshManager.lineSegBodyUuids[r];(u=this.bodyUuid2NodeMap[c])&&(null==(this.meshManager.lineSegBodyNodes[r]=u).leafBodyAttri?(u.leafBodyAttri=new b,u.leafBodyAttri.bodyLineSegIds.push(r),null==u.worldMatrix&&(u.worldMatrix=this.calculateNodeWorldMatrix(u)),h.push(u)):-1==u.leafBodyAttri.bodyLineSegIds.indexOf(r)&&u.leafBodyAttri.bodyLineSegIds.push(r))}for(r=0;r<this.meshManager.nTexts;++r){var c=this.meshManager.textBodyUuids[r],u=this.bodyUuid2NodeMap[c];if(null==(this.meshManager.textBodyNodes[r]=u).leafBodyAttri?(u.leafBodyAttri=new b,u.leafBodyAttri.bodyTextIds.push(r),null==u.worldMatrix&&(u.worldMatrix=this.calculateNodeWorldMatrix(u))):-1==u.leafBodyAttri.bodyTextIds.indexOf(r)&&u.leafBodyAttri.bodyTextIds.push(r),!(this.meshManager.textGeomId[r]<0)){var f=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[r]),p=this.viewer.scene.getObjectByName("dashLine");if(p){p=p.getObjectByName(f.uuid);if(p){f=this.meshManager.mats[this.meshManager.textMaterialId[r]];p.material.color.copy(f.color);var m=new THREE.Matrix4;if(this.meshManager.matrixes)for(var g=0;g<16;++g)m.elements[g]=this.meshManager.matrixes[16*this.meshManager.textMatrixId[r]+g];else m.copy(u.worldMatrix);p.applyMatrix(m)}}}}if(0<(this.pureLineBody=h).length)for(r=0;r<h.length;r++)6!=h[r].leafBodyAttri.bodyBbox.length&&this.calculateLineBodyBoundingBox(h[r]);this.transparentBodyChanged=!0,this.getAllTransparentBodies(!0);for(i=[this.rootBodyNode],r=0;r<i.length;++r)if((o=i[r]).visible)for(s=0,d=o.children.length;s<d;++s)i.push(o.children[s]);else this.hideBody(o);for(r=0;r<this.wholeCoordinateNodes.length;++r){var v,y=this.wholeCoordinateNodes[r];y.visible&&(y.leafBodyAttri.renderObject?y.leafBodyAttri.renderObject.attach(y):(v=null,v=this.viewer.canvas2D||this.viewer.canvas3D,(v=new be(this.viewer.camera,v)).attach(y),y.leafBodyAttri.renderObject=v,this.viewer.scene.add(v)))}this.meshManager.resetGeomSameMaterialFlags()},backupAllBodyFlag:function(){for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlagBackup=this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlag)},resetAllBodyFlag:function(){for(var e=!1,t=0,n=this.wholeLeafBodyNodes.length;t<n;++t)this.wholeLeafBodyNodes[t].leafBodyAttri&&null!=this.wholeLeafBodyNodes[t].leafBodyAttri.bodyFlagBackup&&(this.wholeLeafBodyNodes[t].leafBodyAttri.bodyFlag=this.wholeLeafBodyNodes[t].leafBodyAttri.bodyFlagBackup,e=!(this.wholeLeafBodyNodes[t].leafBodyAttri.bodyFlagBackup=void 0));e&&this.meshManager.resetGeomSameMaterialFlags()},requireContinueLoading:function(){return 0<this.geomManager.bufferChunksToLoad.length},hasEnoughAvailableMemory:function(){return 10485760<=this.geomManager.maxMemory-this.geomManager.usedMemory||this.geomManager.usedMemory<.9*this.geomManager.maxMemory},pageOut:function(){for(var e=this.getMeshSets(),t=0,n=0;n<e.length&&!this.hasEnoughAvailableMemory();++n)(o=e[n]).renderOnce&&o.removeGeometry(t);t=1;var i=this.getLineSegmentsSet();if(this.hasEnoughAvailableMemory()||i.removeGeometry(),!this.hasEnoughAvailableMemory()){for(var t=2,r=[],n=0;n<e.length;++n)(o=e[n]).visible&&o.dirty||r.push(n);this.sortMeshSets2(r);for(var o,a=0;a<r.length&&!this.hasEnoughAvailableMemory();++a)(o=e[r[a]]).removeGeometry(t)}},continueLoading:function(){this.geomManager.stopLoading=!1,this.geomManager.bufferChunksInLoading<=this.geomManager.maxBufferChunksInLoading&&this.geomManager.loadBufferChunk(this.geomManager.bufferChunksToLoad.shift())},setDrawMode:function(e){this.drawMode=e},getDrawModeFace:function(){return this.drawMode===this.SHADED_WITH_EDGES||this.drawMode===this.SHADED||this.drawMode===this.HIDDEN_LINE_REMOVE||this.drawMode===this.HIDDEN_LINE_VISIBLE},getDrawModeFaceColorMask:function(){return this.drawMode!==this.HIDDEN_LINE_REMOVE&&this.drawMode!==this.HIDDEN_LINE_VISIBLE},getDrawModeEdge:function(){return this.drawMode===this.SHADED_WITH_EDGES||this.drawMode===this.WIREFRAME||this.drawMode===this.HIDDEN_LINE_REMOVE||this.drawMode===this.HIDDEN_LINE_VISIBLE},getDrawModeHiddenEdge:function(){return this.drawMode===this.HIDDEN_LINE_VISIBLE},setOverrideMaterial:function(e,t,n){this.meshManager.overrideMaterial=e,this.meshManager.overrideMaterialCopy=t,this.meshManager.useBodyIdMaterial=n,this.referenceEntityDispManager.overrideMaterial=e,this.referenceEntityDispManager.overrideMaterialCopy=t,this.referenceEntityDispManager.useBodyIdMaterial=n,e?n&&(this.meshManager.supportInstancedArrays=!1):this.meshManager.supportInstancedArrays=this.meshManager.supportInstancedArraysCopy},setRootBodyNode:function(e,t,n){if(this.rootBodyNode)if("assembly"==e.type.toLowerCase())this.rootBodyNode.children.push(e),e.parent=this.rootBodyNode;else for(var i=0;i<e.children.length;i++)this.rootBodyNode.children.push(e.children[i]),e.children[i].parent=this.rootBodyNode;else this.rootBodyNode=e;this.rootBodyNode.ndsModel=this,Object.assign(this.meshUuid2GeomUuidMap,t);for(var r=0,o=this.geomManager.geoms.length;r<o;++r){var a=this.geomManager.geoms[r];n[a.uuid]&&(a.tangentEdgeObject=!0)}},setBodyNodeMaterials:function(e){for(var t in Object.assign(this.bodyNodeUUidToMaterial,e),this.bodyNodeUUidToMaterial){var n=this.getBodyNodeFromUuid(t),t=this.bodyNodeUUidToMaterial[t];n&&t&&(n.useBodyNodeMaterial=!0)}this.meshManager.resetGeomSameMaterialFlags()},getBodyNodeUUidToMaterial:function(){return this.bodyNodeUUidToMaterial},setBodyNodeMaterial:function(e,t){e=this.getBodyNodeFromUuid(e);this.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!0,this.meshManager.setGeomSameMaterialFlag(e)},removeAllBodyNodeMaterials:function(){for(var e in this.bodyNodeUUidToMaterial){var t=this.getBodyNodeFromUuid(e);t&&this.bodyNodeUUidToMaterial[e]&&(t.useBodyNodeMaterial=!1)}this.bodyNodeUUidToMaterial={},this.meshManager.resetGeomSameMaterialFlags()},removeBodyNodeMaterial:function(e){var t=this.getBodyNodeFromUuid(e);t&&this.bodyNodeUUidToMaterial[e]&&(delete this.bodyNodeUUidToMaterial[e],t.useBodyNodeMaterial=!1,this.meshManager.setGeomSameMaterialFlag(t))},getBodyNode:function(e){for(var t=0,n=this.wholeLeafBodyNodes.length;t<n;t++)if(this.wholeLeafBodyNodes[t].id==e)return this.wholeLeafBodyNodes[t];for(t=0,n=this.wholeRefEntityNodes.length;t<n;t++)if(this.wholeRefEntityNodes[t].id==e)return this.wholeRefEntityNodes[t];for(t=0,n=this.wholeCoordinateNodes.length;t<n;t++)if(this.wholeCoordinateNodes[t].id==e)return this.wholeCoordinateNodes[t];return null},getBodyNodeFromUuid:function(e){return this.bodyUuid2NodeMap[e]},getSelectedLeafBodyNodes:function(e){for(var t=[],n=this.getLeafBodies(e),i=0,r=n.length;i<r;i++)n[i].leafBodyAttri&&n[i].isSelected()&&t.push(n[i]);return t},getLeafBodies:function(e){var t=[];if(0==e.children.length)0<=e.id&&!e.isReferenceEntity()&&!e.isCoordinate()&&t.push(e);else for(var n=[e],i=0;i<n.length;++i)if(0==n[i].children.length)0<=n[i].id&&!n[i].isReferenceEntity()&&!n[i].isCoordinate()&&t.push(n[i]);else for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},getLeafPMIuuid:function(e){var t=[];if(e.pmiuuid&&(t=t.concat(e.pmiuuid)),0<e.children.length)for(var n=[e],i=0;i<n.length;++i)if(n[i].pmiuuid&&0!=i&&(t=t.concat(n[i].pmiuuid)),0<n[i].children.length)for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},getLayerBodies:function(e){var t=[];if("AcDbLayerTableRecord"===e.type)t.push(e);else for(var n=[e],i=0;i<n.length;++i)if("AcDbLayerTableRecord"===n[i].type)t.push(n[i]);else for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},getLeafReferenceEntities:function(e){var t=[];if(0==e.children.length)e.isReferenceEntity()&&t.push(e);else for(var n=[e],i=0;i<n.length;++i)if(0==n[i].children.length)n[i].isReferenceEntity()&&t.push(n[i]);else for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},getLeafCoordinate:function(e){var t=[];if(0==e.children.length)e.isCoordinate()&&t.push(e);else for(var n=[e],i=0;i<n.length;++i)if(0==n[i].children.length)n[i].isCoordinate()&&t.push(n[i]);else for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},getAllLeafNodes:function(e){var t=[];if(0==e.children.length)t.push(e);else for(var n=[e],i=0;i<n.length;++i)if(0==n[i].children.length)t.push(n[i]);else for(var r=0,o=n[i].children.length;r<o;++r)n.push(n[i].children[r]);return t},updateNodeMatrix:function(e,t,n){e=this.bodyUuid2NodeMap[e];if(e){e.matrix=t.slice(0);for(var i=this.getLeafBodies(e),r=0,o=i.length;r<o;r++)if(i[r].worldMatrix=this.calculateNodeWorldMatrix(i[r]),i[r].leafBodyAttri){var a=i[r].leafBodyAttri.bodyMeshIds;if(0<a.length){for(var s=new THREE.Box3,l=null,d=0,c=a.length;d<c;++d){var h=a[d];-1<this.meshManager.geomId[h]&&(this.geomManager.getGeomFromId(this.meshManager.geomId[h]).updateModelMatrix=!0,this.meshManager.updateMeshBBox(h)),this.meshManager.getMeshBBox(h,s),this.bvhCreater&&this.bvhCreater.m_boxes[h].SetMinMaxPointFromArray([s.min.x,s.min.y,s.min.z,s.max.x,s.max.y,s.max.z]),0==d?l=s.clone():l.union(s)}l&&(i[r].leafBodyAttri.bodyBbox[0]=l.min.x,i[r].leafBodyAttri.bodyBbox[1]=l.min.y,i[r].leafBodyAttri.bodyBbox[2]=l.min.z,i[r].leafBodyAttri.bodyBbox[3]=l.max.x,i[r].leafBodyAttri.bodyBbox[4]=l.max.y,i[r].leafBodyAttri.bodyBbox[5]=l.max.z)}else this.calculateLineBodyBoundingBox(i[r]);if(i[r].pmiuuid&&this.viewer.pmiObject)for(var u=0;u<i[r].pmiuuid.length;++u){var f=i[r].pmiuuid[u],f=this.viewer.pmiObject.getObjectByName(f);f&&(f.matrixWorld.premultiply(n),f.originMatrixWorld.copy(f.matrixWorld))}}for(var p=this.getLeafReferenceEntities(e),r=0,o=p.length;r<o;r++)p[r].worldMatrix=this.calculateNodeWorldMatrix(p[r]),p[r].leafBodyAttri&&(p[r].leafBodyAttri.bbox.setFromArray(p[r].leafBodyAttri.coords),p[r].leafBodyAttri.bbox.applyMatrix4(p[r].worldMatrix),"RefPlane"==p[r].type?this.referenceEntityDispManager.needUpdateRefPlaneVertexBuffer=!0:"RefAxis"==p[r].type&&(this.referenceEntityDispManager.needUpdateRefAxisVertexBuffer=!0));for(var m=this.getLeafCoordinate(e),r=0,o=m.length;r<o;r++)m[r].worldMatrix=this.calculateNodeWorldMatrix(m[r])}},updateBvh:function(){var e;this.bvhCreater&&(this.bvhCreater.Rebuild(),e=this.bvh.bboxes.slice(0,6),this.viewer.modelRootObject.boundingBox.setFromArray(e),this.viewer.controls.setBoundingBox(this.viewer.modelRootObject.boundingBox.min,this.viewer.modelRootObject.boundingBox.max))},calculateNodeWorldMatrix:function(e){var t=e,n=[];for(n.push(t);t.parent;)t=t.parent,n.push(t);for(var i=new THREE.Matrix4,r=new THREE.Matrix4,o=n.length-1;0<=o;o--)null!=n[o].matrix&&(r.fromArray(n[o].matrix),i.multiply(r));return i},intersect:function(e,t){var n=this.intersectReferenceEntity(e,t);if(n&&"RefAxis"==n.bodyNode.type)return[n];var i=[];if(0<t){var r;for(s=0,l=this.lineSegmentsSet.getNumLineSegments();s<l;++s)(r=this.meshManager.intersectLineSegments(h=s,e,1/0,t,this.is2DModel))&&this.meshManager.getLineSegments(r.lineSegId)&&i.push(r);if(0<i.length){for(var o=0,a=i[0].distance,s=1,l=i.length;s<l;++s)i[s].distance<a&&(a=i[s].distance,o=s);i[o].bodyNode=this.bodyUuid2NodeMap[i[o].bodyUuid],i[o].object=i[o].bodyNode,0!==o&&(i[0]=i[o]),i.length=1}}if(!this.is2DModel||0==i.length){var d=this.bvh.intersect(e);if((!d||0===d.length)&&n)return[n];var c=[],s=0,l=0;for(s=0,l=d.length;s<l;++s){var h=d[s];this.meshSets[h].intersect(e,c)}var u,f=[];for(s=0,l=c.length;s<l;++s)if((u=this.meshManager.intersect(h=c[s],e,this.is2DModel))&&f.push(u),this.is2DModel)break;if(0<f.length){var p=0,m=f[0].distance;for(s=1,l=f.length;s<l;++s)f[s].distance<m&&(m=f[s].distance,p=s);f[p].bodyNode=this.bodyUuid2NodeMap[f[p].bodyUuid],f[p].object=f[p].bodyNode,0!==p&&(f[0]=f[p]),f.length=1}!this.is2DModel&&0<f.length&&0<i.length&&i[0].distance>f[0].distance+2*t&&(i.length=0)}return 0<i.length?[i[0]]:0<f.length?[f[0]]:n?[n]:null},intersectReferenceEntity:function(e,t){var n=new THREE.Matrix4,i=new THREE.Ray,r=new THREE.Vector3,o=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,h=null,u=null;if(0<t)for(var f=t*t,p=0,m=this.wholeRefEntityNodes.length;p<m;++p)(g=this.wholeRefEntityNodes[p]).isHidden()||"RefAxis"==g.type&&(y=g.worldMatrix,v=g.leafBodyAttri.coords,r.fromArray(v,0),o.fromArray(v,3),r.applyMatrix4(y),o.applyMatrix4(y),e.distanceSqToSegment(r,o,c,d)<f&&(E=e.origin.distanceTo(c),null==h?((h={}).distance=E,h.point=d.clone(),h.bodyNode=g,h.bodyUuid=g.uuid):E<h.distance&&(h.distance=E,h.point=d.clone(),h.bodyNode=g,h.bodyUuid=g.uuid)));if(null==h)for(var g,v,y,E,p=0,m=this.wholeRefEntityNodes.length;p<m;++p)(g=this.wholeRefEntityNodes[p]).isHidden()||"RefPlane"==g.type&&e.intersectsBox(g.leafBodyAttri.bbox)&&(v=g.leafBodyAttri.coords,y=g.worldMatrix,n.getInverse(y),i.copy(e).applyMatrix4(n),r.fromArray(v,0),o.fromArray(v,3),a.fromArray(v,6),s.fromArray(v,9),(i.intersectTriangle(r,o,a,!1,l)||i.intersectTriangle(a,s,r,!1,l))&&(l.applyMatrix4(y),E=e.origin.distanceTo(l),null==u?((u={}).distance=E,u.point=l.clone(),u.bodyNode=g,u.bodyUuid=g.uuid):E<u.distance&&(u.distance=E,u.point=l.clone(),u.bodyNode=g,u.bodyUuid=g.uuid)));return h||u},setExplodeFactor:function(e,t){if(this.explodeFactor=0,this.explodeFactorX=0,this.explodeFactorY=0,this.explodeFactorZ=0,this.explodeMode&NDS.EXPLODEMODE.NORMAL?this.explodeFactor=t:this.explodeMode&NDS.EXPLODEMODE.X?this.explodeFactorX=t:this.explodeMode&NDS.EXPLODEMODE.Y?this.explodeFactorY=t:this.explodeMode&NDS.EXPLODEMODE.Z&&(this.explodeFactorZ=t),0==(this.explodeMode&NDS.EXPLODEMODE.LEVEL)&&0==(this.explodeMode&NDS.EXPLODEMODE.SELECTED))for(var n=this.wholeLeafBodyNodes.length,i=new THREE.Box3,r=0;r<n;++r){var o=this.wholeLeafBodyNodes[r].leafBodyAttri;o&&(i.min.fromArray(o.bodyBbox,0),i.max.fromArray(o.bodyBbox,3),o.bodyTranslate[0]=.5*(i.min.x+i.max.x)-e.x,o.bodyTranslate[1]=.5*(i.min.y+i.max.y)-e.y,o.bodyTranslate[2]=.5*(i.min.z+i.max.z)-e.z)}for(var a=0,s=this.geomManager.geoms.length;a<s;++a)this.geomManager.geoms[a].updateModelMatrix=!0},getExplodeTranslate:function(e,t){var n=[0,0,0];return 0<e&&((t=t.leafBodyAttri)&&(n[0]+=e*t.bodyTranslate[0],n[1]+=e*t.bodyTranslate[1],n[2]+=e*t.bodyTranslate[2])),n},getBodyTranslate:function(e){function t(e){return n.viewer.ndsModel.objectidTouuid?-1!=n.viewer.explodeObjects.indexOf(e.objectid):-1!=n.viewer.explodeObjects.indexOf(e.id)}var n=this,i=[0,0,0];return(0<this.explodeFactor||0<this.explodeFactorX||0<this.explodeFactorY||0<this.explodeFactorZ)&&(this.explodeMode&NDS.EXPLODEMODE.NORMAL&&(this.explodeMode&NDS.EXPLODEMODE.SELECTED&&t(e)||0==(this.explodeMode&NDS.EXPLODEMODE.SELECTED))&&(i[0]+=this.explodeFactor*e.leafBodyAttri.bodyTranslate[0],i[1]+=this.explodeFactor*e.leafBodyAttri.bodyTranslate[1],i[2]+=this.explodeFactor*e.leafBodyAttri.bodyTranslate[2]),this.explodeMode&NDS.EXPLODEMODE.X&&(this.explodeMode&NDS.EXPLODEMODE.SELECTED&&t(e)||0==(this.explodeMode&NDS.EXPLODEMODE.SELECTED))&&(i[0]+=this.explodeFactorX*e.leafBodyAttri.bodyTranslate[0]),this.explodeMode&NDS.EXPLODEMODE.Y&&(this.explodeMode&NDS.EXPLODEMODE.SELECTED&&t(e)||0==(this.explodeMode&NDS.EXPLODEMODE.SELECTED))&&(i[1]+=this.explodeFactorY*e.leafBodyAttri.bodyTranslate[1]),this.explodeMode&NDS.EXPLODEMODE.Z&&(this.explodeMode&NDS.EXPLODEMODE.SELECTED&&t(e)||0==(this.explodeMode&NDS.EXPLODEMODE.SELECTED))&&(i[2]+=this.explodeFactorZ*e.leafBodyAttri.bodyTranslate[2])),this.hasDraggedBodies()&&e.isDragged()&&(i[0]+=e.leafBodyAttri.bodyDragTranslate[0],i[1]+=e.leafBodyAttri.bodyDragTranslate[1],i[2]+=e.leafBodyAttri.bodyDragTranslate[2]),i},getBodyTranslateWithoutExplode:function(e){var t=[0,0,0];return this.hasDraggedBodies()&&e.isDragged()&&(t[0]=e.leafBodyAttri.bodyDragTranslate[0],t[1]=e.leafBodyAttri.bodyDragTranslate[1],t[2]=e.leafBodyAttri.bodyDragTranslate[2]),t},getBodyTransform:function(e){var t=this.getBodyTranslate(e),n=new THREE.Matrix4;return n.copy(e.worldMatrix),n.elements[12]+=t[0],n.elements[13]+=t[1],n.elements[14]+=t[2],n},getLeafBodyBoundingBox:function(e){var t=new THREE.Box3;t.min.fromArray(e.leafBodyAttri.bodyBbox,0),t.max.fromArray(e.leafBodyAttri.bodyBbox,3);e=this.getBodyTranslate(e);return t.min.x+=e[0],t.min.y+=e[1],t.min.z+=e[2],t.max.x+=e[0],t.max.y+=e[1],t.max.z+=e[2],t},getLeafBodyBoundingBoxTrue:function(e){var t=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],n=new THREE.Box3;if(0<e.leafBodyAttri.bodyMeshIds.length){for(var i=0;i<e.leafBodyAttri.bodyMeshIds.length;++i){var r=e.leafBodyAttri.bodyMeshIds[i],r=this.bvh.meshManager.geomId[r],r=this.bvh.meshManager.geomManager.getGeomFromId(r).boundingBox;r&&e.worldMatrix&&(n.expandByPoint(r.max),n.expandByPoint(r.min))}t[0].set(n.min.x,n.min.y,n.min.z).applyMatrix4(e.worldMatrix),t[1].set(n.min.x,n.min.y,n.max.z).applyMatrix4(e.worldMatrix),t[2].set(n.min.x,n.max.y,n.min.z).applyMatrix4(e.worldMatrix),t[3].set(n.min.x,n.max.y,n.max.z).applyMatrix4(e.worldMatrix),t[4].set(n.max.x,n.min.y,n.min.z).applyMatrix4(e.worldMatrix),t[5].set(n.max.x,n.min.y,n.max.z).applyMatrix4(e.worldMatrix),t[6].set(n.max.x,n.max.y,n.min.z).applyMatrix4(e.worldMatrix),t[7].set(n.max.x,n.max.y,n.max.z).applyMatrix4(e.worldMatrix);var o=this.getBodyTranslate(e),o=(new THREE.Vector3).fromArray(o);return t[0].add(o),t[1].add(o),t[2].add(o),t[3].add(o),t[4].add(o),t[5].add(o),t[6].add(o),t[7].add(o),t}return null},calculateMeshBodyBoundingBox:function(e){if(!e.leafBodyAttri)return!1;var t=e.leafBodyAttri.bodyMeshIds;if(0<t.length){var n=new THREE.Box3,r=null;for(i=0,icount=t.length;i<icount;i++){var o=t[i];this.meshManager.updateMeshBBox(o),this.meshManager.getMeshBBox(o,n),0==j?r=n.clone():r.union(n)}if(r)return e.leafBodyAttri.bodyBbox[0]=r.min.x,e.leafBodyAttri.bodyBbox[1]=r.min.y,e.leafBodyAttri.bodyBbox[2]=r.min.z,e.leafBodyAttri.bodyBbox[3]=r.max.x,e.leafBodyAttri.bodyBbox[4]=r.max.y,e.leafBodyAttri.bodyBbox[5]=r.max.z,!0}return!1},calculateLineBodyBoundingBox:function(e){if(!e.leafBodyAttri)return!1;var t=e.leafBodyAttri.bodyMeshIds,n=e.leafBodyAttri.bodyLineSegIds;if(0==t.length&&0<n.length){for(var i=null,r=0;r<n.length;r++){var o=this.meshManager.lineSegGeomId[n[r]],o=this.geomManager.getGeomFromId(o);o&&o.boundingBox&&!o.boundingBox.isEmpty()&&(0==r?i=o.boundingBox.clone():i.union(o.boundingBox))}if(i&&!i.isEmpty())return i.applyMatrix4(e.worldMatrix),e.leafBodyAttri.bodyBbox[0]=i.min.x,e.leafBodyAttri.bodyBbox[1]=i.min.y,e.leafBodyAttri.bodyBbox[2]=i.min.z,e.leafBodyAttri.bodyBbox[3]=i.max.x,e.leafBodyAttri.bodyBbox[4]=i.max.y,e.leafBodyAttri.bodyBbox[5]=i.max.z,!0}return!1},getBodyBoundingBox:function(e){for(var t=this.getLeafBodies(e),n=null,i=0,r=t.length;i<r;++i){var o=t[i];o.leafBodyAttri&&((o=this.getLeafBodyBoundingBox(o))&&(n?o.isEmpty()||(n.expandByPoint(o.min),n.expandByPoint(o.max)):n=o.clone()))}return n},getBodyBoundingBoxTrue:function(e){if(e.leafBodyAttri)return this.getLeafBodyBoundingBoxTrue(e)},RemoveElement:function(e,t){for(var n=1;-1<n;)-1<(n=e.indexOf(t))&&e.splice(n,1)},hasDraggedBodies:function(){return 0<this.draggedBodies.length},dragBody:function(e,t){for(var n=this.getLeafBodies(e),i=0,r=n.length;i<r;++i){var o=n[i];if(o.leafBodyAttri){if(o.isDragged()||(o.setDragged(!0),this.draggedBodies.push(o)),o.leafBodyAttri.bodyDragTranslate[0]+=t.x,o.leafBodyAttri.bodyDragTranslate[1]+=t.y,o.leafBodyAttri.bodyDragTranslate[2]+=t.z,o.pmiuuid&&this.viewer.pmiObject)for(var a=0;a<o.pmiuuid.length;++a){var s=o.pmiuuid[a],s=this.viewer.pmiObject.getObjectByName(s);s&&(s.matrixWorld.copy(s.originMatrixWorld),(s=s.matrixWorld.elements)[12]+=o.leafBodyAttri.bodyDragTranslate[0],s[13]+=o.leafBodyAttri.bodyDragTranslate[1],s[14]+=o.leafBodyAttri.bodyDragTranslate[2])}this.meshManager.setGeomSameMaterialFlag(o)}}},restoreDraggedBody:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n){var r=t[n];if(r.leafBodyAttri&&r.isDragged()){r.setDragged(!1),r.leafBodyAttri.bodyDragTranslate[0]=0,r.leafBodyAttri.bodyDragTranslate[1]=0,r.leafBodyAttri.bodyDragTranslate[2]=0;var o=this.draggedBodies.indexOf(r);if(-1<o&&this.draggedBodies.splice(o,1),r.pmiuuid&&this.viewer.pmiObject)for(var a=0;a<r.pmiuuid.length;++a){var s=r.pmiuuid[a],s=this.viewer.pmiObject.getObjectByName(s);s&&s.matrixWorld.copy(s.originMatrixWorld)}this.meshManager.setGeomSameMaterialFlag(r)}}},changeBodyColor:function(e,t,n){var i=this.getLeafBodies(e),r=i.length;if(0<r)if(t)if(n)for(s=0;s<r;++s){l=i[s].leafBodyAttri.bodyMeshIds,d=this.meshManager.materialId[l[0]];(a=this.meshManager.mats[d])&&((o=a.clone()).color.equals(t)||(o.color.setHex(t),i[s].setUserMaterial(o),this.meshManager.setGeomSameMaterialFlag(i[s]),16777215<(t+=1000335)&&(t-=16777215)))}else{for(var o,a=null,s=0;s<r;++s){var l=i[s].leafBodyAttri.bodyMeshIds,d=this.meshManager.materialId[l[0]];if(a=this.meshManager.mats[d])break}if(a)if(!(o=a.clone()).color.equals(t)){o.color.setHex(t);for(var s=0;s<r;++s)i[s].setUserMaterial(o),this.meshManager.setGeomSameMaterialFlag(i[s])}}else for(s=0;s<r;++s)i[s].setUserMaterial(null),this.meshManager.setGeomSameMaterialFlag(i[s])},hasTransparentBodies:function(){return 0<this.transparentBodies.length||0<this.transparentizedBodies.length},transparentBody:function(e,t,n){t=t||Ue.bodyOpacity,n=n||Ue.lineOpacity;for(var i=this.getLeafBodies(e),r=0,o=i.length;r<o;++r){var a=i[r];a.leafBodyAttri&&(a.transparent(),a.leafBodyAttri.bodyOpacity=t,this.transparentizedBodies.push(a),this.transparentBodyChanged=!0,this.meshManager.setGeomSameMaterialFlag(a))}if(!this.meshManager.lineSegMaterial){for(var s in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[s].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[s].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.id=this.meshManager.lineSegMaterial.id,this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=null!=n?n:t,this.meshManager.lineSegMaterialCopy.transparent=!0)},opaqueBody:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n){var r=t[n];r.leafBodyAttri&&r.isTransparent()&&(r.opaque(),-(r.leafBodyAttri.bodyOpacity=1)<(r=this.transparentizedBodies.indexOf(r))&&(this.transparentizedBodies.splice(r,1),this.transparentBodyChanged=!0))}this.meshManager.resetGeomSameMaterialFlags()},transparentizeBodies:function(e){if(e&&e.length){this.transparentizedBodies=[];for(var t=0;t<e.length;++t){var n=this.getLeafBodies(e[t]);if(n&&0<n.length)for(var i=0,r=n.length;i<r;++i){var o=n[i];o.isTransparent()||(o.transparent(),o.deIsolate(),this.transparentizedBodies.push(o),this.transparentBodyChanged=!0)}}for(t=0;t<this.wholeLeafBodyNodes.length;++t){var a=this.wholeLeafBodyNodes[t];a.isTransparent()||a.isolate()}if(this.meshManager.resetGeomSameMaterialFlags(),!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(i=0,r=this.meshManager.mats.length;i<r;++i)this.meshManager.mats[i]&&(this.meshManager.matsCopy[i]=this.meshManager.mats[i].clone(),this.meshManager.matsCopy[i].uuid=this.meshManager.mats[i].uuid,this.meshManager.matsCopy[i].program=this.meshManager.mats[i].program,this.meshManager.matsCopy[i].needsUpdate=this.meshManager.mats[i].needsUpdate,this.meshManager.matsCopy[i].opacity=Ue.bodyOpacity,this.meshManager.matsCopy[i].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var s in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[s].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[s].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=Ue.lineOpacity,this.meshManager.lineSegMaterialCopy.transparent=!0)}},transparentizeBodiesOnly:function(e){for(var t=0;t<e.length;++t){var n=this.getLeafBodies(e[t]);if(n&&0<n.length)for(var i=0,r=n.length;i<r;++i){var o=n[i];o.isTransparent()||(o.transparent(),o.deIsolate(),this.transparentizedBodies.push(o),this.transparentBodyChanged=!0)}}if(this.meshManager.resetGeomSameMaterialFlags(),!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(i=0,r=this.meshManager.mats.length;i<r;++i)this.meshManager.mats[i]&&(this.meshManager.matsCopy[i]=this.meshManager.mats[i].clone(),this.meshManager.matsCopy[i].uuid=this.meshManager.mats[i].uuid,this.meshManager.matsCopy[i].program=this.meshManager.mats[i].program,this.meshManager.matsCopy[i].needsUpdate=this.meshManager.mats[i].needsUpdate,this.meshManager.matsCopy[i].opacity=Ue.bodyOpacity,this.meshManager.matsCopy[i].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var a in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[a].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[a].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=Ue.lineOpacity,this.meshManager.lineSegMaterialCopy.transparent=!0)},getTransparentizedBodies:function(){return this.transparentizedBodies},getAllTransparentBodies:function(e){if(this.transparentBodyChanged){for(var t=this.transparentBodies.length=0,n=this.wholeLeafBodyNodes.length;t<n;++t){var i=this.wholeLeafBodyNodes[t];if(i.isTransparent())this.transparentBodies.push(this.wholeLeafBodyNodes[t]);else for(var r=this.meshManager.getNumBodyMeshs(i),o=0;o<r;++o){var a=this.meshManager.getBodyMeshId(i,o),a=this.meshManager.getMeshOriginalMaterial(a);if(a&&a.transparent&&a.opacity<=.99){this.transparentBodies.push(i);break}}}this.transparentBodyChanged=!1,e&&this.sortBodiesByVolume(this.transparentBodies)}return this.transparentBodies},inIsolate:function(){return 0<this.transparentizedBodies.length},exitIsolate:function(){for(var e=0;e<this.wholeLeafBodyNodes.length;++e){var t=this.wholeLeafBodyNodes[e];t.deIsolate(),t.opaque()}this.transparentizedBodies.length=0,this.transparentBodyChanged=!0,this.meshManager.resetGeomSameMaterialFlags()},isolateBodiesOnly:function(e){for(var t=0;t<e.length;++t){var n=e[t],i=this.getLeafBodies(n);if(i&&0<i.length)for(var r=0,o=i.length;r<o;++r)i[r].leafBodyAttri&&(i[r].isolate(),i[r].opaque(),this.RemoveElement(this.transparentizedBodies,i[r]),this.transparentBodyChanged=!0)}this.meshManager.resetGeomSameMaterialFlags(),0==this.transparentizedBodies.length&&this.exitIsolate()},isolateBodyOnly:function(e){var t=this.getLeafBodies(e);if(t&&0<t.length)for(var n=0,i=t.length;n<i;++n)t[n].leafBodyAttri&&(t[n].isolate(),t[n].opaque(),this.RemoveElement(this.transparentizedBodies,t[n]),this.transparentBodyChanged=!0);this.meshManager.resetGeomSameMaterialFlags()},isolateBodies:function(e,t,n){if(e&&e.length){for(var i=0,r=e.length;i<r;++i){var o=this.getLeafBodies(e[i]);if(o&&0<o.length)for(var a=0,s=o.length;a<s;++a)o[a].leafBodyAttri&&(o[a].isolate(),o[a].opaque(),this.meshManager.setGeomSameMaterialFlag(o[a]))}this.transparentizedBodies=[];for(i=0;i<this.wholeLeafBodyNodes.length;++i){var l=this.wholeLeafBodyNodes[i];l.isIsolated()||(l.transparent(),this.transparentizedBodies.push(l))}if(this.transparentBodyChanged=!0,!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(a=0,s=this.meshManager.mats.length;a<s;++a)this.meshManager.mats[a]&&(this.meshManager.matsCopy[a]=this.meshManager.mats[a].clone(),this.meshManager.matsCopy[a].uuid=this.meshManager.mats[a].uuid,this.meshManager.matsCopy[a].program=this.meshManager.mats[a].program,this.meshManager.matsCopy[a].needsUpdate=this.meshManager.mats[a].needsUpdate,this.meshManager.matsCopy[a].opacity=t,this.meshManager.matsCopy[a].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var d in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[d].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[d].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=null!=n?n:t,this.meshManager.lineSegMaterialCopy.transparent=!0),0==this.transparentizedBodies.length&&this.exitIsolate()}},hideBody:function(e){for(var t=[e],o=0;o<t.length;++o)if(0==t[o].children.length){if(0<=t[o].id&&!t[o].isReferenceEntity()&&!t[o].isCoordinate()){var n=t[o];if((n.leafBodyAttri||n.pmiuuid)&&(this.hasHiddenBodies=!0,n.hide(),this.hideBodies.push(n),this.meshManager.setGeomSameMaterialFlag(n),n.leafBodyAttri&&n.leafBodyAttri.bodyTextIds&&0<n.leafBodyAttri.bodyTextIds.length))for(var i=0;i<n.leafBodyAttri.bodyTextIds.length;++i){var r,a=n.leafBodyAttri.bodyTextIds[i];this.meshManager.textGeomId[a]<0||(r=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[a]),(a=this.viewer.scene.getObjectByName("dashLine"))&&(g=a.getObjectByName(r.uuid))&&(g.visible=!1))}}}else{t[o].visible=!1;for(var s=0,l=t[o].children.length;s<l;++s)t.push(t[o].children[s])}(e.isReferenceEntity()||e.isCoordinate())&&(e.hide(),this.hideBodies.push(e));for(var d=this.getLeafReferenceEntities(e),o=0,c=d.length;o<c;o++)d[o].leafBodyAttri&&(d[o].hide(),this.hideBodies.push(d[o]));for(var h=this.getLeafCoordinate(e),o=0,c=h.length;o<c;o++)h[o].hide(),this.hideBodies.push(h[o]);if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var u=this.getLayerBodies(e),f=0,c=u.length;f<c;++f)if((n=u[f]).pmiuuid){for(var p=this.viewer,m=p.pmiObject.getObjectByName("TextGroup"),s=0;s<n.pmiuuid.length;++s){for(var g,v=n.pmiuuid[s],o=0;o<p.SDFMaker.AttributeArray.length;++o)p.SDFMaker.AttributeArray[o]&&p.SDFMaker.AttributeArray[o].forEach(function(e,t){var n=e[v];if(n){for(var i=m.getObjectByName(o+"_"+t).geometry.attributes.position.data,r=n.start;r<n.start+n.count;r++)i.array[r*i.stride+3]<=1&&(i.array[r*i.stride+3]+=1.25);i.version++,i.updateRange.count=i.count}});(g=p.pmiObject.getObjectByName(v))&&(g.visible=!1)}n.visible=!1}var y=this.getLeafPMIuuid(e);if(0<y.length&&!this.viewer.is2DModel&&this.viewer.pmiObject)for(s=0;s<y.length;++s){var v=y[s],E=this.viewer.pmiObject.getObjectByName(v);E&&(E.visible=!1)}this.viewer.render()},showBody:function(e){for(var t=[e],n=!1,o=0;o<t.length;++o)if(0==t[o].children.length){if(0<=t[o].id&&!t[o].isReferenceEntity()&&!t[o].isCoordinate()){var i=t[o];if((i.leafBodyAttri||i.pmiuuid)&&(n=!0,i.show(),this.RemoveElement(this.hideBodies,i),i.leafBodyAttri&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length))for(var r=0;r<i.leafBodyAttri.bodyTextIds.length;++r){var a,s=i.leafBodyAttri.bodyTextIds[r];this.meshManager.textGeomId[s]<0||(a=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[s]),(s=this.viewer.scene.getObjectByName("dashLine"))&&(v=s.getObjectByName(a.uuid))&&(v.visible=!0))}}}else{t[o].visible=!0;for(var l=0,d=t[o].children.length;l<d;++l)t.push(t[o].children[l])}n&&this.meshManager.resetGeomSameMaterialFlags(),(e.isReferenceEntity()||e.isCoordinate())&&(e.show(),this.RemoveElement(this.hideBodies,e));for(var c=this.getLeafReferenceEntities(e),o=0,h=c.length;o<h;o++)c[o].leafBodyAttri&&(c[o].parent.isComponentRefPlaneVisible()&&"RefPlane"==c[o].type||c[o].parent.isComponentRefAxisVisible()&&"RefAxis"==c[o].type)&&(c[o].show(),this.RemoveElement(this.hideBodies,c[o]));for(var u=this.getLeafCoordinate(e),o=0,h=u.length;o<h;o++)u[o].parent.isComponentCoordinateSysVisible()&&(u[o].show(),this.RemoveElement(this.hideBodies,u[o]));if(this.viewer.is2DModel&&this.viewer.pmiObject){for(var f=this.getLayerBodies(e),p=0,h=f.length;p<h;++p)if((i=f[p]).pmiuuid){for(var m=this.viewer,g=m.pmiObject.getObjectByName("TextGroup"),l=0;l<i.pmiuuid.length;++l){for(var v,y=i.pmiuuid[l],o=0;o<m.SDFMaker.AttributeArray.length;++o)m.SDFMaker.AttributeArray[o]&&m.SDFMaker.AttributeArray[o].forEach(function(e,t){var n=e[y];if(n){for(var i=g.getObjectByName(o+"_"+t).geometry.attributes.position.data,r=n.start;r<n.start+n.count;r++)1<i.array[r*i.stride+3]&&(i.array[r*i.stride+3]-=1.25);i.version++,i.updateRange.count=i.count}});(v=m.pmiObject.getObjectByName(y))&&(v.visible=!0)}i.visible=!0}var E="0x"+this.viewer.renderer.getClearColor().getHexString();this.viewer.setBackGroundColor(E)}0==this.hideBodies.length&&(this.hasHiddenBodies=!1);var b=this.getLeafPMIuuid(e),M=this.viewer.ndsModel.rootBodyNode.pmiuuid;if((M||this.viewer.PartPmiVisible)&&(!e.ndsModel&&this.viewer.PartPmiVisible||e.ndsModel&&(this.viewer.AssemblyPMIVisible||this.viewer.PartPmiVisible))&&0<b.length&&!this.viewer.is2DModel&&this.viewer.pmiObject)for(l=0;l<b.length;++l){var x,y=b[l];M&&-1!=M.indexOf(y)&&!this.viewer.AssemblyPMIVisible||M&&-1==M.indexOf(y)&&!this.viewer.PartPmiVisible||(x=this.viewer.pmiObject.getObjectByName(y))&&(x.visible=!0)}},showBodyReversed:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n){var r=t[n];r.leafBodyAttri&&(r.isHidden()?(r.show(),this.RemoveElement(this.hideBodies,r)):(r.hide(),this.hideBodies.push(r)),r.isHidden()&&(this.hasHiddenBodies=!0))}this.meshManager.resetGeomSameMaterialFlags()},showAllBodies:function(){this.hasHiddenBodies=!1,this.hideBodies=[];for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&this.wholeLeafBodyNodes[e].show();this.meshManager.resetGeomSameMaterialFlags()},hideAllBodies:function(){this.hasHiddenBodies=!0,this.hideBodies=[];for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].hide(),this.hideBodies.push(this.wholeLeafBodyNodes[e]));this.meshManager.resetGeomSameMaterialFlags()},reverseBodyVisibility:function(){this.hasHiddenBodies=!1,this.hideBodies=[];for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].isHidden()?this.wholeLeafBodyNodes[e].show():(this.wholeLeafBodyNodes[e].hide(),this.hideBodies.push(this.wholeLeafBodyNodes[e]),this.hasHiddenBodies=!0));this.meshManager.resetGeomSameMaterialFlags()},isBodyAllChildHidden:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n)if(!t[n].isHidden())return!1;return!(e.isReferenceEntity()&&!e.isHidden())&&!(e.isCoordinate()&&!e.isHidden())},isBodyAllChildSelected:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n)if(!t[n].isSelected())return!1;return!(e.isReferenceEntity()&&!e.isSelected())&&!(e.isCoordinate()&&!e.isSelected())},isBodyAllChildShow:function(e){for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n)if(t[n].isHidden())return!1;return!0},isBodyOrSomeChildHidden:function(e){if(e.isHidden())return!0;for(var t=this.getLeafBodies(e),n=0,i=t.length;n<i;++n){var r=t[n];if(r.leafBodyAttri&&(r.isHidden()&&!r.unload))return!0}if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var o=this.getLayerBodies(e),a=0,i=o.length;a<i;++a)if((r=o[a]).pmiuuid&&!r.visible)return!0;return!1},getSelectedBodies:function(){return this.selectedBodies},clearSelection:function(){for(var e=!1,o=0,t=this.selectedBodies.length;o<t;++o)this.selectedBodies[o].deSelect(),e=!0;this.selectedBodies.length=0;var n=this.viewer.ndsModel.rootBodyNode;if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var i=this.getLayerBodies(n),r=0,t=i.length;r<t;++r){var a=i[r];if(a.pmiuuid)for(var s=this.viewer,l=s.pmiObject.getObjectByName("TextGroup"),d=0;d<a.pmiuuid.length;++d){for(var c=a.pmiuuid[d],o=0;o<s.SDFMaker.AttributeArray.length;++o)s.SDFMaker.AttributeArray[o]&&s.SDFMaker.AttributeArray[o].forEach(function(e,t){var n=e[c];if(n){for(var i=l.getObjectByName(o+"_"+t).geometry.attributes.position.data,r=n.start;r<n.start+n.count;r++)1<i.array[r*i.stride+4]&&(i.array[r*i.stride+4]-=1.25);i.version++,i.updateRange.count=i.count}});var h=s.pmiObject.getObjectByName(c);h&&h.material&&h.material.color.copy(h.color)}}e&&this.meshManager.resetGeomSameMaterialFlags();for(o=0,t=this.wholeRefEntityNodes.length;o<t;++o)this.wholeRefEntityNodes[o].deSelect();for(o=0,t=this.wholeCoordinateNodes.length;o<t;++o)this.wholeCoordinateNodes[o].deSelect()},addSelection:function(e){for(var t=this.getLeafBodies(e),o=0,n=t.length;o<n;++o){var i=t[o];if(i.leafBodyAttri&&!i.isSelected()){if(i.select(),this.selectedBodies.push(i),i.leafBodyAttri&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length)for(var r=0;r<i.leafBodyAttri.bodyTextIds.length;++r){var a,s=i.leafBodyAttri.bodyTextIds[r];this.meshManager.textGeomId[s]<0||(a=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[s]),(s=this.viewer.scene.getObjectByName("dashLine"))&&(p=s.getObjectByName(a.uuid))&&p.material.color.copy(Ue.selectedColor))}this.meshManager.setGeomSameMaterialFlag(i)}}for(var l=this.getLeafReferenceEntities(e),o=0,n=l.length;o<n;o++)l[o].leafBodyAttri&&l[o].select();if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var d=this.getLayerBodies(e),c=0,n=d.length;c<n;++c)if((i=d[c]).pmiuuid)for(var h=this.viewer,u=h.pmiObject.getObjectByName("TextGroup"),f=0;f<i.pmiuuid.length;++f){for(var p,m=i.pmiuuid[f],o=0;o<h.SDFMaker.AttributeArray.length;++o)h.SDFMaker.AttributeArray[o]&&h.SDFMaker.AttributeArray[o].forEach(function(e,t){var n=e[m];if(n){for(var i=u.getObjectByName(o+"_"+t).geometry.attributes.position.data,r=n.start;r<n.start+n.count;r++)i.array[r*i.stride+4]<=1&&(i.array[r*i.stride+4]+=1.25);i.version++,i.updateRange.count=i.count}});(p=h.pmiObject.getObjectByName(m))&&p.material&&p.material.color&&p.material.color.set(16776960)}},removeSelection:function(e){var t=this.getLeafBodies(e);if(0<t.length){for(var o=0,n=t.length;o<n;++o){var i=t[o];if(i.leafBodyAttri&&i.isSelected()){i.deSelect();var r=this.selectedBodies.indexOf(i);if(-1<r&&this.selectedBodies.splice(r,1),i.leafBodyAttri&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length)for(var a=0;a<i.leafBodyAttri.bodyTextIds.length;++a){var s,l,d=i.leafBodyAttri.bodyTextIds[a];this.meshManager.textGeomId[d]<0||(s=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[d]),(l=this.viewer.scene.getObjectByName("dashLine"))&&(v=l.getObjectByName(s.uuid))&&(d=this.meshManager.mats[this.meshManager.textMaterialId[d]],v.material.color.copy(d.color)))}}}this.meshManager.resetGeomSameMaterialFlags()}for(var c=this.getLeafReferenceEntities(e),o=0,h=c.length;o<h;o++)c[o].leafBodyAttri&&c[o].deSelect();if(this.viewer.is2DModel&&this.viewer.pmiObject){for(var u=this.getLayerBodies(e),f=0,h=u.length;f<h;++f)if((i=u[f]).pmiuuid)for(var p=this.viewer,m=p.pmiObject.getObjectByName("TextGroup"),g=0;g<i.pmiuuid.length;++g){for(var v,y=i.pmiuuid[g],o=0;o<p.SDFMaker.AttributeArray.length;++o)p.SDFMaker.AttributeArray[o]&&p.SDFMaker.AttributeArray[o].forEach(function(e,t){var n=e[y];if(n){for(var i=m.getObjectByName(o+"_"+t).geometry.attributes.position.data,r=n.start;r<n.start+n.count;r++)1<i.array[r*i.stride+4]&&(i.array[r*i.stride+4]-=1.25);i.version++,i.updateRange.count=i.count}});(v=p.pmiObject.getObjectByName(y))&&v.material&&v.material.color&&v.material.color.copy(v.color)}this.viewer.is2DModel&&(e="0x"+this.viewer.renderer.getClearColor().getHexString(),this.viewer.setBackGroundColor(e))}},preSelectObject:function(e){if(!this.preselectedObject||this.preselectedObject.uuid!=e.uuid){if(this.preselectedObject)for(var t=0,n=(i=this.getAllLeafNodes(this.preselectedObject)).length;t<n;++t)i[t].leafBodyAttri&&i[t].dePreSelect();this.preselectedObject=e;for(var i,t=0,n=(i=this.getAllLeafNodes(e)).length;t<n;++t)i[t].leafBodyAttri&&i[t].preSelect()}},clearPreSelection:function(){if(this.preselectedObject){for(var e=this.getAllLeafNodes(this.preselectedObject),t=0,n=e.length;t<n;++t)e[t].leafBodyAttri&&e[t].dePreSelect();return!(this.preselectedObject=null)}return!1},sortBodies:function(e){for(var t,n=[],i=(new THREE.Box3,0),r=e.length;i<r;++i)t=this.getLeafBodyBoundingBox(e[i]).distanceToPoint(this.viewer.camera.position),n.push({body:e[i],z:t});n.sort(B);for(i=0,r=e.length;i<r;++i)e[i]=n[i].body},sortBodiesByVolume:function(e){for(var t,n,i,r,o=[],a=(new THREE.Box3,0),s=e.length;a<s;++a)n=(t=this.getLeafBodyBoundingBox(e[a])).max.x-t.min.x,i=t.max.y-t.min.y,r=t.max.z-t.min.z,o.push({body:e[a],z:n*i*r});o.sort(C);for(a=0,s=e.length;a<s;++a)e[a]=o[a].body},getGeometriesCount:function(){var e={Mesh:{count:0,triangles:0,points:0},Line:{count:0,points:0}};e.Mesh.count=this.wholeLeafBodyNodes.length;for(var t=0,n=this.geomManager.geoms.length;t<n;++t){var i,r,o=this.geomManager.geoms[t];null!=o&&null!=o.index&&(i=o.refMeshes.length,r=o.refLineSegs.length,0<i?(e.Mesh.triangles+=o.drawRange.count/3*i,o.index.count===o.drawRange.start+o.drawRange.count&&(o.attributes.position.isInterleavedBufferAttribute?e.Mesh.points+=o.attributes.position.data.count:e.Mesh.points+=o.attributes.position.count)):0<r&&(e.Line.count+=r,o.index.count===o.drawRange.start+o.drawRange.count&&(o.attributes.position.isInterleavedBufferAttribute?e.Line.points+=o.attributes.position.data.count:e.Line.points+=o.attributes.position.count)))}return e},updateBodyMeshIds:function(){for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].leafBodyAttri.bodyMeshIds.length=0,this.wholeLeafBodyNodes[e].leafBodyAttri.bodyLineSegIds.length=0);for(e=0;e<this.meshManager.nMeshes;++e)this.meshManager.bodyNodes[e].leafBodyAttri.bodyMeshIds.push(e);for(e=0;e<this.meshManager.nLineSegments;++e)this.meshManager.lineSegBodyNodes[e].leafBodyAttri.bodyLineSegIds.push(e)},delete:function(e){var t=e.parent;if(null!=t){for(var n=0;n<t.children.length;++n)if(t.children[n]===e){t.children.splice(n,1);break}for(var i=[e],r=0;r<i.length;++r){var o=i[r];delete this.bodyUuid2NodeMap[o.uuid];for(var a=0,s=o.children.length;a<s;++a)i.push(o.children[a])}var l=this.getLeafBodies(e);if(0<l.length){for(var d=[],c=[],r=0,h=l.length;r<h;++r){var u=l[r];u.leafBodyAttri&&(d.extend(u.leafBodyAttri.bodyMeshIds),c.extend(u.leafBodyAttri.bodyLineSegIds),u.leafBodyAttri=null),-1<(m=this.wholeLeafBodyNodes.indexOf(u))&&this.wholeLeafBodyNodes.splice(m,1),0<this.transparentBodies.length&&-1<(m=this.transparentBodies.indexOf(u))&&(this.transparentBodies.splice(m,1),this.transparentBodiesDirty=!0),0<this.transparentizedBodies.length&&-1<(m=this.transparentizedBodies.indexOf(u))&&(this.transparentizedBodies.splice(m,1),this.transparentBodiesDirty=!0),0<this.selectedBodies.length&&-1<(m=this.selectedBodies.indexOf(u))&&(this.selectedBodies.splice(m,1),this.selectedBodiesDirty=!0),0<this.draggedBodies.length&&-1<(m=this.draggedBodies.indexOf(u))&&this.draggedBodies.splice(m,1),0<this.hideBodies.length&&-1<(m=this.hideBodies.indexOf(u))&&this.hideBodies.splice(m,1)}this.bvhCreater.delete(d,c),this.meshManager.instancedMeshIds.length=0,this.updateBodyMeshIds(),this.meshManager.collectGeomRefEntities(),this.meshManager.setMaterialInfor();var f=this.bvh.bboxes.slice(0,6);this.viewer.modelRootObject.boundingBox.setFromArray(f),this.viewer.controls.setBoundingBox(this.viewer.modelRootObject.boundingBox.min,this.viewer.modelRootObject.boundingBox.max)}var p=this.getLeafReferenceEntities(e);if(0<p.length){for(r=0,h=p.length;r<h;++r)p[r].leafBodyAttri=null,-1<(m=this.wholeRefEntityNodes.indexOf(p[r]))&&this.wholeRefEntityNodes.splice(m,1),this.referenceEntityDispManager.removeRefEntity(p[r]);this.referenceEntityDirty=!0}for(var m,g=this.getLeafCoordinate(e),r=0,v=g.length;r<v;r++)g[r].leafBodyAttri.renderObject&&(this.viewer.scene.remove(g[r].leafBodyAttri.renderObject),g[r].leafBodyAttri.renderObject.detach(),g[r].leafBodyAttri.renderObject=null),-1<(m=this.wholeCoordinateNodes.indexOf(g[r]))&&this.wholeCoordinateNodes.splice(m,1)}},addReferenceEntity:function(e){var t,n=null;(n=e.parentNode||this.getBodyNodeFromUuid(e.parentUuid))&&((t=this.getBodyNodeFromUuid(e.uuid))||((t=new De).uuid=e.uuid,t.name=e.name,void 0!==e.visible?t.visible=e.visible:t.visible=!1,t.type=e.type,(t.parent=n).children.push(t),t.worldMatrix=this.calculateNodeWorldMatrix(t),t.id=this.leafNodeCount++,this.bodyUuid2NodeMap[t.uuid]=t,this.wholeRefEntityNodes.push(t),n=new c,t.visible||(n.bodyFlag|=NDS.BODYFLAG.HIDDEN_FLAG),n.coords=e.coords.slice(0),n.bbox.setFromArray(n.coords),n.bbox.applyMatrix4(t.worldMatrix),t.leafBodyAttri=n,this.referenceEntityDispManager.addRefEntity(t),this.referenceEntityDirty=!0))},addReferenceEntities:function(e){for(var t=0;t<e.length;t++)this.addReferenceEntity(e[t])}};n(146);var _=function(){var a=this;this.metrics={},this.TextMaterial={},this.TextMaterialItalic={},this.TextMaterialBold={},this.TextMaterialIandB={},this.blendMaterial=null,this.newblendMaterial=null,this.shxMaterial=null,this.mappableUnit=4096,this.textSize=100,this.textUnit=parseInt(1.125*this.textSize),this.specialCodeArray=[],this.AddSpecialCode(),this.AttributeArray=[],this.HashTable={},this.textString="",this.textPos=[],this.geometrytoRange=[],this.lines=[],this.numTextGeom=0,this.ttfCompositeStride=6,this.ttfGeometryBuffers=[],this.shxCompositeStride=3,this.shxGeometryBuffers=[],this.genTTFGeometryBuffer=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1024,e={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(4*e*a.ttfCompositeStride),a.ttfCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(6*e),1),bufferOffset:0,indexOffset:0};return e.compositePositionAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,3,0,!1),e.compositeUvAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,2,3,!1),e.compositeTextureAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,1,5,!1),a.ttfGeometryBuffers[a.ttfGeometryBuffers.length]=e,a.ttfGeometryBuffers.length-1},this.getTTFGeometryBuffer=function(e){for(var t=-1,n=0,i=a.ttfGeometryBuffers.length;n<i;++n){var r=a.ttfGeometryBuffers[n];if(4*e*a.ttfCompositeStride<r.compositeIBuffer.array.length-r.bufferOffset){t=n;break}}return t<0&&(t=a.genTTFGeometryBuffer(4096)),a.ttfGeometryBuffers[t]},this.genSHXGeometryBuffer=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:65536,e={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(e*a.shxCompositeStride),a.shxCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(e),1),bufferOffset:0,indexOffset:0};return e.compositePositionAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,3,0,!1),a.shxGeometryBuffers[a.shxGeometryBuffers.length]=e,a.shxGeometryBuffers.length-1},this.getSHXGeometryBuffer=function(e){for(var t=-1,n=0,i=a.shxGeometryBuffers.length;n<i;++n){var r=a.shxGeometryBuffers[n];if(e*a.shxCompositeStride<r.compositeIBuffer.array.length-r.bufferOffset){t=n;break}}return t<0&&(t=a.genSHXGeometryBuffer(65536)),a.shxGeometryBuffers[t]},this.textCompositeStride=9,this.textGeometryBuffers=[],this.genTextGeometryBuffer=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1024,t={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(4*t*a.textCompositeStride),a.textCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(6*t),1),bufferOffset:0,indexOffset:0,uuidtorange:new Object};return t.compositePositionAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,3,0,!1),t.compositeColorAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,3,3,!1),t.compositeUvAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,2,6,!1),t.compositeTextureAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,1,8,!1),a.textGeometryBuffers[e][a.textGeometryBuffers[e].length]=t,a.textGeometryBuffers[e].length-1},this.getTextGeometryBuffer=function(e,t){var n=-1;a.textGeometryBuffers[e]||(a.textGeometryBuffers[e]=[]);for(var i=0,r=a.textGeometryBuffers[e].length;i<r;++i){var o=a.textGeometryBuffers[e][i];if(4*t*a.textCompositeStride<o.compositeIBuffer.array.length-o.bufferOffset){n=i;break}}return n<0&&(n=a.genTextGeometryBuffer(e,4096)),a.textGeometryBuffers[e][n]},this.SDFVerison=1,this.nametotextureID=[],this.textures=[],this.shxTextArray=[],this.ShxData=null,this.needShxLoad=!1};_.prototype={constructor:_,SetVersion:function(e){this.SDFVerison=e},IsChinese:function(e){return 19968<=e.charCodeAt(0)&&e.charCodeAt(0)<=40869},IsShxFont:function(e){return!!e&&".shx"==e.substring(e.length-4).toLowerCase()},GetTextScale:function(e,t){return this.IsShxFont(t)?1:1.6},GetTextOffset:function(e,t,n){return n||1==this.SDFVerison?0:this.IsShxFont(t)?.05:.25},AddSpecialCode:function(){for(var e=[8982],t=0;t<e.length;++t)this.specialCodeArray.push(String.fromCharCode(t))},CreateImage:function(e,t){var n=this.mappableUnit-this.textUnit,i=new Object,r=document.createElement("canvas");r.width=this.mappableUnit,r.height=this.mappableUnit;var o,a=r.getContext("2d");switch(t){case _.ITALIC:o="italic "+this.textSize+"px ";break;case _.BOLD:o="bold "+this.textSize+"px ";break;case _.NORMAL:o="normal "+this.textSize+"px ";break;case _.ITALICANDBOLD:o="italic bold "+this.textSize+"px "}a.textBaseline="bottom",a.fillStyle="black",a.clearRect(0,0,r.width,r.height);for(var s=2,l=0,d=1,c=0;c<e.length;c++){var h=e[c],u=!1,f=this.IsChinese(h);-1!=this.specialCodeArray.indexOf(h)&&(u=!0),a.font=f?o+"FangSong":o+"Arial",a.clearRect(n,n,this.textUnit,this.textUnit),a.textAlign="center",a.fillText(h,n+this.textUnit/2,this.mappableUnit);var p=50,m=0,g=0;if(f)x=this.textSize;else{for(var v=a.getImageData(n-2,n-2,this.textUnit,this.textUnit),y=0;y<this.textUnit;y++){for(var E=0;E<this.textUnit;E++){var b=v.data[4*(y*this.textUnit+E)+3];if(0!=b&&E<p){p=E;break}}for(var M=this.textUnit-1;0<=M;M--){b=v.data[4*(y*this.textUnit+M)+3];if(0!=b&&m<M){m=M;break}}}var x=m-p;x<0&&(x=6);var w=m+p>>1;w<this.textUnit/2-3?g=1:w>this.textUnit/2+3&&(g=2)}(s=s+(l>>1)+(x>>1)+14)+(x>>1)>this.mappableUnit&&(s=(s=7)+((l=0)>>1)+(x>>1)+14,d++),a.textAlign="center",a.fillText(h,s,this.textUnit*d);var l=x,I=s-(x>>1)-3,w=this.textUnit*d,w={height:f?1.5:1,width:f?1.5:(x+14)/this.textUnit,left:1==g?(I-7)/this.mappableUnit:I/this.mappableUnit,top:1-(w-this.textUnit+3.5)/this.mappableUnit,right:2==g?(I+x+14)/this.mappableUnit:(I+x+14/3)/this.mappableUnit,bottom:1-w/this.mappableUnit};u&&(u=w.right-w.left,u*=1-.7,w.right-=u,u=w.top-w.bottom,u*=1-.7,w.top-=u/2,w.bottom+=u/2),i[h]=w}this.metrics[t]=i;t=document.createElement("img");return t.src=r.toDataURL("image/png"),t},addHash:function(e){this.HashTable[e]=null},containHash:function(e){return e in this.HashTable},getHashKey:function(e){for(var t in this.HashTable)e.push(t);return e},SetTexture:function(e,t,n){this.textures=e;for(var i=0;i<this.textures.length;++i){var r=this.textures[i];r.flipY=!1,r.needsUpdate=!0,this.blendMaterial&&(this.blendMaterial.uniforms["uSampler"+i].value=r.clone(),this.blendMaterial.uniforms["uSampler"+i].value.flipY=!1,this.blendMaterial.uniforms["uSampler"+i].value.needsUpdate=!0),this.newblendMaterial&&t<2&&(this.newblendMaterial.uniforms["uSampler"+i].value=r.clone(),this.newblendMaterial.uniforms["uSampler"+i].value.flipY=!1,this.newblendMaterial.uniforms["uSampler"+i].value.needsUpdate=!0)}n&&n()},CreateMaterial:function(r,e,t){function n(e,t,n,i){var r=new THREE.ShaderMaterial({vertexColors:THREE.FaceColors,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4},diffuse:{value:new THREE.Color(16777215)}},vertexShader:["varying vec2 vUv;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","uniform vec3 diffuse;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = diffuse;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 1.0;","destColor.g = 0.788;","destColor.b = 0.25;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var o,a=0;a<t.length;++a)(o=t[a]).flipY=!1,o.needsUpdate=!0,r.uniforms["uSampler"+a].value=o;else(o=new THREE.Texture(t)).needsUpdate=!0,r.uniforms.uSampler0.value=o;switch(r.side=Ue.enableTextRenderingBothSide?THREE.FrontSide:r.side=THREE.DoubleSide,r.transparent=!0,r.depthWrite=!1,r.alphaTest=.4,n){case _.ITALIC:e.TextMaterialItalic=r,e.TextMaterialItalic.styleId=n;break;case _.BOLD:e.TextMaterialBold=r,e.TextMaterialBold.styleId=n;break;case _.NORMAL:e.TextMaterial=r,e.TextMaterial.styleId=n;break;case _.ITALICANDBOLD:e.TextMaterialIandB=r,e.TextMaterialIandB.styleId=n;break;case _.BLEND:i?(e.newblendMaterial=r,e.newblendMaterial.styleId=n):(e.blendMaterial=r,e.blendMaterial.styleId=n)}}function i(e,t,n){var i=new THREE.ShaderMaterial({vertexColors:THREE.FaceColors,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4}},vertexShader:["varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vColor = color;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = vColor;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 1.0;","destColor.g = 0.788;","destColor.b = 0.25;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var r,o=0;o<t.length;++o)(r=t[o]).flipY=!1,r.needsUpdate=!0,i.uniforms["uSampler"+o].value=r;else(r=new THREE.Texture(t)).needsUpdate=!0,i.uniforms.uSampler0.value=r;switch(i.side=Ue.enableTextRenderingBothSide?THREE.FrontSide:i.side=THREE.DoubleSide,i.transparent=!0,i.depthWrite=!1,i.alphaTest=.4,n){case _.ITALIC:e.TextMaterialItalic=i,e.TextMaterialItalic.styleId=n;break;case _.BOLD:e.TextMaterialBold=i,e.TextMaterialBold.styleId=n;break;case _.NORMAL:e.TextMaterial=i,e.TextMaterial.styleId=n;break;case _.ITALICANDBOLD:e.TextMaterialIandB=i,e.TextMaterialIandB.styleId=n;break;case _.BLEND:e.blendMaterial=i,e.blendMaterial.styleId=n}}var o=new Map;if(r.fonts)for(var a=0,s=r.fonts.length;a<s;++a)o.set(r.fonts[a].uuid,r.fonts[a]);var l=[],d=!1,c=!1,h=!1,u=this;if(2==e&&this.SDFVerison==e&&r){for(var f=new Object,p=0;p<r.length;p++){var m=r[p].name,g=r[p].uvs,v=r[p].str;this.nametotextureID[m]=r[p].textureid;var y=r[p].shapid,E=r[p].range,b={};if(E)for(var M=0;M<E.length;M++)b[E[M].char]=E[M].data;var x=new Object;if(v&&g)for(var w=0;w<v.length;w++){var I=v[w];x[I]={height:1,width:(g[4*w+3]-g[4*w+2])/(g[4*w+1]-g[4*w]),left:g[4*w+2],top:g[4*w],right:g[4*w+3],bottom:g[4*w+1],shxRange:null!=E?b[I]:null}}if(y)for(var S=y.split(","),T=0;T<S.length&&S[T];T++)x[S[T]]={height:2<=t?4:2,width:2<=t?4:2*(g[4*T+3]-g[4*T+2])/(g[4*T+1]-g[4*T]),left:g[4*T+2],top:g[4*T],right:g[4*T+3],bottom:g[4*T+1],shxRange:null!=E?b[String.fromCharCode(S[T])]:null},"131"==S[T]&&(x[S[T]].height=2<=t?4:1,x[S[T]].width=2<=t?4:2),"130"==S[T]&&2<=t&&(x[S[T]].height=4,x[S[T]].width=1);f[m]=x}this.metrics[_.BLEND]=f,1==t?(i(this,this.textures,_.BLEND),n(this,this.textures,_.BLEND,!0)):(n(this,this.textures,_.BLEND,!1),this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)}},vertexShader:["void main() { ","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")}))}else if(1==e&&this.SDFVerison==e&&r){for(var A=0;A<r.bufferchunks.length;A++)r.bufferchunks[A].geometries.map(function(e,t){if("TextGeometry"===e.type)for(var n=0;n<e.text.length;n++){u.containHash(e.text.charAt(n))||u.addHash(e.text.charAt(n));var i=e.textFont;!i.style&&r.fonts&&(i=o.get(e.textFont)),d||"normal"==i.style||"normal"!=i.weight||(d=!0),c||"normal"==i.weight||"normal"!=i.style||(c=!0),h||"normal"==i.style||"normal"==i.weight||(h=!0)}});this.getHashKey(l);var R,e=this.CreateImage(l,_.NORMAL);i(this,e,_.NORMAL),d&&(R=this.CreateImage(l,_.ITALIC),i(this,R,_.ITALIC)),c&&(R=this.CreateImage(l,_.BOLD),i(this,R,_.BOLD)),h&&(l=this.CreateImage(l,_.ITALICANDBOLD),i(this,l,_.ITALICANDBOLD))}},GetMaterialStyleId:function(e,t,n){var i;return"normal"!=e&&"normal"!=t?i=_.ITALICANDBOLD:"normal"==e&&"normal"==t?i=_.NORMAL:"normal"!=e&&"normal"==t?i=_.ITALIC:"normal"==e&&"normal"!=t&&(i=_.BOLD),1<this.SDFVerison&&(i=_.BLEND),i=n?_.SHX:i},RegText:function(e){var t={text:e,underscode:!1,dash:!1,box:!1,superscript:!1,superscriptbegin:0,superscriptend:0,subscript:!1,subscriptbegin:0,subscriptend:0},n=new RegExp("%%145|%%144","gi");e=e.replace(n,""),(n=new RegExp("%%u","gi")).test(e)&&(e=e.replace(n,""),t.underscode=!0),(n=new RegExp("%%o","gi")).test(e)&&(e=e.replace(n,""),t.dash=!0),(n=new RegExp("%%nnn","gi")).test(e)&&(e=e.replace(n,""),t.box=!0),(n=new RegExp("%%140","gi")).test(e)&&(t.superscriptbegin=e.search(n),t.superscriptend=e.search("%%141"),t.superscriptend-=6,t.superscript=!0),(n=new RegExp("%%142","gi")).test(e)&&(t.subscriptbegin=e.search(n),t.subscriptend=e.search("%%143"),t.subscriptend-=6,t.subscript=!0);n=new RegExp("%%140|%%141|%%142|%%143","gi");return t.text=e.replace(n,""),t},ParseSDFTextGeometry1:function(e,t,n,i,r){var o=5<arguments.length&&void 0!==arguments[5]&&arguments[5],a=8<arguments.length&&void 0!==arguments[8]&&arguments[8],s=9<arguments.length&&void 0!==arguments[9]&&arguments[9],l=10<arguments.length&&void 0!==arguments[10]?arguments[10]:2,d=0,c=0,h=new(o?ae:THREE.BufferGeometry);h.textLoad="ttfLoad";var u=this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1),f=this.RegText(e.text);e.text=f.text,h.type="TextBufferGeometry",h.name=e.text,h.styleId=u;for(var p,m,g,v,y,E,b,M,o=a?1:e.text.length,x=Ue.enableTextRenderingBothSide?2*o:o,w=0,I=0,S=0;S<e.text.length;S++){var T,A=a?e.text:e.text[S];if(!(T=this.GetDimensionsForSize(A,e.textFont.size,u,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;if(T.isShx)return h.textLoad="unLoad",h.styleId=_.SHX,h;0===S&&(p=new Float32Array(4*x*6),p=new THREE.InterleavedBuffer(p,6),m=new THREE.InterleavedBufferAttribute(p,3,0,!1),g=new THREE.InterleavedBufferAttribute(p,2,3,!1),v=new THREE.InterleavedBufferAttribute(p,1,5,!1),y=new(16384<x?Uint32Array:64<x?Uint16Array:Uint8Array)(6*x),this.numTextGeom++,console.log("ttf text geometries: "+this.numTextGeom)),(f.superscript&&S>=f.superscriptbegin&&S<=f.superscriptend||f.subscript&&S>=f.subscriptbegin&&S<=f.subscriptend)&&(T.height*=.5,T.width*=.5);A=T.height*this.GetTextOffset(A,e.textFont.name);if(f.superscript&&S>=f.superscriptbegin&&S<=f.superscriptend&&(A-=T.height),c<T.height-A&&(c=T.height-A),m.array[24*S]=d,m.array[24*S+1]=T.height-A,m.array[24*S+2]=0,g.array[24*S+3]=T.left,g.array[24*S+4]=T.top,v.array[24*S+5]=T.textureid,m.array[24*S+6]=d+T.width,m.array[24*S+7]=T.height-A,m.array[24*S+8]=0,g.array[24*S+9]=T.right,g.array[24*S+10]=T.top,v.array[24*S+11]=T.textureid,m.array[24*S+12]=d,m.array[24*S+13]=-A,m.array[24*S+14]=0,g.array[24*S+15]=T.left,g.array[24*S+16]=T.bottom,v.array[24*S+17]=T.textureid,m.array[24*S+18]=d+T.width,m.array[24*S+19]=-A,m.array[24*S+20]=0,g.array[24*S+21]=T.right,g.array[24*S+22]=T.bottom,v.array[24*S+23]=T.textureid,y[6*S]=4*S,y[6*S+1]=4*S+2,y[6*S+2]=4*S+1,y[6*S+3]=4*S+2,y[6*S+4]=4*S+3,y[6*S+5]=4*S+1,w=w<(d+=T.width)?d:w,I=T.height>I?T.height:I,a)break}if(Ue.enableTextRenderingBothSide)for(var d=0,R=e.text.length-1,O=e.text.length;0<=R;R--,O++){var P=a?e.text:e.text[O],C=this.GetDimensionsForSize(P,e.textFont.size,u,e.textFont.name,e.textFont.width,e.textFont.bigName);if(!C)return null;P=C.height*this.GetTextOffset(P,e.textFont.name);if(m.array[24*O]=d,m.array[24*O+1]=C.height-P,m.array[24*O+2]=0,g.array[24*O+3]=C.left,g.array[24*O+4]=C.top,v.array[24*O+5]=C.textureid,m.array[24*O+6]=d+C.width,m.array[24*O+7]=C.height-P,m.array[24*O+8]=0,g.array[24*O+9]=C.right,g.array[24*O+10]=C.top,v.array[24*O+11]=C.textureid,m.array[24*O+12]=d,m.array[24*O+13]=-P,m.array[24*O+14]=0,g.array[24*O+15]=C.left,g.array[24*O+16]=C.bottom,v.array[24*O+17]=C.textureid,m.array[24*O+18]=d+C.width,m.array[24*O+19]=-P,m.array[24*O+20]=0,g.array[24*O+21]=C.right,g.array[24*O+22]=C.bottom,v.array[24*O+23]=C.textureid,y[6*O+2]=4*O+1,y[6*O]=4*O+2,y[6*O+1]=4*O,y[6*O+3]=4*O+1,y[6*O+4]=4*O+3,y[6*O+5]=4*O+2,d+=C.width,a)break}return"ttfLoad"==h.textLoad&&(h.addAttribute("position",m),h.addAttribute("uv",g),h.addAttribute("textureid",v),h.setIndex(new THREE.Uint32BufferAttribute(y,1)),h.drawRange.start=0,h.drawRange.count=y.length),h.rectWidth=w,h.rectHeight=I,s&&((s=new THREE.Euler).setFromQuaternion(n),l<2&&(h.rotateZ(s.z),h.rotateY(s.y),h.rotateX(s.x),h.translate(t.x,t.y,t.z),this.AddObject(h,u,r)),f.underscode&&((E=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(b=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(d,0,0)),b.rotateZ(s.z),b.rotateY(s.y),b.rotateX(s.x),b.translate(t.x,t.y-.1*T.height,t.z),(M=new THREE.LineSegments(b,E)).name=r,M.color=E.color.clone(),this.AddLine(M)),f.box&&((E=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(b=new THREE.Geometry).vertices.push(new THREE.Vector3(d,c,0),new THREE.Vector3(d,0,0),new THREE.Vector3(d,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,c,0),new THREE.Vector3(0,c,0),new THREE.Vector3(d,c,0)),b.rotateZ(s.z),b.rotateY(s.y),b.rotateX(s.x),b.translate(t.x,t.y,t.z),(M=new THREE.LineSegments(b,E)).name=r,M.color=E.color.clone(),this.AddLine(M)),f.dash&&((E=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(b=new THREE.Geometry).vertices.push(new THREE.Vector3(0,c,0),new THREE.Vector3(d,c,0)),b.rotateZ(s.z),b.rotateY(s.y),b.rotateX(s.x),b.translate(t.x,t.y+.1*T.height,t.z),(M=new THREE.LineSegments(b,E)).name=r,M.color=E.color.clone(),this.AddLine(M))),h},ParseSDFTextGeometry:function(e,t,n,i,r){var o,a,s=5<arguments.length&&void 0!==arguments[5]&&arguments[5],l=8<arguments.length&&void 0!==arguments[8]&&arguments[8],d=9<arguments.length&&void 0!==arguments[9]&&arguments[9],c=10<arguments.length&&void 0!==arguments[10]?arguments[10]:2,h=0,u=0,f=l?1:e.text.length,p=Ue.enableTextRenderingBothSide?2*f:f,m=0,g=0,v=0,y=new(s?ae:THREE.BufferGeometry);y.textLoad="ttfLoad";var E=this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1),b=this.RegText(e.text);e.text=b.text,y.type="TextBufferGeometry",y.name=e.text,y.styleId=E;for(var M=0,x=0,w=0;w<e.text.length;w++){var I,S,T,A,R=l?e.text:e.text[w];if(!(I=this.GetDimensionsForSize(R,e.textFont.size,E,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;if(I.isShx){y.textLoad="unLoad",y.styleId=_.SHX;var O=new THREE.Euler;n&&O.setFromQuaternion(n);var P,C,B,h=e.text.length*I.width,L=I.height*this.GetTextOffset(R,e.textFont.name);return u<I.height-L&&(u=I.height-L),d&&(b.underscode&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(h,0,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y-.1*I.height,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B)),b.box&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(h,u,0),new THREE.Vector3(h,0,0),new THREE.Vector3(h,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,u,0),new THREE.Vector3(0,u,0),new THREE.Vector3(h,u,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B)),b.dash&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(0,u,0),new THREE.Vector3(h,u,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y+.1*I.height,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B))),y}0===w&&(g=(m=(L=this.getTTFGeometryBuffer(p)).bufferOffset)/6,S=L.compositePositionAttrib,T=L.compositeUvAttrib,A=L.compositeTextureAttrib,L.bufferOffset+=24*p,a=L.index,o=L.index.array,v=L.indexOffset,L.indexOffset+=6*p),(b.superscript&&w>=b.superscriptbegin&&w<=b.superscriptend||b.subscript&&w>=b.subscriptbegin&&w<=b.subscriptend)&&(I.height*=.5,I.width*=.5);R=I.height*this.GetTextOffset(R,e.textFont.name);if(b.superscript&&w>=b.superscriptbegin&&w<=b.superscriptend&&(R-=I.height),u<I.height-R&&(u=I.height-R),S.data.array[m+24*w]=h,S.data.array[m+24*w+1]=I.height-R,S.data.array[m+24*w+2]=0,T.data.array[m+24*w+3]=I.left,T.data.array[m+24*w+4]=I.top,A.data.array[m+24*w+5]=I.textureid,S.data.array[m+24*w+6]=h+I.width,S.data.array[m+24*w+7]=I.height-R,S.data.array[m+24*w+8]=0,T.data.array[m+24*w+9]=I.right,T.data.array[m+24*w+10]=I.top,A.data.array[m+24*w+11]=I.textureid,S.data.array[m+24*w+12]=h,S.data.array[m+24*w+13]=-R,S.data.array[m+24*w+14]=0,T.data.array[m+24*w+15]=I.left,T.data.array[m+24*w+16]=I.bottom,A.data.array[m+24*w+17]=I.textureid,S.data.array[m+24*w+18]=h+I.width,S.data.array[m+24*w+19]=-R,S.data.array[m+24*w+20]=0,T.data.array[m+24*w+21]=I.right,T.data.array[m+24*w+22]=I.bottom,A.data.array[m+24*w+23]=I.textureid,o[v+6*w]=g+4*w,o[v+6*w+1]=g+4*w+2,o[v+6*w+2]=g+4*w+1,o[v+6*w+3]=g+4*w+2,o[v+6*w+4]=g+4*w+3,o[v+6*w+5]=g+4*w+1,M=M<(h+=I.width)?h:M,x=I.height>x?I.height:x,l)break}if(Ue.enableTextRenderingBothSide){h=0;for(var D=e.text.length-1,H=e.text.length;0<=D;D--,H++){var N=l?e.text:e.text[H],F=this.GetDimensionsForSize(N,e.textFont.size,E,e.textFont.name,e.textFont.width,e.textFont.bigName);if(!F)return null;N=F.height*this.GetTextOffset(N,e.textFont.name);if(S.array[m+24*H]=h,S.array[m+24*H+1]=F.height-N,S.array[m+24*H+2]=0,T.array[m+24*H+3]=F.left,T.array[m+24*H+4]=F.top,A.array[m+24*H+5]=F.textureid,S.array[m+24*H+6]=h+F.width,S.array[m+24*H+7]=F.height-N,S.array[m+24*H+8]=0,T.array[m+24*H+9]=F.right,T.array[m+24*H+10]=F.top,A.array[m+24*H+11]=F.textureid,S.array[m+24*H+12]=h,S.array[m+24*H+13]=-N,S.array[m+24*H+14]=0,T.array[m+24*H+15]=F.left,T.array[m+24*H+16]=F.bottom,A.array[m+24*H+17]=F.textureid,S.array[m+24*H+18]=h+F.width,S.array[m+24*H+19]=-N,S.array[m+24*H+20]=0,T.array[m+24*H+21]=F.right,T.array[m+24*H+22]=F.bottom,A.array[m+24*H+23]=F.textureid,o[v+6*H+2]=g+4*H+1,o[v+6*H]=g+4*H+2,o[v+6*H+1]=g+4*H,o[v+6*H+3]=g+4*H+1,o[v+6*H+4]=g+4*H+3,o[v+6*H+5]=g+4*H+2,h+=F.width,l)break}}return"ttfLoad"==y.textLoad&&(y.addAttribute("position",S),y.addAttribute("uv",T),y.addAttribute("textureid",A),y.setIndex(a),y.drawRange.start=v,y.drawRange.count=6*p),y.rectWidth=M,y.rectHeight=x,d&&((O=new THREE.Euler).setFromQuaternion(n),c<2&&(y.rotateZ(O.z),y.rotateY(O.y),y.rotateX(O.x),y.translate(t.x,t.y,t.z),this.AddObject(y,E,r)),b.underscode&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(h,0,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y-.1*I.height,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B)),b.box&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(h,u,0),new THREE.Vector3(h,0,0),new THREE.Vector3(h,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,u,0),new THREE.Vector3(0,u,0),new THREE.Vector3(h,u,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B)),b.dash&&((P=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(C=new THREE.Geometry).vertices.push(new THREE.Vector3(0,u,0),new THREE.Vector3(h,u,0)),C.rotateZ(O.z),C.rotateY(O.y),C.rotateX(O.x),C.translate(t.x,t.y+.1*I.height,t.z),(B=new THREE.LineSegments(C,P)).name=r,B.color=P.color.clone(),this.AddLine(B))),y},AddShxTextInfo:function(e){this.shxTextArray.push(e)},ProcessShxText:function(e,t){null!=t&&(this.ShxData=t);for(var n=0;n<this.shxTextArray.length;n++){var i=this.shxTextArray[n],r=e.ndsModel.getGeomManager().getGeomFromUuid(i.geomuuid,i.id);r&&(this.SetShxTextGeometry(this.ShxData,r,i.jsonText,!1),r.textLoad="shxLoad")}},SetLineStyleShxTextGeometry:function(e,t,n,i){if(!e)return!1;var r=0,o=this.GetMaterialStyleId(n.textFont.style,n.textFont.weight,!1),a=this.RegText(n.text);n.text=a.text;for(var s=[],l=[],d=0,c=0;c<n.text.length;c++){var h=i?n.text:n.text[c],u=this.GetDimensionsForSize(h,n.textFont.size,o,n.textFont.name,n.textFont.width,n.textFont.bigName);if(u&&u.shxRange){for(var f=u.height,p=u.width,m=u.shxRange[0],g=1;g<u.shxRange.length;g++){for(var v=m;v<u.shxRange[g]+m;v+=4)s.push(r+e[v]*p),s.push(e[v+1]*f),s.push(0),s.push(r+e[v+2]*p),s.push(e[v+3]*f),s.push(0),l[d]=d,l[++d]=d,d++;m+=u.shxRange[g]}if(r+=u.width,i)break}else" "!=h&&console.log("LineStyle faild: ",h," info: ",n),r+=u.width}a=new Float32Array(s),a=new THREE.InterleavedBuffer(a,3),a=new THREE.InterleavedBufferAttribute(a,3,0,!1);return t.addAttribute("position",a),t.setIndex(new(65536<s.length/3?THREE.Uint32BufferAttribute:256<s.length/3?THREE.Uint16BufferAttribute:THREE.Uint8BufferAttribute)(l,1)),!0},SetShxTextGeometry:function(e,t,n,i){var r=0,o=this.GetMaterialStyleId(n.textFont.style,n.textFont.weight,!1),a=this.RegText(n.text);n.text=a.text;for(var s=[],l=[],d=0,c=0;c<n.text.length;c++){var h=i?n.text:n.text[c],u=this.GetDimensionsForSize(h,n.textFont.size,o,n.textFont.name,n.textFont.width,n.textFont.bigName);if(u&&u.shxRange){for(var f=u.height,p=u.width,m=u.shxRange[0],g=1;g<u.shxRange.length;g++){for(var v=m;v<u.shxRange[g]+m;v+=4)s[s.length]=r+e[v]*p,s[s.length]=e[v+1]*f,s[s.length]=0,s[s.length]=r+e[v+2]*p,s[s.length]=e[v+3]*f,s[s.length]=0,l[d]=d,l[++d]=d,d++;m+=u.shxRange[g]}if(r+=u.width,i)break}else" "!=h&&console.log("faild: ",h," info: ",n),r+=u.width}var y=this.getSHXGeometryBuffer(s.length/3);t.drawRange.start=y.indexOffset,t.drawRange.count=l.length;for(var E=0,b=l.length;E<b;++E)l[E]+=y.indexOffset;y.compositeIBuffer.array.set(s,y.bufferOffset),y.bufferOffset+=s.length,y.index.array.set(l,y.indexOffset),y.indexOffset+=l.length;a=y.compositePositionAttrib;t.addAttribute("position",a),t.setIndex(y.index)},GetDimensionsForSize:function(e,t,n,i,r,o){var a=null,s=i,l="msyh.ttf";1<this.SDFVerison&&this.metrics[n]?(this.metrics[n][i]&&(a=this.metrics[n][i][e],s=i),!a&&o&&this.metrics[n][o]&&(a=this.metrics[n][o][e],s=o),!a&&this.metrics[n][l]&&(a=this.metrics[n][l][e],s=l)):1==this.SDFVerison&&this.metrics[n]&&(a=this.metrics[n][e],s=l);o=!1;a||(o=!0,a={height:1,width:1,left:0,top:0,right:1,bottom:1,textureid:0,shxRange:null});n=1<this.SDFVerison?this.GetTextScale(e,s):1,l=!(1<this.SDFVerison)||null==r?1:r,e=a.height*n,r=a.width*n*l,n=this.nametotextureID[s];return{height:e*t,width:r*t,left:a.left,top:a.top,right:a.right,bottom:a.bottom,textureid:(n=o?5:n)||0,font:s,widthScale:l*(l<1.5?.95:1),discard:o,isShx:null!=a.shxRange,shxRange:a.shxRange}},AddTextGeometryBuffer:function(e,t,n,i,r){var o=this.AttributeArray[t];o&&!Array.isArray(o)?this.AttributeArray[t]=o=[o]:o||(this.AttributeArray[t]=o=[]),e.uuidtorange[n]={start:i,count:r},o.indexOf(e)<0&&(o[o.length]=e)},AddObject:function(e,t,n){var i=this.AttributeArray[t];i||(i={propertyArray:new Array,IndexArray:new Array,ArrayLength:0,uuidtorange:new Object},this.AttributeArray[t]=i);var r=e.getAttribute("position");i.uuidtorange[n]={start:i.propertyArray.length/9,count:r.count};for(var o=0;o<r.array.length;++o)i.propertyArray.push(r.array[o]);for(var a=e.getIndex(),s=0;s<a.array.length;s++)i.IndexArray.push(a.array[s]+i.ArrayLength);i.ArrayLength+=r.count},AddLine:function(e){this.lines.push(e)},GetLines:function(){return this.lines},GetLineStyleMaterial:function(e,t){return t?this.shxMaterial:2<=e?this.blendMaterial:this.newblendMaterial},GetMaterial:function(e){switch(e){case _.ITALIC:return this.TextMaterialItalic;case _.NORMAL:return this.TextMaterial;case _.BOLD:return this.TextMaterialBold;case _.ITALICANDBOLD:return this.TextMaterialIandB;case _.BLEND:return this.blendMaterial;case _.SHX:return this.shxMaterial}},HaveSDF:function(){return this.AttributeArray.length},CreateMesh:function(){for(var e=new THREE.Group,t=0;t<this.AttributeArray.length;t++)if(this.AttributeArray[t])if(Array.isArray(this.AttributeArray[t]))for(var n=0,i=this.AttributeArray[t].length;n<i;++n){var r=this.AttributeArray[t][n],o=(r.compositeIBuffer,r.compositePositionAttrib),a=r.compositeColorAttrib,s=r.compositeUvAttrib,l=r.compositeTextureAttrib;(d=new THREE.BufferGeometry).addAttribute("position",o),d.addAttribute("color",a),d.addAttribute("uv",s),d.addAttribute("textureid",l),d.setIndex(r.index);r=new THREE.Mesh(d,this.GetMaterial(t));r.name=t+"_"+n,e.add(r)}else{var d=new THREE.BufferGeometry,c=new Float32Array(this.AttributeArray[t].propertyArray),h=new THREE.InterleavedBuffer(c,9),u=new THREE.InterleavedBufferAttribute(h,3,0,!1),f=new THREE.InterleavedBufferAttribute(h,3,3,!1),c=new THREE.InterleavedBufferAttribute(h,2,6,!1),h=new THREE.InterleavedBufferAttribute(h,1,8,!1);d.addAttribute("position",u),d.addAttribute("color",f),d.addAttribute("uv",c),d.addAttribute("textureid",h),d.setIndex(this.AttributeArray[t].IndexArray);h=new THREE.Mesh(d,this.GetMaterial(t));h.name=t,e.add(h)}return e.name="TextGroup",this.ClearMemory(),e},ClearMemory:function(){for(var e=0;e<this.AttributeArray.length;++e)if(Array.isArray(this.AttributeArray[e]))for(var t=0;t<this.AttributeArray[e].length;++t)this.AttributeArray[e][t]&&(this.AttributeArray[e][t]=this.AttributeArray[e][t].uuidtorange);else this.AttributeArray[e]&&(this.AttributeArray[e]=this.AttributeArray[e].uuidtorange);this.specialCodeArray=[],this.HashTable=null}},_.ITALIC=0,_.BOLD=1,_.NORMAL=2,_.ITALICANDBOLD=3,_.BLEND=4,_.SHX=5;function L(e){this.viewer=e,this.uuidToLineStyle={},this.geomUUidToLineInfo={},this.ttfMesh=new THREE.Mesh,this.shxMesh=new THREE.LineSegments,this.pointMesh=new THREE.Points,this.lineMesh=new THREE.LineSegments,this.lineMaterials=[],this.createLineStyle=function(e,t){var n=null;if(t)for(var n={},i=0;i<t.length;i++)n[t[i].uuid]=t[i];for(var r=0;r<e.length;r++){for(var o,a=e[r].fScale,s={pattern:e[r].fPatternLength*a,pointPattern:[],linePattern:[],textPattern:[],textureArray:new Uint8Array(3072),textGeomArray:[],textOrPoint:!1},l=0,d=0,c=0;c<e[r].nDashes;c++){var h,u,f=e[r].lItem[c];if(d+=Math.abs(f.fLength*a),0!=f.fLength){for(o=Math.floor(d/s.pattern*1024),s.linePattern.push(f.fLength*a);l<o;)s.textureArray[3*l]=0<=f.fLength?0:255,l++;(0<f.nShapeId||null!=f.strText)&&(h={bigName:"",name:f.fontName,size:f.fScale*a,style:"normal",weight:"normal",width:1},n&&f.fontUUid&&n[f.fontUUid]&&(h.bigName=n[f.fontUUid].bigName,h.name=n[f.fontUUid].name,h.style=n[f.fontUUid].style,h.weight=n[f.fontUUid].weight,h.width=n[f.fontUUid].width),h&&(u=this.viewer.SDFMaker.IsShxFont(h.name),(u={text:0<f.nShapeId?f.nShapeId.toString():f.strText,textFont:h,dash:d,rotation:f.fRotation,isShx:u,shapeId:f.nShapeId,offset:new THREE.Vector2}).offset.x=f.offset[0],u.offset.y=f.offset[1],s.textPattern.push(u),s.textOrPoint=!0))}else s.pointPattern.push(d),s.textOrPoint=!0}this.uuidToLineStyle[e[r].strId]=s}},this.createTextGeometry=function(e,t,n){if(!(0<this.uuidToLineStyle[e].textGeomArray.length))for(var i=this.uuidToLineStyle[e].textPattern,r=0;r<i.length;r++){var o=i[r],a=o.textFont.size;o.textFont.size=a*n;var s=this.viewer.SDFMaker.ParseSDFTextGeometry(o,null,null,t,null,!1,!1,!1,0<o.shapeId);"unLoad"==s.textLoad&&(this.viewer.SDFMaker.SetLineStyleShxTextGeometry(this.viewer.SDFMaker.ShxData,s,o,0<o.shapeId),s.textLoad="shxLoad"),o.textFont.size=a,s.computeBoundingBox();o={position:s.getAttribute("position"),index:s.getIndex(),color:t,drawRange:s.drawRange,translateX:s.boundingBox.max.x-s.boundingBox.min.x,translateY:(s.boundingBox.max.y-s.boundingBox.min.y)/this.viewer.SDFMaker.GetTextScale(null,o.textFont.name)};this.uuidToLineStyle[e].textGeomArray.push(o)}},this.setBackGroundColor=function(e){this.backColor=e},this.colorTest=function(e){return this.backColor&&this.backColor.equals(e)?new THREE.Color(16777215-e.getHex()):e},this.getLineStyleInfo=function(e,t,n,i,r){if(this.viewer.is2DModel&&!(this.viewer.SDFMaker.needShxLoad&&!this.viewer.SDFMaker.ShxData&&2<=this.viewer.modelContentVersion)){var o=this.geomUUidToLineInfo[e.uuid],a=this.uuidToLineStyle[t];if(!o&&a&&a.textOrPoint){var s=a.textPattern,l=a.pointPattern,d=a.pattern;0<s.length&&this.createTextGeometry(t,i,n);var c=e.getAttribute("position");if(e.index){for(var h,u,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=(new THREE.Vector3,new THREE.Vector3),E=[],b=[],M={data:[],index:[],length:0},x={data:[],index:[],length:0},w=e.drawRange.start,I=e.drawRange.start+e.drawRange.count;w<I;w+=2){h=e.index.getX(w),R=e.index.getX(w+1),f.fromBufferAttribute(c,h),p.fromBufferAttribute(c,R),m.subVectors(p,f);var S=f.distanceTo(p);if(!(S<=0)){var T=Math.floor(S/(d*n))+1;if(0<l.length&&1e4<T||s.length&&1e3<T)console.log("lineStyle pattern repeat : ",T," use solid line"),E.push(f.x,f.y,f.z,p.x,p.y,p.z);else{u=m.clone().normalize(),y.set(0,0,1),y.cross(u).normalize(),v.set(1,0,0);var A=v.angleTo(u);v.cross(u).normalize();var R=0<=v.z?1:-1,O=A>Math.PI/2?(A-Math.PI)*R:A*R;v.set(0,0,1);for(var P=0;P<l.length;P++)for(var C=0;C<T;C++){var B=(l[P]+C*d)*n/S;if(.999<=B)break;(g=f.clone()).addScaledVector(m,B),b.push(g.x,g.y,g.z)}for(var L=0;L<s.length;L++)for(var D=s[L],H=a.textGeomArray[L].position,N=a.textGeomArray[L].index,F=a.textGeomArray[L].translateX,_=a.textGeomArray[L].translateY,k=a.textGeomArray[L].drawRange,V=0;V<T;V++){var j=(D.dash+V*d)*n/S;if(.999<=j)break;(g=f.clone()).addScaledVector(m,j),A>Math.PI/2&&(g.addScaledVector(u,F),D.isShx||g.addScaledVector(y,_)),D.isShx&&0==D.shapeId&&(y.y=Math.abs(y.y)),g.addScaledVector(u,D.offset.x),g.addScaledVector(y,D.offset.y),(130==D.shapeId||132==D.shapeId||133==D.shapeId)&&this.viewer.modelContentVersion<2&&g.addScaledVector(y,-y.y*_*.5),D.isShx&&2<=this.viewer.modelContentVersion?this.addShxTextAttribute(x,H,N,k,g,v,O+D.rotation):this.addTextAttribute(M,H,N,k,g,v,O+D.rotation)}}}}this.geomUUidToLineInfo[e.uuid]={lineTypeID:t,textGeom:null,textIsShx:!1,pointGeom:null,lineGeom:null,color:i},0<s.length&&(0<M.length&&this.createTextGeom(e.uuid,M),0<x.length&&this.createShxTextGeom(e.uuid,x)),0<l.length&&this.createPointGeom(e.uuid,b),0<E.length&&this.createLineGeom(e.uuid,E)}}if(o){var U=this.getTextMaterial(),z=this.getShxTextMaterial(),G=this.getPointMaterial(),W=this.getLineMaterial();U&&(U.uniforms.diffuse.value.copy(this.colorTest(r?Ue.selectedColor:o.color)),U.uniformsNeedUpdate=!0),z&&(z.uniforms.diffuse.value.copy(this.colorTest(r?Ue.selectedColor:o.color)),z.uniformsNeedUpdate=!0),G&&(G.uniforms.diffuse.value.copy(this.colorTest(r?Ue.selectedColor:o.color)),G.uniformsNeedUpdate=!0),W&&(W.uniforms.diffuse.value.copy(this.colorTest(r?Ue.selectedColor:o.color)),W.uniformsNeedUpdate=!0);t=null,i=null,r=null;return o.textGeom&&(o.textIsShx?((t=this.shxMesh).geometry=o.textGeom,t.material=z):((t=this.ttfMesh).geometry=o.textGeom,t.material=U)),o.pointGeom&&((i=this.pointMesh).geometry=o.pointGeom,i.material=G),o.lineGeom&&((r=this.lineMesh).geometry=o.lineGeom,r.material=W),{textMesh:t,pointMesh:i,lineMesh:r}}return null}},this.getLineStyleInfoForPDF=function(e,t,n,i){if(this.viewer.is2DModel&&!(this.viewer.SDFMaker.needShxLoad&&!this.viewer.SDFMaker.ShxData&&2<=this.viewer.modelContentVersion)){var r=this.uuidToLineStyle[t];if(r&&r.textOrPoint){var o=r.textPattern,a=r.pointPattern,s=r.pattern;0<o.length&&this.createTextGeometry(t,i,n);var l=e.getAttribute("position");if(e.index){for(var d,c,h=new THREE.Vector3,u=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=(new THREE.Vector3,new THREE.Vector3),v={},y=[],E=[],b=e.drawRange.start,M=e.drawRange.start+e.drawRange.count;b<M;b+=2){d=e.index.getX(b),S=e.index.getX(b+1),h.fromBufferAttribute(l,d),u.fromBufferAttribute(l,S),f.subVectors(u,h);var x=h.distanceTo(u);if(!(x<=0)){var w=Math.floor(x/(s*n))+1;if(0<a.length&&1e4<w||o.length&&1e3<w)console.log("lineStyle pattern repeat : ",w," use solid line"),E.push(h.x,h.y,h.z,u.x,u.y,u.z);else{c=f.clone().normalize(),g.set(0,0,1),g.cross(c).normalize(),m.set(1,0,0);var I=m.angleTo(c);m.cross(c).normalize();var S=0<=m.z?1:-1,T=I>Math.PI/2?(I-Math.PI)*S:I*S;m.set(0,0,1);for(var A=0;A<a.length;A++)for(var R=0;R<w;R++){var O=(a[A]+R*s)*n/x;if(.999<=O)break;(p=h.clone()).addScaledVector(f,O),y.push(p.x,p.y,p.z)}for(var P=0;P<o.length;P++){var C=o[P],B=r.textGeomArray[P].translateX,L=r.textGeomArray[P].translateY,D=v[C.text];D||(D={fontName:C.textFont.name,isShx:C.isShx,shapeId:C.shapeId,size:C.textFont.size,data:new Array},v[C.text]=D);for(var H=0;H<w;H++){var N=(C.dash+H*s)*n/x;if(.999<=N)break;(p=h.clone()).addScaledVector(f,N),I>Math.PI/2&&(p.addScaledVector(c,B),C.isShx||p.addScaledVector(g,L)),C.isShx&&0==C.shapeId&&(g.y=Math.abs(g.y)),p.addScaledVector(c,C.offset.x),p.addScaledVector(g,C.offset.y),D.data.push(p.x,p.y,T+C.rotation)}}}}}return{styleText:v,stylePoint:y,styleLine:E}}}return{styleText:null,stylePoint:null,styleLine:null}}},this.addTextAttribute=function(e,t,n,i,r,o,a){for(var s=new THREE.Vector3,l=i.start,d=Math.min(i.count,n.count),c=n.array[l],h=c,u=l;u<l+d;++u)c=c>n.array[u]?n.array[u]:c,h=h>n.array[u]?h:n.array[u];for(var f=c;f<=h;f++)s.fromArray(t.array,6*f),s.applyAxisAngle(o,a),s.add(r),e.data.push(s.x),e.data.push(s.y),e.data.push(s.z),e.data.push(t.array[6*f+3]),e.data.push(t.array[6*f+4]),e.data.push(t.array[6*f+5]);for(var p=l;p<l+d;++p)e.index.push(n.array[p]-c+e.length);e.length+=h-c+1},this.addShxTextAttribute=function(e,t,n,i,r,o,a){if(t){for(var s=new THREE.Vector3,l=i.start,d=Math.min(i.count,n.count),c=n.array[l],h=c,u=l;u<l+d;++u)c=c>n.array[u]?n.array[u]:c,h=h>n.array[u]?h:n.array[u];for(var f=c;f<=h;++f)s.fromArray(t.array,3*f),s.applyAxisAngle(o,a),s.add(r),e.data.push(s.x),e.data.push(s.y),e.data.push(s.z);for(var p=l;p<l+d;++p)e.index.push(n.array[p]-c+e.length);e.length+=h-c+1}},this.createTextGeom=function(e,t){var n=new THREE.BufferGeometry,i=new Float32Array(t.data),r=new THREE.InterleavedBuffer(i,6),o=new THREE.InterleavedBufferAttribute(r,3,0,!1),i=new THREE.InterleavedBufferAttribute(r,2,3,!1),r=new THREE.InterleavedBufferAttribute(r,1,5,!1);n.addAttribute("position",o),n.addAttribute("uv",i),n.addAttribute("textureid",r),n.setIndex(t.index),n.name="ttf",this.geomUUidToLineInfo[e].textGeom=n,this.geomUUidToLineInfo[e].textIsShx=!1},this.createShxTextGeom=function(e,t){var n=new THREE.BufferGeometry,i=new Float32Array(t.data),i=new THREE.InterleavedBuffer(i,3),i=new THREE.InterleavedBufferAttribute(i,3,0,!1);n.addAttribute("position",i),n.setIndex(t.index),n.name="shx",this.geomUUidToLineInfo[e].textGeom=n,this.geomUUidToLineInfo[e].textIsShx=!0},this.createPointGeom=function(e,t){for(var n=[],i=0;i<t.length/3;i++)n.push(i);var r=new THREE.BufferGeometry,o=new Float32Array(t),o=new THREE.InterleavedBuffer(o,3),o=new THREE.InterleavedBufferAttribute(o,3,0,!1);r.addAttribute("position",o),r.setIndex(n),r.name="point",this.geomUUidToLineInfo[e].pointGeom=r},this.createLineGeom=function(e,t){for(var n=[],i=0;i<t.length/3;i++)n.push(i);var r=new THREE.BufferGeometry,o=new Float32Array(t),o=new THREE.InterleavedBuffer(o,3),o=new THREE.InterleavedBufferAttribute(o,3,0,!1);r.addAttribute("position",o),r.setIndex(n),r.name="line",this.geomUUidToLineInfo[e].lineGeom=r},this.getMaterial=function(e){var t=this.uuidToLineStyle[e],n=null,e=1;t?(n=new THREE.DataTexture(t.textureArray,1024,1,THREE.RGBFormat),e=t.pattern):(n=new THREE.DataTexture(new Uint8Array(3072),1024,1,THREE.RGBFormat),console.log("lineType map failded")),n.needsUpdate=!0;e=new THREE.ShaderMaterial({uniforms:{lineScale:{value:1},lineTypeId:{value:0},uSampler:{value:n},patternLength:{value:e},opacity:{value:.8},diffuse:{value:new THREE.Color(16711680)}},linewidth:1,transparent:!0,fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float patternLength;","uniform float lineScale;","uniform sampler2D uSampler;","varying float vLineDistance;","void main() {","float newDistance = vLineDistance/lineScale;","float modSize = mod( newDistance, patternLength);","vec3 value = texture2D(uSampler,vec2(modSize/patternLength,0.0)).rgb;","if(value.r > 0.9){","discard;","}","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","outgoingLight = diffuseColor.rgb;","gl_FragColor = vec4(outgoingLight, diffuseColor.a );","}"].join("\n"),vertexShader:["attribute float lineDistance;","varying float vLineDistance;","void main() {","vLineDistance =  lineDistance;","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n")});return this.lineMaterials.push(e),e},this.getTextMaterial=function(){return this.viewer.SDFMaker.GetLineStyleMaterial(this.viewer.modelContentVersion)},this.getShxTextMaterial=function(){return 2<=this.viewer.modelContentVersion?this.viewer.SDFMaker.GetMaterial(_.SHX):this.getTextMaterial()},this.getPointMaterial=function(){return this.pointMaterial||(this.pointMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16711680)}},vertexShader:["void main() { ","gl_PointSize = 1.5;","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")}),0==Ue.enableTextRenderingBothSide?this.pointMaterial.side=THREE.DoubleSide:this.pointMaterial.side=THREE.FrontSide),this.pointMaterial},this.getLineMaterial=function(){return this.lineMaterial||(this.lineMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16711680)}},vertexShader:["void main() { ","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")})),this.lineMaterial},this.getLineStyleArray=function(e){return this.uuidToLineStyle[e].linePattern},this.clearLineType=function(){for(var e=0;e<this.lineMaterials.length;e++)this.lineMaterials[e].dispose();this.lineMaterials=[]}}NDS.DASHTYPE={SOLID:0,DASH:1,DASHSPACE:2,LONGDASH_DOT:3,LONGDASH_DOUBLEDOT:4,LONGDASH_TRIPLEDOT:5,DOT0:6,LONGDASH_SHORTDASH:7,LONGDASH_DOUBLESHORTDASH:8,DASH_DOT:9,DOUBLEDASH_DOT:10,DASH_DOUBLEDOT:11,DOUBLEDASH_DOUBLEDOT:12,DASH_TRIPLEDOT:13,DOUBLEDASH_TRIPLEDOT:14,BATTING:15,BORDER:16,BORDER2:17,BORDERX2:18,CENTER:19,CENTER2:20,CENTERX2:21,DASHDOT:22,DASHDOT2:23,DASHDOTX2:24,DASHED:25,DASHED2:26,DASHEDX2:27,DIVIDE:28,DIVIDE2:29,DIVIDEX2:30,DOT:31,DOT2:32,DOTX2:33,FENCELINE1:34,FENCELINE2:35,GAS_LINE:36,HIDDEN:37,HIDDEN2:38,HIDDENX2:39,HOT_WATER_SUPPLY:40,JIS_02_07:41,JIS_02_10:42,JIS_02_12:43,JIS_02_20:44,JIS_02_40:45,JIS_08_11:46,JIS_08_15:47,JIS_08_25:48,JIS_08_37:49,JIS_08_50:50,JIS_09_08:51,JIS_09_15:52,JIS_09_29:53,JIS_09_50:54,PHANTOM:55,PHANTOM2:56,PHANTOMX2:57,TRACKS:58,ZIGZAG:59,CUSTOM:999};var D=function e(t,n,i){this.showStatus=t,this.statusDomElement=t?e.prototype.addStatusElement():null,this.imageLoader=new THREE.ImageLoader,this.manager=void 0!==n?n:THREE.DefaultLoadingManager,this.viewer=i,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}};D.prototype={constructor:D,crossOrigin:void 0,addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ";e.total?t+=(100*e.loaded/e.total).toFixed(0)+"%":t+=(e.loaded/1024).toFixed(2)+" KB",this.statusDomElement.innerHTML=t},extractUrlBase:function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},loadTexture:function(e,t,n,i,r,o){if(void 0!==t[n])return t[n];var a,s=THREE.Loader.Handlers.get(n),l=n;return Ue.avoidCaching&&(l=n+"?time="+Date.now()),null!==s?a=s.load(l,r):-1<n.toLowerCase().indexOf(".tga")?((s=new w).crossOrigin=this.crossOrigin,NDS.TextureLoadingManager.itemStart(),a=s.load(l,function(e){e.flipY=!0,e.needsUpdate=!0,r&&r(e),NDS.TextureLoadingManager.itemEnd()},void 0,function(){e.map=null,e.needsUpdate=!0,o&&o()})):(a=new THREE.Texture,(s=new THREE.ImageLoader(NDS.TextureLoadingManager)).crossOrigin=this.crossOrigin,s.crossOrigin="anonymous",s.load(l,function(e){a.image=e,a.needsUpdate=!0,r&&r(a)},void 0,function(){e.map=null,e.needsUpdate=!0,o&&o()})),void 0!==i&&(a.mapping=i),t[n]=a},getTrueTexName:function(e){var t=e;if(this.viewer.trueMapList)for(var n in this.viewer.trueMapList)if(e.toLowerCase()===this.viewer.trueMapList[n].toLowerCase()){t=this.viewer.trueMapList[n];break}return t},getFullTextPath:function(e,t){return-1<t.indexOf(e)||-1<t.indexOf("/")?t:e+this.getTrueTexName(t)},createMaterialForBIM:function(e,t,n,i){var r={side:THREE.DoubleSide};if(void 0!==t.name&&(r.name=t.name),void 0!==t.uuid&&(r.uuid=t.uuid),void 0!==t.type&&"LineBasicMaterial"===t.type&&(null==t.lineStyle||t.lineStyle==NDS.DASHTYPE.SOLID||t.lineStyle==NDS.DASHTYPE.CUSTOM&&null==t.lineTypeId))return void 0!==t.color&&(r.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.doubleSided&&t.doubleSided&&(r.side=THREE.DoubleSide),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(r.transparent=!0,r.opacity=a),void 0!==Ue.lineColor&&void 0!==r.color&&r.color.setHex(Ue.lineColor),void 0!==t.linewidth&&(r.linewidth=parseFloat(t.linewidth)),o=new THREE.LineBasicMaterial(r);if(void 0!==t.type&&"LineBasicMaterial"===t.type&&t.lineStyle==NDS.DASHTYPE.CUSTOM&&null!=t.lineTypeId&&this.viewer.lineTypes)return(o=this.viewer.lineTypes.getMaterial(t.lineTypeId)).uniforms.lineTypeId.value=t.lineTypeId,void 0!==t.lineScale&&(o.uniforms.lineScale.value=parseFloat(t.lineScale)),void 0!==t.color&&o.uniforms.diffuse.value.setHex(parseInt(t.color)),void 0!==t.linewidth&&(o.linewidth=parseFloat(t.linewidth)),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(o.transparent=!0,o.uniforms.opacity.value=a),void 0!==Ue.lineColor&&void 0!==r.color&&o.uniforms.diffuse.value.setHex(Ue.lineColor),o.color=new THREE.Color(16777215),o.color.copy(o.uniforms.diffuse.value),o.setValues(r),o;if(void 0!==t.type&&"LineBasicMaterial"===t.type&&null!=t.lineStyle&&t.lineStyle!=NDS.DASHTYPE.SOLID){switch((o=Ue.dashedMaterial.clone()).uniforms.lineStyle.value=t.lineStyle,t.lineStyle){case NDS.DASHTYPE.DASH:o.uniforms.dashNum.value=1,o.uniforms.pointNum.value=0,o.uniforms.pointSize.value=0;break;case NDS.DASHTYPE.DASHSPACE:o.uniforms.dashNum.value=1,o.uniforms.grapSize.value*=6,o.uniforms.pointNum.value=0,o.uniforms.pointSize.value=0;break;case NDS.DASHTYPE.LONGDASH_DOT:o.uniforms.dashSize.value*=2;break;case NDS.DASHTYPE.LONGDASH_DOUBLEDOT:o.uniforms.dashSize.value*=2,o.uniforms.pointNum.value=2;break;case NDS.DASHTYPE.LONGDASH_TRIPLEDOT:o.uniforms.dashSize.value*=2,o.uniforms.pointNum.value=3;break;case NDS.DASHTYPE.DOT0:o.uniforms.dashNum.value=0;break;case NDS.DASHTYPE.LONGDASH_SHORTDASH:o.uniforms.dashSize.value*=2,o.uniforms.pointSize.value=6;break;case NDS.DASHTYPE.LONGDASH_DOUBLESHORTDASH:o.uniforms.dashSize.value*=2,o.uniforms.pointSize.value=6,o.uniforms.pointNum.value=2;break;case NDS.DASHTYPE.DASH_DOT:break;case NDS.DASHTYPE.DOUBLEDASH_DOT:o.uniforms.dashNum.value=2;break;case NDS.DASHTYPE.DASH_DOUBLEDOT:o.uniforms.pointNum.value=2;break;case NDS.DASHTYPE.DOUBLEDASH_DOUBLEDOT:o.uniforms.dashNum.value=2,o.uniforms.pointNum.value=2;break;case NDS.DASHTYPE.DASH_TRIPLEDOT:o.uniforms.pointNum.value=3;break;case NDS.DASHTYPE.DOUBLEDASH_TRIPLEDOT:o.uniforms.dashNum.value=2,o.uniforms.pointNum.value=3;break;case NDS.DASHTYPE.BATTING:break;case NDS.DASHTYPE.BORDER:o.uniforms.dashNum.value=2;break;case NDS.DASHTYPE.BORDER2:o.uniforms.dashSize.value*=.5,o.uniforms.dashNum.value=2;break;case NDS.DASHTYPE.BORDERX2:o.uniforms.dashNum.value=2,o.uniforms.dashSize.value*=2;break;case NDS.DASHTYPE.CENTER:o.uniforms.pointSize.value=6,o.uniforms.dashSize.value*=2,o.uniforms.grapSize.value=6;break;case NDS.DASHTYPE.CENTER2:o.uniforms.pointSize.value=3;break;case NDS.DASHTYPE.CENTERX2:o.uniforms.pointSize.value=6,o.uniforms.dashSize.value*=4,o.uniforms.grapSize.value=6;break;case NDS.DASHTYPE.DASHDOT:break;case NDS.DASHTYPE.DASHDOT2:o.uniforms.dashSize.value*=.5,o.uniforms.grapSize.value*=.5;break;case NDS.DASHTYPE.DASHDOTX2:o.uniforms.dashSize.value*=2,o.uniforms.grapSize.value*=2;break;case NDS.DASHTYPE.DASHED:o.uniforms.pointNum.value=0,o.uniforms.grapSize.value*=2;break;case NDS.DASHTYPE.DASHED2:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.5;break;case NDS.DASHTYPE.DASHEDX2:o.uniforms.pointNum.value=2,o.uniforms.dashSize.value*=2,o.uniforms.grapSize.value*=4;break;case NDS.DASHTYPE.DIVIDE:o.uniforms.pointNum.value=2,o.uniforms.grapSize.value*=2;break;case NDS.DASHTYPE.DIVIDE2:o.uniforms.pointNum.value=2,o.uniforms.dashSize.value*=.5;break;case NDS.DASHTYPE.DIVIDEX2:o.uniforms.pointNum.value=2,o.uniforms.dashSize.value*=2,o.uniforms.grapSize.value*=4;break;case NDS.DASHTYPE.DOT:o.uniforms.dashNum.value=0,o.uniforms.grapSize.value*=2;break;case NDS.DASHTYPE.DOT2:o.uniforms.dashNum.value=0;break;case NDS.DASHTYPE.DOTX2:o.uniforms.dashNum.value=0,o.uniforms.grapSize.value*=4;break;case NDS.DASHTYPE.FENCELINE1:case NDS.DASHTYPE.FENCELINE2:case NDS.DASHTYPE.GAS_LINE:break;case NDS.DASHTYPE.HIDDEN:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.5;break;case NDS.DASHTYPE.HIDDEN2:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.25,o.uniforms.grapSize.value*=.5;break;case NDS.DASHTYPE.HIDDENX2:o.uniforms.pointNum.value=0,o.uniforms.grapSize.value*=2;break;case NDS.DASHTYPE.HOT_WATER_SUPPLY:break;case NDS.DASHTYPE.JIS_02_07:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.07,o.uniforms.grapSize.value*=.17;break;case NDS.DASHTYPE.JIS_02_10:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.1,o.uniforms.grapSize.value*=.2;break;case NDS.DASHTYPE.JIS_02_12:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.12,o.uniforms.grapSize.value*=.22;break;case NDS.DASHTYPE.JIS_02_20:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.2,o.uniforms.grapSize.value*=.26;break;case NDS.DASHTYPE.JIS_02_40:o.uniforms.pointNum.value=0,o.uniforms.dashSize.value*=.4,o.uniforms.grapSize.value*=.5;break;case NDS.DASHTYPE.JIS_08_11:o.uniforms.pointSize.value=.7,o.uniforms.dashSize.value=11;break;case NDS.DASHTYPE.JIS_08_15:o.uniforms.pointSize.value=.7,o.uniforms.dashSize.value=15;break;case NDS.DASHTYPE.JIS_08_25:o.uniforms.pointSize.value=.7,o.uniforms.dashSize.value=25;break;case NDS.DASHTYPE.JIS_08_37:o.uniforms.pointSize.value=.7,o.uniforms.grapSize.value=1,o.uniforms.dashSize.value=37;break;case NDS.DASHTYPE.JIS_08_50:o.uniforms.pointSize.value=.7,o.uniforms.grapSize.value=1.4,o.uniforms.dashSize.value=50;break;case NDS.DASHTYPE.JIS_09_08:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=.5,o.uniforms.dashSize.value=8,o.uniforms.grapSize.value=.9;break;case NDS.DASHTYPE.JIS_09_15:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=.5,o.uniforms.dashSize.value=15,o.uniforms.grapSize.value=.9;break;case NDS.DASHTYPE.JIS_09_29:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=.5,o.uniforms.dashSize.value=29,o.uniforms.grapSize.value=.9;break;case NDS.DASHTYPE.JIS_09_50:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=.5,o.uniforms.dashSize.value=50,o.uniforms.grapSize.value=.9;break;case NDS.DASHTYPE.PHANTOM:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=6,o.uniforms.dashSize.value=31,o.uniforms.grapSize.value=6;break;case NDS.DASHTYPE.PHANTOM2:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=3,o.uniforms.dashSize.value=15,o.uniforms.grapSize.value=3;break;case NDS.DASHTYPE.PHANTOMX2:o.uniforms.pointNum.value=2,o.uniforms.pointSize.value=12,o.uniforms.dashSize.value=60,o.uniforms.grapSize.value=12;break;case NDS.DASHTYPE.TRACKS:case NDS.DASHTYPE.ZIGZAG:}return void 0!==t.color&&o.uniforms.diffuse.value.setHex(parseInt(t.color)),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(o.transparent=!0,o.uniforms.opacity.value=a),void 0!==Ue.lineColor&&void 0!==r.color&&o.uniforms.diffuse.value.setHex(Ue.lineColor),void 0!==t.linewidth&&(o.linewidth=parseFloat(t.linewidth)),o.color=new THREE.Color(16777215),o.color.copy(o.uniforms.diffuse.value),o.setValues(r),o}var o=null;"MeshBasicMaterial"!=t.type&&void 0!==this.viewer.convertPhongToPBR&&this.viewer.convertPhongToPBR&&(t.type="MeshStandardMaterial");var a,s="";return"MeshBasicMaterial"==t.type&&(o=new THREE.MeshBasicMaterial,void 0!==t.color&&(r.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(r.transparent=!0,r.opacity=a),o.setValues(r)),void 0===t.type||"MeshPhongMaterial"===t.type?(o=new THREE.MeshPhongMaterial,void 0!==t.color&&(r.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.wireframe&&(r.wireframe=t.wireframe),void 0!==t.emissive&&(r.emissive=(new THREE.Color).setHex(parseInt(t.emissive))),void 0!==t.specular&&(r.specular=(new THREE.Color).setHex(parseInt(t.specular))),void 0!==t.shininess&&(r.shininess=parseInt(t.shininess)),void 0!==t.doubleSided&&t.doubleSided&&(r.side=THREE.DoubleSide),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(r.transparent=!0,r.opacity=a),void 0!==t.mapDiffuse&&null!==t.mapDiffuse&&(s=this.getFullTextPath(n,t.mapDiffuse),r.map=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.map.sourceFile=s,r.map.wrapS=THREE.RepeatWrapping,r.map.wrapT=THREE.RepeatWrapping),void 0!==t.map&&null!==t.map&&(s=this.getFullTextPath(n,t.map),r.map=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.map.sourceFile=s,r.map.wrapS=THREE.RepeatWrapping,r.map.wrapT=THREE.RepeatWrapping),void 0!==t.mapBump&&null!==t.mapBump&&(s=this.getFullTextPath(n,t.mapBump),r.bumpMap=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.bumpMap.sourceFile=s,r.bumpMap.wrapS=THREE.RepeatWrapping,r.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpMap&&null!==t.bumpMap&&(s=this.getFullTextPath(n,t.bumpMap),r.bumpMap=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.bumpMap.sourceFile=s,r.bumpMap.wrapS=THREE.RepeatWrapping,r.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpScale&&(r.bumpScale=parseFloat(t.bumpScale)),void 0!==t.reflectivity&&(r.reflectivity=parseFloat(t.reflectivity)),void 0!==t.refractionRatio&&(r.refractionRatio=parseFloat(t.refractionRatio)),void 0!==t.emissiveIntensity&&(r.emissiveIntensity=parseFloat(t.emissiveIntensity)),void 0!==t.shading&&(0==t.shading||2==parseInt(t.shading)?r.flatShading=!1:r.flatShading=!0),o.setValues(r),void 0!==r.shininess&&0==r.shininess&&(o.initialSpecular=new THREE.Color,o.initialSpecular.copy(o.specular),o.specular.setRGB(0,0,0))):"MeshStandardMaterial"===t.type&&(o=new THREE.MeshStandardMaterial,void 0!==t.color&&(r.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.wireframe&&(r.wireframe=t.wireframe),void 0!==t.emissive&&(r.emissive=(new THREE.Color).setHex(parseInt(t.emissive))),void 0!==t.doubleSided&&t.doubleSided&&(r.side=THREE.DoubleSide),void 0!==t.opacity&&(a=parseFloat(t.opacity))<1&&(r.transparent=!0,r.opacity=a),void 0!==t.mapDiffuse&&null!==t.mapDiffuse&&(s=this.getFullTextPath(n,t.mapDiffuse),r.map=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.map.sourceFile=s,r.map.wrapS=THREE.RepeatWrapping,r.map.wrapT=THREE.RepeatWrapping),void 0!==t.map&&null!==t.map&&(s=this.getFullTextPath(n,t.map),r.map=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.map.sourceFile=s,r.map.wrapS=THREE.RepeatWrapping,r.map.wrapT=THREE.RepeatWrapping),void 0!==t.mapBump&&null!==t.mapBump&&(s=this.getFullTextPath(n,t.mapBump),r.bumpMap=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.bumpMap.sourceFile=s,r.bumpMap.wrapS=THREE.RepeatWrapping,r.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpMap&&null!==t.bumpMap&&(s=this.getFullTextPath(n,t.bumpMap),r.bumpMap=this.loadTexture(o,e,s,void 0,void 0,NDS.TextureLoadingManager.onError),r.bumpMap.sourceFile=s,r.bumpMap.wrapS=THREE.RepeatWrapping,r.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpScale&&(r.bumpScale=parseFloat(t.bumpScale)),void 0!==t.reflectivity&&(r.envMapIntensity=parseFloat(t.reflectivity)),void 0!==t.emissiveIntensity&&(r.emissiveIntensity=parseFloat(t.emissiveIntensity)),void 0!==t.envMapIntensity&&(r.envMapIntensity=parseFloat(t.envMapIntensity)),void 0!==t.refractionRatio&&(r.refractionRatio=parseFloat(t.refractionRatio)),void 0!==t.roughness&&(r.roughness=1,this.viewer.reflected&&(r.roughness=.5)),void 0!==t.metalness&&(r.metalness=.3,this.viewer.reflected&&(r.metalness=.5)),void 0===t.roughness&&void 0===t.metalness&&void 0!==t.shininess&&(0==t.shininess?(r.roughness=.8,r.metalness=.5):15<t.shininess&&(r.metalness=.65,r.roughness=.1)),void 0!==t.shading&&(0==t.shading||2==parseInt(t.shading)?r.flatShading=!1:r.flatShading=!0),o.setValues(r),o.polygonOffset=!0,o.polygonOffsetFactor=1,o.polygonOffsetUnits=1),i&&o&&(o.polygonOffset=!0,o.polygonOffsetFactor=1,o.polygonOffsetUnits=1),o},initMaterials:function(e,t,n,i){if(e){null!=n&&(this.viewer.lineTypes&&this.viewer.lineTypes.clearLineType(),this.viewer.lineTypes=new L(this.viewer),this.viewer.lineTypes.createLineStyle(n,i));for(var r=!1,o=0;o<e.length;++o)if(void 0!==(a=e[o]).type&&"LineBasicMaterial"===a.type){r=!0;break}for(var a,s=[],l={},o=0;o<e.length;++o){(a=e[o]).jsonUrl&&(t=this.extractUrlBase(a.jsonUrl));var d=this.createMaterialForBIM(l,a,t,r);36===a.uuid.length&&(a.uuid=a.uuid.slice(0,8)+a.uuid.slice(9,13)+a.uuid.slice(14,18)+a.uuid.slice(19,23)+a.uuid.slice(24,36)),s[a.uuid]={mat:d,refCount:0}}return s}},needsTangents:function(e){for(var t=0,n=e.length;t<n;t++)if(e[t]instanceof THREE.ShaderMaterial)return!0;return!1},createMaterial:function(e,c){var h=this;function u(e){e=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(e))}function t(e,t,n,i,r,o,a){var s,l=c+n,d=THREE.Loader.Handlers.get(l);null!==d?s=d.load(l):(s=new THREE.Texture,(d=h.imageLoader).crossOrigin=h.crossOrigin,d.load(l,function(e){var t,n,i;!1===THREE.Math.isPowerOfTwo(e.width)||!1===THREE.Math.isPowerOfTwo(e.height)?(t=u(e.width),n=u(e.height),(i=document.createElement("canvas")).width=t,i.height=n,i.getContext("2d").drawImage(e,0,0,t,n),s.image=i):s.image=e,s.needsUpdate=!0})),s.sourceFile=n,i&&(s.repeat.set(i[0],i[1]),1!==i[0]&&(s.wrapS=THREE.RepeatWrapping),1!==i[1]&&(s.wrapT=THREE.RepeatWrapping)),r&&s.offset.set(r[0],r[1]),o&&(void 0!==(r={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping})[o[0]]&&(s.wrapS=r[o[0]]),void 0!==r[o[1]]&&(s.wrapT=r[o[1]])),a&&(s.anisotropy=a),e[t]=s}function n(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}var i,r,o="MeshLambertMaterial",a={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};return e.shading&&("phong"===(i=e.shading.toLowerCase())?o="MeshPhongMaterial":"basic"===i&&(o="MeshBasicMaterial")),void 0!==e.blending&&void 0!==THREE[e.blending]&&(a.blending=THREE[e.blending]),(void 0!==e.transparent||e.opacity<1)&&(a.transparent=e.transparent),void 0!==e.depthTest&&(a.depthTest=e.depthTest),void 0!==e.depthWrite&&(a.depthWrite=e.depthWrite),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.flipSided&&(a.side=THREE.BackSide),void 0!==e.doubleSided&&(a.side=THREE.DoubleSide),void 0!==e.wireframe&&(a.wireframe=e.wireframe),void 0!==e.vertexColors&&("face"===e.vertexColors?a.vertexColors=THREE.FaceColors:e.vertexColors&&(a.vertexColors=THREE.VertexColors)),e.colorDiffuse?a.color=n(e.colorDiffuse):e.DbgColor&&(a.color=e.DbgColor),e.colorSpecular&&(a.specular=n(e.colorSpecular)),e.colorAmbient&&(a.ambient=n(e.colorAmbient)),e.colorEmissive&&(a.emissive=n(e.colorEmissive)),e.transparency&&(a.opacity=e.transparency),e.specularCoef&&(a.shininess=e.specularCoef),e.mapDiffuse&&c&&t(a,"map",e.mapDiffuse,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy),e.mapLight&&c&&t(a,"lightMap",e.mapLight,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy),e.mapBump&&c&&t(a,"bumpMap",e.mapBump,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy),e.mapNormal&&c&&t(a,"normalMap",e.mapNormal,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy),e.mapSpecular&&c&&t(a,"specularMap",e.mapSpecular,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy),e.mapAlpha&&c&&t(a,"alphaMap",e.mapAlpha,e.mapAlphaRepeat,e.mapAlphaOffset,e.mapAlphaWrap,e.mapAlphaAnisotropy),e.mapBumpScale&&(a.bumpScale=e.mapBumpScale),e.mapNormal?(i=THREE.ShaderLib.normalmap,(r=THREE.UniformsUtils.clone(i.uniforms)).tNormal.value=a.normalMap,e.mapNormalFactor&&r.uNormalScale.value.set(e.mapNormalFactor,e.mapNormalFactor),a.map&&(r.tDiffuse.value=a.map,r.enableDiffuse.value=!0),a.specularMap&&(r.tSpecular.value=a.specularMap,r.enableSpecular.value=!0),a.lightMap&&(r.tAO.value=a.lightMap,r.enableAO.value=!0),r.diffuse.value.setHex(a.color),r.specular.value.setHex(a.specular),r.ambient.value.setHex(a.ambient),r.shininess.value=a.shininess,void 0!==a.opacity&&(r.opacity.value=a.opacity),r={fragmentShader:i.fragmentShader,vertexShader:i.vertexShader,uniforms:r,lights:!0,fog:!0},r=new THREE.ShaderMaterial(r),a.transparent&&(r.transparent=!0)):r=new THREE[o](a),void 0!==e.DbgName&&(r.name=e.DbgName),r}},D.ensurePowerOfTwo_=function(e){if(THREE.Math.isPowerOfTwo(e.width)&&THREE.Math.isPowerOfTwo(e.height))return e;var t=document.createElement("canvas");return t.width=D.nextHighestPowerOfTwo_(e.width),t.height=D.nextHighestPowerOfTwo_(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t},D.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1};var se=function(e,t,n){D.call(this,e,t,n),this.withCredentials=!1};se.prototype=Object.create(D.prototype),se.prototype.load=function(e,t,n){n=n&&"string"==typeof n?n:this.extractUrlBase(e),this.onLoadStart(),this.loadAjaxJSON(this,e,t,n)},se.prototype.loadAjaxJSON=function(t,n,i,r,o){var a=new XMLHttpRequest,s=0;a.onreadystatechange=function(){if(a.readyState===a.DONE)if(200===a.status||0===a.status){if(a.responseText){var e=JSON.parse(a.responseText);if(void 0!==e.metadata&&"scene"===e.metadata.type)return void console.error('THREE.JSONLoader: "'+n+'" seems to be a Scene. Use THREE.SceneLoader instead.');e=t.parse(e,r);i(e.geometry,e.materials)}else console.error('THREE.JSONLoader: "'+n+'" seems to be unreachable or the file is empty.');t.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load \""+n+'" ('+a.status+")");else a.readyState===a.LOADING?o&&(0===s&&(s=a.getResponseHeader("Content-Length")),o({total:s,loaded:a.responseText.length})):a.readyState===a.HEADERS_RECEIVED&&void 0!==o&&(s=a.getResponseHeader("Content-Length"))},a.open("GET",n,!0),a.withCredentials=this.withCredentials,a.send(null)},se.prototype.parse=function(B,e){var L=new THREE.Geometry,t=void 0!==B.scale?1/B.scale:1;if(!function(e){var t,n,i,r,o,a,s,l,d,c,h,u,f,p,m,g,v,y,E,b,M,x,w,I,S,T,A=B.faces,R=B.vertices,O=B.normals,P=B.colors,C=0;if(void 0!==B.uvs){for(t=0;t<B.uvs.length;t++)B.uvs[t].length&&C++;for(t=0;t<C;t++)L.faceVertexUvs[t]=[]}r=0,o=R.length;for(;r<o;)(v=new THREE.Vector3).x=R[r++]*e,v.y=R[r++]*e,v.z=R[r++]*e,L.vertices.push(v);r=0,o=A.length;for(;r<o;)if(c=A[r++],h=c&2,u=c&8,f=c&16,p=c&32,m=c&64,g=c&128,c&1){if((E=new THREE.Face3).a=A[r],E.b=A[r+1],E.c=A[r+3],(b=new THREE.Face3).a=A[r+1],b.b=A[r+2],b.c=A[r+3],r+=4,h&&(d=A[r++],E.materialIndex=d,b.materialIndex=d),i=L.faces.length,u)for(t=0;t<C;t++)for(w=B.uvs[t],L.faceVertexUvs[t][i]=[],L.faceVertexUvs[t][i+1]=[],n=0;n<4;n++)l=A[r++],S=w[2*l],T=w[2*l+1],I=new THREE.Vector2(S,T),2!==n&&L.faceVertexUvs[t][i].push(I),0!==n&&L.faceVertexUvs[t][i+1].push(I);if(f&&(s=3*A[r++],E.normal.set(O[s++],O[s++],O[s]),b.normal.copy(E.normal)),p)for(t=0;t<4;t++)s=3*A[r++],x=new THREE.Vector3(O[s++],O[s++],O[s]),2!==t&&E.vertexNormals.push(x),0!==t&&b.vertexNormals.push(x);if(m&&(a=A[r++],M=P[a],E.color.setHex(M),b.color.setHex(M)),g)for(t=0;t<4;t++)a=A[r++],M=P[a],2!==t&&E.vertexColors.push(new THREE.Color(M)),0!==t&&b.vertexColors.push(new THREE.Color(M));L.faces.push(E),L.faces.push(b)}else{if((y=new THREE.Face3).a=A[r++],y.b=A[r++],y.c=A[r++],h&&(d=A[r++],y.materialIndex=d),i=L.faces.length,u)for(t=0;t<C;t++)for(w=B.uvs[t],L.faceVertexUvs[t][i]=[],n=0;n<3;n++)l=A[r++],S=w[2*l],T=w[2*l+1],I=new THREE.Vector2(S,T),L.faceVertexUvs[t][i].push(I);if(f&&(s=3*A[r++],y.normal.set(O[s++],O[s++],O[s])),p)for(t=0;t<3;t++)s=3*A[r++],x=new THREE.Vector3(O[s++],O[s++],O[s]),y.vertexNormals.push(x);if(m&&(a=A[r++],y.color.setHex(P[a])),g)for(t=0;t<3;t++)a=A[r++],y.vertexColors.push(new THREE.Color(P[a]));L.faces.push(y)}}(t),function(){var e=void 0!==B.influencesPerVertex?B.influencesPerVertex:2;if(B.skinWeights)for(var t=0,n=B.skinWeights.length;t<n;t+=e){var i=B.skinWeights[t],r=1<e?B.skinWeights[t+1]:0,o=2<e?B.skinWeights[t+2]:0,a=3<e?B.skinWeights[t+3]:0;L.skinWeights.push(new THREE.Vector4(i,r,o,a))}if(B.skinIndices)for(t=0,n=B.skinIndices.length;t<n;t+=e){var s=B.skinIndices[t],l=1<e?B.skinIndices[t+1]:0,d=2<e?B.skinIndices[t+2]:0,c=3<e?B.skinIndices[t+3]:0;L.skinIndices.push(new THREE.Vector4(s,l,d,c))}L.bones=B.bones,L.bones&&0<L.bones.length&&(L.skinWeights.length!==L.skinIndices.length||L.skinIndices.length!==L.vertices.length)&&console.warn("When skinning, number of vertices ("+L.vertices.length+"), skinIndices ("+L.skinIndices.length+"), and skinWeights ("+L.skinWeights.length+") should match.");L.animation=B.animation,L.animations=B.animations}(),function(e){var t,n,i,r,o,a,s,l,d,c,h;if(void 0!==B.morphTargets)for(o=0,a=B.morphTargets.length;o<a;o++)for(L.morphTargets[o]={},L.morphTargets[o].name=B.morphTargets[o].name,L.morphTargets[o].vertices=[],i=L.morphTargets[o].vertices,r=B.morphTargets[o].vertices,t=0,n=r.length;t<n;t+=3){var u=new THREE.Vector3;u.x=r[t]*e,u.y=r[t+1]*e,u.z=r[t+2]*e,i.push(u)}if(void 0!==B.morphColors)for(o=0,a=B.morphColors.length;o<a;o++)for(L.morphColors[o]={},L.morphColors[o].name=B.morphColors[o].name,L.morphColors[o].colors=[],d=L.morphColors[o].colors,c=B.morphColors[o].colors,s=0,l=c.length;s<l;s+=3)(h=new THREE.Color(16755200)).setRGB(c[s],c[s+1],c[s+2]),d.push(h)}(t),L.computeFaceNormals(),L.computeBoundingBox(),void 0===B.materials||0===B.materials.length)return{geometry:L};e=this.initMaterials(B.materials,e,B.lineType);return this.needsTangents(e)&&L.computeTangents(),{geometry:L,materials:e}};var He=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager};He.prototype={constructor:He,load:function(e,t,n,i,r,o){var a=this,s="?time=";0<t.indexOf("?")&&(s="&time="),null!=o?0==o&&(t=t+s+Date.now()):Ue.avoidCaching&&(t=t+s+Date.now());var l=new XMLHttpRequest;if(l.open("GET",t,!0),e)for(var d in e)l.setRequestHeader(d,e[d]);l.addEventListener("load",function(e){n&&n(this.response,a.attribute),a.manager.itemEnd(t)},!1),void 0!==i&&l.addEventListener("progress",function(e){i(e)},!1),void 0!==r&&l.addEventListener("error",function(e){r(e)},!1),void 0!==this.crossOrigin&&(l.crossOrigin=this.crossOrigin),void 0!==this.responseType&&(l.responseType=this.responseType),null!=this.timeout&&(l.timeout=this.timeout),l.send(null),a.manager.itemStart(t)},setResponseType:function(e){this.responseType=e},setCrossOrigin:function(e){this.crossOrigin=e},setTimeout:function(e){this.timeout=e}};n(147);function H(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Ne=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.viewer=e,this.type=2,this.version=0;var S=this;this.mesh2geom=null;var T=!(this.brepInfos={}),E={},i=[],r=[],o=new Map;this.addBrepFileUrl=function(e){i.push(e),r.push(!1)},this.bindReference=function(e,t){o.set(e,t)},this.tojson=function(e){var t=e.readByte();this.version=t;for(var n=e.readInt32(),i={},r=0,r=0;r<n;++r){var o={},a=e.readGuid();if(3<this.version)if(e.readByte()){o.referenceBodyUuid=e.readGuid(),i[a]=o;continue}o.area=e.readFloat32(),o.volume=e.readFloat32();var s=e.readInt32();o.edgeGroups=[],i[a]=o;for(var l=0;l<s;++l){var d={};o.edgeGroups.push(d),d.meshID=e.readGuid(),d.edges=[];for(var c=2<t?e.readInt32():e.readInt16(),h=0;h<c;++h){var u={};d.edges.push(u);var f=e.readByte();0==f?(u.type="circle",u.center=[],u.center[0]=e.readFloat32(),u.center[1]=e.readFloat32(),u.center[2]=e.readFloat32(),u.radius=e.readFloat32()):1==f?u.type="line":2==f?u.type="ellipse":3==f?u.type="nurbs":4==f&&(u.type="other"),u.id=e.readInt32(),u.indexRange=[],u.indexRange[0]=e.readInt32(),u.indexRange[1]=e.readInt32(),u.length=e.readFloat32()}}var p=e.readInt32();o.faceGroups=[];for(var m=0;m<p;++m){var g={};o.faceGroups.push(g),g.meshID=e.readGuid(),g.faces=[];for(var v=2<t?e.readInt32():e.readInt16(),y=0;y<v;++y){var E={};g.faces.push(E);var b=e.readByte();if(0==b?(E.type="plane",E.origin=[],E.origin[0]=e.readFloat32(),E.origin[1]=e.readFloat32(),E.origin[2]=e.readFloat32(),E.normal=[],E.normal[0]=e.readFloat32(),E.normal[1]=e.readFloat32(),E.normal[2]=e.readFloat32()):1==b?(E.type="cylinder",E.origin=[],E.origin[0]=e.readFloat32(),E.origin[1]=e.readFloat32(),E.origin[2]=e.readFloat32(),E.axis=[],E.axis[0]=e.readFloat32(),E.axis[1]=e.readFloat32(),E.axis[2]=e.readFloat32(),E.radius=e.readFloat32()):2==b?(E.type="cone",4<this.version&&(E.origin=[],E.origin[0]=e.readFloat32(),E.origin[1]=e.readFloat32(),E.origin[2]=e.readFloat32(),E.axis=[],E.axis[0]=e.readFloat32(),E.axis[1]=e.readFloat32(),E.axis[2]=e.readFloat32(),E.radius=e.readFloat32())):3==b?E.type="sphere":4==b?E.type="torus":5==b?E.type="nurbs":6==b&&(E.type="other"),E.id=e.readInt32(),E.indexRange=[],E.indexRange[0]=e.readInt32(),E.indexRange[1]=e.readInt32(),E.area=e.readFloat32(),this.version<4&&(E.perimeter=e.readFloat32()),1<t){var M=2<t?e.readInt32():e.readInt16();E.edgeIDS=[];for(var x,w=0;w<M;++w)this.version<4?E.edgeIDS[w]=e.readInt32():(x={perimeter:e.readFloat32(),startID:e.readInt32()},E.edgeIDS[w]=x)}this.version<4&&(0<(b=e.readGuid()).length&&(E.materialID=b),E.thick=e.readFloat32())}}var I=e.readInt32(),S=[];I&&(o.vertices=S);for(var T=0;T<I;++T){var A={};S.push(A),A.id=e.readInt32(),A.coords=[],A.coords[0]=e.readFloat32(),A.coords[1]=e.readFloat32(),A.coords[2]=e.readFloat32()}}return i},this.loadBreps=function(s,l){if(!(r.length<1)){for(var d=0,e=0;e<r.length;e++)0==r[e]&&d++;if(!(d<1)){var t=new He(new THREE.LoadingManager);t.setCrossOrigin("anonymous"),t.setResponseType("arraybuffer"),t.setTimeout(4e4);var n=function(){console.log("load brep error"),--d<1&&S.viewer.exitWaitProcedure()};!0===s&&S.viewer.startWaitProcedure();for(e=0;e<r.length;e++)0==r[e]&&(r[e]=!0,t.load(null,i[e],function(e){var t=new Worker(Ue.BreploadWorkerUrl);t.onmessage=function(e){if("error"===e.data)return console.log("brep file is not exist or not supported format"),void(!0===s&&--d<1&&S.viewer.exitWaitProcedure());if("failed"!==e.data){var t;0==S.type?Object.assign(S.brepInfos,e.data):(console.log(e.data[0]),6<=e.data[0]?(t=new ke.Stream(e.data),Object.assign(S.brepInfos,S.parseBreps(t))):(S.type=1,t=new ke.Stream(e.data),Object.assign(S.brepInfos,S.tojson(t)))),T=!0,l&&l();var n,i=!1,r=!1,o=!1,a=2===S.type?S.brepInfos.breps:S.brepInfos;for(n in a)if(1e-9<a[n].volume&&(i=!0),1e-9<a[n].area&&(r=!0),a[n].faceGroups&&0<a[n].faceGroups.length&&(o=!0),1==r&&1==i&&1==o)break;S.viewer.brepInfo.BfaceArea=o,S.viewer.brepInfo.BbodyVolume=i,S.viewer.brepInfo.BbodyArea=!!i&&r,S.viewer.brepInfo.BtotalArea=r,S.viewer.brepInfo.BfacePerimeter=!!(o&&1<S.version),S.viewer.dispatchBrepEvent(),Ue.enableBroadcast&&S.viewer.broadcastManager.broadcastInfo&&S.viewer.broadcastManager.setBroadcastInfo(S.viewer.broadcastManager.broadcastInfo),!0===s&&--d<1&&S.viewer.exitWaitProcedure()}else!0===s&&--d<1&&S.viewer.exitWaitProcedure()},t.postMessage([e,S.type])},void 0,n,!0))}}};this.GetBodyVolumeAndArea=function(e){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?function(e){if(S.brepInfos.bodies.has(e)){e=S.brepInfos.breps[S.brepInfos.bodies.get(e)];return{volume:e.volume,area:e.area}}return null}:function(e){e=S.brepInfos[e];return(e=e&&e.referenceBodyUuid?S.brepInfos[e.referenceBodyUuid]:e)&&null!=e.volume?{volume:parseFloat(e.volume),area:parseFloat(e.area)}:null})(e)}};function n(e,i){function t(e){for(var t=0,n=e.length;t<n;++t)if(e[t]===i)return 1}if(S.viewer.ndsModel&&S.brepInfos.bodies.has(e)){for(var n,r=S.brepInfos.breps[S.brepInfos.bodies.get(e)],o=0,a=r.edgeGroups.length;o<a;++o){var s=S.brepInfos.edgeGroups[r.edgeGroups[o]];!(n=!(n=!(n=!(n=s.lines&&t(s.lines.ids)?s.geomUUID:n)&&s.circles&&t(s.circles.ids)?s.geomUUID:n)&&s.ellipses&&t(s.ellipses.ids)?s.geomUUID:n)&&s.nurbses&&t(s.nurbses.ids)?s.geomUUID:n)&&s.others&&t(s.others.ids)&&(n=s.geomUUID)}if(n){e=S.viewer.ndsModel.getBodyNodeFromUuid(e);if(e)return S.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(e,n)}}return null}this.GetEdegMeshIDfromID=function(e,t){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?n:function(e,t){if(1!==S.type)return null;var n=S.brepInfos[e];n&&n.referenceBodyUuid&&(n=S.brepInfos[n.referenceBodyUuid]);for(var i=0;i<n.edgeGroups.length;++i)for(var r=n.edgeGroups[i],o=r.meshID,a=0;a<r.edges.length;++a)if(r.edges[a].id==t)return o;return null})(e,t)}},this.GetBrepInfoByUUidAndTopolIndex=function(e,t,n,i){if(!0===T)return i?(i.toLowerCase(),("edge"===i?u:d)(e,t,n)):d(e,t,n)||u(e,t,n)};function A(e,t,n){function i(e,t,n,i){e.id=t,e.geomUUID=i.geomUUID,e.indexRange=[n.triIndexRanges[2*t],n.triIndexRanges[2*t+1]],e.area=n.areas[t];var r=n.loops[2*t],o=n.loops[2*t+1];e.edgeIDS=[];for(var a=0;a<o;++a)e.edgeIDS[a]={perimeter:i.loopPerimeters[r+a],startID:i.loopStartEdgeId[r+a]}}var r;return"plane"===t?i(r={type:"plane",origin:[e.planes.origins[3*n],e.planes.origins[3*n+1],e.planes.origins[3*n+2]],normal:[e.planes.normals[3*n],e.planes.normals[3*n+1],e.planes.normals[3*n+2]]},n,e.planes,e):"cylinder"===t?i(r={type:"cylinder",origin:[e.cylinders.origins[3*n],e.cylinders.origins[3*n+1],e.cylinders.origins[3*n+2]],axis:[e.cylinders.axis[3*n],e.cylinders.axis[3*n+1],e.cylinders.axis[3*n+2]],radius:e.cylinders.radiuses[n]},n,e.cylinders,e):"cone"===t?i(r={type:"cone",origin:[e.cones.origins[3*n],e.cones.origins[3*n+1],e.cones.origins[3*n+2]],axis:[e.cones.axis[3*n],e.cones.axis[3*n+1],e.cones.axis[3*n+2]],radius:e.cones.radiuses[n]},n,e.cones,e):"sphere"===t?i(r={type:"sphere"},n,e.spheres,e):"torus"===t?i(r={type:"torus"},n,e.toruses,e):"nurbs"===t?i(r={type:"nurbs"},n,e.nurbses,e):"other"===t&&i(r={type:"other"},n,e.others,e),r}function R(e,t,n){var i;return"line"===t?i={id:e.lines.ids[n],geomUUID:e.geomUUID,indexRange:[e.lines.indexRanges[2*n],e.lines.indexRanges[2*n+1]],length:e.lines.lengthes[n],type:"line"}:"circle"===t?i={id:e.circles.ids[n],geomUUID:e.geomUUID,indexRange:[e.circles.indexRanges[2*n],e.circles.indexRanges[2*n+1]],length:e.circles.lengthes[n],center:[e.circles.centers[3*n],e.circles.centers[3*n+1],e.circles.centers[3*n+2]],radius:e.circles.radiuses[n],type:"circle"}:"ellipse"===t?i={id:e.ellipses.ids[n],geomUUID:e.geomUUID,indexRange:[e.ellipses.indexRanges[2*n],e.ellipses.indexRanges[2*n+1]],length:e.ellipses.lengthes[n],type:"ellipse"}:"nurbs"===t?i={id:e.nurbses.ids[n],geomUUID:e.geomUUID,indexRange:[e.nurbses.indexRanges[2*n],e.nurbses.indexRanges[2*n+1]],length:e.nurbses.lengthes[n],type:"nurbs"}:"other"===t&&(i={id:e.others.ids[n],geomUUID:e.geomUUID,indexRange:[e.others.indexRanges[2*n],e.others.indexRanges[2*n+1]],length:e.others.lengthes[n],type:"other"}),i}function a(e,i,t){if(!0!==T)return null;if(!S.brepInfos.bodies.has(e))return null;function n(e){for(var t=0,n=e.length;t<n;t++)if(e[t]==i)return t;return-1}var r=S.brepInfos.breps[S.brepInfos.bodies.get(e)];if(t.toLowerCase(),"face"===t&&r.faceGroups)for(var o=0,a=r.faceGroups.length;o<a;o++){var s=S.brepInfos.faceGroups[r.faceGroups[o]],l=!1,d=null;if(s.planes){var c,h,u,f=n(s.planes.ids);if(-1<f&&(l=!0,d=A(s,"plane",f)),l||!s.cylinders||-1<(c=n(s.cylinders.ids))&&(l=!0,d=A(s,"cylinder",c)),l||!s.cones||-1<(c=n(s.cones.ids))&&(l=!0,d=A(s,"cone",c)),l||!s.spheres||-1<(h=n(s.spheres.ids))&&(l=!0,d=A(s,"sphere",h)),l||!s.toruses||-1<(h=n(s.toruses.ids))&&(l=!0,d=A(s,"torus",h)),l||!s.nurbses||-1<(u=n(s.nurbses.ids))&&(l=!0,d=A(s,"nurbs",u)),l||!s.others||-1<(u=n(s.others.ids))&&(l=!0,d=A(s,"other",u)),l&&S.viewer.ndsModel){var p=s.geomUUID;if(M=S.viewer.ndsModel.getBodyNodeFromUuid(e)){s=S.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(M,p);if(-1<s)if(b=S.viewer.ndsModel.meshManager.getSingleMesh(s))return d.parentObj=b,d.bodyId=e,d.meshId=p,d}}}return null}else{if("edge"===t&&r.edgeGroups){for(o=0,a=r.edgeGroups.length;o<a;o++){var m,g,v,y=S.brepInfos.edgeGroups[r.edgeGroups[o]],l=!1,E=null;if(!y.lines||-1<(m=n(y.lines.ids))&&(l=!0,E=R(y,"line",m)),l||!y.circles||-1<(g=n(y.circles.ids))&&(l=!0,E=R(y,"circle",g)),l||!y.ellipses||-1<(g=n(y.ellipses.ids))&&(l=!0,E=R(y,"ellipse",g)),l||!y.nurbses||-1<(v=n(y.nurbses.ids))&&(l=!0,E=R(y,"nurbs",v)),l||!y.others||-1<(v=n(y.others.ids))&&(l=!0,E=R(y,"other",v)),l&&S.viewer.ndsModel){var b,p=y.geomUUID,M=S.viewer.ndsModel.getBodyNodeFromUuid(e);if(M)if(b=S.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(M,p))return E.parentObj=b,E.bodyId=e,E.meshId=p,E}}return null}if("vertex"===t&&r.vertices){for(o=0,a=r.vertices.length;o<a;o++){var x=r.vertices[o];if(i===S.brepInfos.vertices.ids[x]){var w,I=null;S.viewer.ndsModel&&(M=S.viewer.ndsModel.getBodyNodeFromUuid(e),S.viewer.ndsModel.meshManager.getMeshInfor(M.id,w={}),I=w.matrixWorld);x=new THREE.Vector3(S.brepInfos.vertices.coords[3*x+0],S.brepInfos.vertices.coords[3*x+1],S.brepInfos.vertices.coords[3*x+2]);return x.applyMatrix4(I),{id:i,coords:[x.x,x.y,x.z],bodyId:e}}}return null}}}this.GetBrepInfoByBodyUuidAndTopoId=function(e,t,n){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?a:function(e,t,n){if(!0!==T)return null;var i=S.brepInfos[e];if(!i)return null;if(i.referenceBodyUuid&&(i=S.brepInfos[i.referenceBodyUuid]),n.toLowerCase(),"face"===n){for(var r=0,o=i.faceGroups.length;r<o;r++){for(var a=i.faceGroups[r],s=a.faces,l=!1,d=null,c=0,h=s.length;c<h;c++)if(s[c].id==t){l=!0,d=Object.assign({},s[c]);break}if(l){var u=a.meshID;if(S.viewer.ndsModel){var f=S.viewer.ndsModel.meshUuid2GeomUuidMap[u];if(y=S.viewer.ndsModel.getBodyNodeFromUuid(e)){a=S.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(y,f);if(-1<a)if(v=S.viewer.ndsModel.meshManager.getSingleMesh(a))return d.parentObj=v,d.bodyId=e,d.meshId=f,d}}else if(v=S.viewer.getObjectByUUID(u))return d.parentObj=v,d.bodyId=e,d.meshId=u,d}}return null}if("edge"===n){for(r=0,o=i.edgeGroups.length;r<o;r++){for(var p=i.edgeGroups[r],m=p.edges,l=!1,g=null,c=0,h=m.length;c<h;c++)if(m[c].id==t){l=!0,g=Object.assign({},m[c]);break}if(l){u=p.meshID;if(S.viewer.ndsModel){var v,f=S.viewer.ndsModel.meshUuid2GeomUuidMap[u],y=S.viewer.ndsModel.getBodyNodeFromUuid(e);if(y)if(v=S.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(y,f))return g.parentObj=v,g.bodyId=e,g.meshId=f,g}else if(v=S.viewer.getObjectByUUID(u))return g.parentObj=v,g.bodyId=e,g.meshId=u,g}}return null}if("vertex"===n){for(r=0,o=i.vertices.length;r<o;r++)if(t===i.vertices[r].id){var E=null;E=S.viewer.ndsModel?(y=S.viewer.ndsModel.getBodyNodeFromUuid(e),S.viewer.ndsModel.meshManager.getMeshInfor(y.id,b={}),b.matrixWorld):S.viewer.getObjectByUUID(e).matrixWorld;var b=new THREE.Vector3(i.vertices[r].coords[0],i.vertices[r].coords[1],i.vertices[r].coords[2]);return b.applyMatrix4(E),{id:i.vertices[r].id,coords:[b.x,b.y,b.z],bodyId:e}}return null}})(e,t,n)}},this.hasBrepInfo=function(){return T},this.hasBrepFile=function(){return 0<i.length},this.parse=function(e){e&&e.length};this.GetEdgesExtremePointsByBodyUUID=function(e){if(e&&1==T){var t=o.has(e)?o.get(e):e;return 2===S.type?function(e,t){if(!e||1!=T)return null;if(E[t])return E[t];if(!S.brepInfos.bodies.has(e))return null;var n=S.brepInfos.breps[S.brepInfos.bodies.get(e)];if(!n.edgeGroups)return null;for(var g=[],i=function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},r=[];Array.isArray(t)?r=t:r[0]=t;for(var o=0,a=r.length;o<a;++o){var s=r[o],l=s.geometry;if(!l||!l.isBufferGeometry||!l.index)return;for(var d=l.attributes.position.array,c=0,h=e.length/2;c<h;c++){var u=[e[2*c],e[2*c+1]];S.viewer.ndsModel&&(u[0]+=l.drawRange.start/2,u[1]+=l.drawRange.start/2);var f=l.index.array,p=new THREE.Vector3,m=new THREE.Vector3;p.fromArray(d,3*f[2*u[0]]),m.fromArray(d,3*f[2*u[1]+1]),p.applyMatrix4(s.matrixWorld),m.applyMatrix4(s.matrixWorld),"circle"===n&&g.push(new THREE.Vector3(i.centers[3*c+0],i.centers[3*c+1],i.centers[3*c+2]).applyMatrix4(s.matrixWorld)),g.push(p),g.push(m)}}},r=0,o=n.edgeGroups.length;r<o;r++){var a=S.brepInfos.edgeGroups[n.edgeGroups[r]];if(S.viewer.ndsModel){var s=S.viewer.ndsModel.getBodyNodeFromUuid(t);if(!s)continue;s=S.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(s,a.geomUUID)}s&&(a.lines&&i(a.lines.indexRanges,s,"line"),a.circles&&i(a.circles.indexRanges,s,"circle",{centers:a.circles.centers}),a.ellipses&&i(a.ellipses.indexRanges,s,"ellipse"),a.nurbses&&i(a.nurbses.indexRanges,s,"nurbs"),a.others&&i(a.others.indexRanges,s,"other"))}return E[t]=g}(t,e):function(e){if(e&&1==T){if(E[e])return E[e];var t=S.brepInfos[e];if((t=t&&(t.referenceBodyUuid?S.brepInfos[t.referenceBodyUuid]:t))&&t.edgeGroups){for(var n=[],i=0,r=t.edgeGroups.length;i<r;i++){var o=t.edgeGroups[i];if(o){var a=o.edges;if(a){var s,l,d=o.meshID;if(S.viewer.ndsModel){d=S.viewer.ndsModel.meshUuid2GeomUuidMap[d],o=S.viewer.ndsModel.getBodyNodeFromUuid(e);if(!o)continue;s=S.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(o,d)}else s=S.viewer.selectionManager.getLineObjectFromUUid(d);if(s&&(l=s.geometry)&&l.isBufferGeometry){var c=l.index;if(null!=c)for(var h=l.attributes.position.array,u=0,f=a.length;u<f;u++){var p=a[u],m=p.indexRange.concat();S.viewer.ndsModel&&(m[0]+=l.drawRange.start/2,m[1]+=l.drawRange.start/2);var g=c.array,v=new THREE.Vector3,y=new THREE.Vector3;v.fromArray(h,3*g[2*m[0]]),y.fromArray(h,3*g[2*m[1]+1]),v.applyMatrix4(s.matrixWorld),y.applyMatrix4(s.matrixWorld),"circle"==p.type&&n.push(new THREE.Vector3(p.center[0],p.center[1],p.center[2]).applyMatrix4(s.matrixWorld)),n.push(v),n.push(y)}}}}}return E[e]=n}}}(t)}};this.GetVerticesByBodyUUID=function(e){if(e&&1==T){e=o.has(e)?o.get(e):e;return 2===S.type?null:function(e){e=S.brepInfos[e];return(e=e&&(e.referenceBodyUuid?S.brepInfos[e.referenceBodyUuid]:e))&&e.vertices?e.vertices:null}(e)}};this.GetEdgeInfoFromFace=function(e,t){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?function(e,t){if(e&&t&&S.brepInfos.bodies.has(e)){var n=S.brepInfos.breps[S.brepInfos.bodies.get(e)];if(n.faceGroups){var o="Array"===t.constructor.name?t.slice():[t],a=[];if(S.viewer.ndsModel.getBodyNodeFromUuid(e)){for(var i=function(e,t,n){for(var i=0,r=e.ids.length;i<r&&(-1===o.indexOf(e.ids[i])||(a.push(R(n,t,i)),o.splice(o.indexOf(e.ids[i]),1),0!=o.length));++i);},r=0,s=n.edgeGroups.length;r<s;r++){var l=S.brepInfos.edgeGroups[n.edgeGroups[r]],d=l.geomUUID;if(l.lines&&i(l.lines,"line",l),l.circles&&i(l.circles,"circle",l),l.ellipses&&i(l.ellipses,"ellipse",l),l.nurbses&&i(l.nurbses,"nurbs",l),l.others&&i(l.others,"other",l),0==o.length)break}return{array:a,meshID:-1,geomUUID:d}}}}}:function(e,t){if(e&&t){var n=S.brepInfos[e];if((n=n&&(n.referenceBodyUuid?S.brepInfos[n.referenceBodyUuid]:n))&&n.faceGroups){for(var i="Array"===t.constructor.name?t.slice():[t],r=[],o=0,a=n.edgeGroups.length;o<a;o++){var s=n.edgeGroups[o],l=s.edges,d=s.meshID;if(l){for(var c=0,h=l.length;c<h;c++){var u=l[c];if(-1!=i.indexOf(u.id)&&(r.push(u),i.splice(i.indexOf(u.id),1),0==i.length))break}if(0==i.length)break}}return{array:r,meshID:d}}}})(e,t)}};var s=function(e,t,n){if(e&&t&&!(n<0)){var i=S.brepInfos[e];if((i=i&&(i.referenceBodyUuid?S.brepInfos[i.referenceBodyUuid]:i))&&i.faceGroups)for(var r=0,o=i.faceGroups.length;r<o;r++){var a=i.faceGroups[r],s=a.meshID;if(t===(s=S.viewer.ndsModel?S.viewer.ndsModel.meshUuid2GeomUuidMap[s]:s)){var l=a.faces;if(l)for(var d=0,c=l.length;d<c;d++){var h=l[d],u=h.indexRange[0],f=h.indexRange[1];if(u<=n&&n<=f)return Object.assign({},h)}}}}},l=function(e,t,o){if(e&&t&&!(o<0)&&S.viewer.ndsModel&&S.brepInfos.bodies.has(e)){var n=S.brepInfos.breps[S.brepInfos.bodies.get(e)];if(n.faceGroups){for(var i=function(e){for(var t=0,n=e.length/2;t<n;++t){var i=e[2*t],r=e[2*t+1];if(i<=o&&o<=r)return t}return-1},r=0,a=n.faceGroups.length;r<a;r++){var s=S.brepInfos.faceGroups[n.faceGroups[r]];if(t===s.geomUUID){var l,d,c,h,u=!1,f=void 0;if(!s.planes||-1<(l=i(s.planes.triIndexRanges))&&(u=!0,f=A(s,"plane",l)),u||!s.cylinders||-1<(d=i(s.cylinders.triIndexRanges))&&(u=!0,f=A(s,"cylinder",d)),u||!s.cones||-1<(d=i(s.cones.triIndexRanges))&&(u=!0,f=A(s,"cone",d)),u||!s.spheres||-1<(c=i(s.spheres.triIndexRanges))&&(u=!0,f=A(s,"sphere",c)),u||!s.toruses||-1<(c=i(s.toruses.triIndexRanges))&&(u=!0,f=A(s,"torus",c)),u||!s.nurbses||-1<(h=i(s.nurbses.triIndexRanges))&&(u=!0,f=A(s,"nurbs",h)),u||!s.others||-1<(h=i(s.others.triIndexRanges))&&(u=!0,f=A(s,"other",h)),u)return f}}return null}}};function d(e,t,n){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?l:s)(e,t,n)}}var c=function(e,t,n){if(e&&t&&!(n<0)){var i=S.brepInfos[e];if((i=i&&(i.referenceBodyUuid?S.brepInfos[i.referenceBodyUuid]:i))&&i.edgeGroups)for(var r=0,o=i.edgeGroups.length;r<o;r++){var a=i.edgeGroups[r],s=a.meshID;if(t===(s=S.viewer.ndsModel?S.viewer.ndsModel.meshUuid2GeomUuidMap[s]:s)){var l=a.edges;if(l)for(var d=0,c=l.length;d<c;d++){var h=l[d],u=h.indexRange[0],f=h.indexRange[1];if(u<=n&&n<=f)return Object.assign({},h)}}}}},h=function(e,t,o){if(e&&t&&!(o<0)&&S.viewer.ndsModel&&S.brepInfos.bodies.has(e)){var n=S.brepInfos.breps[S.brepInfos.bodies.get(e)];if(n.edgeGroups){for(var i=function(e){for(var t=0,n=e.length/2;t<n;++t){var i=e[2*t],r=e[2*t+1];if(i<=o&&o<=r)return t}return-1},r=0,a=n.edgeGroups.length;r<a;r++){var s=S.brepInfos.edgeGroups[n.edgeGroups[r]];if(t===s.geomUUID){var l,d,c,h=!1,u=void 0;if(!s.lines||-1<(l=i(s.lines.indexRanges))&&(h=!0,u=R(s,"line",l)),h||!s.circles||-1<(d=i(s.circles.indexRanges))&&(h=!0,u=R(s,"circle",d)),h||!s.ellipses||-1<(d=i(s.ellipses.indexRanges))&&(h=!0,u=R(s,"ellipse",d)),h||!s.nurbses||-1<(c=i(s.nurbses.indexRanges))&&(h=!0,u=R(s,"nurbs",c)),h||!s.others||-1<(c=i(s.others.indexRanges))&&(h=!0,u=R(s,"other",c)),h)return u}}return null}}};function u(e,t,n){if(e&&1==T){e=o.has(e)?o.get(e):e;return(2===S.type?h:c)(e,t,n)}}}var e,n,i;return e=t,(n=[{key:"parseBreps",value:function(e){var t=e.readByte();this.version=t;for(var n=e.readInt32(),i=new Array(n),r=0;r<n;++r){var o=e.readGuid();i[r]={geomUUID:o};var a=e.readInt32();if(0<a){i[r].lines={ids:new Int32Array(a),indexRanges:new Int32Array(2*a),lengthes:new Float32Array(a)};for(var s=0;s<a;++s)i[r].lines.ids[s]=e.readInt32(),i[r].lines.indexRanges[2*s]=e.readInt32(),i[r].lines.indexRanges[2*s+1]=e.readInt32(),i[r].lines.lengthes[s]=e.readFloat32()}var l=e.readInt32();if(0<l){i[r].circles={ids:new Int32Array(l),indexRanges:new Int32Array(2*l),lengthes:new Float32Array(l),centers:new Float32Array(3*l),radiuses:new Float32Array(l)};for(var d=0;d<l;++d){i[r].circles.ids[d]=e.readInt32(),i[r].circles.indexRanges[2*d]=e.readInt32(),i[r].circles.indexRanges[2*d+1]=e.readInt32(),i[r].circles.lengthes[d]=e.readFloat32();for(var c=0;c<3;++c)i[r].circles.centers[3*d+c]=e.readFloat32();i[r].circles.radiuses[d]=e.readFloat32()}}var h=e.readInt32();if(0<h){i[r].ellipses={ids:new Int32Array(h),indexRanges:new Int32Array(2*h),lengthes:new Float32Array(h)};for(var u=0;u<h;++u)i[r].ellipses.ids[u]=e.readInt32(),i[r].ellipses.indexRanges[2*u]=e.readInt32(),i[r].ellipses.indexRanges[2*u+1]=e.readInt32(),i[r].ellipses.lengthes[u]=e.readFloat32()}var f=e.readInt32();if(0<f){i[r].nurbses={ids:new Int32Array(f),indexRanges:new Int32Array(2*f),lengthes:new Float32Array(f)};for(var p=0;p<f;++p)i[r].nurbses.ids[p]=e.readInt32(),i[r].nurbses.indexRanges[2*p]=e.readInt32(),i[r].nurbses.indexRanges[2*p+1]=e.readInt32(),i[r].nurbses.lengthes[p]=e.readFloat32()}var m=e.readInt32();if(0<m){i[r].others={ids:new Int32Array(m),indexRanges:new Int32Array(2*m),lengthes:new Float32Array(m)};for(var g=0;g<m;++g)i[r].others.ids[g]=e.readInt32(),i[r].others.indexRanges[2*g]=e.readInt32(),i[r].others.indexRanges[2*g+1]=e.readInt32(),i[r].others.lengthes[g]=e.readFloat32()}}this.brepInfos.edgeGroups=i;for(var v=e.readInt32(),y=new Array(v),E=0;E<v;++E){var b=e.readGuid();y[E]={geomUUID:b,loopPerimeters:[],loopStartEdgeId:[]};var M=e.readInt32();if(0<M){y[E].planes={ids:new Int32Array(M),triIndexRanges:new Int32Array(2*M),areas:new(t<7?Float32Array:Float64Array)(M),origins:new Float32Array(3*M),normals:new Float32Array(3*M),loops:new Int32Array(2*M)};for(var x=0;x<M;++x){y[E].planes.ids[x]=e.readInt32(),y[E].planes.triIndexRanges[2*x]=e.readInt32(),y[E].planes.triIndexRanges[2*x+1]=e.readInt32(),y[E].planes.areas[x]=t<7?e.readFloat32():e.readFloat64();for(var w=e.readInt32(),I=y[E].loopPerimeters.length,S=0;S<w;++S)y[E].loopPerimeters[I+S]=e.readFloat32(),y[E].loopStartEdgeId[I+S]=e.readInt32();y[E].planes.loops[2*x]=I,y[E].planes.loops[2*x+1]=w;for(var T=0;T<3;++T)y[E].planes.origins[3*x+T]=e.readFloat32();for(var A=0;A<3;++A)y[E].planes.normals[3*x+A]=e.readFloat32()}}var R=e.readInt32();if(0<R){y[E].cylinders={ids:new Int32Array(R),triIndexRanges:new Int32Array(2*R),areas:new(t<7?Float32Array:Float64Array)(R),loops:new Int32Array(2*R),origins:new Float32Array(3*R),axis:new Float32Array(3*R),radiuses:new Float32Array(R)};for(var O=0;O<R;++O){y[E].cylinders.ids[O]=e.readInt32(),y[E].cylinders.triIndexRanges[2*O]=e.readInt32(),y[E].cylinders.triIndexRanges[2*O+1]=e.readInt32(),y[E].cylinders.areas[O]=t<7?e.readFloat32():e.readFloat64();for(var P=e.readInt32(),C=y[E].loopPerimeters.length,B=0;B<P;++B)y[E].loopPerimeters[C+B]=e.readFloat32(),y[E].loopStartEdgeId[C+B]=e.readInt32();y[E].cylinders.loops[2*O]=C,y[E].cylinders.loops[2*O+1]=P;for(var L=0;L<3;++L)y[E].cylinders.axis[3*O+L]=e.readFloat32();for(var D=0;D<3;++D)y[E].cylinders.origins[3*O+D]=e.readFloat32();y[E].cylinders.radiuses[O]=e.readFloat32()}}var H=e.readInt32();if(0<H){y[E].cones={ids:new Int32Array(H),triIndexRanges:new Int32Array(2*H),areas:new(t<7?Float32Array:Float64Array)(H),loops:new Int32Array(2*H),origins:new Float32Array(3*H),axis:new Float32Array(3*H),radiuses:new Float32Array(H)};for(var N=0;N<H;++N){y[E].cones.ids[N]=e.readInt32(),y[E].cones.triIndexRanges[2*N]=e.readInt32(),y[E].cones.triIndexRanges[2*N+1]=e.readInt32(),y[E].cones.areas[N]=t<7?e.readFloat32():e.readFloat64();for(var F=e.readInt32(),_=y[E].loopPerimeters.length,k=0;k<F;++k)y[E].loopPerimeters[_+k]=e.readFloat32(),y[E].loopStartEdgeId[_+k]=e.readInt32();y[E].cones.loops[2*N]=_,y[E].cones.loops[2*N+1]=F;for(var V=0;V<3;++V)y[E].cones.axis[3*N+V]=e.readFloat32();for(var j=0;j<3;++j)y[E].cones.origins[3*N+j]=e.readFloat32();y[E].cones.radiuses[N]=e.readFloat32()}}var U=e.readInt32();if(0<U){y[E].spheres={ids:new Int32Array(U),triIndexRanges:new Int32Array(2*U),areas:new(t<7?Float32Array:Float64Array)(U),loops:new Int32Array(2*U)};for(var z=0;z<U;++z){y[E].spheres.ids[z]=e.readInt32(),y[E].spheres.triIndexRanges[2*z]=e.readInt32(),y[E].spheres.triIndexRanges[2*z+1]=e.readInt32(),y[E].spheres.areas[z]=t<7?e.readFloat32():e.readFloat64();for(var G=e.readInt32(),W=y[E].loopPerimeters.length,Y=0;Y<G;++Y)y[E].loopPerimeters[W+Y]=e.readFloat32(),y[E].loopStartEdgeId[W+Y]=e.readInt32();y[E].spheres.loops[2*z]=W,y[E].spheres.loops[2*z+1]=G}}var X=e.readInt32();if(0<X){y[E].toruses={ids:new Int32Array(X),triIndexRanges:new Int32Array(2*X),areas:new(t<7?Float32Array:Float64Array)(X),loops:new Int32Array(2*X)};for(var Z=0;Z<X;++Z){y[E].toruses.ids[Z]=e.readInt32(),y[E].toruses.triIndexRanges[2*Z]=e.readInt32(),y[E].toruses.triIndexRanges[2*Z+1]=e.readInt32(),y[E].toruses.areas[Z]=t<7?e.readFloat32():e.readFloat64();for(var q=e.readInt32(),Q=y[E].loopPerimeters.length,J=0;J<q;++J)y[E].loopPerimeters[Q+J]=e.readFloat32(),y[E].loopStartEdgeId[Q+J]=e.readInt32();y[E].toruses.loops[2*Z]=Q,y[E].toruses.loops[2*Z+1]=q}}var K=e.readInt32();if(0<K){y[E].nurbses={ids:new Int32Array(K),triIndexRanges:new Int32Array(2*K),areas:new(t<7?Float32Array:Float64Array)(K),loops:new Int32Array(2*K)};for(var $=0;$<K;++$){y[E].nurbses.ids[$]=e.readInt32(),y[E].nurbses.triIndexRanges[2*$]=e.readInt32(),y[E].nurbses.triIndexRanges[2*$+1]=e.readInt32(),y[E].nurbses.areas[$]=t<7?e.readFloat32():e.readFloat64();for(var ee=e.readInt32(),te=y[E].loopPerimeters.length,ne=0;ne<ee;++ne)y[E].loopPerimeters[te+ne]=e.readFloat32(),y[E].loopStartEdgeId[te+ne]=e.readInt32();y[E].nurbses.loops[2*$]=te,y[E].nurbses.loops[2*$+1]=ee}}var ie=e.readInt32();if(0<ie){y[E].others={ids:new Int32Array(ie),triIndexRanges:new Int32Array(2*ie),areas:new(t<7?Float32Array:Float64Array)(ie),loops:new Int32Array(2*ie)};for(var re=0;re<ie;++re){y[E].others.ids[re]=e.readInt32(),y[E].others.triIndexRanges[2*re]=e.readInt32(),y[E].others.triIndexRanges[2*re+1]=e.readInt32(),y[E].others.areas[re]=t<7?e.readFloat32():e.readFloat64();for(var oe=e.readInt32(),ae=y[E].loopPerimeters.length,se=0;se<oe;++se)y[E].loopPerimeters[ae+se]=e.readFloat32(),y[E].loopStartEdgeId[ae+se]=e.readInt32();y[E].others.loops[2*re]=ae,y[E].others.loops[2*re+1]=oe}}}this.brepInfos.faceGroups=y;for(var le=e.readInt32(),de=new Uint32Array(le),ce=new Float32Array(3*le),he=0;he<le;++he){de[he]=e.readInt32();for(var ue=0;ue<3;++ue)ce[3*he+ue]=e.readFloat32()}this.brepInfos.vertices={ids:de,coords:ce};for(var fe=e.readInt32(),pe=new Array(fe),me=0;me<fe;++me){pe[me]={},pe[me].area=t<7?e.readFloat32():e.readFloat64(),pe[me].volume=t<7?e.readFloat32():e.readFloat64();var ge=e.readInt32();if(0<ge){pe[me].edgeGroups=new Int32Array(ge);for(var ve=0;ve<ge;++ve)pe[me].edgeGroups[ve]=e.readInt32()}var ye=e.readInt32();if(0<ye){pe[me].faceGroups=new Int32Array(ye);for(var Ee=0;Ee<ye;++Ee)pe[me].faceGroups[Ee]=e.readInt32()}var be=e.readInt32();if(0<be){pe[me].vertices=new Int32Array(be);for(var Me=0;Me<be;++Me)pe[me].vertices[Me]=e.readInt32()}}this.brepInfos.breps=pe;for(var xe=e.readInt32(),we=new Map,Ie=0;Ie<xe;++Ie){var Se=e.readGuid(),Te=e.readInt32();we.set(Se,Te)}this.brepInfos.bodies=we}}])&&H(e.prototype,n),i&&H(e,i),t}(),le=function(e){var c=this;this.viewer=e;var a={},n=[],i=null,d=new THREE.TextureLoader(new THREE.LoadingManager);d.crossOrigin="anonymous";var h=new w;h.crossOrigin="anonymous";var u=null,o=!1,r=0;function s(e){var t,n=[];for(t in c.viewer.ndsModel.bodyNodeUUidToMaterial)if(e.uuid==c.viewer.ndsModel.bodyNodeUUidToMaterial[t].uuid){for(var i=c.viewer.ndsModel.getBodyNodeFromUuid(t),r=c.viewer.ndsModel.getLeafBodies(i),o=0;o<r.length;o++){var a=r[o].leafBodyAttri.bodyMeshIds;if(0<a.length)for(var s=0,l=a.length;s<l;++s){var d=c.viewer.ndsModel.meshManager.geomId[a[s]];-1<d&&n.push(c.viewer.ndsModel.geomManager.getGeomFromId(d))}}break}return n}function T(e){var t=e.boundingBox,n=t.min.x,i=t.min.y,r=t.min.z,o=t.max.x,a=t.max.y,e=t.max.z,t=[];t.push(o-n),t.push(a-i),t.push(e-r),t.sort(function(e,t){return e-t});t=t[1];return 6/(t=t<1?1:t)}function l(e){null!=e.getAttribute("position")?void 0===e.getAttribute("uv")&&(null!=e.getAttribute("normal")?function(o){var a=1;if(o instanceof THREE.Geometry)o.faceVertexUvs[0]=[],a=T(o),o.faces.forEach(function(n){var e=["x","y","z"].sort(function(e,t){return Math.abs(n.normal[e])-Math.abs(n.normal[t])}),t=o.vertices[n.a],i=o.vertices[n.b],r=o.vertices[n.c];o.faceVertexUvs[0].push([new THREE.Vector2(t[e[0]]*a,t[e[1]]*a),new THREE.Vector2(i[e[0]]*a,i[e[1]]*a),new THREE.Vector2(r[e[0]]*a,r[e[1]]*a)])});else if(a=T(o),o.getAttribute("position")){var e=o.getAttribute("normal"),t=o.getAttribute("position"),n=o.index,i=0;if(n)if(i=3*n.count,l=new Float32Array(8*n.count),t instanceof THREE.InterleavedBufferAttribute)for(var r=0;r<n.count;r++)l[8*r]=t.array[n.array[r]*t.data.stride+t.offset],l[8*r+1]=t.array[n.array[r]*t.data.stride+t.offset+1],l[8*r+2]=t.array[n.array[r]*t.data.stride+t.offset+2],l[8*r+3]=e.array[n.array[r]*e.data.stride+e.offset],l[8*r+4]=e.array[n.array[r]*e.data.stride+e.offset+1],l[8*r+5]=e.array[n.array[r]*e.data.stride+e.offset+2];else for(var s=0;s<n.count;s++)l[8*s]=t.array[3*n.array[s]],l[8*s+1]=t.array[3*n.array[s]+1],l[8*s+2]=t.array[3*n.array[s]+2],l[8*s+3]=e.array[3*n.array[s]],l[8*s+4]=e.array[3*n.array[s]+1],l[8*s+5]=e.array[3*n.array[s]+2];else for(var i=t.count,l=new Float32Array(8*i),d=0;d<i/3;d++)l[8*d]=t.array[3*d],l[8*d+1]=t.array[3*d+1],l[8*d+2]=t.array[3*d+2],l[8*d+3]=e.array[3*d],l[8*d+4]=e.array[3*d+1],l[8*d+5]=e.array[3*d+2];for(var c=i/9,h=[],u=0;u<c;u++){var f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3;f.x=l[8*u*3],f.y=l[8*u*3+1],f.z=l[8*u*3+2],p.x=l[8*u*3+8],p.y=l[8*u*3+9],p.z=l[8*u*3+10],m.x=l[8*u*3+16],m.y=l[8*u*3+17],m.z=l[8*u*3+18];var g=new THREE.Vector3,v=new THREE.Vector3;g.subVectors(p,f),v.subVectors(m,f);f=new THREE.Vector3;f.crossVectors(g,v),h.push(f)}for(var y=new Uint32Array(i/3),E=0;E<i/3;E++){new THREE.Vector3;var b=h[parseInt(E/3)].clone(),M=["x","y","z"].sort(function(e,t){return Math.abs(b[e])-Math.abs(b[t])}),x=new THREE.Vector3;x.x=l[8*E],x.y=l[8*E+1],x.z=l[8*E+2],l[8*E+6]=x[M[0]]*a,l[8*E+7]=x[M[1]]*a,y[E]=E}var w=new THREE.InterleavedBuffer(l,8),I=new THREE.InterleavedBufferAttribute(w,3,0,!1),S=new THREE.InterleavedBufferAttribute(w,3,3,!1),w=new THREE.InterleavedBufferAttribute(w,2,6,!1);o.addAttribute("position",I),o.addAttribute("normal",S),o.addAttribute("uv",w),o.setIndex(new THREE.BufferAttribute(y,1))}}(e):console.log("生成纹理坐标失败无法线！！！")):console.log("生成纹理坐标失败，无顶点数据,有可能geometry未加载完！！！")}function f(e,t,n){var i,r,o,a,s,l,n=n;-1<(n=Ue.avoidCaching?n+"?time="+Date.now():n).toLowerCase().indexOf(".tga")?(a=e,s=t,l=n,NDS.TextureLoadingManager.itemStart(),h.load(l,function(e){e.flipY=!0,a[s]=e,a[s].sourceFile=l,a[s].wrapS=THREE.RepeatWrapping,a[s].wrapT=THREE.RepeatWrapping,e.needsUpdate=!0,NDS.TextureLoadingManager.itemEnd(),c.viewer.render()},void 0,function(){a[s]=null,a.needsUpdate=!0,c.viewer.render()})):(i=e,r=t,o=n,d.load(o,function(e){i[r]=e,i[r].sourceFile=o,i[r].wrapS=THREE.RepeatWrapping,i[r].wrapT=THREE.RepeatWrapping,i.needsUpdate=!0,"bumpMap"===r?(i.normalMap=null,u.normalMap=null):"normalMap"===r&&(i.bumpMap=null,u.bumpMap=null),c.viewer.render()},void 0,function(){i.needsUpdate=!0,i[r]=null,c.viewer.render()}))}function p(e,t,n){if(e&&void 0!==n){if(null===n||""===n){if(o)for(var i=s(e),r=0;r<i.length;r++)l(i[r]);return e.needsUpdate=!0,void(e[t]=null)}for(i=s(e),r=0;r<i.length;r++)l(i[r]);e[t]&&e[t].sourceFile===n&&!o||(e.needsUpdate=!0,f(e,t,n))}}function m(e){return null!=e&&""!==e?!0:!1}function g(e,t){m(t.color)&&e.color.set(t.color),m(t.linewidth)&&(e.linewidth=parseInt(t.linewidth)),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1)}function v(e,t,n){m(t.color)&&e.color.set(t.color),m(t.specular)&&e.specular.set(t.specular),m(t.emissive)&&e.emissive.set(t.emissive),m(t.skinning)&&(e.skinning=t.skinning),m(t.shininess)&&(e.shininess=parseInt(t.shininess),0==e.shininess?(e.initialSpecular=new THREE.Color,e.initialSpecular.copy(e.specular),e.specular.setRGB(0,0,0)):e.initialSpecular=void 0),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1),m(t.emissiveIntensity)&&(e.emissiveIntensity=parseFloat(t.emissiveIntensity)),m(t.reflectivity)&&(e.reflectivity=parseFloat(t.reflectivity)),m(t.refractionRatio)&&(e.refractionRatio=parseFloat(t.refractionRatio)),m(t.shading)&&(0==t.shading||2==parseInt(t.shading)?e.flatShading=!1:e.flatShading=!0),m(t.wireframe)&&(e.wireframe=t.wireframe),m(t.doubleSided)&&(t.doubleSided?e.side=THREE.DoubleSide:e.side=THREE.FrontSide),2==n?e.wireframe=!0:(e.wireframe=!1,1==n&&e.specular.setRGB(0,0,0)),m(t.bumpScale)&&(e.bumpScale=t.bumpScale),m(t.normalScale)&&(e.normalScale=new THREE.Vector2(t.normalScale,t.normalScale)),p(e,"map",t.map),p(e,"bumpMap",t.bumpMap),p(e,"normalMap",t.normalMap),p(e,"emissiveMap",t.emissiveMap),p(e,"alphaMap",t.alphaMap),p(e,"specularMap",t.specularMap)}function y(e,t,n){m(t.color)&&e.color.set(t.color),m(t.skinning)&&(e.skinning=t.skinning),m(t.emissive)&&e.emissive.set(t.emissive),m(t.metalness)&&(e.metalness=parseFloat(t.metalness)),m(t.roughness)&&(e.roughness=parseFloat(t.roughness)),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1),m(t.emissiveIntensity)&&(e.emissiveIntensity=parseFloat(t.emissiveIntensity)),m(t.envMapIntensity)&&(e.envMapIntensity=parseFloat(t.envMapIntensity)),m(t.refractionRatio)&&(e.refractionRatio=parseFloat(t.refractionRatio)),m(t.shading)&&(0==t.shading||2==parseInt(t.shading)?e.flatShading=!1:e.flatShading=!0),m(t.wireframe)&&(e.wireframe=t.wireframe),m(t.doubleSided)&&(t.doubleSided?e.side=THREE.DoubleSide:e.side=THREE.FrontSide),e.wireframe=2==n,m(t.bumpScale)&&(e.bumpScale=t.bumpScale),m(t.normalScale)&&(e.normalScale=new THREE.Vector2(t.normalScale,t.normalScale)),p(e,"map",t.map),p(e,"bumpMap",t.bumpMap),p(e,"normalMap",t.normalMap),p(e,"emissiveMap",t.emissiveMap),p(e,"alphaMap",t.alphaMap),p(e,"metalnessMap",t.metalnessMap),p(e,"roughnessMap",t.roughnessMap)}function E(e){var t,n=["map","bumpMap","normalMap","emissiveMap","alphaMap","specularMap","metalnessMap","roughnessMap"];for(t in n){var i,r=e[n[t]];r&&(i=void 0,i=!1,(i=0<=r.indexOf("/")||i)||(i=function(e){var t=e;if(c.viewer.trueMapList)for(var n in c.viewer.trueMapList)if(e.toLowerCase()===c.viewer.trueMapList[n].toLowerCase()){t=c.viewer.trueMapList[n];break}return t}(r),e[n[t]]=(1===(r=(r=c.viewer.modelInfo[c.viewer.modelInfo.length-1].url).split("/")).length?"./":(r.pop(),r.join("/")+"/"))+i))}}function b(e,t,n,i){e[t]&&e[t].sourceFile===n&&((e={uuid:e.uuid})[t]=null,c.updateMaterialInfo(e,i),c.viewer.render())}function M(e,t,n){e[t]&&e[t]===n&&(e[t]=null)}function x(e,t,n){t[n]&&(function(e,t){for(var n=!1,i=0;i<e.length;i++)if(e[i]===t){n=!0;break}return n}(e,n=t[n].sourceFile)||e.push(n))}this.setForceUpdateTex=function(e){o=e},this.getMaterialsMarkersMat=function(){return i},this.setMaterialsMarkersMat=function(e){i=e},this.setMaterialsMarkers=function(e){n=e},this.cleanMaterialsMarkers=function(){for(var e=0;e<n.length;e++){var t=n[e];t.parent.remove(t.marker)}n=[],i=null},this.forceUpdateAllMats=function(){c.setForceUpdateTex(!0);var e=c.getMaterialsInfo();c.updateAllMateriaslInfo(e,c.viewer.getRenderMode()),c.setForceUpdateTex(!1)},this.updateAllMateriaslInfo=function(e,t,n){if(e){var i,r,o=function(e){var t=null;if(e&&e.materials)for(var n in e.materials){n=e.materials[n];if("MeshPhongMaterial"===n.type){t=n.type;break}if("MeshStandardMaterial"===n.type){t=n.type;break}}return t}(e);for(r in o!==function(){var e,t=null;for(e in a){var n=a[e];if(n instanceof THREE.MeshPhongMaterial){t="MeshPhongMaterial";break}if(n instanceof THREE.MeshStandardMaterial){t="MeshStandardMaterial";break}}return t}()&&(i=c.getMaterialsInfo(),c.viewer.convertAllMaterialsInfo(i,o)),e.materials)c.updateMaterialInfo(e.materials[r],t,n)}c.removeAllObjectMaterials()},this.removeAllObjectMaterials=function(){this.viewer.ndsModel.removeAllBodyNodeMaterials()},this.removeObjectMaterial=function(e){this.viewer.ndsModel.removeBodyNodeMaterial(e)},this.getObjectMaterialInfo=function(e){var t,n;return this.viewer.ndsModel.bodyNodeUUidToMaterial[e]?(t=this.viewer.ndsModel.bodyNodeUUidToMaterial[e],a[t.uuid]=t):(n=this.viewer.ndsModel.getBodyNodeFromUuid(e),e=this.viewer.ndsModel.getLeafBodies(n)[0].leafBodyAttri.bodyMeshIds[0],e=this.viewer.ndsModel.meshManager.materialId[e],e=this.viewer.ndsModel.meshManager.materialUuids[e],(e=a[e])instanceof THREE.MeshPhongMaterial?t=new THREE.MeshPhongMaterial:e instanceof THREE.MeshStandardMaterial&&(t=new THREE.MeshStandardMaterial),t.uuid=t.uuid.replaceAll("-",""),t.uuid=t.uuid.toLowerCase(),t.copy(e),a[t.uuid]=t,this.viewer.ndsModel.setBodyNodeMaterial(n.uuid,t)),this.materialToJson(t)},this.getBodyNodeMaterialsInfo=function(){var e,t=this.viewer.ndsModel.getBodyNodeUUidToMaterial(),n={};for(e in t)n[e]=this.materialToJson(t[e]);return n},this.autoCreateMaterial=function(e){var t;return"MeshPhongMaterial"==e?t=new THREE.MeshPhongMaterial:"MeshStandardMaterial"==e&&(t=new THREE.MeshStandardMaterial),t.uuid=t.uuid.replaceAll("-",""),t.uuid=t.uuid.toLowerCase(),t},this.randColor=function(){var e=[Math.floor(240*Math.random()+15),Math.floor(240*Math.random()+15),Math.floor(240*Math.random()+15)];return 65536*e[0]+256*e[1]+e[2]},this.autoSetBodyNodeMaterial=function(e){for(var e=this.viewer.ndsModel.getBodyNodeFromUuid(e),t=this.viewer.ndsModel.getLeafBodies(e),n=0;n<t.length;n++){var i=void 0;(i=t[n].useBodyNodeMaterial?this.viewer.ndsModel.bodyNodeUUidToMaterial[t[n].uuid]:this.autoCreateMaterial("MeshStandardMaterial")).color.set(this.randColor()),i.needsUpdate=!0,a[i.uuid]=i,this.viewer.ndsModel.setBodyNodeMaterial(t[n].uuid,i)}this.viewer.render()},this.updateMaterialInfo=function(e,t,n){E(e),u=e,n&&function(e){var t,n=["map","bumpMap","normalMap","emissiveMap","alphaMap","specularMap","metalnessMap","roughnessMap"];for(t in n)void 0===e[n[t]]&&(e[n[t]]=null)}(e),e&&e.uuid&&((n=a[e.uuid])&&(n instanceof THREE.LineBasicMaterial?g(n,e):n instanceof THREE.MeshPhongMaterial?v(n,e,t):n instanceof THREE.MeshStandardMaterial&&y(n,e,t),n.needsUpdate=!0)),c.viewer.render()},this.initMaterialsInfo=function(e){for(var t in e){var n=e[t];0<n.refCount&&(n.mat.wireframe=!1,a[t]=n.mat)}},this.removeMap=function(e,t,n){if(null==e||""===e)return!1;for(var i in e=e.replace(/ /g,"%20"),a){i=a[i];i.needsUpdate=!0,b(i,"map",e,n),b(i,"bumpMap",e,n),b(i,"normalMap",e,n),b(i,"emissiveMap",e,n),b(i,"alphaMap",e,n),b(i,"specularMap",e,n),b(i,"roughnessMap",e,n),b(i,"metalnessMap",e,n)}return t&&function(e,t){for(var n in t.materials){n=t.materials[n];M(n,"map",e),M(n,"bumpMap",e),M(n,"normalMap",e),M(n,"emissiveMap",e),M(n,"alphaMap",e),M(n,"specularMap",e),M(n,"roughnessMap",e),M(n,"metalnessMap",e),M(n,"specularMapOld",e),M(n,"roughnessMapOld",e),M(n,"metalnessMapOld",e)}}(e,t),!0},this.isMapWorking=function(e){var t=!1;e=e.replace(/ /g,"%20");for(var n=c.getMapList(),i=0;i<n.length;i++)if(e===n[i]){t=!0;break}return t},this.getMapList=function(){var e,t=[];for(e in a){var n=a[e];x(t,n,"map"),x(t,n,"bumpMap"),x(t,n,"normalMap"),x(t,n,"emissiveMap"),x(t,n,"alphaMap"),x(t,n,"specularMap"),x(t,n,"roughnessMap"),x(t,n,"metalnessMap")}return t},this.getMaterialIndex=function(e){var t,n=[],i=-1;for(t in a)n.push(a[t]);for(var r=0,o=n.length;r<o;r++)if(n[r].uuid===e.uuid){i=r;break}return i},this.getMaterialsInfo=function(){var e,t={materials:[]};for(e in r=0,a){var n=this.materialToJson(a[e]);t.materials.push(n)}return t},this.materialToJson=function(e){var t,n,i={};return e instanceof THREE.LineBasicMaterial?i={version:"1.00",name:(n=e).name,type:n.type,uuid:n.uuid,color:n.color.getHex(),linewidth:n.linewidth,opacity:n.opacity}:e instanceof THREE.MeshPhongMaterial?(t={version:"1.00",name:(n=e).name,type:n.type,uuid:n.uuid,doubleSided:n.side===THREE.DoubleSide,shininess:n.shininess,reflectivity:n.reflectivity,refractionRatio:n.refractionRatio,opacity:n.opacity,color:n.color.getHex(),specular:n.specular.getHex(),emissive:n.emissive.getHex(),emissiveIntensity:n.emissiveIntensity,shading:n.flatShading,wireframe:n.wireframe,skinning:n.skinning},n.map?t.map=n.map.sourceFile:t.map=null,n.bumpMap?(t.bumpMap=n.bumpMap.sourceFile,t.bumpScale=n.bumpScale):(t.bumpScale=n.bumpScale,t.bumpMap=null),n.normalMap?t.normalMap=n.normalMap.sourceFile:t.normalMap=null,t.normalScale=n.normalScale.x,n.emissiveMap?t.emissiveMap=n.emissiveMap.sourceFile:t.emissiveMap=null,n.alphaMap?t.alphaMap=n.alphaMap.sourceFile:t.alphaMap=null,n.specularMap?t.specularMap=n.specularMap.sourceFile:t.specularMap=null,i=t):e instanceof THREE.MeshStandardMaterial&&(e={version:"1.00",name:(t=e).name,type:t.type,uuid:t.uuid,doubleSided:t.side===THREE.DoubleSide,envMapIntensity:t.envMapIntensity,refractionRatio:t.refractionRatio,opacity:t.opacity,color:t.color.getHex(),emissive:t.emissive.getHex(),emissiveIntensity:t.emissiveIntensity,shading:t.flatShading,roughness:t.roughness,metalness:t.metalness,wireframe:t.wireframe,skinning:t.skinning},t.map?e.map=t.map.sourceFile:e.map=null,t.bumpMap?e.bumpMap=t.bumpMap.sourceFile:e.bumpMap=null,e.bumpScale=t.bumpScale,t.normalMap?e.normalMap=t.normalMap.sourceFile:e.normalMap=null,e.normalScale=t.normalScale.x,t.emissiveMap?e.emissiveMap=t.emissiveMap.sourceFile:e.emissiveMap=null,t.alphaMap?e.alphaMap=t.alphaMap.sourceFile:e.alphaMap=null,t.metalnessMap?e.metalnessMap=t.metalnessMap.sourceFile:e.metalnessMap=null,t.roughnessMap?e.roughnessMap=t.roughnessMap.sourceFile:e.roughnessMap=null,i=e),""===i.name&&(i.name="Material_"+r.toString(),++r),i},this.jsonToMaterial=function(e){var t;return"LineBasicMaterial"==e.type?g(t=new THREE.LineBasicMaterial,e):"MeshPhongMaterial"==e.type?v(t=new THREE.MeshPhongMaterial,e):"MeshStandardMaterial"==e.type&&y(t=new THREE.MeshStandardMaterial,e),t.uuid=e.uuid,t},this.convertMaterialInfo=function(e,t,n){var i={matJson:null,matObj:null};if(null==e||null==t)return i;if(e.type==t)return i;if("LineBasicMaterial"==e.type)return i;var r=a[e.uuid],o={};return"MeshPhongMaterial"==t?(i.matObj=new THREE.MeshPhongMaterial,o={version:"1.00",name:e.name,type:"MeshPhongMaterial",uuid:e.uuid,doubleSided:e.doubleSided,reflectivity:e.envMapIntensity,refractionRatio:e.refractionRatio,opacity:e.opacity,color:e.color,skinning:e.skinning,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,shading:e.shading,wireframe:e.wireframe,roughnessOld:e.roughness,metalnessOld:e.metalness,metalnessMapOld:e.metalnessMap,roughnessMapOld:e.roughnessMap},null!=e.specularOld?o.specular=e.specularOld:o.specular=i.matObj.specular.getHex(),null!=e.shininessOld?o.shininess=e.shininessOld:o.shininess=i.matObj.shininess,e.map&&(o.map=e.map),e.bumpMap&&(o.bumpMap=e.bumpMap),e.bumpScale&&(o.bumpScale=e.bumpScale),e.normalMap&&(o.normalMap=e.normalMap),e.normalScale&&(o.normalScale=e.normalScale),e.emissiveMap&&(o.emissiveMap=e.emissiveMap),e.alphaMap&&(o.alphaMap=e.alphaMap),e.specularMapOld?o.specularMap=e.specularMapOld:o.specularMap=null):"MeshStandardMaterial"==t&&(i.matObj=new THREE.MeshStandardMaterial,o={version:"1.00",name:e.name,type:"MeshStandardMaterial",uuid:e.uuid,doubleSided:e.doubleSided,envMapIntensity:e.reflectivity,refractionRatio:e.refractionRatio,opacity:e.opacity,color:e.color,skinning:e.skinning,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,shading:e.shading,wireframe:e.wireframe,specularOld:e.specular,shininessOld:e.shininess,specularMapOld:e.specularMap},null!=e.roughnessOld?o.roughness=e.roughnessOld:o.roughness=i.matObj.roughness,null!=e.metalnessOld?o.metalness=e.metalnessOld:o.metalness=i.matObj.metalness,e.map&&(o.map=e.map),e.bumpMap&&(o.bumpMap=e.bumpMap),e.bumpScale&&(o.bumpScale=e.bumpScale),e.normalMap&&(o.normalMap=e.normalMap),e.normalScale&&(o.normalScale=e.normalScale),e.emissiveMap&&(o.emissiveMap=e.emissiveMap),e.alphaMap&&(o.alphaMap=e.alphaMap),e.metalnessMapOld?o.metalnessMap=e.metalnessMapOld:o.metalnessMap=null,e.roughnessMapOld?o.roughnessMap=e.roughnessMapOld:o.roughnessMap=null),r.map&&(i.matObj.map=r.map),r.bumpMap&&(i.matObj.bumpMap=r.bumpMap,i.matObj.bumpScale=r.bumpScale),r.normalMap&&(i.matObj.normalMap=r.normalMap,i.matObj.normalScale=r.normalScale),r.emissiveMap&&(i.matObj.emissiveMap=r.emissiveMap),r.alphaMap&&(i.matObj.alphaMap=r.alphaMap),r.envMap&&(i.matObj.envMap=r.envMap),i.matObj.name=e.name,i.matObj.uuid=e.uuid,a[e.uuid]=i.matObj,i.matJson=o,c.updateMaterialInfo(o,n),i}};function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function V(e,t,n){return t&&k(e.prototype,t),n&&k(e,n),e}var U=function(){function i(e,t,n){F(this,i),this.m_value=[],this.m_value[0]=e||0,this.m_value[1]=t||0,this.m_value[2]=n||0}return V(i,[{key:"LargestCoordIndex",value:function(){var e=0;return this.m_value[1]>this.m_value[0]&&(e=1),e=this.m_value[2]>this.m_value[e]?2:e}},{key:"DistanceToPoint",value:function(e){return Math.sqrt(Math.pow(this.m_value[0]-e.m_value[0],2)+Math.pow(this.m_value[1]-e.m_value[1],2)+Math.pow(this.m_value[2]-e.m_value[2],2))}},{key:"GetValue",value:function(e){return this.m_value[e]}}]),i}(),X=function(){function n(){F(this,n),this.m_value=[],this.m_value[0]=this.m_value[1]=this.m_value[2]=1/0,this.m_value[3]=this.m_value[4]=this.m_value[5]=-1/0}return V(n,[{key:"Init",value:function(){this.m_value[0]=this.m_value[1]=this.m_value[2]=1/0,this.m_value[3]=this.m_value[4]=this.m_value[5]=-1/0}},{key:"GetCentriod",value:function(){return new U(.5*(this.m_value[0]+this.m_value[3]),.5*(this.m_value[1]+this.m_value[4]),.5*(this.m_value[2]+this.m_value[5]))}},{key:"GetMinMaxPoint",value:function(e,t){new U(this.m_value[0],this.m_value[1],this.m_value[2]),new U(this.m_value[3],this.m_value[4],this.m_value[5])}},{key:"SetMinMaxPoint",value:function(e,t){this.m_value[0]=e.m_value[0],this.m_value[1]=e.m_value[1],this.m_value[2]=e.m_value[2],this.m_value[3]=t.m_value[0],this.m_value[4]=t.m_value[1],this.m_value[5]=t.m_value[2]}},{key:"SetMinMaxPointFromArray",value:function(e){this.m_value[0]=e[0],this.m_value[1]=e[1],this.m_value[2]=e[2],this.m_value[3]=e[3],this.m_value[4]=e[4],this.m_value[5]=e[5]}},{key:"GetSize",value:function(){return new U(this.m_value[3]-this.m_value[0],this.m_value[4]-this.m_value[1],this.m_value[5]-this.m_value[2])}},{key:"Area",value:function(){var e=this.m_value[3]-this.m_value[0],t=this.m_value[4]-this.m_value[1],n=this.m_value[5]-this.m_value[2];return e<0||t<0||n<0?0:2*(e*t+t*n+e*n)}},{key:"DiagonalLength",value:function(){return Math.sqrt(Math.pow(this.m_value[0]-this.m_value[3],2)+Math.pow(this.m_value[1]-this.m_value[4],2)+Math.pow(this.m_value[2]-this.m_value[5],2))}},{key:"AddPoint",value:function(e){e.m_value[0]<this.m_value[0]&&(this.m_value[0]=e.m_value[0]),e.m_value[0]>this.m_value[3]&&(this.m_value[3]=e.m_value[0]),e.m_value[1]<this.m_value[1]&&(this.m_value[1]=e.m_value[1]),e.m_value[1]>this.m_value[4]&&(this.m_value[4]=e.m_value[1]),e.m_value[2]<this.m_value[2]&&(this.m_value[2]=e.m_value[2]),e.m_value[2]>this.m_value[5]&&(this.m_value[5]=e.m_value[2])}},{key:"AddVector",value:function(e){this.m_value[0]=Math.min(e.x,this.m_value[0]),this.m_value[1]=Math.min(e.y,this.m_value[1]),this.m_value[2]=Math.min(e.z,this.m_value[2]),this.m_value[3]=Math.max(e.x,this.m_value[3]),this.m_value[4]=Math.max(e.y,this.m_value[4]),this.m_value[5]=Math.max(e.z,this.m_value[5])}},{key:"AddBox",value:function(e){e.m_value[0]<this.m_value[0]&&(this.m_value[0]=e.m_value[0]),e.m_value[3]>this.m_value[3]&&(this.m_value[3]=e.m_value[3]),e.m_value[1]<this.m_value[1]&&(this.m_value[1]=e.m_value[1]),e.m_value[4]>this.m_value[4]&&(this.m_value[4]=e.m_value[4]),e.m_value[2]<this.m_value[2]&&(this.m_value[2]=e.m_value[2]),e.m_value[5]>this.m_value[5]&&(this.m_value[5]=e.m_value[5])}},{key:"IsIntersectBox",value:function(e){return!(e.m_value[3]<this.m_value[0]||e.m_value[0]>this.m_value[3]||e.m_value[4]<this.m_value[1]||e.m_value[1]>this.m_value[4]||e.m_value[5]<this.m_value[2]||e.m_value[2]>this.m_value[5])}},{key:"GetValue",value:function(e){return this.m_value[e]}},{key:"SetFromBox",value:function(e){this.m_value[0]=e.m_value[0],this.m_value[1]=e.m_value[1],this.m_value[2]=e.m_value[2],this.m_value[3]=e.m_value[3],this.m_value[4]=e.m_value[4],this.m_value[5]=e.m_value[5]}},{key:"MultiplyMatrix",value:function(e){n.points[0].set(this.m_value[0],this.m_value[1],this.m_value[2]).applyMatrix4(e),n.points[1].set(this.m_value[3],this.m_value[1],this.m_value[2]).applyMatrix4(e),n.points[2].set(this.m_value[3],this.m_value[1],this.m_value[5]).applyMatrix4(e),n.points[3].set(this.m_value[0],this.m_value[1],this.m_value[5]).applyMatrix4(e),n.points[4].set(this.m_value[0],this.m_value[4],this.m_value[2]).applyMatrix4(e),n.points[5].set(this.m_value[3],this.m_value[4],this.m_value[2]).applyMatrix4(e),n.points[6].set(this.m_value[3],this.m_value[4],this.m_value[5]).applyMatrix4(e),n.points[7].set(this.m_value[0],this.m_value[4],this.m_value[5]).applyMatrix4(e),this.Init();for(var t=0;t<8;++t)this.AddVector(n.points[t])}},{key:"toArray",value:function(){return this.m_value}}]),n}();X.points=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];function z(){F(this,z),this.m_box=new X,this.m_leftChild=-1,this.m_nPrims=0,this.m_startPrim=-1}function G(e,t){F(this,G),this.m_box=e,this.m_triangles=t}var W=function(){function e(){F(this,e),this.m_size=0,this.m_nodes=[],this.m_primIds=[]}return V(e,[{key:"Reset",value:function(){this.m_nodes=[],this.m_primIds=[],this.m_size=0}},{key:"SetNumEstimateNodes",value:function(e){for(var t=0;t<e;++t){var n=new z;this.m_nodes[t]=n}this.m_size=0}},{key:"GetNode",value:function(e){return this.m_nodes[e]}},{key:"AllocNode",value:function(e){var t=this.m_nodes.length;if(this.m_size+e>t){var n=t/4;(n=n<16?16:n)<e&&(n=e);for(var i=0;i<n;++i){var r=new z;this.m_nodes.push(r)}}t=this.m_size;return this.m_size+=e,t}}]),e}(),K=function(){function i(e,t){F(this,i),this.m_maxLevel=11,this.m_widthTol=0,this.m_nodeManager=new W,this.jsonModel=e,this.bvh=t.bvh,this.MeshIndex=0,this.LineIndex=0,this.geometryToPri=[],this.matrixtem=new THREE.Matrix4;var n=new THREE.Matrix4;this.matrixs=[],n.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.matrixs.push(n),this.m_boxes=[],this.m_primIds=[],this.m_nPrimTris=[],this.materials=[],e.materials&&(this.materials=e.materials.concat()),this.ndsModel=t,this.UuidToMaterialID={}}return V(i,[{key:"Reset",value:function(){this.m_boxes=[],this.m_primIds=[],this.m_nPrimTris=[]}},{key:"Build",value:function(){var e=this.jsonModel.bufferchunks;if(null!=e){for(var t=0;t<e.length;++t)for(var n=0;n<e[t].geometries.length;++n){var i,r=e[t].geometries[n];r.triangles&&((i=new X).SetMinMaxPointFromArray(r.box),i=new G(i,r.triangles),this.geometryToPri[r.uuid]=i)}this.bvh.meshManager.setNumMeshes(this.jsonModel.object.meshNum),this.bvh.meshManager.setNumLineSegments(this.jsonModel.object.lineNum),this.deepTree(this.jsonModel.object),this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()}}},{key:"Create",value:function(e,t,n,i,r){var o=n.length;if(this.m_nodeManager.Reset(),o){for(var a=[],s=0;s<o;++s)a[s]=n[s].GetCentriod();for(var l=2*Math.ceil(o/i),d=1;(d*=2)<l;);this.m_nodeManager.SetNumEstimateNodes(d);for(var c=this.m_nodeManager.AllocNode(1),h=this.m_nodeManager.GetNode(c),u=new X,f=new X,p=0;p<o;++p)u.AddBox(n[p]),f.AddPoint(a[p]);var m=u.GetSize();this.m_widthTol=1e-5*m.m_value[m.LargestCoordIndex()],h.m_box=u,h.m_nPrims=o,h.m_startPrim=0;for(var g=new Array(e.length),v=0;v<e.length;++v)g[v]=v;this.Subdvide(c,f,n,a,g,t,i,r,0),this.m_nodeManager.m_primIds=g}}},{key:"Subdvide",value:function(e,t,n,i,r,o,a,s,l){for(var d,c,h,u,f,p=t.GetSize(),m=p.LargestCoordIndex(),g=this.m_nodeManager.GetNode(e),v=0,y=0;y<g.m_nPrims;y++)v+=o[g.m_startPrim+y];g.m_nPrims<a&&v<s||1==g.m_nPrims||l>=this.m_maxLevel||p.m_value[m]<this.m_widthTol||(f=g.m_startPrim,d=g.m_startPrim+g.m_nPrims,u=0,c=new X,h=new X,e=new X,p=new X,u=this.Partition(t,m,n,i,r,f,d,c,h,e,p),t=this.m_nodeManager.AllocNode(2),g.m_leftChild=t,(m=this.m_nodeManager.GetNode(t)).m_box=c,m.m_nPrims=u-f,m.m_startPrim=f,(f=this.m_nodeManager.GetNode(m=t+1)).m_box=h,f.m_nPrims=d-u,f.m_startPrim=u,this.Subdvide(t,e,n,i,r,o,a,s,l+1),this.Subdvide(m,p,n,i,r,o,a,s,l+1))}},{key:"Partition",value:function(e,t,n,i,r,o,a,s,l,d,c){for(var h=16,u=.99999*(h=a-o<h?a-o:h)/(e.m_value[3+t]-e.m_value[t]),f=[],p=[],m=new Int32Array(h),g=new Int32Array(a-o),v=0;v<h;++v){var y=new X,E=new X;f[v]=y,p[v]=E}for(var b=o;b<a;++b){var M=Math.floor(u*(i[r[b]].m_value[t]-e.m_value[t]));M<0?M=0:h<=M&&(M=h-1),++m[g[b-o]=M],f[M],f[M].AddBox(n[r[b]]),p[M].AddPoint(i[r[b]])}var x=[],w=[],I=[],S=[];x[0]=m[0],w[0]=f[0],I[0]=p[0],S[0]=w[0].Area();for(var T=1;T<h-1;++T){x[T]=x[T-1]+m[T];var A=new X,R=new X;A.SetFromBox(w[T-1]),w[T]=A,w[T].AddBox(f[T]),R.SetFromBox(I[T-1]),I[T]=R,I[T].AddBox(p[T]),S[T]=w[T].Area()}var O=[],P=[],C=[],B=[];O[h-1]=m[h-1],P[h-1]=f[h-1],C[h-1]=p[h-1],B[h-1]=P[h-1].Area();for(var L=h-2;0<L;--L){O[L]=O[L+1]+m[L];var D=new X,H=new X;D.SetFromBox(P[L+1]),P[L]=D,P[L].AddBox(f[L]),H.SetFromBox(C[L+1]),C[L]=H,C[L].AddBox(p[L]),B[L]=P[L].Area()}for(var N=x[0]*S[0]+O[1]*B[1],F=0,_=1;_<h-1;++_){var k=x[_]*S[_]+O[_+1]*B[_+1];k<N&&(N=k,F=_)}for(var V=r.slice(o,a),j=0,U=o;U<a;++U)g[U-o]<=F&&(r[o+j]=V[U-o],++j);for(var z=o+j,G=0,W=o;W<a;++W)g[W-o]>F&&(r[z+G]=V[W-o],++G);return s.SetFromBox(w[F]),l.SetFromBox(P[F+1]),d.SetFromBox(I[F]),c.SetFromBox(C[F+1]),z}},{key:"getMatrixId",value:function(e){for(var t=0,n=this.matrixs.length;t<n;++t)if(e.equals(this.matrixs[t]))return t;return-1}},{key:"ParesLeafNode",value:function(e,t,n){var i,r=e.geometry,o=null!=n?n:0,a=this.UuidToMaterialID[e.material];"Mesh"===e.type?(n=this.geometryToPri[e.geometry])?((i=new X).SetFromBox(n.m_box),i.MultiplyMatrix(t),this.m_boxes[this.MeshIndex]=i,this.m_nPrimTris[this.MeshIndex]=n.m_triangles,this.m_primIds[this.MeshIndex]=this.MeshIndex,this.bvh.meshManager.setMeshFromGeomUuid(this.MeshIndex++,i.toArray(),r,0,a,o)):(i=new X,this.m_boxes[this.MeshIndex]=i,this.m_nPrimTris[this.MeshIndex]=0,this.m_primIds[this.MeshIndex]=this.MeshIndex,this.bvh.meshManager.setMeshFromGeomUuid(this.MeshIndex++,i.toArray(),r,0,a,o)):"LinePieces"===e.type&&this.bvh.meshManager.setLineSegmentsFromGeomUuid(this.LineIndex++,r,o,a)}},{key:"deepTree",value:function(e){for(var t,n=this.materials.length,i=[],r=0;r<n;++r)t=this.materials[r].uuid,this.UuidToMaterialID[t]=r,i.push(t);this.bvh.meshManager.setMaterialUuids(i);var o=new THREE.Matrix4;o.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var a=[];a.push({node:e,nodematrix:o,Parentuuid:null});for(var s=0;s<a.length;++s){var l=a[s];if(null!=l.node.geometry)this.ParesLeafNode(l.node,l.nodematrix,l.Parentuuid);else if(null!=l.node.children&&0<l.node.children.length){l.node.matrix&&(this.matrixtem.fromArray(l.node.matrix),l.nodematrix.multiply(this.matrixtem)),null!=l.node.children[0].geometry&&(l.node.worldMatrix=l.nodematrix);for(var d=0;d<l.node.children.length;++d){var c={node:l.node.children[d],nodematrix:l.nodematrix.clone(),Parentuuid:l.node.uuid};a.push(c)}}}}},{key:"BVHconstruct",value:function(){var e=this.m_nodeManager.m_size;this.bvh.setNumNodes(e);for(var t,n,i,r=new Float32Array(6),o=0;o<e;++o){for(var a=0;a<6;++a)r[a]=this.m_nodeManager.m_nodes[o].m_box.m_value[a];t=this.m_nodeManager.m_nodes[o].m_leftChild,n=this.m_nodeManager.m_nodes[o].m_nPrims,i=this.m_nodeManager.m_nodes[o].m_startPrim,this.bvh.setNode(o,r,t,n,i)}this.bvh.setMeshIds(this.m_nodeManager.m_primIds),this.ndsModel.buildMeshSets()}},{key:"Reconstruct",value:function(e){this.jsonModel=e;for(var t=this.jsonModel.bufferchunks,n=0;n<t.length;++n)for(var i=0;i<t[n].geometries.length;++i){var r,o=t[n].geometries[i];o.triangles&&((r=new X).SetMinMaxPointFromArray(o.box),r=new G(r,o.triangles),this.geometryToPri[o.uuid]=r)}this.MeshIndex=this.bvh.meshManager.nMeshes,this.LineIndex=this.bvh.meshManager.nLineSegments,this.bvh.meshManager.expandMeshes(this.jsonModel.object.meshNum),this.bvh.meshManager.expandLineSegments(this.jsonModel.object.lineNum);for(var a=this.materials.length,s=!1,l=0;l<e.materials.length;l++){for(var s=!1,d=0;d<a;d++)if(this.materials[d].uuid==e.materials[l].uuid){s=!0;break}s||this.materials.push(e.materials[l])}this.deepTree(this.jsonModel.object),this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()}},{key:"delete",value:function(n,e){this.m_primIds=this.m_primIds.filter(function(e,t){if(-1==n.indexOf(t))return!0}),this.m_nPrimTris=this.m_nPrimTris.filter(function(e,t){if(-1==n.indexOf(t))return!0}),this.m_boxes=this.m_boxes.filter(function(e,t){if(-1==n.indexOf(t))return!0}),this.bvh.meshManager.deleteMeshes(n),this.bvh.meshManager.deleteLineSegments(e),this.Rebuild()}},{key:"Rebuild",value:function(){this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()}}]),i}();function ee(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var te,Fe=function(e,t){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.loader=null,this.linkMap={},this.linkWaitingArray={},this.linkDoneMap={},this.treeIndex=1e4,this.viewer=t,this.chunkRequestQueue=[],this.maxRequestNum=7,(ye.isIOSDevice()||ye.isIpadDevice())&&(this.maxRequestNum=4),this.loadCanceled=!1,this.chunkRequestFiredNum=0,this.SDFMaker=new _,this.geometryTOchild={},t.SDFMaker=this.SDFMaker};Fe.prototype={constructor:Fe,load:function(u,f,p,m,g,v,y,e,E){this.treeIndex=1e4;var b=this;if(this.loader=new He,this.loader.setCrossOrigin(this.crossOrigin),Array.isArray(f))for(var r={combine:!(b.nLoadedJsonCount=0)},t=0;t<f.length;++t){var n=new He;n.attribute=t,n.load(null,f[t],function(e,t){var n,i=null;try{i=JSON.parse(e)}catch(e){return void(E&&E())}null!=i.modelContentFile&&null!=i.modelContentFile?((n=new He(new THREE.LoadingManager)).setCrossOrigin("anonymous"),n.setResponseType("arraybuffer"),e=b.extractUrlBase(f[t])+i.modelContentFile,null!=m&&null!=m&&(e=m[t]),n.load(null,e,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);b.handleMaterialLoadMultiple(b,u,i,e,r,f,p,t,g,v,y)},void 0,E)):b.handleMaterialLoadMultiple(b,u,i,i,r,f,p,t,g,v,y)},void 0,E)}else this.loader.load(null,f,function(e){var t,n,i=b.extractUrlBase(f),r=null;try{r=JSON.parse(e)}catch(e){return void(E&&E())}if(b.viewer.modelContentVersion=r.modelContentVersion||1,r.fileID&&!b.viewer.watermark){var o=r.fileID.slice(4);b.viewer.watermark="";for(var a=0;a<o.length/4;a++){var s=o.slice(4*a,4*(a+1));b.viewer.watermark+=String.fromCharCode(parseInt(s,16))}"Viewer版本过低，请升级"==b.viewer.watermark&&(b.viewer.watermark="")}r.bvh&&0==Ue.inAssemblyContext&&(b.viewer.ndsModel=new ze(b.viewer),b.viewer.ndsModel.is2DModel=b.viewer.is2DModel,b.viewer.isRunning||setTimeout(b.viewer.run(),1),performance.now().toFixed(0),t={useWorker:!1,bufferlenth:r.bvhBufferLength,compress:!0,bvh:b.viewer.ndsModel.bvh},new oe({objectIdType:r.objectIdType,materialIdType:r.materialIdType,geomIdType:r.geomIdType,instanceIdType:r.instanceIdType}).loadBvh(null,i+r.bvh,t,function(){performance.now().toFixed(0);b.viewer.ndsModel.buildMeshSets(),b.viewer.ndsModelBvhLoaded=!0,b.viewer.ndsModelObjectTreeLoaded&&b.viewer.prepareModelForRendering(),b.viewer.dispatchEvent({type:"BVHInfoEvent",PMI:!0})})),b.viewer.cameraInfoFile=r.cameraInfo,b.viewer.cameraInfoFile&&(b.viewer.cameraInfoFile.hasSet=!1),null!=r.geometryChunksFile&&null!=r.geometryChunksFile?((t=new He).setCrossOrigin("anonymous"),t.setResponseType("arraybuffer"),n=i+r.geometryChunksFile,t.load(null,n,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);b.loadModelContent(b,u,r,e,i,m,f,p,g,v,y,E)},void 0,E)):b.loadModelContent(b,u,r,null,i,m,f,p,g,v,y,E),null!=r.modelBrepData&&null!=r.modelBrepData&&(n=i+r.modelBrepData,null==b.viewer.brepManager&&(b.viewer.brepManager=new Ne(b.viewer)),"modelBrep.js.gz"==r.modelBrepData&&(b.viewer.brepManager.type=0),b.viewer.brepManager.addBrepFileUrl(n),Ue.enablePreSelectBrep||Ue.inAssemblyContext?b.viewer.loadBrepInfo(!1):((n=new He).setCrossOrigin("anonymous"),n.setResponseType("arraybuffer"),d=(i=b.extractUrlBase(f))+r.modelBrepData,n.load(null,d,void 0,void 0,void 0,!0)));function l(){var e=new He;e.setCrossOrigin("anonymous"),e.setResponseType("arraybuffer");var t=b.extractUrlBase(f),n=t+r.pmiContentFile,i=t+"pmi.bin";e.load(null,n,function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);b.SDFMaker.CreateMaterial(e,1,b.viewer.modelContentVersion),b.viewer.is2DModel&&b.viewer.saveTextForPDF(e,1),b.handleMaterialLoad(b,u,r,e,f,i,g,v,function(){var e;!b.viewer.backGroundScene&&b.viewer.is2DModel&&(e="0x"+b.viewer.renderer.getClearColor().getHexString(),b.viewer.clearColor=null,b.viewer.setBackGroundColor(e)),b.viewer.render()},!0)},void 0,E)}var d,c,h;null!=r.uvfile&&((d=new He).setCrossOrigin("anonymous"),d.setResponseType("arraybuffer"),c=b.extractUrlBase(f),h=c+r.uvfile,b.SDFMaker.SetVersion(2),d.load(null,h,function(e){var t=pako.inflate(e,{to:"string"}),e=JSON.parse(t);b.SDFMaker.CreateMaterial(e,2,b.viewer.modelContentVersion);t=new oe,e={useWorker:!1,bufferlenth:r.texturelength,compress:!0};h=c+r.texturefile,t.loadTexture(null,h,e,function(e){b.SDFMaker.SetTexture(e,b.viewer.modelContentVersion,function(){b.viewer.render()})}),null!=r.pmiContentFile&&l()},void 0,E)),null!=r.pmiContentFile?null==r.uvfile&&l():(b.viewer.ndsModelPMILoaded=!0,b.viewer.dispatchEvent({type:"PMIInfoEvent",PMI:!1})),b.viewer.loadbrepDefault?b.viewer.loadBrepInfo(!1):b.loader.load(null,i+"productData.json",function(e){try{var t=function e(t){var n;if(t.uuid&&(n={area:t.area,volume:t.volume},b.viewer.productDataMap[t.uuid]=n),0<t.children.length)for(var i=0;i<t.children.length;++i)e(t.children[i])};b.viewer.productData=JSON.parse(e),b.viewer.productDataMap={},t(b.viewer.productData.datas[0].modelTree)}catch(e){b.viewer.is2DModel||b.viewer.loadBrepInfo(!1)}},void 0,function(){b.viewer.is2DModel||b.viewer.loadBrepInfo(!1)})},e,E)},loadModelContent:function(r,o,a,s,l,e,d,c,h,u,f,t){var n,i;null!=a.modelContentFile&&null!=a.modelContentFile?((n=new He).setCrossOrigin("anonymous"),n.setResponseType("arraybuffer"),i=l+a.modelContentFile,n.load(null,i=null!=e&&null!=e?e:i,function(e){var t=pako.inflate(e,{to:"string"});try{var n=t.replace(/\\[^u]{1}/g,function(e){return"-"+e[1]}),i=JSON.parse(n)}catch(e){i=JSON.parse(t)}i.objectIdType=a.objectIdType,i.materialIdType=a.materialIdType,i.geomIdType=a.geomIdType,i.instanceIdType=a.instanceIdType,i.uv&&(r.SDFMaker.SetVersion(2),r.SDFMaker.CreateMaterial(i.uv,2,r.viewer.modelContentVersion),e=l+i.texturefile,n=new oe,t={useWorker:!1,bufferlenth:i.texturelength,compress:!0},n.loadTexture(null,e,t,function(e){r.SDFMaker.SetTexture(e,r.viewer.modelContentVersion,function(){r.viewer.render()})}),null!=i.shxlength&&0<i.shxlength&&(n=l+i.shxfile,e=new oe,t={useWorker:!1,bufferlenth:i.shxlength,compress:!0},r.SDFMaker.needShxLoad=!0,e.loadShx(null,n,t,function(e){r.SDFMaker.ProcessShxText(r.viewer,e)})),r.viewer.is2DModel&&r.viewer.saveTextForPDF(i,2<=r.viewer.modelContentVersion?2:1));performance.now().toFixed(0);s&&Object.assign(i,s),null!=a.bvh&&null!=a.bvh&&1!=Ue.inAssemblyContext||(r.viewer.ndsModel?r.viewer.ndsModel&&r.viewer.ndsModel.bvhCreater&&r.viewer.ndsModel.bvhCreater.Reconstruct(i):(r.viewer.ndsModel=new ze(r.viewer),r.viewer.isRunning||setTimeout(r.viewer.run(),1),r.viewer.ndsModel.bvhCreater=new K(i,r.viewer.ndsModel),r.viewer.ndsModel.bvhCreater.Build(),r.viewer.ndsModelBvhLoaded=!0,r.viewer.ndsModelObjectTreeLoaded&&r.viewer.prepareModelForRendering())),r.handleMaterialLoad(r,o,a,i,d,c,h,u,f)},void 0,t)):r.handleMaterialLoad(r,o,a,a,d,c,h,u,f)},handleMaterialLoad:function(t,e,n,i,r,o,a,s,l,d){var c;null!=d&&0!=d||(t.viewer.modelUnit=i.unit),null==n.materialsPath&&e.searchMaterialsFile&&(n.materialsPath="materials.js"),e.materialsSetting&&(i.materials=e.materialsSetting.materials),n.materialsPath&&null==parameters.materialsSetting?((c=new He).setCrossOrigin(t.crossOrigin),e=t.extractUrlBase(r),c.load(null,e+n.materialsPath,function(e){e=JSON.parse(e);i.materials=e.materials,t.parse(null,i,r,o,null,a,s,l)},void 0,function(e){t.parse(null,i,r,o,null,a,s,l)})):((n={}).loadingPmi=d,t.parse(n,i,r,o,null,a,s,l))},handleMaterialLoadMultiple:function(t,e,n,i,r,o,a,s,l,d,c){var h;null==n.materialsPath&&e.searchMaterialsFile&&(n.materialsPath="materials.js"),e.materialsSetting&&(i.materials=e.materialsSetting.materials),n.materialsPath&&null==e.materialsSetting?((h=new He).setCrossOrigin(t.crossOrigin),e=t.extractUrlBase(o[s]),h.load(null,e+n.materialsPath,function(e){++t.nLoadedJsonCount;e=JSON.parse(e);i.materials=e.materials,t.mergeMainJson(o[s],a[s],s,r,i),t.nLoadedJsonCount==o.length&&t.parse(null,r,o,a,null,l,d,c)},void 0,function(e){++t.nLoadedJsonCount,t.mergeMainJson(o[s],a[s],s,r,i),t.nLoadedJsonCount==o.length&&t.parse(null,r,o,a,null,l,d,c)})):(++t.nLoadedJsonCount,t.mergeMainJson(o[s],a[s],s,r,i),t.nLoadedJsonCount==o.length&&t.parse(null,r,o,a,null,l,d,c))},mergeMainJson:function(e,t,n,i,r){if(r.materials)if(null==i.materials){i.materials=r.materials;for(var o=0;o<i.materials.length;++o)i.materials[o].jsonUrl=e}else for(o=0;o<r.materials.length;++o)r.materials[o].jsonUrl=e,i.materials.push(r.materials[o]);if(r.object&&(null==i.object&&(i.object={type:"Object3D",children:[]}),i.object.children.push(r.object)),null==i.bufferchunks&&(i.bufferchunks=[]),r.buffer&&((t={buffer:t,bufferlenth:r.bufferlenth,geometries:r.geometries}).compress=r.compress,t.isChunk=!1,i.bufferchunks.push(t)),r.bufferchunks)for(o=0;o<r.bufferchunks.length;++o)r.bufferchunks[o].compress=r.compress,r.bufferchunks[o].jsonUrl=e,r.bufferchunks[o].urlIndex=n,r.bufferchunks[o].isChunk=!0,i.bufferchunks.push(r.bufferchunks[o]);if(r.solidAnimations)if(null==i.solidAnimations)i.solidAnimations=r.solidAnimations;else for(o=0;o<r.solidAnimations.length;++o)i.solidAnimations.push(r.solidAnimations[o])},setCrossOrigin:function(e){this.crossOrigin=e},extractUrlBase:function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},checkGeometries:function(e,t){if(this.needsTangents(t))for(var n=0,i=e.length;n<i;n++)e[n].computeTangents()},needsTangents:function(e){for(var t in e)if(e[t].mat instanceof THREE.ShaderMaterial)return!0;return!1},parseMorphing:function(e,t){if(t instanceof THREE.Geometry){if(null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;for(var n=0,i=e.morphTargets.length;n<i;n++){t.morphTargets[n]={},t.morphTargets[n].name=e.morphTargets[n].name,t.morphTargets[n].vertices=[];for(var r=t.morphTargets[n].vertices,o=0,a=(d=e.morphTargets[n].vertices).length;o<a;o+=3){var s=new THREE.Vector3;s.x=+d[o],s.y=+d[o+1],s.z=+d[o+2],r.push(s)}}}}else if(t instanceof THREE.BufferGeometry&&null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;var l=e.morphTargets.length;morphTargetsPosition=[],t.morphAttributes.position=morphTargetsPosition;for(n=0;n<l;n++){var d=e.morphTargets[n].vertices,c=new THREE.Float32BufferAttribute(d.length,3);c.name=e.morphTargets[n].name,morphTargetsPosition.push(c.copyArray(d))}}},parseGeometry:function(e){},parseTexGeometry:function(e){var t={size:e.textFont.size,height:0,weight:e.textFont.weight,font:this.viewer.fontsManager.Fonts.default,style:e.textFont.style,bevelEnabled:!1,curveSegments:12,steps:1};0==t.size&&(t.size=1),e.isChina&&(t.font=this.viewer.fontsManager.Fonts.simfang);t=new THREE.TextBufferGeometry(e.text,t);return t.type="TextBufferGeometry",t},parseSDFTextGeometry:function(e,t,n,i,r){var o=5<arguments.length&&void 0!==arguments[5]&&arguments[5],a=0,s=0,l=null,d=this.SDFMaker.GetMaterialStyleId(e.textFont.style,e.textFont.weight),c=this.SDFMaker.RegText(e.text);e.text=c.text;var h=e.text.length;Ue.enableTextRenderingBothSide&&(h*=2);var u=this.SDFMaker.textCompositeStride,f=this.SDFMaker.getTextGeometryBuffer(d,h),p=(f.compositeIBuffer,f.compositePositionAttrib),m=f.compositeColorAttrib,g=f.compositeUvAttrib,v=f.compositeTextureAttrib,y=f.index.array,E=4*h*this.SDFMaker.textCompositeStride,b=f.bufferOffset,M=6*h,x=f.indexOffset,w=4*h,I=b/this.SDFMaker.textCompositeStride;f.bufferOffset+=E,f.indexOffset+=M;for(var S,T,A,E=new THREE.Euler,R=new THREE.Matrix4,O=new THREE.Vector3,P=0;P<e.text.length;P++){var C=e.text[P];if(!(D=this.SDFMaker.GetDimensionsForSize(C,e.textFont.size,d,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;(c.superscript&&P>=c.superscriptbegin&&P<=c.superscriptend||c.subscript&&P>=c.subscriptbegin&&P<=c.subscriptend)&&(D.height*=.5,D.width*=.5);var B=D.height*this.SDFMaker.GetTextOffset(C,e.textFont.name);c.superscript&&P>=c.superscriptbegin&&P<=c.superscriptend&&(B-=D.height),s<D.height-B&&(s=D.height-B),p.array[b+36*P]=a,p.array[b+36*P+1]=D.height-B,p.array[b+36*P+2]=0,m.array[b+36*P+3]=i.r,m.array[b+36*P+4]=i.g,m.array[b+36*P+5]=i.b,g.array[b+36*P+6]=D.left,g.array[b+36*P+7]=D.top,v.array[b+36*P+8]=D.textureid,p.array[b+36*P+9]=a+D.width,p.array[b+36*P+10]=D.height-B,p.array[b+36*P+11]=0,m.array[b+36*P+12]=i.r,m.array[b+36*P+13]=i.g,m.array[b+36*P+14]=i.b,g.array[b+36*P+15]=D.right,g.array[b+36*P+16]=D.top,v.array[b+36*P+17]=D.textureid,p.array[b+36*P+18]=a,p.array[b+36*P+19]=-B,p.array[b+36*P+20]=0,m.array[b+36*P+21]=i.r,m.array[b+36*P+22]=i.g,m.array[b+36*P+23]=i.b,g.array[b+36*P+24]=D.left,g.array[b+36*P+25]=D.bottom,v.array[b+36*P+26]=D.textureid,p.array[b+36*P+27]=a+D.width,p.array[b+36*P+28]=-B,p.array[b+36*P+29]=0,m.array[b+36*P+30]=i.r,m.array[b+36*P+31]=i.g,m.array[b+36*P+32]=i.b,g.array[b+36*P+33]=D.right,g.array[b+36*P+34]=D.bottom,v.array[b+36*P+35]=D.textureid,y[x+6*P]=I+4*P,y[x+6*P+1]=I+4*P+2,y[x+6*P+2]=I+4*P+1,y[x+6*P+3]=I+4*P+2,y[x+6*P+4]=I+4*P+3,y[x+6*P+5]=I+4*P+1,a+=D.width}if(Ue.enableTextRenderingBothSide)for(var a=0,L=e.text.length-1,P=e.text.length;0<=L;L--,P++){var D,C=e.text[L];if(!(D=this.SDFMaker.GetDimensionsForSize(C,e.textFont.size,d,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;var H=D.height*this.SDFMaker.GetTextOffset(C,e.textFont.name);p.array[b+36*P]=a,p.array[b+36*P+1]=D.height-H,p.array[b+36*P+2]=0,m.array[b+36*P+3]=i.r,m.array[b+36*P+4]=i.g,m.array[b+36*P+5]=i.b,g.array[b+36*P+6]=D.left,g.array[b+36*P+7]=D.top,v.array[b+36*P+8]=D.textureid,p.array[b+36*P+9]=a+D.width,p.array[b+36*P+10]=D.height-H,p.array[b+36*P+11]=0,m.array[b+36*P+12]=i.r,m.array[b+36*P+13]=i.g,m.array[b+36*P+14]=i.b,g.array[b+36*P+15]=D.right,g.array[b+36*P+16]=D.top,v.array[b+36*P+17]=D.textureid,p.array[b+36*P+18]=a,p.array[b+36*P+19]=-H,p.array[b+36*P+20]=0,m.array[b+36*P+21]=i.r,m.array[b+36*P+22]=i.g,m.array[b+36*P+23]=i.b,g.array[b+36*P+24]=D.left,g.array[b+36*P+25]=D.bottom,v.array[b+36*P+26]=D.textureid,p.array[b+36*P+27]=a+D.width,p.array[b+36*P+28]=-H,p.array[b+36*P+29]=0,m.array[b+36*P+30]=i.r,m.array[b+36*P+31]=i.g,m.array[b+36*P+32]=i.b,g.array[b+36*P+33]=D.right,g.array[b+36*P+34]=D.bottom,v.array[b+36*P+35]=D.textureid,y[x+6*P+2]=I+4*P+1,y[x+6*P]=I+4*P+2,y[x+6*P+1]=I+4*P,y[x+6*P+3]=I+4*P+1,y[x+6*P+4]=I+4*P+3,y[x+6*P+5]=I+4*P+2,a+=D.width}if(this.viewer.is2DModel){if(E.setFromQuaternion(n),this.viewer.modelContentVersion<2){R.identity(),R.makeRotationFromEuler(E),R.setPosition(t);for(var N=0;N<w;++N)O.x=p.array[b+N*u],O.y=p.array[b+N*u+1],O.z=p.array[b+N*u+2],O.applyMatrix4(R),p.array[b+N*u]=O.x,p.array[b+N*u+1]=O.y,p.array[b+N*u+2]=O.z;this.SDFMaker.AddTextGeometryBuffer(f,d,r,I,w)}c.underscode&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(T=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0)),T.rotateZ(E.z),T.rotateY(E.y),T.rotateX(E.x),T.translate(t.x,t.y,t.z),(A=new THREE.LineSegments(T,S)).name=r,A.color=S.color.clone(),this.SDFMaker.AddLine(A)),c.box&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(T=new THREE.Geometry).vertices.push(new THREE.Vector3(a,s,0),new THREE.Vector3(a,0,0),new THREE.Vector3(a,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,s,0),new THREE.Vector3(0,s,0),new THREE.Vector3(a,s,0)),T.rotateZ(E.z),T.rotateY(E.y),T.rotateX(E.x),T.translate(t.x,t.y,t.z),(A=new THREE.LineSegments(T,S)).name=r,A.color=S.color.clone(),this.SDFMaker.AddLine(A)),c.dash&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(T=new THREE.Geometry).vertices.push(new THREE.Vector3(0,s,0),new THREE.Vector3(a,s,0)),T.rotateZ(E.z),T.rotateY(E.y),T.rotateX(E.x),T.translate(t.x,t.y,t.z),(A=new THREE.LineSegments(T,S)).name=r,A.color=S.color.clone(),this.SDFMaker.AddLine(A))}else(l=new(o?ae:THREE.BufferGeometry)).type="TextBufferGeometry",l.name=e.text,l.styleId=d,l.addAttribute("position",p),l.addAttribute("color",m),l.addAttribute("uv",g),l.addAttribute("textureid",v),l.setIndex(f.index),l.setDrawRange(x,M);return l},parseBufferGeometry:function(e){var t=new THREE.BufferGeometry;t.morphTargets=[],this.parseMorphing(e,t),t.bones=e.bones;var n=[],i=[];void 0!==e.animations&&null!=e.animations&&(e.animations.length?i=i.concat(e.animations):i.push(e.animations));for(var r=0;r<i.length;r++){var o=THREE.AnimationClip.parseAnimation(i[r],t.bones);o&&(this.viewer.animationsManager.bHasSkeletonAnimation=!0,o.animationUUID=i[r].uuid,n.push(o))}if(t.morphAttributes.position&&0<t.morphAttributes.position.length){var a=THREE.AnimationClip.CreateClipsFromMorphTargetSequences(t.morphAttributes.position,5);if(null!=a&&0<a.length)for(var n=n.concat(a),s=0;s<a.length;s++)a[s].uuid=e.morphInfos[s].uuid,a[s].ndsDuration=e.morphInfos[s].duration,a[s].ndsFps=e.morphInfos[s].fps}return 0<n.length&&(t.animations=n),t},parse:function(e,r,t,n,o,i,a,s){Array.isArray(t)||(o=o&&"string"==typeof o?o:this.extractUrlBase(t));var l=new se(void 0,this.manager,this.viewer),d=this,c=void 0;if(r.buffer){for(var h={},u=[],f=[],p=0,m=r.geometries.length;p<m;++p)"BufferGeometry"===r.geometries[p].type?u.push(new THREE.BufferGeometry):"Geometry"===r.geometries[p].type&&u.push(new THREE.Geometry),1==r.geometries[p].vertexColors&&(f[r.geometries[p].uuid]=!0),h[r.geometries[p].uuid]=u[p],d.manager.itemStart();var g={useWorker:!1,bufferlenth:r.bufferlenth,compress:r.compress,geometriesArray:u},v=new oe;this.manager.itemStart(),v.load(null,n,function(){},g,function(){d.parseDecals(o,r.decals,c),s&&s(!0,!0),d.manager.itemEnd()});var y=l.initMaterials(r.materials,o,r.lineType,r.fonts);d.checkGeometries(h,y);var E=d.parseObject(r.object,h,y,t,f);return(K=new THREE.Object3D).add(E),(c=K).isPmi=e.loadingPmi,r.solidAnimations&&0<(Q=d.parseSolidAnimations(r.solidAnimations,h,y)).length&&this.viewer&&(this.viewer.animationsManager.bHasSolidAnimation=!0,this.viewer.animationsManager.initSolidAnimations(K,Q)),this.viewer&&(this.viewer.materialsSetting||(this.viewer.materialsSetting=new le),e.loadingPmi||this.viewer.materialsSetting.initMaterialsInfo(y)),i&&i(K,r.lightsPreset),r.rendersetting&&(J=o+r.rendersetting,this.loader.load(null,J,function(e){a&&a(JSON.parse(e))})),d.manager.itemEnd(),K}function b(){++A===I&&d.parseDecals(o,r.decals,c);for(var e,t=!0,n=0;n<R.length;++n)for(var i=0;i<R[n].length;++i)if(null==R[n][i].boundingBox){t=!1;break}s&&(e=!1,(A===I||d.viewer.ndsModel&&d.loadCanceled&&A===d.chunkRequestFiredNum)&&(d.loadCanceled=!(e=!0)),s(e,t))}function M(){}function x(){var e,t=d.viewer.ndsModel;if(t&&t.geomManager.stopLoading){if(0<d.chunkRequestQueue.length){if(d.loadCanceled=!0,d.chunkRequestFiredNum=I-d.chunkRequestQueue.length,t.geomManager.ignorePendingBufferChunks)return void(d.chunkRequestQueue.length=0);for(var n=0,i=d.chunkRequestQueue.length;n<i;++n)t.geomManager.ignorePendingLineSegBufferChunks&&0<d.chunkRequestQueue[n].parameters.ndsGeometriesArray[0].refLineSegs.length||(d.chunkRequestQueue[n].callback=b,t.geomManager.bufferChunksToLoad.push(d.chunkRequestQueue[n]));d.chunkRequestQueue.length=0}}else 0<d.chunkRequestQueue.length&&(e=d.chunkRequestQueue.shift(),new oe({objectIdType:r.objectIdType,geomIdType:r.geomIdType,materialIdType:r.materialIdType,instanceIdType:r.instanceIdType}).load(null,e.url,M,e.parameters,b,x))}var w=function e(t){null!=t.geometry&&(d.geometryTOchild[t.geometry]||(d.geometryTOchild[t.geometry]=new Array),d.geometryTOchild[t.geometry].push(t));var n=t.children;if(n&&0<n.length)for(var i=0;i<n.length;i++)e(n[i])},h={},I=0,S=r.bufferchunks.concat();if(S){for(var T=0;T<S.length;++T)(0<S[T].bufferlenth||0==S[T].bufferlenth&&null==S[T].buffer)&&(r.bufferchunks[I]=S[T],I++);0<S.length-I&&r.bufferchunks.splice(I,S.length-I)}var A=0,R=[],O=[],f=[],P=!!d.viewer.ndsModel;e.loadingPmi&&(P=!1);d.viewer.nBufferChunks=I;var y=l.initMaterials(r.materials,o,r.lineType,r.fonts),C=new Map;if(r.fonts)for(var B=0,L=r.fonts.length;B<L;++B)C.set(r.fonts[B].uuid,r.fonts[B]);P||w(r.object);for(var D=0;D<I;++D){for(var u=[],H=[],p=0;p<r.bufferchunks[D].geometries.length;++p){var N=r.bufferchunks[D].geometries[p].type;if(null!=r.bufferchunks[D].geometries[p].id&&null!=r.bufferchunks[D].geometries[p].id||(r.bufferchunks[D].geometries[p].id=0),P){var F=r.bufferchunks[D].geometries[p].uuid;if(36===F.length&&(F=F.slice(0,8)+F.slice(9,13)+F.slice(14,18)+F.slice(19,23)+F.slice(24,36)),"PointGeometry"===N){var _=d.viewer.ndsModel.getGeomManager().getPointGeomFromUuid(F);_||((_=new NdsPointGeometry).uuid=F,d.viewer.ndsModel.getGeomManager().addPointGeom(_)),H.push(_);continue}if("BufferGeometry"===N){_=d.viewer.ndsModel.getGeomManager().getGeomFromUuid(F,r.bufferchunks[D].geometries[p].id);_||((_=new ae).geomType=r.bufferchunks[D].geometries[p].geomType,_.uuid=F,_.subGeomId=r.bufferchunks[D].geometries[p].id,_.bufferLength=r.bufferchunks[D].geometries[p].bufferLength,r.bufferchunks[D].geometries[p].box&&_.boundingBox.setFromArray(r.bufferchunks[D].geometries[p].box),r.bufferchunks[D].geometries[p].vertexColors&&(_.vertexColors=!0),d.viewer.ndsModel.getGeomManager().addGeom(_)),H.push(_),_.updateModelMatrix=!0,h[_.uuid]=_;continue}if("TextGeometry"===N){(V=d.viewer.ndsModel.getGeomManager().getGeomFromUuid(F,r.bufferchunks[D].geometries[p].id))||(Y=r.bufferchunks[D].geometries[p],r.fonts&&(Y.textFont=C.get(Y.textFont.uuid||Y.textFont)),G=new THREE.Vector3,Y.position&&(G.x=Y.position.x,G.y=Y.position.y,G.z=Y.position.z),W=new THREE.Quaternion,void 0!==Y.angle&&W.setFromAxisAngle(new THREE.Vector3(0,0,1),Y.angle),z=new THREE.Color,"unLoad"==(V=this.SDFMaker.ParseSDFTextGeometry(Y,G,W,z,r.bufferchunks[D].geometries[p].uuid,!0,Y.isMirroredInX,Y.isMirroredInY,!1,this.viewer.is2DModel,this.viewer.modelContentVersion)).textLoad&&this.SDFMaker.AddShxTextInfo({jsonText:Y,geomuuid:F,id:r.bufferchunks[D].geometries[p].id}),V.text=Y.text,V.uuid=F,V.isTextGeometry=!0,V.subGeomId=r.bufferchunks[D].geometries[p].id,V.bufferLength=r.bufferchunks[D].geometries[p].bufferLength,V.position=G,V.quaternion=W,d.viewer.ndsModel.getGeomManager().addGeom(V),F="text:"+V.styleId,d.viewer.ndsModel.getMeshManager().materials[F]||(d.viewer.ndsModel.getMeshManager().materials[F]={mat:this.SDFMaker.GetMaterial(V.styleId),refCount:0})),H.push(V),V.updateModelMatrix=!0,h[V.uuid]=V;continue}}if("BufferGeometry"===N){var k=this.parseBufferGeometry(r.bufferchunks[D].geometries[p]);u.push(k)}else if("Geometry"===N){k=new THREE.Geometry;u.push(k)}else if("TextGeometry"===N){var V,j=this.geometryTOchild[r.bufferchunks[D].geometries[p].uuid];if(j)if(this.viewer.is2DModel)for(var U=0;U<j.length;++U){var z=y[(X=j[U]).material].mat.color,G=new THREE.Vector3,W=new THREE.Quaternion;X.position?(G.set(X.position[0],X.position[1],X.position[2]),W.setFromAxisAngle(new THREE.Vector3(0,0,1),X.angle)):X.matrix&&((Z=new THREE.Matrix4).fromArray(X.matrix),q=new THREE.Vector3,Z.decompose(G,W,q));var Y=r.bufferchunks[D].geometries[p];r.fonts&&(Y.textFont=C.get(Y.textFont.uuid||Y.textFont)),V=this.parseSDFTextGeometry(Y,G,W,z,X.uuid),u.push(V)}else{var X,Z,q,z=y[(X=j[0]).material].mat.color,G=new THREE.Vector3,W=new THREE.Quaternion;X.position?(G.set(X.position[0],X.position[1],X.position[2]),W.setFromAxisAngle(new THREE.Vector3(0,0,1),X.angle)):X.matrix&&((Z=new THREE.Matrix4).fromArray(X.matrix),q=new THREE.Vector3,Z.decompose(G,W,q));Y=r.bufferchunks[D].geometries[p];r.fonts&&(Y.textFont=C.get(Y.textFont.uuid||Y.textFont)),V=this.parseSDFTextGeometry(Y,G,W,z,X.uuid),u.push(V)}else{Y=r.bufferchunks[D].geometries[p];r.fonts&&(Y.textFont=C.get(Y.textFont));G=new THREE.Vector3;Y.position&&(G.x=Y.position.x,G.y=Y.position.y,G.z=Y.position.z);W=new THREE.Quaternion;void 0!==Y.angle&&W.setFromAxisAngle(new THREE.Vector3(0,0,1),Y.angle);z=new THREE.Color;V=this.parseSDFTextGeometry(Y,G,W,z,r.bufferchunks[D].geometries[p].uuid),u.push(V)}}h[r.bufferchunks[D].geometries[p].uuid]=u[p],null!=r.bufferchunks[D].urlIndex&&(h[r.bufferchunks[D].geometries[p].uuid].urlIndex=r.bufferchunks[D].urlIndex),u[p]&&r.bufferchunks[D].geometries[p].box&&(u[p].boundingBox=new THREE.Box3,u[p].boundingBox.setFromArray(r.bufferchunks[D].geometries[p].box)),1==r.bufferchunks[D].geometries[p].vertexColors&&(f[r.bufferchunks[D].geometries[p].uuid]=!0)}R.push(u),O.push(H)}this.geometryTOchild={},P||d.checkGeometries(h,y),P&&d.viewer.ndsModel.getMeshManager().setMaterials(y);var Q,J,K=new THREE.Object3D;if(P){var $={},n={},ee={};if(r.instances)for(var te=0,ne=r.instances.length;te<ne;++te)r.instances[te].geometries&&(ee[r.instances[te].uuid]={geometries:r.instances[te].geometries,materials:r.instances[te].materials});l=[],w=d.parseNdsModelObject(r.object,$,n,ee,0,l);if(w.pmiuuid=l,d.viewer.ndsModel.setRootBodyNode(w,$,n),K.boundingBox=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),1==Ue.inAssemblyContext&&this.viewer.ndsModel.bvh.bboxes&&6<=this.viewer.ndsModel.bvh.bboxes.length&&!this.viewer.is2DModel?(n=this.viewer.ndsModel.bvh.bboxes.slice(0,6),K.boundingBox.setFromArray(n)):r.bbox&&K.boundingBox.setFromArray(r.bbox),0<this.SDFMaker.lines.length){var ie=new THREE.Group;ie.name="dashLine";for(T=0;T<this.SDFMaker.lines.length;T++)ie.add(this.SDFMaker.lines[T]);this.viewer.scene.add(ie)}}else{E=d.parseObject(r.object,h,y,t,f);if(this.SDFMaker.HaveSDF()&&this.viewer.is2DModel&&this.viewer.modelContentVersion<2){E.add(this.SDFMaker.CreateMesh());for(T=0;T<this.SDFMaker.lines.length;T++)E.add(this.SDFMaker.lines[T])}else E.updateMatrixWorld(!0);K.add(E)}(c=K).isPmi=e.loadingPmi,r.solidAnimations&&0<(Q=d.parseSolidAnimations(r.solidAnimations,h,y)).length&&this.viewer&&(this.viewer.animationsManager.bHasSolidAnimation=!0,this.viewer.animationsManager.initSolidAnimations(K,Q)),this.viewer&&(this.viewer.materialsSetting||(this.viewer.materialsSetting=new le(this.viewer)),e.loadingPmi||this.viewer.materialsSetting.initMaterialsInfo(y)),i&&i(K,r.lightsPreset,!1),r.rendersetting&&(J=o+r.rendersetting,this.loader.load(null,J,function(e){a&&a(JSON.parse(e))}));performance.now().toFixed(0);for(var re,D=0;D<I;++D)null!=r.bufferchunks[D].buffer?(u=R[D],H=P?O[D]:null,re=o+r.bufferchunks[D].buffer,g={useWorker:!0,bufferlenth:r.bufferchunks[D].bufferlenth,compress:r.compress,bufferIndex:D,geometriesArray:P?null:u,ndsGeometriesArray:H},null!=r.bufferchunks[D].compress&&(g.compress=r.bufferchunks[D].compress),r.bufferchunks[D].jsonUrl&&(re=this.extractUrlBase(r.bufferchunks[D].jsonUrl)+r.bufferchunks[D].buffer),0==r.bufferchunks[D].isChunk&&(re=r.bufferchunks[D].buffer),D<d.maxRequestNum?(v=new oe({objectIdType:r.objectIdType,materialIdType:r.materialIdType,geomIdType:r.geomIdType,instanceIdType:r.instanceIdType}),e.loadingPmi?v.load(null,re,M,g,s):v.load(null,re,M,g,b,x)):d.chunkRequestQueue.push({url:re,parameters:g}),P&&(d.viewer.ndsModel.getGeomManager().bufferChunk[re]=g)):++A;return 0==I&&s&&s(!0,!0),K},parseSolidAnimations:function(e,t,n){if(e.length<=0)return null;for(var i,r,o,a=[],s=0;s<e.length;s++)null!=e[s].fps&&(e[s].fps=parseFloat(e[s].fps)),null!=e[s].duration&&(e[s].duration=parseFloat(e[s].duration)),null!=e[s].fps&&null!=e[s].duration&&(e[s].fps<=0||e[s].duration<=0||(i=THREE.AnimationClip.parse(e[s]),null!=e[s].uuid&&(i.uuid=e[s].uuid),null!=e[s].fps&&(i.fps=parseFloat(e[s].fps)),e[s].animationObject&&(r=this.parseObject(e[s].animationObject,t,n,null),(o=new THREE.Object3D).add(r),i.animationScene=new THREE.Scene,i.animationScene.autoUpdate=!1,i.animationScene.add(o)),a.push(i)));return a},parseDecals:function(e,t,n){if(void 0!==t&&void 0!==n){var i={},r={},o={},a=new THREE.Object3D;a.type="decals",n.add(a),n.updateMatrixWorld(!0);for(var s=0;s<t.length;++s){var l,d=void 0,d=new(void 0!==this.viewer.convertPhongToPBR&&this.viewer.convertPhongToPBR?THREE.MeshStandardMaterial:THREE.MeshPhongMaterial);i[t[s].uuid]=t[s],d.map=(new D).loadTexture(d,r,e+t[s].textureFile,void 0,void 0,NDS.TextureLoadingManager.onError),o[t[s].uuid]=d,void 0===t[s].opacity||(l=parseFloat(t[s].opacity))<1&&(d.transparent=!0,d.opacity=l)}this.traverseDecals(a,n,o,i),a.matrixAutoUpdate=!1,a.matrixWorldNeedsUpdate=!1,a.updateMatrixWorld(!0)}},traverseDecals:function(e,t,n,i){if(null!=t&&t instanceof THREE.Object3D&&!(t instanceof THREE.Light))if(void 0===t.decals){if(null!=t.children)for(c=t.children,h=0;h<c.length;++h)this.traverseDecals(e,t.children[h],n,i)}else if(t.hasOwnProperty("geometry"))for(var r=0;r<t.decals.length;++r){var o=i[t.decals[r]],a=n[t.decals[r]],s=new THREE.Vector3(o.origin[0],o.origin[1],o.origin[2]),l=new THREE.Vector3(o.vecX[0],o.vecX[1],o.vecX[2]),d=new THREE.Vector3(o.vecY[0],o.vecY[1],o.vecY[2]);s.addScaledVector(l,.5),s.addScaledVector(d,.5),"MapPlanar"===o.mappingType&&(o=new f(t,s,l,d,o.projectionType),(a=new THREE.Mesh(o,a)).matrixAutoUpdate=!1,a.matrixWorldNeedsUpdate=!1,a.updateMatrixWorld(!0),e.add(a))}else for(var c=t.children,h=0;h<c.length;++h)this.traverseChild(t.decals,e,t.children[h],n,i)},traverseChild:function(e,t,n,i,r){if(null!=n&&n instanceof THREE.Object3D&&!(n instanceof THREE.Light))if(void 0===e){if(null!=n.children)for(var o=n.children,a=0;a<o.length;++a)this.traverseChild(e,t,n.children[a],i,r)}else if(n.hasOwnProperty("geometry"))for(var s=0;s<e.length;++s){var l=r[e[s]],d=i[e[s]],c=new THREE.Vector3(l.origin[0],l.origin[1],l.origin[2]),h=new THREE.Vector3(l.vecX[0],l.vecX[1],l.vecX[2]),u=new THREE.Vector3(l.vecY[0],l.vecY[1],l.vecY[2]);c.addScaledVector(h,.5),c.addScaledVector(u,.5),"MapPlanar"===l.mappingType&&(l=new f(n,c,h,u,l.projectionType),(d=new THREE.Mesh(l,d)).matrixAutoUpdate=!1,d.matrixWorldNeedsUpdate=!1,d.updateMatrixWorld(!0),t.add(d))}},parseGeometries:function(e){var t={};if(void 0!==e)for(var n=new se,i=new THREE.BufferGeometryLoader,r=0,o=e.length;r<o;r++){var a,s=e[r];switch(s.type){case"PlaneGeometry":a=new THREE.PlaneGeometry(s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":a=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":a=new THREE.CircleGeometry(s.radius,s.segments);break;case"CylinderGeometry":a=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded);break;case"SphereGeometry":a=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"IcosahedronGeometry":a=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"TorusGeometry":a=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":a=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":a=i.parse(s.data);break;case"Geometry":a=n.parse(s.data).geometry}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t},parseMaterials:function(e){var t={};if(void 0!==e)for(var n=new THREE.MaterialLoader,i=0,r=e.length;i<r;i++){var o=e[i],a=n.parse(o);a.uuid=o.uuid,void 0!==o.name&&(a.name=o.name),t[o.uuid]=a}return t},parseLink:function(e,a,s,l,t){var d=this,c=this.extractUrlBase(t)+e.linkPath;this.manager.itemStart(),this.loader.load(null,c,function(e){var t=JSON.parse(e);if(t.buffer){for(var n={},i=[],r=0;r<t.geometries.length;++r)"BufferGeometry"===t.geometries[r].type?i.push(new THREE.BufferGeometry):"Geometry"===t.geometries[r].type&&i.push(new THREE.Geometry),n[t.geometries[r].uuid]=i[r];var e=d.extractUrlBase(c)+t.buffer,o={useWorker:!0,bufferlenth:t.bufferlenth,compress:t.compress,geometriesArray:i};(new oe).load(null,e,function(){d.manager.itemEnd()},o),d.checkGeometries(n,l);o=d.parseObject(t.object,n,l,c);a.add(o),d.onLinkComplete(a.linkID)}else{o=d.parseObject(t.object,s,l,c);a.add(o),d.onLinkComplete(a.linkID)}})},recordLink:function(e,t){return null==this.linkMap[e]&&(this.linkMap[e]=t,!(this.linkDoneMap[e]=!1))},addWaitingLink:function(e,t){var n=this.linkWaitingArray[e];null==n&&(this.linkWaitingArray[e]=n=[]),n.push(t)},cloneObject:function(e,t){var n=null;if(null!=e.linkID?((n=e.clone(void 0,t=!1)).linkID=e.linkID,this.isLinkComplete(n.linkID)?this.processLoadedLink(n,this.getCompleteLink(n.linkID)):this.addWaitingLink(n.linkID,n)):n=e.clone(void 0,!1),n.uuid=e.uuid,n.type=e.type,!0===t)for(var i=0;i<e.children.length;i++){var r=e.children[i];n.add(this.cloneObject(r,t))}return n},processLoadedLink:function(e,t){for(var n=0;n<t.children.length;n++)e.add(this.cloneObject(t.children[n],!0))},isLinkComplete:function(e){return this.linkDoneMap[e]},getCompleteLink:function(e){return this.linkMap[e]},onLinkComplete:function(e){this.linkDoneMap[e]=!0;for(var t=this.linkWaitingArray[e],n=0;n<t.length;n++)this.processLoadedLink(t[n],this.linkMap[e])},parseObject:(te=new THREE.Matrix4,function(e,t,n,i,r){var o=i;switch(e.type){case"Scene":s=new THREE.Scene;break;case"PerspectiveCamera":s=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":s=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":s=new THREE.AmbientLight(e.color);break;case"DirectionalLight":s=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":s=new THREE.PointLight(e.color,e.intensity,e.distance);break;case"SpotLight":s=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent);break;case"HemisphereLight":s=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":if(null==(l=t[e.geometry]))return null;if("TextBufferGeometry"!==l.type||this.viewer.is2DModel){if("TextBufferGeometry"===l.type&&this.viewer.is2DModel)return null;36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36));var a=n[e.material];r&&r[e.geometry]&&a.mat&&(a.mat.vertexColors=THREE.VertexColors),++a.refCount,void 0===l&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===a&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Mesh(l,a.mat)}else var a=this.SDFMaker.GetMaterial(l.styleId),s=new THREE.Mesh(l,a);null!=l.urlIndex&&(s.urlIndex=l.urlIndex);break;case"Line":var l=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(a=n[e.material]).refCount,void 0===l&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===a&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Line(l,a.mat),null!=l.urlIndex&&(s.urlIndex=l.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==Ue.tangentEdgeVisible&&(s.visible=!1));break;case"LineStrip":l=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(a=n[e.material]).refCount,void 0===l&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===a&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Line(l,a.mat,THREE.LineStrip),null!=l.urlIndex&&(s.urlIndex=l.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==Ue.tangentEdgeVisible&&(s.visible=!1));break;case"LinePieces":l=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(a=n[e.material]).refCount,void 0===l&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===a&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.LineSegments(l,a.mat),null!=l.urlIndex&&(s.urlIndex=l.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==Ue.tangentEdgeVisible&&(s.visible=!1));break;case"Sprite":36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),void 0===(a=n[e.material])&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Sprite(a.mat);break;case"Group":s=new THREE.Group;break;case"Link":(s=new THREE.Object3D).type="Link",s.linkID=e.linkID,this.recordLink(e.linkID,s)?this.parseLink(e,s,t,n,o):this.isLinkComplete(e.linkID)?this.processLoadedLink(s,this.getCompleteLink(e.linkID)):this.addWaitingLink(e.linkID,s);break;default:s=new THREE.Object3D,void 0!==e.type&&(s.type=e.type)}if(void 0!==e.uuid?s.uuid=e.uuid:(s.uuid=this.treeIndex.toString(),++this.treeIndex),s.name=s.uuid,void 0!==e.propertyfile&&(s.propertyfile=e.propertyfile,this.viewer.containProperty=!0),void 0!==e.matrix?(te.fromArray(e.matrix),te.decompose(s.position,s.quaternion,s.scale)):(void 0!==e.position&&s.position.fromArray(e.position),void 0!==e.rotation&&s.rotation.fromArray(e.rotation),void 0!==e.scale&&s.scale.fromArray(e.scale)),s.updateMatrixWorld(!0),s.originMatrixWorld=s.matrixWorld.clone(),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.userData&&(s.userData=e.userData),void 0!==e.decals&&(s.decals=e.decals),!this.viewer.isPartPmi()&&!this.viewer.isAssemblyPmi()||this.viewer.pmiVisible||"PMI"==s.type||"Object3D"==s.type||(s.visible=!1),void 0!==e.children)for(var d=0;d<e.children.length;++d){var c=this.parseObject(e.children[d],t,n,i,r);null!=c&&s.add(c)}return s.updateMatrix(),s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1,s}),setVisibleOfChild:function(e){for(var t in e.children)e.children[t].visible=!1,this.setVisibleOfChild(e.children[t])},parseNdsModelObject:function(e,t,n,i,r,o){var a=new De;if(a.unload=!1,void 0!==e.uuid?(a.uuid=e.uuid,36===a.uuid.length&&"-"==a.uuid.charAt(8)&&"-"==a.uuid.charAt(13)&&"-"==a.uuid.charAt(18)&&"-"==a.uuid.charAt(23)&&(a.uuid=a.uuid.slice(0,8)+a.uuid.slice(9,13)+a.uuid.slice(14,18)+a.uuid.slice(19,23)+a.uuid.slice(24,36)),a.uuid=a.uuid.toLowerCase()):(a.uuid=this.treeIndex.toString(),++this.treeIndex),void 0!==e.objectid?(a.objectid=e.objectid,this.viewer.ndsModel.objectidTouuid[e.objectid]=a.uuid):this.viewer.ndsModel.objectidTouuid&&(this.viewer.ndsModel.objectidTouuid=null),void 0!==e.name?a.name=e.name:a.name=a.uuid,void 0!==e.propertyfile&&(a.propertyfile=e.propertyfile,this.viewer.containProperty=!0),this.viewer.useUnvisibleList||void 0===e.visible||(a.visible=e.visible),void 0!==e.fixed&&(a.fixed=e.fixed),void 0!==e.matrix&&(a.matrix=e.matrix.slice(0)),void 0!==e.worldMatrix&&(a.worldMatrix=e.worldMatrix.clone()),a.type=e.type,null!=e.pmiuuid&&(a.pmiuuid=e.pmiuuid,"Assembly"!==e.type&&"Model"!==e.type?(this.viewer.haspartPMI=!0,this.viewer.PartPMIuuid.push(e.pmiuuid)):(this.viewer.hasAssemblyPMI=!0,o&&o.push.apply(o,ee(e.pmiuuid)))),void 0!==e.children){"Body"===e.children[0].type&&(r=0);for(var s=0;s<e.children.length;s++){var l,d=e.children[s];if("Mesh"!==d.type&&"Line"!==d.type&&"LinePieces"!==d.type){if("Instance"!==d.type)"RefPoint"!==d.type&&"RefAxis"!==d.type&&"RefPlane"!==d.type?((l=this.parseNdsModelObject(d,t,n,i,r,o)).parent=a,"Body"===d.type&&r++,("Body"===d.type||!Ue.inBIMContext||l.children&&0!=l.children.length)&&(void 0!==a.visible&&0==a.visible&&(l.visible=!1,this.setVisibleOfChild(l)),a.children.push(l),"CoordSystem"===d.type&&d.visible&&a.setComponentCoordinateSysVisibility(!0))):(l={parentNode:a,uuid:d.uuid,type:d.type,name:d.name,visible:d.visible,coords:d.points},this.viewer.ndsModel.addReferenceEntity(l),"RefAxis"===d.type&&d.visible&&a.setComponentRefAxisVisibility(!0),"RefPlane"===d.type&&d.visible&&a.setComponentRefPlaneVisibility(!0));else if(i.hasOwnProperty(d.instance))for(var c=i[d.instance],h=0,u=c.geometries.length;h<u;++h){t[a.uuid+":"+h]=c.geometries[h];var f=c.materials[h];36===f.length&&"-"==f.charAt(8)&&"-"==f.charAt(13)&&"-"==f.charAt(18)&&"-"==f.charAt(23)&&(f=f.slice(0,8)+f.slice(9,13)+f.slice(14,18)+f.slice(19,23)+f.slice(24,36)),this.viewer.ndsModel.getMeshManager().materials[f].refCount++}}else"Line"!==d.type&&"LinePieces"!==d.type||!d.tangentEdgeObject||(n[d.geometry]=!0),36===d.material.length&&"-"==d.material.charAt(8)&&"-"==d.material.charAt(13)&&"-"==d.material.charAt(18)&&"-"==d.material.charAt(23)&&(d.material=d.material.slice(0,8)+d.material.slice(9,13)+d.material.slice(14,18)+d.material.slice(19,23)+d.material.slice(24,36)),this.viewer.ndsModel.getMeshManager().materials[d.material].refCount++,t[d.uuid]=d.geometry}}return"Body"!=e.type?void 0!==e.fileguid&&(a.fileguid=e.fileguid,this.viewer.ndsModel.fileguidTouuid[a.fileguid]||(this.viewer.ndsModel.fileguidTouuid[a.fileguid]=[]),"Model"==e.type&&1==e.children.length&&"Part"==e.children[0].type?this.viewer.ndsModel.fileguidTouuid[a.fileguid].push(e.children[0].uuid):this.viewer.ndsModel.fileguidTouuid[a.fileguid].push(a.uuid)):a.BodyfileID=r,a}};function ne(e,t,n){this.baseUrl=e,this.options=t,this.crossOrigin=n}n(121);ne.prototype={constructor:ne,load:function(e,t,n,i){var r=this,o=new THREE.XHRLoader;o.setCrossOrigin(this.crossOrigin),o.load(e,function(e){t(r.parse(e))},n,i)},parse:function(e){for(var t=e.split("\n"),n={},i=/\s+/,r={},o=0;o<t.length;o++){var a,s,l=(l=t[o]).trim();0!==l.length&&"#"!==l.charAt(0)&&(a=(a=0<=(s=l.indexOf(" "))?l.substring(0,s):l).toLowerCase(),l=(l=0<=s?l.substring(s+1):"").trim(),"newmtl"===a?r[l]=n={name:l}:n&&("ka"===a||"kd"===a||"ks"===a?(s=l.split(i,3),n[a]=[parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])]):n[a]=l))}e=new ne.MaterialCreator(this.baseUrl,this.options);return e.setMaterials(r),e}},(ne.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping}).prototype={constructor:ne.MaterialCreator,setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t,n={};for(t in e){var i,r=e[t],o={};for(i in n[t]=o,r){var a=!0,s=r[i],l=i.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(s=[s[0]/255,s[1]/255,s[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===s[0]&&0===s[1]&&0===s[1]&&(a=!1);break;case"d":this.options&&this.options.invertTransparency&&(s=1-s)}a&&(o[l]=s)}}return n},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e,t=0;for(e in this.materialsInfo)this.materialsArray[t]=this.create(e),this.nameLookup[e]=t,t++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t,n=this.materialsInfo[e],i={name:e,side:this.side};for(t in n){var r=n[t];switch(t.toLowerCase()){case"kd":i.diffuse=(new THREE.Color).fromArray(r);break;case"ka":i.ambient=(new THREE.Color).fromArray(r);break;case"ks":i.specular=(new THREE.Color).fromArray(r);break;case"map_kd":i.map=this.loadTexture(this.baseUrl+r),i.map.wrapS=this.wrap,i.map.wrapT=this.wrap;break;case"ns":i.shininess=r;break;case"d":r<1&&(i.transparent=!0,i.opacity=r)}}return i.diffuse&&(i.ambient||(i.ambient=i.diffuse),i.color=i.diffuse),this.materials[e]=new THREE.MeshPhongMaterial(i),this.materials[e]},loadTexture:function(e,t,n,i){var r,o=THREE.Loader.Handlers.get(e);return null!==o?r=o.load(e,n):(r=new THREE.Texture,(o=new THREE.ImageLoader).crossOrigin=this.crossOrigin,o.load(e,function(e){r.image=ne.ensurePowerOfTwo_(e),r.needsUpdate=!0,n&&n(r)})),r.mapping=t,r}},ne.ensurePowerOfTwo_=function(e){if(THREE.Math.isPowerOfTwo(e.width)&&THREE.Math.isPowerOfTwo(e.height))return e;var t=document.createElement("canvas");return t.width=ne.nextHighestPowerOfTwo_(e.width),t.height=ne.nextHighestPowerOfTwo_(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t},ne.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},ne.prototype=Object.create(THREE.EventDispatcher.prototype);var _e=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager};_e.prototype={constructor:_e,load:function(t,e,i,r,o){function n(e){var n=e;n&&n.preload();e=new THREE.XHRLoader(a.manager);e.setCrossOrigin(this.crossOrigin),e.load(t,function(e){e=a.parse(e);e.traverse(function(e){var t;e instanceof THREE.Mesh&&(!e.material.name||(t=n?n.create(e.material.name):null)&&(e.material=t))}),i(e)},r,o)}var a=this;e?new ne(t.substr(0,t.lastIndexOf("/")+1)).load(e,n,r,o):n()},parse:function(e,t){function n(e,t,n){return new THREE.Vector3(e,t,n)}function r(e,t,n,i){return new THREE.Face3(e,t,n,i)}var o=0;function i(e,t){0<h.length&&(l.vertices=h,l.mergeVertices(),l.computeFaceNormals(),l.computeBoundingSphere(),s.add(c),l=new THREE.Geometry,c=new THREE.Mesh(l,d)),void 0!==e&&(c.name=e),void 0!==t&&((d=new THREE.MeshLambertMaterial).name=t,c.material=d)}var a=new THREE.Group,s=a,l=new THREE.Geometry,d=new THREE.MeshLambertMaterial,c=new THREE.Mesh(l,d),h=[],u=[],f=[];function p(e,t,n,i){void 0===i?l.faces.push(r(parseInt(e)-(o+1),parseInt(t)-(o+1),parseInt(n)-(o+1))):l.faces.push(r(parseInt(e)-(o+1),parseInt(t)-(o+1),parseInt(n)-(o+1),[u[parseInt(i[0])-1].clone(),u[parseInt(i[1])-1].clone(),u[parseInt(i[2])-1].clone()]))}function m(e,t,n){l.faceVertexUvs[0].push([f[parseInt(e)-1].clone(),f[parseInt(t)-1].clone(),f[parseInt(n)-1].clone()])}function g(e,t,n){void 0===e[3]?(p(e[0],e[1],e[2],n),void 0!==t&&0<t.length&&m(t[0],t[1],t[2])):(void 0!==n&&0<n.length?(p(e[0],e[1],e[3],[n[0],n[1],n[3]]),p(e[1],e[2],e[3],[n[1],n[2],n[3]])):(p(e[0],e[1],e[3]),p(e[1],e[2],e[3])),void 0!==t&&0<t.length&&(m(t[0],t[1],t[3]),m(t[1],t[2],t[3])))}for(var v,y,E=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,b=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,M=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,x=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,w=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,I=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,S=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,T=e.split("\n"),A=0;A<T.length;A++){var R,O=(O=T[A]).trim();0!==O.length&&"#"!==O.charAt(0)&&(null!==(R=E.exec(O))?h.push(n(parseFloat(R[1]),parseFloat(R[2]),parseFloat(R[3]))):null!==(R=b.exec(O))?u.push(n(parseFloat(R[1]),parseFloat(R[2]),parseFloat(R[3]))):null!==(R=M.exec(O))?f.push((v=parseFloat(R[1]),y=parseFloat(R[2]),new THREE.Vector2(v,y))):null!==(R=x.exec(O))?g([R[1],R[2],R[3],R[4]]):null!==(R=w.exec(O))?g([R[2],R[5],R[8],R[11]],[R[3],R[6],R[9],R[12]]):null!==(R=I.exec(O))?g([R[2],R[6],R[10],R[14]],[R[3],R[7],R[11],R[15]],[R[4],R[8],R[12],R[16]]):null!==(R=S.exec(O))?g([R[2],R[5],R[8],R[11]],[],[R[3],R[6],R[9],R[12]]):/^o /.test(O)?(i(),o+=h.length,h=[],(s=new THREE.Object3D).name=O.substring(2).trim(),a.add(s)):/^g /.test(O)?i(O.substring(2).trim(),void 0):/^usemtl /.test(O)?i(void 0,O.substring(7).trim()):/^mtllib /.test(O)?t&&t(O.substring(7).trim()):/^s /.test(O)||console.log("OBJMTLLoader: Unhandled line "+O))}return i(void 0,void 0),a}},_e.prototype=Object.create(THREE.EventDispatcher.prototype);function ie(){this.skingMesh=null,this.actions=[],this.actionMap={}}function re(){this.mixer=null,this.actionSkinMeshs=[]}function de(e,t){var r=this;this.viewer=e;var o=new NDS.Dialog({id:"dlgOpMeasure",className:"dialog",callbackEvent:d,title:"Measure Selection",noTitlebar:!0,noScrollbar:!0});o.setVisibility(!1),o.setSize(150,570),o.setOpacity(Ue.dialogOpacity),e.container.appendChild(o.domElement),this.dialog=o;var n=new NDS.Element({className:"dialog-content"});o.setContent(n);var i,a,s=new NDS.Table,e="radioGroup",l={idRadioPointToPoint:"radioPointToPoint",idRadioPointToFace:"radioPointToFace",idRadioFaceDist:"radioFaceDist",idRadioFaceThickness:"radioFaceThickness",idRadioFaceAngle:"radioFaceAngle",idRadioMeasureEdges:"radioMeasureEdges",idRadioMeasureFaceArea:"radioFaceArea",idRadioMeasureFacePerimeter:"radioFacePerimeter",idRadioMeasureBoundingBox:"radioFaceBoundingBox",idRadioMeasureHoleDist:"radioHoleDist",idRadioMeasureRadius:"radioRadius",idRadioMeasureDiameter:"radioDiameter",idRadioMeasureDistance:"radioDistance",idRadioMeasureLineAngle:"radioLineAngle",idRadioMeasureBodyArea:"radioBodyArea",idRadioMeasureBodyVolume:"radioBodyVolume",idRadioMeasureTotalArea:"radioTotalArea",idRadioMeasureBodyAngle:"radioBodyAngle",idRadioMeasureBodyEdgeLength:"radioBodyEdgeLength",idRadioMeasureBodyDistance:"radioBodyDistance"};function d(e){var t=e.target.domElement.id;switch(t){case"dlgOpMeasure":!function(e){var t=e.event.type,n=e.target;switch(t){case"mouseenter":n.deleteOpacity();break;case"mouseleave":n.setOpacity(Ue.dialogOpacity);break;case"mouseover":n.deleteOpacity();break;case"mouseout":n.setOpacity(Ue.dialogOpacity)}}(e);break;case l.idRadioPointToPoint:"click"===e.event.type&&c(l.idRadioPointToPoint);break;case l.idRadioPointToFace:"click"===e.event.type&&c(l.idRadioPointToFace);break;case l.idRadioFaceDist:"click"===e.event.type&&c(l.idRadioFaceDist);break;case l.idRadioFaceThickness:"click"===e.event.type&&c(l.idRadioFaceThickness);break;case l.idRadioFaceAngle:"click"===e.event.type&&c(l.idRadioFaceAngle);break;case l.idRadioMeasureEdges:"click"===e.event.type&&c(l.idRadioMeasureEdges);break;case l.idRadioMeasureFaceArea:"click"===e.event.type&&c(l.idRadioMeasureFaceArea);break;case l.idRadioMeasureFacePerimeter:"click"===e.event.type&&c(l.idRadioMeasureFacePerimeter);break;case l.idRadioMeasureBoundingBox:"click"===e.event.type&&c(l.idRadioMeasureBoundingBox);break;case l.idRadioMeasureHoleDist:"click"===e.event.type&&c(l.idRadioMeasureHoleDist);break;case l.idRadioMeasureRadius:"click"===e.event.type&&c(l.idRadioMeasureRadius);break;case l.idRadioMeasureDiameter:"click"===e.event.type&&c(l.idRadioMeasureDiameter);break;case l.idRadioMeasureDistance:"click"===e.event.type&&c(l.idRadioMeasureDistance);break;case l.idRadioMeasureLineAngle:"click"===e.event.type&&c(l.idRadioMeasureLineAngle);break;case l.idRadioMeasureBodyAngle:"click"===e.event.type&&c(l.idRadioMeasureBodyAngle);break;case l.idRadioMeasureBodyEdgeLength:"click"===e.event.type&&c(l.idRadioMeasureBodyEdgeLength);break;case l.idRadioMeasureBodyDistance:"click"===e.event.type&&c(l.idRadioMeasureBodyDistance);break;default:r.viewer.setMeasureOpType(t)}}function c(e){e=function(e){var t=null;switch(e){case l.idRadioPointToPoint:t="pt2pt";break;case l.idRadioPointToFace:t="LineAngle";break;case l.idRadioFaceDist:t="faceDist";break;case l.idRadioFaceThickness:t="faceThickness";break;case l.idRadioFaceAngle:t="faceAngle";break;case l.idRadioMeasureEdges:t="measureEdges";break;case l.idRadioMeasureFaceArea:t="faceArea";break;case l.idRadioMeasureFacePerimeter:t="facePerimeter";break;case l.idRadioMeasureBoundingBox:t="BoundingBox";break;case l.idRadioMeasureHoleDist:t="holeDist";break;case l.idRadioMeasureRadius:t="radius";break;case l.idRadioMeasureDiameter:t="contourarea";break;case l.idRadioMeasureDistance:t="Lineargauge";break;case l.idRadioMeasureLineAngle:t="lineAngle";break;case l.idRadioMeasureBodyAngle:t="bodyAngle";break;case l.idRadioMeasureBodyEdgeLength:t="bodyEdgeLength";break;case l.idRadioMeasureBodyDistance:t="bodyDistance"}return t}(e);e&&(r.viewer.setMeasureOpType(e),ye.isMobileDevice()&&r.viewer.Optoolbar&&r.viewer.Optoolbar.getMeasureDlg().show(!1))}t?(this.viewer.is2DModel?o.setSize(150,188):o.setSize(150,338),s.addRow(),i=new NDS.Input({id:"PointToLine",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"点到线"}),s.addCol({element:a}),s.addRow(),this.viewer.is2DModel||(i=new NDS.Input({id:"PointToFace",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"点到面"}),s.addCol({element:a})),s.addRow(),i=new NDS.Input({id:"LineToLine",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"线到线"}),s.addCol({element:a}),this.viewer.is2DModel||(s.addRow(),i=new NDS.Input({id:"LineToFace",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"线到面"}),s.addCol({element:a})),s.addRow(),i=new NDS.Input({id:"AxisToPoint",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"孔轴到点"}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:"AxisToLine",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"孔轴到线"}),s.addCol({element:a}),this.viewer.is2DModel||(s.addRow(),i=new NDS.Input({id:"AxisToFace",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"孔轴到面"}),s.addCol({element:a})),s.addRow(),i=new NDS.Input({id:"LineAngle",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"线夹角"}),s.addCol({element:a}),this.viewer.is2DModel||(s.addRow(),i=new NDS.Input({id:"LineFaceAngle",name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:"线面夹角"}),s.addCol({element:a}))):(s.addRow(),i=new NDS.Input({id:l.idRadioMeasureBodyAngle,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_BODY_ANGLE")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureBodyEdgeLength,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_BODY_LENGTH")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureBodyDistance,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_BODY_DISATANCE")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioPointToPoint,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_DIST")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioPointToFace,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_ANGLE")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioFaceDist,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_FACE_DIST")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioFaceThickness,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_FACE_THICKNESS")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioFaceAngle,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_FACE_ANGLE")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureEdges,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_MEASURE_EDGES")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureFaceArea,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_FACE_AREA")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureFacePerimeter,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_FACE_PERIMETER")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureBoundingBox,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_BOUNDINGBOX")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureHoleDist,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_HOLE_DIST")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureRadius,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_RADIUS")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureDiameter,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_DIAMETER")}),s.addCol({element:a}),s.addRow(),i=new NDS.Input({id:l.idRadioMeasureDistance,name:e,type:"radio",callbackEvent:d}),s.addCol({element:i}),o.addChildElement(i),a=new NDS.Element({className:"dialog-content-info",text:ye.translateString("IDS_MEASURETYPE_2DDISTANCE")}),s.addCol({element:a})),n.domElement.appendChild(s.domElement),this.release=function(){r.viewer.container.removeChild(o.domElement)},this.show=function(e){var t,n,i;e&&(i=(n=r.viewer.tlbOperator).getChildElement("btnMeasure").domElement,n=(t=n.domElement).offsetLeft+i.offsetLeft,i=parseInt(ye.getStyle(t,"padding-top"))+parseInt(ye.getStyle(t,"padding-bottom"))+parseInt(ye.getStyle(t,"border-top-width"))+parseInt(ye.getStyle(t,"border-bottom-width"))+parseInt(ye.getStyle(t,"margin-bottom")),i=t.offsetHeight+i,o.setLeft(n),o.setBottom(i)),o.setVisibility(e)},this.setChecked=function(e){e=o.getChildElement(e);e&&(e.domElement.checked=!0)},this.getChecked=function(){for(var e=document.getElementsByName("radioGroup"),t=0;t<e.length;++t)if(e[t].checked)return e[t].id}}var Ve=function(e){var l=this,d=null,c=[],h=null,o=null,u=0,a=!0,t=0,f=!1,p=1e3/30,s=null,n=!1,r=0;this.viewer=e,this.bHasSkeletonAnimation=!1,this.bHasSolidAnimation=!1,this.bHasMorph=!1,this.bHasInitSleletonAnimation=!1,this.skeletonAnimationObjects=[];var m=null;this.morphMixer=null,this.morphClipActions=[];var g=new THREE.Clock;this.initMorphAnimations=function(){var r=this.viewer.scene;r.traverse(function(e){if(e instanceof THREE.Mesh){var t=e;t.parent;if(null==l.morphMixer&&(l.morphMixer=new THREE.AnimationMixer(r),l.morphMixer.addEventListener("finished",function(e){f=!0})),t.geometry.animations&&0<t.geometry.animations.length){t.material.morphTargets=!0;for(var n=0;n<t.geometry.animations.length;n++){var i=l.morphMixer.clipAction(t.geometry.animations[n],t);l.morphClipActions.push(i)}}}}),this.viewer.onBoxSectionView(!0),this.viewer.onBoxSectionView(!1)},this.updateMorphAnimation=function(e){null!=this.morphMixer&&(this.morphMixer.update(e),l.viewer.render())},this.updateSkeletonAnimation=function(e){for(var t=0;t<l.skeletonAnimationObjects.length;t++){var n=l.skeletonAnimationObjects[t].mixer;if(n){n.update(e);for(var i=0;i<l.skeletonAnimationObjects[t].actionSkinMeshs.length;i++)l.skeletonAnimationObjects[t].actionSkinMeshs[i].skingMesh.updateMatrixWorld(!0);l.viewer.render()}}},this.initSkeletonAnimation=function(){if(!this.bHasInitSleletonAnimation){this.bHasInitSleletonAnimation=!0;var e=this.viewer.scene,n=[],i=[];e.traverse(function(e){var t;e instanceof THREE.Mesh&&(t=e.parent,n.push(e),i.push(t))});var t=new re,r=null;t.name="AnimationRoot",this.skeletonAnimationObjects.push(t);for(var o,a,s=0;s<n.length;s++)if(n[s].geometry.animations&&0<n[s].geometry.animations.length){i[s].remove(n[s]),n[s].material.skinning=!0;var l=new THREE.SkinnedMesh(n[s].geometry,n[s].material);o=n[s],(a=l).position.copy(o.position),a.quaternion.copy(o.quaternion),a.scale.copy(o.scale),a.updateMatrixWorld(!0),i[s].add(l),r||(r=new THREE.AnimationMixer(l.parent),t.mixer=r);var d=new ie;d.skingMesh=l;for(var c=0;c<l.geometry.animations.length;c++){var h=r.clipAction(l.geometry.animations[c],l);h.name=l.geometry.animations[c].name,d.actions.push(h);var u=l.geometry.animations[c].animationUUID;d.actionMap[u]=h}t.actionSkinMeshs.push(d)}this.viewer.selectionManager.computeTargetList(e),this.viewer.recordOriginalMeshes(),r&&r.addEventListener("finished",function(e){f=!0})}},this.getCurrentAnimationUuid=function(){return m},this.getAnimationsExitCount=function(){return r},this.isMaterialsUpdated=function(){return n},this.setMaterialsUpdated=function(e){n=e},this.getCurrentAnimationScene=function(){return o&&o.animationScene?o.animationScene:null},this.getAllAnimationScenes=function(){if(d){for(var e=[],t=0;t<d.length;++t)d[t]&&d[t].animationScene&&e.push(d[t].animationScene);return e}return null},this.getAnimationFinishedFlag=function(){return f},this.setAnimationFinishedFlag=function(e){f=e},this.setAnimationLoopReatDelayTime=function(e){t=e},this.getAnimationLoopReatDelayTime=function(){return t},this.delayAnimation=function(){};function v(){if(c=[],d&&0<d.length)for(var e,t=0;t<d.length;++t)d[t]&&(e=h.clipAction(d[t]),null!=d[t].timeScale&&(e.timeScale=d[t].timeScale),c.push(e))}this.initSolidAnimations=function(e,t){s=e,d=t,(h=new THREE.AnimationMixer(e)).addEventListener("finished",function(e){f=!0}),v()},this.update=function(){if(f)return!1;var e=!1,t=g.getDelta();return h&&(h.update(t),e=!0),this.bHasSkeletonAnimation&&(this.updateSkeletonAnimation(t),e=!0),this.bHasMorph&&(this.updateMorphAnimation(t),e=!0),e},this.hasAnimations=function(){return this.bHasSkeletonAnimation||this.bHasSolidAnimation||this.bHasMorph},this.hasSolidAnimations=function(){return this.bHasSolidAnimation},this.getAllAnimationsInfo=function(){if(!this.hasAnimations())return null;var e={animations:[]};if(d&&0<d.length)for(var t=0;t<d.length;++t)d[t]&&0<d[t].tracks.length&&0<d[t].duration&&((r={}).duration=d[t].duration,r.name=d[t].name,r.uuid=d[t].uuid,r.fps=d[t].fps,r.version="1.00",e.animations.push(r));else if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){var n,i=this.skeletonAnimationObjects[0].actionSkinMeshs[0].actionMap;for(n in i)(r={}).duration=i[n]._clip.duration,r.name=i[n]._clip.name,r.uuid=n,r.fps=i[n]._clip.fps,r.version="1.00",e.animations.push(r)}else if(this.bHasMorph)for(var r,o=0;o<l.morphClipActions.length;o++)(r={}).duration=l.morphClipActions[o]._clip.duration,r.name=l.morphClipActions[o]._clip.name,r.uuid=l.morphClipActions[o]._clip.uuid,r.fps=l.morphClipActions[o]._clip.ndsFps,r.version="1.00",e.animations.push(r);return e},this.getAnimationInfoByUUID=function(e){if(!this.hasAnimations())return null;if(d&&0<d.length){null==e&&(e=d[0].uuid);for(var t=0;t<d.length;++t)if(d[t])if(d[t].uuid==e&&0<d[t].tracks.length&&0<d[t].duration)return(r={}).duration=d[t].duration,r.name=d[t].name,r.uuid=d[t].uuid,r.fps=d[t].fps,r.version="1.00",r}else if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){var n,i=this.skeletonAnimationObjects[0].actionSkinMeshs[0].actionMap;for(n in i)if(n==e)return(r={}).duration=i[n]._clip.duration,r.name=i[n]._clip.name,r.uuid=n,r.fps=i[n]._clip.fps,r.version="1.00",r}else if(this.bHasMorph){var r;return(r={}).duration=l.morphClipActions[0]._clip.duration,r.name=l.morphClipActions[0]._clip.name,r.uuid=l.morphClipActions[0]._clip.uuid,r.fps=l.morphClipActions[0]._clip.ndsFps,r.version="1.00",r}return null},this.startMorphAnimationByUUID=function(e,t){if(this.bHasMorph){if(f=a=!1,null==e)null!=t&&!t||(m=l.morphClipActions[0]._clip.uuid,l.morphClipActions[0].play());else if(m!=e){for(var n=0;n<l.morphClipActions.length;n++)l.morphClipActions[n]._clip.uuid==e&&(l.morphClipActions[n].enabled=!1,l.morphClipActions[n].stop());m=e}for(n=0;n<l.morphClipActions.length;n++){var i=l.morphClipActions[n];i.isRunning()||i.time>=i._clip.duration&&(i.reset(),g=new THREE.Clock),i.enabled=!0,i.paused=!t,i.play()}}},this.startSkeletonAnimationByUUID=function(e,t){if(this.bHasSkeletonAnimation)if(f=a=!1,null==e){if(null==t||t){m=this.skeletonAnimationObjects[0].actionSkinMeshs[0].actions[0]._clip.animationUUID;for(var n=0;n<this.skeletonAnimationObjects[0].actionSkinMeshs.length;n++)this.skeletonAnimationObjects[0].actionSkinMeshs[n].skingMesh.material.skinning=!0,this.skeletonAnimationObjects[0].actionSkinMeshs[n].actions[0].play();this.viewer.onBoxSectionView(!0),this.viewer.onBoxSectionView(!1)}}else{if(m!=e){for(n=0;n<this.skeletonAnimationObjects[0].actionSkinMeshs.length;n++)for(r in(i=this.skeletonAnimationObjects[0].actionSkinMeshs[n]).actionMap)r==m&&(i.actionMap[r].enabled=!1,i.actionMap[r].stop());m=e}for(var i,r,o,n=0;n<this.skeletonAnimationObjects[0].actionSkinMeshs.length;n++)for(r in(i=this.skeletonAnimationObjects[0].actionSkinMeshs[n]).skingMesh.material.skinning=!0,i.actionMap)r==e&&((o=i.actionMap[r]).isRunning()||o.time>=o._clip.duration&&(o.reset(),g=new THREE.Clock),o.enabled=!0,o.paused=!t,o.play())}},this.startSolidAnimationByUUID=function(e,t){if(d&&0<d.length){var n=o,i=u;if(null==e)null==o&&(o=d[0],m=d[0].uuid,u=0);else for(var r=0;r<d.length;++r)if(d[r].uuid==e){o=d[r],u=r;break}n&&n!=o&&c[i].stop(),n!=o&&(h=o.animationScene?new THREE.AnimationMixer(o.animationScene):new THREE.AnimationMixer(s),v(),h.addEventListener("finished",function(e){f=!0})),!o||(n=c[u])&&(null==t||t?(n.isRunning()||n.time>=n._clip.duration&&(n.reset(),g=new THREE.Clock),n.paused=!1,n.play(),a=f=!1,p=1e3/o.fps):n.paused=!0)}return o},this.getAnimationLoopModeByUUID=function(e){var t="loopRepeat";if(d&&0<d.length){if(null!=e)for(var n=0;n<d.length;++n)if(d[n].uuid==e){d[n].loop==THREE.LoopOnce?t="loopOnce":d[n].loop==THREE.LoopRepeat&&(t="loopRepeat");break}}else if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){if(null!=e)for(var i in this.skeletonAnimationObjects[0].actionSkinMeshs[0].actionMap)i==e&&(this.skeletonAnimationObjects[0].actionSkinMeshs[0].actionMap[i].loop==THREE.LoopOnce?t="loopOnce":this.skeletonAnimationObjects[0].actionSkinMeshs[0].actionMap[i].loop==THREE.LoopRepeat&&(t="loopRepeat"))}else if(l.bHasMorph&&null!=e)for(var r=0;r<l.morphClipActions.length;r++)e==l.morphClipActions[r]._clip.uuid&&(l.morphClipActions[r].loop==THREE.LoopOnce?t="loopOnce":l.morphClipActions[r].loop==THREE.LoopRepeat&&(t="loopRepeat"));return t},this.setAnimationLoopModeByUUID=function(e,t){if(d&&0<d.length&&null!=e)for(var n=0;n<d.length;++n)if(d[n].uuid==e){"loopOnce"==t?d[n].loop=THREE.LoopOnce:"loopRepeat"==t&&(d[n].loop=THREE.LoopRepeat);var i=h.clipAction(d[n]);i&&(i.loop=d[n].loop);break}if(this.bHasSkeletonAnimation&&null!=e)for(var r=0;r<this.skeletonAnimationObjects[0].actionSkinMeshs.length;r++)for(var o=this.skeletonAnimationObjects[0].actionSkinMeshs[r],a=0;a<o.actions.length;a++)o.actions[a]._clip.animationUUID==e&&("loopOnce"==t?o.actions[a].loop=THREE.LoopOnce:"loopRepeat"==t&&(o.actions[a].loop=THREE.LoopRepeat));if(l.bHasMorph&&null!=e)for(r=0;r<l.morphClipActions.length;r++){var s=l.morphClipActions[r];s._clip.uuid==e&&("loopOnce"==t?s.loop=THREE.LoopOnce:"loopRepeat"==t&&(s.loop=THREE.LoopRepeat))}},this.getCurrentAnimationTime=function(){if(o){var e=c[u];if(e)return e.time}if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){var t,n=this.skeletonAnimationObjects[0].actionSkinMeshs[0];for(t in n.actionMap)if(t==m)return n.actionMap[t].time}if(l.bHasMorph)for(var i=0;i<l.morphClipActions.length;i++){var r=l.morphClipActions[i];if(r._clip.uuid==m)return r.time}return 0},this.getCurrentAnimationDuration=function(){if(o)return o.duration;if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){var e,t=this.skeletonAnimationObjects[0].actionSkinMeshs[0];for(e in t.actionMap)if(e==m)return t.actionMap[e]._clip.duration}if(l.bHasMorph)for(var n=0;n<l.morphClipActions.length;n++){var i=l.morphClipActions[n];if(i._clip.uuid==m)return i._clip.duration}return 0},this.setAnimationTimeByUUID=function(e,t){if(d&&0<d.length&&null!=e)for(var n=0;n<d.length;++n)if(d[n].uuid==e){var i=c[u];i&&(i.time=Math.floor(1e3*t/p)*p*.001);break}if(this.bHasSkeletonAnimation)for(var r=0;r<this.skeletonAnimationObjects[0].actionSkinMeshs.length;r++){var o,a=this.skeletonAnimationObjects[0].actionSkinMeshs[r];for(o in a.actionMap)o==e&&(a.actionMap[o].time=Math.floor(1e3*t/p)*p*.001)}if(l.bHasMorph)for(r=0;r<l.morphClipActions.length;r++){var s=l.morphClipActions[r];s._clip.uuid==e&&(s.time=Math.floor(1e3*t/p)*p*.001)}},this.getAnimationScaleByUUID=function(e){var t=1;if(d&&0<d.length&&null!=e)for(var n=0;n<d.length;++n)if(d[n].uuid==e){t=c[n].timeScale;break}if(!this.bHasSolidAnimation&&this.bHasSkeletonAnimation){var i,r=this.skeletonAnimationObjects[0].actionSkinMeshs[0];for(i in r.actionMap)if(i==e)return r.actionMap[i].timeScale}if(l.bHasMorph)for(var o=0;o<l.morphClipActions.length;o++){var a=l.morphClipActions[o];if(a._clip.uuid==e)return a.timeScale}return t},this.setAnimationScaleByUUID=function(e,t){if(d&&0<d.length&&null!=e)for(var n=0;n<d.length;++n)if(d[n].uuid==e){c[n].timeScale=t,d[n].timeScale=t;break}if(null!=e){if(this.bHasSkeletonAnimation)for(var i=0;i<this.skeletonAnimationObjects[0].actionSkinMeshs.length;i++){var r,o=this.skeletonAnimationObjects[0].actionSkinMeshs[i];for(r in o.actionMap)r==e&&(o.actionMap[r].timeScale=t)}if(l.bHasMorph)for(i=0;i<l.morphClipActions.length;i++){var a=l.morphClipActions[i];a._clip.uuid==e&&(a.timeScale=t)}}},this.isAnimationsExited=function(){return a},this.exitAnimations=function(){if(o&&c[u].stop(),this.bHasSkeletonAnimation)for(var e=0;e<this.skeletonAnimationObjects[0].actionSkinMeshs.length;e++){var t,n=this.skeletonAnimationObjects[0].actionSkinMeshs[e];for(t in n.actionMap)n.actionMap[t].stop(),n.actionMap[t].reset()}if(l.bHasMorph)for(e=0;e<l.morphClipActions.length;e++){var i=l.morphClipActions[e];i.stop(),i.reset()}a=!0,++r}},je=function(e){this.viewer=e;var S=this,n=null,T={},A={},h={},l={lineWidth:1,strokeStyle:"#000000"},u="",R="",f=!1,d=null,p=[],t="lineSeg",i=!1,m=null,g=null,v=null,y=null,E=null,b=null,M=null,x=null,w=null,I=null,O=this.viewer.renderer.domElement,P=new THREE.WebGLRenderTarget(O.width,O.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1});P.texture.generateMipmaps=!1;var C=new THREE.Scene,B=new THREE.MeshBasicMaterial;B.side=THREE.DoubleSide;var L=this.viewer.ndsModel?(new B.constructor).copy(B):null,o=10,r=new THREE.ShaderMaterial({vertexShader:N.vertexShader,fragmentShader:N.fragmentShader});r.side=THREE.DoubleSide;var c=null;function D(e,t){var n=t?"annotationLogoSelected":"annotationLogo";return null!=e&&("ImageAnno"==e?n=t?"imgAnnotationLogoSelected":"imgAnnotationLogo":"ViewportAnno"==e?n=t?"viewportAnnotationLogoSelected":"viewportAnnotationLogo":"VideoAnno"==e?n=t?"videoAnnotationLogoSelected":"videoAnnotationLogo":"AudioAnno"==e&&(n=t?"AudioAnnotationLogoSelected":"AudioAnnotationLogo")),n}function H(){var e,t,n,i,r,o,a,s,l=null,d=new THREE.Box2,c=S.viewer.renderer.domElement.width/2,h=S.viewer.renderer.domElement.height/2,u=S.viewer.renderer.getPixelRatio(),f=new THREE.Vector3;for(p in T)(m=T[p])&&(null!=m.type&&null!=m.type&&"lineSeg"==m.type?f.set(m.coords[m.coords.length-3],m.coords[m.coords.length-2],m.coords[m.coords.length-1]):f.copy((e=m,r=i=n=t=void 0,(r=new THREE.Vector3).set(e.coords[0],e.coords[1],e.coords[2]),e.locationObjectUUID&&""!=e.locationObjectUUID&&(e.locationObject||(S.viewer.ndsModel?e.locationObject=S.viewer.ndsModel.getBodyNodeFromUuid(e.locationObjectUUID):e.locationObject=S.viewer.modelRootObject.getObjectByProperty("uuid",e.locationObjectUUID)),!e.locationObject&&S.viewer.ndsModel&&e.fileguid&&(n=null,(t=S.viewer.ndsModel.fileguidTouuid[e.fileguid])&&0<t.length&&(n=S.viewer.ndsModel.getRightBodyuuid(e.rootfileguid,t)),(n=S.viewer.ndsModel.bodyUuid2NodeMap[n])&&n.children&&!n.children[e.BodyfileID]&&(n=n.children[e.BodyfileID],e.locationObject=n)),e.locationObject&&("4"==e.version||"5"==e.version?S.viewer.ndsModel?0<=e.locationObject.id&&(i=S.viewer.ndsModel.getBodyTranslate(e.locationObject),r.x+=i[0],r.y+=i[1],r.z+=i[2]):r.applyMatrix4(e.locationObject.matrixWorld):e.locationObject.matrixWorldTransOrginal&&((i=new THREE.Vector3).setFromMatrixPosition(e.locationObject.matrixWorld),i.sub(e.locationObject.matrixWorldTransOrginal),r.add(i)),A[e.uuid]&&A[e.uuid].position.copy(r))),r)),m.worldPosition=f.clone(),f.project(S.viewer.camera),f.x=Math.round(f.x*c+c),f.y=Math.round(-f.y*h+h),m.screenPosition=f.clone(),0<=f.x&&f.x<=P.width&&0<=f.y&&f.y<=P.height&&d.expandByPoint(f)),R!=p||(r=!(r=document.getElementById("calcAudioShow"))||"none"==r.style.display?document.getElementById("calcPicTextShow"):r)&&"none"!=r.style.display&&(r.style.left=f.x/u+4+"px",r.style.top=f.y/u+8+"px");if(S.viewer.isRotationEnable()){f.y=f.x=4,d.expandByVector(f),d.min.x<0&&(d.min.x=0),d.min.y<0&&(d.min.y=0),d.max.x>P.width&&(d.max.x=P.width),d.max.y>P.height&&(d.max.y=P.height),d.isEmpty()||(o=S.viewer.scene.overrideMaterial,a=S.viewer.renderer.getClearColor().clone(),s=S.viewer.renderer.getClearAlpha(),S.viewer.scene.overrideMaterial=B,S.viewer.renderer.setClearColor(3),S.viewer.ndsModel&&(S.viewer.ndsModel.backupDirty(),S.viewer.ndsModel.setDirty(),S.viewer.ndsModel.setDrawMode(S.viewer.ndsModel.SHADED),S.viewer.scene.children.push(S.viewer.ndsModel),S.viewer.ndsModel.setOverrideMaterial(B,L,!1)),S.viewer.renderer.render(S.viewer.scene,S.viewer.camera,P,!0),S.viewer.scene.overrideMaterial=o,S.viewer.ndsModel&&(S.viewer.ndsModel.setOverrideMaterial(null,null,!1),S.viewer.ndsModel.resetDirty()),S.viewer.renderer.render(C,S.viewer.camera,P,!1),E=d.max.x-d.min.x,b=d.max.y-d.min.y,l=new Uint8Array(4*E*b),S.viewer.renderer.readRenderTargetPixels(P,d.min.x,P.height-d.max.y,E,b,l),S.viewer.renderer.setRenderTarget(null),S.viewer.renderer.setClearColor(a,s));var p,m;for(p in T)if(m=T[p]){var g=!0;if("1"!=m.version){var v=A[m.uuid];if(v&&l)for(var y=v.material.color.getHex(),E=d.max.x-d.min.x,b=d.max.y-d.min.y,g=!1,M=m.screenPosition.x-1;M<=m.screenPosition.x+1&&M<=d.max.x&&M>=d.min.x;++M){for(var x=m.screenPosition.y-1;x<=m.screenPosition.y+1&&x<=d.max.y&&x>=d.min.y;++x){var w=4*((b-(x-d.min.y))*E+(M-d.min.x)),w=l[w]<<16|l[1+w]<<8|l[2+w];if(Math.abs(w-y)<3){g=!0;break}}if(1==g)break}}else{var I=m.worldPosition.clone(),v=(I.clone(),S.viewer.camera.position.distanceTo(I)),v=new THREE.Raycaster(S.viewer.camera.position,I.sub(S.viewer.camera.position).normalize(),0,.9999*v).intersectObjects(S.viewer.selectionManager.getTargetList());0<v.length&&v[0].point&&(g=!1)}m.bShowAnnoOpacity=g}}}this.getAnnotationJsonArray=function(){return n},this.getSelectAnnotation=function(){return R},this.getDepthRGBAMaterial=function(){return r},this.getRenderTarget=function(){return P},this.setSize=function(e,t){e==P.width&&t==P.height||(P.dispose(),(P=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1)},this.listenAnnotation=function(e){(c=e)&&h[c]&&S.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:h[c]})},this.setAnnotationMode=function(e){null!=e&&(t=e)},this.getAnnotationMode=function(){return t},this.setLineSegAnnotationStyle=function(e){e&&(null!=e.lineWidth&&(l.lineWidth=e.lineWidth),null!=e.strokeStyle&&(l.strokeStyle=e.strokeStyle))},this.getLineSegAnnotationStyle=function(){return l},this.getposFromFileGuid=function(e,t,n){var i=e.fileguid,r=e.rootfileguid,o=e.matrix,a=e.BodyfileID,s=e.explodeFactor,l=S.viewer.ndsModel.fileguidTouuid[i],i=null;if(null==(i=l&&0<l.length?S.viewer.ndsModel.getRightBodyuuid(r,l):i))return!1;i=S.viewer.ndsModel.bodyUuid2NodeMap[i];if(!(i&&i.children&&i.children[a]&&i.children[a].uuid))return!1;i=i.children[a],a=S.viewer.ndsModel.getExplodeTranslate(4*s,i);a[0]+=e.translate[0],a[1]+=e.translate[1],a[2]+=e.translate[2];s=new THREE.Matrix4;s.fromArray(o);var d,i=i.worldMatrix;return null!=t.cx&&(d=new THREE.Vector3(t.cx,t.cy,t.cz),null!=n&&0!=n&&(d.x-=e.annoTranslate[0],d.y-=e.annoTranslate[1],d.z-=e.annoTranslate[2]),d.applyMatrix4(s),d.applyMatrix4(i),null!=n&&0!=n&&(d.x+=a[0],d.y+=a[1],d.z+=a[2]),t.cx=d.x,t.cy=d.y,t.cz=d.z),null!=t.x&&(d=new THREE.Vector3(t.x,t.y,t.z),null!=n&&0!=n&&(d.x-=e.annoTranslate[0],d.y-=e.annoTranslate[1],d.z-=e.annoTranslate[2]),d.applyMatrix4(s),d.applyMatrix4(i),null!=n&&0!=n&&(d.x+=a[0],d.y+=a[1],d.z+=a[2]),t.x=d.x,t.y=d.y,t.z=d.z),null!=t.cx2&&(d=new THREE.Vector3(t.cx2,t.cy2,t.cz2),null!=n&&0!=n&&(d.x-=e.annoTranslate[0],d.y-=e.annoTranslate[1],d.z-=e.annoTranslate[2]),d.applyMatrix4(s),d.applyMatrix4(i),null!=n&&0!=n&&(d.x+=a[0],d.y+=a[1],d.z+=a[2]),t.cx2=d.x,t.cy2=d.y,t.cz2=d.z),!0},this.getCamupFromFileGuid=function(e,t){var n=e.fileguid,i=e.rootfileguid,r=e.matrix,o=e.BodyfileID,a=S.viewer.ndsModel.fileguidTouuid[n],e=null;if(null==(e=a&&0<a.length?S.viewer.ndsModel.getRightBodyuuid(i,a):e))return!1;n=S.viewer.ndsModel.bodyUuid2NodeMap[e];if(!(n&&n.children&&n.children[o]&&n.children[o].uuid))return!1;i=n.children[o],a=new THREE.Matrix4;a.fromArray(r);e=i.worldMatrix,n=new THREE.Vector3(t.x,t.y,t.z),o=new THREE.Quaternion,r=new THREE.Vector3,i=new THREE.Vector3;return a.decompose(r,o,i),n.applyQuaternion(o),e.decompose(r,o,i),n.applyQuaternion(o),t.x=n.x,t.y=n.y,t.z=n.z,!0},this.selectAnnotation=function(e){var t,n,i,r,o,a,s,l,d,c;f=!1,R&&""!=R&&this.resetSelectAnnotation(!0),null==e?u="":(R=u=e,m=S.viewer.getExplodeFactor(),y=S.viewer.getExplodeMode(),g=S.viewer.getExplodeLevel(),v=S.viewer.explodeObjects.concat(),(t=S.getAnnotation(e))&&t.cameraInfo&&(S.viewer.restoreAllDraggedObjects(!1),null==E&&(E=S.viewer.camera.position.clone(),b=S.viewer.camera.target.clone(),M=S.viewer.camera.up.clone(),x=S.viewer.camera.far,w=S.viewer.camera.near,I=S.viewer.camera.IsPerspective()),n=t.cameraInfo.far,t.other&&!t.haschange&&t.rootfileguid&&t.fileguid&&t.translate&&(this.getposFromFileGuid(t,t.cameraInfo.position,!0),this.getposFromFileGuid(t,t.cameraInfo.target,!0),this.getCamupFromFileGuid(t,t.cameraInfo.up),t.haschange=!0,t.cameraInfo.modelScreenBBox=S.viewer.computeModelScreenBBox()),!t.locationObject&&t.locationObjectUUID&&(S.viewer.ndsModel?t.locationObject=S.viewer.ndsModel.getBodyNodeFromUuid(t.locationObjectUUID):t.locationObject=S.viewer.modelRootObject.getObjectByProperty("uuid",t.locationObjectUUID)),t.bOnModel&&t.locationObject&&t.translate&&(o=t.locationObject,0<(p=S.viewer.ndsModel.getBodyTranslateWithoutExplode(o)).length&&(a=new THREE.Vector3(t.translate[0]-p[0],t.translate[1]-p[1],t.translate[2]-p[2]),S.viewer.ndsModel.dragBody(o,a))),S.viewer.camera.IsPerspective()!=t.cameraInfo.isPerspective&&(t.cameraInfo.isPerspective?S.viewer.camera.toPerspective():S.viewer.camera.toOrthographic()),i={center:new THREE.Vector3(t.cameraInfo.target.x,t.cameraInfo.target.y,t.cameraInfo.target.z),up:new THREE.Vector3(t.cameraInfo.up.x,t.cameraInfo.up.y,t.cameraInfo.up.z),position:new THREE.Vector3(t.cameraInfo.position.x,t.cameraInfo.position.y,t.cameraInfo.position.z)},"ViewportAnno"==t.type||1<(r=function(e,t){if(null==t.width||null==t.height||null==t.modelScreenBBox)return 1;var n=S.viewer.renderer.getPixelRatio(),i=S.viewer.renderer.domElement.width/n,r=S.viewer.renderer.domElement.height/n;if(Math.abs(t.width-i)/i<.1&&Math.abs(t.height-r)/r<.1)return 1;var o=S.viewer.camera.position.clone(),a=S.viewer.camera.target.clone(),s=S.viewer.camera.up.clone();S.viewer.camera.position.copy(e.position),S.viewer.camera.target.copy(e.center),S.viewer.camera.up.copy(e.up),S.viewer.camera.lookAt(e.center),S.viewer.camera.updateMatrixWorld(!0),S.viewer.camera.updateProjectionMatrix();var l=S.viewer.computeModelScreenBBox();S.viewer.camera.position.copy(o),S.viewer.camera.target.copy(a),S.viewer.camera.up.copy(s),S.viewer.camera.lookAt(a),S.viewer.camera.updateMatrixWorld(!0),S.viewer.camera.updateProjectionMatrix();var d=l.max.x-l.min.x,c=l.max.y-l.min.y,h=l.min.x,u=i-l.max.x,f=l.min.y,p=r-l.max.y,n=t.width,e=t.height,o=t.modelScreenBBox.max.x-t.modelScreenBBox.min.x,s=t.modelScreenBBox.max.y-t.modelScreenBBox.min.y,a=t.modelScreenBBox.min.x,l=n-t.modelScreenBBox.max.x,n=t.modelScreenBBox.min.y,e=e-t.modelScreenBBox.max.y,t=0;h<0&&(a<0?(m=-a/o)<-h/d&&(t=-d*m-h):t=-h);h=0;u<0&&(l<0?(m=-l/o)<-u/d&&(h=-d*m-u):h=-u);t=Math.max(t,h),h=1;0<t&&(h=(i+2*t)/i);i=0;f<0&&(n<0?(m=-n/s)<-f/c&&(i=-c*m-f):i=-f);f=0;{var m;p<0&&(e<0?(m=-e/s)<-p/c&&(f=-c*m-p):f=-p)}i=Math.max(i,f),f=1;0<i&&(f=(r+2*i)/r);f=Math.max(h,f);1<f&&(f*=1.1);return f}(i,t.cameraInfo))&&!t.other&&(2<r?(o=(s=(s=S.viewer.controls.getExplosionBoundingBox())||S.viewer.controls.getBoundingBox()).getCenter(),a=(d=.5*(new THREE.Vector3).subVectors(s.max,s.min).length())/Math.sin(Math.PI/180*S.viewer.camera.fov*.5),S.viewer.camera.IsPerspective()&&S.viewer.camera.aspect<1&&(a/=S.viewer.camera.aspect),(l=i.position.clone()).sub(i.center),l.normalize(),l.multiplyScalar(a),i.center=o.clone(),i.position.addVectors(i.center,l)):((l=i.position.clone()).sub(i.center),l.multiplyScalar(r),i.position.addVectors(i.center,l),n<2*(c=l.length())&&(n=2*c))),t.other?(l=(s=null==(s=S.viewer.controls.getExplosionBoundingBox())||null==s?S.viewer.controls.getBoundingBox():s).getCenter(),d=.5*(new THREE.Vector3).subVectors(s.max,s.min).length(),c=i.position.distanceTo(l),S.viewer.camera.setFarNear(c=(c+=d)<n?n:c,t.cameraInfo.near)):S.viewer.camera.setFarNear(n,t.cameraInfo.near),"4"==t.version&&(i.center.applyMatrix4(S.viewer.modelRootObject.matrixWorld),i.position.applyMatrix4(S.viewer.modelRootObject.matrixWorld),i.up.transformDirection(S.viewer.modelRootObject.matrixWorld)),null!=t.explodeFactor&&null!=t.explodeFactor&&(t.explodeMode&NDS.EXPLODEMODE.SELECTED?(S.viewer.explodeObjects=t.explodeObjects.concat(),S.viewer.setExplodeMode(t.explodeMode,t.exploseLevel,!0)):S.viewer.setExplodeMode(t.explodeMode,t.exploseLevel),S.viewer.explodeModel(t.explodeFactor)),S.viewer.toggleAutoRotation(!1),S.viewer.startSmoothTranslation(i,function(){h[e]||S.renderAnnotations(),S.viewer.dispatchEvent({type:"annotationSelectedEvent",userData:{uuid:e,index:t.index||-1,annotationDiv:h[e]}}),S.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:h[e]})}),Ue.enableBroadcast&&!Ue.broadcastMajor&&(h[e]||S.renderAnnotations(),S.viewer.dispatchEvent({type:"annotationSelectedEvent",userData:{uuid:e,index:t.index||-1,annotationDiv:h[e]}}),S.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:h[e]}))))},this.setAnnotationType=function(e,t){t=T[t];t&&(t.type=e)},this.setAnnotationsVisibilityByUuid=function(e,t){t=h[t];t&&(e?(t.style.visibility="visible",i=!1):t.style.visibility="hidden")},this.resetSelectAnnotation=function(e){if(R&&""!=R){var t,n=S.getAnnotation(R);if(!n)return null!=m&&(y&NDS.EXPLODEMODE.SELECTED?(S.viewer.explodeObjects=v.concat(),S.viewer.setExplodeMode(y,g,!0)):S.viewer.setExplodeMode(y,g),S.viewer.explodeModel(m)),R="",y=v=g=m=null,void(p=[]);!n.bOnModel||(t=n.locationObject)&&0<p.length&&n.translate&&(n=new THREE.Vector3(p[0]-n.translate[0],p[1]-n.translate[1],p[2]-n.translate[2]),S.viewer.ndsModel.dragBody(t,n)),null!=m&&(y&NDS.EXPLODEMODE.SELECTED?(S.viewer.explodeObjects=v.concat(),S.viewer.setExplodeMode(y,g,!0)):S.viewer.setExplodeMode(y,g),S.viewer.explodeModel(m)),R="",y=v=g=m=null,p=[]}(e=null==e?!1:e)||null==E||null==b||null==M||(e={center:b,up:M,position:E},S.viewer.camera.IsPerspective()!=I&&(I?S.viewer.camera.toPerspective():S.viewer.camera.toOrthographic()),S.viewer.camera.setFarNear(x,w),S.viewer.startSmoothTranslation(e,function(){w=x=M=b=E=null}))},this.addAnnotationRenderObject=function(e){var t,n,i,r;A[e.uuid]||(i=S.viewer.controls.getBoundingBox().getSize(),r=Math.min(i.x,i.y),(r=Math.min(r,i.z))<.1&&(t=Math.max(i.x,i.y),n=Math.max(i.z,i.y),r=Math.min(t,n)),30<Math.max(i.x,i.y,i.z)/r&&(r*=10),i=new THREE.SphereBufferGeometry(.03*r,8,8),(r=new THREE.MeshBasicMaterial).color.setHex(o),r=new THREE.Mesh(i,r),A[e.uuid]=r,C.add(A[e.uuid]),o+=10),null!=e.type&&null!=e.type&&"lineSeg"==e.type?A[e.uuid].position.set(e.coords[e.coords.length-3],e.coords[e.coords.length-2],e.coords[e.coords.length-1]):A[e.uuid].position.set(e.coords[0],e.coords[1],e.coords[2]),A[e.uuid].updateMatrixWorld(!0)},this.addAnnotation=function(e,t,n){if(e&&e.uuid){if(e.locationObject=null,n&&!e.other){var i=new THREE.Vector3(e.coords[0],e.coords[1],e.coords[2]);this.getposFromFileGuid(e,i),e.coords[0]=i.x,e.coords[1]=i.y,e.coords[2]=i.z,e.other=!0;n=S.viewer.ndsModel.fileguidTouuid[e.fileguid],i=null;n&&0<n.length&&(i=S.viewer.ndsModel.getRightBodyuuid(e.rootfileguid,n));var r=S.viewer.ndsModel.bodyUuid2NodeMap[i];if(!r||!r.children||!r.children[e.BodyfileID])return!1;for(var o=0,a=0;a<r.children.length;++a){var s=r.children[a];if(!s.isReferenceEntity()&&!s.isCoordinate()){if(o==e.BodyfileID){o=a;break}o++}}r=r.children[o],e.locationObject=r}T[e.uuid]=e,f=!1,u=e.uuid,null!=t&&0==t||S.addAnnotationRenderObject(e)}},this.addAnnotations=function(e){f=!1,u="";for(var t=0;t<e.length;++t)e[t]&&e[t].uuid&&(T[e[t].uuid]=e[t],S.addAnnotationRenderObject(e[t]));n=e},this.getAnnotation=function(e){return e?T[e]:null},this.removeAnnotation=function(e){if(e){e==u&&(f=!1,u=""),T[e]=null;var t,n=h[e],i=1/0;for(t in n&&(this.viewer.container.removeChild(n),h[e]=null,i=Number(n.innerText)),T){var r=T[t];r&&r.index>i&&r.index--}A[e]&&(A[e].geometry&&A[e].geometry.dispose(),A[e].material&&A[e].material.dispose(),C.remove(A[e]),A[e]=null)}},this.removeAllAnnotations=function(){for(var e in T={},h){var t=h[e];t&&this.viewer.container.removeChild(t)}for(e in f=!(h={}),d&&(this.viewer.canvas2D.getContext("2d").clearRect(d.min.x,d.min.y,d.max.x-d.min.x,d.max.y-d.min.y),d=null),u="",A)A[e]&&(A[e].geometry&&A[e].geometry.dispose(),A[e].material&&A[e].material.dispose());A={};for(var n=0;n<C.children.length;n++)C.remove(C.children[n]),n--;S.viewer.render()},this.addAnnotationTip=function(e,t,n,i,r){var o=document.createElement("div");return o.className=D(n,!1),ye.isMobileDevice()?(o.style.top=r-30+"px",o.style.left=i-12+"px"):(o.style.top=r-35+"px",o.style.left=i-13+"px"),o.style.opacity=1,(null==n||"ImageAnno"!=n&&"VideoAnno"!=n&&"AudioAnno"!=n)&&(o.innerHTML=t.toString(),o.innerText=t.toString()),o.setAttribute("uuid",e),o.onclick=function(e){e&&(e.preventDefault(),e.stopPropagation()),null!=o.style.opacity&&1==o.style.opacity&&(e=o.getAttribute("uuid"),S.selectAnnotation(e))},o.onselectstart=function(){return!1},o},this.restoreAllAnnotations=function(){if(this.viewer.canvas2D){for(var e in h){e=h[e];e&&(e.style.visibility="visible")}i=!1}},this.hasAnnotationsForAnimation=function(e){if(this.viewer.canvas2D)for(var t in T)if(T[t]&&e==T[t].ownerUuid&&"animation"==T[t].ownerType)return!0;return!1},this.updateAnnotationsVisiblilityForAnimation=function(e,t){if(this.viewer.canvas2D)for(var n in h){var i=h[n];i&&"animation"==T[n].ownerType&&(e==T[n].ownerUuid&&T[n].timeStart<=t&&T[n].timeEnd>=t?i.style.visibility="visible":(i.style.visibility="hidden",u==n&&(u="")))}},this.setAnnotationsVisiblilityForAnimation=function(e){if(this.viewer.canvas2D)for(var t in h){var n=h[t];n&&"animation"==T[t].ownerType&&(n.style.visibility=e?"visible":"hidden")}},this.hideAllAnnotations=function(e){if(this.viewer.canvas2D)for(var t in d&&(this.viewer.canvas2D.getContext("2d").clearRect(d.min.x,d.min.y,d.max.x-d.min.x,d.max.y-d.min.y),d=null),u="",h){var n,i=h[t];i&&(n=!0,(n="animation"==T[t].ownerType&&e==T[t].ownerUuid?!1:n)&&(i.style.visibility="hidden"))}},this.setAnnotationsVisibility=function(e){if(this.viewer.canvas2D){for(var t in i=!e,d&&(this.viewer.canvas2D.getContext("2d").clearRect(d.min.x,d.min.y,d.max.x-d.min.x,d.max.y-d.min.y),d=null),u="",h){var n=h[t];n&&(n.style.visibility=e?"visible":"hidden")}S.viewer.render()}},this.isAnnotationsVisible=function(){i=!0;var e,t=0;for(e in h)if(h.hasOwnProperty(e)){t++;var n=h[e];if(n&&("visible"==n.style.visibility||n.style.hidemodel)){i=!1;break}}return!(i=0==t?!1:i)},this.getHotPoint=function(e,t){var n=this.viewer.renderer.getPixelRatio(),i=new THREE.Matrix4;i.multiplyMatrices(this.viewer.camera.matrixWorld,i.getInverse(this.viewer.camera.projectionMatrix));var r,o,a,s,l,d=function e(t){return t.parent?t.parent.fileguid||e(t.parent):null},c=!1,h=new Object,u=this.viewer.selectionManager.getPickIntersects(e,t);return u&&0<u.length&&(l=u[0].point.clone(),this.viewer.ndsModel?(r=u[0].bodyNode,o=this.viewer.ndsModel.getBodyTranslate(r),l.x-=o[0],l.y-=o[1],l.z-=o[2],a=r.worldMatrix,(s=new THREE.Matrix4).getInverse(a),h.matrix=Array.prototype.slice.call(new Float32Array(s.elements)),d(r)&&(h.fileguid=d(r)),this.viewer.ndsModel.rootBodyNode.fileguid&&(h.rootfileguid=this.viewer.ndsModel.rootBodyNode.fileguid),null!=r.BodyfileID&&null!=r.BodyfileID&&(h.BodyfileID=r.BodyfileID),d=this.viewer.ndsModel.getBodyTranslateWithoutExplode(r),h.annoTranslate=o,h.translate=d):(null==(r=this.viewer.selectionManager.findParentElement(u[0].object))&&(r=u[0].object),(s=new THREE.Matrix4).getInverse(r.matrixWorld),l.applyMatrix4(s)),h.coords=[l.x,l.y,l.z],h.bOnModel=!0,h.locationObjectUUID=r.uuid,c=!0),this.viewer.ndsModel.rootBodyNode.fileguid&&(h.rootfileguid=this.viewer.ndsModel.rootBodyNode.fileguid),c||(c=new THREE.Vector3,this.viewer.controls.getBoundingBox().getCenter(c),c.project(this.viewer.camera),(c=c.z)<-1&&(c=-.99),(l=new THREE.Vector3).set(e*n/O.width*2-1,2*-(t*n/O.height)+1,c),l.applyMatrix4(i),(i=[])[0]=l.x,i[1]=l.y,i[2]=l.z,h.coords=i,h.bOnModel=!1,h.locationObjectUUID=null),h.cameraInfo=this.viewer.getCameraInfo(),h.explodeFactor=this.viewer.getExplodeFactor(),h.explodeMode=this.viewer.getExplodeMode(),h.exploseLevel=this.viewer.getExplodeLevel(),h.explodeObjects=this.viewer.explodeObjects.concat(),h},this.renderAnnotations=function(){if(this.viewer.canvas2D){d&&(this.viewer.canvas2D.getContext("2d").clearRect(d.min.x,d.min.y,d.max.x-d.min.x,d.max.y-d.min.y),d=null);var e,t=this.viewer.renderer.getPixelRatio();for(e in H(),T){var n=T[e];n&&(o=!0,n.locationObject&&(o=S.viewer.ndsModel?!n.locationObject.isHidden():n.locationObject.visible),(i=h[n.uuid])&&(r=!0,!(r="hidden"==i.style.visibility?!1:r)&&i.style.hidemodel&&o?i.style.hidemodel=!1:!r||o||i.style.hidemodel?o&=r:i.style.hidemodel=!0),r=!1,(r=null!=n.version?function(e){var t=new THREE.Vector3(e.cameraInfo.position.x,e.cameraInfo.position.y,e.cameraInfo.position.z);"4"==e.version&&t.applyMatrix4(S.viewer.modelRootObject.matrixWorld);var n=!1;return u==e.uuid&&((n=S.viewer.camera.position.distanceToSquared(t)<1e-6)&&(t.set(e.cameraInfo.up.x,e.cameraInfo.up.y,e.cameraInfo.up.z),"4"==e.version&&t.transformDirection(S.viewer.modelRootObject.matrixWorld),n=S.viewer.camera.up.distanceToSquared(t)<1e-6),f?n||(u="",f=!1):f=n),n}(n):r)&&o&&(null!=n.type&&null!=n.type&&"lineSeg"==n.type?function(e){var t=S.viewer.renderer.domElement.width/2,n=S.viewer.renderer.domElement.height/2,i=S.viewer.canvas2D.getContext("2d");null!=e.lineWidth?i.lineWidth=e.lineWidth:i.lineWidth=l.lineWidth,null!=e.strokeStyle?i.strokeStyle=e.strokeStyle:i.strokeStyle=l.strokeStyle,d=new THREE.Box2;var r=new THREE.Vector3;i.beginPath(),r.set(e.coords[0],e.coords[1],e.coords[2]),r.project(S.viewer.camera),r.x=Math.round(r.x*t+t),r.y=Math.round(-r.y*n+n),i.moveTo(r.x,r.y),d.expandByPoint(r);for(var o=1;o<e.coords.length/3-1;++o)r.set(e.coords[3*o],e.coords[3*o+1],e.coords[3*o+2]),r.project(S.viewer.camera),r.x=Math.round(r.x*t+t),r.y=Math.round(-r.y*n+n),i.lineTo(r.x,r.y),d.expandByPoint(r);r.x=2*i.lineWidth,r.y=r.x,d.expandByVector(r),i.stroke()}(n):(a=n,s=void 0,s=S.viewer.canvas2D.getContext("2d"),null!=a.strokeStyle?(s.fillStyle=a.strokeStyle,s.strokeStyle=a.strokeStyle):(s.fillStyle=l.strokeStyle,s.strokeStyle=l.strokeStyle),d=new THREE.Box2,s.beginPath(),s.arc(a.screenPosition.x,a.screenPosition.y,2,0,2*Math.PI),s.fill(),s.stroke(),d.min.set(a.screenPosition.x-4,a.screenPosition.y-4),d.max.set(a.screenPosition.x+4,a.screenPosition.y+4))),void 0!==n.index&&((s=n.screenPosition.clone()).x/=t,s.y/=t,h[e]||(i=this.addAnnotationTip(n.uuid,n.index,n.type,s.x,s.y))&&(this.viewer.container.appendChild(i),h[e]=i),this.viewer.isRotationEnable()||(n.bShowAnnoOpacity=!0),a=s,i=r,r=(s=n).bShowAnnoOpacity,n=o,o=void 0,(o=h[s.uuid])&&(i=D(s.type,i),o.className!=i&&(o.className=i),ye.isMobileDevice()?(o.style.top=a.y-30+"px",o.style.left=a.x-12+"px"):(o.style.top=a.y-35+"px",o.style.left=a.x-13+"px"),r?(o.style.opacity=1,o.style.cursor="pointer"):(o.style.opacity=.2,null!=(r=S.viewer.renderer.domElement)&&(o.style.cursor=r.style.cursor)),o.style.visibility=n?"visible":"hidden",null==s.type||"ImageAnno"!=s.type&&"VideoAnno"!=s.type&&"AudioAnno"!=s.type?(o.innerHTML=s.index.toString(),o.innerText=s.index.toString()):(o.innerHTML="",o.innerText=""))))}c&&h[c]&&S.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:h[c]})}var i,r,o,a,s}};de.prototype=Object.create(THREE.EventDispatcher.prototype),NDS.TOUCH={TOUCH_SINGLE:10,TOUCH_DOUBLE:11,TOUCH_TRIPLE:12},NDS.MOUSE={NONE:-1,LEFT:0,MIDDLE:1,RIGHT:2};function ce(e){this.type="OpBase",this.viewer=e,this.state=-1,this.pointer=new THREE.Vector2,this.pointerOld=new THREE.Vector2,this.pointer2nd=new THREE.Vector2,this.pointerOld2nd=new THREE.Vector2,this.lMouseDown=new THREE.Vector2,this.lMouseUp=new THREE.Vector2,this.downModelPnt=new THREE.Vector3,this.singleTouchStartPos=new THREE.Vector2,this.singleTouchEndPos=new THREE.Vector2,this.normalMatrix=new THREE.Matrix3,this.intervalTimer=null,this.isDoubleTouch=!1;var t=.7,n=new THREE.SphereGeometry(t,20,20),i=new THREE.MeshPhongMaterial({color:7829503,depthTest:!0});this.rotateCenterHelper=new THREE.Mesh(n,i),this.rotateCenterHelper.name="rotateCenterHelper";var r=this.rotateSphereCenter=null;this.oldSelectType=e.selectionManager.getSelectType(),this.startTransform=null,this.endTransform=null,this.entityIsTransformed=!1,this.transformType="",(e.canvas2D||e.canvas3D).height,this.latAngle=0;var a=this;function o(){this.getCameraScale=function(e,t){var n=1;if(!e)return n;var i=5;null!=t&&(i=t);var r=a.viewer.camera.getCameraTarget(),o=a.viewer.camera.position,t=new THREE.Vector3;t.subVectors(r,o);e=e.clone(),o=a.viewer.camera.isPerspective?e.sub(o).dot(t.normalize()):1.2*t.length(),t=a.viewer.camera.fov,o=2*o*Math.tan(THREE.Math.degToRad(.5*t)),t=a.viewer.renderer.domElement.height;return n=i*o*a.viewer.renderer.getPixelRatio()/t},this.run=function(){var e;a.rotateSphereCenter&&a.viewer.scene.getObjectByName("rotateCenterHelper")&&(e=this.getCameraScale(a.rotateCenterHelper.position,10*t),a.rotateCenterHelper.scale.x=a.rotateCenterHelper.scale.y=a.rotateCenterHelper.scale.z=e,a.rotateCenterHelper.updateMatrixWorld(!0))}}this.showRotateCenterHelper=function(){try{if(a.viewer.scene.getObjectByName("rotateCenterHelper"))return}catch(e){return}if(!a.rotateSphereCenter){var e=a.viewer.cameraControl.getRotateCenter();if(!e){var t=a.viewer.controls.getBoundingBox();if(t||renturn,!(e=t.getCenter()))return}a.rotateSphereCenter=e.clone(),a.rotateCenterHelper.position.x=a.rotateSphereCenter.x,a.rotateCenterHelper.position.y=a.rotateSphereCenter.y,a.rotateCenterHelper.position.z=a.rotateSphereCenter.z}r=r||new o,a.viewer.addFrameListener(r),a.viewer.scene.add(a.rotateCenterHelper),a.rotateCenterHelper.updateMatrixWorld(!0),a.viewer.render()},this.hideRotateCenterHelper=function(){try{if(!a.viewer.scene.getObjectByName("rotateCenterHelper"))return}catch(e){return}r&&a.viewer.removeFrameListener(r),a.viewer.scene.remove(a.rotateCenterHelper),a.viewer.render()},this.updateRotateCenterHelper=function(){var e=a.viewer.cameraControl.getRotateCenter();e&&(a.rotateSphereCenter=e.clone()),a.rotateSphereCenter&&(a.rotateCenterHelper.position.equals(a.rotateSphereCenter)||(a.rotateCenterHelper.position.x=a.rotateSphereCenter.x,a.rotateCenterHelper.position.y=a.rotateSphereCenter.y,a.rotateCenterHelper.position.z=a.rotateSphereCenter.z,a.rotateCenterHelper.updateMatrixWorld(!0)))},this.onMouseOut=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(e.preventDefault(),a.IsNodeChildOfContainer(e.toElement)||a.onMouseUp(e))},this.IsNodeChildOfContainer=function(e){return!!e&&(e==a.viewer.container||a.IsNodeChildOfContainer(e.parentNode))},this.onMouseDown=function(e){var t,n,i,r;0===e.button&&1==e.buttons||1===e.button&&4==e.buttons||2===e.button&&2==e.buttons?Ue.enableBroadcast&&!Ue.broadcastMajor||a.viewer.isClipTransformControlSelected()||(e.preventDefault(),t=e.offsetX||e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-a.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),a.pointer.set(t,n),r=[t,n],(i=null)!=(i=!a.viewer.is2DModel?a.viewer.getIntersectionPtByScreenPt(r,!1):i)?a.downModelPnt.set(i.coords[0],i.coords[1],i.coords[2]):(r=a.viewer.clientCoordToModelCoord(r),a.downModelPnt.set(r[0],r[1],r[2])),0===e.button?(a.lMouseDown.set(t,n),a.onLMouseDown(e)):1===e.button?(a.onMMouseDown(e),a.viewer.renderer.domElement.removeEventListener("mousewheel",a.onMouseWheel,!1),a.viewer.canvas2D&&a.viewer.canvas2D.removeEventListener("mousewheel",a.onMouseWheel,!1)):2===e.button&&a.onRMouseDown(e),a.pointerOld.set(t,n),document.addEventListener("mouseup",a.onMouseUp,!1),a.viewer.testMode&&console.log("屏幕按下坐标为 x :"+e.clientX+" y :"+e.clientY)):console.log("onMouseDown btn %d btns %d undefined combo",e.button,e.buttons)};var s,l,d,c,h=(s=a.onNMouseMove,l=100,c=a,function(){var e=arguments;d&&clearTimeout(d),d=setTimeout(function(){s.apply(c,e)},l)});this.onMouseMove=function(e){var t,n;Ue.enableBroadcast&&!Ue.broadcastMajor||a.viewer.isClipTransformControlSelected()||a.viewer.isLightEditControlSelected()||(e.preventDefault(),t=e.offsetX||e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-a.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),a.pointer.set(t,n),a.pointer.equals(a.pointerOld)||(a.viewer.promptshow?(a.viewer.prompt.innerHTML=a.viewer.promptstring,a.viewer.prompt.style.display="inline",a.viewer.prompt&&(a.viewer.renderer.getPixelRatio(),a.viewer.prompt.style.left=e.clientX+16+"px",a.viewer.prompt.style.top=e.clientY+16+"px")):a.viewer.prompt&&(a.viewer.prompt.style.display="none"),a.state===NDS.MOUSE.LEFT?Ue.enableDirectMove&&a.viewer.selectionManager.hasTransformableObjectSelected()&&"OpBall"!=a.viewer.controls.getOperator().type?ce.prototype.onLMouseMove.call(a,e):a.onLMouseMove(e):a.state===NDS.MOUSE.MIDDLE?a.onMMouseMove(e):a.state===NDS.MOUSE.RIGHT?Ue.enableDirectRotate&&a.viewer.selectionManager.hasTransformableObjectSelected()&&"OpBall"!=a.viewer.controls.getOperator().type?ce.prototype.onRMouseMove.call(a,e):a.onRMouseMove(e):a.viewer.is2DModel&&ye.isMobileDevice()&&"OpMeasure"==a.type?h(e):a.onNMouseMove(e),a.pointerOld.set(t,n)))},this.onMouseUp=function(e){var t,n;0!==e.button&&1!==e.button&&2!==e.button||0!=e.buttons?console.log("onMouseUp btn %d btns %d undefined combo",e.button,e.buttons):a.viewer.isClipTransformControlSelected()?a.onLMouseUp(e):(a.hideRotateCenterHelper(),document.removeEventListener("mouseup",a.onMouseUp,!1),e.preventDefault(),t=e.offsetX||e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-a.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==a.viewer.renderer.domElement&&(t=e.clientX-a.viewer.container.getBoundingClientRect().left,n=e.clientY-a.viewer.container.getBoundingClientRect().top),a.state===NDS.MOUSE.LEFT?(a.lMouseUp.set(t,n),a.onLMouseUp(e)):a.state===NDS.MOUSE.MIDDLE?(a.onMMouseUp(e),a.viewer.renderer.domElement.addEventListener("mousewheel",a.onMouseWheel,!1),a.viewer.canvas2D&&a.viewer.canvas2D.addEventListener("mousewheel",a.onMouseWheel,!1)):a.state===NDS.MOUSE.RIGHT&&a.onRMouseUp(e),a.viewer.testMode&&(e=a.viewer.getCameraInfo(),console.log("相机信息： "+JSON.stringify(e))))};var u,f,p=(u=function(){var e=a.viewer.getCameraInfo();console.log("相机信息： "+JSON.stringify(e))},f=null,function(){null!==f&&clearTimeout(f),f=setTimeout(u,1e3)});this.onMouseWheel=function(e){var t,n;Ue.enableBroadcast&&!Ue.broadcastMajor||(e.preventDefault(),a.mouseEvent(e),t=0,n=he,e.shiftKey&&(n=Ge),e.wheelDelta?t=-e.wheelDelta:e.detail&&(t=e.detail),a.viewer.getMouseWheelForwardEnlargeFlag()||(t*=-1),t=0<t?n:-n,a.zoom(new THREE.Vector3(0,0,t),e),a.viewer.testMode&&p())},this.onClick=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||a.viewer.isClipTransformControlSelected()||a.viewer.isLightEditControlSelected()||(e.preventDefault(),0===e.button?a.lMouseDown.equals(a.lMouseUp)&&a.onLMouseClick(e):1===e.button?a.onMMouseClick(e):2===e.button&&a.onRMouseClick(e))},this.ondblClick=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(e.preventDefault(),0===e.button?a.onLMouseDbClick():1===e.button||e.button)},this.touchstart=function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&!(a.viewer.isClipTransformControlSelected()||"Lineargauge"==a.measureType&&a.MeasureOper.lineargaugediv&&"block"==a.MeasureOper.lineargaugediv.style.display)){switch(e.preventDefault(),e.touches.length){case 1:if(clearTimeout(a.intervalTimer),a.isDoubleTouch)return"OpMeasure"!=a.type&&(Ue.enableSelect?a.selectAndZoom(a.singleTouchEndPos.x,a.singleTouchEndPos.y):a.viewer.zoomExtents()),a.updateRotateCenterHelper(),a.state=-1,void(a.isDoubleTouch=!1);a.isDoubleTouch=!0,a.intervalTimer=setTimeout(function(){a.isDoubleTouch=!1},300);var t=e.touches[0].offsetX||e.touches[0].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-a.viewer.container.getBoundingClientRect().top;a.pointer.set(t,n),a.pointerOld.set(t,n),a.singleTouchStartPos.set(t,n),a.viewer.testMode&&console.log("屏幕按下坐标为 x :"+t+" y :"+n),a.onTouchSingleStart(e);break;case 2:a.isDoubleTouch=!1;t=e.touches[0].offsetX||e.touches[0].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-a.viewer.container.getBoundingClientRect().top;a.pointer.set(t,n),a.pointerOld.set(t,n),t=e.touches[1].offsetX||e.touches[1].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[1].offsetY||e.touches[1].clientY-a.viewer.container.getBoundingClientRect().top,a.pointer2nd.set(t,n),a.pointerOld2nd.set(t,n),a.onTouchDoubleStart(e);break;default:a.isDoubleTouch=!1}var i=[a.pointer.x,a.pointer.y],r=null;null!=(r=!a.viewer.is2DModel&&1==e.touches.length?a.viewer.getIntersectionPtByScreenPt(i,!1):r)?a.downModelPnt.set(r.coords[0],r.coords[1],r.coords[2]):(i=a.viewer.clientCoordToModelCoord(i),a.downModelPnt.set(i[0],i[1],i[2]))}},this.touchmove=function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&!(a.viewer.isClipTransformControlSelected()||a.viewer.isLightEditControlSelected()||"Lineargauge"==a.measureType&&a.MeasureOper.lineargaugediv&&"block"==a.MeasureOper.lineargaugediv.style.display)){switch(e.preventDefault(),e.touches.length){case 1:var t=e.touches[0].offsetX||e.touches[0].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-a.viewer.container.getBoundingClientRect().top;if(a.pointer.set(t,n),a.viewer.limitEventArea){var i=a.viewer.container.getBoundingClientRect().width,r=a.viewer.container.getBoundingClientRect().height;if(i<t||r<n)return void a.touchend(e)}break;case 2:t=e.touches[0].offsetX||e.touches[0].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-a.viewer.container.getBoundingClientRect().top;if(a.pointer.set(t,n),t=e.touches[1].offsetX||e.touches[1].clientX-a.viewer.container.getBoundingClientRect().left,n=e.touches[1].offsetY||e.touches[1].clientY-a.viewer.container.getBoundingClientRect().top,a.pointer2nd.set(t,n),a.viewer.limitEventArea){i=a.viewer.container.getBoundingClientRect().width,r=a.viewer.container.getBoundingClientRect().height;if((a.pointer.x>i||a.pointer.y>r)&&(a.pointer2nd.x>i||a.pointer2nd.y>r))return void a.touchend(e)}}switch(a.state){case NDS.TOUCH.TOUCH_SINGLE:a.onTouchSingleMove(e);break;case NDS.TOUCH.TOUCH_DOUBLE:a.onTouchDoubleMove(e)}a.pointerOld.copy(a.pointer),a.pointerOld2nd.copy(a.pointer2nd)}},this.touchend=function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&!(a.viewer.isClipTransformControlSelected()||"Lineargauge"==a.measureType&&a.MeasureOper.lineargaugediv&&"block"==a.MeasureOper.lineargaugediv.style.display)){switch(a.state){case NDS.TOUCH.TOUCH_SINGLE:var t=e.changedTouches[0].offsetX||e.changedTouches[0].clientX-a.viewer.container.getBoundingClientRect().left,n=e.changedTouches[0].offsetY||e.changedTouches[0].clientY-a.viewer.container.getBoundingClientRect().top;a.singleTouchEndPos.set(t,n),a.viewer.testMode&&(n=a.viewer.getCameraInfo(),console.log("相机信息： "+JSON.stringify(n))),a.onTouchSingleEnd(e);break;case NDS.TOUCH.TOUCH_DOUBLE:a.onTouchDoubleEnd(e)}a.state=-1}},this.touchcancel=function(e){a.state=-1},this.onKeyDown=function(e){if(Ue.enableArrowKeyOp)switch(e.keyCode){case 38:a.moveForwardBack(!0,!0);break;case 37:a.pan(new THREE.Vector3(-20,0,0),!0);break;case 40:a.moveForwardBack(!1,!0);break;case 39:a.pan(new THREE.Vector3(20,0,0),!0)}},this.onKeyUp=function(e){}}var he=30,Ge=20;ce.prototype={constructor:ce,center:function(){return this.viewer.camera.getCameraTarget()},render:function(){this.dispatchEvent({type:"render",forceRenderAll:0<arguments.length&&void 0!==arguments[0]&&arguments[0]})},update:function(){},mouseEvent:function(e){this.dispatchEvent({type:"mouseEvent",event:e})},onTouchSingleStart:function(e){this.state=NDS.TOUCH.TOUCH_SINGLE},onTouchSingleMove:function(e){var t=new THREE.Vector2,n=new THREE.Vector2;t.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),n.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y));var i=n.x-t.x,t=n.y-t.y;this.rotate(new THREE.Vector3(i,t,0))},onTouchSingleEnd:function(e){var t,n;this.state=-1,Ue.enableSelect&&(t=Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x),n=Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y),t<3&&n<3&&(this.viewer.is2DModel||this.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y))),this.hideRotateCenterHelper()},onTouchDoubleStart:function(e){this.state=NDS.TOUCH.TOUCH_DOUBLE},onTouchDoubleMove:function(e){var t=.5*(this.pointerOld.x+this.pointerOld2nd.x),n=.5*(this.pointerOld.y+this.pointerOld2nd.y),i=.5*(this.pointer.x+this.pointer2nd.x),r=.5*(this.pointer.y+this.pointer2nd.y),o=i-t,a=r-n,s=this.pointerOld.x-this.pointerOld2nd.x,l=this.pointerOld.y-this.pointerOld2nd.y,d=s*s+l*l,d=((s=this.pointer.x-this.pointer2nd.x)*s+(l=this.pointer.y-this.pointer2nd.y)*l)/d-1,t=this.pointer.x-this.pointerOld.x,n=this.pointer.y-this.pointerOld.y,s=this.pointer2nd.x-this.pointerOld2nd.x,l=this.pointer2nd.y-this.pointerOld2nd.y,t=new THREE.Vector2(t,n);t.normalize();n=new THREE.Vector2(s,l);n.normalize();s=t.dot(n),l=0,t=he,n=!1;s<.6?.05<Math.abs(d)&&(l=0<d?-t:t,r={offsetX:i,offsetY:r},this.zoom(new THREE.Vector3(0,0,.4*l),r,!1),n=!0):0==o&&0==a||(this.pan(new THREE.Vector3(-o,a,0),!1),n=!0),n&&this.render()},onTouchDoubleEnd:function(e){this.state=-1},onLMouseDbClick:function(e){Ue.enableSelect?this.selectAndZoom(this.lMouseUp.x,this.lMouseUp.y):this.viewer.zoomExtents(),this.updateRotateCenterHelper()},onLMouseClick:function(e){Ue.enableSelect&&!this.viewer.is2DModel&&this.selectByClick(this.lMouseUp.x,this.lMouseUp.y,e.ctrlKey)},onMMouseClick:function(e){},onRMouseClick:function(e){},onTransformStart:function(){var e;this.viewer.selectionManager.hasTransformableObjectSelected()&&(e=this.viewer.selectionManager.getSelectedObjects()[0],this.entityIsTransformed=!1,this.transformType="",this.startTransform=new THREE.Matrix4,e.matrix&&this.startTransform.fromArray(e.matrix))},onTransformFinish:function(){var e,t,n;this.viewer.selectionManager.hasTransformableObjectSelected()&&this.entityIsTransformed&&(e=this.viewer.selectionManager.getSelectedObjects()[0],this.entityIsTransformed=!1,t=e.matrix.slice(0),this.startTransform.toArray(n=[]),this.viewer.dispatchEvent({type:"ComponentTransformedEvent",componentUuid:e.uuid,originalTransform:n,endTransform:t,transformType:this.transformType}),this.transformType="",this.viewer.ndsModel.updateBvh())},onLMouseDown:function(e){this.state=NDS.MOUSE.LEFT,Ue.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformStart()},onMMouseDown:function(e){this.state=NDS.MOUSE.MIDDLE,this.mouseEvent(e)},onRMouseDown:function(e){this.state=NDS.MOUSE.RIGHT,this.mouseEvent(e),Ue.enableDirectRotate&&!this.viewer.isExploded()&&this.onTransformStart()},onLMouseMove:function(e){var t,n,i,r,o;Ue.enableDirectMove&&!this.viewer.isExploded()&&this.viewer.selectionManager.hasTransformableObjectSelected()?(t=this.viewer.selectionManager.getSelectedComponent())&&!t.isFixed()&&(r=this.pointer.x-this.pointerOld.x,o=this.pointer.y-this.pointerOld.y,i=[this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z],i=[(n=this.viewer.modelCoordToClientCoord(i))[0]+r,n[1]+o,n[2]],n=this.viewer.clientCoordToModelCoord(i),(i=new THREE.Vector3(n[0],n[1],n[2]).clone()).sub(this.downModelPnt),n=new THREE.Matrix4,i=(new THREE.Matrix4).makeTranslation(i.x,i.y,i.z),t.matrix?n.fromArray(t.matrix).premultiply(i):n.copy(i),this.viewer.ndsModel.updateNodeMatrix(t.uuid,n.toArray(),i),this.render(),this.entityIsTransformed=!0,this.transformType="Move"):(n=new THREE.Vector2,i=new THREE.Vector2,n.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),i.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y)),r=i.x-n.x,o=i.y-n.y,this.rotate(new THREE.Vector3(r,o,0)))},onMMouseMove:function(e){var t=this.pointer.x-this.pointerOld.x,n=this.pointer.y-this.pointerOld.y;this.pan(new THREE.Vector3(-t,n,0))},onRMouseMove:function(e){var t,n,i,r,o,a,s=this.pointer.x-this.pointerOld.x,l=this.pointer.y-this.pointerOld.y;Ue.enableDirectRotate&&!this.viewer.isExploded()&&this.viewer.selectionManager.hasTransformableObjectSelected()?(t=this.viewer.selectionManager.getSelectedComponent())&&!t.isFixed()&&((r=new THREE.Vector3(0,0,0)).unproject(this.viewer.camera),(a=new THREE.Vector3(10,0,0)).unproject(this.viewer.camera),a.sub(r).normalize(),(o=new THREE.Vector3(0,10,0)).unproject(this.viewer.camera),o.sub(r).normalize(),(n=new THREE.Quaternion).setFromAxisAngle(o,s/200),(i=new THREE.Quaternion).setFromAxisAngle(a,l/200),r=new THREE.Matrix4,o=new THREE.Matrix4,a=new THREE.Matrix4,t.matrix&&r.fromArray(t.matrix),a.makeTranslation(-this.downModelPnt.x,-this.downModelPnt.y,-this.downModelPnt.z),r.premultiply(a),o.premultiply(a),a.makeRotationFromQuaternion(n),r.premultiply(a),o.premultiply(a),a.makeRotationFromQuaternion(i),r.premultiply(a),o.premultiply(a),a.makeTranslation(this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z),r.premultiply(a),o.premultiply(a),this.viewer.ndsModel.updateNodeMatrix(t.uuid,r.toArray(),o),this.render(),this.entityIsTransformed=!0,this.transformType="Rotate"):this.pan(new THREE.Vector3(-s,l,0))},onNMouseMove:function(e){Ue.enablePreSelectBrep&&this.viewer.selectionManager.selectOnMouseMove(this.pointer.x,this.pointer.y)},onLMouseUp:function(e){this.state=-1,Ue.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformFinish(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})},onMMouseUp:function(e){this.state=-1,this.mouseEvent(e)},onRMouseUp:function(e){this.state=-1,this.mouseEvent(e),Ue.enableDirectRotate&&!this.viewer.isExploded()&&this.onTransformFinish()},pan:function(e,t){this.viewer.cameraControl.pan(this,e,t)},moveForwardBack:function(e,t){this.viewer.cameraControl.moveForwardBack(this,e,t)},zoom:function(e,t,n){this.viewer.cameraControl.zoom(this,e,t,n)},calFarthestDistToCamera:function(){return this.viewer.cameraControl.calFarthestDistToCamera()},zoomByMouse:function(e,t,n){this.cameraControl.zoomByMouse(this,e,t,n)},rotateByTrackBall:function(e,t){this.viewer.cameraControl.rotateByTrackBall(this,e,t)},rotateByHall:function(e,t){this.viewer.cameraControl.rotateByHall(this,t)},rotateByBim:function(e,t){this.viewer.cameraControl.rotateByBim(this,t)},rotateByFirstPerson:function(e){this.viewer.cameraControl.rotateByFirstPerson(this,e)},rotate:function(e,t){var n;this.viewer.isRotationEnable()&&("hall"==(n=this.viewer.getModelOperationMode())?this.rotateByHall(e,t):"bim"==n?this.rotateByBim(e,t):"FirstPerson"==n?this.rotateByFirstPerson(e):this.rotateByTrackBall(e,t),"FirstPerson"==n||NDS.MOUSE.LEFT!==this.state&&NDS.TOUCH.TOUCH_SINGLE!==this.state||this.showRotateCenterHelper())},createEventListener:function(){var e=this.viewer.canvas2D;e?ye.isMobileDevice()?(e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1)):(e.addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousemove",this.onMouseMove,!1),e.addEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.addEventListener("mouseout",this.onMouseOut,!1),e.addEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.addEventListener("click",this.onClick,!1),e.addEventListener("dblclick",this.ondblClick,!1),e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1)):(e=null!=(e=this.viewer.renderer.domElement)?e:document,ye.isMobileDevice()?(e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1)):(e.addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousemove",this.onMouseMove,!1),e.addEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.addEventListener("mouseout",this.onMouseOut,!1),e.addEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.addEventListener("click",this.onClick,!1),e.addEventListener("dblclick",this.ondblClick,!1),e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1)))},releaseEventListener:function(){var e=this.viewer.canvas2D;e?ye.isMobileDevice()?(e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1)):(e.removeEventListener("mousedown",this.onMouseDown,!1),e.removeEventListener("mousemove",this.onMouseMove,!1),e.removeEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.removeEventListener("mouseout",this.onMouseOut,!1),e.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.removeEventListener("click",this.onClick,!1),e.removeEventListener("dblclick",this.ondblClick,!1),e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keyup",this.onKeyUp,!1)):(e=null!=(e=this.viewer.renderer.domElement)?e:document,ye.isMobileDevice()?(e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1)):(e.removeEventListener("mousedown",this.onMouseDown,!1),e.removeEventListener("mousemove",this.onMouseMove,!1),e.removeEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.removeEventListener("mouseout",this.onMouseOut,!1),e.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.removeEventListener("click",this.onClick,!1),e.removeEventListener("dblclick",this.ondblClick,!1),e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keyup",this.onKeyUp,!1)))},create:function(){this.createEventListener()},release:function(){this.viewer.selectionManager.setSelectType(this.oldSelectType),this.releaseEventListener()},resetEventListener:function(){this.releaseEventListener(),this.createEventListener()},getMouseOnCircle:function(e,t){var n=this.viewer.renderer.domElement,i=new THREE.Vector2,r=this.viewer.renderer.getPixelRatio();return i.set((e*r-.5*n.width)/(.5*n.width),(n.height-2*t*r)/n.height),i},selectByClick:function(e,t,n){this.viewer.selectionManager.selectByClick(e,t,n),0==this.viewer.selectionManager.getSelectedObjects().length&&this.viewer.dispatchEvent({type:"pickOnEmptyArea",clickPosX:e,clickPosY:t}),this.render()},selectAndZoom:function(e,t){this.viewer.selectionManager.clearSelection(),this.viewer.selectionManager.selectByClick(e,t);var n,i=this.viewer.selectionManager.getSelectedObjects();1==i.length?(this.viewer.zoomToObject(i[0]),Ue.dynamicRotateCenter&&(e=new THREE.Vector3,t=new THREE.Vector3,this.viewer.computeBoundingBox(i[0],e,t,{flag:!0}),(n=new THREE.Vector3).x=.5*(t.x+e.x),n.y=.5*(t.y+e.y),n.z=.5*(t.z+e.z),this.viewer.cameraControl.setRotateCenter(n))):(this.viewer.zoomExtents(),n=this.viewer.controls.getBoundingBox().getCenter(),this.viewer.cameraControl.setRotateCenter(n))}},Object.assign(ce.prototype,THREE.EventDispatcher.prototype);var We=function(e){ce.call(this,e),this.type="OpDrag",this.opMode="default"};We.prototype=Object.create(ce.prototype),We.prototype.setMoveMode=function(){this.opMode="move"},We.prototype.setRestoreMode=function(){this.opMode="restore"},We.prototype.setDefaultMode=function(){this.opMode="default"},We.prototype.isModelMoved=function(){if(this.viewer.ndsModel)return this.viewer.ndsModel.hasDraggedBodies();var t=!1;return this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&null!=e.matrixWorldTransOrginalDrag&&(t=!0)}),t},We.prototype.hideSelectedModel=function(){this.viewer.hideSelectedObjects(),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager.updateClipPlane()},We.prototype.showAllModel=function(){this.viewer.showObject(this.viewer.scene,!0),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager.updateClipPlane(),this.render()},We.prototype.reverseVisibleAndHidingModel=function(){this.viewer.showObjectReversed(this.viewer.scene),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager.updateClipPlane(),this.render()},We.prototype.create=function(){this.viewer.selectionManager.setSelectType("body"),ce.prototype.create.call(this)},We.prototype.release=function(){this.update(),this.render(),ce.prototype.release.call(this)},We.prototype.update=function(){this.viewer.selectionManager.clearSelection(),ce.prototype.update.call(this)},We.prototype.onLMouseClick=function(e){e.preventDefault();var t=this.viewer,n=(t.renderer.domElement,e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left),i=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(n=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(n=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),Math.abs(n-this.lMouseDown.x)<1&&Math.abs(i-this.lMouseDown.y)<1&&("move"==this.opMode||"default"==this.opMode?(t.selectionManager.selectByClick(n,i,e.ctrlKey),this.render()):"restore"==this.opMode&&this.onOpRestore(n,i))},We.prototype.onOpDrag=function(){var e=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes(),t=this.pointer.x-this.pointerOld.x,n=this.pointer.y-this.pointerOld.y,i=[this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z],i=this.viewer.modelCoordToClientCoord(i),i=[i[0]+t,i[1]+n,i[2]],i=this.viewer.clientCoordToModelCoord(i),r=new THREE.Vector3(i[0],i[1],i[2]).clone();if(r.sub(this.downModelPnt),null==this.viewer.draggedObjects&&(this.viewer.draggedObjects=new Array),this.viewer.ndsModel){for(var o=0;o<e.length;++o){var a=e[o];this.viewer.ndsModel.dragBody(a,r),this.addDraggedObject(a)}this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager.updateClipPlane()}else for(o=0;o<e.length;++o){void 0===(a=e[o].key).matrixWorldTransOrginal&&(a.matrixWorldTransOrginal=new THREE.Vector3,a.matrixWorldTransOrginal.setFromMatrixPosition(a.matrixWorld));var s=new THREE.Vector3;s.setFromMatrixPosition(a.matrixWorld),s.add(r),a.matrixWorld.setPosition(s),a.matrixWorldTransExplode?s.sub(a.matrixWorldTransExplode):s.sub(a.matrixWorldTransOrginal),void 0===a.matrixWorldTransOrginalDrag&&(a.matrixWorldTransOrginalDrag=new THREE.Vector3),a.matrixWorldTransOrginalDrag.copy(s),this.addDraggedObject(a)}this.render(),this.viewer.dispatchEvent({type:"dragingModel"})},We.prototype.addDraggedObject=function(e){for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return;this.viewer.draggedObjects.push(e)},We.prototype.removeDraggedObject=function(e){if(null!=this.viewer.draggedObjects)for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return void this.viewer.draggedObjects.splice(t,1)},We.prototype.onOpRestore=function(e,t){if(this.viewer.selectionManager.clearSelection(),this.viewer.selectionManager.selectByClick(e,t),this.viewer.ndsModel){for(var n=this.viewer.selectionManager.getSelectedObjects(),i=0;i<n.length;++i){var r=n[i];this.viewer.ndsModel.restoreDraggedBody(r),this.removeDraggedObject(r)}this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager.updateClipPlane()}else for(n=this.viewer.selectionManager.getSelectedMeshes(),i=0;i<n.length;++i)(r=n[i].key).matrixWorldTransOrginalDrag&&(r.matrixWorldTransOrginalDrag=void 0),r.matrixWorldTransExplode?r.matrixWorld.setPosition(r.matrixWorldTransExplode):r.matrixWorldTransOrginal&&(r.matrixWorld.setPosition(r.matrixWorldTransOrginal),r.matrixWorldTransOrginal=void 0),this.removeDraggedObject(r);this.render(),this.viewer.dispatchEvent({type:"dragingModel"})},We.prototype.onLMouseMove=function(e){0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes()).length&&"move"==this.opMode?this.onOpDrag():ce.prototype.onLMouseMove.call(this,e)},We.prototype.onTouchSingleStart=function(e){ce.prototype.onTouchSingleStart.call(this,e)},We.prototype.onTouchSingleMove=function(e){0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes()).length&&"move"==this.opMode?this.onOpDrag():ce.prototype.onTouchSingleMove.call(this,e)},We.prototype.onTouchSingleEnd=function(e){this.state=-1,Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x)<1&&Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y)<1&&("move"==this.opMode||"default"==this.opMode?(this.viewer.selectionManager.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.render()):"restore"==this.opMode&&this.onOpRestore(this.singleTouchEndPos.x,this.singleTouchEndPos.y))};function Ye(e){var r,b=e,o=null,a=null,s=null,l=!1,d=null,f=Number.MAX_VALUE,c=null,h=null;this.isSnapped=function(){return l},this.getSnappedType=function(){return d},this.getSnappedVertex=function(){return a},this.isEqualWithPrecision=function(e,t){return Math.abs(e-t)<=.001},this.isEqualVectorsWithPrecision=function(e,t){return Math.abs(e.x-t.x)<=.001&&Math.abs(e.y-t.y)<=.001&&Math.abs(e.z-t.z)<=.001},this.isInverseVectorsWithPrecision=function(e,t){return Math.abs(e.x+t.x)<=.001&&Math.abs(e.y+t.y)<=.001&&Math.abs(e.z+t.z)<=.001},this.trianglesSharedEdge=function(e,t,n,i,r,o){var a=!1,s=!1,l=!1;return(e.equals(i)||e.equals(r)||e.equals(o))&&(a=!0),(t.equals(i)||t.equals(r)||t.equals(o))&&(s=!0),(n.equals(i)||n.equals(r)||n.equals(o))&&(l=!0),!!(a&s||a&l||s&l)},this.getTrianglesOnSameFace=function(e,t,n,i){var r=!1,o=e.vertices.slice(),a=new THREE.Geometry;a.vertices.push(t),a.vertices.push(n),a.vertices.push(i),a.faces.push(new THREE.Face3(0,1,2));var s=[];do{for(var s=[],l=0;l<o.length;l+=3)if(o[l].equals(t)&&o[l+1].equals(n)&&o[l+2].equals(i))r=!0,s.push(l);else for(var d=0;d<a.vertices.length;d+=3)if(this.trianglesSharedEdge(o[l],o[l+1],o[l+2],a.vertices[d],a.vertices[d+1],a.vertices[d+2])){var c=a.vertices.length;a.vertices.push(o[l].clone()),a.vertices.push(o[l+1].clone()),a.vertices.push(o[l+2].clone()),a.faces.push(new THREE.Face3(c,c+1,c+2)),s.push(l);break}for(var h=s.length-1;0<=h;--h)o.splice(s[h],3)}while(0<s.length);return r?a:null},this.faceSnapping=function(e,t){var n=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3,o=new THREE.Geometry;if(t instanceof THREE.Geometry){h=t.vertices[e.a].clone(),u=t.vertices[e.b].clone(),f=t.vertices[e.c].clone();for(var a=0;a<t.faces.length;a++){var s=t.faces[a],n=t.vertices[s.a].clone(),i=t.vertices[s.b].clone(),r=t.vertices[s.c].clone(),l=THREE.Triangle.normal(n,i,r);this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(n),e.normal.dot(h))&&(E=o.vertices.length,o.vertices.push(n.clone()),o.vertices.push(i.clone()),o.vertices.push(r.clone()),o.faces.push(new THREE.Face3(E,E+1,E+2)))}}else if(b.ndsModel&&t instanceof ae){var d=t.attributes.position,c=t.index.array,h=new THREE.Vector3,u=new THREE.Vector3,f=new THREE.Vector3;h.fromBufferAttribute(d,e.a),u.fromBufferAttribute(d,e.b),f.fromBufferAttribute(d,e.c);for(var a=t.drawRange.start,p=t.drawRange.start+t.drawRange.count;a<p;a+=3){var m=c[a];n.fromBufferAttribute(d,m);var g=c[a+1];i.fromBufferAttribute(d,g);var v=c[a+2];r.fromBufferAttribute(d,v);l=THREE.Triangle.normal(n,i,r);this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(n),e.normal.dot(h))&&(E=o.vertices.length,o.vertices.push(n.clone()),o.vertices.push(i.clone()),o.vertices.push(r.clone()),o.faces.push(new THREE.Face3(E,E+1,E+2)))}}else if(t instanceof THREE.BufferGeometry){var y=t.attributes.position.array,c=t.index.array;(h=new THREE.Vector3).set(y[3*e.a],y[3*e.a+1],y[3*e.a+2]),(u=new THREE.Vector3).set(y[3*e.b],y[3*e.b+1],y[3*e.b+2]),(f=new THREE.Vector3).set(y[3*e.c],y[3*e.c+1],y[3*e.c+2]);for(a=0;a<c.length;a+=3){m=c[a];n.set(y[3*m],y[3*m+1],y[3*m+2]);g=c[a+1];i.set(y[3*g],y[3*g+1],y[3*g+2]);v=c[a+2];r.set(y[3*v],y[3*v+1],y[3*v+2]);var E,l=THREE.Triangle.normal(n,i,r);this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(n),e.normal.dot(h))&&(E=o.vertices.length,o.vertices.push(n.clone()),o.vertices.push(i.clone()),o.vertices.push(r.clone()),o.faces.push(new THREE.Face3(E,E+1,E+2)))}}return 0<o.vertices.length?this.getTrianglesOnSameFace(o,h,u,f):null},this.edgeSnapping=function(e,t){for(var n=new THREE.Geometry,i=!0,r=!0,o=!0,a=0;a<e.vertices.length;a+=3){for(var s=0;s<e.vertices.length;s+=3)a!==s&&((e.vertices[a].equals(e.vertices[s])||e.vertices[a].equals(e.vertices[s+1])||e.vertices[a].equals(e.vertices[s+2]))&&(e.vertices[a+1].equals(e.vertices[s])||e.vertices[a+1].equals(e.vertices[s+1])||e.vertices[a+1].equals(e.vertices[s+2]))&&(i=!1),(e.vertices[a].equals(e.vertices[s])||e.vertices[a].equals(e.vertices[s+1])||e.vertices[a].equals(e.vertices[s+2]))&&(e.vertices[a+2].equals(e.vertices[s])||e.vertices[a+2].equals(e.vertices[s+1])||e.vertices[a+2].equals(e.vertices[s+2]))&&(r=!1),(e.vertices[a+1].equals(e.vertices[s])||e.vertices[a+1].equals(e.vertices[s+1])||e.vertices[a+1].equals(e.vertices[s+2]))&&(e.vertices[a+2].equals(e.vertices[s])||e.vertices[a+2].equals(e.vertices[s+1])||e.vertices[a+2].equals(e.vertices[s+2]))&&(o=!1));i&&(n.vertices.push(e.vertices[a].clone()),n.vertices.push(e.vertices[a+1].clone())),r&&(n.vertices.push(e.vertices[a].clone()),n.vertices.push(e.vertices[a+2].clone())),o&&(n.vertices.push(e.vertices[a+1].clone()),n.vertices.push(e.vertices[a+2].clone())),o=r=i=!0}for(var l,d=new THREE.Geometry,c=Number.MAX_VALUE,h=0;h<n.vertices.length;h+=2){var u=this.distancePointToLine(t,n.vertices[h],n.vertices[h+1]);u<c&&(c=u,l=h)}return d.vertices.push(n.vertices[l].clone()),d.vertices.push(n.vertices[l+1].clone()),d.vertices=this.getConnectedLineSegmentsOnSameLine(n,d.vertices),f=c,d},this.distancePointToLine=function(e,t,n){var i,r=new THREE.Vector3,o=new THREE.Vector3;return r.subVectors(t,e),o.subVectors(n,t),i=r.dot(o),r.subVectors(n,t),(i=-i/r.dot(r))<0?e.distanceTo(t):1<i?e.distanceTo(n):(r.subVectors(e,t),o.subVectors(e,n),r.cross(o),o.subVectors(n,t),Math.sqrt(r.dot(r))/Math.sqrt(o.dot(o)))},this.getConnectedLineSegmentsOnSameLine=function(e,t){var n=e.vertices.slice(),i=t[0],r=t[1],o=[];do{for(var o=[],a=0;a<n.length;a+=2)if(!n[a].equals(i)||!n[a+1].equals(r))for(var s=0;s<t.length;s+=2)if(n[a].equals(t[s])||n[a+1].equals(t[s])||n[a].equals(t[s+1])||n[a+1].equals(t[s+1])){var l=new THREE.Vector3,d=new THREE.Vector3;if(l.subVectors(t[s],t[s+1]),l.normalize(),d.subVectors(n[a],n[a+1]),d.normalize(),this.isEqualVectorsWithPrecision(l,d)||this.isInverseVectorsWithPrecision(l,d)){o.push(a);break}}for(var c=o.length-1;0<=c;--c)t.push(n[o[c]]),t.push(n[o[c]+1]),n.splice(o[c],2)}while(0<o.length);return t},this.vertexSnapping=function(e,t){for(var n=Number.MAX_VALUE,i=new THREE.Vector3,r=0;r<e.vertices.length;++r){var o=t.distanceTo(e.vertices[r]);o<n-.001&&(n=o,i=e.vertices[r].clone())}return c=n,i},this.setDetectRadius=function(e){var t=ye.isMobileDevice()?25:10,n=b.camera.getCameraTarget(),i=b.camera.position,r=new THREE.Vector3;r.subVectors(n,i);e=e.clone(),i=b.camera.isPerspective?e.sub(i).dot(r.normalize()):r.length(),r=b.camera.fov,i=2*i*Math.tan(THREE.Math.degToRad(.5*r)),r=b.renderer.domElement.height;return t*i*b.renderer.getPixelRatio()/r},this.doSnapping=function(e){l=!1,a=o=null;var t=e.face;s=e.point;var n,i=e.object;(i=b.ndsModel&&i instanceof De&&-1<e.meshId?b.ndsModel.meshManager.getSingleMesh(e.meshId):i)instanceof THREE.Mesh&&i.hasOwnProperty("geometry")?(o=this.faceSnapping(t,i.geometry))&&(o.applyMatrix(i.matrixWorld),r=this.edgeSnapping(o,s),a=this.vertexSnapping(r,s),h=this.setDetectRadius(s),d=c<h?0:f<h?1:2,l=!0):i instanceof THREE.LineSegments&&i.hasOwnProperty("geometry")&&((n=i.geometry)instanceof THREE.BufferGeometry&&(t=n.attributes.position.array,e=(i=n.index.array)[n=e.index],i=i[n+1],(n=new THREE.Vector3).set(t[3*e],t[3*e+1],t[3*e+2]),(e=new THREE.Vector3).set(t[3*i],t[3*i+1],t[3*i+2]),h=2*this.setDetectRadius(s),s.distanceTo(n)<h?(a=n,l=!(d=0)):s.distanceTo(e)<h&&(a=e,l=!(d=0))))}}n(148),n(150);NDS.INFOTYPE={POINT:1,SECONDPOINT:2,POINTLINE:3,LINE:4,POINTPLANE:5,PLANE:6,SECONDLINE:7,LINEPLANE:8,PARALLELLINE:9,PARALLELPLANE:10,CIRCLE:11,SECONDCIRCLE:12,SECONDPLANE:13,AXISLINE:14,AXISPOINT:15,AXIS:16,AXISPLANE:17,FACE:18,CIRCLEANDLINE:19,FIRSTPOINT:20,BODY:21,LINEPOSITION:22,FIRMEASUREBODY:23,SECMEASUREBODY:24,MEASUREBODY:25,THIRDPOINT:26,ENDMEASURE:27,CANCELLINE:28,FIRSTLINE:29,MOUSEENTER:30,CROSSENTER:31,FIRSTPLANE:32,COORDINATEPOINT:33,CIRCLEA:34,LINEANDCIRCLE:35,FIRSTPARALLELPLANE:36,MEASURENOTICEBEGIN:37,AXISNOPARALLEL:38,NOPARALLEL:39,INTERSECT:40,LINEPARALLEL:41,PLANEPARALLELLINE:42,LINEPARALLELPLANE:43,PLANEPARALLEL:44,TWOAXISNOPARALLEL:45,NOBREP:46,NOCONJOINT:47,NOCLOSE:48,PLANENOPARALLEL:49,LINENOPARALLEL:50,NOTFACE:51,LOADDATE:52,TWOBODYPARALLEL:53,TWOBODYNOTPARALLEL:54,NOTFACEPARALLEL:55,NOTFACESECOND:56},NDS.MEASUREFLAG={pt2pt:1,pointtoline:2,pointtoface:4,axistopoint:8,linetoline:16,linetoface:32,facedist:64,axistoline:128,axistoface:256,holedist:512,Edge:512,perimeter:1024,LineAngle:2048,LineFaceAngle:4096,faceAngle:8192,radius:16384,contour:32768,contourarea:65536,Lineargauge:131072,coordinate:262144,bodyAngle:524288,bodyDistance:1048576,bodyEdgeLength:2097152,angle:4194304,pt2ptbim:8388608};var Xe=function(e){this.viewer=e.viewer,this.OpMeasure=e,this.measureType="",this.measureClass="Base",this.InfoType=0,this.snappingTool=new Ye(this.viewer),this.snappedPoint=null,this.textLines=[],this.POINTSIZE=3,this.LINEWIDTH=2,this.ARCWIDTH=2,this.CYLINDERWIDTH=14,this.cylinderRadiusBottom=.4,this.cylinderHeight=1.2,this.edgeInfo={startPos:null,endPos:null,selLineInfo:null,selLineObj:null,preSelLineInfo:null,preSelLineObj:null,startToClndLine:null,endToClndLine:null,clndToClndLine:null,lineType:"",boxToClndLine:null,centerToClndLine:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,selLineCenterPos:null,dimString:"",unit:"",textBox:null,textPos:null},this.holeInfo={firstHoleInfo:null,secondHoleInfo:null,preSelHoleInfo:null,preSelHoleObj:null,firstSelHoleObj:null,secondSelHoleObj:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,centerToClndLine:null,centerToClndLine2:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,selLineCenterPos:null,textBox:null,textPos:null,dimString:"",unit:""},this.distanceInfo={firstSelObj:null,firstSelInfo:null,secondSelObj:null,secondSelInfo:null,axisLineObj:null,secaxisLineObj:null,firstPoint:null,secondPoint:null,preSelInfo:null,preSelObj:null,preSelInfoOld:null,fstToSndLine:null,FstToFstPointLine:null,SndToSndPointLine:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,dimString:"",unit:"",textBox:null,textPos:null,XorY:0,mousePos:null},this.faceInfo={fstIntersect:null,sndIntersect:null,firstFaceInfo:null,secondFaceInfo:null,preSelFaceInfo:null,preSelFaceObj:null,fstSelFaceObj:null,sndSelFaceObj:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,fstClnd:null,sndClnd:null,fstToMidLine:null,midToClndLine:null,arcMeshes:[],arcCenter:null,midLineEndPt:null,fstClndPos:null,sndClndPos:null,dimString:"",unit:"",textBox:null,textPos:null,selFaceObjs:[],selFaceInfors:[]},this.lineAngleInfo={firstLineObj:null,firstLineInfo:null,secondLineObj:null,secondLineInfo:null,preSelLineInfo:null,preSelLineObj:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,arcMeshes:[],arcCenter:null,auxLine1:null,auxLine2:null,dimString:"",unit:"",textBox:null,textPos:null,twoPlane:!1,firstHelpPointobj:null,firstHelpPointInfo:null,secHelpPointobj:null,secHelpPointInfo:null,thrHelpPointobj:null,thrHelpPointInfo:null},this.lineContoursInfo={preSelLineInfo:null,preSelLineObj:null,prestart:new THREE.Vector2,preend:new THREE.Vector2,unit:"",divPos:null,divBox:null,perimeter:0,Contours:[],start:new THREE.Vector2,end:new THREE.Vector2},this.perimeterInfos=[],this.preSelectBody=null,this.preSelectBodyMat=null,this.contourdiv=null,this.coordinatediv=null,this.coordinatedivtextPos=null,this.coordinatedivdims=null,this.lineargaugediv=null,this.shadowdiv=null,this.materialLine=new THREE.MeshBasicMaterial({color:8190976,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),this.appmaterialLine=new THREE.MeshBasicMaterial({color:16743724,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),this.materialPoint=Ue.selectedVertexMaterial,this.axisLine=new THREE.LineBasicMaterial({opacity:1,color:16711680,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!1}),this.materialBoxLine=new THREE.LineBasicMaterial({opacity:.8,color:8190976,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0}),this.materialPreSelectMeshopacity=new THREE.MeshBasicMaterial({color:65535,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,transparent:!1});var o=this;this.touchstart=function(e){if(this.parentElement){switch(o.OpMeasure.unsteady=!0,o.measureType){case"PointToLine":case"PointToFace":case"AxisToPoint":case"LineToLine":case"LineToFace":case"faceDist":case"AxisToLine":case"AxisToFace":case"holeDist":case"pt2pt":case"pt2ptbim":o.OpMeasure.unsteadyType="Distance";break;case"radius":o.OpMeasure.unsteadyType="Radius";break;case"measureEdges":o.OpMeasure.unsteadyType="measureEdges";break;case"LineAngle":case"LineFaceAngle":case"faceAngle":case"angle":o.OpMeasure.unsteadyType="Angle";break;case"bodyAngle":case"bodyEdgeLength":case"bodyDistance":o.OpMeasure.unsteadyType=o.measureType}o.OpMeasure.unsteadyuuid=this.getAttribute("group"),o.OpMeasure.unsteadyTextBox=this,o.OpMeasure.unsteadyMoving=!1,o.OpMeasure.startPoint=e.touches?[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY],e.preventDefault()}},this.touchend=function(e){o.OpMeasure.unsteady=!1,o.OpMeasure.unsteadyuuid=null,o.OpMeasure.unsteadyMoving=!1,o.OpMeasure.startPoint=null,o.OpMeasure.unsteadyType="",e.preventDefault()},this.touchmove=function(e){var t=e.touches?[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY],n=o.OpMeasure.startPoint,i=1.1*window.devicePixelRatio;t&&n&&(Math.abs(t[0]-n[0])>i||Math.abs(t[1]-n[1])>i)?(o.OpMeasure.startPoint=t,o.OpMeasure.unsteadyTextBox=this,o.OpMeasure.unsteadyMoving=!0,t=document.createEvent("HTMLEvents"),ye.isMobileDevice()?(t.initEvent("touchmove",!0,!0),t.touches=e.touches,1==e.touches.length&&(o.OpMeasure.state=NDS.TOUCH.TOUCH_SINGLE)):(t.initEvent("mousemove",!0,!0),0===e.button&&(o.OpMeasure.state=NDS.MOUSE.NONE),t.offsetX=e.offsetX,t.clientX=e.clientX,t.offsetY=e.offsetY,t.clientY=e.clientY),(o.viewer.canvas2D||o.viewer.canvas3D).dispatchEvent(t),e.preventDefault()):ye.isMobileDevice()||o.OpMeasure.InfoType!=NDS.INFOTYPE.MOUSEENTER&&o.OpMeasure.InfoType!=NDS.INFOTYPE.CROSSENTER&&o.OpMeasure.PostInfo(NDS.INFOTYPE.MOUSEENTER)},this.mouseenter=function(){o.OpMeasure.InfoType!=NDS.INFOTYPE.MOUSEENTER&&o.OpMeasure.InfoType!=NDS.INFOTYPE.CROSSENTER&&o.OpMeasure.InfoType!=NDS.INFOTYPE.MEASURENOTICEBEGIN&&(o.InfoType=o.OpMeasure.InfoType),o.OpMeasure.PostInfo(NDS.INFOTYPE.MOUSEENTER),o.clearPreInfo()},this.mouseleave=function(e){o.OpMeasure.unsteady||o.OpMeasure.PostInfo(o.InfoType)},this.sectionCrossend=function(e){if(e&&e.preventDefault(),!o.OpMeasure.unsteadyMoving){o.OpMeasure.unsteadyuuid=this.parentElement.getAttribute("group");e=o.OpMeasure.rootObject.getObjectByProperty("uuid",o.OpMeasure.unsteadyuuid);delete o.OpMeasure.unsteadyData[o.OpMeasure.unsteadyuuid],o.OpMeasure.rootObject.remove(e),o.viewer.container.removeChild(this.parentElement);for(var t=999,n=0;n<o.OpMeasure.boxInfos.length;++n){var i=o.OpMeasure.boxInfos[n],r=Number(i.textBox.getAttribute("lineInfo"));i.textBox.getAttribute("group")==o.OpMeasure.unsteadyuuid&&(o.OpMeasure.boxInfos.splice(n,1),t=r,n--),t<r&&i.textBox.setAttribute("lineInfo",r-1)}for(n=0;n<o.OpMeasure.textLines.length;++n)if((i=o.OpMeasure.textLines[n]).uuid==o.OpMeasure.unsteadyuuid){o.OpMeasure.textLines.splice(n,1);break}o.OpMeasure.unsteady=!1,o.OpMeasure.submeasureTimes(),o.OpMeasure.PostInfo(o.InfoType),o.OpMeasure.viewer.render()}},this.crossenter=function(e){e.preventDefault(),o.OpMeasure.InfoType!=NDS.INFOTYPE.MOUSEENTER&&o.OpMeasure.InfoType!=NDS.INFOTYPE.CROSSENTER&&o.OpMeasure.InfoType!=NDS.INFOTYPE.MEASURENOTICEBEGIN&&(o.InfoType=o.OpMeasure.InfoType),o.OpMeasure.PostInfo(NDS.INFOTYPE.CROSSENTER)},this.crossleave=function(e){e.preventDefault(),o.OpMeasure.PostInfo(o.InfoType)}};Xe.prototype.OperatorStart=function(e){this.measureType=e,this.snappedPoint=null,this.OpMeasure.PostInfo()},Xe.prototype.OperatorEnd=function(){this.OpMeasure.PostInfo(),this.clearDistanceInfo(),this.clearHoleInfo(),this.clearEdgeInfo(),this.clearPerimetrBox(),this.clearFaceInfo(),this.clearLineAngleInfo(),this.ClearmeasureBodyVolumeAndAreaPre(),this.measureBoundingBox(!1),this.clearCoordinate(),this.clearContoursInfo()},Xe.prototype.onNMouseMove=function(e,t){},Xe.prototype.onLMouseClick=function(e,t,n){},Xe.prototype.renderMeasureScene=function(){this.update2DScene()},Xe.prototype.Bline=function(e){var t=e.geometry,n=e.indexRange.concat();if(n[1]==n[0])return!0;if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/2,n[1]+=t.drawRange.start/2),t.isBufferGeometry){var i=t.index,r=t.attributes.position.array;if(null!=i){var o=i.array,a=new THREE.Vector3,s=new THREE.Vector3,e=new THREE.Vector3,t=n[0],i=n[1],n=Math.round(.5*(t+i));if(a.fromArray(r,3*o[2*t]),s.fromArray(r,3*o[2*i+1]),s.distanceTo(a)<1e-7)return!1;e.fromArray(r,3*o[2*n]);a=a.clone().sub(e).normalize();return e.clone().sub(s).normalize().distanceTo(a)<2*Math.sin(2*Math.PI/180)}}},Xe.prototype.FindParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D||e instanceof De){var t=e.type.toLowerCase();if(this.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var n=e.parent;null!=n&&null!=n;)"instanceobject"==n.type.toLowerCase()&&(e=n),n=n.parent;return e}return this.FindParentElement(e.parent)}return this.FindParentElement(e.parent)},Xe.prototype.getFilterDistByBody=function(e){var t,n,i=.5;return e?(e.boxDiagonalLength||(t=new THREE.Vector3,n=new THREE.Vector3,this.viewer.computeBoundingBox(e,t,n,{flag:!0}),e.boxDiagonalLength=n.distanceTo(t)),i=.015*e.boxDiagonalLength):i},Xe.prototype.getSnappingPntEx=function(e){if(e){var t;if(this.viewer.hasBrepInfo()){var n=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(!n)return;var i=n.uuid,r=this.viewer.brepManager.GetEdgesExtremePointsByBodyUUID(i);if(!r||r.length<=0)return;for(var o,n=this.getFilterDistByBody(n),a=n*n,s=e.point.clone(),n=this.viewer.modelCoordToClientCoord([s.x,s.y,s.z]),l=new THREE.Vector3(n[0],n[1],0),d=new THREE.Vector3,c=64,h=0;h<r.length;h++)s.distanceToSquared(r[h])<a&&(o=this.viewer.modelCoordToClientCoord([r[h].x,r[h].y,r[h].z]),d.set(o[0],o[1],0),(o=l.distanceToSquared(d))<c&&(t=r[h],c=o))}else Ue.inBIMContext||(this.snappingTool.doSnapping(e),this.snappingTool.isSnapped()&&0==this.snappingTool.getSnappedType()&&(t=this.snappingTool.getSnappedVertex()));return t}},Xe.prototype.doRaycasterPick=function(e,t,n){var i=this.viewer,r=i.renderer.domElement,o=i.renderer.getPixelRatio(),e=e*o/r.width*2-1,o=2*-(t*o/r.height)+1,r=new THREE.Raycaster;i.camera.setCastRay(r,e,o),n&&(r.linePrecision=this.getLinePrecision());return i.ndsModel?n?i.ndsModel.intersect(r.ray,r.linePrecision):i.ndsModel.intersect(r.ray):n?r.intersectObjects(i.selectionManager.getTargetIncludeLineList()):r.intersectObjects(i.selectionManager.getTargetList())},Xe.prototype.getSelectInfoFromIntersect=function(e){if(e&&this.viewer.hasBrepInfo()){var t=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(t){var n,i,r,o=t.uuid,t=e.object.uuid;return this.viewer.ndsModel&&(0<=e.meshId?(e.mesh=this.viewer.ndsModel.meshManager.getSingleMesh(e.meshId),e.mesh&&(n=e.faceIndex-e.mesh.geometry.drawRange.start/3,i="face")):0<=e.lineSegId&&(e.mesh=this.viewer.ndsModel.meshManager.getLineSegments(e.lineSegId),e.mesh&&(n=.5*(e.index-e.mesh.geometry.drawRange.start),i="edge")),t=e.geomUuid),0<=n&&(r=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(o,t,n,i))&&(r.parentObj=e.mesh,r.geometry=e.mesh.geometry,r.matrixWorld=e.mesh.matrixWorld.clone(),r.intersect=e.point.clone(),r.bodyId=e.bodyId,r.bodyUuid=e.bodyUuid,r.meshId=e.meshId,r.topolIndex=n,r.topolType=i,r.lineSegId=e.lineSegId,"face"==i&&(r.edgeInfos=this.viewer.brepManager.GetEdgeInfoFromFace(o,r.edgeIDS)),r.normal&&null==r.worldNormal&&(e=new THREE.Vector3,i=new THREE.Quaternion,o=new THREE.Vector3,r.parentObj.matrixWorld.decompose(e,i,o),r.worldNormal=new THREE.Vector3(r.normal[0],r.normal[1],r.normal[2]),r.worldNormal.applyQuaternion(i)),r.origin&&null==r.worldOrigin&&(r.worldOrigin=new THREE.Vector3(r.origin[0],r.origin[1],r.origin[2]),r.worldOrigin.applyMatrix4(r.matrixWorld))),r}}},Xe.prototype.previewSnappedPoint=function(e,t,n){var i=!1;null!=this.snappedPoint&&(i=!0),this.snappedPoint=null;e=this.doRaycasterPick(e,t,!0);e&&0<e.length&&((t=this.getSnappingPntEx(e[0]))&&(this.snappedPoint=t,i=!0)),!this.snappedPoint&&e&&0<e.length&&((e=this.getSelectInfoFromIntersect(e[0]))&&"circle"==e.type&&n&&((n=new THREE.Vector3(e.center[0],e.center[1],e.center[2])).applyMatrix4(e.matrixWorld),this.snappedPoint=n,i=!0)),i&&this.update2DScene()},Xe.prototype.previewSnappedPoint2=function(e,t){var n,i=!1;null!=this.snappedPoint&&(i=!0),this.snappedPoint=null,e&&0<e.length&&((n=this.getSnappingPntEx(e[0]))&&(this.snappedPoint=n,i=!0)),!this.snappedPoint&&e&&0<e.length&&((e=this.getSelectInfoFromIntersect(e[0]))&&"circle"==e.type&&t&&((t=new THREE.Vector3(e.center[0],e.center[1],e.center[2])).applyMatrix4(e.matrixWorld),this.snappedPoint=t,i=!0)),i&&this.update2DScene()},Xe.prototype.get2dPoint=function(e){e.project(this.viewer.camera);var t=this.viewer.renderer.domElement.width/2,n=this.viewer.renderer.domElement.height/2;return{x:Math.round(e.x*t+t),y:Math.round(-e.y*n+n)}},Xe.prototype.addAnnotationTip=function(e,t,n){var i,r,o=this.viewer.renderer.getPixelRatio();t/=o,n/=o;var a=this.viewer.renderer.domElement.width*this.viewer.renderer.domElement.height/(o*o)/445440,o=1<=a?(i=13,r=35,14):((r=Math.round(35*a))<22&&(a=(r=22)/35),i=Math.round(13*a),Math.round(.35*r)),a=document.createElement("div");return a.className="perimeterLogo",a.style.width=2*i+"px",a.style.height=r+"px",a.style.top=n-r+"px",a.style.left=t-i+"px",a.style.fontSize=o+"px",a.style.paddingTop=Math.round(.3*(r-o))+"px",a.style.opacity=1,a.innerHTML=e.toString(),a.innerText=e.toString(),a},Xe.prototype.getAndShowTextBox=function(e,t,n){var i,r,o,a;n&&(i=this.get2dPoint(e),null!=n.screenX&&Math.abs(n.screenX-i.x)<=2&&null!=n.screenY&&Math.abs(n.screenY-i.y)<=2||(r=this.viewer.renderer.getPixelRatio(),o=n.clientWidth,a=n.clientHeight,n.screenX=i.x,n.screenY=i.y,"up"==n.getAttribute("mobile")?(n.style.left=Math.round(i.x/r-o/2)+"px",n.style.top=Math.round(i.y/r-a)+"px",null!=t&&(n.childNodes[0].data=t)):"right"==n.getAttribute("mobile")?(n.style.left=Math.round(i.x/r-o)+"px",n.style.top=Math.round(i.y/r-a/2)+"px",null!=t&&(n.childNodes[0].data=t)):"down"==n.getAttribute("mobile")?(n.style.left=Math.round(i.x/r-o/2)+"px",n.style.top=Math.round(i.y/r+0)+"px",null!=t&&(n.childNodes[0].data=t)):"left"==n.getAttribute("mobile")?(n.style.left=Math.round(i.x/r+0)+"px",n.style.top=Math.round(i.y/r-a/2)+"px",null!=t&&(n.childNodes[0].data=t)):(n.style.left=Math.round(i.x/r)+"px",n.style.top=Math.round(i.y/r)+"px",null!=t&&(n.innerHTML=t)),"true"==n.getAttribute("needDown")&&(n.style.top=Math.round(i.y/r)+20+"px"),e=null))},Xe.prototype.update2DScene=function(){var e=this.viewer.renderer.getPixelRatio(),t=this.viewer.canvas2D.getContext("2d");if(t.clearRect(0,0,window.innerWidth*e,window.innerHeight*e),(c=this.viewer.watermark)&&this.viewer.excalibur)if(ye.isMobileDevice()){c=c.substr(0,20);var n=Math.cos(45*Math.PI/180),i=Math.sin(45*Math.PI/180),r=(d=this.viewer.canvas2D.width/2)*n-(l=this.viewer.canvas2D.height/2)*i,n=d*i+l*n,o=c.length+1;(h=this.viewer.canvas2D.getContext("2d")).rotate(-45*Math.PI/180),h.clearRect(r-24*o,n-48,48*o,60),h.font="bold 48px Arial",h.textAlign="center",h.fillStyle="#137FE2",h.globalAlpha=this.viewer.is2DModel?.2:.05,h.fillText(c,r,n),h.rotate(45*Math.PI/180),h.globalAlpha=1}else{var a=0,s=0,l=0,d=0,a=-this.viewer.canvas2D.width;for(d=0;a<this.viewer.canvas2D.width;a+=150,d++){for(l=s=0;s<2*this.viewer.canvas2D.height;s+=100,l++){var c,h,o=(c=c.substr(0,20)).length+1;(h=this.viewer.canvas2D.getContext("2d")).rotate(-25*Math.PI/180),h.clearRect(a-18*o/2,s-18,18*o,27),h.font="bold 18px Arial",h.textAlign="center",h.fillStyle="#000000",h.globalAlpha=.1,h.fillText(c,a,s),h.rotate(25*Math.PI/180),h.globalAlpha=1}a+=18*o}}if(this.snappedPoint&&(n=this.get2dPoint(this.snappedPoint.clone()),t.fillStyle="#00FFFF",t.beginPath(),t.arc(n.x,n.y,4,0,2*Math.PI),t.closePath(),t.fill()),"radius"!=this.measureType&&"diameter"!=this.measureType||!this.OpMeasure.rootObject.visible||this.holeInfo.textPos&&this.holeInfo.fstClndPos&&(f=this.get2dPoint(this.holeInfo.textPos.clone()),p=this.get2dPoint(this.holeInfo.fstClndPos.clone()),t.strokeStyle="#00FF00",t.lineWidth=e,t.beginPath(),t.moveTo(f.x,f.y),t.lineTo(p.x,p.y),t.stroke()),0<this.OpMeasure.textLines.length&&this.OpMeasure.rootObject.visible){this.viewer.is2DModel?t.strokeStyle="#00FF00":t.strokeStyle="#FF7D2C",t.lineWidth=e,t.beginPath();for(var u=0;u<this.OpMeasure.textLines.length;u++){var f=this.get2dPoint(this.OpMeasure.textLines[u].start.clone()),p=this.get2dPoint(this.OpMeasure.textLines[u].end.clone());t.moveTo(f.x,f.y),t.lineTo(p.x,p.y)}t.stroke()}},Xe.prototype.clearPreSelect=function(){this.holeInfo.preSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.distanceInfo.preSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.lineContoursInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.edgeInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.faceInfo.preSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.ClearmeasureBodyVolumeAndAreaPre(),this.snappedPoint=null,this.clearCoordinate()},Xe.prototype.clearHoleInfo=function(e){this.holeInfo.preSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),1!=e&&(this.holeInfo.firstSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.firstSelHoleObj),this.holeInfo.secondSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.secondSelHoleObj),this.holeInfo.textBox&&this.viewer.container.removeChild(this.holeInfo.textBox),this.holeInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.fstToClndLine),this.holeInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.sndToClndLine),this.holeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.clndToClndLine),this.holeInfo.centerToClndLine2&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine2),this.holeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine),this.holeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.boxToClndLine),this.holeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.sndClnd)),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null,this.holeInfo.firstSelHoleObj=null,this.holeInfo.firstHoleInfo=null,this.holeInfo.secondSelHoleObj=null,this.holeInfo.secondHoleInfo=null,this.holeInfo.fstToClndLine=null,this.holeInfo.sndToClndLine=null,this.holeInfo.clndToClndLine=null,this.holeInfo.boxToClndLine=null,this.holeInfo.centerToClndLine=null,this.holeInfo.centerToClndLine2=null,this.holeInfo.selLineCenterPos=null,this.holeInfo.fstClnd=null,this.holeInfo.sndClnd=null,this.holeInfo.fstClndPos=null,this.holeInfo.sndClndPos=null,this.holeInfo.textBox=null,this.holeInfo.textPos=null,this.holeInfo.dimString="",this.holeInfo.unit=""},Xe.prototype.clearPreInfo=function(){this.distanceInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelLineObj),this.distanceInfo.preSelLineObj=null,this.distanceInfo.preSelLineInfo=null),this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null),this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelLineObj=null,this.holeInfo.preSelLineInfo=null),this.edgeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelHoleObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null),this.ClearmeasureBodyVolumeAndAreaPre(),this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null)},Xe.prototype.clearDistanceInfo=function(e){this.distanceInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.preSelLineObj),1!=e&&(this.distanceInfo.firstSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.secondSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.axisLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.secaxisLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.secaxisLineObj),this.distanceInfo.fstToSndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToSndLine),this.distanceInfo.FstToFstPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.FstToFstPointLine),this.distanceInfo.SndToSndPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.SndToSndPointLine),this.distanceInfo.textBox&&this.viewer.container.removeChild(this.distanceInfo.textBox),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd)),this.distanceInfo.preSelLineObj=null,this.distanceInfo.preSelLineInfo=null,this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelObj=null,this.distanceInfo.axisLineObj=null,this.distanceInfo.secaxisLineObj=null,this.distanceInfo.secondSelInfo=null,this.distanceInfo.firstPoint=null,this.distanceInfo.secondPoint=null,this.distanceInfo.fstToSndLine=null,this.distanceInfo.FstToFstPointLine=null,this.distanceInfo.SndToSndPointLine=null,this.distanceInfo.fstToClndLine=null,this.distanceInfo.sndToClndLine=null,this.distanceInfo.clndToClndLine=null,this.distanceInfo.boxToClndLine=null,this.distanceInfo.fstClnd=null,this.distanceInfo.sndClnd=null,this.distanceInfo.fstClndPos=null,this.distanceInfo.sndClndPos=null,this.distanceInfo.dimString="",this.distanceInfo.unit="",this.distanceInfo.textBox=null,this.distanceInfo.textPos=null,this.distanceInfo.mousePos=null,this.distanceInfo.XorY=0,this.lineargaugediv&&"none"!=this.lineargaugediv.style.display&&(this.lineargaugediv.style.display="none"),this.shadowdiv&&"none"!=this.shadowdiv.style.display&&(this.shadowdiv.style.display="none")},Xe.prototype.clearContoursInfo=function(e){if(this.lineContoursInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),1!=e)for(var t=0;t<this.lineContoursInfo.Contours.length;++t){var n=this.lineContoursInfo.Contours[t];this.OpMeasure.rootObject.remove(n.lineobj)}this.lineContoursInfo.Contours=[],this.lineContoursInfo.preSelLineInfo=null,this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.prestart=new THREE.Vector2,this.lineContoursInfo.preend=new THREE.Vector2,this.lineContoursInfo.unit="",this.lineContoursInfo.divPos=null,this.lineContoursInfo.divBox=null,this.lineContoursInfo.perimeter=0,this.lineContoursInfo.start=new THREE.Vector2,this.lineContoursInfo.end=new THREE.Vector2,this.contourdiv&&1!=e&&(this.viewer.container.removeChild(this.contourdiv),this.contourdiv=null)},Xe.prototype.clearEdgeInfo=function(e){1!=e&&(this.edgeInfo.selLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.selLineObj),this.edgeInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.startToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine),this.edgeInfo.endToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine),this.edgeInfo.textBox&&this.OpMeasure.viewer.container.removeChild(this.edgeInfo.textBox),this.edgeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.centerToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd),this.edgeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd)),this.edgeInfo.startPos=null,this.edgeInfo.endPos=null,this.edgeInfo.selLineInfo=null,this.edgeInfo.selLineObj=null,this.edgeInfo.preSelLineInfo=null,this.edgeInfo.preSelLineObj=null,this.edgeInfo.startToClndLine=null,this.edgeInfo.endToClndLine=null,this.edgeInfo.clndToClndLine=null,this.edgeInfo.lineType="",this.edgeInfo.clndToClndLine=null,this.edgeInfo.boxToClndLine=null,this.edgeInfo.centerToClndLine=null,this.edgeInfo.fstClnd=null,this.edgeInfo.sndClnd=null,this.edgeInfo.fstClndPos=null,this.edgeInfo.sndClndPos=null,this.edgeInfo.selLineCenterPos=null,this.edgeInfo.dimString="",this.edgeInfo.unit="",this.edgeInfo.textBox=null,this.edgeInfo.textPos=null},Xe.prototype.clearPerimetrBox=function(){for(var e=0,t=this.perimeterInfos.length;e<t;e++){var n=this.perimeterInfos[e];this.viewer.container.removeChild(n.textimg),n.textPos=null,n.textimg=null}this.perimeterInfos.splice(0,this.perimeterInfos.length)},Xe.prototype.measureBoundingBox=function(e){for(var t,n,i,r,o,a,s,l,d,c=0,h=this.OpMeasure.boundingboxInfos.length;c<h;c++){var u=this.OpMeasure.boundingboxInfos[c];this.viewer.container.removeChild(u.textBox),u.textPos=null,u.textBox=null}this.OpMeasure.boundingboxInfos.splice(0,this.OpMeasure.boundingboxInfos.length),e?(d=this.viewer.modelRootObject.boundingBox.clone(),this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null),Ue.inBIMContext&&0<this.viewer.ndsModel.ModelUpMatrix4.length&&((a=new THREE.Matrix4).fromArray(this.viewer.ndsModel.ModelUpMatrix4),d.applyMatrix4(a)),this.OpMeasure.boundingboxmesh=this.createBoundingBox(d),this.distanceInfo.unit=this.getUnitString(),this.OpMeasure.rootObject.add(this.OpMeasure.boundingboxmesh),t=d.max.x-d.min.x,n=d.max.y-d.min.y,i=d.max.z-d.min.z,t*=(s=this.viewer.getDispalyModelUnit(t)).scale,n*=s.scale,i*=s.scale,l=this.getUnitStringmap(s.unit),t=t.toFixed(2)+l,n=n.toFixed(2)+l,i=i.toFixed(2)+l,(r=document.createElement("div")).style.position="absolute",r.style.color="white",r.style.zIndex=3,r.style.backgroundColor="rgba(115,0,230,0.75)",r.style.userSelect="none",r.style.pointerEvents="none",this.viewer.container.appendChild(r),(o=document.createElement("div")).style.position="absolute",o.style.color="white",o.style.zIndex=3,o.style.backgroundColor="rgba(115,0,230,0.75)",o.style.userSelect="none",o.style.pointerEvents="none",this.viewer.container.appendChild(o),(e=document.createElement("div")).style.position="absolute",e.style.color="white",e.style.zIndex=3,e.style.backgroundColor="rgba(115,0,230,0.75)",e.style.userSelect="none",e.style.pointerEvents="none",this.viewer.container.appendChild(e),a=d.max.clone().sub(new THREE.Vector3((d.max.x-d.min.x)/2,0,0)),s=d.max.clone().sub(new THREE.Vector3(0,(d.max.y-d.min.y)/2,0)),l=d.max.clone().sub(new THREE.Vector3(0,0,(d.max.z-d.min.z)/2)),this.getAndShowTextBox(a.clone(),t,r),this.getAndShowTextBox(s.clone(),n,o),this.getAndShowTextBox(l.clone(),i,e),(d={}).dimString=t,d.textPos=a.clone(),d.textBox=r,this.OpMeasure.boundingboxInfos.push(d),(d={}).dimString=n,d.textPos=s.clone(),d.textBox=o,this.OpMeasure.boundingboxInfos.push(d),(d={}).dimString=i,d.textPos=l.clone(),d.textBox=e,this.OpMeasure.boundingboxInfos.push(d)):this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null)},Xe.prototype.clearFaceInfo=function(e){if(this.faceInfo.preSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.fstSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.faceInfo.sndSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),1!=e){this.faceInfo.textBox&&this.viewer.container.removeChild(this.faceInfo.textBox),this.faceInfo.fstToMidLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToMidLine),this.faceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToClndLine),this.faceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.sndToClndLine),this.faceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.clndToClndLine),this.faceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.boxToClndLine),this.faceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.fstClnd),this.faceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.sndClnd);for(var t=0;t<this.faceInfo.arcMeshes.length;t++)this.OpMeasure.rootObject.remove(this.faceInfo.arcMeshes[t])}this.faceInfo.arcMeshes=[],this.faceInfo.fstIntersect=null,this.faceInfo.sndIntersect=null,this.faceInfo.firstFaceInfo=null,this.faceInfo.secondFaceInfo=null,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj=null,this.faceInfo.fstSelFaceObj=null,this.faceInfo.sndSelFaceObj=null,this.faceInfo.fstToMidLine=null,this.faceInfo.fstToClndLine=null,this.faceInfo.sndToClndLine=null,this.faceInfo.clndToClndLine=null,this.faceInfo.boxToClndLine=null,this.faceInfo.fstClnd=null,this.faceInfo.sndClnd=null,this.faceInfo.fstClndPos=null,this.faceInfo.sndClndPos=null,this.faceInfo.dimString="",this.faceInfo.unit="",this.faceInfo.textBox=null,this.faceInfo.textPos=null,this.faceInfo.arcCenter=null,this.faceInfo.midLineEndPt=null;for(var n=this.faceInfo.selFaceInfors.length=0,i=this.faceInfo.selFaceObjs.length;n<i;n++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[n]);this.faceInfo.selFaceObjs.length=0},Xe.prototype.clearLineAngleInfo=function(e){if(this.lineAngleInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),1!=e){this.lineAngleInfo.firstLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.secondLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.secondLineObj),this.lineAngleInfo.textBox&&this.viewer.container.removeChild(this.lineAngleInfo.textBox),this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine2&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine2);for(var t=0;t<this.lineAngleInfo.arcMeshes.length;t++)this.OpMeasure.rootObject.remove(this.lineAngleInfo.arcMeshes[t]);this.lineAngleInfo.firstHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstHelpPointobj),this.lineAngleInfo.secHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.secHelpPointobj),this.lineAngleInfo.thrHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.thrHelpPointobj)}this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null,this.lineAngleInfo.secondLineObj=null,this.lineAngleInfo.secondLineInfo=null,this.lineAngleInfo.firstHelpPointobj=null,this.lineAngleInfo.firstHelpPointInfo=null,this.lineAngleInfo.thrHelpPointobj=null,this.lineAngleInfo.thrHelpPointInfo=null,this.lineAngleInfo.secHelpPointInfo=null,this.lineAngleInfo.secHelpPointobj=null,this.lineAngleInfo.fstClnd=null,this.lineAngleInfo.sndClnd=null,this.lineAngleInfo.fstClndPos=null,this.lineAngleInfo.sndClndPos=null,this.lineAngleInfo.auxLine1=null,this.lineAngleInfo.auxLine2=null,this.lineAngleInfo.arcCenter=null;for(t=0;t<this.lineAngleInfo.arcMeshes.length;t++)this.lineAngleInfo.arcMeshes[t]=null;this.lineAngleInfo.arcMeshes.length=0,this.lineAngleInfo.dimString="",this.lineAngleInfo.unit="",this.lineAngleInfo.textBox=null,this.lineAngleInfo.textPos=null,this.lineAngleInfo.twoPlane=!1},Xe.prototype.clearCoordinate=function(){this.coordinatediv&&(this.viewer.container.removeChild(this.coordinatediv),this.coordinatediv=null,this.coordinatedivtextPos=null,this.coordinatedivdims=null)},Xe.prototype.getSelectedFaceArea=function(){for(var e=0,t=0,n=this.faceInfo.selFaceInfors.length;t<n;t++)e+=parseFloat(this.faceInfo.selFaceInfors[t].area);return e},Xe.prototype.getLineStartEndPoints=function(e){if("cylinder"==e.type&&e.origin&&e.axis){var t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.isBufferGeometry){var i=t.index,r=t.attributes.position,o=new THREE.Vector3,a=new THREE.Vector3;o.fromArray(e.origin),a.fromArray(e.axis),a.normalize();for(var s=0,l=n[0],d=n[1];l<=d;l++){var c=i.getX(E=3*l),h=i.getX(E+1),u=i.getX(E+2),f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3;f.fromBufferAttribute(r,c),p.fromBufferAttribute(r,h),m.fromBufferAttribute(r,u),Math.abs(f.clone().sub(o).dot(a))>Math.abs(s)&&(s=f.clone().sub(o).dot(a)),Math.abs(p.clone().sub(o).dot(a))>Math.abs(s)&&(s=p.clone().sub(o).dot(a)),Math.abs(m.clone().sub(o).dot(a))>Math.abs(s)&&(s=m.clone().sub(o).dot(a)),m=p=f=null}if(0==Math.abs(s))return null;(x=new THREE.Vector3).fromArray(e.origin),x.applyMatrix4(e.matrixWorld);var g=new THREE.Quaternion,r=new THREE.Vector3,v=new THREE.Vector3;e.matrixWorld.decompose(r,g,v),a.applyQuaternion(g);var y=x.clone().add(a.clone().multiplyScalar(s));return{start:x,end:y}}}if("cone"==e.type&&e.origin&&e.axis){t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.isBufferGeometry){i=t.index,r=t.attributes.position,o=new THREE.Vector3,a=new THREE.Vector3;o.fromArray(e.origin),a.fromArray(e.axis),a.normalize();for(s=0,l=n[0],d=n[1];l<=d;l++){var E,c=i.getX(E=3*l),h=i.getX(E+1),u=i.getX(E+2),f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3;f.fromBufferAttribute(r,c),p.fromBufferAttribute(r,h),m.fromBufferAttribute(r,u),Math.abs(f.clone().sub(o).dot(a))>Math.abs(s)&&(s=f.clone().sub(o).dot(a)),Math.abs(p.clone().sub(o).dot(a))>Math.abs(s)&&(s=p.clone().sub(o).dot(a)),Math.abs(m.clone().sub(o).dot(a))>Math.abs(s)&&(s=m.clone().sub(o).dot(a)),m=p=f=null}if(0==Math.abs(s))return null;(x=new THREE.Vector3).fromArray(e.origin),x.applyMatrix4(e.matrixWorld);g=new THREE.Quaternion,r=new THREE.Vector3,v=new THREE.Vector3;e.matrixWorld.decompose(r,g,v),a.applyQuaternion(g);y=x.clone().add(a.clone().multiplyScalar(s));return{start:x,end:y}}}if("circle"==e.type&&e.center){t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/2,n[1]+=t.drawRange.start/2),t.isBufferGeometry){var i=t.index,b=t.attributes.position.array;if(null!=i){var M=i.array,o=new THREE.Vector3,y=new THREE.Vector3,x=new THREE.Vector3(e.center[0],e.center[1],e.center[2]);o.fromArray(b,3*M[2*n[0]]),y.fromArray(b,3*M[2*n[0]+1]);f=x.clone().sub(o).normalize(),p=y.clone().sub(o).normalize();return o.applyMatrix4(e.matrixWorld),y.applyMatrix4(e.matrixWorld),x.applyMatrix4(e.matrixWorld),o.sub(x),y.sub(x),(a=o.clone().cross(y)).normalize(),o.set(e.center[0],e.center[1],e.center[2]),o.applyMatrix4(e.matrixWorld),y=o.clone().add(a),{start:o,end:y}}}}t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/2,n[1]+=t.drawRange.start/2),t.isBufferGeometry){i=t.index,b=t.attributes.position.array;if(null!=i){M=i.array,o=new THREE.Vector3,y=new THREE.Vector3;return o.fromArray(b,3*M[2*n[0]]),y.fromArray(b,3*M[2*n[1]+1]),o.applyMatrix4(e.matrixWorld),y.applyMatrix4(e.matrixWorld),{start:o,end:y}}}return null},Xe.prototype.ClearmeasureBodyVolumeAndAreaPre=function(){this.preSelectBody&&(this.preSelectBodyMat?this.preSelectBody.setUserMaterial(this.preSelectBodyMat):this.preSelectBody.setUserMaterial(null)),this.preSelectBody=null,this.preSelectBodyMat=null},Xe.prototype.createFace=function(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var n=e.geometry,i=e.indexRange.concat();if(this.viewer.ndsModel&&(i[0]+=n.drawRange.start/3,i[1]+=n.drawRange.start/3),n.isBufferGeometry){for(var r=n.index,o=n.attributes.position,a=i[1]-i[0]+1,s=new Float32Array(9*a),l=0,d=new THREE.Vector3,c=i[0],h=i[1];c<=h;c++,l+=1){var u=3*c,f=r.getX(u),p=r.getX(1+u),m=r.getX(2+u),g=new THREE.Vector3,v=new THREE.Vector3,u=new THREE.Vector3;g.fromBufferAttribute(o,f),v.fromBufferAttribute(o,p),u.fromBufferAttribute(o,m);p=(new THREE.Vector3).subVectors(v,g),m=(new THREE.Vector3).subVectors(u,g);p.cross(m).normalize(),d.add(p),s[9*l]=g.x,s[9*l+1]=g.y,s[9*l+2]=g.z,s[9*l+3]=v.x,s[9*l+4]=v.y,s[9*l+5]=v.z,s[9*l+6]=u.x,s[9*l+7]=u.y,s[9*l+8]=u.z,u=v=g=null}i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(s,3)),(a=new THREE.Mesh(i,0==t?Ue.selectedFaceMaterial:Ue.preSelectedFaceMaterial)).objectType="Face",a.FaceInfo=[];i=this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0];a.FaceInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id),a.FaceInfo.push(i),a.FaceInfo.push(e.topolIndex),a.FaceInfo.push(e.meshId),a.FaceInfo.push(t?1:0),a.applyMatrix(e.matrixWorld),a.matrixWorldNeedsUpdate=!0,d.normalize(),e.averagenormal=d}return a}},Xe.prototype.createAxisLine=function(e){if(e&&e.parentObj instanceof THREE.Mesh){var t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.isBufferGeometry){var i=t.index,r=t.attributes.position,o=new THREE.Vector3,a=new THREE.Vector3;o.fromArray(e.origin),a.fromArray(e.axis),a.normalize();for(var s=0,l=n[0],d=n[1];l<=d;l++){var c=3*l,h=i.getX(c),u=i.getX(1+c),f=i.getX(2+c),p=new THREE.Vector3,m=new THREE.Vector3,c=new THREE.Vector3;p.fromBufferAttribute(r,h),m.fromBufferAttribute(r,u),c.fromBufferAttribute(r,f),Math.abs(p.clone().sub(o).dot(a))>Math.abs(s)&&(s=p.clone().sub(o).dot(a)),Math.abs(m.clone().sub(o).dot(a))>Math.abs(s)&&(s=m.clone().sub(o).dot(a)),Math.abs(c.clone().sub(o).dot(a))>Math.abs(s)&&(s=c.clone().sub(o).dot(a)),c=m=p=null}if(0==Math.abs(s))return null;o.applyMatrix4(e.matrixWorld);var g=new THREE.Quaternion,r=new THREE.Vector3,n=new THREE.Vector3;e.matrixWorld.decompose(r,g,n),a.applyQuaternion(g);for(var v=o.clone().add(a.clone().multiplyScalar(s)),y=Math.ceil(Math.abs(s/6)),E=0<s?1:-1,b=new Float32Array(6*y),M=0;M<y;++M){var x=new THREE.Vector3,w=new THREE.Vector3,x=o.clone().add(a.clone().multiplyScalar(6*M*E));6*M+4<Math.abs(s)?w=x.clone().add(a.clone().multiplyScalar(4*E)):w.set(v.x,v.y,v.z),b[6*M]=x.x,b[6*M+1]=x.y,b[6*M+2]=x.z,b[6*M+3]=w.x,b[6*M+4]=w.y,b[6*M+5]=w.z}var g=new THREE.BufferGeometry;g.addAttribute("position",new THREE.BufferAttribute(b,3)),(g=new THREE.LineSegments(g,this.axisLine)).objectType="AxisLine",g.Start=o,g.End=v,g.matrixWorldNeedsUpdate=!0}return g}},Xe.prototype.createLine=function(e,t,n){if(e&&e.parentObj instanceof THREE.Line){var i=e.geometry,r=e.indexRange.concat();if(this.viewer.ndsModel&&(r[0]+=i.drawRange.start/2,r[1]+=i.drawRange.start/2),i.isBufferGeometry){var o=r[1]-r[0]+1,a=i.index,s=i.attributes.position.array,l=new Float32Array(6*o);if(null!=a){var d=a.array,c=0;this.edgeInfo.startPos=new THREE.Vector3,this.edgeInfo.endPos=new THREE.Vector3,this.edgeInfo.midPos=new THREE.Vector3;var h=r[0],u=r[1];Math.round(.5*(h+u));this.edgeInfo.thirdPos=null,this.edgeInfo.startPos.fromArray(s,3*d[2*h]),this.edgeInfo.endPos.fromArray(s,3*d[2*u+1]),this.edgeInfo.endPos.distanceTo(this.edgeInfo.startPos)<1e-7&&(this.edgeInfo.thirdPos=new THREE.Vector3,this.edgeInfo.thirdPos.fromArray(s,3*d[2*(u-1)]));for(var f=0,p=h,m=u;p<=m;p++,c+=1){var g=d[2*p],v=d[2*p+1],y=new THREE.Vector3,E=new THREE.Vector3;y.fromArray(s,3*g),E.fromArray(s,3*v),l[6*c]=y.x,l[6*c+1]=y.y,l[6*c+2]=y.z,l[6*c+3]=E.x,l[6*c+4]=E.y,l[6*c+5]=E.z,f+=y.clone().distanceTo(E),E=y=null}for(var b=0,p=h;p<=u;p++){g=d[2*p],v=d[2*p+1],y=new THREE.Vector3,E=new THREE.Vector3;y.fromArray(s,3*g),E.fromArray(s,3*v);var M=b;if(.5*f<(b+=y.clone().distanceTo(E))){var x=.5*f-M,M=E.clone().sub(y);M.normalize(),this.edgeInfo.midPos=y.clone().addScaledVector(M,x);break}}n=n||(0==t?Ue.selectedVertexMaterial:Ue.preSelectedEdgeMaterial);var h=new THREE.BufferGeometry;h.addAttribute("position",new THREE.BufferAttribute(l,3)),(h=new THREE.LineSegments(h,n)).objectType="SelLine",h.LineInfo=[],h.LineInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id);n=this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0];h.LineInfo.push(n),h.LineInfo.push(e.topolIndex),h.LineInfo.push(e.lineSegId),h.LineInfo.push(t?1:0),h.applyMatrix(e.matrixWorld),h.matrixWorldNeedsUpdate=!0,this.edgeInfo.startPos.applyMatrix4(e.matrixWorld),this.edgeInfo.endPos.applyMatrix4(e.matrixWorld),this.edgeInfo.midPos.applyMatrix4(e.matrixWorld),this.edgeInfo.thirdPos&&this.edgeInfo.thirdPos.applyMatrix4(e.matrixWorld)}}return h}},Xe.prototype.isBetweenTwoVectors=function(e,t,n){if(e.equals(t)||e.equals(n))return!0;var i=(new THREE.Vector3).crossVectors(e,t),r=(new THREE.Vector3).crossVectors(e,n);return i.dot(r)<0&&e.angleTo(t)+e.angleTo(n)<Math.PI},Xe.prototype.createLineMesh=function(e,t,n){var i=(new THREE.Vector3).subVectors(t,e),r=new THREE.Matrix4;r.lookAt(e,t,(new THREE.Object3D).up),r.multiply((new THREE.Matrix4).set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1));i=new THREE.CylinderGeometry(.5,.5,i.length(),8,1,!1),n=new THREE.Mesh(i,n);return n.applyMatrix(r),n.position.addVectors(e,t),n.position.multiplyScalar(.5),n},Xe.prototype.createLineMesh2=function(e,t,n){var i=new THREE.Geometry;i.vertices.push(t),i.vertices.push(e);n=new THREE.Line(i,n);return n.updateMatrixWorld(!0),n.objectType="Line",n.Start=e.clone(),n.End=t.clone(),n},Xe.prototype.createLineMesh3=function(e,t,n){for(var i=t.clone().sub(e).normalize(),r=e.distanceTo(t),o=Math.ceil(Math.abs(r/6)),a=0<r?1:-1,s=new Float32Array(6*o),l=0;l<o;++l){var d=new THREE.Vector3,c=new THREE.Vector3,d=e.clone().add(i.clone().multiplyScalar(6*l*a));6*l+4<Math.abs(r)?c=d.clone().add(i.clone().multiplyScalar(3*a)):c.set(t.x,t.y,t.z),s[6*l]=d.x,s[6*l+1]=d.y,s[6*l+2]=d.z,s[6*l+3]=c.x,s[6*l+4]=c.y,s[6*l+5]=c.z}var h=new THREE.BufferGeometry;h.addAttribute("position",new THREE.BufferAttribute(s,3));n=new THREE.LineSegments(h,n);return n.objectType="Edge",n.Start=e.clone(),n.End=t.clone(),n.matrixWorldNeedsUpdate=!0,n},Xe.prototype.createLineMesh4=function(e,t,n,i){for(var r=t.clone().sub(e).normalize(),o=e.distanceTo(t),a=Math.ceil(Math.abs(o/6)),s=Math.ceil(n.distanceTo(t)/6),l=new Float32Array(6*(a+s)),d=0;d<a;++d){var c=new THREE.Vector3,h=new THREE.Vector3;c=e.clone().add(r.clone().multiplyScalar(6*d)),6*d+4<o?h=c.clone().add(r.clone().multiplyScalar(3)):h.set(t.x,t.y,t.z),l[6*d]=c.x,l[6*d+1]=c.y,l[6*d+2]=c.z,l[6*d+3]=h.x,l[6*d+4]=h.y,l[6*d+5]=h.z}for(r=n.clone().sub(t).normalize(),o=n.distanceTo(t),d=0;d<s;++d){c=new THREE.Vector3,h=new THREE.Vector3;c=t.clone().add(r.clone().multiplyScalar(6*d)),6*d+4<o?h=c.clone().add(r.clone().multiplyScalar(3)):h.set(n.x,n.y,n.z),l[6*(d+a)]=c.x,l[6*(d+a)+1]=c.y,l[6*(d+a)+2]=c.z,l[6*(d+a)+3]=h.x,l[6*(d+a)+4]=h.y,l[6*(d+a)+5]=h.z}var u=new THREE.BufferGeometry;u.addAttribute("position",new THREE.BufferAttribute(l,3));i=new THREE.LineSegments(u,i);return i.objectType="CircleLine",i.Start=e.clone(),i.Mid=t.clone(),i.End=n.clone(),i.matrixWorldNeedsUpdate=!0,i},Xe.prototype.createCylinderMesh=function(e,t,n){var i=new THREE.Matrix4;i.lookAt(e,t,(new THREE.Object3D).up),i.multiply((new THREE.Matrix4).set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1));var r=new THREE.CylinderGeometry(0,this.cylinderRadiusBottom,this.cylinderHeight,8,1,!1),n=new THREE.Mesh(r,n);return n.applyMatrix(i),n.position.copy(e),n.objectType="Cylinder",n.Start=e.clone(),n.End=t.clone(),n},Xe.prototype.createAngleArcMeshes2=function(e,t,n,i,r,o,a){var s=new THREE.Vector3,l=new THREE.Vector3;s.subVectors(e,t),l.subVectors(n,t);var d=s.dot(l),c=s.length(),e=l.length(),n=(n=Math.acos(d/(c*e)))/Math.PI*180;this.dimString=n.toFixed(2),this.dimString+="°";d=new THREE.Vector3;d.crossVectors(s,l),d.normalize(),o&&d.copy(o);e=Math.min(c,e);return this.createAngleArcMeshesWithAngle(t,s,l,e,n,i,r)},Xe.prototype.createAngleArcMeshesWithAngle=function(r,e,t,o,n,i,a){this.dimString=n.toFixed(2),this.dimString+="°",e.normalize(),t.normalize();var s=new THREE.Vector3;s.crossVectors(e,t),s.normalize();n=new THREE.CircleGeometry(o,18,0,n*Math.PI/180);if(new THREE.Mesh(n,this.materialLine).geometry.vertices.length<2)return[];var l=[];!function e(t,n){var i=(new THREE.Vector3).addVectors(t,n);i.normalize(),i.angleTo(t)/Math.PI*180<=2?(l.push(r.clone().addScaledVector(t,o)),l.push(r.clone().addScaledVector(i,o)),l.push(r.clone().addScaledVector(n,o))):(e(t.clone(),i.clone()),e(i.clone(),n.clone()))}(e,t);var d=[];a=a||this.materialLine;for(var c=0;c<l.length-1;c++){var h=this.createLineMesh2(l[c],l[c+1],a,i);d.push(h)}return d},Xe.prototype.createContour=function(e){var t=new Float32Array(e),n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(t,3));n=new THREE.LineSegments(n,Ue.selectedVertexMaterial);return n.objectType="Contour",n.Vertices=e,n.matrixWorldNeedsUpdate=!0,n},Xe.prototype.getCameraScale=function(e,t){var n=1;if(!e)return n;var i=5;null!=t&&(i=t);var r=this.viewer.camera.getCameraTarget(),o=this.viewer.camera.position,t=new THREE.Vector3;t.subVectors(r,o);e=e.clone(),o=this.viewer.camera.isPerspective?e.sub(o).dot(t.normalize()):1.2*t.length(),t=this.viewer.camera.fov,o=2*o*Math.tan(THREE.Math.degToRad(.5*t)),t=this.viewer.renderer.domElement.height;return n=i*o*this.viewer.renderer.getPixelRatio()/t},Xe.prototype.setPointScale=function(e,t){t=this.OpMeasure.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()},Xe.prototype.setCylinderScale=function(e,t){t=this.OpMeasure.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.oldPosition&&e.offsetPos&&e.position.addVectors(e.oldPosition,e.offsetPos.clone().multiplyScalar(t)),e.updateMatrixWorld()},Xe.prototype.createPointMesh=function(e,t,n){t=new THREE.Mesh(new THREE.SphereGeometry(1),t);return t.position.set(e.x,e.y,e.z),this.setPointScale(t,n),t.objectType="Point",t.Point=e.clone(),t},Xe.prototype.isTwoTopolInfoTheSame=function(e,t){return!(e&&!t||!e&&t||!e&&!t)&&((!this.viewer.ndsModel||e.bodyId==t.bodyId&&e.meshId==t.meshId&&e.lineSegId==t.lineSegId)&&(e.parentObj==t.parentObj&&e.id==t.id&&e.indexRange[0]===t.indexRange[0]&&e.indexRange[1]===t.indexRange[1]))},Xe.prototype.isTwoPointTheSame=function(e,t){return Math.abs(e.x-t.x)<1e-6&&Math.abs(e.y-t.y)<1e-6&&Math.abs(e.z-t.z)<1e-6},Xe.prototype.getIntersectsByPriorityOfLine=function(e,t,n){var i=this.viewer,r=i.renderer.domElement,o=i.renderer.getPixelRatio(),a=new THREE.Raycaster;i.camera.setCastRay(a,e*o/r.width*2-1,2*-(t*o/r.height)+1),a.linePrecision=this.getLinePrecision(),n&&(a.linePrecision=n);var s=null,s=i.ndsModel?i.ndsModel.intersect(a.ray,a.linePrecision):a.intersectObjects(i.selectionManager.getTargetIncludeLineList());if(s&&0<s.length&&!i.ndsModel&&1<s.length&&!(s[0].object instanceof THREE.Line)){s[0].object;for(var l=s[0].distance,d=1;d<s.length;d++){var c=s[d].object,h=s[d].distance;if(!(l+2*a.linePrecision>=h))break;if(c instanceof THREE.Line){c=s[d];s[d]=s[0],s[0]=c;break}}}return s},Xe.prototype.createAndShowDistanceDimension=function(e,t){var n,i,r,o,a,s,l,d,c,h,u,f,p,m,g,v,y,E,b,M,x,w,I,S,T,A;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(n=!1,w=(n=this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type?!0:n)?(i=this.distanceInfo.firstSelInfo.intersect.clone(),this.distanceInfo.secondSelInfo.intersect.clone()):(i=this.distanceInfo.firstPoint.clone(),this.distanceInfo.secondPoint.clone()),this.distanceInfo.fstClndPos||(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone()),this.distanceInfo.sndClndPos||(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone()),this.distanceInfo.textPos&&e&&((o=new THREE.Plane).setFromCoplanarPoints(i,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),o.normal.length()<1e-8&&o.setFromCoplanarPoints(i.clone().add(new THREE.Vector3(1,-1,1)),this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),(r=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&this.distanceInfo.textPos.copy(r)),this.distanceInfo.fstClnd&&this.distanceInfo.sndClnd?!n&&this.distanceInfo.textPos?(h=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),(a=this.getProjectPntToLine(w,this.distanceInfo.sndClndPos,this.distanceInfo.textPos.clone()))&&(1e-5<(r=a.clone().sub(w)).length()?(this.distanceInfo.sndClndPos.addVectors(w,r),this.distanceInfo.fstClndPos.subVectors(this.distanceInfo.sndClndPos,h)):(d=this.viewer.camera.position,c=(new THREE.Vector3).subVectors(d,this.distanceInfo.fstClndPos),(u=(h=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(u=(h=new THREE.Vector3(100,100,100)).length(),(f=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*u,1e-4)),this.distanceInfo.fstClndPos.add(f),this.distanceInfo.sndClndPos.sub(f)):((f=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*u,1e-4)),this.distanceInfo.fstClndPos.add(f),this.distanceInfo.sndClndPos.add(f))))):n&&(s=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),l=(new THREE.Vector3).subVectors(this.distanceInfo.textPos,this.distanceInfo.fstClndPos),(o=new THREE.Plane).setFromCoplanarPoints(i,w,this.distanceInfo.sndClndPos),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&(a=this.getProjectPntToLine(this.distanceInfo.secondSelInfo.intersect,this.distanceInfo.sndClndPos,o))&&this.distanceInfo.sndClndPos.copy(a),this.distanceInfo.fstClndPos=this.distanceInfo.sndClndPos.clone().sub(s),this.distanceInfo.textPos.copy(this.distanceInfo.fstClndPos.clone().add(l))):n?(a=(new THREE.Vector3).subVectors(w,i),(s=this.distanceInfo.firstSelInfo.worldNormal.clone()).normalize(),this.distanceInfo.fstClndPos=i.clone(),this.distanceInfo.sndClndPos=new THREE.Vector3,l=this.distanceInfo.dimString,l*=T=this.viewer.getUnitScale(this.distanceInfo.unit),l=Math.max(l,1e-4),0<a.dot(s)?this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,s.multiplyScalar(l)):this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,s.multiplyScalar(-1*l))):(d=this.viewer.camera.position,c=(new THREE.Vector3).subVectors(d,this.distanceInfo.fstClndPos),(u=(h=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(u=(h=new THREE.Vector3(100,100,100)).length(),(f=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*u,1e-4)),this.distanceInfo.fstClndPos.add(f),this.distanceInfo.sndClndPos.sub(f)):((f=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*u,1e-4)),this.distanceInfo.fstClndPos.add(f),this.distanceInfo.sndClndPos.add(f))),this.distanceInfo.textPos||(this.distanceInfo.textPos=this.distanceInfo.sndClndPos.clone()),n||this.distanceInfo.fstToSndLine||(this.distanceInfo.fstToSndLine=this.createLineMesh2(this.distanceInfo.firstPoint,this.distanceInfo.secondPoint,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToSndLine),this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&(p=this.getClosePoint(this.distanceInfo.firstSelInfo,this.distanceInfo.firstPoint),this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,p,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type&&(p=this.getClosePoint(this.distanceInfo.secondSelInfo,this.distanceInfo.secondPoint),this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,p,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&((m=new THREE.Vector3(this.distanceInfo.firstSelInfo.center[0],this.distanceInfo.firstSelInfo.center[1],this.distanceInfo.firstSelInfo.center[2])).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),g=this.distanceInfo.firstSelInfo.geometry,v=new THREE.Vector3,y=this.distanceInfo.firstSelInfo.indexRange.concat(),this.viewer.ndsModel&&(y[0]+=g.drawRange.start/2,y[1]+=g.drawRange.start/2),g.isBufferGeometry&&(E=g.index,b=g.attributes.position.array,null!=E&&(M=E.array,x=y[0],v.fromArray(b,3*M[2*x]),v.applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld))),this.distanceInfo.FstToFstPointLine=this.createLineMesh4(this.distanceInfo.firstPoint,m,v,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"circle"==this.distanceInfo.secondSelInfo.type&&((m=new THREE.Vector3(this.distanceInfo.secondSelInfo.center[0],this.distanceInfo.secondSelInfo.center[1],this.distanceInfo.secondSelInfo.center[2])).applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld),g=this.distanceInfo.secondSelInfo.geometry,v=new THREE.Vector3,y=this.distanceInfo.secondSelInfo.indexRange.concat(),this.viewer.ndsModel&&(y[0]+=g.drawRange.start/2,y[1]+=g.drawRange.start/2),g.isBufferGeometry&&(E=g.index,b=g.attributes.position.array,null!=E&&(M=E.array,x=y[0],v.fromArray(b,3*M[2*x]),v.applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld))),this.distanceInfo.SndToSndPointLine=this.createLineMesh4(this.distanceInfo.secondPoint,m,v,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),!this.distanceInfo.firstSelInfo||"line"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(I=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo))&&1e-5<(S=new THREE.Line3(I.start,I.end).closestPointToPoint(this.distanceInfo.firstPoint,!0)).distanceTo(this.distanceInfo.firstPoint)&&(this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,S,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),!this.distanceInfo.secondSelInfo||"line"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(I=this.getLineStartEndPoints(this.distanceInfo.secondSelInfo))&&1e-5<(S=new THREE.Line3(I.start,I.end).closestPointToPoint(this.distanceInfo.secondPoint,!0)).distanceTo(this.distanceInfo.secondPoint)&&(this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,S,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine))),I=this.isPointBetweenIn(this.distanceInfo.textPos,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),(S=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos)).normalize(),I?(this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine),T=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),S.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=S.clone(),this.distanceInfo.fstClnd.position.addVectors(this.distanceInfo.fstClndPos,S.clone().multiplyScalar(T))):(this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,!1),T=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),S.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=S.clone().multiplyScalar(-1),this.distanceInfo.fstClnd.position.subVectors(this.distanceInfo.fstClndPos,S.clone().multiplyScalar(T))),this.distanceInfo.fstClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),I?(this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=S.clone().multiplyScalar(-1),this.distanceInfo.sndClnd.position.subVectors(this.distanceInfo.sndClndPos,S.clone().multiplyScalar(T))):(this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine,!1),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=S.clone(),this.distanceInfo.sndClnd.position.addVectors(this.distanceInfo.sndClndPos,S.clone().multiplyScalar(T))),this.distanceInfo.sndClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.sndClnd),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.clndToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.clndToClndLine),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.fstToClndLine=this.createLineMesh2(i,this.distanceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.sndToClndLine=this.createLineMesh2(w,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.sndToClndLine),this.distanceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.boxToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.boxToClndLine),""==this.distanceInfo.dimString?(this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),A=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=A.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(2),this.distanceInfo.unit=this.getUnitStringmap(A.unit)):(u=parseFloat(this.distanceInfo.dimString))<1&&""==this.distanceInfo.unit&&(.999999<u&&(u=1),u*=(A=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString)).scale,this.distanceInfo.dimString=u.toFixed(2),this.distanceInfo.unit=this.getUnitStringmap(A.unit)),A=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(2)+this.distanceInfo.unit,this.distanceInfo.textBox||(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.distanceInfo.textBox)),this.getAndShowTextBox(this.distanceInfo.textPos.clone(),A,this.distanceInfo.textBox),1==t&&((t={}).dimString=A,t.textPos=this.distanceInfo.textPos.clone(),t.textBox=this.distanceInfo.textBox,t.textBox.setAttribute("type","length"),t.textBox.setAttribute("dimString",this.distanceInfo.dimString),t.textBox.setAttribute("unit",this.distanceInfo.unit),this.OpMeasure.boxInfos.push(t),this.clearDistanceInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},Xe.prototype.DeepCopy=function(e){var t,n={};for(t in e)n[t]=e[t];return n},Xe.prototype.ChangeMeasureFlag=function(){switch(this.measureType){case"pt2pt":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.pt2pt;break;case"pt2ptbim":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.pt2ptbim;break;case"PointToLine":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.pointtoline;break;case"PointToFace":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.pointtoface;break;case"AxisToPoint":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.axistopoint;break;case"LineToLine":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.linetoline;break;case"LineToFace":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.linetoface;break;case"faceDist":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.facedist;break;case"AxisToLine":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.axistoline;break;case"AxisToFace":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.axistoface;break;case"holeDist":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.holedist;break;case"measureEdges":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.Edge;break;case"perimeter":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.perimeter;break;case"LineAngle":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.LineAngle;break;case"LineFaceAngle":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.LineFaceAngle;break;case"faceAngle":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.faceAngle;break;case"contour":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.contour;break;case"contourarea":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.contourarea;break;case"Lineargauge":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.Lineargauge;break;case"coordinate":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.coordinate;break;case"bodyAngle":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.bodyAngle;break;case"bodyDistance":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.bodyDistance;break;case"bodyEdgeLength":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.bodyEdgeLength;break;case"angle":this.OpMeasure.measureFlag|=NDS.MEASUREFLAG.angle}this.OpMeasure.PostInfo()},Xe.prototype.hasMeasured=function(){switch(this.measureType){case"pt2pt":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.pt2pt;case"PointToLine":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.pointtoline;case"PointToFace":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.pointtoface;case"AxisToPoint":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.axistopoint;case"LineToLine":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.linetoline;case"LineToFace":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.linetoface;case"faceDist":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.facedist;case"AxisToLine":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.axistoline;case"AxisToFace":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.axistoface;case"holeDist":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.holedist;case"measureEdges":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.Edge;case"perimeter":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.perimeter;case"LineAngle":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.LineAngle;case"LineFaceAngle":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.LineFaceAngle;case"faceAngle":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.faceAngle;case"contour":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.contour;case"contourarea":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.contourarea;case"Lineargauge":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.Lineargauge;case"coordinate":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.coordinate;case"bodyAngle":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.bodyAngle;case"bodyDistance":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.bodyDistance;case"bodyEdgeLength":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.bodyEdgeLength;case"angle":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.angle;case"pt2ptbim":return this.OpMeasure.measureFlag&NDS.MEASUREFLAG.pt2ptbim}},Xe.prototype.createAndShow3DDistanceDimension=function(e,t){var n,i,r,o,a,s,l,d,c,h,u,f,p,m,g,v,y,E,b,M,x,w,I,S,T,A,R;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(l=!1,x=(l=this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type?!0:l)?(n=this.distanceInfo.firstSelInfo.intersect.clone(),this.distanceInfo.secondSelInfo.intersect.clone()):(n=this.distanceInfo.firstPoint.clone(),this.distanceInfo.secondPoint.clone()),this.distanceInfo.fstClndPos||(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone()),this.distanceInfo.sndClndPos||(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone()),this.distanceInfo.textPos&&e&&((r=new THREE.Plane).setFromCoplanarPoints(n,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),r.normal.length()<1e-8&&r.setFromCoplanarPoints(n.clone().add(new THREE.Vector3(1,-1,1)),this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,r))&&this.distanceInfo.textPos.copy(i)),this.distanceInfo.fstClnd&&this.distanceInfo.sndClnd?!l&&this.distanceInfo.textPos?(h=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),(o=this.getProjectPntToLine(x,this.distanceInfo.sndClndPos,this.distanceInfo.textPos.clone()))&&(1e-5<(i=o.clone().sub(x)).length()?(this.distanceInfo.sndClndPos.addVectors(x,i),this.distanceInfo.fstClndPos.subVectors(this.distanceInfo.sndClndPos,h)):(d=this.viewer.camera.position,c=(new THREE.Vector3).subVectors(d,this.distanceInfo.fstClndPos),(w=(h=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(w=(h=new THREE.Vector3(100,100,100)).length(),(u=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*w,1e-4)),this.distanceInfo.fstClndPos.add(u),this.distanceInfo.sndClndPos.sub(u)):((u=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*w,1e-4)),this.distanceInfo.fstClndPos.add(u),this.distanceInfo.sndClndPos.add(u))))):l&&(a=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),s=(new THREE.Vector3).subVectors(this.distanceInfo.textPos,this.distanceInfo.fstClndPos),(r=new THREE.Plane).setFromCoplanarPoints(n,x,this.distanceInfo.sndClndPos),(r=this.clientCoordToModelCoordOnPlane(e.x,e.y,r))&&(o=this.getProjectPntToLine(this.distanceInfo.secondSelInfo.intersect,this.distanceInfo.sndClndPos,r))&&this.distanceInfo.sndClndPos.copy(o),this.distanceInfo.fstClndPos=this.distanceInfo.sndClndPos.clone().sub(a),this.distanceInfo.textPos.copy(this.distanceInfo.fstClndPos.clone().add(s))):l?(a=(new THREE.Vector3).subVectors(x,n),(s=this.distanceInfo.firstSelInfo.worldNormal.clone()).normalize(),this.distanceInfo.fstClndPos=n.clone(),this.distanceInfo.sndClndPos=new THREE.Vector3,l=this.distanceInfo.dimString,l*=this.viewer.getUnitScale(this.distanceInfo.unit),l=Math.max(l,1e-4),0<a.dot(s)?this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,s.multiplyScalar(l)):this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,s.multiplyScalar(-1*l))):(d=this.viewer.camera.position,c=(new THREE.Vector3).subVectors(d,this.distanceInfo.fstClndPos),(w=(h=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(w=(h=new THREE.Vector3(100,100,100)).length(),(u=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*w,1e-4)),this.distanceInfo.fstClndPos.add(u),this.distanceInfo.sndClndPos.sub(u)):((u=(new THREE.Vector3).crossVectors(h,c)).normalize().multiplyScalar(Math.max(.001*w,1e-4)),this.distanceInfo.fstClndPos.add(u),this.distanceInfo.sndClndPos.add(u))),this.distanceInfo.textPos||(this.distanceInfo.textPos=this.distanceInfo.firstPoint.clone().add(this.distanceInfo.secondPoint).divideScalar(2)),this.distanceInfo.fstToSndLine||(this.distanceInfo.fstToSndLine=this.createLineMesh2(this.distanceInfo.firstPoint,this.distanceInfo.secondPoint,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToSndLine)),this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&(f=this.getClosePoint(this.distanceInfo.firstSelInfo,this.distanceInfo.firstPoint),this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,f,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type&&(f=this.getClosePoint(this.distanceInfo.secondSelInfo,this.distanceInfo.secondPoint),this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,f,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&((p=new THREE.Vector3(this.distanceInfo.firstSelInfo.center[0],this.distanceInfo.firstSelInfo.center[1],this.distanceInfo.firstSelInfo.center[2])).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),m=this.distanceInfo.firstSelInfo.geometry,g=new THREE.Vector3,v=this.distanceInfo.firstSelInfo.indexRange.concat(),this.viewer.ndsModel&&(v[0]+=m.drawRange.start/2,v[1]+=m.drawRange.start/2),m.isBufferGeometry&&(y=m.index,E=m.attributes.position.array,null!=y&&(b=y.array,M=v[0],g.fromArray(E,3*b[2*M]),g.applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld))),this.distanceInfo.FstToFstPointLine=this.createLineMesh4(this.distanceInfo.firstPoint,p,g,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"circle"==this.distanceInfo.secondSelInfo.type&&((p=new THREE.Vector3(this.distanceInfo.secondSelInfo.center[0],this.distanceInfo.secondSelInfo.center[1],this.distanceInfo.secondSelInfo.center[2])).applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld),m=this.distanceInfo.secondSelInfo.geometry,g=new THREE.Vector3,v=this.distanceInfo.secondSelInfo.indexRange.concat(),this.viewer.ndsModel&&(v[0]+=m.drawRange.start/2,v[1]+=m.drawRange.start/2),m.isBufferGeometry&&(y=m.index,E=m.attributes.position.array,null!=y&&(b=y.array,M=v[0],g.fromArray(E,3*b[2*M]),g.applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld))),this.distanceInfo.SndToSndPointLine=this.createLineMesh4(this.distanceInfo.secondPoint,p,g,this.appmaterialLine),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),!this.distanceInfo.firstSelInfo||"line"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(A=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo))&&1e-5<(R=new THREE.Line3(A.start,A.end).closestPointToPoint(this.distanceInfo.firstPoint,!0)).distanceTo(this.distanceInfo.firstPoint)&&(this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,R,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),!this.distanceInfo.secondSelInfo||"line"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(A=this.getLineStartEndPoints(this.distanceInfo.secondSelInfo))&&1e-5<(R=new THREE.Line3(A.start,A.end).closestPointToPoint(this.distanceInfo.secondPoint,!0)).distanceTo(this.distanceInfo.secondPoint)&&(this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,R,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),""==this.distanceInfo.dimString?(this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),I=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=I.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(2),this.distanceInfo.unit=this.getUnitStringmap(I.unit)):(w=parseFloat(this.distanceInfo.dimString))<1&&""==this.distanceInfo.unit&&(.999999<w&&(w=1),w*=(I=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString)).scale,this.distanceInfo.dimString=w.toFixed(2),this.distanceInfo.unit=this.getUnitStringmap(I.unit)),A=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(2)+this.distanceInfo.unit,R=null,this.distanceInfo.textBox||("pt2ptbim"==this.measureType?(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="measure-tc",(R=document.createElement("div")).className="sectionCross",this.distanceInfo.textBox.appendChild(R),(T=document.createElement("div")).className="sectionPoint",T.style.left="calc(50% - 6px)",T.style.top="calc(100% - 5.5px)",this.distanceInfo.textBox.appendChild(T),w=document.createElement("p"),S="en"==ye.getLanguage(),w.innerHTML=S?"<span>dis：</span>"+A:"<span>距离：</span>"+A,this.distanceInfo.textBox.appendChild(w),S=document.createElement("p"),w=Math.abs(this.distanceInfo.firstPoint.x-this.distanceInfo.secondPoint.x),I=this.viewer.getDispalyModelUnit(w),S.innerHTML="<span>X：</span>"+(w*this.viewer.measuringScale*I.scale).toFixed(2)+this.getUnitStringmap(I.unit),this.distanceInfo.textBox.appendChild(S),w=document.createElement("p"),S=Math.abs(this.distanceInfo.firstPoint.z-this.distanceInfo.secondPoint.z),I=this.viewer.getDispalyModelUnit(S),w.innerHTML="<span>Y：</span>"+(S*this.viewer.measuringScale*I.scale).toFixed(2)+this.getUnitStringmap(I.unit),this.distanceInfo.textBox.appendChild(w),S=document.createElement("p"),w=Math.abs(this.distanceInfo.firstPoint.y-this.distanceInfo.secondPoint.y),I=this.viewer.getDispalyModelUnit(w),S.innerHTML="<span>Z：</span>"+(w*this.viewer.measuringScale*I.scale).toFixed(2)+this.getUnitStringmap(I.unit),this.distanceInfo.textBox.appendChild(S)):(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="section10",this.distanceInfo.textBox.innerHTML=A,(T=document.createElement("div")).className="sectionPoint",this.distanceInfo.textBox.appendChild(T),(R=document.createElement("div")).className="sectionCross",this.distanceInfo.textBox.appendChild(R)),this.viewer.container.appendChild(this.distanceInfo.textBox)),this.distanceInfo.boxToClndLine&&(this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.boxToClndLine=null),I=this.distanceInfo.firstPoint.clone().add(this.distanceInfo.secondPoint).divideScalar(2),this.distanceInfo.boxToClndLine||(this.distanceInfo.boxToClndLine=this.createLineMesh2(I,this.distanceInfo.textPos,this.appmaterialLine,1),this.distanceInfo.boxToClndLine.name="unsteady",this.OpMeasure.rootObject.add(this.distanceInfo.boxToClndLine)),S=this.get2dPoint(this.distanceInfo.textPos.clone()),T=this.viewer.renderer.getPixelRatio(),this.distanceInfo.textBox.style.left=Math.round(S.x/T-49)+"px",this.distanceInfo.textBox.style.top=Math.round(S.y/T-26)+"px",1==t&&((T={}).dimString=A,T.textPos=this.distanceInfo.textPos.clone(),T.textBox=this.distanceInfo.textBox,t=this,(A=new THREE.Group).objectType="Group",t.OpMeasure.rootObject.remove(t.distanceInfo.boxToClndLine),t.OpMeasure.rootObject.remove(t.distanceInfo.fstToSndLine),t.OpMeasure.rootObject.remove(t.distanceInfo.firstSelObj),t.OpMeasure.rootObject.remove(t.distanceInfo.secondSelObj),t.distanceInfo.FstToFstPointLine&&(t.OpMeasure.rootObject.remove(t.distanceInfo.FstToFstPointLine),A.add(t.distanceInfo.FstToFstPointLine)),t.distanceInfo.SndToSndPointLine&&(t.OpMeasure.rootObject.remove(t.distanceInfo.SndToSndPointLine),A.add(t.distanceInfo.SndToSndPointLine)),t.distanceInfo.axisLineObj&&(t.OpMeasure.rootObject.remove(t.distanceInfo.axisLineObj),A.add(t.distanceInfo.axisLineObj)),t.distanceInfo.secaxisLineObj&&(t.OpMeasure.rootObject.remove(t.distanceInfo.secaxisLineObj),A.add(t.distanceInfo.secaxisLineObj)),A.add(t.distanceInfo.fstToSndLine),A.add(t.distanceInfo.firstSelObj),A.add(t.distanceInfo.secondSelObj),t.OpMeasure.rootObject.add(A),ye.isMobileDevice()?(T.textBox.addEventListener("touchstart",this.touchstart,!1),T.textBox.addEventListener("touchend",this.touchend,!1),T.textBox.addEventListener("touchmove",this.touchmove,!1)):(T.textBox.addEventListener("mousedown",this.touchstart,!1),T.textBox.addEventListener("mouseup",this.touchend,!1),T.textBox.addEventListener("mousemove",this.touchmove,!1),T.textBox.addEventListener("mouseleave",this.mouseleave,!1),T.textBox.addEventListener("mouseenter",this.mouseenter,!1)),ye.isMobileDevice()?R.addEventListener("touchend",this.sectionCrossend,!1):(R.addEventListener("mousedown",this.sectionCrossend,!1),R.addEventListener("mouseleave",this.crossleave,!1),R.addEventListener("mouseenter",this.crossenter,!1)),(R={}).start=this.distanceInfo.textPos.clone(),R.end=I.clone(),R.uuid=A.uuid,this.OpMeasure.textLines.push(R),T.textBox.setAttribute("mobile","up"),T.textBox.setAttribute("group",A.uuid),T.textBox.setAttribute("type","length"),T.textBox.setAttribute("dimString",this.distanceInfo.dimString),T.textBox.setAttribute("unit",this.distanceInfo.unit),T.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(T),this.OpMeasure.unsteadyData[A.uuid]=this.DeepCopy(this.distanceInfo),this.OpMeasure.unsteadyData[A.uuid].p1=n,this.OpMeasure.unsteadyData[A.uuid].p2=x,this.clearDistanceInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},Xe.prototype.changeMeasureDistance=function(e){var t,n,i,r,o,a,s=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid];s.textPos&&e&&((o=new THREE.Plane).setFromCoplanarPoints(s.p1,s.fstClndPos,s.sndClndPos),o.normal.length()<1e-8&&o.setFromCoplanarPoints(s.p2,s.fstClndPos,s.sndClndPos),o.normal.length()<1e-8&&o.setFromCoplanarPoints(s.p1.clone().add(new THREE.Vector3(1,-1,1)),s.fstClndPos,s.sndClndPos),(n=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&s.textPos.copy(n)),s.fstClnd&&s.sndClnd&&(!bFaceToFaceDim&&s.textPos?(t=(new THREE.Vector3).subVectors(s.sndClndPos,s.fstClndPos),(a=this.getProjectPntToLine(s.p2,s.sndClndPos,s.textPos.clone()))&&(1e-5<(r=a.clone().sub(s.p2)).length()?(s.sndClndPos.addVectors(s.p2,r),s.fstClndPos.subVectors(s.sndClndPos,t)):(n=this.viewer.camera.position,r=(new THREE.Vector3).subVectors(n,s.fstClndPos),(n=(t=(new THREE.Vector3).subVectors(s.secondPoint,s.firstPoint)).length())<1e-8?(n=(t=new THREE.Vector3(100,100,100)).length(),(i=(new THREE.Vector3).crossVectors(t,r)).normalize().multiplyScalar(Math.max(.001*n,1e-4)),s.fstClndPos.add(i),s.sndClndPos.sub(i)):((i=(new THREE.Vector3).crossVectors(t,r)).normalize().multiplyScalar(Math.max(.001*n,1e-4)),s.fstClndPos.add(i),s.sndClndPos.add(i))))):bFaceToFaceDim&&(d=(new THREE.Vector3).subVectors(s.sndClndPos,s.fstClndPos),c=(new THREE.Vector3).subVectors(s.textPos,s.fstClndPos),(o=new THREE.Plane).setFromCoplanarPoints(s.p1,s.p2,s.sndClndPos),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&(a=this.getProjectPntToLine(s.secondSelInfo.intersect,s.sndClndPos,o))&&s.sndClndPos.copy(a),s.fstClndPos=s.sndClndPos.clone().sub(d),s.textPos.copy(s.fstClndPos.clone().add(c))));var l=s.firstPoint.clone().add(s.secondPoint).divideScalar(2),d=this.get2dPoint(s.textPos.clone()),c=this.get2dPoint(l.clone()),c=new THREE.Vector2(d.x-c.x,d.y-c.y);c.normalize(),c.y>=c.x/2&&c.y>=-c.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):c.y>c.x/2&&c.y<-c.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):c.y<c.x/2&&c.y<-c.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):c.y<c.x/2&&c.y>-c.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left"));for(var h=0;h<this.OpMeasure.boxInfos.length;h++){var u=this.OpMeasure.boxInfos[h];if(u.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){u.textPos=s.textPos;break}}for(h=0;h<this.OpMeasure.textLines.length;h++){var f=this.OpMeasure.textLines[h];if(f.uuid==this.OpMeasure.unsteadyuuid){f.start=s.textPos.clone(),f.end=l.clone();break}}this.OpMeasure.viewer.render()},Xe.prototype.getClosePoint=function(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var n=e.geometry,i=e.indexRange.concat();if(this.viewer.ndsModel&&(i[0]+=n.drawRange.start/3,i[1]+=n.drawRange.start/3),n.isBufferGeometry)for(var r=n.index,o=n.attributes.position,a=new THREE.Vector3,s=1/0,l=i[0],d=i[1];l<=d;l++){var c=3*l,h=r.getX(c),u=r.getX(1+c),f=r.getX(2+c),p=new THREE.Vector3,m=new THREE.Vector3,c=new THREE.Vector3;p.fromBufferAttribute(o,h),m.fromBufferAttribute(o,u),c.fromBufferAttribute(o,f),p.applyMatrix4(e.matrixWorld),m.applyMatrix4(e.matrixWorld),c.applyMatrix4(e.matrixWorld);u=new THREE.Triangle(p,m,c);if(u.containsPoint(t))return t;f=new THREE.Vector3;u.closestPointToPoint(t,f),t.distanceTo(f)<s&&(s=t.distanceTo(f),a=f.clone()),f=c=m=p=null}return a}},Xe.prototype.getLinePrecision=function(){var e=this.viewer.clientCoordToModelCoord([0,0]),t=new THREE.Vector3(e[0],e[1],e[2]),e=this.viewer.clientCoordToModelCoord([4,0]),e=new THREE.Vector3(e[0],e[1],e[2]);return t.distanceTo(e)},Xe.prototype.getUnitString=function(){var e="mm";if(this.viewer.modelUnit)switch(this.viewer.modelUnit.toLowerCase()){case"meter":e="m";break;case"centimeter":e="cm";break;case"millimeter":e="mm";break;case"inch":e="in";break;case"feet":e="ft"}return e},Xe.prototype.getUnitStringmap=function(e){var t="mm";if(e)switch(e.toLowerCase()){case"meter":t="m";break;case"centimeter":t="cm";break;case"millimeter":t="mm";break;case"inch":t="in";break;case"feet":t="ft"}return t},Xe.prototype.OperatorRelease=function(){this.OperatorEnd(),this.measureType="",this.OpMeasure.prompt&&(this.viewer.container.removeChild(this.OpMeasure.prompt),this.OpMeasure.prompt=null)},Xe.prototype.getViewClientCoords=function(e){var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;return e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),new THREE.Vector2(t,n)},Xe.prototype.isZero=function(e){return Math.abs(e)<1e-6},Xe.prototype.isPointBetweenIn=function(e,t,n){if(!e||!t||!n)return!1;var i=t.distanceTo(n),t=e.distanceTo(t),n=e.distanceTo(n);return this.isZero(i-t-n)},Xe.prototype.getAngle=function(e,t,n){if(!e||!t||!n)return 0;e=(new THREE.Vector3).subVectors(e,t),t=(new THREE.Vector3).subVectors(n,t);return e.angleTo(t)},Xe.prototype.getBaceFaceDir=function(e){if(!e)return new THREE.Vector3(0,0,1);var t=new THREE.Vector3(0,0,1),n=new THREE.Vector3(0,0,-1),i=new THREE.Vector3(1,0,0),r=new THREE.Vector3(-1,0,0),o=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,-1,0),s=e.angleTo(t),l=e.angleTo(n),d=e.angleTo(i),c=e.angleTo(r),h=e.angleTo(o),u=e.angleTo(a),e=Math.min(s,l),e=Math.min(e,d);return e=Math.min(e,c),e=Math.min(e,h),e=Math.min(e,u),Math.abs(s-e)<1e-6?t:Math.abs(l-e)<1e-6?n:Math.abs(d-e)<1e-6?i:Math.abs(c-e)<1e-6?r:Math.abs(h-e)<1e-6?o:a},Xe.prototype.getProjectPntToPlane=function(e,t,n,i){t=(new THREE.Vector3).subVectors(t,e),n=(new THREE.Vector3).subVectors(n,e),n=(new THREE.Vector3).crossVectors(t,n);n.normalize();e=(new THREE.Vector3).subVectors(i,e).dot(n);return i.clone().sub(n.multiplyScalar(e))},Xe.prototype.getProjectPntToLine=function(e,t,n){if(e.equals(t))return e.clone();t=(new THREE.Vector3).subVectors(t,e);t.normalize();n=(new THREE.Vector3).subVectors(n,e),n=t.dot(n);return e.clone().add(t.multiplyScalar(n))},Xe.prototype.clientCoordToModelCoordOnPlane=function(e,t,n){e=[e,t,.99],t=this.viewer.clientCoordToModelCoord(e),t=new THREE.Vector3(t[0],t[1],t[2]);e[2]=-.99;e=this.viewer.clientCoordToModelCoord(e),e=new THREE.Vector3(e[0],e[1],e[2]);return this.intersectLine(t,e,n)},Xe.prototype.intersectLine=function(e,t,n){if(!e||!t||!n)return null;var i=e.clone(),r=(new THREE.Vector3).subVectors(t,e);r.normalize();e=r.dot(n.normal);if(Math.abs(e)<=1e-8)return null;t=n.coplanarPoint(t.clone()),e=(new THREE.Vector3).subVectors(t,i).dot(n.normal)/e;return i.add(r.multiplyScalar(e))},Xe.prototype.createBoundingBox=function(e){var t=new Float32Array(24);t[0]=e.max.x,t[1]=e.max.y,t[2]=e.max.z,t[3]=e.max.x,t[4]=e.max.y,t[5]=e.min.z,t[6]=e.min.x,t[7]=e.max.y,t[8]=e.min.z,t[9]=e.min.x,t[10]=e.max.y,t[11]=e.max.z,t[12]=e.max.x,t[13]=e.min.y,t[14]=e.max.z,t[15]=e.max.x,t[16]=e.min.y,t[17]=e.min.z,t[18]=e.min.x,t[19]=e.min.y,t[20]=e.min.z,t[21]=e.min.x,t[22]=e.min.y,t[23]=e.max.z;var n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),e=new THREE.BufferGeometry;return e.setIndex(new THREE.BufferAttribute(n,1)),e.addAttribute("position",new THREE.BufferAttribute(t,3)),(e=new THREE.LineSegments(e,this.materialBoxLine)).objectType="BoundingBox",e};function Ze(e){Xe.call(this,e),this.measureClass="Distance"}(Ze.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"pt2pt":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT);break;case"PointToLine":case"PointToFace":case"AxisToPoint":this.OpMeasure.PostInfo(NDS.INFOTYPE.POINT);break;case"pt2ptbim":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT);break;case"LineToLine":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTLINE);break;case"LineToFace":this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPLANE);break;case"faceDist":this.OpMeasure.PostInfo(NDS.INFOTYPE.PLANE);break;case"AxisToLine":this.OpMeasure.PostInfo(NDS.INFOTYPE.AXISLINE);break;case"AxisToFace":this.OpMeasure.PostInfo(NDS.INFOTYPE.AXISPLANE);break;case"holeDist":this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLE);break;case"bodyDistance":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRMEASUREBODY)}},Ze.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);if(this.OpMeasure.unsteady)this.changeMeasureDistance(n);else if(this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!ye.isMobileDevice())this.createAndShowDistanceDimension(n);else{var i=[];switch(this.measureType){case"bodyDistance":i=4<this.viewer.brepManager.version?["point","line","plane","circle","cylinder","cone"]:["point","line","plane","circle","cylinder"];break;case"PointToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["line"]):i=["point"];break;case"PointToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["plane"]):i=["point"];break;case"holeDist":i=["circle","cylinder"];break;case"AxisToPoint":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["circle","cylinder"]):i=["point"];break;case"LineToLine":i=["line"];break;case"LineToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?i=["plane"]:"plane"==this.distanceInfo.firstSelInfo.type&&(i=["line"]):i=["line","plane"];break;case"faceDist":i=["plane"];break;case"AxisToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?i=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(i=["line"]):i=["line","circle","cylinder"];break;case"AxisToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"plane"==this.distanceInfo.firstSelInfo.type?i=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(i=["plane"]):i=["plane","circle","cylinder"];break;case"pt2pt":case"pt2ptbim":i=["point"];break;default:return}this.measureDistance(e,t,!0,i),this.updateMeasureDistanceScene("true")}},Ze.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);if(this.OpMeasure.PostInfo(),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj)this.viewer.is2DModel?this.createAndShowDistanceDimension(i,!0):this.createAndShow3DDistanceDimension(i,!0),this.OperatorStart(this.measureType);else{var r=[];switch(this.measureType){case"bodyDistance":r=4<this.viewer.brepManager.version?["point","line","plane","circle","cylinder","cone"]:["point","line","plane","circle","cylinder"];break;case"PointToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(r=["line"]):r=["point"];break;case"holeDist":r=["circle","cylinder"];break;case"PointToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(r=["plane"]):r=["point"];break;case"AxisToPoint":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(r=["circle","cylinder"]):r=["point"];break;case"LineToLine":r=["line"];break;case"LineToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?r=["plane"]:"plane"==this.distanceInfo.firstSelInfo.type&&(r=["line"]):r=["line","plane"];break;case"faceDist":r=["plane"];break;case"AxisToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?r=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(r=["line"]):r=["line","circle","cylinder"];break;case"AxisToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"plane"==this.distanceInfo.firstSelInfo.type?r=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(r=["plane"]):r=["plane","circle","cylinder"];break;case"pt2pt":case"pt2ptbim":r=["point"]}switch(this.measureDistance(e,t,!1,r),this.updateMeasureDistanceScene("false"),this.measureType){case"pt2pt":case"pt2ptbim":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDPOINT):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT);break;case"PointToLine":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.LINE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.POINT);break;case"PointToFace":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.PLANE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.POINT);break;case"AxisToPoint":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.viewer.is2DModel?this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEA):this.OpMeasure.PostInfo(NDS.INFOTYPE.AXIS):!this.distanceInfo.firstSelInfo||"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||this.distanceInfo.secondSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.POINT):this.OpMeasure.PostInfo(NDS.INFOTYPE.POINT);break;case"LineToLine":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDS.INFOTYPE.INTERSECT?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDLINE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTLINE);break;case"LineToFace":this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDS.INFOTYPE.LINENOPARALLEL?this.OpMeasure.PostInfo(NDS.INFOTYPE.PARALLELLINE):this.distanceInfo.firstSelInfo&&"line"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&NDS.INFOTYPE.PLANENOPARALLEL!=this.OpMeasure.InfoType&&this.OpMeasure.InfoType!=NDS.INFOTYPE.NOTFACEPARALLEL?this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPARALLELPLANE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPLANE);break;case"faceDist":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDS.INFOTYPE.PLANENOPARALLEL&&this.OpMeasure.InfoType!=NDS.INFOTYPE.NOTFACEPARALLEL?this.OpMeasure.PostInfo(NDS.INFOTYPE.PARALLELPLANE):this.distanceInfo.firstSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo&&this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.OpMeasure.PostInfo(NDS.INFOTYPE.PLANE);break;case"AxisToLine":this.distanceInfo.firstSelInfo&&"line"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.viewer.is2DModel?this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEA):this.OpMeasure.PostInfo(NDS.INFOTYPE.AXIS):!this.distanceInfo.firstSelInfo||"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||this.distanceInfo.secondSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.AXISLINE):this.OpMeasure.PostInfo(NDS.INFOTYPE.LINE);break;case"AxisToFace":this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&NDS.INFOTYPE.AXISNOPARALLEL!=this.OpMeasure.InfoType?this.OpMeasure.PostInfo(NDS.INFOTYPE.AXIS):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.AXISPLANE),this.distanceInfo.firstSelInfo&&("circle"==this.distanceInfo.firstSelInfo.type||"cylinder"==this.distanceInfo.firstSelInfo.type)&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDS.INFOTYPE.PARALLELPLANE);break;case"holeDist":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDCIRCLE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLE);break;case"bodyDistance":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECMEASUREBODY):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRMEASUREBODY)}}},Ze.prototype.calculateDistanceFromPoint=function(e){var t,n,i=0;if("point"==e.firstSelInfo.type){if((i=e.firstSelInfo.point.distanceTo(e.secondSelInfo.point))<1e-10)return void(e.secondSelInfo=null);e.dimString=i.toFixed(2)}else"line"==e.firstSelInfo.type?(t=this.getLineStartEndPoints(e.firstSelInfo))&&(i=(n=new THREE.Line3(t.start,t.end).closestPointToPoint(e.secondSelInfo.point,!1)).distanceTo(e.secondSelInfo.point),e.dimString=i.toFixed(2),e.firstPoint=n):"circle"==e.firstSelInfo.type||"cylinder"==e.firstSelInfo.type||"cone"==e.firstSelInfo.type?"bodyDistance"==this.measureType&&"circle"==e.firstSelInfo.type?(t=this.getLineStartEndPoints(e.firstSelInfo))&&(i=e.secondSelInfo.point.distanceTo(t.start),e.dimString=i.toFixed(2),e.firstPoint=t.start):(t=this.getLineStartEndPoints(e.firstSelInfo))&&(i=(n=new THREE.Line3(t.start,t.end).closestPointToPoint(e.secondSelInfo.point,!1)).distanceTo(e.secondSelInfo.point),e.dimString=i.toFixed(2),e.firstPoint=n):"plane"==e.firstSelInfo.type&&((n=new THREE.Plane).setFromNormalAndCoplanarPoint(e.firstSelInfo.worldNormal,e.firstSelInfo.worldOrigin),r=new THREE.Vector3,n.projectPoint(e.secondSelInfo.point,r),i=r.distanceTo(e.secondSelInfo.point),e.dimString=i.toFixed(2),e.firstPoint=r);var r=this.viewer.getDispalyModelUnit(i=i<1&&.999999<i?1:i);i*=r.scale,e.unit=this.getUnitStringmap(r.unit),e.dimString=i.toFixed(2)},Ze.prototype.measureDistance=function(e,t,n,i){""==this.distanceInfo.unit&&(this.distanceInfo.unit=this.getUnitString()),i=i||(this.viewer.is2DModel?["line","circle","point"]:["line","circle","cylinder","plane","point","cone"]);var r=null,r=this.doRaycasterPick(e,t,!0);if(-1!=i.indexOf("point")&&n&&this.previewSnappedPoint2(r),null!=this.snappedPoint)this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null),n||(null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstSelInfo={type:"point",point:this.snappedPoint.clone()},this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point):"bodyDistance"==this.measureType&&"point"==this.distanceInfo.firstSelInfo.type&&this.isTwoPointTheSame(this.distanceInfo.firstSelInfo.point,this.snappedPoint)?(this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null)):(this.distanceInfo.secondSelInfo={type:"point",point:this.snappedPoint.clone()},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo)),this.snappedPoint=null);else{var o=this.viewer;if(r&&0!=r.length){var a=null;if(a=!o.ndsModel&&!(r[0].object instanceof THREE.Line||r[0].object instanceof THREE.LineSegments)&&1<r.length&&(r[1].object instanceof THREE.Line||r[1].object instanceof THREE.LineSegments)&&(b=Math.abs(r[1].distance-r[0].distance))<linePrecision?r[1]:r[0]){e=null;n||-1==i.indexOf("point")||(e=this.getSnappingPntEx(a));t=this.getSelectInfoFromIntersect(a);if(t){if("bodyDistance"==this.measureType&&-1==i.indexOf(t.type))return this.distanceInfo.preSelInfo=null,void(this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null));if("line"!=t.type||this.Bline(t))if(1==n)-1!=i.indexOf(t.type)?this.isTwoTopolInfoTheSame(this.distanceInfo.preSelInfo,t)||(this.distanceInfo.preSelInfo=t,this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null)):this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null);else{if(-1==i.indexOf(t.type)&&-1!=i.indexOf("plane")&&("cylinder"===t.type||"other"===t.type||"nurbs"===t.type))return this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACEPARALLEL),void(this.distanceInfo.firstSelInfo&&this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,t)&&(this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null)));if(this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN),this.distanceInfo.preSelInfo=null,this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null),e)null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstSelInfo={type:"point",point:e},this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point):(this.distanceInfo.secondSelInfo={type:"point",point:e},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo));else if(-1==i.indexOf("point")||-1!=i.indexOf(t.type))if(this.distanceInfo.firstSelInfo){if(this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,t))this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null);else if(-1!=i.indexOf(t.type)||-1!=i.indexOf("point")){if("line"==this.distanceInfo.firstSelInfo.type){var s=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo);if("line"==t.type){var l=this.getLineStartEndPoints(t);if(s&&l){(v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),(g=(new THREE.Vector3).subVectors(l.end,l.start)).normalize();var d=v.dot(g);if(1-Math.abs(d)<1e-7){if((b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(l.start,!1)).distanceTo(l.start))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.INTERSECT);this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=E,this.distanceInfo.secondPoint=l.start.clone()}else{var c=l.start.clone().sub(s.start),h=Math.pow(v.clone().cross(g).length(),2),u=c.clone().cross(g).dot(v.clone().cross(g))/h,f=c.clone().cross(v).dot(v.clone().cross(g))/h,p=v.clone().multiplyScalar(u).add(s.start),m=g.clone().multiplyScalar(f).add(l.start);if((b=p.distanceTo(m))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.INTERSECT);this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=p,this.distanceInfo.secondPoint=m}}}else"plane"==t.type?((v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),Math.abs(t.worldNormal.dot(v))<1e-5?(this.distanceInfo.secondSelInfo=t,(y=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),M=new THREE.Vector3,y.projectPoint(s.start,M),b=M.distanceTo(s.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=s.start.clone(),this.distanceInfo.secondPoint=M):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.PLANENOPARALLEL)):"circle"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||(l=this.getLineStartEndPoints(t),"bodyDistance"==this.measureType&&"circle"==t.type?s&&l&&(b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=E,this.distanceInfo.secondPoint=l.start.clone(),this.distanceInfo.secondSelInfo=t):s&&l&&((v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),(g=(new THREE.Vector3).subVectors(l.end,l.start)).normalize(),d=v.dot(g),1-Math.abs(d)<1e-7?(this.distanceInfo.secondSelInfo=t,b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=E,this.distanceInfo.secondPoint=l.start.clone()):(c=l.start.clone().sub(s.start),h=Math.pow(v.clone().cross(g).length(),2),u=c.clone().cross(g).dot(v.clone().cross(g))/h,f=c.clone().cross(v).dot(v.clone().cross(g))/h,p=v.clone().multiplyScalar(u).add(s.start),m=g.clone().multiplyScalar(f).add(l.start),b=p.distanceTo(m),this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=p,this.distanceInfo.secondPoint=m)))}else if("point"==this.distanceInfo.firstSelInfo.type||"bodyDistance"==this.measureType&&"circle"==this.distanceInfo.firstSelInfo.type)"bodyDistance"==this.measureType&&"circle"==this.distanceInfo.firstSelInfo.type?(s=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo),this.distanceInfo.firstPoint=s.start.clone()):this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point,"line"==(this.distanceInfo.secondSelInfo=t).type?(s=this.getLineStartEndPoints(t))&&(b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(this.distanceInfo.firstPoint,!1)).distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondPoint=E):"plane"==t.type?((y=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),M=new THREE.Vector3,y.projectPoint(this.distanceInfo.firstPoint,M),b=M.distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondPoint=M):"circle"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||("bodyDistance"==this.measureType&&"circle"==t.type?(s=this.getLineStartEndPoints(t))&&(b=s.start.distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondPoint=s.start.clone()):(s=this.getLineStartEndPoints(t))&&(b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(this.distanceInfo.firstPoint,!1)).distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondPoint=E));else if("plane"==this.distanceInfo.firstSelInfo.type)"line"==t.type?(s=this.getLineStartEndPoints(t))&&((v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),Math.abs(this.distanceInfo.firstSelInfo.worldNormal.dot(v))<1e-5?((y=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),M=new THREE.Vector3,y.projectPoint(s.start,M),b=M.distanceTo(s.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=M,this.distanceInfo.secondPoint=s.start.clone()):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.LINENOPARALLEL)):"plane"==t.type?(o=this.distanceInfo.firstSelInfo.worldNormal,r=t.worldNormal.clone(),o.normalize(),r.normalize(),r=Math.abs(o.dot(r)),Math.abs(r-1)<1e-5?(this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.intersect,(y=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),M=new THREE.Vector3,y.projectPoint(this.distanceInfo.firstPoint,M),b=M.distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondPoint=M):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.PLANENOPARALLEL)):"circle"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||(s=this.getLineStartEndPoints(t),"bodyDistance"==this.measureType&&"circle"==t.type?s&&((y=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),M=new THREE.Vector3,y.projectPoint(s.start,M),b=M.distanceTo(s.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=M,this.distanceInfo.secondPoint=s.start.clone(),this.distanceInfo.secondSelInfo=t):s&&((v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),Math.abs(this.distanceInfo.firstSelInfo.worldNormal.dot(v))<1e-5?(this.distanceInfo.secondSelInfo=t,(y=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),M=new THREE.Vector3,y.projectPoint(s.start,M),b=M.distanceTo(s.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=M,this.distanceInfo.secondPoint=s.start.clone()):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.AXISNOPARALLEL)));else if("circle"==this.distanceInfo.firstSelInfo.type||"cylinder"==this.distanceInfo.firstSelInfo.type||"cone"==this.distanceInfo.firstSelInfo.type){var g,v,y,s=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo),l=this.getLineStartEndPoints(t);if("line"==t.type||"circle"==t.type||"cylinder"==t.type||"cone"==t.type){if("bodyDistance"==this.measureType&&"circle"==t.type)s&&l&&(b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=E,this.distanceInfo.secondPoint=l.start.clone());else if(s&&l){(v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),(g=(new THREE.Vector3).subVectors(l.end,l.start)).normalize();d=v.dot(g);if(1-Math.abs(d)<1e-7){this.distanceInfo.secondSelInfo=t;var E,b=(E=new THREE.Line3(s.start,s.end).closestPointToPoint(l.start,!1)).distanceTo(l.start);this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=E,this.distanceInfo.secondPoint=l.start.clone()}else{if("bodyDistance"==this.measureType&&("line"==t.type||"cylinder"==t.type||"cone"==t.type)){c=l.start.clone().sub(s.start),h=Math.pow(v.clone().cross(g).length(),2),u=c.clone().cross(g).dot(v.clone().cross(g))/h,f=c.clone().cross(v).dot(v.clone().cross(g))/h,p=v.clone().multiplyScalar(u).add(s.start),m=g.clone().multiplyScalar(f).add(l.start);if((b=p.distanceTo(m))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.INTERSECT);this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=p,this.distanceInfo.secondPoint=m}if("circle"==t.type||"cylinder"==t.type||"cone"==t.type)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.TWOAXISNOPARALLEL);c=l.start.clone().sub(s.start),h=Math.pow(v.clone().cross(g).length(),2),u=c.clone().cross(g).dot(v.clone().cross(g))/h,f=c.clone().cross(v).dot(v.clone().cross(g))/h,p=v.clone().multiplyScalar(u).add(s.start),m=g.clone().multiplyScalar(f).add(l.start);b=p.distanceTo(m),this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.firstPoint=p,this.distanceInfo.secondPoint=m}}}else"plane"==t.type&&((v=(new THREE.Vector3).subVectors(s.end,s.start)).normalize(),Math.abs(t.worldNormal.dot(v))<1e-6?((y=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),M=new THREE.Vector3,y.projectPoint(s.start,M),b=M.distanceTo(s.start),this.distanceInfo.dimString=b.toFixed(2),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=s.start.clone(),this.distanceInfo.secondPoint=M):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDS.INFOTYPE.PLANENOPARALLEL))}var M=this.viewer.getDispalyModelUnit(b=b<1&&.999999<b?1:b);b*=M.scale,this.distanceInfo.unit=this.getUnitStringmap(M.unit),this.distanceInfo.dimString=b.toFixed(2)}}else-1==i.indexOf(t.type)&&-1==i.indexOf("point")||(this.distanceInfo.firstSelInfo=t);else{var x=t.intersect.clone();null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=x,this.distanceInfo.firstSelInfo={type:"point",point:x}):(this.distanceInfo.secondSelInfo={type:"point",point:x},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo))}}else this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null)}else n||(e?null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstSelInfo={type:"point",point:e},this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point):(this.distanceInfo.secondSelInfo={type:"point",point:e},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo)):-1!=i.indexOf("point")&&(x=a.point,null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=x,this.distanceInfo.firstSelInfo={type:"point",point:x}):(this.distanceInfo.secondSelInfo={type:"point",point:x},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo))))}}else this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null)}},Ze.prototype.updateMeasureDistanceScene=function(e){var t;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null):!(!e||"true"!==e.toLowerCase())?this.distanceInfo.preSelInfo&&!this.distanceInfo.preSelObj&&("line"==this.distanceInfo.preSelInfo.type||"circle"==this.distanceInfo.preSelInfo.type?(t=(this.viewer.is2DModel,this.createLine(this.distanceInfo.preSelInfo,!(t=null))))&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t):"plane"!=this.distanceInfo.preSelInfo.type&&"cylinder"!=this.distanceInfo.preSelInfo.type&&"cone"!=this.distanceInfo.preSelInfo.type||(t=this.createFace(this.distanceInfo.preSelInfo,!0))&&((e=[]).push(t),this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects=e),this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t)):(this.distanceInfo.firstSelInfo&&!this.distanceInfo.firstSelObj&&(this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null),t=null,"point"==this.distanceInfo.firstSelInfo.type?t=this.createPointMesh(this.distanceInfo.firstSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.firstSelInfo.type||"circle"==this.distanceInfo.firstSelInfo.type?t=this.createLine(this.distanceInfo.firstSelInfo,!1):"plane"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(t=this.createFace(this.distanceInfo.firstSelInfo,!1),"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(this.distanceInfo.axisLineObj=this.createAxisLine(this.distanceInfo.firstSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.axisLineObj))),t&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.firstSelObj=t)),this.distanceInfo.secondSelInfo&&!this.distanceInfo.secondSelObj&&(this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null),t=null,"point"==this.distanceInfo.secondSelInfo.type?t=this.createPointMesh(this.distanceInfo.secondSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.secondSelInfo.type||"circle"==this.distanceInfo.secondSelInfo.type?t=this.createLine(this.distanceInfo.secondSelInfo,!1):"plane"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(t=this.createFace(this.distanceInfo.secondSelInfo,!1),"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(this.distanceInfo.secaxisLineObj=this.createAxisLine(this.distanceInfo.secondSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.secaxisLineObj))),t&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.secondSelObj=t)),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.viewer.is2DModel?this.createAndShowDistanceDimension():(this.createAndShow3DDistanceDimension(null,!0),this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelInfo=null)))};function qe(e){Xe.call(this,e),this.measureClass="Hole"}(qe.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){this.measureType=e,"radius"===this.measureType&&(ye.isMobileDevice()||this.OpMeasure.PostInfo(NDS.INFOTYPE.MEASUREBODY))},qe.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeRadius(n):"radius"==this.measureType&&(this.holeInfo.firstSelHoleObj&&!ye.isMobileDevice()?this.createAndShowMeasureRadiusAndDiameterDimension(n):(this.measureRadiusAndDiameter(e,t,!0),this.updateMeasureRadiusAndDiameterScene("true",n)))},qe.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);"radius"==this.measureType&&(this.holeInfo.firstSelHoleObj?(this.viewer.is2DModel?this.createAndShowMeasureRadiusAndDiameterDimension(i,!0):this.createAndShowMeasure3DRadiusAndDiameterDimension(i,!0),this.holeInfo.firstSelHoleObj||ye.isMobileDevice()||this.OpMeasure.PostInfo(NDS.INFOTYPE.MEASUREBODY)):(this.measureRadiusAndDiameter(e,t,!1),this.updateMeasureRadiusAndDiameterScene("false",i),this.holeInfo.firstSelHoleObj&&!ye.isMobileDevice()&&this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE)))},qe.prototype.getCylinderOrigin=function(e){var t=e.geometry,n=e.indexRange.concat();this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3);var i=t.index,r=t.attributes.position,o=i.getX(3*n[0]),a=i.getX(3*n[0]+1),s=i.getX(3*n[0]+2),t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3;t.fromBufferAttribute(r,o),i.fromBufferAttribute(r,a),n.fromBufferAttribute(r,s);a=new THREE.Vector3(e.origin[0],e.origin[1],e.origin[2]),r=new THREE.Vector3(e.axis[0],e.axis[1],e.axis[2]),s=(new THREE.Vector3).addVectors(a,r),e=this.getProjectPntToLine(a,s,t),r=e.distanceTo(a),t=this.getProjectPntToLine(a,s,i),i=t.distanceTo(a),n=this.getProjectPntToLine(a,s,n),a=n.distanceTo(a);return r<=i&&r<=a?e:i<=r&&i<=a?t:n},qe.prototype.getHoleAxisAndCenter=function(e){var t=new THREE.Vector3,n=new THREE.Quaternion,i=new THREE.Vector3;if(e.matrixWorld.decompose(t,n,i),"cylinder"==e.type){var r=this.getCylinderOrigin(e);return r.applyMatrix4(e.matrixWorld),(d=new THREE.Vector3(e.axis[0],e.axis[1],e.axis[2])).applyQuaternion(n),d.normalize(),{center:r,axis:d}}if("circle"==e.type){var o=new THREE.Vector3(e.center[0],e.center[1],e.center[2]),a=e.geometry,s=e.indexRange.concat();this.viewer.ndsModel&&(s[0]+=a.drawRange.start/2,s[1]+=a.drawRange.start/2);var l=(s[0]+s[1])/2;l-1>s[0]&&l--;t=a.index,i=a.attributes.position.array;if(null!=t){r=t.array,a=new THREE.Vector3,t=new THREE.Vector3;a.fromArray(i,3*r[2*s[0]]),t.fromArray(i,3*r[2*l]);var a=(new THREE.Vector3).subVectors(a,o),t=(new THREE.Vector3).subVectors(t,o),d=(new THREE.Vector3).crossVectors(a,t);return o.applyMatrix4(e.matrixWorld),d.applyQuaternion(n),d.normalize(),{center:o,axis:d}}}return null},qe.prototype.measureRadiusAndDiameter=function(e,t,n){if(""==this.holeInfo.unit&&(this.holeInfo.unit=this.getUnitString()),this.holeInfo.firstSelHoleObj)this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null);else{var i=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){if(0<e.length){t=null;if(i.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&(Math.abs(e[1].distance-e[0].distance)<(i=this.viewer.controls.getBoundingBox()).min.distanceTo(i.max)/1e3&&(t=e[1])),t){e=this.getSelectInfoFromIntersect(t);if(!e||"cylinder"!=e.type&&"circle"!=e.type)return this.holeInfo.preSelHoleInfo=e,void(this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null));if(e)return void(1==n?this.isTwoTopolInfoTheSame(this.holeInfo.preSelHoleInfo,e)||(this.holeInfo.preSelHoleInfo=e,this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null)):(this.holeInfo.firstHoleInfo=e,t=this.getHoleAxisAndCenter(e),this.holeInfo.firstHoleInfo.worldCenter=t.center,this.holeInfo.firstHoleInfo.worldAxis=t.axis,t="radius"==this.measureType?e.radius:2*e.radius,e=this.viewer.getDispalyModelUnit(t=t<1&&.999999<t?1:t),t*=e.scale,this.holeInfo.dimString=(parseInt(t*Math.pow(10,2)+.5)/Math.pow(10,2)).toFixed(2),this.holeInfo.unit=this.getUnitStringmap(e.unit),"radius"==this.measureType?this.holeInfo.dimString="R "+this.holeInfo.dimString:this.holeInfo.dimString="Φ "+this.holeInfo.dimString))}}1==n&&this.holeInfo.preSelHoleInfo&&(this.holeInfo.preSelHoleInfo=null,this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null))}else this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null)}},qe.prototype.updateMeasureRadiusAndDiameterScene=function(e,t){var n;"radius"!==this.measureType&&"diameter"!=this.measureType||(this.holeInfo.firstSelHoleObj?this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null):!(!e||"true"!==e.toLowerCase())?this.holeInfo.preSelHoleInfo&&!this.holeInfo.preSelHoleObj&&("cylinder"==this.holeInfo.preSelHoleInfo.type?(n=this.createFace(this.holeInfo.preSelHoleInfo,!0))&&((e=[]).push(n),this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects=e),this.OpMeasure.rootObject.add(n),this.holeInfo.preSelHoleObj=n):"circle"==this.holeInfo.preSelHoleInfo.type&&(n=this.createLine(this.holeInfo.preSelHoleInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.holeInfo.preSelHoleObj=n)):(this.holeInfo.firstHoleInfo&&!this.holeInfo.firstSelHoleObj&&(n=null,"cylinder"==this.holeInfo.firstHoleInfo.type?n=this.createFace(this.holeInfo.firstHoleInfo,!1):"circle"==this.holeInfo.firstHoleInfo.type&&(n=this.createLine(this.holeInfo.firstHoleInfo,!1)),n&&(this.OpMeasure.rootObject.add(n),this.holeInfo.firstSelHoleObj=n)),this.holeInfo.firstSelHoleObj&&(Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.viewer.is2DModel?this.createAndShowMeasureRadiusAndDiameterDimension(t):this.createAndShowMeasure3DRadiusAndDiameterDimension(t,!0))))},qe.prototype.createAndShowMeasureRadiusAndDiameterDimension=function(e,t){var n,i,r,o,a;"radius"!=this.measureType&&"diameter"!=this.measureType||this.holeInfo.firstHoleInfo&&this.holeInfo.firstSelHoleObj&&(this.holeInfo.selLineCenterPos||(this.holeInfo.selLineCenterPos=this.holeInfo.firstHoleInfo.worldCenter.clone()),this.holeInfo.textPos?e&&((n=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&this.holeInfo.textPos.copy(i)):((n=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))?this.holeInfo.textPos=i:((r=(new THREE.Vector3).subVectors(this.holeInfo.firstHoleInfo.intersect,this.holeInfo.firstHoleInfo.worldCenter)).projectOnPlane(this.holeInfo.firstHoleInfo.worldAxis),this.holeInfo.textPos=(new THREE.Vector3).addVectors(this.holeInfo.firstHoleInfo.worldCenter,r))),(i=(new THREE.Vector3).subVectors(this.holeInfo.textPos,this.holeInfo.selLineCenterPos)).normalize(),this.holeInfo.fstClnd?(this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(i.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(i.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),r=this.isPointBetweenIn(this.holeInfo.textPos,this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos),this.holeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.sndClnd),r?(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(o=i.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=o.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,o.clone().multiplyScalar(a)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.sndClnd,this.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=o.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,o.clone().multiplyScalar(a)))):(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.fstClndPos,this.holeInfo.selLineCenterPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(o=i.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=o.clone(),this.holeInfo.fstClnd.position.addVectors(this.holeInfo.fstClndPos,o.clone().multiplyScalar(a)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.sndClndPos,this.holeInfo.selLineCenterPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.sndClnd,this.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=o.clone().multiplyScalar(-1),this.holeInfo.sndClnd.position.subVectors(this.holeInfo.sndClndPos,o.clone().multiplyScalar(a)))),this.OpMeasure.rootObject.add(this.holeInfo.fstClnd),"diameter"==this.measureType&&this.holeInfo.sndClnd&&this.OpMeasure.rootObject.add(this.holeInfo.sndClnd)):(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(i.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(i.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(o=i.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=o.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,o.clone().multiplyScalar(a)),this.OpMeasure.rootObject.add(this.holeInfo.fstClnd),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine),a=this.OpMeasure.getScale(this.holeInfo.sndClnd,NDS.INFOTYPE.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=o.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,o.clone().multiplyScalar(a)),this.OpMeasure.rootObject.add(this.holeInfo.sndClnd))),this.holeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine),this.holeInfo.centerToClndLine=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.holeInfo.centerToClndLine),this.holeInfo.centerToClndLine2&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine2),"diameter"==this.measureType&&(this.holeInfo.centerToClndLine2=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.holeInfo.centerToClndLine2)),a=this.holeInfo.dimString.slice(0,2)+(this.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2)+this.holeInfo.unit,this.holeInfo.textBox||(this.holeInfo.textBox=document.createElement("div"),this.holeInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.holeInfo.textBox)),this.getAndShowTextBox(this.holeInfo.textPos.clone(),a,this.holeInfo.textBox),1==t&&((t={}).start=this.holeInfo.textPos.clone(),t.end=this.holeInfo.fstClndPos.clone(),this.OpMeasure.textLines.push(t),(t={}).dimString=a,t.textPos=this.holeInfo.textPos.clone(),t.textBox=this.holeInfo.textBox,t.textBox.setAttribute("type","radius"),t.textBox.setAttribute("dimString",this.holeInfo.dimString),t.textBox.setAttribute("unit",this.holeInfo.unit),t.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(t),this.clearHoleInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},qe.prototype.createAndShowMeasure3DRadiusAndDiameterDimension=function(e,t){var n,i,r,o,a,s,l;"radius"!=this.measureType&&"diameter"!=this.measureType||this.holeInfo.firstHoleInfo&&this.holeInfo.firstSelHoleObj&&(this.holeInfo.selLineCenterPos||(this.holeInfo.selLineCenterPos=this.holeInfo.firstHoleInfo.worldCenter.clone()),this.holeInfo.textPos?e&&((n=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&this.holeInfo.textPos.copy(i)):((n=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))?this.holeInfo.textPos=i:((r=(new THREE.Vector3).subVectors(this.holeInfo.firstHoleInfo.intersect,this.holeInfo.firstHoleInfo.worldCenter)).projectOnPlane(this.holeInfo.firstHoleInfo.worldAxis),this.holeInfo.textPos=(new THREE.Vector3).addVectors(this.holeInfo.firstHoleInfo.worldCenter,r))),(r=(new THREE.Vector3).subVectors(this.holeInfo.textPos,this.holeInfo.selLineCenterPos)).normalize(),this.holeInfo.fstClnd?(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(r.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(r.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.isPointBetweenIn(this.holeInfo.textPos,this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos)?(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine),o=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(l=r.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,l.clone().multiplyScalar(o))):(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.fstClndPos,this.holeInfo.selLineCenterPos,this.appmaterialLine),o=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(l=r.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=l.clone(),this.holeInfo.fstClnd.position.addVectors(this.holeInfo.fstClndPos,l.clone().multiplyScalar(o)))):(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(r.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(r.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine),o=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(l=r.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,l.clone().multiplyScalar(o)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.appmaterialLine),o=this.OpMeasure.getScale(this.holeInfo.sndClnd,NDS.INFOTYPE.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=l.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,l.clone().multiplyScalar(o)))),this.holeInfo.centerToClndLine=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine,1),r=this.holeInfo.dimString.slice(0,2)+(this.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2)+this.holeInfo.unit,l=null,this.holeInfo.textBox||(this.holeInfo.textBox=document.createElement("div"),this.holeInfo.textBox.className="section10",this.holeInfo.textBox.innerHTML=r,(s=document.createElement("div")).className="sectionPoint",this.holeInfo.textBox.appendChild(s),(l=document.createElement("div")).className="sectionCross",this.holeInfo.textBox.appendChild(l),this.viewer.container.appendChild(this.holeInfo.textBox)),1==t&&((o={}).dimString=r,o.textPos=this.holeInfo.textPos.clone(),o.textBox=this.holeInfo.textBox,a=this,s=new THREE.Group,t=new THREE.Group,s.objectType="Group",t.objectType="Group",t.name="unsteady",t.add(this.holeInfo.fstClnd),t.add(this.holeInfo.centerToClndLine),s.add(t),this.OpMeasure.rootObject.remove(this.holeInfo.firstSelHoleObj),s.add(this.holeInfo.firstSelHoleObj),a.OpMeasure.rootObject.add(s),ye.isMobileDevice()?(o.textBox.addEventListener("touchstart",this.touchstart,!1),o.textBox.addEventListener("touchend",this.touchend,!1),o.textBox.addEventListener("touchmove",this.touchmove,!1)):(o.textBox.addEventListener("mousedown",this.touchstart,!1),o.textBox.addEventListener("mouseup",this.touchend,!1),o.textBox.addEventListener("mousemove",this.touchmove,!1),o.textBox.addEventListener("mouseleave",this.mouseleave,!1),o.textBox.addEventListener("mouseenter",this.mouseenter,!1)),ye.isMobileDevice()?l.addEventListener("touchend",this.sectionCrossend,!1):(l.addEventListener("mousedown",this.sectionCrossend,!1),l.addEventListener("mouseleave",this.crossleave,!1),l.addEventListener("mouseenter",this.crossenter,!1)),(l={}).start=this.holeInfo.textPos.clone(),l.end=this.holeInfo.fstClndPos.clone(),l.uuid=s.uuid,this.OpMeasure.textLines.push(l),o.textBox.setAttribute("mobile","up"),o.textBox.setAttribute("group",s.uuid),o.textBox.setAttribute("type","radius"),o.textBox.setAttribute("dimString",this.holeInfo.dimString),o.textBox.setAttribute("unit",this.holeInfo.unit),o.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.unsteadyData[s.uuid]=this.DeepCopy(this.holeInfo),this.OpMeasure.boxInfos.push(o),this.getAndShowTextBox(this.holeInfo.textPos.clone(),r,this.holeInfo.textBox),this.clearHoleInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},qe.prototype.changeRadius=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n),(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i,r,o=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid];o.selLineCenterPos||(o.selLineCenterPos=o.firstHoleInfo.worldCenter.clone()),o.textPos?e&&((i=new THREE.Plane).setFromNormalAndCoplanarPoint(o.firstHoleInfo.worldAxis,o.firstHoleInfo.worldCenter),(r=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))?o.textPos.copy(r):((s=(new THREE.Vector3).subVectors(o.firstHoleInfo.intersect,o.firstHoleInfo.worldCenter)).projectOnPlane(o.firstHoleInfo.worldAxis),o.textPos=(new THREE.Vector3).addVectors(o.firstHoleInfo.worldCenter,s))):((i=new THREE.Plane).setFromNormalAndCoplanarPoint(o.firstHoleInfo.worldAxis,o.firstHoleInfo.worldCenter),(r=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))?o.textPos=r:((s=(new THREE.Vector3).subVectors(o.firstHoleInfo.intersect,o.firstHoleInfo.worldCenter)).projectOnPlane(o.firstHoleInfo.worldAxis),o.textPos=(new THREE.Vector3).addVectors(o.firstHoleInfo.worldCenter,s)));var a,s=(new THREE.Vector3).subVectors(o.textPos,o.selLineCenterPos);s.normalize(),o.fstClnd?(o.fstClndPos=o.selLineCenterPos.clone().add(s.clone().multiplyScalar(o.firstHoleInfo.radius)),o.sndClndPos=o.selLineCenterPos.clone().add(s.clone().multiplyScalar(-o.firstHoleInfo.radius)),this.isPointBetweenIn(o.textPos,o.selLineCenterPos,o.fstClndPos)?(o.fstClnd=this.createCylinderMesh(o.selLineCenterPos,o.fstClndPos,this.appmaterialLine),h=this.OpMeasure.getScale(o.fstClnd,this.CYLINDERWIDTH),(a=s.clone()).multiplyScalar(.5*o.fstClnd.geometry.parameters.height),o.fstClnd.oldPosition=o.fstClndPos.clone(),o.fstClnd.offsetPos=a.clone().multiplyScalar(-1),o.fstClnd.position.subVectors(o.fstClndPos,a.clone().multiplyScalar(h))):(o.fstClnd=this.createCylinderMesh(o.fstClndPos,o.selLineCenterPos,this.appmaterialLine),h=this.OpMeasure.getScale(o.fstClnd,this.CYLINDERWIDTH),(a=s.clone()).multiplyScalar(.5*o.fstClnd.geometry.parameters.height),o.fstClnd.oldPosition=o.fstClndPos.clone(),o.fstClnd.offsetPos=a.clone(),o.fstClnd.position.addVectors(o.fstClndPos,a.clone().multiplyScalar(h)))):(o.fstClndPos=o.selLineCenterPos.clone().add(s.clone().multiplyScalar(o.firstHoleInfo.radius)),o.sndClndPos=o.selLineCenterPos.clone().add(s.clone().multiplyScalar(-o.firstHoleInfo.radius)),o.fstClnd=this.createCylinderMesh(o.selLineCenterPos,o.fstClndPos,this.materialLine),h=this.OpMeasure.getScale(o.fstClnd,this.CYLINDERWIDTH),(a=s.clone()).multiplyScalar(.5*o.fstClnd.geometry.parameters.height),o.fstClnd.oldPosition=o.fstClndPos.clone(),o.fstClnd.offsetPos=a.clone().multiplyScalar(-1),o.fstClnd.position.subVectors(o.fstClndPos,a.clone().multiplyScalar(h)),"diameter"==this.measureType&&(o.sndClnd=this.createCylinderMesh(o.selLineCenterPos,o.sndClndPos,this.materialLine),h=this.OpMeasure.getScale(o.sndClnd,NDS.INFOTYPE.CYLINDERWIDTH),o.sndClnd.oldPosition=o.sndClndPos.clone(),o.sndClnd.offsetPos=a.clone(),o.sndClnd.position.addVectors(o.sndClndPos,a.clone().multiplyScalar(h)))),o.centerToClndLine=this.createLineMesh2(o.selLineCenterPos,o.fstClndPos,this.appmaterialLine,1),n.add(o.fstClnd),n.add(o.centerToClndLine);for(var l=0;l<this.OpMeasure.boxInfos.length;l++){var d=this.OpMeasure.boxInfos[l];if(d.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){d.textPos=o.textPos;break}}for(l=0;l<this.OpMeasure.textLines.length;l++){var c=this.OpMeasure.textLines[l];if(c.uuid==this.OpMeasure.unsteadyuuid){c.start=o.textPos.clone(),c.end=o.fstClndPos.clone();break}}var h=this.get2dPoint(o.textPos.clone()),n=this.get2dPoint(o.fstClndPos.clone()),n=(this.viewer.renderer.getPixelRatio(),new THREE.Vector2(h.x-n.x,h.y-n.y));n.normalize(),n.y>=n.x/2&&n.y>=-n.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):n.y>n.x/2&&n.y<-n.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):n.y<n.x/2&&n.y<-n.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):n.y<n.x/2&&n.y>-n.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left")),this.OpMeasure.viewer.render()};function Qe(e){Xe.call(this,e),this.measureClass="Edge"}(Qe.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"bodyEdgeLength":this.OpMeasure.PostInfo(NDS.INFOTYPE.MEASUREBODY);break;case"measureEdges":this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEANDCIRCLE)}},Qe.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeMeasureEdge(n):this.edgeInfo.selLineObj&&!ye.isMobileDevice()?this.createAndShowMeasureEdgesDimension(n):(this.measureEdges(e,t,!0),this.viewer.is2DModel?this.updateMeasureEdgesScene("true",n):this.update3DMeasureEdgesScene("true",n))},Qe.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.edgeInfo.selLineObj?this.viewer.is2DModel?(this.createAndShowMeasureEdgesDimension(i,!0),this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEANDCIRCLE)):this.createAndShow3DMeasureEdgesDimension(i,!0):(this.measureEdges(e,t,!1),this.viewer.is2DModel?(this.updateMeasureEdgesScene("false",i),this.edgeInfo.selLineObj&&this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE)):this.update3DMeasureEdgesScene("false",i))},Qe.prototype.createAndShowMeasureEdgesDimension=function(e,t){var n,i,r,o,a,s,l,d,c;"measureEdges"!=this.measureType&&"bodyEdgeLength"!=this.measureType||this.edgeInfo.selLineInfo&&this.edgeInfo.selLineObj&&(n=!1,(n=this.edgeInfo.thirdPos?!0:n)?((s=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.midPos,this.edgeInfo.thirdPos),this.edgeInfo.textPos||(this.edgeInfo.textPos=this.edgeInfo.startPos.clone()),e&&((i=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))&&(this.edgeInfo.textPos=i),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.boxToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.boxToClndLine))):(this.edgeInfo.fstClndPos||(this.edgeInfo.fstClndPos=this.edgeInfo.startPos.clone()),this.edgeInfo.sndClndPos||(this.edgeInfo.sndClndPos=this.edgeInfo.endPos.clone()),i=(new THREE.Vector3).subVectors(this.edgeInfo.endPos,this.edgeInfo.startPos),this.edgeInfo.fstClnd&&this.edgeInfo.sndClnd?e&&((s=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),(l=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))&&(d=this.getProjectPntToLine(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,l))&&(r=d.clone().sub(this.edgeInfo.startPos),this.edgeInfo.fstClndPos.addVectors(this.edgeInfo.startPos,r),this.edgeInfo.sndClndPos=this.edgeInfo.fstClndPos.clone().add(i))):"line"==this.edgeInfo.selLineInfo.type?(o=this.viewer.camera.getWorldDirection(),a=(new THREE.Vector3).crossVectors(i,o),a=this.getBaceFaceDir(a),c=(c=i.length())<1?.01:.5,a.normalize().multiplyScalar(c),this.edgeInfo.fstClndPos.add(a),this.edgeInfo.sndClndPos.add(a)):(r=(new THREE.Vector3).subVectors(this.edgeInfo.midPos,this.edgeInfo.startPos),1e-7<(r=(new THREE.Vector3).crossVectors(i,r)).lengthSq()?((r=(new THREE.Vector3).crossVectors(r,i)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(r),this.edgeInfo.sndClndPos.add(r)):(o=this.viewer.camera.getWorldDirection(),a=(new THREE.Vector3).crossVectors(i,o),(a=this.getBaceFaceDir(a)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(a),this.edgeInfo.sndClndPos.add(a))),this.edgeInfo.textPos?e&&((s=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),(l=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))&&(d=this.getProjectPntToLine(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,l))&&this.edgeInfo.textPos.copy(d)):this.edgeInfo.textPos=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.startToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine),this.edgeInfo.startToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.startToClndLine),this.edgeInfo.endToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine),this.edgeInfo.endToClndLine=this.createLineMesh2(this.edgeInfo.endPos,this.edgeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.endToClndLine),d=this.isPointBetweenIn(this.edgeInfo.textPos,this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos),this.edgeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd),i.normalize(),d?(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),c=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),i.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=i.clone(),this.edgeInfo.fstClnd.position.addVectors(this.edgeInfo.fstClndPos,i.clone().multiplyScalar(c))):(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),c=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),i.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=i.clone().multiplyScalar(-1),this.edgeInfo.fstClnd.position.subVectors(this.edgeInfo.fstClndPos,i.clone().multiplyScalar(c))),this.OpMeasure.rootObject.add(this.edgeInfo.fstClnd),this.edgeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd),d?(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=i.clone().multiplyScalar(-1),this.edgeInfo.sndClnd.position.subVectors(this.edgeInfo.sndClndPos,i.clone().multiplyScalar(c))):(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=i.clone(),this.edgeInfo.sndClnd.position.addVectors(this.edgeInfo.sndClndPos,i.clone().multiplyScalar(c))),this.OpMeasure.rootObject.add(this.edgeInfo.sndClnd),this.edgeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine),this.edgeInfo.clndToClndLine=this.createLineMesh2(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.clndToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.boxToClndLine=this.createLineMesh2(this.edgeInfo.fstClndPos,this.edgeInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.boxToClndLine)),c="",c="⌒"==this.edgeInfo.dimString[0]?"⌒ "+(this.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2)+this.edgeInfo.unit:(this.edgeInfo.dimString*this.viewer.measuringScale).toFixed(2)+this.edgeInfo.unit,this.edgeInfo.textBox||(this.edgeInfo.textBox=document.createElement("div"),this.edgeInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.edgeInfo.textBox)),this.getAndShowTextBox(this.edgeInfo.textPos.clone(),c,this.edgeInfo.textBox),1==t&&((t={}).dimString=c,t.textPos=this.edgeInfo.textPos.clone(),t.textBox=this.edgeInfo.textBox,t.textBox.setAttribute("type","length"),t.textBox.setAttribute("dimString",this.edgeInfo.dimString),t.textBox.setAttribute("unit",this.edgeInfo.unit),this.OpMeasure.boxInfos.push(t),this.clearEdgeInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes()))},Qe.prototype.measureEdges=function(e,t,n){if(""==this.edgeInfo.unit&&(this.edgeInfo.unit=this.getUnitString()),this.edgeInfo.selLineObj)this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null);else{var i=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){if(0<e.length){t=null;if(i.ndsModel?0<=e[0].lineSegId&&(t=e[0]):e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&(Math.abs(e[1].distance-e[0].distance)<(i=this.viewer.controls.getBoundingBox()).min.distanceTo(i.max)/1e3&&(t=e[1])),t){e=this.getSelectInfoFromIntersect(t);if(e)return void(1==n?this.isTwoTopolInfoTheSame(this.edgeInfo.preSelLineInfo,e)||(this.edgeInfo.preSelLineInfo=e,this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null)):(this.edgeInfo.selLineInfo=e,this.edgeInfo.dimString=parseFloat(e.length),this.edgeInfo.dimString<1&&.999999<this.edgeInfo.dimString&&(this.edgeInfo.dimString=1),t=this.viewer.getDispalyModelUnit(this.edgeInfo.dimString),this.edgeInfo.dimString*=t.scale,this.edgeInfo.dimString=this.edgeInfo.dimString.toFixed(2),this.edgeInfo.unit=this.getUnitStringmap(t.unit),"line"!=e.type&&(this.edgeInfo.dimString="⌒ "+this.edgeInfo.dimString)))}}1==n&&this.edgeInfo.preSelLineInfo&&(this.edgeInfo.preSelLineInfo=null,this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null))}else this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null)}},Qe.prototype.updateMeasureEdgesScene=function(e,t){var n;"measureEdges"!==this.measureType&&"radius"!==this.measureType&&"bodyEdgeLength"!=this.measureType||(this.edgeInfo.selLineObj?this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.edgeInfo.preSelLineInfo&&!this.edgeInfo.preSelLineObj&&(n=this.createLine(this.edgeInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.preSelLineObj=n):(this.edgeInfo.selLineInfo&&!this.edgeInfo.selLineObj&&(this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),(n=this.createLine(this.edgeInfo.selLineInfo,!1))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.selLineObj=n)),this.edgeInfo.selLineObj&&this.createAndShowMeasureEdgesDimension(t)))},Qe.prototype.update3DMeasureEdgesScene=function(e,t){var n;"measureEdges"!==this.measureType&&"radius"!==this.measureType&&"bodyEdgeLength"!=this.measureType||(this.edgeInfo.selLineObj?this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.edgeInfo.preSelLineInfo&&!this.edgeInfo.preSelLineObj&&(n=this.createLine(this.edgeInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.preSelLineObj=n):(this.edgeInfo.selLineInfo&&!this.edgeInfo.selLineObj&&(this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),(n=this.createLine(this.edgeInfo.selLineInfo,!1,this.materialPoint))&&(this.edgeInfo.selLineObj=n)),this.edgeInfo.selLineObj&&(Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.createAndShow3DMeasureEdgesDimension(t,!0))))},Qe.prototype.createAndShow3DMeasureEdgesDimension=function(e,t){var n,i,r,o,a,s,l,d,c,h;"measureEdges"!=this.measureType&&"bodyEdgeLength"!=this.measureType||this.edgeInfo.selLineInfo&&this.edgeInfo.selLineObj&&(n=!1,(n=this.edgeInfo.thirdPos?!0:n)?((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.midPos,this.edgeInfo.thirdPos),this.edgeInfo.textPos||(this.edgeInfo.textPos=this.edgeInfo.startPos.clone()),!e||(n=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(this.edgeInfo.textPos=n)):(this.edgeInfo.fstClndPos||(this.edgeInfo.fstClndPos=this.edgeInfo.startPos.clone()),this.edgeInfo.sndClndPos||(this.edgeInfo.sndClndPos=this.edgeInfo.endPos.clone()),d=(new THREE.Vector3).subVectors(this.edgeInfo.endPos,this.edgeInfo.startPos),this.edgeInfo.fstClnd&&this.edgeInfo.sndClnd?e&&((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),(s=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(l=this.getProjectPntToLine(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,s))&&(i=l.clone().sub(this.edgeInfo.startPos),this.edgeInfo.fstClndPos.addVectors(this.edgeInfo.startPos,i),this.edgeInfo.sndClndPos=this.edgeInfo.fstClndPos.clone().add(d))):"line"==this.edgeInfo.selLineInfo.type?(r=this.viewer.camera.getWorldDirection(),o=(new THREE.Vector3).crossVectors(d,r),o=this.getBaceFaceDir(o),h=(h=d.length())<1?.01:.5,o.normalize().multiplyScalar(h),this.edgeInfo.fstClndPos.add(o),this.edgeInfo.sndClndPos.add(o)):(i=(new THREE.Vector3).subVectors(this.edgeInfo.midPos,this.edgeInfo.startPos),1e-7<(i=(new THREE.Vector3).crossVectors(d,i)).lengthSq()?((i=(new THREE.Vector3).crossVectors(i,d)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(i),this.edgeInfo.sndClndPos.add(i)):(r=this.viewer.camera.getWorldDirection(),o=(new THREE.Vector3).crossVectors(d,r),(o=this.getBaceFaceDir(o)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(o),this.edgeInfo.sndClndPos.add(o))),this.edgeInfo.textPos?e&&((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),(s=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(l=this.getProjectPntToLine(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,s))&&this.edgeInfo.textPos.copy(l)):this.edgeInfo.textPos=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.startToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,this.materialLine,1),this.edgeInfo.endToClndLine=this.createLineMesh2(this.edgeInfo.endPos,this.edgeInfo.sndClndPos,this.materialLine,1),l=this.isPointBetweenIn(this.edgeInfo.textPos,this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos),d.normalize(),l?(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),h=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),d.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=d.clone(),this.edgeInfo.fstClnd.position.addVectors(this.edgeInfo.fstClndPos,d.clone().multiplyScalar(h))):(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),h=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),d.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=d.clone().multiplyScalar(-1),this.edgeInfo.fstClnd.position.subVectors(this.edgeInfo.fstClndPos,d.clone().multiplyScalar(h))),l?(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=d.clone().multiplyScalar(-1),this.edgeInfo.sndClnd.position.subVectors(this.edgeInfo.sndClndPos,d.clone().multiplyScalar(h))):(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=d.clone(),this.edgeInfo.sndClnd.position.addVectors(this.edgeInfo.sndClndPos,d.clone().multiplyScalar(h)))),d="",d="⌒"==this.edgeInfo.dimString[0]?"⌒ "+(this.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2)+this.edgeInfo.unit:(this.edgeInfo.dimString*this.viewer.measuringScale).toFixed(2)+this.edgeInfo.unit,h=null,this.edgeInfo.textBox||(this.edgeInfo.textBox=document.createElement("div"),this.edgeInfo.textBox.className="section10",this.edgeInfo.textBox.innerHTML=d,(c=document.createElement("div")).className="sectionPoint",this.edgeInfo.textBox.appendChild(c),(h=document.createElement("div")).className="sectionCross",this.edgeInfo.textBox.appendChild(h),this.viewer.container.appendChild(this.edgeInfo.textBox)),1==t&&(c={},"line"==this.edgeInfo.selLineInfo.type&&(this.edgeInfo.midPos=this.edgeInfo.startPos.clone().add(this.edgeInfo.endPos).divideScalar(2)),this.edgeInfo.textPos=this.edgeInfo.midPos.clone(),c.dimString=d,c.textPos=this.edgeInfo.textPos.clone(),c.textBox=this.edgeInfo.textBox,(t=new THREE.Group).objectType="Group",t.add(this.edgeInfo.selLineObj),this.OpMeasure.rootObject.add(t),ye.isMobileDevice()?(c.textBox.addEventListener("touchstart",this.touchstart,!1),c.textBox.addEventListener("touchend",this.touchend,!1),c.textBox.addEventListener("touchmove",this.touchmove,!1)):(c.textBox.addEventListener("mousedown",this.touchstart,!1),c.textBox.addEventListener("mouseup",this.touchend,!1),c.textBox.addEventListener("mousemove",this.touchmove,!1),c.textBox.addEventListener("mouseleave",this.mouseleave,!1),c.textBox.addEventListener("mouseenter",this.mouseenter,!1)),ye.isMobileDevice()?h.addEventListener("touchend",this.sectionCrossend,!1):(h.addEventListener("mousedown",this.sectionCrossend,!1),h.addEventListener("mouseleave",this.crossleave,!1),h.addEventListener("mouseenter",this.crossenter,!1)),(h={}).start=this.edgeInfo.textPos.clone(),h.end=this.edgeInfo.midPos.clone(),h.uuid=t.uuid,this.OpMeasure.textLines.push(h),c.textBox.setAttribute("mobile","up"),c.textBox.setAttribute("group",t.uuid),c.textBox.setAttribute("type","length"),c.textBox.setAttribute("dimString",this.edgeInfo.dimString),c.textBox.setAttribute("unit",this.edgeInfo.unit),c.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(c),this.OpMeasure.unsteadyData[t.uuid]=this.DeepCopy(this.edgeInfo),this.getAndShowTextBox(this.edgeInfo.textPos.clone(),d,this.edgeInfo.textBox),this.clearEdgeInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},Qe.prototype.changeMeasureEdge=function(e){var t,n,i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],r=!1;(r=i.thirdPos?!0:r)?((n=new THREE.Plane).setFromCoplanarPoints(i.startPos,i.midPos,i.thirdPos),!e||(t=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&(i.textPos=t)):(r=(new THREE.Vector3).subVectors(i.endPos,i.startPos),i.fstClnd&&i.sndClnd&&e&&(n=new THREE.Plane,Math.abs(i.startPos.x-i.endPos.x)<1e-6&&Math.abs(i.startPos.x-i.fstClndPos.x)<1e-6&&(i.fstClndPos.x+=10),Math.abs(i.startPos.y-i.endPos.y)<1e-6&&Math.abs(i.startPos.y-i.fstClndPos.y)<1e-6&&(i.fstClndPos.y+=10),n.setFromCoplanarPoints(i.startPos,i.endPos,i.fstClndPos),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&(a=this.getProjectPntToLine(i.startPos,i.fstClndPos,o))&&(t=a.clone().sub(i.startPos),i.fstClndPos.addVectors(i.startPos,t),i.sndClndPos=i.fstClndPos.clone().add(r))),e&&((n=new THREE.Plane).setFromCoplanarPoints(i.startPos,i.endPos,i.fstClndPos),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&(a=this.getProjectPntToLine(i.fstClndPos,i.sndClndPos,o))&&i.textPos.copy(a)));var o=this.get2dPoint(i.textPos.clone()),a=this.get2dPoint(i.midPos.clone()),a=(this.viewer.renderer.getPixelRatio(),new THREE.Vector2(o.x-a.x,o.y-a.y));a.normalize(),a.y>=a.x/2&&a.y>=-a.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):a.y>a.x/2&&a.y<-a.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):a.y<a.x/2&&a.y<-a.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):a.y<a.x/2&&a.y>-a.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left"));for(var s=0;s<this.OpMeasure.boxInfos.length;s++){var l=this.OpMeasure.boxInfos[s];if(l.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){l.textPos=i.textPos;break}}for(s=0;s<this.OpMeasure.textLines.length;s++){var d=this.OpMeasure.textLines[s];if(d.uuid==this.OpMeasure.unsteadyuuid){d.start=i.textPos.clone(),d.end=i.midPos.clone();break}}this.OpMeasure.viewer.render()};function Je(e){Xe.call(this,e),this.measureClass="Face"}(Je.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"faceArea":ye.isMobileDevice()||this.OpMeasure.PostInfo(NDS.INFOTYPE.FACE);break;case"facePerimeter":this.OpMeasure.PostInfo(NDS.INFOTYPE.FACE)}},Je.prototype.onNMouseMove=function(e,t){switch(this.measureType){case"faceArea":this.measurefaceAreaAndPerimeter(e,t,!0);break;case"facePerimeter":this.measurefaceAreaAndPerimeter(e,t,!0,!1,!0)}},Je.prototype.onLMouseClick=function(e,t,n){switch(this.measureType){case"faceArea":this.measurefaceAreaAndPerimeter(e,t,!1,n);break;case"facePerimeter":this.measurefaceAreaAndPerimeter(e,t,!1,n,!0)}},Je.prototype.renderMeasureScene=function(){this.update2DScene();for(var e=0,t=this.perimeterInfos.length;e<t;e++){var n=this.perimeterInfos[e];this.viewer.container.removeChild(n.textimg);var i=this.get2dPoint(n.textPos.clone()),i=this.addAnnotationTip(n.dimString,i.x,i.y);i&&this.viewer.container.appendChild(i),n.textimg=i}},Je.prototype.measurefaceAreaAndPerimeter=function(e,t,n,i,r){var o=this.viewer;o.renderer.domElement,o.renderer.getPixelRatio();if(!(r&&null!=i&&1==i||this.viewer.brepManager.veriosn<2&&r)){var a=this.doRaycasterPick(e,t,!1);if(a){for(var s=0;s<a.length;){var l,d=this.getSelectInfoFromIntersect(a[s]);if(d&&null!=d.area){if(1==n)this.isTwoTopolInfoTheSame(this.faceInfo.preSelFaceInfo,d)||(this.faceInfo.preSelFaceInfo=d,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null),this.faceInfo.preSelFaceObj=this.createFace(this.faceInfo.preSelFaceInfo,!0),this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.add(this.faceInfo.preSelFaceObj),this.viewer.outlinePass&&((l=[]).push(this.faceInfo.preSelFaceObj),this.viewer.outlinePass.tempSelectedObjects=l)));else{for(var c=!1,h=-1,u=0,f=this.faceInfo.selFaceInfors.length;u<f;u++)if(this.isTwoTopolInfoTheSame(this.faceInfo.selFaceInfors[u],d)){c=!0,h=u;break}if(null!=i&&1==i)c?(this.faceInfo.selFaceInfors.splice(h,1),this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[h]),this.faceInfo.selFaceObjs[h]=null,this.faceInfo.selFaceObjs.splice(h,1)):(this.faceInfo.selFaceInfors.push(d),(p=this.createFace(d,!1))&&(this.OpMeasure.rootObject.add(p),this.faceInfo.selFaceObjs.push(p))),r||(this.clearPerimetrBox(),g=(g=(g=this.getSelectedFaceArea())<1&&.999999<g?1:g)*(v=this.viewer.getDispalyModelUnit(g)).scale*v.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:g,modelUnit:v.unit}));else{for(var p,u=this.faceInfo.selFaceInfors.length=0,f=this.faceInfo.selFaceObjs.length;u<f;u++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[u]);this.faceInfo.selFaceObjs.length=0,c||(this.faceInfo.selFaceInfors.push(d),(p=this.createFace(d,!1))&&(this.OpMeasure.rootObject.add(p),this.faceInfo.selFaceObjs.push(p))),r?(this.clearPerimetrBox(),d.edgeInfos&&0<d.edgeInfos.array.length?this.createPerimetrBox(this.getLinePoint(d.edgeInfos.array,d.bodyUuid,d.matrixWorld)):this.createPerimetrBox(this.getedgePoint(d.edgeIDS,d.bodyUuid,d.matrixWorld))):(this.clearPerimetrBox(),g=(g=(g=this.getSelectedFaceArea())<1&&.999999<g?1:g)*(v=this.viewer.getDispalyModelUnit(g)).scale*v.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:g,modelUnit:v.unit}))}}return}s++}if(1==n&&this.faceInfo.preSelFaceInfo&&(this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null)),!n&&(null==i||0==i)){m=!1;0<this.faceInfo.selFaceInfors.length&&(m=!0);for(u=this.faceInfo.selFaceInfors.length=0,f=this.faceInfo.selFaceObjs.length;u<f;u++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[u]);this.faceInfo.selFaceObjs.length=0,m&&(r?(o.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeter:[]}),this.clearPerimetrBox()):(this.clearPerimetrBox(),g=(g=(g=this.getSelectedFaceArea())<1&&.999999<g?1:g)*(v=this.viewer.getDispalyModelUnit(g)).scale*v.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:g,modelUnit:v.unit})))}}else if(this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects.length=0),!n&&(null==i||0==i)){var m=!1;0<this.faceInfo.selFaceInfors.length&&(m=!0);for(var g,v,u=this.faceInfo.selFaceInfors.length=0,f=this.faceInfo.selFaceObjs.length;u<f;u++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[u]);this.faceInfo.selFaceObjs.length=0,m&&(r?(o.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]}),this.clearPerimetrBox()):(this.clearPerimetrBox(),g=(g=(g=this.getSelectedFaceArea())<1&&.999999<g?1:g)*(v=this.viewer.getDispalyModelUnit(g)).scale*v.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:g,modelUnit:v.unit})))}}},Je.prototype.getSelectedFacePerimeter=function(){for(var e=0,t=0,n=this.faceInfo.selFaceInfors.length;t<n;t++)e+=parseFloat(this.faceInfo.selFaceInfors[t].perimeter);return e},Je.prototype.createPerimetrBox=function(e){var t=[];if(0!=e.length){for(var n=this.viewer.getDispalyModelUnit(e[0].perimeter),i=0;i<e.length;i++){var r=e[i].perimeter,o=e[i].startPos;this.distanceInfo.unit=this.getUnitString();var a=i+1,s={},l=this.get2dPoint(o.clone()),l=this.addAnnotationTip(i+1,l.x,l.y);l&&this.viewer.container.appendChild(l),s.dimString=a,s.textPos=o.clone(),s.textimg=l,this.perimeterInfos.push(s),r*=n.scale,t[i]=r.toFixed(2)}this.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:t,modelUnit:n.unit}),ye.isMobileDevice()&&this.ChangeMeasureFlag(),this.OpMeasure.perimeterunit=n.unit,this.OpMeasure.perimeterBroadcast=t}},Je.prototype.getLinePoint=function(e,t,n){for(var i,r=[],o=null,a=0;a<e.length;++a){var s,l,d,c=e[a],h=this.viewer.brepManager.GetEdegMeshIDfromID(t,c.id),u=this.viewer.ndsModel.geomManager.getGeomFromUuid(this.viewer.ndsModel.meshUuid2GeomUuidMap[h],0),f=c.indexRange.concat();this.viewer.ndsModel&&(f[0]+=u.drawRange.start/2,f[1]+=u.drawRange.start/2),u.isBufferGeometry&&(d=u.index,s=u.attributes.position.array,null!=d&&(l=d.array,h=new THREE.Vector3,u=new THREE.Vector3,d=f[0],f=f[1],h.fromArray(s,3*l[2*d]),u.fromArray(s,3*l[2*f+1]),u.distanceTo(h)<1e-7&&(new THREE.Vector3).fromArray(s,3*l[2*(f-1)]),h.applyMatrix4(n),u.applyMatrix4(n),c={startPos:h,endPos:u,perimeter:c.length},r.push(c)))}for(var p=[],m=0;m<r.length;++m){for(var g=(o=r.shift()).perimeter,v=0;v<r.length;++v)i=r[v],o.startPos.distanceTo(i.endPos)<1e-7?(o.startPos.copy(i.startPos),r.splice(v,1),v=-1,g+=i.perimeter):o.endPos.distanceTo(i.startPos)<1e-7?(o.endPos.copy(i.endPos),r.splice(v,1),v=-1,g+=i.perimeter):o.endPos.distanceTo(i.endPos)<1e-7?(o.endPos.copy(i.startPos),r.splice(v,1),v=-1,g+=i.perimeter):o.startPos.distanceTo(i.startPos)<1e-7&&(o.startPos.copy(i.endPos),r.splice(v,1),v=-1,g+=i.perimeter);o.perimeter=g,p.push(o),m=-1}return p},Je.prototype.getedgePoint=function(e,t,n){for(var i=0;i<e.length;++i){var r=this.viewer.brepManager.GetEdgeInfoFromFace(t,e[i].startID).array[0];s=r.geomUUID?this.viewer.ndsModel.geomManager.getGeomFromUuid(r.geomUUID,0):(a=this.viewer.brepManager.GetEdegMeshIDfromID(t,e[i].startID),this.viewer.ndsModel.geomManager.getGeomFromUuid(this.viewer.ndsModel.meshUuid2GeomUuidMap[a],0));var o,a,s,l,d=r.indexRange.concat();this.viewer.ndsModel&&(d[0]+=s.drawRange.start/2,d[1]+=s.drawRange.start/2),s.isBufferGeometry&&(l=s.index,o=s.attributes.position.array,null!=l&&(a=l.array,r=new THREE.Vector3,s=new THREE.Vector3,l=d[0],d=d[1],r.fromArray(o,3*a[2*l]),s.fromArray(o,3*a[2*d+1]),s.distanceTo(r)<1e-7&&(new THREE.Vector3).fromArray(o,3*a[2*(d-1)]),r.applyMatrix4(n),s.applyMatrix4(n),e[i].startPos=r))}return e};function Ke(e){Xe.call(this,e),this.measureClass="Angle"}(Ke.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"bodyAngle":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRMEASUREBODY);break;case"LineAngle":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTLINE);break;case"LineFaceAngle":this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPLANE);break;case"faceAngle":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPLANE);break;case"angle":this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT)}},Ke.prototype.onNMouseMove=function(e,t){var n,i,r=new THREE.Vector3(e,t,0);if(this.OpMeasure.unsteady)this.changeLineAngle(r);else switch(this.measureType){case"bodyAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!ye.isMobileDevice()?this.lineAngleInfo.twoPlane?(i=this.viewer.clientCoordToModelCoord([e,t]),r.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(r)):this.createAndShowLineAngleDimension(r):(n=4<this.viewer.brepManager.version?["line","plane","cylinder","cone"]:["line","plane","cylinder"],this.measureBodyAngle(e,t,!0,n),this.updateBodyAngleScene("true"));break;case"LineAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!ye.isMobileDevice()?this.createAndShowLineAngleDimension(r):(this.measureLineAngle(e,t,!0,n=["line"]),this.updateLineAngleScene("true"));break;case"LineFaceAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!ye.isMobileDevice()?this.createAndShowLineAngleDimension(r):(n=[],this.lineAngleInfo.firstLineInfo||this.lineAngleInfo.secondLineInfo?"plane"==this.lineAngleInfo.firstLineInfo.type?n=["line"]:"line"==this.lineAngleInfo.firstLineInfo.type&&(n=["plane"]):n=["plane","line"],this.measureLineAngle(e,t,!0,n),this.updateLineAngleScene("true"));break;case"faceAngle":this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&!ye.isMobileDevice()?(i=this.viewer.clientCoordToModelCoord([e,t]),r.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(r)):(this.measurefaceAngle(e,t,!0),this.updateFaceAngleScene("true"));break;case"angle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!ye.isMobileDevice()?this.createAndShowLineAngleDimension(r):this.previewSnappedPoint(e,t,!0)}},Ke.prototype.onLMouseClick=function(e,t,n){var i,r,o=new THREE.Vector3(e,t,0);switch(this.measureType){case"bodyAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.lineAngleInfo.twoPlane?(r=this.viewer.clientCoordToModelCoord([e,t]),o.set(r[0],r[1],r[2]),this.createAndShowFaceAngleDimension(o,!0)):this.createAndShowLineAngleDimension(o,!0):this.lineAngleInfo.twoPlane?(r=this.viewer.clientCoordToModelCoord([e,t]),o.set(r[0],r[1],r[2]),this.createAndShow3DFaceAngleDimension(o,!0)):this.createAndShow3DLineAngleDimension(o,!0),this.OperatorStart(this.measureType)):(i=4<this.viewer.brepManager.version?["line","plane","cylinder","cone"]:["line","plane","cylinder"],this.measureBodyAngle(e,t,!1,i),this.updateBodyAngleScene("false"),this.viewer.is2DModel?this.lineAngleInfo.twoPlane?(r=this.viewer.clientCoordToModelCoord([e,t]),o.set(r[0],r[1],r[2]),this.createAndShowFaceAngleDimension(o,!1)):this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineObj&&!this.lineAngleInfo.secondLineObj&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECMEASUREBODY):this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.lineAngleInfo.firstLineObj||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRMEASUREBODY));break;case"LineAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!0):this.createAndShow3DLineAngleDimension(o,!0),this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTLINE)):(this.measureLineAngle(e,t,!1,i=["line"]),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineObj&&!this.lineAngleInfo.secondLineObj&&this.OpMeasure.InfoType!=NDS.INFOTYPE.LINEPARALLEL&&this.OpMeasure.InfoType!=NDS.INFOTYPE.PLANEPARALLELLINE&&this.OpMeasure.InfoType!=NDS.INFOTYPE.LINEPARALLELPLANE?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDLINE):this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):this.lineAngleInfo.firstLineObj||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTLINE));break;case"LineFaceAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.createAndShowLineAngleDimension(o,!0),this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPLANE)):(i=[],this.lineAngleInfo.firstLineInfo||this.lineAngleInfo.secondLineInfo?"plane"==this.lineAngleInfo.firstLineInfo.type?i=["line"]:"line"==this.lineAngleInfo.firstLineInfo.type&&(i=["plane"]):i=["plane","line"],this.measureLineAngle(e,t,!1,i),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineInfo&&"plane"==this.lineAngleInfo.firstLineInfo.type&&!this.lineAngleInfo.secondLineInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.LINE):this.lineAngleInfo.firstLineInfo&&"line"==this.lineAngleInfo.firstLineInfo.type&&!this.lineAngleInfo.secondLineInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.PLANE):this.lineAngleInfo.firstLineInfo&&this.lineAngleInfo.secondLineInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):!this.lineAngleInfo.firstLineInfo&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPLANE));break;case"faceAngle":this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?(r=this.viewer.clientCoordToModelCoord([e,t]),o.set(r[0],r[1],r[2]),this.createAndShowFaceAngleDimension(o,!0),this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPLANE)):(this.measurefaceAngle(e,t,!1),this.updateFaceAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.faceInfo.fstSelFaceObj&&!this.faceInfo.sndSelFaceObj&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDPLANE):this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?this.OpMeasure.PostInfo(NDS.INFOTYPE.ENDMEASURE):!this.faceInfo.fstSelFaceObj&&this.OpMeasure.InfoType<=NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPLANE));break;case"angle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!0):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo||this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT)):(this.AngleMeasure(e,t),this.lineAngleInfo.thrHelpPointInfo&&this.lineAngleInfo.firstHelpPointInfo&&this.lineAngleInfo.secHelpPointInfo&&(i=new THREE.Vector2(this.lineAngleInfo.firstHelpPointInfo.x-this.lineAngleInfo.secHelpPointInfo.x,this.lineAngleInfo.firstHelpPointInfo.y-this.lineAngleInfo.secHelpPointInfo.y),r=new THREE.Vector2(this.lineAngleInfo.thrHelpPointInfo.x-this.lineAngleInfo.secHelpPointInfo.x,this.lineAngleInfo.thrHelpPointInfo.y-this.lineAngleInfo.secHelpPointInfo.y),r=i.add(r).divideScalar(2),o.setX(this.lineAngleInfo.secHelpPointInfo.x+r.x),o.setY(this.lineAngleInfo.secHelpPointInfo.y+r.y)),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo?!this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo?this.lineAngleInfo.firstHelpPointInfo&&this.lineAngleInfo.secHelpPointInfo&&!this.lineAngleInfo.thrHelpPointInfo&&this.OpMeasure.PostInfo(NDS.INFOTYPE.THIRDPOINT):this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDPOINT):this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT))}},Ke.prototype.createAndShowLineAngleDimension=function(e,t){if(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj){var n=this.lineAngleInfo.firstLineInfo.start,i=(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start);i.normalize();var r=i.clone().negate(),o=this.lineAngleInfo.secondLineInfo.start,a=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start);a.normalize();var s=a.clone().negate();this.lineAngleInfo.arcCenter||(this.lineAngleInfo.arcCenter=this.getIntersectPointOfTwoLine(n,i,o,a),this.lineAngleInfo.fstClndPos=new THREE.Vector3,this.lineAngleInfo.sndClndPos=new THREE.Vector3);var l=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,i),n=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,a),o=new THREE.Plane;o.setFromCoplanarPoints(this.lineAngleInfo.arcCenter,l,n);l=this.clientCoordToModelCoordOnPlane(e.x,e.y,o);if(l){this.lineAngleInfo.textPos=l;n=(new THREE.Vector3).subVectors(this.lineAngleInfo.textPos,this.lineAngleInfo.arcCenter),e=n.length();n.normalize();o=i,l=a;this.isBetweenTwoVectors(n,i,a)?(o=i,l=a):this.isBetweenTwoVectors(n,i,s)?(o=i,l=s):this.isBetweenTwoVectors(n,r,a)?(o=r,l=a):this.isBetweenTwoVectors(n,r,s)&&(o=r,l=s);n=(n=o.angleTo(l))/Math.PI*180;this.lineAngleInfo.dimString=n.toFixed(2),this.lineAngleInfo.fstClndPos.addVectors(this.lineAngleInfo.arcCenter,o.clone().multiplyScalar(e)),this.lineAngleInfo.sndClndPos.addVectors(this.lineAngleInfo.arcCenter,l.clone().multiplyScalar(e));for(var d=0;d<this.lineAngleInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.remove(this.lineAngleInfo.arcMeshes[d]),this.lineAngleInfo.arcMeshes[d]=null;if(this.lineAngleInfo.arcMeshes=this.createAngleArcMeshes2(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcCenter,this.lineAngleInfo.sndClndPos,this.ARCWIDTH),0!=this.lineAngleInfo.arcMeshes.length){for(d=0;d<this.lineAngleInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.add(this.lineAngleInfo.arcMeshes[d]);this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.fstClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[1].geometry.vertices[0],this.lineAngleInfo.fstClndPos,this.materialLine);o=(new THREE.Vector3).subVectors(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcMeshes[1].geometry.vertices[0]);o.normalize();l=this.OpMeasure.getScale(this.lineAngleInfo.fstClnd,this.CYLINDERWIDTH);o.multiplyScalar(.5*this.lineAngleInfo.fstClnd.geometry.parameters.height),this.lineAngleInfo.fstClnd.oldPosition=this.lineAngleInfo.fstClndPos.clone(),this.lineAngleInfo.fstClnd.offsetPos=o.clone().multiplyScalar(-1),this.lineAngleInfo.fstClnd.position.subVectors(this.lineAngleInfo.fstClndPos,o.clone().multiplyScalar(l)),this.OpMeasure.rootObject.add(this.lineAngleInfo.fstClnd),this.lineAngleInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.sndClnd),this.lineAngleInfo.sndClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0],this.lineAngleInfo.sndClndPos,this.materialLine);e=(new THREE.Vector3).subVectors(this.lineAngleInfo.sndClndPos,this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0]);e.normalize();l=this.OpMeasure.getScale(this.lineAngleInfo.sndClnd,this.CYLINDERWIDTH);e.multiplyScalar(.5*this.lineAngleInfo.sndClnd.geometry.parameters.height),this.lineAngleInfo.sndClnd.oldPosition=this.lineAngleInfo.sndClndPos.clone(),this.lineAngleInfo.sndClnd.offsetPos=e.clone().multiplyScalar(-1),this.lineAngleInfo.sndClnd.position.subVectors(this.lineAngleInfo.sndClndPos,e.clone().multiplyScalar(l)),this.OpMeasure.rootObject.add(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine1=null);var c,o=this.lineAngleInfo.firstLineInfo.start.distanceTo(this.lineAngleInfo.firstLineInfo.end),e=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.start),l=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.end);this.isZero(e+l-o)||(h=l<e?(c=this.lineAngleInfo.firstLineInfo.end,(new THREE.Vector3).addVectors(c,i.clone().multiplyScalar(1.3*l))):(c=this.lineAngleInfo.firstLineInfo.start,(new THREE.Vector3).addVectors(c,r.clone().multiplyScalar(1.3*e))),this.lineAngleInfo.auxLine1=this.createLineMesh2(c,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.lineAngleInfo.auxLine1)),this.lineAngleInfo.auxLine2&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine2),this.lineAngleInfo.auxLine2=null),o=this.lineAngleInfo.secondLineInfo.start.distanceTo(this.lineAngleInfo.secondLineInfo.end),e=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.start),l=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.end),this.isZero(e+l-o)||(h=l<e?(c=this.lineAngleInfo.secondLineInfo.end,(new THREE.Vector3).addVectors(c,a.clone().multiplyScalar(1.3*l))):(c=this.lineAngleInfo.secondLineInfo.start,(new THREE.Vector3).addVectors(c,s.clone().multiplyScalar(1.3*e))),this.lineAngleInfo.auxLine2=this.createLineMesh2(c,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.lineAngleInfo.auxLine2));var h=this.lineAngleInfo.dimString+this.lineAngleInfo.unit;this.lineAngleInfo.textBox||(this.lineAngleInfo.textBox=document.createElement("div"),this.lineAngleInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.lineAngleInfo.textBox)),this.getAndShowTextBox(this.lineAngleInfo.textPos.clone(),h,this.lineAngleInfo.textBox),t&&((t={}).dimString=h,t.textPos=this.lineAngleInfo.textPos.clone(),t.textBox=this.lineAngleInfo.textBox,t.textBox.setAttribute("type","angle"),t.textBox.setAttribute("dimString",this.lineAngleInfo.dimString),t.textBox.setAttribute("unit",this.lineAngleInfo.unit),this.OpMeasure.boxInfos.push(t),this.clearLineAngleInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes())}}}},Ke.prototype.createAndShow3DLineAngleDimension=function(e,t){if(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj||this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect){var n=this.lineAngleInfo.firstLineInfo.start,i=(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start);i.normalize();var r=i.clone().negate(),o=this.lineAngleInfo.secondLineInfo.start,a=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start);a.normalize();var s=a.clone().negate();this.lineAngleInfo.arcCenter||(this.lineAngleInfo.arcCenter=this.getIntersectPointOfTwoLine(n,i,o,a),this.lineAngleInfo.fstClndPos=new THREE.Vector3,this.lineAngleInfo.sndClndPos=new THREE.Vector3);var l=(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start),d=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start),n=.8*Math.max(Math.min(l.length(),d.length()),.1),o=(new THREE.Vector3).addVectors(i,a);o.normalize(),this.lineAngleInfo.textPos=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,o.clone().multiplyScalar(n));l=(new THREE.Vector3).subVectors(this.lineAngleInfo.textPos,this.lineAngleInfo.arcCenter),d=l.length();l.normalize();o=i,n=a;this.isBetweenTwoVectors(l,i,a)?(o=i,n=a):this.isBetweenTwoVectors(l,i,s)?(o=i,n=s):this.isBetweenTwoVectors(l,r,a)?(o=r,n=a):this.isBetweenTwoVectors(l,r,s)&&(o=r,n=s);l=(l=o.angleTo(n))/Math.PI*180;if(this.lineAngleInfo.dimString=l.toFixed(2),this.lineAngleInfo.fstClndPos.addVectors(this.lineAngleInfo.arcCenter,o.clone().multiplyScalar(d)),this.lineAngleInfo.sndClndPos.addVectors(this.lineAngleInfo.arcCenter,n.clone().multiplyScalar(d)),this.lineAngleInfo.arcMeshes=this.createAngleArcMeshes2(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcCenter,this.lineAngleInfo.sndClndPos,this.ARCWIDTH,this.appmaterialLine),0!=this.lineAngleInfo.arcMeshes.length){this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.fstClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[1].geometry.vertices[0],this.lineAngleInfo.fstClndPos,this.appmaterialLine);o=(new THREE.Vector3).subVectors(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcMeshes[1].geometry.vertices[0]);o.normalize();n=this.OpMeasure.getScale(this.lineAngleInfo.fstClnd,this.CYLINDERWIDTH);o.multiplyScalar(.5*this.lineAngleInfo.fstClnd.geometry.parameters.height),this.lineAngleInfo.fstClnd.oldPosition=this.lineAngleInfo.fstClndPos.clone(),this.lineAngleInfo.fstClnd.offsetPos=o.clone().multiplyScalar(-1),this.lineAngleInfo.fstClnd.position.subVectors(this.lineAngleInfo.fstClndPos,o.clone().multiplyScalar(n)),this.lineAngleInfo.sndClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0],this.lineAngleInfo.sndClndPos,this.appmaterialLine);d=(new THREE.Vector3).subVectors(this.lineAngleInfo.sndClndPos,this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0]);d.normalize();n=this.OpMeasure.getScale(this.lineAngleInfo.sndClnd,this.CYLINDERWIDTH);d.multiplyScalar(.5*this.lineAngleInfo.sndClnd.geometry.parameters.height),this.lineAngleInfo.sndClnd.oldPosition=this.lineAngleInfo.sndClndPos.clone(),this.lineAngleInfo.sndClnd.offsetPos=d.clone().multiplyScalar(-1),this.lineAngleInfo.sndClnd.position.subVectors(this.lineAngleInfo.sndClndPos,d.clone().multiplyScalar(n));o=this.lineAngleInfo.firstLineInfo.start.distanceTo(this.lineAngleInfo.firstLineInfo.end),d=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.start),n=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.end);this.isZero(d+n-o)||(h=n<d?(c=this.lineAngleInfo.firstLineInfo.end,(new THREE.Vector3).addVectors(c,i.clone().multiplyScalar(1.3*n))):(c=this.lineAngleInfo.firstLineInfo.start,(new THREE.Vector3).addVectors(c,r.clone().multiplyScalar(1.3*d))),this.lineAngleInfo.auxLine1=this.createLineMesh2(c,h,this.appmaterialLine,1)),o=this.lineAngleInfo.secondLineInfo.start.distanceTo(this.lineAngleInfo.secondLineInfo.end),d=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.start),n=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.end),this.isZero(d+n-o)||(h=n<d?(c=this.lineAngleInfo.secondLineInfo.end,(new THREE.Vector3).addVectors(c,a.clone().multiplyScalar(1.3*n))):(c=this.lineAngleInfo.secondLineInfo.start,(new THREE.Vector3).addVectors(c,s.clone().multiplyScalar(1.3*d))),this.lineAngleInfo.auxLine2=this.createLineMesh2(c,h,this.appmaterialLine,1));var c=this.lineAngleInfo.dimString+this.lineAngleInfo.unit,h=null;if(this.lineAngleInfo.textBox||(this.lineAngleInfo.textBox=document.createElement("div"),this.lineAngleInfo.textBox.className="section10",this.lineAngleInfo.textBox.innerHTML=c,(u=document.createElement("div")).className="sectionPoint",this.lineAngleInfo.textBox.appendChild(u),(h=document.createElement("div")).className="sectionCross",this.lineAngleInfo.textBox.appendChild(h),this.viewer.container.appendChild(this.lineAngleInfo.textBox)),t){var u={};u.dimString=c,u.textPos=this.lineAngleInfo.textPos.clone(),u.textBox=this.lineAngleInfo.textBox;var t=new THREE.Group,f=new THREE.Group;t.objectType="Group",f.objectType="Group",f.name="unsteady";for(var p=0;p<this.lineAngleInfo.arcMeshes.length;p++)f.add(this.lineAngleInfo.arcMeshes[p]);f.add(this.lineAngleInfo.fstClnd),f.add(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&f.add(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine2&&f.add(this.lineAngleInfo.auxLine2),t.add(f),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.OpMeasure.rootObject.remove(this.lineAngleInfo.secondLineObj),t.add(this.lineAngleInfo.firstLineObj),t.add(this.lineAngleInfo.secondLineObj)),this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),t.add(this.faceInfo.sndSelFaceObj),t.add(this.faceInfo.fstSelFaceObj)),this.OpMeasure.rootObject.add(t),ye.isMobileDevice()?(u.textBox.addEventListener("touchstart",this.touchstart,!1),u.textBox.addEventListener("touchend",this.touchend,!1),u.textBox.addEventListener("touchmove",this.touchmove,!1)):(u.textBox.addEventListener("mousedown",this.touchstart,!1),u.textBox.addEventListener("mouseup",this.touchend,!1),u.textBox.addEventListener("mousemove",this.touchmove,!1),u.textBox.addEventListener("mouseleave",this.mouseleave,!1),u.textBox.addEventListener("mouseenter",this.mouseenter,!1)),ye.isMobileDevice()?h.addEventListener("touchend",this.sectionCrossend,!1):(h.addEventListener("mousedown",this.sectionCrossend,!1),h.addEventListener("mouseleave",this.crossleave,!1),h.addEventListener("mouseenter",this.crossenter,!1)),u.textBox.setAttribute("mobile","up"),u.textBox.setAttribute("group",t.uuid),u.textBox.setAttribute("type","angle"),u.textBox.setAttribute("dimString",this.lineAngleInfo.dimString),u.textBox.setAttribute("unit",this.lineAngleInfo.unit),this.OpMeasure.unsteadyData[t.uuid]=this.DeepCopy(this.lineAngleInfo),this.getAndShowTextBox(this.lineAngleInfo.textPos.clone(),c,this.lineAngleInfo.textBox),this.OpMeasure.boxInfos.push(u),this.clearLineAngleInfo(!0),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&this.clearFaceInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes()}}}},Ke.prototype.createMeasureScene=function(){if(null!=this.dimensionObject&&(this.scene.remove(this.dimensionObject),this.dimensionObject=null),"angle"==this.measureType){if(this.firstSprite&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),(e=this.createPointMesh(this.firstSprite,this.materialPoint,this.POINTSIZE)).objectType="Point",this.dimensionObject.add(e)),this.secondSprite&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),(e=this.createPointMesh(this.secondSprite,this.materialPoint,this.POINTSIZE)).objectType="Point",this.dimensionObject.add(e)),this.lastMeasure&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),"angle"==this.measureType)){var e=this.createLineMesh2(this.lastMeasure.first,this.lastMeasure.second,this.materialLine,this.LINEWIDTH);e.objectType="Line",this.dimensionObject.add(e);e=this.createLineMesh2(this.lastMeasure.third,this.lastMeasure.second,this.materialLine,this.LINEWIDTH);e.objectType="Line",this.dimensionObject.add(e);for(var t=this.createAngleArcMeshes(this.lastMeasure.first,this.lastMeasure.second,this.lastMeasure.third,this.ARCWIDTH,this.midPoint),n=0;n<t.length;n++)t[n].objectType="Arc",this.dimensionObject.add(t[n]);e=this.createPointMesh(this.lastMeasure.first,this.materialPoint,this.POINTSIZE);e.objectType="Point",this.dimensionObject.add(e);e=this.createPointMesh(this.lastMeasure.second,this.materialPoint,this.POINTSIZE);e.objectType="Point",this.dimensionObject.add(e);e=this.createPointMesh(this.lastMeasure.third,this.materialPoint,this.POINTSIZE);e.objectType="Point",this.dimensionObject.add(e)}null!=this.dimensionObject&&this.scene.add(this.dimensionObject)}},Ke.prototype.AngleMeasure=function(e,t){var n;if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit="°"),null!=this.snappedPoint)n=this.snappedPoint;else{var i=this.getIntersectsByPriorityOfLine(e,t);if(i&&0<i.length)for(var r=0;r<i.length;){if(null!=(this.viewer.ndsModel?i[r].object:this.FindParentElement(i[r].object))){n=i[r].point.clone();break}r++}}n&&(null==this.lineAngleInfo.firstHelpPointInfo?this.lineAngleInfo.firstHelpPointInfo={type:"point",point:n.clone(),x:e,y:t}:null==this.lineAngleInfo.secHelpPointInfo?(this.lineAngleInfo.secHelpPointInfo={type:"point",point:n.clone(),x:e,y:t},this.lineAngleInfo.firstLineInfo={type:"helpline",start:this.lineAngleInfo.secHelpPointInfo.point.clone(),end:this.lineAngleInfo.firstHelpPointInfo.point.clone()}):null==this.lineAngleInfo.thrHelpPointInfo&&(this.lineAngleInfo.thrHelpPointInfo={type:"point",point:n.clone(),x:e,y:t},this.lineAngleInfo.secondLineInfo={type:"helpline",start:this.lineAngleInfo.secHelpPointInfo.point.clone(),end:this.lineAngleInfo.thrHelpPointInfo.point.clone()}))},Ke.prototype.changeLineAngle=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n),(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],r=i.firstLineInfo.start,o=(new THREE.Vector3).subVectors(i.firstLineInfo.end,i.firstLineInfo.start);o.normalize();var a=o.clone().negate(),s=i.secondLineInfo.start,l=(new THREE.Vector3).subVectors(i.secondLineInfo.end,i.secondLineInfo.start);l.normalize();var d=l.clone().negate();i.arcCenter||(i.arcCenter=this.getIntersectPointOfTwoLine(r,o,s,l),i.fstClndPos=new THREE.Vector3,i.sndClndPos=new THREE.Vector3);var c=(new THREE.Vector3).addVectors(i.arcCenter,o),h=(new THREE.Vector3).addVectors(i.arcCenter,l),u=new THREE.Plane,f=null,p=null;u.setFromCoplanarPoints(i.arcCenter,c,h),u.normal.length()<1e-8&&(u.setFromCoplanarPoints(i.arcCenter.clone().add(new THREE.Vector3(1,-1,1)),c,h),f=new THREE.Vector3,p=new THREE.Vector3);t=this.clientCoordToModelCoordOnPlane(e.x,e.y,u);if(t){i.textPos=t;r=(new THREE.Vector3).subVectors(i.textPos,i.arcCenter),s=r.length();r.normalize();c=o,h=l;this.isBetweenTwoVectors(r,o,l)?(c=o,h=l):this.isBetweenTwoVectors(r,o,d)?(c=o,h=d):this.isBetweenTwoVectors(r,a,l)?(c=a,h=l):this.isBetweenTwoVectors(r,a,d)&&(c=a,h=d);e=(e=c.angleTo(h))/Math.PI*180;if(i.dimString=e.toFixed(2),i.fstClndPos.addVectors(i.arcCenter,c.clone().multiplyScalar(s)),i.sndClndPos.addVectors(i.arcCenter,h.clone().multiplyScalar(s)),null!=f&&(u=new THREE.Vector3,r=new THREE.Vector3,u.subVectors(i.fstClndPos,i.arcCenter),r.subVectors(t,i.arcCenter),f.crossVectors(u,r),f.normalize(),p.subVectors(t,i.arcCenter),p.normalize().negate()),(p=(new THREE.Vector3).addVectors(o,l)).normalize(),i.arcMeshes=this.createAngleArcMeshesWithAngle(i.arcCenter,c,h,s,e,this.ARCWIDTH,this.appmaterialLine),0!=i.arcMeshes.length){for(var m=0;m<i.arcMeshes.length;m++)n.add(i.arcMeshes[m]);h=i.arcMeshes[1].geometry.vertices[0],s=i.arcMeshes[i.arcMeshes.length-2].geometry.vertices[0];i.fstClnd=this.createCylinderMesh(h,i.fstClndPos,this.appmaterialLine);e=(new THREE.Vector3).subVectors(i.fstClndPos,h);e.normalize();h=this.OpMeasure.getScale(i.fstClnd,this.CYLINDERWIDTH);e.multiplyScalar(.5*i.fstClnd.geometry.parameters.height),i.fstClnd.oldPosition=i.fstClndPos.clone(),i.fstClnd.offsetPos=e.clone().multiplyScalar(-1),i.fstClnd.position.subVectors(i.fstClndPos,e.clone().multiplyScalar(h)),n.add(i.fstClnd),i.sndClnd=this.createCylinderMesh(s,i.sndClndPos,this.appmaterialLine);e=(new THREE.Vector3).subVectors(i.sndClndPos,s);e.normalize();h=this.OpMeasure.getScale(i.sndClnd,this.CYLINDERWIDTH);e.multiplyScalar(.5*i.sndClnd.geometry.parameters.height),i.sndClnd.oldPosition=i.sndClndPos.clone(),i.sndClnd.offsetPos=e.clone().multiplyScalar(-1),i.sndClnd.position.subVectors(i.sndClndPos,e.clone().multiplyScalar(h)),n.add(i.sndClnd);var g,v,s=i.firstLineInfo.start.distanceTo(i.firstLineInfo.end),e=i.fstClndPos.distanceTo(i.firstLineInfo.start),h=i.fstClndPos.distanceTo(i.firstLineInfo.end);this.isZero(e+h-s)||(v=h<e?(g=i.firstLineInfo.end,(new THREE.Vector3).addVectors(g,o.clone().multiplyScalar(1.3*h))):(g=i.firstLineInfo.start,(new THREE.Vector3).addVectors(g,a.clone().multiplyScalar(1.3*e))),i.auxLine1=this.createLineMesh2(g,v,this.appmaterialLine,1),n.add(i.auxLine1)),s=i.secondLineInfo.start.distanceTo(i.secondLineInfo.end),e=i.sndClndPos.distanceTo(i.secondLineInfo.start),h=i.sndClndPos.distanceTo(i.secondLineInfo.end),this.isZero(e+h-s)||(v=h<e?(g=i.secondLineInfo.end,(new THREE.Vector3).addVectors(g,l.clone().multiplyScalar(1.3*h))):(g=i.secondLineInfo.start,(new THREE.Vector3).addVectors(g,d.clone().multiplyScalar(1.3*e))),i.auxLine2=this.createLineMesh2(g,v,this.appmaterialLine,1),n.add(i.auxLine2));for(var y=i.dimString+i.unit,E=0;E<this.OpMeasure.boxInfos.length;E++){var b=this.OpMeasure.boxInfos[E];if(b.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){b.textPos=i.textPos,b.dimString=y;break}}this.OpMeasure.viewer.render()}}},Ke.prototype.createAndShowFaceAngleDimension=function(e,t){if(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&("faceAngle"===this.measureType||"bodyAngle"===this.measureType)){var n=this.faceInfo.fstIntersect,i=this.faceInfo.sndIntersect;if(this.faceInfo.arcCenter){if(!this.faceInfo.fstClnd||!this.faceInfo.sndClnd)return}else{var r=(new THREE.Vector3).subVectors(i,n),o=this.faceInfo.firstFaceInfo.worldNormal.clone(),a=this.faceInfo.secondFaceInfo.worldNormal.clone();o.normalize(),a.normalize();var s=new THREE.Vector3,l=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(n,o,i,a,s,l))return;var l=s.clone().add(l.clone().multiplyScalar(10));this.faceInfo.arcCenter=this.getProjectPntToLine(s,l,i);s=r.dot(o),l=(new THREE.Vector3).subVectors(i,o.clone().multiplyScalar(s)),s=(new THREE.Vector3).crossVectors(o,a),a=n.clone().add(s.multiplyScalar(2));this.faceInfo.midLineEndPt=this.getProjectPntToLine(n,a,l);s=this.faceInfo.arcCenter.distanceTo(l),a=i.distanceTo(l),l=Math.min(s,a);this.isZero(l)&&(l=.001);s=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),a=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter);s.normalize(),a.normalize(),this.faceInfo.sndClndPos=(new THREE.Vector3).addVectors(i,a.multiplyScalar(l));l=this.faceInfo.arcCenter.distanceTo(this.faceInfo.sndClndPos);this.faceInfo.fstClndPos=(new THREE.Vector3).addVectors(this.faceInfo.arcCenter,s.multiplyScalar(l));s=(s=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos))/Math.PI*180;this.faceInfo.dimString=s.toFixed(2)}this.faceInfo.textPos?(!e||(e=this.getProjectPntToPlane(this.faceInfo.arcCenter,this.faceInfo.fstClndPos,this.faceInfo.sndClndPos,e))&&this.faceInfo.textPos.copy(e),r=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),o=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),r.normalize(),o.normalize(),l=this.faceInfo.arcCenter.distanceTo(this.faceInfo.textPos),this.faceInfo.fstClndPos.addVectors(this.faceInfo.arcCenter,r.multiplyScalar(l)),this.faceInfo.sndClndPos.addVectors(this.faceInfo.arcCenter,o.multiplyScalar(l))):this.faceInfo.textPos=this.faceInfo.sndClndPos.clone(),this.faceInfo.fstToMidLine||(this.faceInfo.fstToMidLine=this.createLineMesh2(n,this.faceInfo.midLineEndPt,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.fstToMidLine)),this.faceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToClndLine),this.faceInfo.fstToClndLine=this.createLineMesh2(this.faceInfo.midLineEndPt,this.faceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.fstToClndLine),this.faceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.sndToClndLine),this.faceInfo.sndToClndLine=this.createLineMesh2(i,this.faceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.sndToClndLine);for(var d=0;d<this.faceInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.remove(this.faceInfo.arcMeshes[d]),this.faceInfo.arcMeshes[d]=null;this.faceInfo.arcMeshes=this.createAngleArcMeshes2(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos,this.ARCWIDTH);for(d=0;d<this.faceInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.add(this.faceInfo.arcMeshes[d]);this.faceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.fstClnd),this.faceInfo.fstClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[1].geometry.vertices[0],this.faceInfo.fstClndPos,this.materialLine);l=(new THREE.Vector3).subVectors(this.faceInfo.fstClndPos,this.faceInfo.arcMeshes[1].geometry.vertices[0]);l.normalize();n=this.OpMeasure.getScale(this.faceInfo.fstClnd,this.CYLINDERWIDTH);l.multiplyScalar(.5*this.faceInfo.fstClnd.geometry.parameters.height),this.faceInfo.fstClnd.oldPosition=this.faceInfo.fstClndPos.clone(),this.faceInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.faceInfo.fstClnd.position.subVectors(this.faceInfo.fstClndPos,l.clone().multiplyScalar(n)),this.OpMeasure.rootObject.add(this.faceInfo.fstClnd),this.faceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.sndClnd),this.faceInfo.sndClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0],this.faceInfo.sndClndPos,this.materialLine);i=(new THREE.Vector3).subVectors(this.faceInfo.sndClndPos,this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0]);i.normalize();n=this.OpMeasure.getScale(this.faceInfo.sndClnd,this.CYLINDERWIDTH);i.multiplyScalar(.5*this.faceInfo.sndClnd.geometry.parameters.height),this.faceInfo.sndClnd.oldPosition=this.faceInfo.sndClndPos.clone(),this.faceInfo.sndClnd.offsetPos=i.clone().multiplyScalar(-1),this.faceInfo.sndClnd.position.subVectors(this.faceInfo.sndClndPos,i.clone().multiplyScalar(n)),this.OpMeasure.rootObject.add(this.faceInfo.sndClnd);l=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.textPos),i=this.getAngle(this.faceInfo.textPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),n=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),i=Math.abs(l+i-n)<.01,n=this.faceInfo.dimString+this.faceInfo.unit;this.faceInfo.textBox||(this.faceInfo.textBox=document.createElement("div"),this.faceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.faceInfo.textBox)),this.getAndShowTextBox(this.faceInfo.textPos.clone(),n,this.faceInfo.textBox),this.faceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.boxToClndLine),i||(i=this.faceInfo.sndClndPos,this.faceInfo.textPos.distanceToSquared(this.faceInfo.fstClndPos)<this.faceInfo.textPos.distanceToSquared(this.faceInfo.sndClndPos)&&(i=this.faceInfo.fstClndPos),this.faceInfo.boxToClndLine=this.createLineMesh2(i,this.faceInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.boxToClndLine)),t&&((t={}).dimString=n,t.textPos=this.faceInfo.textPos.clone(),t.textBox=this.faceInfo.textBox,this.OpMeasure.boxInfos.push(t),this.clearFaceInfo(!0),this.lineAngleInfo.twoPlane&&this.clearLineAngleInfo(!0),this.ChangeMeasureFlag())}},Ke.prototype.createAndShow3DFaceAngleDimension=function(e,t){if(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&("faceAngle"===this.measureType||"bodyAngle"===this.measureType)){var n=this.faceInfo.fstIntersect,i=this.faceInfo.sndIntersect;if(this.faceInfo.arcCenter){if(!this.faceInfo.fstClnd||!this.faceInfo.sndClnd)return}else{var r=(new THREE.Vector3).subVectors(i,n),o=this.faceInfo.firstFaceInfo.worldNormal.clone(),a=this.faceInfo.secondFaceInfo.worldNormal.clone();o.normalize(),a.normalize();var s=new THREE.Vector3,l=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(n,o,i,a,s,l))return;var l=s.clone().add(l.clone().multiplyScalar(10));this.faceInfo.arcCenter=this.getProjectPntToLine(s,l,i);s=r.dot(o),l=(new THREE.Vector3).subVectors(i,o.clone().multiplyScalar(s)),s=(new THREE.Vector3).crossVectors(o,a),a=n.clone().add(s.multiplyScalar(2));this.faceInfo.midLineEndPt=this.getProjectPntToLine(n,a,l);s=this.faceInfo.arcCenter.distanceTo(l),a=i.distanceTo(l),l=Math.min(s,a);this.isZero(l)&&(l=.001);s=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),a=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter);s.normalize(),a.normalize(),this.faceInfo.sndClndPos=(new THREE.Vector3).addVectors(i,a.multiplyScalar(l));l=this.faceInfo.arcCenter.distanceTo(this.faceInfo.sndClndPos);this.faceInfo.fstClndPos=(new THREE.Vector3).addVectors(this.faceInfo.arcCenter,s.multiplyScalar(l));s=(s=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos))/Math.PI*180;this.faceInfo.dimString=s.toFixed(2)}this.faceInfo.textPos?(!e||(e=this.getProjectPntToPlane(this.faceInfo.arcCenter,this.faceInfo.fstClndPos,this.faceInfo.sndClndPos,e))&&this.faceInfo.textPos.copy(e),r=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),o=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),r.normalize(),o.normalize(),l=this.faceInfo.arcCenter.distanceTo(this.faceInfo.textPos),this.faceInfo.fstClndPos.addVectors(this.faceInfo.arcCenter,r.multiplyScalar(l)),this.faceInfo.sndClndPos.addVectors(this.faceInfo.arcCenter,o.multiplyScalar(l))):this.faceInfo.textPos=this.faceInfo.sndClndPos.clone(),this.faceInfo.fstToMidLine=this.createLineMesh2(n,this.faceInfo.midLineEndPt,this.appmaterialLine,1),this.faceInfo.fstToClndLine=this.createLineMesh2(this.faceInfo.midLineEndPt,this.faceInfo.fstClndPos,this.appmaterialLine,1),this.faceInfo.sndToClndLine=this.createLineMesh2(i,this.faceInfo.sndClndPos,this.appmaterialLine,1),this.faceInfo.arcMeshes=this.createAngleArcMeshes2(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos,this.ARCWIDTH,this.appmaterialLine),this.faceInfo.fstClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[1].geometry.vertices[0],this.faceInfo.fstClndPos,this.appmaterialLine);l=(new THREE.Vector3).subVectors(this.faceInfo.fstClndPos,this.faceInfo.arcMeshes[1].geometry.vertices[0]);l.normalize();n=this.OpMeasure.getScale(this.faceInfo.fstClnd,this.CYLINDERWIDTH);l.multiplyScalar(.5*this.faceInfo.fstClnd.geometry.parameters.height),this.faceInfo.fstClnd.oldPosition=this.faceInfo.fstClndPos.clone(),this.faceInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.faceInfo.fstClnd.position.subVectors(this.faceInfo.fstClndPos,l.clone().multiplyScalar(n)),this.faceInfo.sndClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0],this.faceInfo.sndClndPos,this.appmaterialLine);i=(new THREE.Vector3).subVectors(this.faceInfo.sndClndPos,this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0]);i.normalize();n=this.OpMeasure.getScale(this.faceInfo.sndClnd,this.CYLINDERWIDTH);i.multiplyScalar(.5*this.faceInfo.sndClnd.geometry.parameters.height),this.faceInfo.sndClnd.oldPosition=this.faceInfo.sndClndPos.clone(),this.faceInfo.sndClnd.offsetPos=i.clone().multiplyScalar(-1),this.faceInfo.sndClnd.position.subVectors(this.faceInfo.sndClndPos,i.clone().multiplyScalar(n));l=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.textPos),i=this.getAngle(this.faceInfo.textPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),n=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),l=Math.abs(l+i-n)<.01,i=this.faceInfo.dimString+this.faceInfo.unit;this.faceInfo.textBox=document.createElement("div"),this.faceInfo.textBox.className="section10",this.faceInfo.textBox.innerHTML=i;n=document.createElement("div");n.className="sectionPoint",this.faceInfo.textBox.appendChild(n);n=document.createElement("div");if(n.className="sectionCross",this.faceInfo.textBox.appendChild(n),this.viewer.container.appendChild(this.faceInfo.textBox),l||(l=this.faceInfo.sndClndPos,this.faceInfo.textPos.distanceToSquared(this.faceInfo.fstClndPos)<this.faceInfo.textPos.distanceToSquared(this.faceInfo.sndClndPos)&&(l=this.faceInfo.fstClndPos),this.faceInfo.boxToClndLine=this.createLineMesh2(l,this.faceInfo.textPos,this.appmaterialLine,1)),t){t={};t.dimString=i,t.textPos=this.faceInfo.textPos.clone(),t.textBox=this.faceInfo.textBox;var i=new THREE.Group,d=new THREE.Group;i.objectType="Group",d.objectType="Group",d.name="unsteady",d.add(this.faceInfo.fstToMidLine),d.add(this.faceInfo.fstToClndLine),d.add(this.faceInfo.sndToClndLine);for(var c=0;c<this.faceInfo.arcMeshes.length;c++)d.add(this.faceInfo.arcMeshes[c]);d.add(this.faceInfo.fstClnd),d.add(this.faceInfo.sndClnd),this.faceInfo.boxToClndLine&&d.add(this.faceInfo.boxToClndLine),i.add(d),this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),i.add(this.faceInfo.fstSelFaceObj),i.add(this.faceInfo.sndSelFaceObj),this.OpMeasure.rootObject.add(i),ye.isMobileDevice()?(t.textBox.addEventListener("touchstart",this.touchstart,!1),t.textBox.addEventListener("touchend",this.touchend,!1),t.textBox.addEventListener("touchmove",this.touchmove,!1)):(t.textBox.addEventListener("mousedown",this.touchstart,!1),t.textBox.addEventListener("mouseup",this.touchend,!1),t.textBox.addEventListener("mousemove",this.touchmove,!1),t.textBox.addEventListener("mouseleave",this.mouseleave,!1),t.textBox.addEventListener("mouseenter",this.mouseenter,!1)),ye.isMobileDevice()?n.addEventListener("touchend",this.sectionCrossend,!1):(n.addEventListener("mousedown",this.sectionCrossend,!1),n.addEventListener("mouseleave",this.crossleave,!1),n.addEventListener("mouseenter",this.crossenter,!1)),t.textBox.setAttribute("mobile","up"),t.textBox.setAttribute("group",i.uuid),this.OpMeasure.unsteadyData[i.uuid]=this.DeepCopy(this.faceInfo),this.OpMeasure.boxInfos.push(t),this.clearFaceInfo(!0),this.lineAngleInfo.twoPlane&&this.clearLineAngleInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()}}},Ke.prototype.changeFaceAngle=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n),(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],r=i.fstIntersect,o=i.sndIntersect;if(i.arcCenter){if(!i.fstClnd||!i.sndClnd)return}else{var a=(new THREE.Vector3).subVectors(o,r),s=i.firstFaceInfo.worldNormal.clone(),l=i.secondFaceInfo.worldNormal.clone();s.normalize(),l.normalize();var t=new THREE.Vector3,d=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(r,s,o,l,t,d))return;var d=t.clone().add(d.clone().multiplyScalar(10));i.arcCenter=this.getProjectPntToLine(t,d,o);t=a.dot(s),d=(new THREE.Vector3).subVectors(o,s.clone().multiplyScalar(t)),t=(new THREE.Vector3).crossVectors(s,l),l=r.clone().add(t.multiplyScalar(2));i.midLineEndPt=this.getProjectPntToLine(r,l,d);t=i.arcCenter.distanceTo(d),l=o.distanceTo(d),d=Math.min(t,l);this.isZero(d)&&(d=.001);t=(new THREE.Vector3).subVectors(i.midLineEndPt,i.arcCenter),l=(new THREE.Vector3).subVectors(o,i.arcCenter);t.normalize(),l.normalize(),i.sndClndPos=(new THREE.Vector3).addVectors(o,l.multiplyScalar(d));d=i.arcCenter.distanceTo(i.sndClndPos);i.fstClndPos=(new THREE.Vector3).addVectors(i.arcCenter,t.multiplyScalar(d));t=(t=this.getAngle(i.fstClndPos,i.arcCenter,i.sndClndPos))/Math.PI*180;i.dimString=t.toFixed(2)}i.textPos?(!e||(e=this.getProjectPntToPlane(i.arcCenter,i.fstClndPos,i.sndClndPos,e))&&i.textPos.copy(e),a=(new THREE.Vector3).subVectors(i.midLineEndPt,i.arcCenter),s=(new THREE.Vector3).subVectors(o,i.arcCenter),a.normalize(),s.normalize(),d=i.arcCenter.distanceTo(i.textPos),i.fstClndPos.addVectors(i.arcCenter,a.multiplyScalar(d)),i.sndClndPos.addVectors(i.arcCenter,s.multiplyScalar(d))):i.textPos=i.sndClndPos.clone(),i.fstToMidLine||(i.fstToMidLine=this.createLineMesh2(r,i.midLineEndPt,this.appmaterialLine,1)),i.fstToClndLine=this.createLineMesh2(i.midLineEndPt,i.fstClndPos,this.appmaterialLine,1),i.sndToClndLine=this.createLineMesh2(o,i.sndClndPos,this.appmaterialLine,1),i.arcMeshes=this.createAngleArcMeshes2(i.fstClndPos,i.arcCenter,i.sndClndPos,this.ARCWIDTH,this.appmaterialLine),i.fstClnd=this.createCylinderMesh(i.arcMeshes[1].geometry.vertices[0],i.fstClndPos,this.appmaterialLine);d=(new THREE.Vector3).subVectors(i.fstClndPos,i.arcMeshes[1].geometry.vertices[0]);d.normalize();r=this.OpMeasure.getScale(i.fstClnd,this.CYLINDERWIDTH);d.multiplyScalar(.5*i.fstClnd.geometry.parameters.height),i.fstClnd.oldPosition=i.fstClndPos.clone(),i.fstClnd.offsetPos=d.clone().multiplyScalar(-1),i.fstClnd.position.subVectors(i.fstClndPos,d.clone().multiplyScalar(r)),i.sndClnd=this.createCylinderMesh(i.arcMeshes[i.arcMeshes.length-2].geometry.vertices[0],i.sndClndPos,this.appmaterialLine);o=(new THREE.Vector3).subVectors(i.sndClndPos,i.arcMeshes[i.arcMeshes.length-2].geometry.vertices[0]);o.normalize();r=this.OpMeasure.getScale(i.sndClnd,this.CYLINDERWIDTH);o.multiplyScalar(.5*i.sndClnd.geometry.parameters.height),i.sndClnd.oldPosition=i.sndClndPos.clone(),i.sndClnd.offsetPos=o.clone().multiplyScalar(-1),i.sndClnd.position.subVectors(i.sndClndPos,o.clone().multiplyScalar(r));d=this.getAngle(i.fstClndPos,i.arcCenter,i.textPos),o=this.getAngle(i.textPos,i.arcCenter,i.sndClndPos),r=this.getAngle(i.fstClndPos,i.arcCenter,i.sndClndPos);Math.abs(d+o-r)<.01||(r=i.sndClndPos,i.textPos.distanceToSquared(i.fstClndPos)<i.textPos.distanceToSquared(i.sndClndPos)&&(r=i.fstClndPos),i.boxToClndLine=this.createLineMesh2(r,i.textPos,this.appmaterialLine,1)),n.add(i.fstToMidLine),n.add(i.fstToClndLine),n.add(i.sndToClndLine);for(var c=0;c<i.arcMeshes.length;c++)n.add(i.arcMeshes[c]);n.add(i.fstClnd),n.add(i.sndClnd),i.boxToClndLine&&n.add(i.boxToClndLine);for(var h=0;h<this.OpMeasure.boxInfos.length;h++){var u=this.OpMeasure.boxInfos[h];if(u.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){u.textPos=i.textPos;break}}this.OpMeasure.viewer.render()},Ke.prototype.getIntersectLineOfTwoPlane=function(e,t,n,i,r,o){if(!r||!o)return!1;t.normalize(),i.normalize();var a=Math.abs(t.dot(i));if(Math.abs(a-1)<1e-5)return!1;o.crossVectors(t,i);o=t.clone().cross(o),n=(new THREE.Vector3).subVectors(n,e).dot(i),i=o.dot(i),i=n/(i=this.isZero(i)?1e-6:i);return r.addVectors(e,o.clone().multiplyScalar(i)),!0},Ke.prototype.getIntersectPointOfTwoLine=function(e,t,n,i){if(e.distanceToSquared(n)<1e-8)return n.clone();var r=(new THREE.Vector3).crossVectors(t,i),i=((new THREE.Vector3).crossVectors(r,t),(new THREE.Vector3).crossVectors(r,i)),n=(new THREE.Vector3).subVectors(n,e).dot(i)/i.dot(t),i=new THREE.Vector3;return i.addVectors(e,t.clone().multiplyScalar(n)),i},Ke.prototype.measureLineAngle=function(e,t,n,i){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit="°"),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj)this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null);else{var r=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){t=null;if(t=r.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?e[0]:t){var o,a,e=this.getSelectInfoFromIntersect(t);if(e)if("line"!=e.type||this.Bline(e))if(1==n)this.isTwoTopolInfoTheSame(this.lineAngleInfo.preSelLineInfo,e)||-1!=i.indexOf(e.type)&&(this.lineAngleInfo.preSelLineInfo=e,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null));else if(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),this.lineAngleInfo.firstLineInfo)if(this.isTwoTopolInfoTheSame(this.lineAngleInfo.firstLineInfo,e))this.lineAngleInfo.firstLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null);else if(-1!=i.indexOf(e.type)||-1==i.indexOf("plane")||"cylinder"!==e.type&&"other"!==e.type){if(-1!=i.indexOf(e.type)){this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN);var s,t=new THREE.Plane;if(this.lineAngleInfo.firstLineInfo.type==e.type)s=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),o=this.getLineStartEndPoints(e);else{"line"==this.lineAngleInfo.firstLineInfo.type?(s=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),(t=new THREE.Plane).setFromNormalAndCoplanarPoint(e.worldNormal,e.worldOrigin),a=e.intersect):"plane"==this.lineAngleInfo.firstLineInfo.type&&(s=this.getLineStartEndPoints(e),t.setFromNormalAndCoplanarPoint(this.lineAngleInfo.firstLineInfo.worldNormal,this.lineAngleInfo.firstLineInfo.worldOrigin),a=this.lineAngleInfo.firstLineInfo.intersect);var l=this.intersectLine(s.start,s.end,t);if(!l)return void("line"==e.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.LINEPARALLELPLANE):"plane"==e.type&&this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.PLANEPARALLELLINE));var d=new THREE.Vector3;t.projectPoint(s.start,d);n=new THREE.Vector3;t.projectPoint(s.end,n),o=d.distanceTo(n)<1e-5?{start:l,end:a}:d.distanceTo(l)<1e-4?{start:l,end:n}:{start:l,end:d}}if(s&&o){l=(new THREE.Vector3).subVectors(s.end,s.start);l.normalize();d=(new THREE.Vector3).subVectors(o.end,o.start);d.normalize();d=l.dot(d);if(1-Math.abs(d)<1e-6)return this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),void this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.LINEPARALLEL);this.lineAngleInfo.secondLineInfo=e,this.lineAngleInfo.firstLineInfo.start=s.start.clone(),this.lineAngleInfo.firstLineInfo.end=s.end.clone(),this.lineAngleInfo.secondLineInfo.start=o.start.clone(),this.lineAngleInfo.secondLineInfo.end=o.end.clone(),this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null)}}}else this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACE);else-1!=i.indexOf(e.type)||-1==i.indexOf("plane")||"cylinder"!==e.type&&"other"!==e.type?-1!=i.indexOf(e.type)&&(this.lineAngleInfo.firstLineInfo=e,this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN)):this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACE);else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}}else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}},Ke.prototype.updateLineAngleScene=function(e){var t;"LineAngle"!==this.measureType&&"LineFaceAngle"!==this.measureType&&"angle"!==this.measureType||(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.lineAngleInfo.preSelLineInfo&&!this.lineAngleInfo.preSelLineObj&&("line"==this.lineAngleInfo.preSelLineInfo.type&&(t=this.createLine(this.lineAngleInfo.preSelLineInfo,!0)),(t="plane"==this.lineAngleInfo.preSelLineInfo.type?this.createFace(this.lineAngleInfo.preSelLineInfo,!0):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.preSelLineObj=t)):(this.lineAngleInfo.firstLineInfo&&!this.lineAngleInfo.firstLineObj&&("line"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createLine(this.lineAngleInfo.firstLineInfo,!1)),"plane"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createFace(this.lineAngleInfo.firstLineInfo,!1)),(t="helpline"==this.lineAngleInfo.firstLineInfo.type?this.createLineMesh2(this.lineAngleInfo.firstLineInfo.start,this.lineAngleInfo.firstLineInfo.end,this.materialLine,1):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.firstLineObj=t)),this.lineAngleInfo.secondLineInfo&&!this.lineAngleInfo.secondLineObj&&("line"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createLine(this.lineAngleInfo.secondLineInfo,!1)),"plane"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createFace(this.lineAngleInfo.secondLineInfo,!1)),(t="helpline"==this.lineAngleInfo.secondLineInfo.type?this.createLineMesh2(this.lineAngleInfo.secondLineInfo.start,this.lineAngleInfo.secondLineInfo.end,this.materialLine,1):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.secondLineObj=t)),this.lineAngleInfo.firstHelpPointInfo&&!this.lineAngleInfo.firstHelpPointobj&&(t=this.createPointMesh(this.lineAngleInfo.firstHelpPointInfo.point,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.firstHelpPointobj=t),this.lineAngleInfo.secHelpPointInfo&&!this.lineAngleInfo.secHelpPointobj&&(t=this.createPointMesh(this.lineAngleInfo.secHelpPointInfo.point,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.secHelpPointobj=t),this.lineAngleInfo.thrHelpPointInfo&&!this.lineAngleInfo.thrHelpPointobj&&(this.lineAngleInfo.secHelpPointobj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.secHelpPointobj),this.lineAngleInfo.secHelpPointInfo=null),this.lineAngleInfo.firstHelpPointobj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstHelpPointobj),this.lineAngleInfo.firstHelpPointInfo=null))))},Ke.prototype.measurefaceAngle=function(e,t,n){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit="°"),this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj)this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null);else{this.viewer;var i=this.doRaycasterPick(e,t,!1);if(!i)return this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),void(this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects.length=0));for(var r=0;r<i.length;){var o=this.getSelectInfoFromIntersect(i[r]);if(o){if("plane"!=o.type){n||(null!=this.faceInfo.firstFaceInfo?this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACESECOND):this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACE));break}if(1==n)this.isTwoTopolInfoTheSame(this.faceInfo.preSelFaceInfo,o)||(this.faceInfo.preSelFaceInfo=o,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null));else if(this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN),this.faceInfo.firstFaceInfo)if(this.isTwoTopolInfoTheSame(this.faceInfo.firstFaceInfo,o))this.faceInfo.fstSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.faceInfo.fstSelFaceObj=null,this.faceInfo.firstFaceInfo=null);else{var a=this.faceInfo.firstFaceInfo.worldNormal.clone(),s=o.worldNormal.clone();a.normalize(),s.normalize();var l=a.dot(s),a=null,s=null;if(Math.abs(Math.abs(l)-1)<1e-5)return this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.PLANEPARALLEL),this.faceInfo.preSelFaceInfo=null,void(this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null));this.faceInfo.secondFaceInfo=o,this.faceInfo.sndIntersect=o.intersect,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null)}else this.faceInfo.firstFaceInfo=o,this.faceInfo.fstIntersect=o.intersect,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null);return}r++}1==n&&this.faceInfo.preSelFaceInfo&&(this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null))}},Ke.prototype.updateFaceAngleScene=function(e){var t,n,i,r,o;"faceAngle"===this.measureType&&(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null):(!(!e||"true"!==e.toLowerCase())?this.faceInfo.preSelFaceInfo&&!this.faceInfo.preSelFaceObj&&(o=this.createFace(this.faceInfo.preSelFaceInfo,!0))&&((r=[]).push(o),this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects=r),this.OpMeasure.rootObject.add(o),this.faceInfo.preSelFaceObj=o):(this.faceInfo.firstFaceInfo&&!this.faceInfo.fstSelFaceObj&&(o=this.createFace(this.faceInfo.firstFaceInfo,!1))&&(this.OpMeasure.rootObject.add(o),this.faceInfo.fstSelFaceObj=o),this.faceInfo.secondFaceInfo&&!this.faceInfo.sndSelFaceObj&&(o=this.createFace(this.faceInfo.secondFaceInfo,!1))&&(this.OpMeasure.rootObject.add(o),this.faceInfo.sndSelFaceObj=o)),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&(t=this.faceInfo.fstIntersect,n=this.faceInfo.sndIntersect,this.lineAngleInfo.firstLineInfo=this.faceInfo.firstFaceInfo,this.lineAngleInfo.secondLineInfo=this.faceInfo.secondFaceInfo,i=this.faceInfo.firstFaceInfo.worldNormal.clone(),e=this.faceInfo.secondFaceInfo.worldNormal.clone(),i.normalize(),e.normalize(),r=new THREE.Vector3,o=new THREE.Vector3,this.getIntersectLineOfTwoPlane(t,i,n,e,r,o),this.lineAngleInfo.firstLineInfo.start=t.clone(),this.lineAngleInfo.firstLineInfo.end=r.clone(),this.getIntersectLineOfTwoPlane(n,e,t,i,r,o),this.lineAngleInfo.secondLineInfo.start=n.clone(),this.lineAngleInfo.secondLineInfo.end=r.clone())))},Ke.prototype.measureBodyAngle=function(e,t,n,i){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit="°"),""==this.faceInfo.unit&&(this.faceInfo.unit="°"),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj)this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null);else{var r=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){t=null;if(t=r.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?e[0]:t){var o,t=this.getSelectInfoFromIntersect(t);if(t){if("bodyAngle"==this.measureType&&-1==i.indexOf(t.type))return this.lineAngleInfo.preSelLineInfo=null,void(this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null));if("line"!=t.type||this.Bline(t))if(1==n)this.isTwoTopolInfoTheSame(this.lineAngleInfo.preSelLineInfo,t)||-1!=i.indexOf(t.type)&&(this.lineAngleInfo.preSelLineInfo=t,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null));else if(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),this.lineAngleInfo.firstLineInfo)if(this.isTwoTopolInfoTheSame(this.lineAngleInfo.firstLineInfo,t))this.lineAngleInfo.firstLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null);else if(-1!=i.indexOf(t.type)||-1==i.indexOf("plane")||"other"!==t.type){if(-1!=i.indexOf(t.type)){this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN);var a,n=new THREE.Plane;if("line"!=this.lineAngleInfo.firstLineInfo.type&&"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"line"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type){if("plane"==this.lineAngleInfo.firstLineInfo.type&&"plane"==t.type){this.lineAngleInfo.twoPlane=!0;var s=this.lineAngleInfo.firstLineInfo.worldNormal.clone(),l=t.worldNormal.clone();s.normalize(),l.normalize();var d=s.dot(l);return Math.abs(Math.abs(d)-1)<1e-5?(this.OpMeasure.PostInfo(NDS.INFOTYPE.TWOBODYPARALLEL),void(this.lineAngleInfo.twoPlane=!1)):(this.faceInfo.firstFaceInfo=this.lineAngleInfo.firstLineInfo,this.faceInfo.fstIntersect=this.lineAngleInfo.firstLineInfo.intersect,this.faceInfo.secondFaceInfo=t,this.faceInfo.sndIntersect=t.intersect,void(this.lineAngleInfo.secondLineInfo=t))}"line"!=this.lineAngleInfo.firstLineInfo.type&&"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"plane"!=t.type?"plane"!=this.lineAngleInfo.firstLineInfo.type||"line"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||(a=this.getLineStartEndPoints(t),n.setFromNormalAndCoplanarPoint(this.lineAngleInfo.firstLineInfo.worldNormal,this.lineAngleInfo.firstLineInfo.worldOrigin),o=this.lineAngleInfo.firstLineInfo.intersect):(a=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),(n=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),o=t.intersect);s=this.intersectLine(a.start,a.end,n);if(!s)return void("line"==t.type||"cylinder"==t.type||"cone"==t.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.LINEPARALLELPLANE):"plane"==t.type&&this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.PLANEPARALLELLINE));l=new THREE.Vector3;n.projectPoint(a.start,l);var d=new THREE.Vector3;n.projectPoint(a.end,d),d=l.distanceTo(d)<1e-5?{start:s,end:o}:l.distanceTo(s)<1e-4?{start:s,end:d}:{start:s,end:l}}else a=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),d=this.getLineStartEndPoints(t);if(a&&d){s=(new THREE.Vector3).subVectors(a.end,a.start);s.normalize();l=(new THREE.Vector3).subVectors(d.end,d.start);l.normalize();l=s.dot(l);if(1-Math.abs(l)<1e-6)return this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),void("line"==this.lineAngleInfo.firstLineInfo.type&&"line"==t.type||"line"==this.lineAngleInfo.firstLineInfo.type&&"line"==t.type||"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"cylinder"!=t.type&&"cone"!=t.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.LINEPARALLEL):this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDS.INFOTYPE.TWOBODYPARALLEL:NDS.INFOTYPE.AXISNOPARALLEL));this.lineAngleInfo.secondLineInfo=t,this.lineAngleInfo.firstLineInfo.start=a.start.clone(),this.lineAngleInfo.firstLineInfo.end=a.end.clone(),this.lineAngleInfo.secondLineInfo.start=d.start.clone(),this.lineAngleInfo.secondLineInfo.end=d.end.clone(),this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null)}}}else this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACE);else-1!=i.indexOf(t.type)||-1==i.indexOf("plane")||"other"!==t.type?-1!=i.indexOf(t.type)&&(this.lineAngleInfo.firstLineInfo=t,this.OpMeasure.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDS.INFOTYPE.MEASURENOTICEBEGIN)):this.OpMeasure.PostInfo(NDS.INFOTYPE.NOTFACE);else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}}}else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}},Ke.prototype.updateBodyAngleScene=function(e){var t,n,i,r,o;"bodyAngle"===this.measureType&&(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null):(!(!e||"true"!==e.toLowerCase())?this.lineAngleInfo.preSelLineInfo&&!this.lineAngleInfo.preSelLineObj&&("line"==this.lineAngleInfo.preSelLineInfo.type&&(o=this.createLine(this.lineAngleInfo.preSelLineInfo,!0)),"plane"==this.lineAngleInfo.preSelLineInfo.type&&(o=this.createFace(this.lineAngleInfo.preSelLineInfo,!0)),"cylinder"==this.lineAngleInfo.preSelLineInfo.type&&(o=this.createFace(this.lineAngleInfo.preSelLineInfo,!0)),(o="cone"==this.lineAngleInfo.preSelLineInfo.type?this.createFace(this.lineAngleInfo.preSelLineInfo,!0):o)&&(this.OpMeasure.rootObject.add(o),this.lineAngleInfo.preSelLineObj=o)):(this.lineAngleInfo.firstLineInfo&&!this.lineAngleInfo.firstLineObj&&("line"==this.lineAngleInfo.firstLineInfo.type&&(o=this.createLine(this.lineAngleInfo.firstLineInfo,!1)),"plane"==this.lineAngleInfo.firstLineInfo.type&&(o=this.createFace(this.lineAngleInfo.firstLineInfo,!1)),"cylinder"==this.lineAngleInfo.firstLineInfo.type&&(o=this.createFace(this.lineAngleInfo.firstLineInfo,!0)),(o="cone"==this.lineAngleInfo.firstLineInfo.type?this.createFace(this.lineAngleInfo.firstLineInfo,!0):o)&&(this.OpMeasure.rootObject.add(o),this.lineAngleInfo.firstLineObj=o)),this.lineAngleInfo.secondLineInfo&&!this.lineAngleInfo.secondLineObj&&("line"==this.lineAngleInfo.secondLineInfo.type&&(o=this.createLine(this.lineAngleInfo.secondLineInfo,!1)),"plane"==this.lineAngleInfo.secondLineInfo.type&&(o=this.createFace(this.lineAngleInfo.secondLineInfo,!1),this.faceInfo.fstSelFaceObj=this.lineAngleInfo.firstLineObj,this.faceInfo.sndSelFaceObj=o),"cylinder"==this.lineAngleInfo.secondLineInfo.type&&(o=this.createFace(this.lineAngleInfo.secondLineInfo,!0)),(o="cone"==this.lineAngleInfo.secondLineInfo.type?this.createFace(this.lineAngleInfo.secondLineInfo,!0):o)&&(this.OpMeasure.rootObject.add(o),this.lineAngleInfo.secondLineObj=o))),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&(t=this.faceInfo.fstIntersect,n=this.faceInfo.sndIntersect,this.lineAngleInfo.firstLineInfo=this.faceInfo.firstFaceInfo,this.lineAngleInfo.secondLineInfo=this.faceInfo.secondFaceInfo,i=this.faceInfo.firstFaceInfo.worldNormal.clone(),r=this.faceInfo.secondFaceInfo.worldNormal.clone(),i.normalize(),r.normalize(),e=new THREE.Vector3,o=new THREE.Vector3,this.getIntersectLineOfTwoPlane(t,i,n,r,e,o),this.lineAngleInfo.firstLineInfo.start=t.clone(),this.lineAngleInfo.firstLineInfo.end=e.clone(),this.getIntersectLineOfTwoPlane(n,r,t,i,e,o),this.lineAngleInfo.secondLineInfo.start=n.clone(),this.lineAngleInfo.secondLineInfo.end=e.clone())))};function $e(e){Xe.call(this,e),this.measureClass="BodyAndTotal"}($e.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"TotalArea":var t=this.viewer.getObjectProperty(this.viewer.ndsModel.rootBodyNode);this.viewer.dispatchAsyncEvent({type:"BodyTotalAreaEvent",totalArea:t.area,modelUnit:t.unit});break;case"TotalVolume":t=this.viewer.getObjectProperty(this.viewer.ndsModel.rootBodyNode);this.viewer.dispatchAsyncEvent({type:"BodyTotalVolumeEvent",totalVolume:t.volume,modelUnit:t.unit});break;case"BoundingBox":this.measureBoundingBox(!0),Ue.enableBroadcast&&Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"});break;case"BodyArea":case"BodyVolume":this.OpMeasure.PostInfo(NDS.INFOTYPE.BODY);break;case"bodyBoundingBox":ye.isMobileDevice()||this.OpMeasure.PostInfo(NDS.INFOTYPE.BODY)}},$e.prototype.onNMouseMove=function(e,t){switch(this.measureType){case"BodyArea":case"BodyVolume":case"bodyBoundingBox":this.measureBodyVolumeAndAreaPre(e,t,this.measureType)}},$e.prototype.onLMouseClick=function(e,t,n){switch(this.ClearmeasureBodyVolumeAndAreaPre(),this.measureType){case"BodyArea":this.measureBodyVolumeAndArea(e,t,"FaceMeasure",n);break;case"BodyVolume":this.measureBodyVolumeAndArea(e,t,"VolumeMeasure",n);break;case"bodyBoundingBox":this.measureBodyBoundingBox(e,t)}},$e.prototype.measureBodyVolumeAndAreaPre=function(e,t,n){var i=this.getIntersectsByPriorityOfLine(e,t),t=!1;if(this.preSelectBodyMat&&this.preSelectBody?(this.preSelectBody.setUserMaterial(this.preSelectBodyMat),t=!0,this.preSelectBodyMat=null):this.preSelectBody&&(this.preSelectBody.setUserMaterial(null),t=!0),i&&0<i.length){for(var r=0;r<i.length;){var o=this.viewer.ndsModel?i[r].object:this.FindParentElement(i[r].object);if(null!=o){this.preSelectBody=o;o=this.preSelectBody.getUserMaterial();this.preSelectBodyMat=o||null,this.preSelectBody.setUserMaterial(this.materialPreSelectMeshopacity);break}r++}this.OpMeasure.render()}else this.preSelectBody=null,t&&this.OpMeasure.render()},$e.prototype.measureBodyBoundingBox=function(e,t){var n=this.getIntersectsByPriorityOfLine(e,t);if(n&&0<n.length){for(var i=0;i<n.length;){var r=this.viewer.ndsModel?n[i].object:this.FindParentElement(n[i].object);if(null!=r)break;i++}if(null!=r){var o=this.viewer.ndsModel.getBodyBoundingBoxTrue(r);this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null);for(var a=0,s=this.OpMeasure.boundingboxInfos.length;a<s;a++){var l=this.OpMeasure.boundingboxInfos[a];this.viewer.container.removeChild(l.textBox),l.textPos=null,l.textBox=null}this.OpMeasure.boundingboxInfos.splice(0,this.OpMeasure.boundingboxInfos.length),this.OpMeasure.boundingboxmesh=this.createBodyBoundingBox(o),this.distanceInfo.unit=this.getUnitString(),this.OpMeasure.rootObject.add(this.OpMeasure.boundingboxmesh);var d=new THREE.Vector3,c=d.subVectors(o[7],o[3]).length(),h=d.subVectors(o[7],o[5]).length(),u=d.subVectors(o[7],o[6]).length(),f=this.viewer.getDispalyModelUnit(c);c*=f.scale,h*=f.scale,u*=f.scale;var p=this.getUnitStringmap(f.unit),c=c.toFixed(2)+p,h=h.toFixed(2)+p,u=u.toFixed(2)+p,m=document.createElement("div");m.style.position="absolute",m.style.color="white",m.style.zIndex=3,m.style.backgroundColor="rgba(115,0,230,0.75)",m.style.userSelect="none",m.style.pointerEvents="none",this.viewer.container.appendChild(m);e=document.createElement("div");e.style.position="absolute",e.style.color="white",e.style.zIndex=3,e.style.backgroundColor="rgba(115,0,230,0.75)",e.style.userSelect="none",e.style.pointerEvents="none",this.viewer.container.appendChild(e);t=document.createElement("div");t.style.position="absolute",t.style.color="white",t.style.zIndex=3,t.style.backgroundColor="rgba(115,0,230,0.75)",t.style.userSelect="none",t.style.pointerEvents="none",this.viewer.container.appendChild(t);f=d.clone().addVectors(o[7],o[3]).divideScalar(2),p=d.clone().addVectors(o[7],o[5]).divideScalar(2),d=d.clone().addVectors(o[7],o[6]).divideScalar(2);this.getAndShowTextBox(f.clone(),c,m),this.getAndShowTextBox(p.clone(),h,e),this.getAndShowTextBox(d.clone(),u,t);o={};o.dimString=c,o.textPos=f.clone(),o.textBox=m,this.OpMeasure.boundingboxInfos.push(o);o={};o.dimString=h,o.textPos=p.clone(),o.textBox=e,this.OpMeasure.boundingboxInfos.push(o);o={};o.dimString=u,o.textPos=d.clone(),o.textBox=t,this.OpMeasure.boundingboxInfos.push(o)}}else this.measureBoundingBox(!1)},$e.prototype.createBodyBoundingBox=function(e){var t=new Float32Array(24);t[0]=e[0].x,t[1]=e[0].y,t[2]=e[0].z,t[3]=e[1].x,t[4]=e[1].y,t[5]=e[1].z,t[6]=e[2].x,t[7]=e[2].y,t[8]=e[2].z,t[9]=e[3].x,t[10]=e[3].y,t[11]=e[3].z,t[12]=e[4].x,t[13]=e[4].y,t[14]=e[4].z,t[15]=e[5].x,t[16]=e[5].y,t[17]=e[5].z,t[18]=e[6].x,t[19]=e[6].y,t[20]=e[6].z,t[21]=e[7].x,t[22]=e[7].y,t[23]=e[7].z;var n=new Uint16Array([0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]),i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(n,1)),i.addAttribute("position",new THREE.BufferAttribute(t,3)),(i=new THREE.LineSegments(i,this.materialBoxLine)).objectType="BodyBoundingBox",i.box=e,i},$e.prototype.measureBodyVolumeAndArea=function(e,t,n,i){var r=this.getIntersectsByPriorityOfLine(e,t);if(r&&0<r.length)for(var o=0;o<r.length;){if(null!=(this.viewer.ndsModel?r[o].object:this.FindParentElement(r[o].object)))break;o++}ye.isMobileDevice()&&this.ChangeMeasureFlag(),this.viewer.selectionManager.selectByClick(e,t,i)};function et(e){Xe.call(this,e),this.measureClass="Coordinate"}(et.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){this.measureType=e,this.viewer.onOpChanged({id:"coordinate"}),this.coordinatediv||(this.coordinatediv=document.createElement("div"),this.coordinatediv.className="ActiveCoordinate",this.coordinatediv.style.position="absolute",this.coordinatediv.style.color="white",this.coordinatediv.style.zIndex=3,this.coordinatediv.style.backgroundColor="rgba(115,0,230,0.75)",this.coordinatediv.style.userSelect="none",this.coordinatediv.style.pointerEvents="none",this.viewer.container.appendChild(this.coordinatediv)),ye.isMobileDevice()&&this.OpMeasure.PostInfo(NDS.INFOTYPE.COORDINATEPOINT)},et.prototype.onNMouseMove=function(e,t){this.coordinatediv||(this.coordinatediv=document.createElement("div"),this.coordinatediv.className="ActiveCoordinate",this.coordinatediv.style.position="absolute",this.coordinatediv.style.color="white",this.coordinatediv.style.zIndex=3,this.coordinatediv.style.backgroundColor="rgba(115,0,230,0.75)",this.coordinatediv.style.userSelect="none",this.coordinatediv.style.pointerEvents="none",this.viewer.container.appendChild(this.coordinatediv));var n,i,r,o,a,s,l=48;ye.isMobileDevice()&&this.viewer.is2DModel&&(l=0),this.previewSnappedPoint(e+l,t+l,!0),this.snappedPoint?(n="X:"+parseFloat(this.snappedPoint.x.toFixed(4).toString())+"<br>Y:"+parseFloat(this.snappedPoint.y.toFixed(4).toString()),i=this.snappedPoint.clone(),this.getAndShowTextBox(i.clone(),n,this.coordinatediv),this.coordinatedivtextPos=i,this.coordinatedivdims=n):(s=(r=this.viewer).renderer.domElement,a=r.renderer.getPixelRatio(),o=new THREE.Raycaster,r.camera.setCastRay(o,(e+l)*a/s.width*2-1,2*-((t+l)*a/s.height)+1),a=new THREE.Plane(new THREE.Vector3(0,0,-1),0),s=new THREE.Vector3,o.ray.intersectPlane(a,s),s&&(n="X:"+parseFloat(s.x.toFixed(4).toString())+"<br>Y:"+parseFloat(s.y.toFixed(4).toString()),i=s.clone(),this.getAndShowTextBox(i.clone(),n,this.coordinatediv),this.coordinatedivtextPos=i,this.coordinatedivdims=n))},et.prototype.onLMouseClick=function(e,t,n){var i=document.createElement("div");i.className="mearesult",this.viewer.container.appendChild(i);var r,o,a=48;ye.isMobileDevice()&&this.viewer.is2DModel&&(a=0);var s,l,d,c,h=new THREE.Vector3;this.snappedPoint?(r="X:"+parseFloat(this.snappedPoint.x.toFixed(4).toString())+"<br>Y:"+parseFloat(this.snappedPoint.y.toFixed(4).toString()),o=this.snappedPoint.clone(),this.getAndShowTextBox(o.clone(),r,i),h.copy(this.snappedPoint),this.snappedPoint=null):(c=(s=this.viewer).renderer.domElement,l=s.renderer.getPixelRatio(),d=new THREE.Raycaster,s.camera.setCastRay(d,(e+a)*l/c.width*2-1,2*-((t+a)*l/c.height)+1),c=new THREE.Plane(new THREE.Vector3(0,0,-1),0),d.ray.intersectPlane(c,h),h&&(r="X:"+parseFloat(h.x.toFixed(4).toString())+"<br>Y:"+parseFloat(h.y.toFixed(4).toString()),o=h.clone(),this.getAndShowTextBox(o.clone(),r,i))),!h||(u=this.createPointMesh(h,this.materialPoint,10*this.POINTSIZE))&&this.OpMeasure.rootObject.add(u);var u={};u.dimString=r,u.textPos=o,u.textBox=i,u.textBox.setAttribute("type","coordinate"),u.textBox.setAttribute("dimString",r),this.OpMeasure.boxInfos.push(u),ye.isMobileDevice()&&this.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes()};function tt(e){Xe.call(this,e),this.measureClass="Lineargauge"}function nt(e){return(nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function it(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}function rt(){this.edgeIndex=-1,this.Pos=-1}function ot(){this.dimString="",this.textBox=null,this.textPos=null,this.lineobj=null,this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.lineInfo=null,this.LineSegments=[],this.intersectMouse=null,this.intersectPos=[]}(tt.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){var t,n,i,r;this.measureType=e,ye.isMobileDevice()&&this.viewer.is2DModel&&(t=this,r="en"==ye.getLanguage(),this.lineargaugediv||(this.lineargaugediv=document.createElement("div"),this.lineargaugediv.className="tc-box ts-tc",(i=document.createElement("p")).innerHTML=r?"Select the direction ":"请选择标注线放置方向",(n=document.createElement("div")).className="ts-tcCnt",n.appendChild(i),(e=document.createElement("span")).innerHTML=r?"Horizontal":"水平方向",e.onclick=function(){t.distanceInfo.XorY=0,t.lineargaugediv.style.display="none",t.shadowdiv.style.display="none",t.ShowLineargaugeDimension(null,!0,t.distanceInfo.XorY),t.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT),Ue.enableBroadcast&&Ue.broadcastMajor&&t.viewer.dispatchEvent({type:"broadcastEvent"})},(i=document.createElement("span")).innerHTML=r?"Vertical":"垂直方向",i.onclick=function(){t.distanceInfo.XorY=1,t.lineargaugediv.style.display="none",t.shadowdiv.style.display="none",t.ShowLineargaugeDimension(null,!0,t.distanceInfo.XorY),t.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT),Ue.enableBroadcast&&Ue.broadcastMajor&&t.viewer.dispatchEvent({type:"broadcastEvent"})},(r=document.createElement("div")).className="clearfix ts-tcBtn ts-tcBtn02",r.appendChild(e),r.appendChild(i),this.lineargaugediv.appendChild(n),this.lineargaugediv.appendChild(r),this.lineargaugediv.style.display="none",this.lineargaugediv.style.zIndex=10,this.viewer.container.appendChild(this.lineargaugediv),this.shadowdiv=document.createElement("div"),this.shadowdiv.className="shadowvtc",this.shadowdiv.style.display="none",this.viewer.container.appendChild(this.shadowdiv))),this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT)},tt.prototype.onNMouseMove=function(e,t){var n,i,r,o,a,s=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!ye.isMobileDevice()?(n=this.distanceInfo.firstPoint.clone(),i=this.distanceInfo.secondPoint.clone(),s&&(a=new THREE.Plane(new THREE.Vector3(0,0,-1),0),(r=this.clientCoordToModelCoordOnPlane(s.x,s.y,a))&&(this.distanceInfo.mousePos||(this.distanceInfo.mousePos=r.clone()),a=o=!1,(o=this.distanceInfo.mousePos.y<Math.max(n.y,i.y)&&this.distanceInfo.mousePos.y>Math.min(n.y,i.y)&&this.distanceInfo.mousePos.x<Math.max(n.x,i.x)&&this.distanceInfo.mousePos.x>Math.min(n.x,i.x)?!0:o)!=(a=r.y<Math.max(n.y,i.y)&&r.y>Math.min(n.y,i.y)&&r.x<Math.max(n.x,i.x)&&r.x>Math.min(n.x,i.x)?!0:a)&&(n.y<Math.max(this.distanceInfo.mousePos.y,r.y)&&n.y>Math.min(this.distanceInfo.mousePos.y,r.y)||i.y<Math.max(this.distanceInfo.mousePos.y,r.y)&&i.y>Math.min(this.distanceInfo.mousePos.y,r.y)?this.distanceInfo.XorY=0:(n.x<Math.max(this.distanceInfo.mousePos.x,r.x)&&n.x>Math.min(this.distanceInfo.mousePos.x,r.x)||i.x<Math.max(this.distanceInfo.mousePos.x,r.x)&&i.x>Math.min(this.distanceInfo.mousePos.x,r.x))&&(this.distanceInfo.XorY=1)),this.distanceInfo.mousePos.set(r.x,r.y,0))),this.ShowLineargaugeDimension(s,!1,this.distanceInfo.XorY)):this.previewSnappedPoint(e,t,!0)},tt.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?(this.ShowLineargaugeDimension(i,!0,this.distanceInfo.XorY),this.OpMeasure.PostInfo(NDS.INFOTYPE.FIRSTPOINT)):(this.PtToPtMeasure(e,t,!1),this.updatePtToPtScene(),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&ye.isMobileDevice()&&(this.lineargaugediv.style.display="block",this.shadowdiv.style.display="block"))},tt.prototype.PtToPtMeasure=function(e,t,n){if(null!=this.snappedPoint)null==this.distanceInfo.firstPoint?this.distanceInfo.firstPoint=this.snappedPoint.clone():this.distanceInfo.secondPoint=this.snappedPoint.clone(),this.snappedPoint=null;else{var i=this.getIntersectsByPriorityOfLine(e,t);if(i&&0<i.length)for(var r=0;r<i.length;){if(null!=(this.viewer.ndsModel?i[r].object:this.FindParentElement(i[r].object))){var o,a=i[r].point.clone();!n||(o=this.getSnappingPntEx(i[r]))&&a.copy(o),null==this.distanceInfo.firstPoint?this.distanceInfo.firstPoint=a:this.distanceInfo.secondPoint=a;break}r++}}this.distanceInfo.firstPoint&&!this.distanceInfo.secondPoint&&this.OpMeasure.PostInfo(NDS.INFOTYPE.SECONDPOINT),this.distanceInfo.firstPoint&&this.distanceInfo.secondPoint&&!ye.isMobileDevice()&&this.OpMeasure.PostInfo(NDS.INFOTYPE.LINEPOSITION)},tt.prototype.ShowLineargaugeDimension=function(e,t,n){var i,r,o,a,s;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&this.viewer.is2DModel&&(i=this.distanceInfo.firstPoint.clone(),r=this.distanceInfo.secondPoint.clone(),null==n&&(n=0),Math.abs(i.x-r.x)<1e-6&&!ye.isMobileDevice()?n=1:Math.abs(i.y-r.y)<1e-6&&!ye.isMobileDevice()&&(n=0),this.distanceInfo.fstClndPos?this.distanceInfo.fstClndPos.set(this.distanceInfo.firstPoint.x,this.distanceInfo.firstPoint.y,0):(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone(),this.distanceInfo.fstClndPos.z=0),this.distanceInfo.sndClndPos?this.distanceInfo.sndClndPos.set(this.distanceInfo.secondPoint.x,this.distanceInfo.secondPoint.y,0):(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone(),this.distanceInfo.sndClndPos.z=0),e?(o=new THREE.Plane(new THREE.Vector3(0,0,-1),0),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&0==n?(this.distanceInfo.fstClndPos.y=o.y,this.distanceInfo.sndClndPos.y=o.y):o&&1==n&&(this.distanceInfo.fstClndPos.x=o.x,this.distanceInfo.sndClndPos.x=o.x)):0==n?(a=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,this.distanceInfo.fstClndPos.y=a,this.distanceInfo.sndClndPos.y=a):1==n&&(s=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.fstClndPos.x=s,this.distanceInfo.sndClndPos.x=s),this.distanceInfo.textPos?(this.distanceInfo.textPos.x=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.textPos.y=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2):this.distanceInfo.textPos=new THREE.Vector3((this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,0),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),(a=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos)).normalize(),this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine),s=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),a.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=a.clone(),this.distanceInfo.fstClnd.position.addVectors(this.distanceInfo.fstClndPos,a.clone().multiplyScalar(s)),this.distanceInfo.fstClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=a.clone().multiplyScalar(-1),this.distanceInfo.sndClnd.position.subVectors(this.distanceInfo.sndClndPos,a.clone().multiplyScalar(s)),this.distanceInfo.sndClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.sndClnd),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.clndToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.clndToClndLine),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.fstToClndLine=this.createLineMesh2(i,this.distanceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.sndToClndLine=this.createLineMesh2(r,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.sndToClndLine),this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),0==n?this.distanceInfo.dimString=Math.abs(this.distanceInfo.firstPoint.x-this.distanceInfo.secondPoint.x):1==n&&(this.distanceInfo.dimString=Math.abs(this.distanceInfo.firstPoint.y-this.distanceInfo.secondPoint.y)),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),n=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=n.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(2),this.distanceInfo.unit=this.getUnitStringmap(n.unit),n=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(2)+this.distanceInfo.unit,this.distanceInfo.textBox||(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.distanceInfo.textBox)),this.getAndShowTextBox(this.distanceInfo.textPos.clone(),n,this.distanceInfo.textBox),1==t&&((t={}).dimString=n,t.textPos=this.distanceInfo.textPos.clone(),t.textBox=this.distanceInfo.textBox,t.textBox.setAttribute("type","length"),t.textBox.setAttribute("dimString",this.distanceInfo.dimString),t.textBox.setAttribute("unit",this.distanceInfo.unit),this.OpMeasure.boxInfos.push(t),this.clearDistanceInfo(!0),ye.isMobileDevice()&&this.ChangeMeasureFlag()))},tt.prototype.updatePtToPtScene=function(){var e;this.distanceInfo.firstPoint&&!this.distanceInfo.firstSelObj&&(e=this.createPointMesh(this.distanceInfo.firstPoint,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(e),this.distanceInfo.firstSelObj=e),this.distanceInfo.secondPoint&&!this.distanceInfo.secondSelObj&&(e=this.createPointMesh(this.distanceInfo.secondPoint,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(e),this.distanceInfo.secondSelObj=e),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!ye.isMobileDevice()&&this.ShowLineargaugeDimension()};function at(e){Xe.call(this,e),this.measureClass="Contour"}(at.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){var C,t,n,i;"contour"==(this.measureType=e)?(this.contourdiv||((C=this).contourdiv=document.createElement("div"),ye.isMobileDevice()?(this.contourdiv.className="continuityLength-arrow",(n=document.createElement("span")).className="arrow-prev no",(t=document.createElement("a")).className="continuityLength-btn no","en"==ye.getLanguage()?t.innerHTML="confirm":t.innerHTML="确认",this.contourdiv.appendChild(n),this.contourdiv.appendChild(t)):(this.contourdiv.id="contour",this.contourdiv.style.position="absolute",this.contourdiv.style.zIndex=3,(t=document.createElement("img")).style.height="36px",t.style.width="36px",(n=document.createElement("img")).style.height="36px",n.style.width="36px",(i=document.createElement("img")).style.height="36px",i.style.width="36px"),t.onclick=function(){if(0!=C.lineContoursInfo.Contours.length){C.contourdiv.style.display="none";for(var e=null,t=C.lineContoursInfo.perimeter=0;t<C.lineContoursInfo.Contours.length;++t){var n=C.lineContoursInfo.Contours[t];if(C.OpMeasure.rootObject.remove(n.lineobj),1==n.LineSegments.length){for(var i=0,r=1,o=0;o<n.intersectPos.length;++o){if(n.intersectMouse.Pos>=i&&n.intersectMouse.Pos<=n.intersectPos[o].Pos){r=n.intersectPos[o].Pos;break}i=n.intersectPos[o].Pos}var a=n.LineSegments[0].start.distanceTo(n.LineSegments[0].end),s=n.LineSegments[0].end.clone().sub(n.LineSegments[0].start).normalize();(f=[])[0]=n.LineSegments[0].start.x+i*a*s.x,f[1]=n.LineSegments[0].start.y+i*a*s.y,f[2]=0,f[3]=n.LineSegments[0].start.x+r*a*s.x,f[4]=n.LineSegments[0].start.y+r*a*s.y,f[5]=0,t==C.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(f[3],f[4],f[5]));var l=C.createContour(f);C.OpMeasure.rootObject.add(l),n.lineobj=l,n.textPos=new THREE.Vector3((f[0]+f[3])/2,(f[1]+f[4])/2,0),n.dimString=(r-i)*a}else{for(var i=0,d=0,r=n.LineSegments.length-1,c=1,o=0;o<n.intersectPos.length;++o){if((n.intersectMouse.edgeIndex>i||n.intersectMouse.edgeIndex==i&&n.intersectMouse.Pos>d)&&(n.intersectMouse.edgeIndex<n.intersectPos[o].edgeIndex||n.intersectMouse.edgeIndex==n.intersectPos[o].edgeIndex&&n.intersectMouse.Pos<n.intersectPos[o].Pos)){r=n.intersectPos[o].edgeIndex,c=n.intersectPos[o].Pos;break}(n.intersectPos[o].edgeIndex<r||n.intersectPos[o].Pos<1)&&(i=n.intersectPos[o].edgeIndex,d=n.intersectPos[o].Pos)}var h=0,u=n.intersectPos.length-1;n.start.distanceTo(n.end)<1e-6&&0==i&&0==d&&-1<u?h=n.LineSegments.length-n.intersectPos[u].edgeIndex:n.start.distanceTo(n.end)<1e-6&&r==n.LineSegments.length-1&&1==c&&-1<u&&(h=n.intersectPos[0].edgeIndex+1);for(var f=[],p=0,m=0,o=i;o<=r;++o,++p){var g=n.LineSegments[o].start.clone(),s=(v=n.LineSegments[o].end.clone()).clone().sub(g).normalize();o==i&&(a=g.distanceTo(v),g.x+=d*a*s.x,g.y+=d*a*s.y),o==r&&(a=g.distanceTo(v),v.x=g.x+c*a*s.x,v.y=g.y+c*a*s.y),o==parseInt((i+r)/2)&&(n.textPos=new THREE.Vector3((g.x+v.x)/2,(g.y+v.y)/2,0)),f[6*p+0]=g.x,f[6*p+1]=g.y,f[6*p+2]=0,f[6*p+3]=v.x,f[6*p+4]=v.y,f[6*p+5]=0,m+=g.distanceTo(v)}if(0<h)if(0==i&&0==d)for(o=n.intersectPos[u].edgeIndex;o<n.LineSegments.length;++o,++p){g=n.LineSegments[o].start.clone(),s=(v=n.LineSegments[o].end.clone()).clone().sub(g).normalize();o==n.intersectPos[u].edgeIndex&&(a=g.distanceTo(v),g.x+=n.intersectPos[u].Pos*a*s.x,g.y+=n.intersectPos[u].Pos*a*s.y),f[6*p+0]=g.x,f[6*p+1]=g.y,f[6*p+2]=0,f[6*p+3]=v.x,f[6*p+4]=v.y,f[6*p+5]=0,m+=g.distanceTo(v)}else for(o=0;o<=n.intersectPos[0].edgeIndex;++o,++p){var v,g=n.LineSegments[o].start.clone(),s=(v=n.LineSegments[o].end.clone()).clone().sub(g).normalize();o==n.intersectPos[0].edgeIndex&&(a=g.distanceTo(v),v.x=g.x+n.intersectPos[0].Pos*a*s.x,v.y=g.y+n.intersectPos[0].Pos*a*s.y),f[6*p+0]=g.x,f[6*p+1]=g.y,f[6*p+2]=0,f[6*p+3]=v.x,f[6*p+4]=v.y,f[6*p+5]=0,m+=g.distanceTo(v)}t==C.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(f[6*(p-1)+3],f[6*(p-1)+4],f[6*(p-1)+5]));l=C.createContour(f);C.OpMeasure.rootObject.add(l),n.lineobj=l,n.dimString=m}var y=parseFloat(n.dimString),h=C.viewer.getDispalyModelUnit(y);y*=h.scale,C.lineContoursInfo.unit=C.getUnitStringmap(h.unit),C.lineContoursInfo.perimeter+=y;var E=(parseFloat(y)*C.viewer.measuringScale).toFixed(2);E+=C.lineContoursInfo.unit,n.textBox.style.display="inline",C.getAndShowTextBox(n.textPos.clone(),E,n.textBox),(x={}).dimString=E,x.textPos=n.textPos.clone(),x.textBox=n.textBox,x.textBox.setAttribute("type","length"),x.textBox.setAttribute("dimString",n.dimString),x.textBox.setAttribute("unit",C.lineContoursInfo.unit);for(var b=0;b<C.OpMeasure.boxInfos.length;b++)C.OpMeasure.boxInfos[b].textPos.distanceTo(x.textPos)<1e-4&&(x.textPos.y+=3);C.OpMeasure.boxInfos.push(x)}var M=document.createElement("div");M.className="mearesult",C.viewer.container.appendChild(M);var x,E=(C.lineContoursInfo.perimeter*C.viewer.measuringScale).toFixed(2);E+=C.lineContoursInfo.unit,E="en"==ye.getLanguage()?"overall length:"+E:"总长:"+E,C.getAndShowTextBox(e.clone(),E,M),(x={}).dimString=E,x.textPos=e.clone(),x.textBox=M,x.textBox.setAttribute("type","perimeter"),x.textBox.setAttribute("dimString",C.lineContoursInfo.perimeter),x.textBox.setAttribute("unit",C.lineContoursInfo.unit);for(b=0;b<C.OpMeasure.boxInfos.length;b++)C.OpMeasure.boxInfos[b].textPos.distanceTo(x.textPos)<1e-4&&(x.textPos.y+=3);C.OpMeasure.boxInfos.push(x),C.clearContoursInfo(!0),C.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE),ye.isMobileDevice()&&C.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&C.viewer.dispatchEvent({type:"broadcastEvent"})}},n.onclick=function(){if(0!=C.lineContoursInfo.Contours.length){var e=null,t=C.lineContoursInfo.Contours.length-1,e=C.lineContoursInfo.Contours.pop();if(0<t)if(C.lineContoursInfo.divPos=C.lineContoursInfo.Contours[t-1].textPos,e.start.equals(C.lineContoursInfo.start))for(var n=0;n<C.lineContoursInfo.Contours.length;++n)(i=C.lineContoursInfo.Contours[n]).start.distanceTo(e.end)&&C.lineContoursInfo.start.copy(i.start);else for(var i,n=0;n<C.lineContoursInfo.Contours.length;++n)(i=C.lineContoursInfo.Contours[n]).end.distanceTo(e.start)&&C.lineContoursInfo.end.copy(i.end);0==C.lineContoursInfo.Contours.length?(ye.isMobileDevice()?(C.contourdiv.children[0].className="arrow-prev no",C.contourdiv.children[1].className="continuityLength-btn no"):C.contourdiv.style.display="none",C.lineContoursInfo.preSelLineInfo=null,C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.prestart=new THREE.Vector2,C.lineContoursInfo.preend=new THREE.Vector2,C.lineContoursInfo.divPos=null,C.lineContoursInfo.start=new THREE.Vector2,C.lineContoursInfo.end=new THREE.Vector2):1==C.lineContoursInfo.Contours.length&&(C.lineContoursInfo.start.copy(C.lineContoursInfo.Contours[0].start),C.lineContoursInfo.end.copy(C.lineContoursInfo.Contours[0].end)),C.OpMeasure.rootObject.remove(e.lineobj),C.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)}},ye.isMobileDevice()||(i.onclick=function(){C.contourdiv.style.display="none",C.lineContoursInfo.preSelLineInfo=null,C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.prestart=new THREE.Vector2,C.lineContoursInfo.preend=new THREE.Vector2,C.lineContoursInfo.divPos=null;for(var e=0;e<C.lineContoursInfo.Contours.length;++e)C.OpMeasure.rootObject.remove(C.lineContoursInfo.Contours[e].lineobj);C.lineContoursInfo.Contours=[],C.lineContoursInfo.start=new THREE.Vector2,C.lineContoursInfo.end=new THREE.Vector2,C.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)},this.contourdiv.style.display="none"),this.contourdiv.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),C.lineContoursInfo.preSelLineObj&&(C.OpMeasure.rootObject.remove(C.lineContoursInfo.preSelLineObj),C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.preSelLineInfo=null)},this.viewer.container.appendChild(this.contourdiv)),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)):"contourarea"==e&&(this.contourdiv||((C=this).contourdiv=document.createElement("div"),ye.isMobileDevice()?(this.contourdiv.className="continuityLength-arrow",(n=document.createElement("span")).className="arrow-prev no",(t=document.createElement("a")).className="continuityLength-btn no","en"==ye.getLanguage()?t.innerHTML="confirm":t.innerHTML="确认",this.contourdiv.appendChild(n),this.contourdiv.appendChild(t)):(this.contourdiv.id="contour",this.contourdiv.style.position="absolute",this.contourdiv.style.zIndex=3,(t=document.createElement("img")).style.height="36px",t.style.width="36px",(n=document.createElement("img")).style.height="36px",n.style.width="36px",(i=document.createElement("img")).style.height="36px",i.style.width="36px"),t.onclick=function(){if(0!=C.lineContoursInfo.Contours.length){ye.isMobileDevice()&&C.ChangeMeasureFlag();var e=[],o=[],a=[],t=[];C.contourdiv.style.display="none";for(var n=0;n<C.lineContoursInfo.Contours.length;++n)if("circle"==(O=C.lineContoursInfo.Contours[n]).lineInfo.type&&O.LineSegments[0].start.distanceTo(O.LineSegments[O.LineSegments.length-1].end)<.002){var i=new THREE.Vector3(O.lineInfo.center[0],O.lineInfo.center[1],O.lineInfo.center[2]);i.applyMatrix4(O.lineInfo.matrixWorld);i={radius:O.lineInfo.radius,pos:i.toArray()};t.push(i)}else{C.OpMeasure.rootObject.remove(O.lineobj),O.lineobj=null;for(var r=0;r<O.LineSegments.length;++r){for(var s=O.LineSegments[r],l={},d=0;d<a.length;++d){var c=new THREE.Vector3;C.lineIntersection2D(s.start,s.end,a[d].start,a[d].end,c)&&((l[c.z]=c).z=d)}if(Object.keys(l).length<1)s.p1=o.length,o.push(s.start),s.p2=o.length,o.push(s.end),a.push(s);else{var h=[];h.push(s.start),Object.keys(l).sort(function(e,t){return e-t}).forEach(function(e){var t,n,i,r;0!=l[e].s&&1!=l[e].s&&(t=a[l[e].z],(r=new THREE.Vector2).set(l[e].x,l[e].y),(i=new P).start.set(t.start.x,t.start.y),i.end.set(l[e].x,l[e].y),i.p1=t.p1,-1<(n=C.getIndexFromPoints(r,o))?i.p2=n:(i.p2=o.length,n=i.p2,o.push(r)),a.push(i),(i=new P).start.set(l[e].x,l[e].y),i.end.set(t.end.x,t.end.y),i.p1=n,i.p2=t.p2,a.push(i),a[l[e].z]=null),0!=e&&1!=e&&((r=new THREE.Vector2).set(l[e].x,l[e].y),h.push(r))}),h.push(s.end);for(d=0;d<h.length-1;++d){var u=new P;u.start.set(h[d].x,h[d].y),u.end.set(h[d+1].x,h[d+1].y);var f=C.getIndexFromPoints(h[d],o);-1<f?u.p1=f:(u.p1=o.length,o.push(h[d])),-1<(f=C.getIndexFromPoints(h[d+1],o))?u.p2=f:(u.p2=o.length,o.push(h[d+1])),a.push(u)}}for(d=0;d<a.length;++d)a[d]||(a.splice(d,1),--d)}}var p=new THREE.Box2(o[0],o[1]),m=new NDS.Triangulator.ContourSet(a,p);m.sanitizeEdges(),m.stitchContoursCheng();for(var g=0;g<m.contours.length;g++){var v=m.contours[g];if(v[0]==v[v.length-1]){for(var y=0,E=new THREE.Vector2,b=[],M=1;M<v.length;M++){var x=o[v[M-1]],w=o[v[M]];b[6*(M-1)+0]=x.x,b[6*(M-1)+1]=x.y,b[6*(M-1)+2]=0,b[6*(M-1)+3]=w.x,b[6*(M-1)+4]=w.y,b[6*(M-1)+5]=0,y+=(x.x*w.y-x.y*w.x)/2,E.add(x)}var I=C.createContour(b);C.OpMeasure.rootObject.add(I),E.divideScalar(v.length-1);y=Math.abs(y);(T=document.createElement("div")).className="mearesult",C.viewer.container.appendChild(T),y=y*(A=C.viewer.getDispalyModelUnit(y)).scale*A.scale,C.lineContoursInfo.unit=C.getUnitStringmap(A.unit);var S=(y*Math.pow(C.viewer.measuringScale,2)).toFixed(2);S="en"==ye.getLanguage()?"area: "+S+C.lineContoursInfo.unit+"²":"面积: "+S+C.lineContoursInfo.unit+"²",(R={}).dimString=S,R.textPos=new THREE.Vector3(E.x,E.y,0),R.textBox=T,R.textBox.setAttribute("type","area"),R.textBox.setAttribute("dimString",y),R.textBox.setAttribute("unit",C.lineContoursInfo.unit+"²");for(d=0;d<C.OpMeasure.boxInfos.length;d++)C.OpMeasure.boxInfos[d].textPos.distanceTo(R.textPos)<1e-4&&R.textBox.setAttribute("needDown","true");for(d=0;d<e.length;d++)e[d].textPos.distanceTo(R.textPos)<1e-4&&R.textBox.setAttribute("needDown","true");e.push(R)}}for(var T,A,g=0;g<t.length;++g){y=Math.pow(t[g].radius,2)*Math.PI,(T=document.createElement("div")).className="mearesult",C.viewer.container.appendChild(T),y=y*(A=C.viewer.getDispalyModelUnit(y)).scale*A.scale,C.lineContoursInfo.unit=C.getUnitStringmap(A.unit);var R,S=(y*Math.pow(C.viewer.measuringScale,2)).toFixed(2);S="en"==ye.getLanguage()?"area: "+S+C.lineContoursInfo.unit+"²":"面积: "+S+C.lineContoursInfo.unit+"²",(R={}).dimString=S,R.textPos=new THREE.Vector3(t[g].pos[0],t[g].pos[1],0),R.textBox=T,R.textBox.setAttribute("type","area"),R.textBox.setAttribute("dimString",y),R.textBox.setAttribute("unit",C.lineContoursInfo.unit+"²");for(d=0;d<C.OpMeasure.boxInfos.length;d++)C.OpMeasure.boxInfos[d].textPos.distanceTo(R.textPos)<1e-4&&R.textBox.setAttribute("needDown","true");for(d=0;d<e.length;d++)e[d].textPos.distanceTo(R.textPos)<1e-4&&R.textBox.setAttribute("needDown","true");e.push(R)}if(0<e.length)C.OpMeasure.boxInfos=C.OpMeasure.boxInfos.concat(e);else{C.OpMeasure.PostInfo(NDS.INFOTYPE.NOCLOSE);for(n=0;n<C.lineContoursInfo.Contours.length;++n){var O=C.lineContoursInfo.Contours[n];C.OpMeasure.rootObject.remove(O.lineobj)}}C.clearContoursInfo(!0),Ue.enableBroadcast&&Ue.broadcastMajor&&C.viewer.dispatchEvent({type:"broadcastEvent"})}function P(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}},n.onclick=function(){var e,t;0!=C.lineContoursInfo.Contours.length&&(t=null,e=C.lineContoursInfo.Contours.length-1,t=C.lineContoursInfo.Contours.pop(),0<e&&(C.lineContoursInfo.divPos=C.lineContoursInfo.Contours[e-1].textPos),0==C.lineContoursInfo.Contours.length&&(ye.isMobileDevice()?(C.contourdiv.children[0].className="arrow-prev no",C.contourdiv.children[1].className="continuityLength-btn no"):C.contourdiv.style.display="none",C.lineContoursInfo.preSelLineInfo=null,C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.prestart=new THREE.Vector2,C.lineContoursInfo.preend=new THREE.Vector2,C.lineContoursInfo.divPos=null,C.lineContoursInfo.start=new THREE.Vector2,C.lineContoursInfo.end=new THREE.Vector2),C.OpMeasure.rootObject.remove(t.lineobj))},ye.isMobileDevice()||(i.onclick=function(){C.contourdiv.style.display="none",C.lineContoursInfo.preSelLineInfo=null,C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.prestart=new THREE.Vector2,C.lineContoursInfo.preend=new THREE.Vector2,C.lineContoursInfo.divPos=null;for(var e=0;e<C.lineContoursInfo.Contours.length;++e)C.OpMeasure.rootObject.remove(C.lineContoursInfo.Contours[e].lineobj);C.lineContoursInfo.Contours=[],C.lineContoursInfo.start=new THREE.Vector2,C.lineContoursInfo.end=new THREE.Vector2},this.contourdiv.style.display="none"),this.contourdiv.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),C.lineContoursInfo.preSelLineObj&&(C.OpMeasure.rootObject.remove(C.lineContoursInfo.preSelLineObj),C.lineContoursInfo.preSelLineObj=null,C.lineContoursInfo.preSelLineInfo=null)},this.viewer.container.appendChild(this.contourdiv)),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE))},at.prototype.measureEnd=function(){var e=this;if("contour"==this.measureType){if(0==this.lineContoursInfo.Contours.length)return;this.contourdiv.style.display="none";for(var t=null,n=this.lineContoursInfo.perimeter=0;n<this.lineContoursInfo.Contours.length;++n){var i=this.lineContoursInfo.Contours[n];if(this.OpMeasure.rootObject.remove(i.lineobj),1==i.LineSegments.length){for(var r=0,o=1,a=0;a<i.intersectPos.length;++a){if(i.intersectMouse.Pos>=r&&i.intersectMouse.Pos<=i.intersectPos[a].Pos){o=i.intersectPos[a].Pos;break}r=i.intersectPos[a].Pos}var s=i.LineSegments[0].start.distanceTo(i.LineSegments[0].end),l=i.LineSegments[0].end.clone().sub(i.LineSegments[0].start).normalize();(p=[])[0]=i.LineSegments[0].start.x+r*s*l.x,p[1]=i.LineSegments[0].start.y+r*s*l.y,p[2]=0,p[3]=i.LineSegments[0].start.x+o*s*l.x,p[4]=i.LineSegments[0].start.y+o*s*l.y,p[5]=0,n==this.lineContoursInfo.Contours.length-1&&(t=new THREE.Vector3(p[3],p[4],p[5]));var d=this.createContour(p);this.OpMeasure.rootObject.add(d),i.lineobj=d,i.textPos=new THREE.Vector3((p[0]+p[3])/2,(p[1]+p[4])/2,0),i.dimString=(o-r)*s}else{for(var r=0,c=0,o=i.LineSegments.length-1,h=1,a=0;a<i.intersectPos.length;++a){if((i.intersectMouse.edgeIndex>r||i.intersectMouse.edgeIndex==r&&i.intersectMouse.Pos>c)&&(i.intersectMouse.edgeIndex<i.intersectPos[a].edgeIndex||i.intersectMouse.edgeIndex==i.intersectPos[a].edgeIndex&&i.intersectMouse.Pos<i.intersectPos[a].Pos)){o=i.intersectPos[a].edgeIndex,h=i.intersectPos[a].Pos;break}(i.intersectPos[a].edgeIndex<o||i.intersectPos[a].Pos<1)&&(r=i.intersectPos[a].edgeIndex,c=i.intersectPos[a].Pos)}var u=0,f=i.intersectPos.length-1;i.start.distanceTo(i.end)<1e-6&&0==r&&0==c&&-1<f?u=i.LineSegments.length-i.intersectPos[f].edgeIndex:i.start.distanceTo(i.end)<1e-6&&o==i.LineSegments.length-1&&1==h&&-1<f&&(u=i.intersectPos[0].edgeIndex+1);for(var p=[],m=0,g=0,a=r;a<=o;++a,++m){var v=i.LineSegments[a].start.clone(),l=(y=i.LineSegments[a].end.clone()).clone().sub(v).normalize();a==r&&(s=v.distanceTo(y),v.x+=c*s*l.x,v.y+=c*s*l.y),a==o&&(s=v.distanceTo(y),y.x=v.x+h*s*l.x,y.y=v.y+h*s*l.y),a==parseInt((r+o)/2)&&(i.textPos=new THREE.Vector3((v.x+y.x)/2,(v.y+y.y)/2,0)),p[6*m+0]=v.x,p[6*m+1]=v.y,p[6*m+2]=0,p[6*m+3]=y.x,p[6*m+4]=y.y,p[6*m+5]=0,g+=v.distanceTo(y)}if(0<u)if(0==r&&0==c)for(a=i.intersectPos[f].edgeIndex;a<i.LineSegments.length;++a,++m){v=i.LineSegments[a].start.clone(),l=(y=i.LineSegments[a].end.clone()).clone().sub(v).normalize();a==i.intersectPos[f].edgeIndex&&(s=v.distanceTo(y),v.x+=i.intersectPos[f].Pos*s*l.x,v.y+=i.intersectPos[f].Pos*s*l.y),p[6*m+0]=v.x,p[6*m+1]=v.y,p[6*m+2]=0,p[6*m+3]=y.x,p[6*m+4]=y.y,p[6*m+5]=0,g+=v.distanceTo(y)}else for(a=0;a<=i.intersectPos[0].edgeIndex;++a,++m){var y,v=i.LineSegments[a].start.clone(),l=(y=i.LineSegments[a].end.clone()).clone().sub(v).normalize();a==i.intersectPos[0].edgeIndex&&(s=v.distanceTo(y),y.x=v.x+i.intersectPos[0].Pos*s*l.x,y.y=v.y+i.intersectPos[0].Pos*s*l.y),p[6*m+0]=v.x,p[6*m+1]=v.y,p[6*m+2]=0,p[6*m+3]=y.x,p[6*m+4]=y.y,p[6*m+5]=0,g+=v.distanceTo(y)}n==this.lineContoursInfo.Contours.length-1&&(t=new THREE.Vector3(p[6*(m-1)+3],p[6*(m-1)+4],p[6*(m-1)+5]));d=this.createContour(p);this.OpMeasure.rootObject.add(d),i.lineobj=d,i.dimString=g}u=parseFloat(i.dimString);u*=(G=this.viewer.getDispalyModelUnit(u)).scale,this.lineContoursInfo.unit=this.getUnitStringmap(G.unit),this.lineContoursInfo.perimeter+=u;var E=(u*this.viewer.measuringScale).toFixed(2);E+=this.lineContoursInfo.unit,i.textBox.style.display="inline",this.getAndShowTextBox(i.textPos.clone(),E,i.textBox),(W={}).dimString=E,W.textPos=i.textPos.clone(),W.textBox=i.textBox,W.textBox.setAttribute("type","length"),W.textBox.setAttribute("dimString",u),W.textBox.setAttribute("unit",this.lineContoursInfo.unit);for(var b=0;b<this.OpMeasure.boxInfos.length;b++)this.OpMeasure.boxInfos[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");this.OpMeasure.boxInfos.push(W)}(z=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(z);E=(this.lineContoursInfo.perimeter*this.viewer.measuringScale).toFixed(2);E+=this.lineContoursInfo.unit,E="en"==ye.getLanguage()?"overall length:"+E:"总长:"+E,this.getAndShowTextBox(t.clone(),E,z),(W={}).dimString=E,W.textPos=t.clone(),W.textBox=z,W.textBox.setAttribute("type","perimeter"),W.textBox.setAttribute("dimString",this.lineContoursInfo.perimeter),W.textBox.setAttribute("unit",this.lineContoursInfo.unit);for(b=0;b<this.OpMeasure.boxInfos.length;b++)this.OpMeasure.boxInfos[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");this.OpMeasure.boxInfos.push(W),this.clearContoursInfo(!0),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE),ye.isMobileDevice()&&this.ChangeMeasureFlag(),Ue.enableBroadcast&&Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})}else if("contourarea"==this.measureType){var M,x,w,I,S,T,A,R,O,P,C,B,L,D,H,N,F,_,k,V,j,U,z,G,W,Y=function(){function o(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}if(0==e.lineContoursInfo.Contours.length)return{v:void 0};for(M=function(e,t){return(e.x*t.y-e.y*t.x)/2},ye.isMobileDevice()&&e.ChangeMeasureFlag(),x=[],w=[],I=[],S=[],e.contourdiv.style.display="none",n=0;n<e.lineContoursInfo.Contours.length;++n)if("circle"==(i=e.lineContoursInfo.Contours[n]).lineInfo.type&&i.LineSegments[0].start.distanceTo(i.LineSegments[i.LineSegments.length-1].end)<.002)(T=new THREE.Vector3(i.lineInfo.center[0],i.lineInfo.center[1],i.lineInfo.center[2])).applyMatrix4(i.lineInfo.matrixWorld),T={radius:i.lineInfo.radius,pos:T.toArray()},S.push(T);else for(e.OpMeasure.rootObject.remove(i.lineobj),i.lineobj=null,a=0;a<i.LineSegments.length;++a){for(A=i.LineSegments[a],R={},b=0;b<I.length;++b)O=new THREE.Vector3,e.lineIntersection2D(A.start,A.end,I[b].start,I[b].end,O)&&((R[O.z]=O).z=b);if(Object.keys(R).length<1)A.p1=w.length,w.push(A.start),A.p2=w.length,w.push(A.end),I.push(A);else for((P=[]).push(A.start),C=e,Object.keys(R).sort(function(e,t){return e-t}).forEach(function(e){var t,n,i,r;0!=R[e].s&&1!=R[e].s&&(t=I[R[e].z],(r=new THREE.Vector2).set(R[e].x,R[e].y),(i=new o).start.set(t.start.x,t.start.y),i.end.set(R[e].x,R[e].y),i.p1=t.p1,-1<(n=C.getIndexFromPoints(r,w))?i.p2=n:(i.p2=w.length,n=i.p2,w.push(r)),I.push(i),(i=new o).start.set(R[e].x,R[e].y),i.end.set(t.end.x,t.end.y),i.p1=n,i.p2=t.p2,I.push(i),I[R[e].z]=null),0!=e&&1!=e&&((r=new THREE.Vector2).set(R[e].x,R[e].y),P.push(r))}),P.push(A.end),b=0;b<P.length-1;++b)(B=new o).start.set(P[b].x,P[b].y),B.end.set(P[b+1].x,P[b+1].y),-1<(L=e.getIndexFromPoints(P[b],w))?B.p1=L:(B.p1=w.length,w.push(P[b])),-1<(L=e.getIndexFromPoints(P[b+1],w))?B.p2=L:(B.p2=w.length,w.push(P[b+1])),I.push(B);for(b=0;b<I.length;++b)I[b]||(I.splice(b,1),--b)}for(D=new THREE.Box2(w[0],w[1]),(H=new NDS.Triangulator.ContourSet(I,D)).sanitizeEdges(),H.stitchContoursCheng(),U=0;U<H.contours.length;U++)if((N=H.contours[U])[0]==N[N.length-1]){for(F=0,_=new THREE.Vector2,p=[],k=1;k<N.length;k++)V=w[N[k-1]],j=w[N[k]],p[6*(k-1)+0]=V.x,p[6*(k-1)+1]=V.y,p[6*(k-1)+2]=0,p[6*(k-1)+3]=j.x,p[6*(k-1)+4]=j.y,p[6*(k-1)+5]=0,F+=M(V,j),_.add(V);for(d=e.createContour(p),e.OpMeasure.rootObject.add(d),_.divideScalar(N.length-1),F=Math.abs(F),(z=document.createElement("div")).className="mearesult",e.viewer.container.appendChild(z),G=e.viewer.getDispalyModelUnit(F),F=F*G.scale*G.scale,e.lineContoursInfo.unit=e.getUnitStringmap(G.unit),E=(F*Math.pow(e.viewer.measuringScale,2)).toFixed(2),E="en"==ye.getLanguage()?"area: "+E+e.lineContoursInfo.unit+"²":"面积: "+E+e.lineContoursInfo.unit+"²",(W={}).dimString=E,W.textPos=new THREE.Vector3(_.x,_.y,0),W.textBox=z,W.textBox.setAttribute("type","area"),W.textBox.setAttribute("dimString",F),W.textBox.setAttribute("unit",e.lineContoursInfo.unit+"²"),b=0;b<e.OpMeasure.boxInfos.length;b++)e.OpMeasure.boxInfos[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");for(b=0;b<x.length;b++)x[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");x.push(W)}for(U=0;U<S.length;++U){for(F=Math.pow(S[U].radius,2)*Math.PI,(z=document.createElement("div")).className="mearesult",e.viewer.container.appendChild(z),G=e.viewer.getDispalyModelUnit(F),F=F*G.scale*G.scale,e.lineContoursInfo.unit=e.getUnitStringmap(G.unit),E=(F*Math.pow(e.viewer.measuringScale,2)).toFixed(2),E="en"==ye.getLanguage()?"area: "+E+e.lineContoursInfo.unit+"²":"面积: "+E+e.lineContoursInfo.unit+"²",(W={}).dimString=E,W.textPos=new THREE.Vector3(S[U].pos[0],S[U].pos[1],0),W.textBox=z,W.textBox.setAttribute("type","area"),W.textBox.setAttribute("dimString",F),W.textBox.setAttribute("unit",e.lineContoursInfo.unit+"²"),b=0;b<e.OpMeasure.boxInfos.length;b++)e.OpMeasure.boxInfos[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");for(b=0;b<x.length;b++)x[b].textPos.distanceTo(W.textPos)<1e-4&&W.textBox.setAttribute("needDown","true");x.push(W)}if(0<x.length)e.OpMeasure.boxInfos=e.OpMeasure.boxInfos.concat(x);else for(e.OpMeasure.PostInfo(NDS.INFOTYPE.NOCLOSE),n=0;n<e.lineContoursInfo.Contours.length;++n)i=e.lineContoursInfo.Contours[n],e.OpMeasure.rootObject.remove(i.lineobj);e.clearContoursInfo(!0),Ue.enableBroadcast&&Ue.broadcastMajor&&e.viewer.dispatchEvent({type:"broadcastEvent"})}();if("object"===nt(Y))return Y.v}Ue.enableBroadcast&&Ue.broadcastMajor&&this.OpMeasure.addmeasureTimes()},at.prototype.onNMouseMove=function(e,t){this.measureContour(e,t,!0)},at.prototype.onLMouseClick=function(e,t,n){this.measureContour(e,t,!1)},at.prototype.lineIntersection2D=function(e,t,n,i,r){if(e.distanceTo(n)<.002)return null!=r&&(r.x=e.x,r.y=e.y,r.z=0,r.s=0),!0;if(t.distanceTo(n)<.002)return null!=r&&(r.x=t.x,r.y=t.y,r.z=1,r.s=0),!0;if(e.distanceTo(i)<.002)return null!=r&&(r.x=e.x,r.y=e.y,r.z=0,r.s=1),!0;if(t.distanceTo(i)<.002)return null!=r&&(r.x=t.x,r.y=t.y,r.z=1,r.s=1),!0;if(Math.abs((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x))<.002)return!1;var o=((e.y-n.y)*(i.x-n.x)-(e.x-n.x)*(i.y-n.y))/((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x)),n=((e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y))/((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x));return 0<=o&&o<=1&&0<=n&&n<=1&&(null!=r&&(r.x=e.x+o*(t.x-e.x),r.y=e.y+o*(t.y-e.y),r.z=o,r.s=n),!0)},at.prototype.getIndexFromPoints=function(e,t){for(var n=0;n<t.length;++n){var i=t[n];if(e.distanceTo(i)<.002)return n}return-1},at.prototype.measureContour=function(e,t,n){""==this.lineContoursInfo.unit&&(this.lineContoursInfo.unit=this.getUnitString());var i=this.viewer,r=this.doRaycasterPick(e,t,!0);if(!r||0==r.length)return this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null),void this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE);r=r[0];if(r){var o=this.getSelectInfoFromIntersect(r);if(o){if("line"==o.type&&!this.Bline(o))return void(this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null));this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,o)||(this.lineContoursInfo.preSelLineInfo=o,this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null),h=o.geometry,(j=o.indexRange.concat())[0]+=h.drawRange.start/2,j[1]+=h.drawRange.start/2,h.isBufferGeometry&&(u=h.index,f=h.attributes.position.array,null!=u&&(p=u.array,w=j[0],I=j[1],this.lineContoursInfo.prestart.fromArray(f,3*p[2*w]),this.lineContoursInfo.preend.fromArray(f,3*p[2*I+1]))),n&&(c=this.createLine(this.lineContoursInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(c),this.lineContoursInfo.preSelLineObj=c))}}if(this.lineContoursInfo.preSelLineInfo&&n){for(var a=0;a<this.lineContoursInfo.Contours.length;++a){var s=this.lineContoursInfo.Contours[a];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,s.lineInfo)&&"contourarea"===this.measureType)return void this.OpMeasure.PostInfo(NDS.INFOTYPE.CANCELLINE)}if("contour"===this.measureType&&0<this.lineContoursInfo.Contours.length){s=this.lineContoursInfo.Contours[this.lineContoursInfo.Contours.length-1];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,s.lineInfo))return void this.OpMeasure.PostInfo(NDS.INFOTYPE.CANCELLINE)}}if(this.lineContoursInfo.preSelLineInfo&&!n){this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null);var r=this.lineContoursInfo.Contours.length-1,l=null;if("contour"===this.measureType&&0<=r){s=this.lineContoursInfo.Contours[r];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,s.lineInfo)){if(l=this.lineContoursInfo.Contours.pop(),0<r)if(this.lineContoursInfo.divPos=this.lineContoursInfo.Contours[r-1].textPos,l.start.equals(this.lineContoursInfo.start))for(var d=0;d<this.lineContoursInfo.Contours.length;++d)(s=this.lineContoursInfo.Contours[d]).start.equals(l.end)&&this.lineContoursInfo.start.copy(s.start);else for(d=0;d<this.lineContoursInfo.Contours.length;++d)(s=this.lineContoursInfo.Contours[d]).end.equals(l.start)&&this.lineContoursInfo.end.copy(s.end);return 0==this.lineContoursInfo.Contours.length?(this.contourdiv.style.display="none",this.lineContoursInfo.preSelLineInfo=null,this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.prestart=new THREE.Vector2,this.lineContoursInfo.preend=new THREE.Vector2,this.lineContoursInfo.divPos=null,this.lineContoursInfo.start=new THREE.Vector2,this.lineContoursInfo.end=new THREE.Vector2):1==this.lineContoursInfo.Contours.length&&(this.lineContoursInfo.start.copy(this.lineContoursInfo.Contours[0].start),this.lineContoursInfo.end.copy(this.lineContoursInfo.Contours[0].end)),this.OpMeasure.rootObject.remove(l.lineobj),void(this.lineContoursInfo.preSelLineInfo=null)}}for(a=0;a<this.lineContoursInfo.Contours.length;++a){s=this.lineContoursInfo.Contours[a];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,s.lineInfo)){if("contourarea"===this.measureType)return l=this.lineContoursInfo.Contours.splice(a,1)[0],this.OpMeasure.rootObject.remove(l.lineobj),void(this.lineContoursInfo.preSelLineInfo=null);if("contour"===this.measureType)return void(this.lineContoursInfo.preSelLineInfo=null)}}o=this.viewer.renderer.getPixelRatio();ye.isMobileDevice()?(this.contourdiv.children[0].className="arrow-prev",this.contourdiv.children[1].className="continuityLength-btn"):(this.contourdiv.style.left=Math.round(e/o)+"px",this.contourdiv.style.top=Math.round(t/o)+"px"),this.contourdiv.style.display="inline";n=(i=this.viewer).renderer.domElement,r=new THREE.Raycaster;i.camera.setCastRay(r,e*o/n.width*2-1,2*-(t*o/n.height)+1);o=new THREE.Plane(new THREE.Vector3(0,0,-1),0),n=new THREE.Vector3;if(r.ray.intersectPlane(o,n),"contourarea"===this.measureType){n&&(this.lineContoursInfo.divPos=n);var c=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(c),(S=new ot).dimString=this.lineContoursInfo.preSelLineInfo.length,S.lineobj=c,S.lineInfo=this.lineContoursInfo.preSelLineInfo;var h=S.lineInfo.geometry;if((j=S.lineInfo.indexRange.concat())[0]+=h.drawRange.start/2,j[1]+=h.drawRange.start/2,h.isBufferGeometry){var u=h.index,f=h.attributes.position.array;if(null!=u)for(var p=u.array,m=0,g=w=j[0],v=I=j[1];g<=v;g++,m+=1){var y=p[2*g],E=p[2*g+1],b=new THREE.Vector3,M=new THREE.Vector3;b.fromArray(f,3*y),M.fromArray(f,3*E),b.applyMatrix4(S.lineInfo.matrixWorld),M.applyMatrix4(S.lineInfo.matrixWorld),(U=new it).start.set(b.x,b.y),U.end.set(M.x,M.y),S.LineSegments.push(U),M=b=null}}S.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),S.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),S.textPos=new THREE.Vector3((S.start.x+S.end.x)/2,(S.start.y+S.end.y)/2,0),this.lineContoursInfo.Contours.push(S),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)}else if("contour"===this.measureType)if(0==this.lineContoursInfo.Contours.length){n&&(this.lineContoursInfo.divPos=n);c=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(c),(S=new ot).dimString=this.lineContoursInfo.preSelLineInfo.length,S.lineobj=c,S.lineInfo=this.lineContoursInfo.preSelLineInfo,(V=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(V),S.textBox=V;h=S.lineInfo.geometry;if((j=S.lineInfo.indexRange.concat())[0]+=h.drawRange.start/2,j[1]+=h.drawRange.start/2,h.isBufferGeometry){u=h.index,f=h.attributes.position.array;if(null!=u)for(p=u.array,m=0,g=w=j[0],v=I=j[1];g<=v;g++,m+=1){y=p[2*g],E=p[2*g+1],b=new THREE.Vector3,M=new THREE.Vector3;b.fromArray(f,3*y),M.fromArray(f,3*E),b.x!=M.x||b.y!=M.y?(b.applyMatrix4(S.lineInfo.matrixWorld),M.applyMatrix4(S.lineInfo.matrixWorld),O=S.lineInfo.intersect.clone().sub(b).normalize(),P=M.clone().sub(b).normalize(),O.distanceTo(P)<1e-6&&null==S.intersectMouse&&0<=(A=new THREE.Line3(b,M).closestPointToPointParameter(S.lineInfo.intersect,!1))&&A<=1&&((L=new rt).edgeIndex=m,L.Pos=A,S.intersectMouse=L),(U=new it).start.set(b.x,b.y),U.end.set(M.x,M.y),S.LineSegments.push(U),M=b=null):(m--,M=b=null)}}S.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),S.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),S.textPos=new THREE.Vector3((S.start.x+S.end.x)/2,(S.start.y+S.end.y)/2,0),this.lineContoursInfo.Contours.push(S),this.lineContoursInfo.start.copy(S.start),this.lineContoursInfo.end.copy(S.end),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)}else{h=this.lineContoursInfo.preSelLineInfo.geometry;(j=this.lineContoursInfo.preSelLineInfo.indexRange.concat())[0]+=h.drawRange.start/2,j[1]+=h.drawRange.start/2;var x=!1;if(h.isBufferGeometry){u=h.index,f=h.attributes.position.array;if(null!=u){for(var p=u.array,m=0,w=j[0],I=j[1],S=new ot,T=null,g=w,v=I;g<=v;g++,m+=1){y=p[2*g],E=p[2*g+1],b=new THREE.Vector3,M=new THREE.Vector3;if(b.fromArray(f,3*y),M.fromArray(f,3*E),b.x!=M.x||b.y!=M.y){b.applyMatrix4(this.lineContoursInfo.preSelLineInfo.matrixWorld),M.applyMatrix4(this.lineContoursInfo.preSelLineInfo.matrixWorld);var A,R,O=this.lineContoursInfo.preSelLineInfo.intersect.clone().sub(b).normalize(),P=M.clone().sub(b).normalize();O.distanceTo(P)<1e-6&&null==T&&0<=(A=new THREE.Line3(b,M).closestPointToPointParameter(this.lineContoursInfo.preSelLineInfo.intersect,!1))&&A<=1&&((R=new rt).edgeIndex=m,R.Pos=A,T=R);for(var C=0;C<this.lineContoursInfo.Contours.length;++C)for(var B=this.lineContoursInfo.Contours[C],d=0;d<B.LineSegments.length;++d){var L,l=B.LineSegments[d],D=new THREE.Vector2(b.x,b.y),H=new THREE.Vector2(M.x,M.y),N=new THREE.Vector3;if(this.lineIntersection2D(D,H,l.start,l.end,N)){(L=new rt).edgeIndex=m,L.Pos=N.z;for(var F=!1,_=0;_<S.intersectPos.length;++_){if(S.intersectPos[_].edgeIndex>L.edgeIndex){S.intersectPos.splice(_,0,L),F=!0;break}if(S.intersectPos[_].edgeIndex==L.edgeIndex&&S.intersectPos[_].Pos>L.Pos){S.intersectPos.splice(_,0,L),F=!0;break}}F||S.intersectPos.push(L);var k=new rt;k.edgeIndex=d,k.Pos=N.s;for(F=!1,_=0;_<B.intersectPos.length;++_){if(B.intersectPos[_].edgeIndex>k.edgeIndex){B.intersectPos.splice(_,0,k),F=!0;break}if(B.intersectPos[_].edgeIndex==k.edgeIndex&&B.intersectPos[_].Pos>k.Pos){B.intersectPos.splice(_,0,k),F=!0;break}}F||B.intersectPos.push(k),x=!0}}M=b=null}else m--,M=b=null}if(x){n&&(this.lineContoursInfo.divPos=n);var V,c=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(c),S.intersectMouse=T,S.dimString=this.lineContoursInfo.preSelLineInfo.length,S.lineobj=c,S.lineInfo=this.lineContoursInfo.preSelLineInfo,(V=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(V),S.textBox=V;var j,h=S.lineInfo.geometry;if((j=S.lineInfo.indexRange.concat())[0]+=h.drawRange.start/2,j[1]+=h.drawRange.start/2,h.isBufferGeometry){u=h.index,f=h.attributes.position.array;if(null!=u)for(p=u.array,m=0,g=w=j[0],v=I=j[1];g<=v;g++,m+=1){var U,y=p[2*g],E=p[2*g+1],b=new THREE.Vector3,M=new THREE.Vector3;b.fromArray(f,3*y),M.fromArray(f,3*E),b.x!=M.x||b.y!=M.y?(b.applyMatrix4(S.lineInfo.matrixWorld),M.applyMatrix4(S.lineInfo.matrixWorld),(U=new it).start.set(b.x,b.y),U.end.set(M.x,M.y),S.LineSegments.push(U),M=b=null):(m--,M=b=null)}}S.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),S.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),S.textPos=new THREE.Vector3((S.start.x+S.end.x)/2,(S.start.y+S.end.y)/2,0),this.lineContoursInfo.Contours.push(S),this.lineContoursInfo.start.copy(S.start),this.lineContoursInfo.end.copy(S.end),this.OpMeasure.PostInfo(NDS.INFOTYPE.CIRCLEANDLINE)}else this.OpMeasure.PostInfo(NDS.INFOTYPE.NOCONJOINT)}}}this.lineContoursInfo.preSelLineInfo=null}};function st(e){Xe.call(this,e),this.measureClass="Wall"}(st.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){this.measureType=e},st.prototype.onNMouseMove=function(e,t){t=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!ye.isMobileDevice()&&this.createAndShowDistanceDimension(t)},st.prototype.createWall=function(e,t){""==this.distanceInfo.unit&&(this.distanceInfo.unit=this.getUnitString());var n=this.viewer,i=n.renderer.domElement,r=n.renderer.getPixelRatio(),o=new THREE.Raycaster;n.camera.setCastRay(o,e*r/i.width*2-1,2*-(t*r/i.height)+1);t=this.getLinePrecision();o.linePrecision=t;r=null;if(!(r=n.ndsModel?n.ndsModel.intersect(o.ray,o.linePrecision/600):r)||!r[0].face)return null;i=r[0].meshId,t=this.viewer.ndsModel.meshManager;if(t.geomId[i]<0)return null;n=t.geomManager.getGeomFromId(t.geomId[i]);if(!n.loaded||n.index&&null==n.index.array)return null;o=t.bodyNodes[i];if(o.isHidden())return null;i=o.worldMatrix.clone(),o=t.ndsModel.getBodyTranslate(o);i.elements[12]+=o[0],i.elements[13]+=o[1],i.elements[14]+=o[2];o=new THREE.Matrix4;o.getInverse(i);var a=new THREE.Ray(r[0].point.applyMatrix4(o),r[0].face.normal.divideScalar(-1)),s=r[0],l=n.index;if(!l)return null;for(var d=n.attributes.position,c=new THREE.Vector3,h=new THREE.Vector3,u=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Face3,m=n.drawRange.start,g=n.drawRange.start+n.drawRange.count;m<g;m+=3){var v=l.getX(m),y=l.getX(m+1),E=l.getX(m+2);c.fromBufferAttribute(d,v),h.fromBufferAttribute(d,y),u.fromBufferAttribute(d,E),null!==a.intersectTriangle(u,h,c,!0,f)&&(p.a=v,p.b=y,p.c=E,p.normal=THREE.Triangle.normal(c,h,u),(E=a.origin.distanceTo(f))<s.distance&&s.faceIndex!=m/3&&(s.distance=E,s.point=f.clone()))}this.distanceInfo.firstSelInfo={type:"point",point:a.origin.applyMatrix4(i)},this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point,this.distanceInfo.secondSelInfo={type:"point",point:s.point.applyMatrix4(i)},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.distanceInfo.dimString=s.distance.toFixed(2);i=this.createPointMesh(this.distanceInfo.firstSelInfo.point,this.materialPoint,this.POINTSIZE);i&&(this.OpMeasure.rootObject.add(i),this.distanceInfo.firstSelObj=i);i=this.createPointMesh(this.distanceInfo.secondSelInfo.point,this.materialPoint,this.POINTSIZE);i&&(this.OpMeasure.rootObject.add(i),this.distanceInfo.secondSelObj=i)},st.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?this.createAndShowDistanceDimension(i,!0):(this.createWall(e,t),this.createAndShowDistanceDimension(i))};t=function(e){Xe.call(this,e),this.measureClass="Thickness"};(t.prototype=Object.create(Xe.prototype)).OperatorStart=function(e){},t.prototype.ClearPreSel=function(){this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelfInfo=null)},t.prototype.GetSelfInfoFromMouseXY=function(e,t){var n=null,i=null;if(!(n=this.doRaycasterPick(e,t,!1))||0==n.length)return this.ClearPreSel(),i;n=n[0];return i=n?this.getSelectInfoFromIntersect(n):i},t.prototype.onNMouseMove=function(e,t){t=this.GetSelfInfoFromMouseXY(e,t);t&&"face"===t.topolType&&(this.isTwoTopolInfoTheSame(this.distanceInfo.preSelInfo,t)||(this.distanceInfo.preSelInfo=t,this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null)),!this.distanceInfo.preSelInfo||this.distanceInfo.preSelObj||(t=this.createFace(this.distanceInfo.preSelInfo,!0))&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t))},t.prototype.onLMouseClick=function(e,t,n){var i,r,o;this.distanceInfo.firstSelObj?(r=this.GetSelfInfoFromMouseXY(e,t))&&"face"===r.topolType&&(this.ClearPreSel(),this.distanceInfo.secondSelInfo=r,(o=this.createFace(this.distanceInfo.firstSelInfo,!1))&&(this.OpMeasure.rootObject.add(o),this.distanceInfo.secondSelObj=o,0<(i=this.CalculateNearestFaceToFace(this.distanceInfo.firstSelInfo,this.distanceInfo.secondSelInfo)).distLen&&(this.distanceInfo.dimString=i.distLen.toFixed(2),new THREE.LineBasicMaterial({color:255,depthTest:!1}),this.distanceInfo.firstPoint=i.startP,this.distanceInfo.secondPoint=i.endP,this.viewer.is2DModel?this.createAndShowDistanceDimension():this.createAndShowMobileDistanceDimension(null,!0),this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.secondSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelInfo=null))):(r=this.GetSelfInfoFromMouseXY(e,t))&&"face"===r.topolType&&(this.ClearPreSel(),this.distanceInfo.firstSelInfo=r,(o=this.createFace(this.distanceInfo.firstSelInfo,!1))&&(this.OpMeasure.rootObject.add(o),this.distanceInfo.firstSelObj=o))},t.prototype.PointToTriangleNearestDistance=function(e,t){var n,i,r,o,a={},s=(new THREE.Vector3).subVectors(t.v0,e),l=(new THREE.Vector3).subVectors(t.v1,t.v0),d=(new THREE.Vector3).subVectors(t.v2,t.v0),c=l.dot(l),h=l.dot(d),u=d.dot(d),f=s.dot(l),p=s.dot(d),m=Math.max(c*u-h*h,0),g=h*p-u*f,s=h*f-c*p;return g+s<=m?g<0?s<0&&f<0?(s=0,g=c<=-f?1:-f/c):s=(g=0)<=p?0:u<=-p?1:-p/u:s<0?g=(s=0)<=f?0:c<=-f?1:-f/c:(g/=m,s/=m):g<0?s=(n=h+f)<(i=u+p)?(o=c-2*h+u)<=(r=i-n)?(g=1,0):1-(g=r/o):i<=(g=0)?1:0<=p?0:-p/u:s<0?g=(n=h+p)<(i=c+f)?(o=c-2*h+u)<=(r=i-n)?(s=1,0):1-(s=r/o):i<=(s=0)?1:0<=f?0:-f/c:s=(r=u+p-h-f)<=0?(g=0,1):(o=c-2*h+u)<=r?(g=1,0):1-(g=r/o),a.startP=e,a.endP=new THREE.Vector3,a.endP.x=t.v0.x+l.x*g+d.x*s,a.endP.y=t.v0.y+l.y*g+d.y*s,a.endP.z=t.v0.z+l.z*g+d.z*s,a.distLen=e.clone().distanceTo(a.endP),a},t.prototype.CalculateNearestFaceToFace=function(e,t){var n=e.geometry,i=t.geometry,r=e.indexRange.concat();r[0]+=n.drawRange.start/3,r[1]+=n.drawRange.start/3;var o=t.indexRange.concat();o[0]+=i.drawRange.start/3,o[1]+=i.drawRange.start/3;for(var a=n.index,s=new Set,l=r[0];l<=r[1];l++){var d=a.getX(x=3*l),c=a.getX(x+1),h=a.getX(x+2);s.add(d),s.add(c),s.add(h)}for(var u=i.index,f=new Set,l=o[0];l<=o[1];l++){d=u.getX(x=3*l),c=u.getX(x+1),h=u.getX(x+2);f.add(d),f.add(c),f.add(h)}var p={distLen:1/0},m=n.attributes.position,g=i.attributes.position,v=!0,n=!1,i=void 0;try{for(var y,E=s[Symbol.iterator]();!(v=(y=E.next()).done);v=!0){var b=y.value;(P=new THREE.Vector3).fromBufferAttribute(m,b),P.applyMatrix4(e.matrixWorld);for(var M=o[0];M<=o[1];M++){var x=3*M,d=u.getX(x),c=u.getX(x+1),h=u.getX(x+2),w=new THREE.Vector3,I=new THREE.Vector3,S=new THREE.Vector3;w.fromBufferAttribute(g,d),I.fromBufferAttribute(g,c),S.fromBufferAttribute(g,h),w.applyMatrix4(t.matrixWorld),I.applyMatrix4(t.matrixWorld),S.applyMatrix4(t.matrixWorld),(B={}).v0=w,B.v1=I,B.v2=S,0<=(L=this.PointToTriangleNearestDistance(P,B)).distLen&&L.distLen<p.distLen&&(p=L)}}}catch(e){n=!0,i=e}finally{try{v||null==E.return||E.return()}finally{if(n)throw i}}var T={distLen:1/0},A=!0,n=!1,i=void 0;try{for(var R,O=f[Symbol.iterator]();!(A=(R=O.next()).done);A=!0){var P,C=R.value;(P=new THREE.Vector3).fromBufferAttribute(g,C),P.applyMatrix4(t.matrixWorld);for(M=r[0];M<=r[1];M++){var B,L,x=3*M,d=a.getX(x),c=a.getX(x+1),h=a.getX(x+2),w=new THREE.Vector3,I=new THREE.Vector3,S=new THREE.Vector3;w.fromBufferAttribute(m,d),I.fromBufferAttribute(m,c),S.fromBufferAttribute(m,h),w.applyMatrix4(e.matrixWorld),I.applyMatrix4(e.matrixWorld),S.applyMatrix4(e.matrixWorld),(B={}).v0=w,B.v1=I,B.v2=S,0<=(L=this.PointToTriangleNearestDistance(P,B)).distLen&&L.distLen<T.distLen&&(T=L)}}}catch(e){n=!0,i=e}finally{try{A||null==O.return||O.return()}finally{if(n)throw i}}return p.distLen>T.distLen?T:p};var lt=function(e){ce.call(this,e);var t=this;this.MeasureOper=new Xe(this),!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.viewer.loadBrepInfo(!1):this.dispatchEvent({type:"BrepInfoEvent"}),this.scene=new THREE.Scene,this.type="OpMeasure",this.dimString="",this.unit="",this.measureType="pt2pt",this.boxInfos=[],this.textLines=[],this.click=!1,this.measureRelease=!0,this.clientHeightRatio=0,this.clientWidthRatio=0,this.hasZoomArea=!1,this.longClick=0,this.totalArea=0,this.totalVolume=0,this.pixWidth=120,this.hasMouseZoomArea=!0,this.showMouseZoomArea=!1,this.dpr=Math.floor(window.devicePixelRatio),1!=this.dpr&&2!=this.dpr&&3!=this.dpr&&(this.dpr=1),this.textBoxBroadcast=null,this.textPosBroadcast=null,this.perimeterInfos=[],this.perimeterBroadcast=null,this.perimeterunit=null,this.measureTimes=0,this.measureShowResult=!1,this.unsteady=!1,this.unsteadyType="",this.unsteadyuuid=null,this.unsteadyData={},this.unsteadyTextBox=null,this.unsteadyMoving=!1,this.startPoint=null,this.measureFlag=0,this.Popup=null,this.prompt=document.createElement("div"),ye.isMobileDevice()?this.prompt.className="app-alert":this.prompt.className="pc-alert",this.viewer.container.appendChild(this.prompt);var n,i,r,o,a,s,l,d,c,h;this.debounceTouchSinglemove=(n=function(){var e,t;this.debounceStop||(e=this.pointer.x,t=this.pointer.y,this.hasMouseZoomArea&&(t-=this.pixWidth/2),this.MeasureOper.onNMouseMove(e,t),this.MeasureOper.isTwoTopolInfoTheSame(this.MeasureOper.distanceInfo.preSelInfoOld,this.MeasureOper.distanceInfo.preSelInfo)||(this.imageData=null,this.MeasureOper.distanceInfo.preSelInfoOld=function(e){var t,n={};for(t in e)n[t]=e[t];return n}(this.MeasureOper.distanceInfo.preSelInfo),this.hasMouseZoomArea?this.changeMouseZoomArea():this.changeZoomArea()))},i=80,o=t,function(){var e=arguments;r&&clearTimeout(r),r=setTimeout(function(){n.apply(o,e)},i)}),this.debounceTouchSinglemove2=(a=function(){var e,t;this.debounceStop||(e=this.pointer.x,t=this.pointer.y,this.hasMouseZoomArea&&1==this.longClick&&(t-=this.pixWidth/2),this.MeasureOper.onNMouseMove(e,t))},s=function(){this.render(),this.MeasureOper.isTwoTopolInfoTheSame(this.MeasureOper.distanceInfo.preSelInfoOld,this.MeasureOper.distanceInfo.preSelInfo)||(this.imageData=null,this.MeasureOper.distanceInfo.preSelInfoOld=function(e){var t,n={};for(t in e)n[t]=e[t];return n}(this.MeasureOper.distanceInfo.preSelInfo),this.hasMouseZoomArea?this.changeMouseZoomArea():this.changeZoomArea())},l=80,c=d=!0,h=t,function(){var e=arguments;if(s.apply(h,e),d&&(d=!1,setTimeout(function(){d=!0},l),c)){c=!1;try{a.apply(h,e)}catch(e){c=!0,console.error(e)}c=!0}}),this.debounceStop=!1,this.imageData=null,this.boundingboxmesh=null,this.boundingboxInfos=[],this.preSelectBody=null,this.preSelectBodyMat=null,this.rootObject=new THREE.Object3D,this.measureData=new THREE.Group,this.scene.add(this.rootObject),this.viewer.canvas2D&&(this.viewer.canvas2D.style.display=""),this.render()};lt.prototype=Object.create(ce.prototype),lt.prototype.getMeasureVisible=function(){return!!this.rootObject&&this.rootObject.visible},lt.prototype.restrictMeasuretime=function(){var e=this.viewer.is2DModel?20:10;if(!this.viewer.is2DModel)for(;this.boxInfos.length>e;){var t=this.boxInfos[0].textBox.children[1];"sectionCross"==t.className&&this.MeasureOper.sectionCrossend.apply(t,[])}},lt.prototype.setMeasureVisible=function(e){this.rootObject&&(this.rootObject.visible=e);for(var t=0,n=this.boxInfos.length;t<n;t++)this.boxInfos[t].textBox.style.display=e?"block":"none"},lt.prototype.release=function(){this.showMouseZoomArea=!1;for(var e=0;e<this.perimeterInfos.length;e++)this.viewer.removeIconFromContainer(this.perimeterInfos[e].textimg);this.perimeterInfos=[],this.MeasureOper.OperatorRelease(),this.clearZoomArea(),this.MeasureOper.update2DScene();var t=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*t,window.innerHeight*t),this.measureTimes=0,this.measureShowResult=!1,Ue.enableBroadcast&&!Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent"}),this.boundingboxmesh&&(this.rootObject.remove(this.boundingboxmesh),this.boundingboxmesh=null),this.textBoxBroadcast&&(this.viewer.container.removeChild(this.textBoxBroadcast),this.textBoxBroadcast=null,this.textPosBroadcast=null),this.viewer.outlinePass&&(this.viewer.outlinePass.tempSelectedObjects.length=0),this.scene.remove(this.rootObject),this.rootObject=null;for(var n=0,i=this.boxInfos.length;n<i;n++){var r=this.boxInfos[n];this.viewer.container.removeChild(r.textBox),r.textPos=null,r.textBox=null}this.boxInfos.splice(0,this.boxInfos.length);for(n=0,i=this.boundingboxInfos.length;n<i;n++){r=this.boundingboxInfos[n];this.viewer.container.removeChild(r.textBox),r.textPos=null,r.textBox=null}this.boundingboxInfos.splice(0,this.boundingboxInfos.length),this.viewer.selectionManager.clearSelection(),this.textLines.length=0,this.update(),this.render(),ce.prototype.release.call(this)},lt.prototype.update=function(){ce.prototype.update.call(this)},lt.prototype.addmeasureTimes=function(){this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),this.measureTimes++},lt.prototype.submeasureTimes=function(){this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),this.measureTimes--},lt.prototype.onNMouseMove=function(e){var t=this.MeasureOper.getViewClientCoords(e),n=t.x,t=t.y;if(this.prompt&&!ye.isMobileDevice()&&(0<this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.viewer.renderer.getPixelRatio(),this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px"),this.unsteady){var i,n=this.pointer.x,t=this.pointer.y;switch(this.unsteadyType){case"bodyDistance":(i=new Ze(this)).measureType="bodyDistance";break;case"Distance":i=new Ze(this);break;case"Radius":(i=new qe(this)).measureType="radius";break;case"bodyEdgeLength":(i=new Qe(this)).measureType="bodyEdgeLength";break;case"measureEdges":(i=new Qe(this)).measureType="measureEdges";break;case"bodyAngle":(i=new Ke(this)).measureType="bodyAngle";break;case"Angle":(i=new Ke(this)).measureType="LineAngle";break;case"FaceAngle":(i=new Ke(this)).measureType="faceAngle"}i.onNMouseMove(n,t),this.render(!0)}else this.MeasureOper.onNMouseMove(n,t),this.dispatchEvent({type:"render",forceRenderAll:!0,needBroadcast:!1})},lt.prototype.onLMouseClick=function(e){if(10!=this.measureTimes||!Ue.enableBroadcast||this.viewer.is2DModel||"faceArea"==this.measureType||"BodyArea"==this.measureType||"BodyVolume"==this.measureType){if(20==this.measureTimes&&Ue.enableBroadcast&&this.viewer.is2DModel&&"faceArea"!=this.measureType&&"BodyArea"!=this.measureType&&"BodyVolume"!=this.measureType){if(this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),"coordinate"==this.measureType||this.measureShowResult)return;this.measureShowResult=!0}else this.measureShowResult=!1;if(e.preventDefault(),!this.viewer.hasBrepInfo()&&this.measureType&&"pt2pt"!=this.measureType&&"angle"!=this.measureType&&"pt2ptbim"!=this.measureType&&"BoundingBox"!=this.measureType&&"bodyBoundingBox"!=this.measureType)return this.PostInfo(NDS.INFOTYPE.NOBREP),void this.render(!0);var t=this.MeasureOper.getViewClientCoords(e);this.click=!0,this.MeasureOper.onLMouseClick(t.x,t.y,e.ctrlKey),this.isInMeasure()&&"coordinate"!=this.measureType?this.dispatchEvent({type:"render",forceRenderAll:!0,needBroadcast:!1}):this.render(!0)}else this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes})},lt.prototype.onLMouseDbClick=function(){"contour"!=this.MeasureOper.measureType&&"contourarea"!=this.MeasureOper.measureType||this.MeasureOper.measureEnd()},lt.prototype.onLMouseUp=function(e){this.state=-1,Ue.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformFinish()},lt.prototype.onTouchDoubleEnd=function(e){e.preventDefault(),ce.prototype.onTouchDoubleEnd.call(this,e),this.getZoomAreaVisible()&&(this.invisible(),this.MeasureOper&&this.MeasureOper.clearPreSelect()),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},lt.prototype.onTouchSingleEnd=function(e){if(this.hideRotateCenterHelper(),e.preventDefault(),!this.lineargaugediv||"block"!=this.lineargaugediv.style.display)if(10==this.measureTimes&&Ue.enableBroadcast)this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes});else{var t=this.singleTouchEndPos.x,n=this.singleTouchEndPos.y,e=Date.now()-this.touchStartTime;if(!this.viewer.hasBrepInfo()&&this.measureType&&"pt2pt"!=this.measureType&&"pt2ptbim"!=this.measureType&&"angle"!=this.measureType&&"BoundingBox"!=this.measureType)return this.PostInfo(NDS.INFOTYPE.NOBREP),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,void(this.longClick=0);(1==this.longClick||e<500&&Math.abs(this.singleTouchStartPos.x-this.singleTouchEndPos.x)<3&&Math.abs(this.singleTouchStartPos.y-this.singleTouchEndPos.y)<3)&&(this.hasMouseZoomArea&&1==this.longClick&&(n-=this.pixWidth/2),this.MeasureOper.onLMouseClick(t,n,!1),this.render(),this.invisible(),this.MeasureOper.clearCoordinate()),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0,this.debounceStop=!0}},lt.prototype.onTouchDoubleStart=function(e){e.preventDefault(),ce.prototype.onTouchDoubleStart.call(this,e),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},lt.prototype.onTouchSingleStart=function(e){var t;this.lineargaugediv&&"block"==this.lineargaugediv.style.display||(ce.prototype.onTouchSingleStart.call(this,e),(t=this).longClick=0,this.hasMouseZoomArea?this.createMouseZoomArea():t.createZoomArea(),Ue.inBIMContext||(this.timeOutEvent=setTimeout(function(){t.longClick=1,t.hasMouseZoomArea?t.changeMouseZoomArea(!0):t.changeZoomArea(!0)},500)),this.touchStartTime=Date.now())},lt.prototype.onTouchDoubleMove=function(e){ce.prototype.onTouchDoubleMove.call(this,e),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},lt.prototype.onTouchSingleMove=function(e){if(Date.now()-this.touchStartTime<500&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&(clearTimeout(this.timeOutEvent),this.timeOutEvent=0),0!=this.longClick||!(Math.abs(this.pointer.x-this.singleTouchStartPos.x)<3||Math.abs(this.pointer.y-this.singleTouchStartPos.y)<3))if(0==this.longClick)if(this.invisible(),this.MeasureOper.clearCoordinate(),this.unsteady){var t,n=this.pointer.x,i=this.pointer.y;switch(this.unsteadyType){case"bodyDistance":(t=new Ze(this)).measureType="bodyDistance";break;case"Distance":t=new Ze(this);break;case"Radius":(t=new qe(this)).measureType="radius";break;case"bodyEdgeLength":(t=new Qe(this)).measureType="bodyEdgeLength";break;case"measureEdges":(t=new Qe(this)).measureType="measureEdges";break;case"bodyAngle":(t=new Ke(this)).measureType="bodyAngle";break;case"Angle":(t=new Ke(this)).measureType="LineAngle";break;case"FaceAngle":(t=new Ke(this)).measureType="faceAngle"}t.onNMouseMove(n,i)}else ce.prototype.onTouchSingleMove.call(this,e);else this.debounceStop=!1,this.hasMouseZoomArea?(this.debounceTouchSinglemove2(),this.changeMouseZoomArea()):(this.debounceTouchSinglemove(),this.changeZoomArea())},lt.prototype.PostInfo=function(e){if(this.prompt){if(!e||this.MeasureOper.hasMeasured()&&ye.isMobileDevice()&&e<=NDS.INFOTYPE.MEASURENOTICEBEGIN)return this.InfoType=0,this.prompt.style.display="none",void(this.prompt.innerHTML="");this.Popup&&(clearTimeout(this.Popup),this.Popup=null),this.InfoType=e;var t="en"==ye.getLanguage(),n=22;if(ye.isMobileDevice()&&(n=42),this.prompt.style.height=n+"px",ye.isMobileDevice())switch(e){case NDS.INFOTYPE.POINT:r=t?"select a point":"请选择点";break;case NDS.INFOTYPE.MOUSEENTER:r=t?"Long press to move the data frame":"长按左键可拖拽测量数据";break;case NDS.INFOTYPE.THIRDPOINT:r=t?"Click to select the third point.":"单击确定第三个点";break;case NDS.INFOTYPE.COORDINATEPOINT:r=t?"Click to determine the point to measure.":"请选择坐标点";break;case NDS.INFOTYPE.CROSSENTER:r=t?"Click to delete the measure data":"单击删除测量数据";break;case NDS.INFOTYPE.SECONDPOINT:r=t?"Please select the second point":"请选择第二个点";break;case NDS.INFOTYPE.CANCELLINE:r=t?"<div class = 'blackdiv'>Click to cancel the line/arc.</div><div class = 'whitediv'>Double-click to finish.</div>":"<div class = 'blackdiv'>单击取消线段/弧线</div><div class = 'whitediv'>双击结束</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.POINTLINE:r=t?"select a point/straight line":"请选择点/直线";break;case NDS.INFOTYPE.LINE:r=t?"select a straight line":"请选择直线";break;case NDS.INFOTYPE.POINTPLANE:r=t?"select a point/plane":"请选择点/平面";break;case NDS.INFOTYPE.PLANE:r=t?"select a plane":"请选择平面";break;case NDS.INFOTYPE.FIRSTLINE:r=t?"select a straight line":"请选择直线";break;case NDS.INFOTYPE.LINEANDCIRCLE:r=t?"select line segment / arc":"请选择线段/弧线";break;case NDS.INFOTYPE.SECONDLINE:r=t?"select the second straight line":"请选择第二条直线";break;case NDS.INFOTYPE.ENDMEASURE:r="";break;case NDS.INFOTYPE.LINEPLANE:r=t?"select a straight line/plane":"请选择直线/平面";break;case NDS.INFOTYPE.FIRSTPLANE:r=t?"select a plane":"请选择平面";break;case NDS.INFOTYPE.PARALLELLINE:r=t?"select a parallel line":"请选择平行的线";break;case NDS.INFOTYPE.PARALLELPLANE:case NDS.INFOTYPE.FIRSTPARALLELPLANE:r=t?"select a parallel plane":"请选择平行的面";break;case NDS.INFOTYPE.CIRCLE:r=t?this.viewer.is2DModel?"select a circle/circular arc":"select a circle/circular arc/cylindrical surface":this.viewer.is2DModel?"请选择正圆/圆弧":"请选择正圆/圆弧/壁面";break;case NDS.INFOTYPE.SECONDCIRCLE:r=t?this.viewer.is2DModel?"select the second circle/circular arc":"select second circle/circular <br/> arc/cylindrical surface":this.viewer.is2DModel?"请选择第二个正圆/圆弧":"请选择第二个正圆/圆弧/壁面",!this.viewer.is2DModel&&t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.CIRCLEA:r=t?this.viewer.is2DModel?"select a circle/circular arc":"select a circle/circular arc/cylindrical surface":this.viewer.is2DModel?"请选择正圆/圆弧":"请选择正圆/圆弧/壁面";break;case NDS.INFOTYPE.SECONDPLANE:r=t?"select the second plane":"请选择第二个平面";break;case NDS.INFOTYPE.AXISLINE:r=t?this.viewer.is2DModel?"select a straight line/a circle/circular arc":"select a straight line/ a hole/an axis":this.viewer.is2DModel?"请选择直线/正圆/圆弧":"请选择直线/孔轴";break;case NDS.INFOTYPE.AXISPOINT:r=t?this.viewer.is2DModel?"select a point/a circle/circular arc":"select a point/ a hole/an axis":this.viewer.is2DModel?"请选择点/正圆/圆弧":"请选择点/孔轴";break;case NDS.INFOTYPE.AXIS:r=t?"select a hole/an axis":"请选择孔/轴";break;case NDS.INFOTYPE.AXISPLANE:r=t?"select a plane / a hole / an axis":"请选择平面/孔轴";break;case NDS.INFOTYPE.FACE:r=t?"select a plane / curve":"请选择平面或者曲面";break;case NDS.INFOTYPE.CIRCLEANDLINE:r=t?"select line segment / arc":"请选择线段/弧线";break;case NDS.INFOTYPE.FIRSTPOINT:r=t?"Please select the first point":"请选择第一个点";break;case NDS.INFOTYPE.BODY:r=t?"select the body":"请选择实体";break;case NDS.INFOTYPE.LINEPOSITION:r=t?"Click to choose the position of the dimension line.":"单击确定指定尺寸线位置";break;case NDS.INFOTYPE.LINENOPARALLEL:r=t?"The line you selected is unparallel":"当前选择的线不平行";break;case NDS.INFOTYPE.PLANENOPARALLEL:r=t?"The surface you selected is unparallel":"当前选择的面不平行";break;case NDS.INFOTYPE.NOTFACE:case NDS.INFOTYPE.NOTFACEPARALLEL:r=t?"The surface you selected is not a plane":"当前选择的面不是平面";break;case NDS.INFOTYPE.AXISNOPARALLEL:r=t?"The hole/axis you selected is unparallel":"当前选择的孔/轴不平行";break;case NDS.INFOTYPE.NOBREP:r=t?"The model is missing data and  <br/> cannot use the measurement function":"模型缺少数据，无法使用该测量功能",t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.NOPARALLEL:r=t?"The two currently selected records are parallel":"当前选择的两条记录平行";break;case NDS.INFOTYPE.NOTFACESECOND:r=t?"The surface you selected is not a plane":"当前选择的面不是平面";break;case NDS.INFOTYPE.INTERSECT:r=t?"The lines you selected are intersecting":"当前选择的线相交";break;case NDS.INFOTYPE.LINEPARALLEL:r=t?"The currently selected two lines are parallel":"当前所选择的两条线平行";break;case NDS.INFOTYPE.PLANEPARALLELLINE:r=t?"The currently selected face is parallel to the line":"当前所选择的面与线平行";break;case NDS.INFOTYPE.LINEPARALLELPLANE:r=t?"The currently selected line is parallel to the face":"当前所选择的线与面平行";break;case NDS.INFOTYPE.PLANEPARALLEL:r=t?"The currently selected two faces are parallel":"当前所选择的两个面平行";break;case NDS.INFOTYPE.TWOAXISNOPARALLEL:r=t?"The currently selected two <br/>hole axes are not parallel":"当前所选择的两个孔轴线不平行",t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.NOCONJOINT:r=t?"select the connected line segment/arc":"当前对象无法选中，请选择相连的线段/弧线";break;case NDS.INFOTYPE.NOCLOSE:r=t?"select a closed drawing":"请选择闭合的图形";break;case NDS.INFOTYPE.FIRMEASUREBODY:r=t?"Select first measuring object":"请选择第一个测量对象";break;case NDS.INFOTYPE.SECMEASUREBODY:r=t?"Select second measuring object":"请选择第二个测量对象";break;case NDS.INFOTYPE.MEASUREBODY:r=t?"Select measuring object":"请选择要测量的对象";break;case NDS.INFOTYPE.TWOBODYPARALLEL:r=t?"The selected objects are parallel<br/>cannot measure the angle":"所选对象平行，无法测量角度",t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.TWOBODYNOTPARALLEL:r=t?"The selected objects are unparallel<br/>cannot measure the distance":"所选对象不平行，无法测量距离",t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.LOADDATE:r=t?"The measurement data is being loaded<br/>please try again later":"测量数据正在加载，请稍候重试",t&&(this.prompt.style.height=2*n+"px")}else switch(e){case NDS.INFOTYPE.POINT:r=t?"Click to select the point.":"单击确定点";break;case NDS.INFOTYPE.COORDINATEPOINT:r=t?"Click to determine the point to measure.":"单击确定坐标点";break;case NDS.INFOTYPE.SECONDPOINT:r=Ue.inBIMContext?t?"Please select the second point.":"请选择第二个点":t?"Click to select the second point.":"单击确定第二个点";break;case NDS.INFOTYPE.THIRDPOINT:r=Ue.inBIMContext?t?"Please select the third point.":"请选择第三个点":t?"Click to select the third point.":"单击确定第三个点";break;case NDS.INFOTYPE.POINTLINE:r=t?"select a point/straight line.":"请选择点/直线";break;case NDS.INFOTYPE.LINE:r=t?"Click to select the line.":"单击确定直线";break;case NDS.INFOTYPE.LINEANDCIRCLE:r=t?"Click to select the line.":"单击确定线";break;case NDS.INFOTYPE.POINTPLANE:r=t?"select a point/plane.":"请选择点/平面";break;case NDS.INFOTYPE.PLANE:r=t?"Click to select the plane.":"单击确定平面";break;case NDS.INFOTYPE.FIRSTLINE:r=t?"Click to select the first line.":"单击确定第一条直线";break;case NDS.INFOTYPE.SECONDLINE:r=t?"Click to select the second line.":"单击确定第二条直线";break;case NDS.INFOTYPE.LINEPLANE:r=t?"Click to select the line / plane.":"单击确定直线/平面";break;case NDS.INFOTYPE.PARALLELLINE:r=t?"Click to select the first parallel line.":"单击确定平行的线";break;case NDS.INFOTYPE.FIRSTPARALLELPLANE:r=t?"Click to select the first parallel planes.":"单击确定平行的面";break;case NDS.INFOTYPE.PARALLELPLANE:r=t?"Click to select parallel plane.":"单击确定平行的面";break;case NDS.INFOTYPE.CIRCLE:r=t?this.viewer.is2DModel?"Click to select the first circle/ arc.":"Click to select the first <br/> circle/ arc/ wall surface.":this.viewer.is2DModel?"单击确定第一个正圆/圆弧":"单击确定第一个正圆/圆弧/壁面",!this.viewer.is2DModel&&t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.CIRCLEA:r=t?this.viewer.is2DModel?"Click to select the circle/ arc.":"Click to select the <br/> circle/ arc/ wall surface.":this.viewer.is2DModel?"单击确定正圆/圆弧":"单击确定正圆/圆弧/壁面",!this.viewer.is2DModel&&t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.SECONDCIRCLE:r=t?this.viewer.is2DModel?"Click to select the second circle/ arc.":"Click to select the second <br/> circle/ arc/ wall surface.":this.viewer.is2DModel?"单击确定第二个正圆/圆弧":"单击确定第二个正圆/圆弧/壁面",!this.viewer.is2DModel&&t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.SECONDPLANE:r=t?"Click to select the second plane.":"单击确定第二个平面";break;case NDS.INFOTYPE.FIRSTPLANE:r=t?"Click to select the first plane.":"单击确定第一个平面";break;case NDS.INFOTYPE.AXISLINE:r=t?this.viewer.is2DModel?"Click to select the line/ circle/ arc.":"Click to select the line/whole shaft.":this.viewer.is2DModel?"单击确定直线/正圆/圆弧":"单击确定直线/孔轴";break;case NDS.INFOTYPE.AXISPOINT:r=t?this.viewer.is2DModel?"select a point/a circle/circular arc.":"select a point/ a hole/an axis.":this.viewer.is2DModel?"请选择点/正圆/圆弧":"请选择点/孔轴";break;case NDS.INFOTYPE.AXIS:r=t?"Click to select the whole shaft.":"单击确定孔/轴";break;case NDS.INFOTYPE.AXISPLANE:r=t?"Click to select the plane/whole shaft.":"单击确定平面/孔轴";break;case NDS.INFOTYPE.FACE:r=t?"Click to select the plane/curved surface.":"单击确定平面/曲面";break;case NDS.INFOTYPE.CIRCLEANDLINE:r=t?"<div class = 'blackdiv'>Click to select the line/arc to measure.</div><div class = 'whitediv'>Double-click to finish.</div>":"<div class = 'blackdiv'>单击确定线段/弧线 </div><div class = 'whitediv'>双击结束</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.FIRSTPOINT:r=Ue.inBIMContext?t?"Please select the first point.":"请选择第一个点":t?"Click to select the first point.":"单击确定第一个点";break;case NDS.INFOTYPE.BODY:r=t?"Click to select the object.":"单击确定指定实体";break;case NDS.INFOTYPE.LINEPOSITION:r=t?"Click to choose the position of the dimension line.":"单击确定指定尺寸线位置";break;case NDS.INFOTYPE.ENDMEASURE:r=t?"Click to choose the position.":"单击确定放置位置";break;case NDS.INFOTYPE.CANCELLINE:r=t?"<div class = 'blackdiv'>Click to cancel the line/arc.</div><div class = 'whitediv'>Double-click to finish.</div>":"<div class = 'blackdiv'>单击取消线段/弧线</div><div class = 'whitediv'>双击结束</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.LINENOPARALLEL:r=t?"<div class = 'yellowdiv'>The currently selected lines are not parallel.</div><div class = 'blackdiv'>Click to select the line.</div>":"<div class = 'yellowdiv'>当前选择的线不平行</div><div class = 'blackdiv'>单击确定直线</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.PLANENOPARALLEL:r=t?"<div class = 'yellowdiv'>The currently selected planes are not parallel.</div><div class = 'blackdiv'>Click to select the parallel plane.</div>":"<div class = 'yellowdiv'>当前选择的面不平行</div><div class = 'blackdiv'>单击确定平行的面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.NOTFACE:r=t?"<div class = 'yellowdiv'>The currently selected planes are not parallel.</div><div class = 'blackdiv'>Click to select the plane.</div>":"<div class = 'yellowdiv'>所选对象不是平面，无法测量</div><div class = 'blackdiv'>单击确定平面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.NOTFACESECOND:r=t?"<div class = 'yellowdiv'>The object is not a plane, can not be measured.</div><div class = 'blackdiv'>Click to select the second plane.</div>":"<div class = 'yellowdiv'>所选对象不是平面，无法测量</div><div class = 'blackdiv'>单击确定第二个平面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.NOTFACEPARALLEL:r=t?"<div class = 'yellowdiv'>The object is not a plane, can not be measured.</div><div class = 'blackdiv'>Click to select the parallel plane.</div>":"<div class = 'yellowdiv'>所选对象不是平面，无法测量</div><div class = 'blackdiv'>单击确定平行的面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.AXISNOPARALLEL:r=t?"<div class = 'yellowdiv'>The selected whole shaft are not parallel.</div><div class = 'blackdiv'>Click to select the whole shaft.</div>":"<div class = 'yellowdiv'>当前选择的孔轴不平行</div><div class = 'blackdiv'>单击确定孔/轴</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.MOUSEENTER:r=t?"Long press to move the data frame":"长按左键可拖拽测量数据";break;case NDS.INFOTYPE.CROSSENTER:r=t?"Click to delete the measure data":"单击删除测量数据";break;case NDS.INFOTYPE.NOBREP:r=t?"The model is missing data and  <br/> cannot use the measurement function":"模型缺少数据，无法使用该测量功能",t&&(this.prompt.style.height=2*n+"px");break;case NDS.INFOTYPE.NOPARALLEL:r=t?"The two currently selected records are parallel.":"当前选择的两条记录平行";break;case NDS.INFOTYPE.INTERSECT:r=t?"<div class = 'yellowdiv'>The currently selected lines are intersects.</div><div class = 'blackdiv'>Click to select the second line.</div>":"<div class = 'yellowdiv'>当前选择的线相交</div><div class = 'blackdiv'>单击确定第二条直线</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.LINEPARALLEL:r=t?this.viewer.is2DModel?"<div class = 'yellowdiv'>Two objects are parallel, angle can not measure.</div><div class = 'blackdiv'>Click to select the second line.</div>":"<div class = 'yellowdiv'>Two objects are parallel, can not be measured.</div><div class = 'blackdiv'>Click to select the second line.</div>":"<div class = 'yellowdiv'>所选对象平行，无法测量角度</div><div class = 'blackdiv'>单击确定第二条直线</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.PLANEPARALLELLINE:r=t?"<div class = 'yellowdiv'>Two objects are parallel, can not be measured.</div><div class = 'blackdiv'> Click to select the plane.</div>":"<div class = 'yellowdiv'>所选对象平行，无法测量</div><div class = 'blackdiv'>单击确定平面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.LINEPARALLELPLANE:r=t?"<div class = 'yellowdiv'>Two objects are parallel, can not be measured.</div><div class = 'blackdiv'>Click to select the line.</div>":"<div class = 'yellowdiv'>所选对象平行，无法测量</div><div class = 'blackdiv'>单击确定直线</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.PLANEPARALLEL:r=t?"<div class = 'yellowdiv'>The currently selected planes are parallel.</div><div class = 'blackdiv'>Click to select the second plane.</div>":"<div class = 'yellowdiv'>当前所选择的两个面平行</div><div class = 'blackdiv'>单击确定第二个平面</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.TWOAXISNOPARALLEL:var i="",i=t?this.viewer.is2DModel?"Click to select the second circle/ arc.":"Click to select the second circle/ arc/ wall surface.":this.viewer.is2DModel?"单击确定第二个正圆/圆弧":"单击确定第二个正圆/圆弧/壁面",r=t?"<div class = 'yellowdiv'>The selected whole shaft are not parallel.</div><div class = 'blackdiv'>"+i+"</div>":"<div class = 'yellowdiv'>当前所选择的两个孔轴线不平行</div><div class = 'blackdiv'>"+i+"</div>";this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.NOCONJOINT:r=t?"<div class = 'yellowdiv'>The objects are not connected, can not be measured.</div><div class = 'blackdiv'>Click to select the contiguous line/arc.</div><div class = 'whitediv'> Double-click to finish.</div>":"<div class = 'yellowdiv'>所选对象不相连，无法测量长度</div><div class = 'blackdiv'>单击确定线段/弧线</div><div class = 'whitediv'>双击结束</div>",this.prompt.style.height=3*n+"px";break;case NDS.INFOTYPE.NOCLOSE:r=t?"<div class = 'yellowdiv'>The objects are not closed, can not be measured.</div><div class = 'blackdiv'>Click to select the closed graph.</div><div class = 'whitediv'>Double-click to finish.</div>":"<div class = 'yellowdiv'>所选对象不闭合，无法测量面积</div><div class = 'blackdiv'>单击确定线段/弧线</div><div class = 'whitediv'>双击结束</div>",this.prompt.style.height=3*n+"px";break;case NDS.INFOTYPE.FIRMEASUREBODY:r=t?"Click to select the first object.":"单击确定第一个测量对象";break;case NDS.INFOTYPE.SECMEASUREBODY:r=t?"Click to select the second object.":"单击确定第二个测量对象";break;case NDS.INFOTYPE.MEASUREBODY:r=t?"Click to select the object.":"单击确定测量对象";break;case NDS.INFOTYPE.TWOBODYPARALLEL:r=t?"<div class = 'yellowdiv'>The objects are parallel, can not measure.</div><div class = 'blackdiv'>Click to select the second object.</div>":"<div class = 'yellowdiv'>所选对象平行，无法测量角度</div><div class = 'blackdiv'>单击确定第二个测量对象</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.TWOBODYNOTPARALLEL:r=t?"<div class = 'yellowdiv'>The objects are not parallel, can not measure the distance.</div><div class = 'blackdiv'>Click to select the second object.</div>":"<div class = 'yellowdiv'>所选对象不平行，无法测量距离</div><div class = 'blackdiv'>单击确定第二个测量对象</div>",this.prompt.style.height=2*n+"px";break;case NDS.INFOTYPE.LOADDATE:r=t?"The measurement data is being loaded<br/>please try again later.":"测量数据正在加载，请稍候重试",t&&(this.prompt.style.height=2*n+"px")}if(""==r||!Ue.broadcastMajor&&Ue.enableBroadcast)return this.prompt.style.display="none",void(this.prompt.innerHTML=r);this.prompt.innerHTML=r,this.prompt.style.display="block",ye.isMobileDevice()&&(a=this.viewer.renderer.getSize().height/2-21+"px",this.prompt.style.top=a),this.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN?this.prompt.style.color="#ff7d2c":ye.isMobileDevice()?this.prompt.style.color="rgba(27,27,27,1)":this.prompt.style.color="rgba(51,51,51,1)";var o=this,a=2e3;this.InfoType>NDS.INFOTYPE.MEASURENOTICEBEGIN&&(a=3e3),ye.isMobileDevice()&&(this.Popup=setTimeout(function(){o.prompt.style.display="none"},a))}},lt.prototype.setMeasureType=function(e){switch(this.showMouseZoomArea=""!=e,this.measureType=e,this.viewer.brepInfo.BfacePerimeter||"facePerimeter"!=this.measureType||(this.measureType="Base"),Ue.enableBroadcast&&!Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent"}),this.viewer.selectionManager.clearSelection(),this.viewer.onOpChanged({id:"MeasureType"}),this.MeasureOper.OperatorEnd(),this.measureType){case"bodyDistance":case"PointToLine":case"PointToFace":case"AxisToPoint":case"LineToLine":case"LineToFace":case"faceDist":case"AxisToLine":case"AxisToFace":case"holeDist":case"pt2pt":case"pt2ptbim":"Distance"!=this.MeasureOper.measureClass&&(this.MeasureOper=new Ze(this));break;case"radius":"Hole"!=this.MeasureOper.measureClass&&(this.MeasureOper=new qe(this));break;case"measureEdges":case"bodyEdgeLength":"Edge"!=this.MeasureOper.measureClass&&(this.MeasureOper=new Qe(this));break;case"facePerimeter":case"faceArea":"Face"!=this.MeasureOper.measureClass&&(this.MeasureOper=new Je(this));break;case"bodyAngle":case"LineAngle":case"LineFaceAngle":case"faceAngle":case"angle":"Angle"!=this.MeasureOper.measureClass&&(this.MeasureOper=new Ke(this));break;case"BodyArea":case"BodyVolume":case"bodyBoundingBox":case"TotalArea":case"TotalVolume":case"BoundingBox":"BodyAndTotal"!=this.MeasureOper.measureClass&&(this.MeasureOper=new $e(this));break;case"coordinate":"Coordinate"!=this.MeasureOper.measureClass&&(this.MeasureOper=new et(this));break;case"Lineargauge":"Lineargauge"!=this.MeasureOper.measureClass&&(this.MeasureOper=new tt(this));break;case"contour":case"contourarea":"Contour"!=this.MeasureOper.measureClass&&(this.MeasureOper=new at(this));break;case"thickness":"Wall"!=this.MeasureOper.measureClass&&(this.MeasureOper=new st(this));break;default:"Base"!=this.MeasureOper.measureClass&&(this.MeasureOper=new Xe(this))}"Base"!=this.MeasureOper.measureClass&&!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.PostInfo(NDS.INFOTYPE.LOADDATE):!this.viewer.hasBrepFile()&&this.measureType&&"pt2pt"!=this.measureType&&"pt2ptbim"!=this.measureType&&"angle"!=this.measureType&&"BoundingBox"!=this.measureType&&"bodyBoundingBox"!=this.measureType||"facePerimeter"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BfacePerimeter||"BodyArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BbodyArea||("BodyVolume"==e||"TotalVolume"==e)&&this.viewer.brepInfo&&!this.viewer.brepInfo.BbodyVolume||"faceArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BfaceArea||"TotalArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BtotalArea?this.PostInfo(NDS.INFOTYPE.NOBREP):this.MeasureOper.OperatorStart(this.measureType),this.prompt&&!ye.isMobileDevice()&&(this.prompt.style.display="none"),ye.isMobileDevice()&&(this.hasMouseZoomArea?this.createMouseZoomArea():this.createZoomArea()),this.render()},lt.prototype.setPointScale=function(e,t){t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()},lt.prototype.setCylinderScale=function(e,t){ye.isMobileDevice()&&(t*=1.5);t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.oldPosition&&e.offsetPos&&e.position.addVectors(e.oldPosition,e.offsetPos.clone().multiplyScalar(t)),e.updateMatrixWorld()},lt.prototype.getScale=function(e,t){var n=5;null!=t&&(n=t);var i=this.viewer.camera.getCameraTarget(),r=this.viewer.camera.position,t=new THREE.Vector3;t.subVectors(i,r);e=e.position.clone(),r=this.viewer.camera.isPerspective?e.sub(r).dot(t.normalize()):t.length(),t=this.viewer.camera.fov,r=2*r*Math.tan(THREE.Math.degToRad(.5*t)),t=this.viewer.renderer.domElement.height;return n*r*this.viewer.renderer.getPixelRatio()/t},lt.prototype.renderScale=function(e){for(var t=0;t<e.children.length;t++){var n=e.children[t];if(null!=n.objectType)switch(n.objectType){case"Point":this.setPointScale(n,this.MeasureOper.POINTSIZE);break;case"Cylinder":this.setCylinderScale(n,this.MeasureOper.CYLINDERWIDTH);break;case"Group":this.renderScale(n)}}},lt.prototype.renderMeasureScene=function(e,t){if(this.scene){if(null!=this.rootObject&&this.renderScale(this.rootObject),e?this.viewer.renderer.render(this.scene,this.viewer.camera,e,t):this.viewer.renderer.render(this.scene,this.viewer.camera),this.MeasureOper.renderMeasureScene(),this.perimeterInfos)for(var n=0,i=this.perimeterInfos.length;n<i;n++){var r=this.perimeterInfos[n];this.viewer.removeIconFromContainer(r.textimg);var o=this.MeasureOper.get2dPoint(r.textPos.clone()),o=this.MeasureOper.addAnnotationTip(r.dimString,o.x,o.y);o&&this.viewer.container.appendChild(o),r.textimg=o}for(n=0,i=this.boxInfos.length;n<i;n++){r=this.boxInfos[n];this.MeasureOper.getAndShowTextBox(r.textPos.clone(),r.dimString,r.textBox)}for(n=0,i=this.boundingboxInfos.length;n<i;n++){r=this.boundingboxInfos[n];this.MeasureOper.getAndShowTextBox(r.textPos.clone(),r.dimString,r.textBox)}}},lt.prototype.setMeasureScale=function(e){for(var t=0,n=this.boxInfos.length;t<n;t++){var i,r,o,a,s=this.boxInfos[t];"length"==s.textBox.getAttribute("type")?(i=s.textBox.getAttribute("dimString"),a=s.textBox.getAttribute("unit"),"⌒"==i[0]?s.dimString="⌒ "+(i.slice(2)*e).toFixed(2)+a:s.dimString=(i*e).toFixed(2)+a):"radius"==s.textBox.getAttribute("type")?(i=(r=s.textBox.getAttribute("dimString")).slice(0,2),r=r.slice(2),a=s.textBox.getAttribute("unit"),s.dimString=i+(r*e).toFixed(2)+a):"perimeter"==s.textBox.getAttribute("type")?(o=parseFloat(s.textBox.getAttribute("dimString")),a=s.textBox.getAttribute("unit"),"en"==ye.getLanguage()?s.dimString="over length:"+(o*e).toFixed(2)+a:s.dimString="总长:"+(o*e).toFixed(2)+a):"area"==s.textBox.getAttribute("type")&&(o=parseFloat(s.textBox.getAttribute("dimString")),a=s.textBox.getAttribute("unit"),"en"==ye.getLanguage()?s.dimString="area:"+(o*e*e).toFixed(2)+a:s.dimString="面积:"+(o*e*e).toFixed(2)+a),s.textBox.screenX=-10,this.MeasureOper.getAndShowTextBox(s.textPos.clone(),s.dimString,s.textBox)}Ue.enableBroadcast&&Ue.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})},lt.prototype.isInMeasure=function(){var e,t=!1;for(e in this.MeasureOper.coordinatedivtextPos&&this.MeasureOper.coordinatediv&&(t=!0),this.MeasureOper.faceInfo)if(!(null==this.MeasureOper.faceInfo[e]||""==this.MeasureOper.faceInfo[e]||Array.isArray(this.MeasureOper.faceInfo[e])||this.MeasureOper.faceInfo[e]instanceof THREE.Vector2||this.MeasureOper.faceInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.faceInfo.textBox&&null!=this.MeasureOper.faceInfo.textPos){t=!0;break}for(e in this.MeasureOper.holeInfo)if(!(null==this.MeasureOper.holeInfo[e]||""==this.MeasureOper.holeInfo[e]||Array.isArray(this.MeasureOper.holeInfo[e])||this.MeasureOper.holeInfo[e]instanceof THREE.Vector2||this.MeasureOper.holeInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.holeInfo.textBox&&null!=this.MeasureOper.holeInfo.textPos){t=!0;break}for(e in this.MeasureOper.edgeInfo)if(!(null==this.MeasureOper.edgeInfo[e]||""==this.MeasureOper.edgeInfo[e]||Array.isArray(this.MeasureOper.edgeInfo[e])||this.MeasureOper.edgeInfo[e]instanceof THREE.Vector2||this.MeasureOper.edgeInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.edgeInfo.textBox&&null!=this.MeasureOper.edgeInfo.textPos){t=!0;break}for(e in this.MeasureOper.distanceInfo)if(!(null==this.MeasureOper.distanceInfo[e]||""==this.MeasureOper.distanceInfo[e]||Array.isArray(this.MeasureOper.distanceInfo[e])||this.MeasureOper.distanceInfo[e]instanceof THREE.Vector2||this.MeasureOper.distanceInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.distanceInfo.textBox&&null!=this.MeasureOper.distanceInfo.textPos){t=!0;break}for(e in this.MeasureOper.lineContoursInfo)if(!(null==this.MeasureOper.lineContoursInfo[e]||""==this.MeasureOper.lineContoursInfo[e]||Array.isArray(this.MeasureOper.lineContoursInfo[e])||this.MeasureOper.lineContoursInfo[e]instanceof THREE.Vector2||this.MeasureOper.lineContoursInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.lineContoursInfo.textBox&&null!=this.MeasureOper.lineContoursInfo.textPos){t=!0;break}for(e in this.MeasureOper.lineAngleInfo)if(!(null==this.MeasureOper.lineAngleInfo[e]||""==this.MeasureOper.lineAngleInfo[e]||Array.isArray(this.MeasureOper.lineAngleInfo[e])||this.MeasureOper.lineAngleInfo[e]instanceof THREE.Vector2||this.MeasureOper.lineAngleInfo[e]instanceof THREE.Vector2)&&null!=this.MeasureOper.lineAngleInfo.textBox&&null!=this.MeasureOper.lineAngleInfo.textPos){t=!0;break}return t},lt.prototype.getMeasureContent=function(){function i(e){if(e instanceof THREE.Vector3){var t=e.clone();t.x=Number.parseFloat(Number.parseFloat(e.x).toPrecision(6)),t.y=Number.parseFloat(Number.parseFloat(e.y).toPrecision(6)),t.z=Number.parseFloat(Number.parseFloat(e.z).toPrecision(6));for(var n=0;n<r.length;n++)if(t.distanceTo(r[n])<1e-5)return n;return r.push(t.clone()),r.length-1}if(e instanceof Array){var i=[];if(e[0]instanceof THREE.Vector3)for(n=0;n<e.length;++n)i.push(Number.parseFloat(Number.parseFloat(e[n].x).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n].y).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n].z).toPrecision(6)));else for(n=0;n<e.length;n+=3)i.push(Number.parseFloat(Number.parseFloat(e[n]).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n+1]).toPrecision(6)));return i}}function e(e,t){var n=[];if(n[0]=i(e.textPos),n[1]=e.dimString,n[2]=t?e.textBox.getAttribute("lineInfo"):null,t=e.textBox)switch(e.textBox.getAttribute("type")){case"length":n[3]=0,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"radius":n[3]=1,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"perimeter":n[3]=2,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"area":n[3]=3,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"coordinate":n[3]=4;break;default:n[3]=5}else if(e.textimg)switch(e.textimg.getAttribute("type")){case"length":n[3]=0,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"radius":n[3]=1,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"perimeter":n[3]=2,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"area":n[3]=3,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"coordinate":n[3]=4;break;default:n[3]=5}return n}var r=[],t=0,n=[],o=[],a=[],s=[],l=null;for(t=0;t<this.boxInfos.length;t++)n.push(e(this.boxInfos[t],!0));for(t=0;t<this.boundingboxInfos.length;t++)o.push(e(this.boundingboxInfos[t],!1));for(t=0;t<this.MeasureOper.perimeterInfos.length;t++)a.push(e(this.MeasureOper.perimeterInfos[t],!1));var d=this.isInMeasure(),l=!!d||null;for(t=0;t<this.boxInfos.length;t++)s.push(this.boxInfos[t].textPos);var c={boxInfos:n,boundingboxInfos:o,perimeterInfos:a,textPos:s,textBox:l,textLines:this.textLines,snappedPoint:this.MeasureOper.snappedPoint||null,InMeasure:d};0<this.MeasureOper.perimeterInfos.length&&(c.perimeterBroadcast=this.MeasureOper.perimeterBroadcast,c.perimeterunit=this.MeasureOper.perimeterunit),"faceArea"==this.measureType&&(l=(l=this.MeasureOper.getSelectedFaceArea())*(d=this.viewer.getDispalyModelUnit(l)).scale*d.scale,c.faceArea=l,c.faceAreaunit=d.unit),"radius"==this.measureType&&this.MeasureOper.holeInfo.textPos&&this.MeasureOper.holeInfo.fstClndPos&&(c.holeInfotextPos=this.MeasureOper.holeInfo.textPos,c.holeInfofstClndPos=this.MeasureOper.holeInfo.fstClndPos);var h=[];if(this.rootObject){c.cs=this.rootObject.children.length;for(var u=function e(t){switch(t.objectType){case"Line":h.push(0),h.push(i(t.Start)),h.push(i(t.End));break;case"Edge":h.push(1),h.push(i(t.Start)),h.push(i(t.End));break;case"CircleLine":h.push(2),h.push(i(t.Start)),h.push(i(t.Mid)),h.push(i(t.End));break;case"Cylinder":h.push(3),h.push(i(t.Start)),h.push(i(t.End)),h.push(i(t.position)),h.push(i(new THREE.Vector3(t.material.color.r,t.material.color.g,t.material.color.b)));break;case"Point":h.push(4),h.push(i(t.Point));break;case"Face":t.FaceInfo[4]?c.cs--:(h.push(5),h=h.concat(t.FaceInfo));break;case"AxisLine":h.push(6),h.push(i(t.Start)),h.push(i(t.End));break;case"SelLine":t.LineInfo[4]?c.cs--:(h.push(7),h=h.concat(t.LineInfo));break;case"BodyBoundingBox":h.push(8),h=h.concat(i(t.box));break;case"Contour":h.push(9),h.push(t.Vertices.length/3*2),h=h.concat(i(t.Vertices));break;case"Group":for(var n=0;n<t.children.length;++n)e(t.children[n])}},t=0;t<this.rootObject.children.length;++t)u(this.rootObject.children[t]);var f=[];for(t=0;t<r.length;++t){var p=r[t];f.push(p.x),f.push(p.y),f.push(p.z)}c.Ps=f}return c.rootObject=h,c},lt.prototype.createCoordinate=function(e,t){var n,i=document.createElement("div");i.className="mearesult",this.viewer.container.appendChild(i),e&&(n=e.clone(),this.MeasureOper.getAndShowTextBox(n.clone(),t,i));e={};e.dimString=t,e.textPos=n,e.textBox=i,e.textBox.setAttribute("type","coordinate"),e.textBox.setAttribute("dimString",t),this.boxInfos.push(e)},lt.prototype.setMeasureContent=function(e){function t(e,t,n,i,r){var o={},n=n?new THREE.Vector3(n.x,n.y,n.z):c[e[0]];if(o.textPos=n,o.dimString=e[1],Number.isInteger(o.dimString)){var a=d.MeasureOper.get2dPoint(o.textPos.clone()),s=d.MeasureOper.addAnnotationTip(o.dimString,a.x,a.y);s&&d.viewer.container.appendChild(s),o.textimg=s}else{var a,l=document.createElement("div");if(d.viewer.is2DModel?(l.className="mearesult",d.viewer.container.appendChild(l)):(l.className="section10",l.innerHTML=e[1],d.viewer.container.appendChild(l),(s=document.createElement("div")).className="sectionPoint",l.appendChild(s)),l.textPos=n,e[3]<5)switch(e[3]){case 0:l.setAttribute("type","length"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 1:l.setAttribute("type","radius"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 2:l.setAttribute("type","perimeter"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 3:l.setAttribute("type","area"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 4:l.setAttribute("type","coordinate"),l.setAttribute("dimString",e[1])}r&&!d.viewer.is2DModel&&(e[2]?(r=new THREE.Vector3(t[e[2]].start.x,t[e[2]].start.y,t[e[2]].start.z),t=new THREE.Vector3(t[e[2]].end.x,t[e[2]].end.y,t[e[2]].end.z),t=r.clone().add(t.clone()).divideScalar(2),a=i.get2dPoint(n.clone()),t=i.get2dPoint(t.clone()),(t=new THREE.Vector2(a.x-t.x,a.y-t.y)).normalize(),t.y>=t.x/2&&t.y>=-t.x/2?(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="-5.5px",l.setAttribute("mobile","down")):t.y>t.x/2&&t.y<-t.x/2?(l.childNodes[1].style.left="calc(100% - 4px)",l.childNodes[1].style.top="calc(50% - 5.5px)",l.setAttribute("mobile","right")):t.y<t.x/2&&t.y<-t.x/2?(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="calc(100% - 5.5px)",l.setAttribute("mobile","up")):t.y<t.x/2&&t.y>-t.x/2&&(l.childNodes[1].style.left="-5.5px",l.childNodes[1].style.top="calc(50% - 5.5px)",l.setAttribute("mobile","left"))):(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="calc(100% - 5.5px)",l.setAttribute("mobile","up"))),o.textBox=l}return o}var d=this,c=[];if(e){var n=0;for(n=0;n<e.Ps.length;n+=3){var i=e.Ps[n],r=e.Ps[n+1],o=e.Ps[n+2],a=new THREE.Vector3(i,r,o);c.push(a)}e.InMeasure=!0;for(var s=0,l=this.boxInfos.length;s<l;s++)(u=this.boxInfos[s]).textBox&&(this.viewer.container.removeChild(u.textBox),u.textPos=null,u.textBox=null);for(this.boxInfos.splice(0,this.boxInfos.length),n=0;n<e.boxInfos.length;n++){var h=t(e.boxInfos[n],e.textLines,e.textPos[n],this.MeasureOper,!0);h&&this.boxInfos.push(h)}for(s=0,l=this.boundingboxInfos.length;s<l;s++){var u=this.boundingboxInfos[s];this.viewer.container.removeChild(u.textBox),u.textPos=null,u.textBox=null}for(this.boundingboxInfos.splice(0,this.boundingboxInfos.length),n=0;n<e.boundingboxInfos.length;n++)this.boundingboxInfos.push(t(e.boundingboxInfos[n],null,null,null,!1));for(n=0;n<this.perimeterInfos.length;n++)this.viewer.removeIconFromContainer(this.perimeterInfos[n].textimg);for(this.perimeterInfos=[],this.MeasureOper.perimeterInfos=[],n=0;n<e.perimeterInfos.length;n++)this.perimeterInfos.push(t(e.perimeterInfos[n],null,null,null,!1));for(this.textLines=[],n=0;n<e.textLines.length;n++){var f={};f.start=new THREE.Vector3(e.textLines[n].start.x,e.textLines[n].start.y,e.textLines[n].start.z),f.end=new THREE.Vector3(e.textLines[n].end.x,e.textLines[n].end.y,e.textLines[n].end.z),this.textLines.push(f)}e.snappedPoint?this.MeasureOper.snappedPoint=new THREE.Vector3(e.snappedPoint.x,e.snappedPoint.y,e.snappedPoint.z):this.MeasureOper.snappedPoint=null;var p=e.rootObject;if(p&&0==p.length&&(this.rootObject.children=[]),p&&0<p.length){this.rootObject.children=[];for(n=0;n<p.length;){var m=null;switch(p[n++]){case 0:var g=c[p[n++]],v=c[p[n++]],m=this.viewer.is2DModel?this.MeasureOper.createLineMesh2(g,v,this.MeasureOper.materialLine,1):this.MeasureOper.createLineMesh2(g,v,Ue.selectedEdgeMaterial,1);break;case 1:g=c[p[n++]],v=c[p[n++]];m=this.MeasureOper.createLineMesh3(g,v,Ue.selectedEdgeMaterial,1);break;case 2:var g=c[p[n++]],y=c[p[n++]],v=c[p[n++]];m=this.MeasureOper.createLineMesh4(g,y,v,this.MeasureOper.materialLine);break;case 3:var g=c[p[n++]],v=c[p[n++]],E=c[p[n++]],y=c[p[n++]];this.MeasureOper.materialLine.color=y,(m=this.MeasureOper.createCylinderMesh(g,v,this.MeasureOper.materialLine)).position.copy(E);break;case 4:a=c[p[n++]];m=this.MeasureOper.createPointMesh(a,this.MeasureOper.materialPoint,10*this.MeasureOper.POINTSIZE);break;case 5:var b=this.viewer.ndsModel.getBodyNode(p[n++]).uuid,M=this.viewer.ndsModel.geomManager.geoms[p[n++]].uuid,x=p[n++],w=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(b,M,x,"face"),I=p[n++],S=this.viewer.ndsModel.meshManager.getSingleMesh(I);w.parentObj=S,w.geometry=S.geometry,w.bodyUuid=b,w.topolIndex=x,w.meshId=I,w.matrixWorld=S.matrixWorld.clone();var T=!!p[n++];m=this.MeasureOper.createFace(w,T);break;case 6:g=c[p[n++]],v=c[p[n++]];m=this.MeasureOper.createLineMesh3(g,v,this.MeasureOper.axisLine,1);break;case 7:b=this.viewer.ndsModel.getBodyNode(p[n++]).uuid,M=this.viewer.ndsModel.geomManager.geoms[p[n++]].uuid,x=p[n++],w=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(b,M,x,"edge"),I=p[n++],S=this.viewer.ndsModel.meshManager.getLineSegments(I);w.parentObj=S,w.geometry=S.geometry,w.bodyUuid=b,w.matrixWorld=S.matrixWorld.clone(),w.topolIndex=x,w.lineSegId=I;T=!!p[n++];m=this.MeasureOper.createLine(w,T);break;case 8:for(var A=[],R=0;R<8;R++,n+=3){var O=new THREE.Vector3(p[n],p[n+1],p[n+2]);A.push(O)}m=this.MeasureOper.createBodyBoundingBox(A);break;case 9:for(var P=[],C=p[n++],R=0;R<C;R+=2,n+=2)P.push(p[n]),P.push(p[n+1]),P.push(0);m=this.MeasureOper.createContour(P)}this.rootObject.add(m)}}"radius"==this.measureType?e.holeInfotextPos&&e.holeInfofstClndPos&&(this.MeasureOper.holeInfo.textPos=new THREE.Vector3(e.holeInfotextPos.x,e.holeInfotextPos.y,e.holeInfotextPos.z),this.MeasureOper.holeInfo.fstClndPos=new THREE.Vector3(e.holeInfofstClndPos.x,e.holeInfofstClndPos.y,e.holeInfofstClndPos.z)):"faceArea"==this.measureType?this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:e.faceArea,modelUnit:e.faceAreaunit}):"BoundingBox"==this.measureType&&this.MeasureOper.measureBoundingBox(!0)}},lt.prototype.setMeasureBox=function(e){e&&e.textBox&&e.textPos&&(this.textBoxBroadcast||(this.textBoxBroadcast=document.createElement("div"),this.textBoxBroadcast.className="mearesult",this.viewer.container.appendChild(this.textBoxBroadcast)),this.textPosBroadcast=new THREE.Vector3(e.textPos.x,e.textPos.y,e.textPos.z),e=this.dimString+this.unit,this.MeasureOper.getAndShowTextBox(this.textPosBroadcast.clone(),e,this.textBoxBroadcast))},lt.prototype.clearMeasureBox=function(){this.textBoxBroadcast&&(this.viewer.container.removeChild(this.textBoxBroadcast),this.textBoxBroadcast=null,this.textPosBroadcast=null),this.MeasureOper.clearFaceInfo(),this.MeasureOper.clearHoleInfo(),this.MeasureOper.clearEdgeInfo(),this.MeasureOper.clearDistanceInfo(),this.MeasureOper.clearLineAngleInfo(),this.MeasureOper.clearContoursInfo()},lt.prototype.setDimString=function(e,t){switch(this.measureType){case"pt2pt":case"PointToLine":case"PointToFace":case"LineToLine":case"LineToFace":case"AxisToPoint":case"AxisToLine":case"AxisToFace":case"LineAngle":case"LineFaceAngle":case"faceDist":this.MeasureOper.distanceInfo.dimString=e,this.MeasureOper.distanceInfo.unit=t;break;case"faceAngle":this.MeasureOper.faceInfo.dimString=e,this.MeasureOper.faceInfo.unit=t;break;case"measureEdges":this.MeasureOper.edgeInfo.dimString=e,this.MeasureOper.edgeInfo.unit=t;break;case"bodyAngle":this.MeasureOper.faceInfo.dimString=e,this.MeasureOper.faceInfo.unit=t;break;case"bodyDistance":this.MeasureOper.distanceInfo.dimString=e,this.MeasureOper.distanceInfo.unit=t;break;case"bodyEdgeLength":this.MeasureOper.edgeInfo.dimString=e,this.MeasureOper.edgeInfo.unit=t}},lt.prototype.getDimString=function(){switch(this.measureType){case"pt2pt":case"PointToLine":case"PointToFace":case"LineToLine":case"LineToFace":case"AxisToPoint":case"AxisToLine":case"AxisToFace":case"Lineargauge":case"faceDist":case"holeDist":return{str:(this.MeasureOper.distanceInfo.dimString*this.viewer.measuringScale).toFixed(2),unit:this.MeasureOper.distanceInfo.unit};case"LineAngle":case"LineFaceAngle":return{str:this.MeasureOper.lineAngleInfo.dimString,unit:this.MeasureOper.lineAngleInfo.unit};case"faceAngle":return{str:this.MeasureOper.faceInfo.dimString,unit:this.MeasureOper.faceInfo.unit};case"measureEdges":var e="";return""==this.MeasureOper.edgeInfo.dimString?{str:e,unit:this.MeasureOper.edgeInfo.unit}:{str:e="⌒"==this.MeasureOper.edgeInfo.dimString[0]?"⌒ "+(this.MeasureOper.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2):(this.MeasureOper.edgeInfo.dimString*this.viewer.measuringScale).toFixed(2),unit:this.MeasureOper.edgeInfo.unit};case"radius":return""==this.MeasureOper.holeInfo.dimString?{str:this.MeasureOper.holeInfo.dimString,unit:this.MeasureOper.holeInfo.unit}:{str:e=this.MeasureOper.holeInfo.dimString.slice(0,2)+(this.MeasureOper.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2),unit:this.MeasureOper.holeInfo.unit};case"coordinate":return{str:this.MeasureOper.coordinatedivdims,unit:" "};case"bodyAngle":return this.MeasureOper.lineAngleInfo.dimString?{str:this.MeasureOper.lineAngleInfo.dimString,unit:this.MeasureOper.lineAngleInfo.unit}:{str:this.MeasureOper.faceInfo.dimString,unit:this.MeasureOper.faceInfo.unit};case"bodyDistance":return{str:(this.MeasureOper.distanceInfo.dimString*this.viewer.measuringScale).toFixed(2),unit:this.MeasureOper.distanceInfo.unit};case"bodyEdgeLength":e="";return""==this.MeasureOper.edgeInfo.dimString?{str:e,unit:this.MeasureOper.edgeInfo.unit}:{str:e="⌒"==this.MeasureOper.edgeInfo.dimString[0]?"⌒ "+(this.MeasureOper.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(2):(this.MeasureOper.edgeInfo.dimString*this.viewer.measuringScale).toFixed(2),unit:this.MeasureOper.edgeInfo.unit}}},lt.prototype.createMouseZoomArea=function(){var e,t,n;this.hasZoomArea||(e=document.createElement("div"),(t=document.createElement("canvas")).id="ZoomArea",t.style.height=this.pixWidth+"px",t.style.width=this.pixWidth+"px",e.id="ZoomCanvas",e.style.zIndex=4,e.style.width=this.pixWidth+"px",e.style.height=this.pixWidth+"px",e.style.position="fixed",e.style.top="20px",e.style.left="20px",e.onmouseup=function(e){n.singleTouchEndPos.set(e.clientX,e.clientY),e.preventDefault(),n.onTouchSingleEnd(e)},e.onmousedown=function(e){n.singleTouchStartPos.set(e.clientX,e.clientY),e.preventDefault(),n.onTouchSingleStart(e)},e.appendChild(t),this.viewer.container.appendChild(e),this.hasZoomArea=!0,this.imgMouseObject=new Image,this.imgMouseObject.src="img/mouse_"+this.dpr.toString()+"x.png",(n=this).imgMouseObject.onload=function(){t.width=Math.floor(n.imgMouseObject.width*n.dpr),t.height=Math.floor(n.imgMouseObject.height*n.dpr)})},lt.prototype.changeMouseZoomArea=function(e){var t,n,i;!this.showMouseZoomArea||(t=document.getElementById("ZoomCanvas"))&&("inline"==t.style.display||e)&&(n=this.viewer.container.getBoundingClientRect(),i=parseInt(this.pointer.x)-this.pixWidth/2+n.left,n=parseInt(this.pointer.y)-this.pixWidth+n.top,t.style.top=n+"px",t.style.left=i+"px",i=(n=document.getElementById("ZoomArea")).getContext("2d"),n.width=this.imgMouseObject.width*this.dpr,n.height=this.imgMouseObject.height*this.dpr,i.scale(this.dpr,this.dpr),i.drawImage(this.imgMouseObject,0,0),"inline"!=t.style.display&&e&&(t.style.display="inline"))},lt.prototype.createZoomArea=function(){var e,t,n,i;this.hasZoomArea||(n=document.createElement("div"),(e=document.createElement("canvas")).id="ZoomArea",e.style.height=this.pixWidth+"px",e.style.width=this.pixWidth+"px",n.id="ZoomCanvas",n.style.zIndex=4,n.style.width=this.pixWidth+"px",n.style.height=this.pixWidth+"px",n.style.position="fixed",n.style.top="20px",n.style.left="20px",n.onmouseup=function(e){t.singleTouchEndPos.set(e.clientX,e.clientY),t.onTouchSingleEnd(e)},n.onmousedown=function(e){t.singleTouchStartPos.set(e.clientX,e.clientY),t.onTouchSingleStart(e)},n.appendChild(e),this.viewer.container.appendChild(n),this.hasZoomArea=!0,n=(t=this).viewer.getScreenCapture(null,null,null),this.imageData=n,(i=new Image).src=n,i.onload=function(){var e=t.viewer.container.getBoundingClientRect();t.clientWidthRatio=i.width/e.width,t.clientHeightRatio=i.height/e.height})},lt.prototype.clearZoomArea=function(){var e=document.getElementById("ZoomArea");e&&e.getContext("2d").clearRect(0,0,this.pixWidth,this.pixWidth);var t=document.getElementById("ZoomCanvas");t&&(e=document.getElementById("ZoomArea"),t.removeChild(e),this.viewer.container.removeChild(t),this.hasZoomArea=!1),this.imageData=null},lt.prototype.getZoomAreaVisible=function(){var e=document.getElementById("ZoomCanvas");return!!e&&"inline"==e.style.display},lt.prototype.invisible=function(){var e=document.getElementById("ZoomCanvas");e&&(e.style.display="none");e=document.getElementById("ZoomArea");e&&e.getContext("2d").clearRect(0,0,this.pixWidth,this.pixWidth),this.imageData=null},lt.prototype.changeZoomArea=function(e){var r,t,o,n=document.getElementById("ZoomCanvas");this.clientHeightRatio&&n&&("inline"==n.style.display||e)&&(this.imageData?t=this.imageData:(t=this.viewer.getScreenCapture(null,null,null),this.imageData=t),t=this.viewer.getScreenCapture(null,null,null),(r=new Image).src=t,t=this.viewer.container.getBoundingClientRect(),r.width=t.width*this.clientWidthRatio,r.height=t.height*this.clientHeightRatio,o=this,r.onload=function(){var e=o.pixWidth;o.getImagePortion(r,e,e,o.pointer.x*o.clientWidthRatio-e/2,o.pointer.y*o.clientHeightRatio-e/2,1);var t,n,i=document.getElementById("ZoomArea").getContext("2d");i.moveTo(e/2-20,e/2),i.lineTo(e/2+20,e/2),i.moveTo(e/2,e/2-20),i.lineTo(e/2,e/2+20),i.lineWidth=1,i.strokeStyle="#FF0000",i.stroke(),o.MeasureOper.snappedPoint&&(n=o.MeasureOper.get2dPoint(o.MeasureOper.snappedPoint.clone()),t=o.pointer.x*o.clientWidthRatio-n.x,n=o.pointer.y*o.clientHeightRatio-n.y,i.fillStyle="#00FFFF",i.beginPath(),i.arc(e/2-t,e/2-n,2,0,2*Math.PI),i.closePath(),i.fill())},"inline"!=n.style.display&&e&&(n.style.display="inline"))},lt.prototype.getImagePortion=function(e,t,n,i,r,o){var a=document.getElementById("ZoomArea"),s=a.getContext("2d");a.width=t,a.height=n;var l=document.createElement("canvas"),a=l.getContext("2d");l.width=e.width,l.height=e.height,a.drawImage(e,0,0),s.drawImage(l,i,r,t*o,n*o,0,0,t,n)};var dt=function(e){ce.call(this,e),this.type="OpOrbit"};dt.prototype=Object.create(ce.prototype),dt.prototype.onOpOrbit=function(){var e=new THREE.Vector2,t=new THREE.Vector2;e.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),t.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y));var n=t.x-e.x,e=t.y-e.y;this.rotate(new THREE.Vector3(n,e,0))},dt.prototype.onLMouseMove=function(e){this.onOpOrbit()},dt.prototype.onTouchSingleMove=function(e){this.onOpOrbit()};var ct=function(e){ce.call(this,e),this.type="OpPan"};ct.prototype=Object.create(ce.prototype),ct.prototype.onOpPan=function(){var e=this.pointer.x-this.pointerOld.x,t=this.pointer.y-this.pointerOld.y;this.pan(new THREE.Vector3(-e,t,0))},ct.prototype.onLMouseMove=function(e){this.onOpPan()},ct.prototype.onTouchSingleMove=function(e){this.onOpPan()};var ht=function(e){ce.call(this,e),this.type="OpZoom"};ht.prototype=Object.create(ce.prototype),ht.prototype.onOpZoom=function(){var e=this.pointer.y-this.pointerOld.y;this.zoom(new THREE.Vector3(0,0,5*e))},ht.prototype.onLMouseMove=function(e){this.onOpZoom()},ht.prototype.onTouchSingleMove=function(e){this.onOpZoom()};var ut=function(e){ce.call(this,e),this.type="OpZoomWindow",this.clearCanvas2D=function(){var e=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e)},this.zoomToRect=function(e,t,n,i){var r,o=this.viewer.container.getBoundingClientRect(),a=Math.abs(n-e),s=Math.abs(i-t);0!=a&&0!=s&&(n=[.5*(e+n),.5*(t+i)],t=new THREE.Vector3,null!=(i=this.viewer.getIntersectionPtByScreenPt(n,!1))?t.set(i.coords[0],i.coords[1],i.coords[2]):(r=this.viewer.clientCoordToModelCoord(n),t.set(r[0],r[1],r[2])),n=this.viewer.camera.position,n=(r=this.viewer.camera.target.clone().sub(n)).length(),r.normalize(),s=Math.min(o.width/a,o.height/s),r.multiplyScalar(-(n/s)),r.add(t),this.viewer.camera.position.set(r.x,r.y,r.z),this.viewer.camera.setCameraTarget(t),this.viewer.camera.updateProjectionMatrix(),this.viewer.render())},this.drawRectangle=function(e,t,n,i){this.clearCanvas2D();var r=this.viewer.canvas2D.getContext("2d");r.strokeStyle="#00FFFF",r.setLineDash([5,5]),r.beginPath(),r.moveTo(e,t),r.lineTo(n,t),r.lineTo(n,i),r.lineTo(e,i),r.lineTo(e,t),r.closePath(),r.stroke(),r.setLineDash([])}};ut.prototype=Object.create(ce.prototype),ut.prototype.release=function(){this.clearCanvas2D(),ce.prototype.release.call(this)},ut.prototype.onLMouseDown=function(e){e.preventDefault(),ce.prototype.onLMouseDown.call(this,e)},ut.prototype.onLMouseMove=function(e){e.preventDefault();e=this.viewer.renderer.getPixelRatio();this.drawRectangle(this.lMouseDown.x*e,this.lMouseDown.y*e,this.pointer.x*e,this.pointer.y*e)},ut.prototype.onLMouseUp=function(e){e.preventDefault(),ce.prototype.onLMouseUp.call(this,e),this.clearCanvas2D(),this.zoomToRect(this.lMouseDown.x,this.lMouseDown.y,this.lMouseUp.x,this.lMouseUp.y)},ut.prototype.onTouchSingleStart=function(e){e.preventDefault(),ce.prototype.onTouchSingleStart.call(this,e)},ut.prototype.onTouchSingleMove=function(e){e.preventDefault();e=this.viewer.renderer.getPixelRatio();this.drawRectangle(this.singleTouchStartPos.x*e,this.singleTouchStartPos.y*e,this.pointer.x*e,this.pointer.y*e)},ut.prototype.onTouchSingleEnd=function(e){e.preventDefault(),ce.prototype.onTouchSingleEnd.call(this,e),this.clearCanvas2D(),this.zoomToRect(this.singleTouchStartPos.x,this.singleTouchStartPos.y,this.singleTouchEndPos.x,this.singleTouchEndPos.y)};function ft(e){var t=e.viewer,n=t.camera,i=e.objects,r=e.domElement,o=e.group,a=null,s=(new THREE.Plane,new THREE.Raycaster),l=new THREE.Vector2,d=(new THREE.Vector3,null),c=!1,h=!0,u=!1,f=!1,p=!(this._enabled=!0),m=1,g=this;function v(e,t){if(e)switch(e){case"translate":g.setTransformEnable();break;case"rotate":g.setRotateEnable();break;case"both":g.setTransRotEnable()}ye.isMobileDevice()?(r.addEventListener("touchstart",E,!1),r.addEventListener("touchmove",b,!1),r.addEventListener("touchend",M,!1)):(r.addEventListener("mousemove",b,!1),r.addEventListener("mousedown",E,!1),r.addEventListener("mouseup",M,!1)),h?((a=new P(n,r,t)).setMode("translate"),a.setSpace("local"),o.add(a)):u?((a=new P(n,r,t)).setMode("rotate"),a.setSpace("local"),o.add(a)):f&&((a=new P(n,r,t)).setMode("both"),a.setSpace("local"),o.add(a)),g.setSize(m),p=!0}function y(){null!=a&&a.detach(a.object),ye.isMobileDevice()?(r.removeEventListener("touchstart",E,!1),r.removeEventListener("touchmove",b,!1),r.removeEventListener("touchend",M,!1)):(r.removeEventListener("mousemove",b,!1),r.removeEventListener("mousedown",E,!1),r.removeEventListener("mouseup",M,!1))}function E(e){c=!1,e.preventDefault(),e.stopPropagation();var t=e;ye.isMobileDevice()&&0<e.changedTouches.length&&(t=e.changedTouches[0]);e=r.getBoundingClientRect();l.x=(t.clientX-e.left)/e.width*2-1,l.y=2*-((t.clientY-e.top)/e.height)+1,n instanceof fe?n.setCastRay(s,l.x,l.y):s.setFromCamera(l,n);e=s.intersectObjects(i);0<e.length&&(d=e[0].object,r.style.cursor="move",g.dispatchEvent({type:"mousedown",object:d}))}function b(e){e.preventDefault(),e.stopPropagation(),c=!0}function M(e){null!=e&&e.preventDefault(),c?g.dispatchEvent({type:"mouseup",object:d}):(a.detach(a.object),null!=d&&g.attachTo(d)),t.render(),d=null,r.style.cursor="auto"}this.isActive=function(){return p},this.getCurrAttachObj=function(){if(a)return a.object},this.setSize=function(e){m=e,a&&a.setSize(e)},this.addEventListener=function(e,t){a&&a.addEventListener(e,t)},this.getCurrentControls=function(){return a},this.getObjByName=function(e){return i[e]},this.attachTo=function(e){a.detach(a.object),null!=e&&a&&a.attach(e),t.render()},this.detach=function(){a&&a.detach(a.object)},this.isSelected=function(){var e=!1;return e=a?a.isSelected():e},this.update=function(){a&&(a.update(),a.updateMatrixWorld(!0))},this.setTransformEnable=function(){f=u=!(h=!0)},this.setRotateEnable=function(){h=!(u=!0)},this.setTransRotEnable=function(){u=h=!(f=!0)},this.setEnabled=function(e){e?this._enabled||v():this._enabled&&y(),this._enabled=e},this.activate=v,this.deactivate=y,this.dispose=function(){y()}}var pt=function(e){this.viewer=e;var L=this,m=null,D=null,g=!1,H=null,v=null;this.broadcastInfo=null,this.onTouchMove=function(e){if(!L.viewer.isClipTransformControlSelected()&&!L.viewer.isLightEditControlSelected()){switch(e.stopPropagation(),e.touches.length){case 1:var t=e.touches[0].offsetX||e.touches[0].clientX-L.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-L.viewer.container.getBoundingClientRect().top;if(L.viewer.limitEventArea){var i=L.viewer.container.getBoundingClientRect().width,r=L.viewer.container.getBoundingClientRect().height;if(i<t||r<n)return}break;case 2:t=e.touches[0].offsetX||e.touches[0].clientX-L.viewer.container.getBoundingClientRect().left,n=e.touches[0].offsetY||e.touches[0].clientY-L.viewer.container.getBoundingClientRect().top;if(t=e.touches[1].offsetX||e.touches[1].clientX-L.viewer.container.getBoundingClientRect().left,n=e.touches[1].offsetY||e.touches[1].clientY-L.viewer.container.getBoundingClientRect().top,L.viewer.limitEventArea){i=L.viewer.container.getBoundingClientRect().width,r=L.viewer.container.getBoundingClientRect().height;if((L.pointer.x>i||L.pointer.y>r)&&(L.pointer2nd.x>i||L.pointer2nd.y>r))return}}if(null==m&&(m=new THREE.Vector2),"OpMeasure"==L.viewer.getCurrentOperatorID()){null==v&&(v=new THREE.Vector3);var o=L.viewer.controls.getOperator().MeasureOper.getIntersectsByPriorityOfLine(t,n),a=null;if(o&&0<o.length)for(var s=0;s<o.length;){if(null!=o[s].object){a=o[s].point.clone();break}s++}a?v.set(a.x,a.y,a.z):v=null}else v=null;var l=L.viewer.renderer.getPixelRatio();m.set(t*l/L.viewer.renderer.domElement.width,n*l/L.viewer.renderer.domElement.height)}},this.onBroadcastMouseMove=function(e){var t=e.offsetX||e.clientX-L.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-L.viewer.container.getBoundingClientRect().top;if(e.srcElement&&e.srcElement!==L.viewer.renderer.domElement&&(t=e.clientX-L.viewer.container.getBoundingClientRect().left,n=e.clientY-L.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==L.viewer.renderer.domElement&&(t=e.clientX-L.viewer.container.getBoundingClientRect().left,n=e.clientY-L.viewer.container.getBoundingClientRect().top),null==m&&(m=new THREE.Vector2),"OpMeasure"==L.viewer.getCurrentOperatorID()){null==v&&(v=new THREE.Vector3);var i=L.viewer.controls.getOperator().MeasureOper.getIntersectsByPriorityOfLine(t,n),r=null;if(i&&0<i.length)for(var o=0;o<i.length;){if(null!=i[o].object){r=i[o].point.clone();break}o++}r?v.set(r.x,r.y,r.z):v=null}else v=null;var a=L.viewer.renderer.getPixelRatio();m.set(t*a/L.viewer.renderer.domElement.width,n*a/L.viewer.renderer.domElement.height),g=!1,e.srcElement&&("toolbar"!=e.srcElement.className&&"toolbar-button"!=e.srcElement.className&&"dialog"!=e.srcElement.className&&"explode-tool-slider"!=e.srcElement.className||(g=!0)),null==e.srcElement&&e.target&&("toolbar"!=e.target.className&&"toolbar-button"!=e.target.className&&"dialog"!=e.target.className&&"explode-tool-slider"!=e.target.className||(g=!0))},this.getBroadcastInfo=function(){var e,t,n={version:1,isMobile:ye.isMobileDevice(),operator:L.viewer.getCurrentOperatorID(),state:L.viewer.getCurrentOperatorState(),explode:{factor:L.viewer.getExplodeFactor(),mode:L.viewer.getExplodeMode(),level:L.viewer.getExplodeLevel()},annoSetting:0,line:L.viewer.getLinesVisibility()?1:0,mousePos:m?[m.x,m.y]:[-1,-1],worldPos:v?[v.x,v.y,v.z]:[-1,-1,-1],ClearColor:L.viewer.clearColor,camera:{pos:[L.viewer.camera.position.x,L.viewer.camera.position.y,L.viewer.camera.position.z],center:[L.viewer.camera.getCameraTarget().x,L.viewer.camera.getCameraTarget().y,L.viewer.camera.getCameraTarget().z],fov:L.viewer.camera.fov,persp:L.viewer.camera.isPerspective?1:0,near:L.viewer.camera.near,far:L.viewer.camera.far,up:[L.viewer.camera.up.x,L.viewer.camera.up.y,L.viewer.camera.up.z]},selfromTree:L.viewer.selectionManager.selectfromtree,measuringScale:L.viewer.measuringScale};if("OpZoomWindow"==n.operator&&(t={x:0,y:0},e=L.viewer.renderer.getPixelRatio(),n.state==NDS.MOUSE.LEFT?(t.x=L.viewer.controls.getOperator().lMouseDown.x,t.y=L.viewer.controls.getOperator().lMouseDown.y):n.state==NDS.TOUCH.TOUCH_SINGLE&&(t.x=L.viewer.controls.getOperator().singleTouchStartPos.x,t.y=L.viewer.controls.getOperator().singleTouchStartPos.y),t.x=t.x*e/L.viewer.renderer.domElement.width,t.y=t.y*e/L.viewer.renderer.domElement.height,n.lMouseDown=t),"OpMeasure"==n.operator&&(n.click=L.viewer.controls.getOperator().click,n.InfoType=L.viewer.controls.getOperator().InfoType,n.MeasureType=L.viewer.controls.getOperator().measureType,(t=L.viewer.controls.getOperator().getDimString())?(n.unit=t.unit,n.dimString=t.str):(n.unit="",n.dimString=""),n.measureRelease=L.viewer.controls.getOperator().measureRelease,n.MeasureContent=L.viewer.controls.getOperator().getMeasureContent(),L.viewer.controls.getOperator().click=!1,L.viewer.controls.getOperator().measureRelease=!1),"OpDrag"==n.operator&&(n.opMode=L.viewer.controls.getOperator().opMode),""!=L.viewer.renderer.domElement.style.cursor)switch(L.viewer.renderer.domElement.style.cursor){case'url("img/cursorOrbit.ico"), wait':n.cursor="Orbit";break;case'url("img/cursorPan.ico"), wait':n.cursor="Pan";break;case'url("img/cursorZoom.ico"), wait':n.cursor="Zoom";break;case'url("img/cursorCross.ico"), crosshair':n.cursor="Cross"}L.viewer.syncSendMsg(n),g&&(n.cursor="Normal"),L.viewer.Optoolbar&&(L.viewer.Optoolbar.getExplodeDlgVisibility()&&(n.explodeDlg=1,n.explodeDlgValue=L.viewer.Optoolbar.getExplodeDlgValue()),n.annoSetting=L.viewer.Optoolbar.getAnnotationSetting()?1:0,(i=L.viewer.Optoolbar.getDispStyleToolbar())&&(i.getVisibility()?n.DispStyle=!0:n.DispStyle=!1),(i=L.viewer.Optoolbar.getMeasureDlg())&&(n.measureDlg=i.dialog.getVisibility(),n.checkID=i.getChecked()));var i,r=void 0;switch(L.viewer.getRenderMode()){case 0:r="lighting";break;case 1:r="primarycolor";break;case 2:r="wireframe";break;case 3:r="whitemold";break;case 4:r="shadedWithEdges";break;case 5:r="shaded";break;case 6:r="hiddenLineRemove";break;case 7:r="hiddenLineVisible"}n.RenderMode=r,null!=L.viewer.clipBoxManager.active&&(n.clipBoxActive=L.viewer.clipBoxManager.active,n.clipBoxActive&&((i=L.viewer.clipBoxManager.getPlaneEditControls()).getCurrAttachObj()&&(n.PlaneName=i.getCurrAttachObj().name,n.PlanePosition=i.getCurrentControls().newPosition),i=L.viewer.clipBoxManager.getTransformControls().object.position,n.BoxPosition=i)),L.viewer.isSectionViewEnabled()&&(n.clipPlaneInfo=L.viewer.clipPlaneManager.getClipPlaneInfor());var o=[],a=[],s=[],l=[],d=[];if(L.viewer.ndsModel){var c=L.viewer.ndsModel.getSelectedBodies();if(0<c.length){n.meshSel=[];for(var h=0;h<c.length;++h)n.meshSel.push(c[h].id)}if(0<L.viewer.ndsModel.draggedBodies.length)for(var u=0;u<L.viewer.ndsModel.draggedBodies.length;++u){var f=L.viewer.ndsModel.draggedBodies[u];d.push({id:f.id,dragPos:f.leafBodyAttri.bodyDragTranslate})}for(var u=0,p=L.viewer.ndsModel.wholeLeafBodyNodes.length;u<p;++u)(f=L.viewer.ndsModel.wholeLeafBodyNodes[u]).leafBodyAttri&&((f.isHidden()?a:o).push(f.id),L.viewer.ndsModel.inIsolate()&&(!f.isIsolated()&&f.isTransparent()?s:l).push(f.id))}return 0<d.length&&(n.meshDrag=d),0==a.length?n.meshInvisible=[]:0==o.length&&0<a.length?n.meshVisible=[]:a.length<=o.length?n.meshInvisible=a:n.meshVisible=o,s.length<=l.length?n.meshTrans=s:n.meshNoTrans=l,L.viewer.Optoolbar&&L.viewer.Optoolbar.getDragToolbarBtnSelected()&&(n.dragBtn=L.viewer.Optoolbar.getDragToolbarBtnSelected()),L.viewer.annotationsManager&&(n.annotationsVisible=L.viewer.annotationsManager.isAnnotationsVisible(),n.SelectAnnotation=L.viewer.annotationsManager.getSelectAnnotation()),n},this.startBroadcast=function(e){L.exitBroadcast(),Ue.enableBroadcast=!0,Ue.broadcastMajor=null!=e&&e;e=L.viewer.controls.getOperator();"OpMeasure"==e.type&&e.restrictMeasuretime(),Ue.broadcastMajor&&(document.addEventListener("mousemove",L.onBroadcastMouseMove,!1),document.addEventListener("touchmove",L.onTouchMove,!1))},this.exitBroadcast=function(){Ue.enableBroadcast&&Ue.broadcastMajor&&(document.removeEventListener("mousemove",L.onBroadcastMouseMove,!1),document.removeEventListener("touchmove",L.onTouchMove,!1)),Ue.enableBroadcast=!1,Ue.broadcastMajor=!1,m=null,g=!1,D&&L.viewer.container.removeChild(D),D=null},this.setBroadcastInfo=function(e){try{if(!Ue.enableBroadcast)return;if(null==e)return;if(L.viewer.syncGetMsg(e),e.operator&&L.viewer.getCurrentOperatorID()!=e.operator)switch(e.operator){case"OpOrbit":L.viewer.controls.setOperator(new dt(L.viewer)),L.viewer.controls.addEventListener("change",L.viewer.render),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnOrbit")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpOrbit"});break;case"OpPan":L.viewer.controls.setOperator(new ct(L.viewer)),L.viewer.controls.addEventListener("change",L.viewer.render),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnPan")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpPan"});break;case"OpZoom":L.viewer.controls.setOperator(new ht(L.viewer)),L.viewer.controls.addEventListener("change",L.viewer.render),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnZoom")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpZoom"});break;case"OpDrag":L.viewer.controls.setOperator(new We(L.viewer)),L.viewer.controls.addEventListener("change",L.viewer.render),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnDrag")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpDrag"});break;case"OpZoomWindow":L.viewer.controls.setOperator(new ut(L.viewer)),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnZoomWindow")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpZoomWindow"});break;case"OpMeasure":L.viewer.controls.setOperator(new lt(L.viewer)),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnMeasure")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpMeasure"})}for(var t,n,i,r,o,a,s,l,d,c,h,u,f,p,m,g;0<L.viewer.ndsModel.draggedBodies.length;)(y=L.viewer.ndsModel.draggedBodies[0]).leafBodyAttri&&y.isDragged()&&(y.setDragged(!1),y.leafBodyAttri.bodyDragTranslate[0]=0,y.leafBodyAttri.bodyDragTranslate[1]=0,y.leafBodyAttri.bodyDragTranslate[2]=0,-1<(t=L.viewer.ndsModel.draggedBodies.indexOf(y))&&L.viewer.ndsModel.draggedBodies.splice(t,1),L.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(y));if(e.meshDrag&&0<e.meshDrag.length)if(L.viewer.ndsModel)for(var v=0;v<e.meshDrag.length;++v){var y=L.viewer.ndsModel.getBodyNode(e.meshDrag[v].id),E=new THREE.Vector3;E.fromArray(e.meshDrag[v].dragPos),y.leafBodyAttri&&(y.isDragged()||(y.setDragged(!0),L.viewer.ndsModel.draggedBodies.push(y)),y.leafBodyAttri.bodyDragTranslate[0]=E.x,y.leafBodyAttri.bodyDragTranslate[1]=E.y,y.leafBodyAttri.bodyDragTranslate[2]=E.z,L.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(y))}else for(var b=new THREE.Vector3,v=0;v<e.meshDrag.length;++v)(I=L.viewer.scene.getObjectByProperty("uuid",e.meshDrag[v].uuid))&&(void 0===I.matrixWorldTransOrginal&&(I.matrixWorldTransOrginal=new THREE.Vector3,I.matrixWorldTransOrginal.setFromMatrixPosition(I.matrixWorld)),null==I.matrixWorldTransOrginalDrag&&(I.matrixWorldTransOrginalDrag=new THREE.Vector3),I.matrixWorldTransOrginalDrag.fromArray(e.meshDrag[v].dragPos),b.copy(I.matrixWorldTransOrginal),b.add(I.matrixWorldTransOrginalDrag),I.matrixWorld.setPosition(b));if("OpZoomWindow"!=e.operator||e.state!=NDS.MOUSE.LEFT&&e.state!=NDS.TOUCH.TOUCH_SINGLE?"OpZoomWindow"==e.operator&&(i=L.viewer.controls.getOperator()).clearCanvas2D():(L.viewer.controls.getOperator().state=e.state,B=L.viewer.renderer.getPixelRatio(),(i=L.viewer.controls.getOperator()).drawRectangle(e.lMouseDown.x*L.viewer.renderer.domElement.width,e.lMouseDown.y*L.viewer.renderer.domElement.height,e.mousePos[0]*L.viewer.renderer.domElement.width,e.mousePos[1]*L.viewer.renderer.domElement.height)),"OpMeasure"!=e.operator||!L.viewer.brepManager.hasBrepInfo()&&L.viewer.hasBrepFile()?"OpDrag"==e.operator&&(L.viewer.controls.getOperator().opMode=e.opMode):(e.measureRelease&&L.viewer.getCurrentOperatorID()==e.operator&&(L.viewer.controls.setOperator(new lt(L.viewer)),L.viewer.tlbOperator?(n={target:L.viewer.tlbOperator.getChildElement("btnMeasure")},L.viewer.onOpChanged(n)):L.viewer.onOpChanged({id:"OpMeasure"})),i=L.viewer.controls.getOperator(),e.MeasureType!=i.measureType&&i.setMeasureType(e.MeasureType),i.PostInfo(e.InfoType),""!=e.dimString&&(i.dimString=e.dimString),""!=e.unit&&(i.unit=e.unit),i.setMeasureContent(e.MeasureContent),0<e.MeasureContent.perimeterInfos.length?L.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:e.MeasureContent.perimeterBroadcast,modelUnit:e.MeasureContent.perimeterunit}):(i.MeasureOper.clearPerimetrBox(),L.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]})),L.viewer.measuringScale!=e.measuringScale&&L.viewer.setMeasuringScale(e.measuringScale),L.viewer.Optoolbar&&L.viewer.Optoolbar.getMeasureDlg().setChecked(e.checkID),-1!=e.worldPos[0]||-1!=e.worldPos[1]||-1!=e.worldPos[2]?(r=L.viewer.modelCoordToClientCoord(e.worldPos))&&(r[0],r[1],r[0],r[1]):(e.mousePos[0],L.viewer.renderer.domElement.width,e.mousePos[1],L.viewer.renderer.domElement.height,e.mousePos[0],L.viewer.renderer.domElement.width,e.mousePos[1],L.viewer.renderer.domElement.height)),"OpMeasure"==e.operator&&!L.viewer.brepManager.hasBrepInfo()&&L.viewer.hasBrepFile()?L.broadcastInfo=e:L.broadcastInfo=null,!L.viewer.Optoolbar||(o=L.viewer.Optoolbar.getDispStyleToolbar())&&o.setVisibility(e.DispStyle),e.RenderMode&&L.viewer.setRenderMode(e.RenderMode,!0),null!=e.annotationsVisible&&""==e.SelectAnnotation&&L.viewer.setAnnotationsVisibility(e.annotationsVisible),null!=e.clipBoxActive&&L.viewer.clipBoxManager.active!=e.clipBoxActive&&L.viewer.clipBoxManager.onBoxSectionView(e.clipBoxActive),null!=e.PlaneName&&((a=L.viewer.clipBoxManager.getPlaneEditControls()).getCurrentControls().newPosition.equals(e.PlanePosition)||(a.getCurrentControls().newPosition.copy(e.PlanePosition),s=L.viewer.clipBoxManager.getTransformControls().object.children[e.PlaneName],l=new THREE.Vector3(H.x-e.BoxPosition.x,H.y-e.BoxPosition.y,H.z-e.BoxPosition.z),H=e.BoxPosition,3==e.PlaneName||4==e.PlaneName||5==e.PlaneName?s.position.copy(e.PlanePosition):s.position.sub(l),d={type:"objectChange"},L.viewer.clipBoxManager.getPlaneEditControls().getCurrentControls().dispatchEvent(d))),e.clipBoxActive&&null==e.PlaneName&&e.BoxPosition&&(L.viewer.clipBoxManager.getTransformControls().object.position.copy(e.BoxPosition),d={type:"objectChange"},L.viewer.clipBoxManager.getTransformControls().dispatchEvent(d),H=e.BoxPosition),!L.viewer.Optoolbar||null==(c=L.viewer.Optoolbar.getMeasureDlg())&&(c=new de(L.viewer),L.viewer.Optoolbar.setMeasureDlg(c)),null!=e.measureDlg&&c.show(e.measureDlg),(L.viewer.bLinesVisibility&&0==e.line||!L.viewer.bLinesVisibility&&1==e.line)&&(L.viewer.setLinesVisibility(1==e.line,!1),L.viewer.tlbOperator&&(L.viewer.getLinesVisibility()?null==(u=L.viewer.tlbOperator.getChildElement("btnLineInVisible"))&&(h=L.viewer.tlbOperator.getChildElement("btnLineVisible"))&&(h.domElement.id="btnLineInVisible",L.viewer.tlbOperator.updateChildElement("btnLineVisible","btnLineInVisible")):null==(h=L.viewer.tlbOperator.getChildElement("btnLineVisible"))&&(u=L.viewer.tlbOperator.getChildElement("btnLineInVisible"))&&(u.domElement.id="btnLineVisible",L.viewer.tlbOperator.updateChildElement("btnLineInVisible","btnLineVisible")))),null!=e.annoSetting&&L.viewer.tlbOperator&&(f=L.viewer.tlbOperator.getChildElement("btnAnnotationSettingShow"),1==e.annoSetting&&null==f&&((p=L.viewer.tlbOperator.getChildElement("btnAnnotationSettingHide"))&&(p.domElement.id="btnAnnotationSettingShow",L.viewer.tlbOperator.updateChildElement("btnAnnotationSettingHide","btnAnnotationSettingShow")),L.viewer.annotationsManager&&L.viewer.annotationsManager.getAnnotationJsonArray()&&L.viewer.showAnnotations(L.viewer.annotationsManager.getAnnotationJsonArray(),!1)),0==e.annoSetting&&null!=f&&L.viewer.tlbOperator&&(f.domElement.id="btnAnnotationSettingHide",L.viewer.tlbOperator.updateChildElement("btnAnnotationSettingShow","btnAnnotationSettingHide"),L.viewer.annotationsManager&&L.viewer.annotationsManager.removeAllAnnotations(!1))),L.viewer.scene.traverse(function(e){"lightctrls"!=e.name&&(null!=e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0),e.matrixWorldTransExplode?e.matrixWorld.setPosition(e.matrixWorldTransExplode):e.matrixWorldTransOrginal&&e.matrixWorld.setPosition(e.matrixWorldTransOrginal))}),L.viewer.ndsModel)if(null!=e.meshSel&&0<e.meshSel.length){var M=!0,x=L.viewer.ndsModel.getSelectedBodies();if(e.meshSel.length==x.length){for(var w=!0,v=0;v<x.length;++v)if(e.meshSel[v]!=x[v].id){w=!1;break}w&&(M=!1)}if(M){L.viewer.ndsModel.clearSelection();for(var I,S=L.viewer.selectionManager.getSelectedObjects(),v=S.length=0;v<e.meshSel.length;++v)(I=L.viewer.ndsModel.getBodyNode(e.meshSel[v]))&&(L.viewer.ndsModel.meshManager.setSelectedMaterial(Ue.selectedMaterial,Ue.selectedLineMaterial),L.viewer.ndsModel.addSelection(I),S.push(I));var T,A,R=L.viewer.getCurrentMeasureType(),O="BodyVolume"!==R&&"BodyArea"!==R?!0:!1;Ue.enableBodyVolumeMeasure&&(!L.viewer.hasBrepInfo()||L.viewer.productData)&&O&&((T=L.viewer.getSelectedObjectProperty(function(){}))&&1e-7<T.area?L.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:T,modelUnit:T.unit}):L.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&L.viewer.hasBrepInfo()&&!L.viewer.productData&&O&&((A=L.viewer.selectionManager.getSelectedBodyVolumeAndArea())?L.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:A[0],modelUnit:A[1]}):L.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&L.viewer.hasBrepInfo()&&!O&&((A=L.viewer.selectionManager.getSelectedBodyVolumeAndArea())?L.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:A[0],measureType:R,modelUnit:A[1]}):L.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:R,modelUnit:null})),e.selfromTree||L.viewer.dispatchAsyncEvent({type:"selectObjectEvent"})}}else L.viewer.selectionManager.clearSelection();if(null!=e.explode&&(e.explode.mode&NDS.EXPLODEMODE.SELECTED?(x=e.meshSel,L.viewer.setExplodeMode(e.explode.mode,e.explode.level,x)):L.viewer.setExplodeMode(e.explode.mode,e.explode.level,!0),L.viewer.getExplodeFactor()!=e.explode.factor&&L.viewer.explodeModel(e.explode.factor)),null!=e.dragBtn&&L.viewer.Optoolbar&&L.viewer.Optoolbar.setDragToolbarBtnSelected(e.dragBtn),L.viewer.Optoolbar&&(L.viewer.Optoolbar.setExplodeDlgVisibility(1==e.explodeDlg),L.viewer.Optoolbar.setExplodeDlgValue(1==e.explodeDlg?e.explodeDlgValue:0)),e.meshVisible&&L.viewer.ndsModel){L.viewer.ndsModel.hideBody(L.viewer.ndsModel.rootBodyNode);for(v=0;v<e.meshVisible.length;++v){var P=e.meshVisible[v];L.viewer.ndsModel.hasHiddenBodies=!0,(y=L.viewer.ndsModel.getBodyNode(P)).show()}}if(e.meshInvisible&&L.viewer.ndsModel){L.viewer.ndsModel.showBody(L.viewer.ndsModel.rootBodyNode);for(v=0;v<e.meshInvisible.length;++v){P=e.meshInvisible[v];L.viewer.ndsModel.hasHiddenBodies=!0,(y=L.viewer.ndsModel.getBodyNode(P)).hide(),L.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(y)}}if(L.viewer.ndsModel&&L.viewer.ndsModel.inIsolate()&&L.viewer.ndsModel.exitIsolate(),e.meshTrans&&0<e.meshTrans.length&&L.viewer.ndsModel){for(var C=[],v=0;v<e.meshTrans.length;++v){P=e.meshTrans[v];C.push(L.viewer.ndsModel.getBodyNode(P))}L.viewer.ndsModel.transparentizeBodies(C)}if(e.meshNoTrans)if(0<e.meshNoTrans.length){for(C=[],v=0;v<e.meshNoTrans.length;++v){P=e.meshNoTrans[v];C.push(L.viewer.ndsModel.getBodyNode(P))}L.viewer.ndsModel.isolateBodies(C,Ue.bodyOpacity,Ue.lineOpacity)}else 0==e.meshNoTrans.length&&((m=[]).push(L.viewer.ndsModel.rootBodyNode),L.viewer.ndsModel.transparentizeBodies(m));if(null!=e.camera&&(L.viewer.camera.fov=e.camera.fov,L.viewer.camera.near=e.camera.near,L.viewer.camera.far=e.camera.far,L.viewer.camera.position.fromArray(e.camera.pos),L.viewer.camera.up.fromArray(e.camera.up),L.viewer.camera.setCameraTarget((new THREE.Vector3).fromArray(e.camera.center)),L.viewer.camera.isPerspective=e.camera.persp,L.viewer.camera.updateProjectionMatrix(),L.viewer.viewBox&&L.viewer.cameraControl.updateViewBoxCamDir()),null!=e.clipPlaneInfo?(L.viewer.isSectionViewEnabled()||(L.viewer.onSectionView(!0,!1),L.viewer.tlbOperator&&(g=L.viewer.tlbOperator.getChildElement("btnSectionView"))&&(g.setBorder("1px solid rgba(150,150,150,0.8)"),g.setBgColor(Ue.toolbarButtonClickedBkgColor))),L.viewer.clipPlaneManager.setClipPlaneInfor(e.clipPlaneInfo)):L.viewer.isSectionViewEnabled()&&(L.viewer.onSectionView(!1,!1),L.viewer.tlbOperator&&(g=L.viewer.tlbOperator.getChildElement("btnSectionView"))&&(g.setBorder(""),g.setBgColor(""))),null!=e.mousePos&&!e.isMobile){var B=L.viewer.renderer.getPixelRatio();switch(null==D&&((D=document.createElement("div")).className="broadcastMouseDiv",D.onselectstart=function(){return!1},L.viewer.container.appendChild(D)),D.style.top=e.mousePos[1]*L.viewer.renderer.domElement.height/B+"px",D.style.left=e.mousePos[0]*L.viewer.renderer.domElement.width/B+"px","Cross"==e.cursor?(D.style.width="96px",D.style.height="96px"):(D.style.width="24px",D.style.height="24px"),e.cursor){case"Orbit":"broadcastMouseDivOrbit"!=D.id&&(D.id="broadcastMouseDivOrbit");break;case"Pan":"broadcastMouseDivPan"!=D.id&&(D.id="broadcastMouseDivPan");break;case"Zoom":"broadcastMouseDivZoom"!=D.id&&(D.id="broadcastMouseDivZoom");break;case"Normal":"broadcastMouseDivNormal"!=D.id&&(D.id="broadcastMouseDivNormal");break;case"Cross":"broadcastMouseDivCoordinate"!=D.id&&(D.id="broadcastMouseDivCoordinate");break;default:"broadcastMouseDivNormal"!=D.id&&(D.id="broadcastMouseDivNormal")}}(e.isMobile||Ue.broadcastMajor)&&D&&(L.viewer.container.removeChild(D),D=null),L.viewer.render()}catch(e){console.error(e)}}};(ft.prototype=Object.create(THREE.EventDispatcher.prototype)).constructor=ft;["#if NUM_CLIPPING_PLANES > 0","#if ! defined( PHYSICAL ) && ! defined( PHONG )","vViewPosition = - mvPosition.xyz;","#endif","vec4 tempWorldPosition = modelMatrix * vec4( position, 1.0 );","vClippingWorldPosition = tempWorldPosition.xyz;","#endif"].join("\n"),["#if NUM_CLIPPING_PLANES > 0","#if ! defined( PHYSICAL ) && ! defined( PHONG )","varying vec3 vViewPosition;","#endif","varying vec3 vClippingWorldPosition;","#endif"].join("\n");function mt(e,t,n){THREE.Mesh.call(this,e,t,!1),this.plane=n,this.planeVec=new THREE.Vector4(n.normal.x,n.normal.y,n.normal.z,n.constant),this.connectivity=[],this.outlines=[]}var gt=["#if NUM_CLIPPING_PLANES > 0","#if ! defined( PHYSICAL ) && ! defined( PHONG )","varying vec3 vViewPosition;","#endif","uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];","bvec2 checkClippingPlanes() {","bool isCut = false;","bool isCutEdge = false;","for (int i=0; i<NUM_CLIPPING_PLANES; i++) {","vec4 plane = clippingPlanes[ i ];","float dotPlane = dot(vec4(vViewPosition, -1.0), plane);","isCut = isCut || (dotPlane > 0.0 );","if (!isCut) {","isCutEdge = isCutEdge || (abs(dotPlane) < abs(0.0012 * length(vViewPosition)));","}","}","return bvec2(isCut,isCutEdge);","}","#endif"].join("\n"),vt=["#if NUM_CLIPPING_PLANES > 0","bvec2 clipRetVec2NDS = checkClippingPlanes();","if (clipRetVec2NDS.x) discard;","#endif"].join("\n"),yt=["#if NUM_CLIPPING_PLANES > 0","if(clipRetVec2NDS.y) gl_FragColor = vec4(0.8, 0.4, 0.298, 1.0);","#endif","}"].join("\n"),t=(Et=THREE.ShaderChunk.meshphong_frag).lastIndexOf("}"),Et=Et.substr(0,t)+yt,t=(bt=THREE.ShaderChunk.meshphysical_frag).lastIndexOf("}"),bt=bt.substr(0,t)+yt,Mt=(["#if NUM_CLIPPING_PLANES > 0","for ( int i = 0; i < NUM_CLIPPING_PLANES; ++ i ) {","vec4 plane = clippingPlanes[ i ];","if ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;","}","if (!gl_FrontFacing) {","gl_FragColor = vec4(0.8, 0.4, 0.298, 1.0);","return;","}","#endif"].join("\n"),{defines:{NUM_CLIPPING_PLANES_NDS:1},uniforms:{clipping:{color:{type:"c",value:new THREE.Color(16711680)},clippingPlaneNDS:{type:"v4v",value:[0,0,-1,0]}},caps:{color:{type:"c",value:new THREE.Color(.8,.4,.298)}}},vertex:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),vertexClipping:["varying vec4 worldPosition;","varying vec3 camPosition;","void main() {","worldPosition = modelMatrix * vec4( position, 1.0 );","camPosition = cameraPosition;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragment:["uniform vec3 color;","void main( void ) {","gl_FragColor = vec4( color , 1.0 );","}"].join("\n"),fragmentClippingFront:["uniform vec3 color;","uniform vec4 clippingPlaneNDS[NUM_CLIPPING_PLANES_NDS];","varying vec4 worldPosition;","varying vec3 camPosition;","void main() {","#if NUM_CLIPPING_PLANES_NDS > 0","for ( int i = 0; i < NUM_CLIPPING_PLANES_NDS; ++ i ) {","vec4 plane = clippingPlaneNDS[i];","if ( -dot( worldPosition.xyz, plane.xyz ) > plane.w && -dot( camPosition, plane.xyz ) > plane.w) discard;","else {","gl_FragColor = vec4( color , 1.0 );","}","}","#endif","}"].join("\n")}),xt={vertex:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragment:["uniform vec3 color;","uniform vec2 hatchParams;","uniform vec3 hatchTintColor;","uniform float hatchTintIntensity;","vec4 calculateHatchPattern(vec2 hatchParams, vec2 coord, vec4 fragColor, vec3 hatchTintColor, float hatchTintIntensity ) {","float hatchSlope = hatchParams.x;","float hatchPeriod = hatchParams.y;","if (abs(hatchSlope) <= 1.0) {","float hatchPhase = coord.y - hatchSlope * coord.x;","float dist = abs(mod((hatchPhase), (hatchPeriod)));","if (dist < 2.0) {","fragColor = vec4(0.0,0.0,0.0,1.0);","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","}","} else {","float hatchPhase = - coord.y / hatchSlope + coord.x;","float dist = abs(mod((hatchPhase), (hatchPeriod)));","if (dist < 1.0) {","fragColor = vec4(0.0,0.0,0.0,1.0);","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","}","}","return fragColor;","}","void main( void ) {","gl_FragColor = vec4( color , 1.0 );","gl_FragColor = calculateHatchPattern(hatchParams, gl_FragCoord.xy, gl_FragColor, hatchTintColor, hatchTintIntensity);","}"].join("\n")};((mt.prototype=Object.create(THREE.Mesh.prototype)).constructor=mt).prototype.update=function(){this.plane.normal.set(0,0,-1),this.plane.normal.applyQuaternion(this.quaternion);var e=this.plane.normal,t=-1*this.getWorldPosition().dot(e);this.planeVec.set(e.x,e.y,e.z,t),this.plane.constant=t};function wt(e,t,n){var i=this;this.viewer=e;var r=new NDS.Dialog({id:"dlgExplodeTool",className:"dialog",callbackEvent:s,noTitlebar:!0,noScrollbar:!0});r.addEventListener("resize",function(e){a(e)}),r.setVisibility(!1),r.domElement.style.minHeight="20px",r.setSize(120,20),null!=n.toolbarButtonSize&&"small"==n.toolbarButtonSize?r.setPadding({left:4,right:4,top:4,bottom:4}):r.setPadding({left:10,right:10,top:10,bottom:10}),i.viewer.getToolBarAutoHideFlag()&&r.setOpacity(Ue.dialogOpacity),t.setPopupDialog(r),e.container.appendChild(r.domElement),this.dialog=r;var o=new NDS.Slider({id:"sliderExplodeTool",className:"explode-tool-slider",callbackEvent:s});function a(e){var t,n;null!=e.left&&null!=e.bottom?(r.setLeft(e.left),r.setBottom(e.bottom)):(n=(t=i.viewer.tlbOperator).getChildElement("btnExplode").domElement,t=(e=t.domElement).offsetLeft+n.offsetLeft,n=parseInt(ye.getStyle(e,"padding-top"))+parseInt(ye.getStyle(e,"padding-bottom"))+parseInt(ye.getStyle(e,"border-top-width"))+parseInt(ye.getStyle(e,"border-bottom-width"))+parseInt(ye.getStyle(e,"margin-bottom")),n=e.offsetHeight+n,r.setLeft(t),r.setBottom(n))}function s(e){"dlgExplodeTool"===e.target.domElement.id&&function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&i.viewer.getToolBarAutoHideFlag()){var t=e.event.type,n=e.target;switch(t){case"mouseenter":n.deleteOpacity();break;case"mouseleave":n.setOpacity(Ue.toolbarOpacity);break;case"mouseover":n.deleteOpacity();break;case"mouseout":n.setOpacity(Ue.toolbarOpacity);break;case"resize":a()}}}(e)}o.domElement.max="100",o.domElement.step="1",r.domElement.appendChild(o.domElement),o.domElement.oninput=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||i.viewer.explodeModel(o.domElement.value/100)},o.domElement.onchange=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||i.viewer.explodeModel(o.domElement.value/100)},this.resetExplosion=function(){o.domElement.value=0,i.viewer.explodeModel(0)},this.getExplodeDlgValue=function(){return o.domElement.value},this.setExplodeDlgValue=function(e){o.domElement.value=e}}var It=function(E){var b=this;this.viewer=E,this.active=!1;var M=[[0,1],[1,3],[3,2],[2,0]],e=null,e=E.canvas2D||E.canvas3D,x=[],w=[],I=null,S=null,i=null,l=null,r=null,o={},a="Right",n=!0,T={},A={},s=1;function d(){this.run=function(){i&&(i.update(),i.updateMatrixWorld(!0)),l&&l.update()}}o.clipping_planes_fragment=THREE.ShaderChunk.clipping_planes_fragment,o.clipping_planes_pars_fragment=THREE.ShaderChunk.clipping_planes_pars_fragment,o.meshphong_frag=THREE.ShaderChunk.meshphong_frag,o.meshphysical_frag=THREE.ShaderChunk.meshphysical_frag,o.phongFrag=THREE.ShaderLib.phong.fragmentShader,o.physicalFrag=THREE.ShaderLib.physical.fragmentShader,this.getTransformControls=function(){return i},this.getPlaneEditControls=function(){return l},this.SetRenderBox=function(e){n=e},this.getBoxClipInfo=function(){var e={};if(e.clipBoxActive=b.active,e.clipBoxActive){var t=b.getPlaneEditControls();t.getCurrAttachObj()&&(e.PlaneName=t.getCurrAttachObj().name,e.PlanePosition=t.getCurrentControls().newPosition);for(var n=b.viewer.renderer.clippingPlanes,i=new THREE.Vector3(-1e4,-1e4,-1e4),r=new THREE.Vector3(1e4,1e4,1e4),o=0;o<n.length;o++).001<Math.abs(n[o].normal.x)?(i.x=Math.max(i.x,-1*n[o].normal.x*n[o].constant),r.x=Math.min(r.x,-1*n[o].normal.x*n[o].constant)):.001<Math.abs(n[o].normal.y)?(i.y=Math.max(i.y,-1*n[o].normal.y*n[o].constant),r.y=Math.min(r.y,-1*n[o].normal.y*n[o].constant)):(i.z=Math.max(i.z,-1*n[o].normal.z*n[o].constant),r.z=Math.min(r.z,-1*n[o].normal.z*n[o].constant));t=b.getTransformControls().object.position;e.BoxPosition=t;t=new THREE.Box3(r,i);e.clipbox=t,e.planeMeshPositions=[];for(var a=0;a<x.length;++a)e.planeMeshPositions[a]=x[a].position}return e},this.setPlanePosition=function(e){for(var t=0;t<x.length;++t)x[t].position.copy(e[t]),b.viewer.renderer.clippingPlanes[t]};function R(){I&&I.traverse(function(e){e instanceof mt&&e.update()});for(var e=[],t=0;t<w.length;t++){var n=(new THREE.Plane).setComponents(w[t].x,w[t].y,w[t].z,w[t].w);e.push(n)}b.viewer.renderer.clippingPlanes=e}this.getOperateMode=function(){return s},this.setOperateMode=function(e){s=e},this.setActivePlaneByName=function(e){a=e},this.getActivePlaneName=function(){return a},this.activePlaneCanForward=function(){if(!this.active)return!1;var e=!0;T[a].updateMatrixWorld(!0);var t=T[a].position,n=null;switch(a){case"Right":T.Left.updateMatrixWorld(!0),n=T.Left.position,t.distanceTo(n)<1&&(e=!1);break;case"Left":n=T.Right.position,t.distanceTo(n)<1&&(e=!1);break;case"Up":n=T.Down.position,t.distanceTo(n)<1&&(e=!1);break;case"Down":n=T.Up.position,t.distanceTo(n)<1&&(e=!1);break;case"Front":n=T.Back.position,t.distanceTo(n)<1&&(e=!1);break;case"Back":n=T.Front.position,t.distanceTo(n)<1&&(e=!1)}return e},this.planeTranslate=function(e){if(!this.active)return!1;var t=null,n=null,i=null,r=null;switch(a){case"Right":n=A.Left,i=A.Right,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r);break;case"Left":n=A.Right,i=A.Left,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r);break;case"Up":n=A.Down,i=A.Up,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r);break;case"Down":n=A.Up,i=A.Down,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r);break;case"Front":n=A.Back,i=A.Front,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r);break;case"Back":n=A.Front,i=A.Back,t=n.clone().sub(i),r=i.clone().add(t.multiplyScalar(e)),T[a].position.copy(r)}return T[a].updateMatrixWorld(!0),O(),R(),b.viewer.render(),!0},this.isClipTransformControlSelected=function(){var e=!1,t=!1;return i&&(e=i.isSelected()),l&&(t=l.isSelected()),e||t},this.renderClipBox=function(e,t){S&&n&&(e?b.viewer.renderer.render(S,b.viewer.camera,e,t):b.viewer.renderer.render(S,b.viewer.camera))};function c(){(i=new P(E.camera,e)).setSize(.6),i.setMode("translate"),i.setSpace("local"),i.addEventListener("change",function(){b.viewer.render()}),i.addEventListener("objectChange",function(){R()}),i.attach(I),S.add(i),(l=new ft({objects:x,domElement:e,viewer:E,group:S})).setSize(.5),l.activate("translate","translateZ"),l.addEventListener("change",function(){b.viewer.render()}),l.addEventListener("objectChange",function(){R(),O(),function(){var e=b.viewer.renderer.clippingPlanes;if(e&&!(e.length<3)&&I){for(var t=new THREE.Vector3(-1e4,-1e4,-1e4),n=.001,i=0;i<e.length;i++)Math.abs(e[i].normal.x)>n?t.x=Math.max(t.x,-1*e[i].normal.x*e[i].constant):Math.abs(e[i].normal.y)>n?t.y=Math.max(t.y,-1*e[i].normal.y*e[i].constant):t.z=Math.max(t.z,-1*e[i].normal.z*e[i].constant);n=1e-6;var r=t.clone().sub(I.position);r.x=Math.abs(r.x)<n?0:r.x,r.y=Math.abs(r.y)<n?0:r.y,r.z=Math.abs(r.z)<n?0:r.z,I.position.add(r);var o,a=l.getCurrentControls();a&&(o=a.getOldPosition(),o=(o=o||new THREE.Vector3).clone().sub(r),a.setOldPosition(o));for(i=0;i<I.children.length;i++){var s=I.children[i];s instanceof mt&&s.position.sub(r)}I.updateMatrixWorld(!0)}}(),b.viewer.render()})}this.onBoxSectionView=function(e,t){if(e)this.active=!0,THREE.ShaderChunk.clipping_planes_fragment=vt,THREE.ShaderChunk.clipping_planes_pars_fragment=gt,THREE.ShaderChunk.meshphong_frag=Et,THREE.ShaderLib.phong.fragmentShader=Et,THREE.ShaderChunk.meshphysical_frag=bt,THREE.ShaderLib.physical.fragmentShader=bt,function(e){var t=[new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1)],n=["Right","Up","Front","Left","Down","Back"],i=[[[1,2],[1,5],[2,4],[4,5]],[[3,5],[0,5],[2,3],[0,2]],[[1,3],[0,1],[3,4],[0,4]],[[1,5],[1,2],[4,5],[2,4]],[[2,3],[0,2],[3,5],[0,5]],[[0,1],[3,1],[0,4],[3,4]]],r=new THREE.Group;I=r;var o=null;o=0==b.viewer.getExplodeFactor()?E.controls.getBoundingBox():E.controls.getExplosionBoundingBox();var a=o.getSize(),a=Math.max(Math.max(a.x,a.y),a.z)/50,a=new THREE.Vector3(a,a,a),s=o.clone();s.expandByVector(a),e&&s.copy(e);var l=s.max;r.position.copy(l);for(var d=[],c=[],h=0;h<t.length;h++){var u=new THREE.Plane(t[h],-1*l.dot(t[h]));d.push(u),2<h&&(3==h?u.constant-=s.max.x-s.min.x:4==h?u.constant-=s.max.y-s.min.y:5==h&&(u.constant-=s.max.z-s.min.z)),(f=function(e,t){var n=new THREE.Quaternion;{var i,r;n.setFromUnitVectors(new THREE.Vector3(0,0,1),e.normal),c=t?(i=e.projectPoint(t.max),o=e.projectPoint(t.min),r=n.clone().inverse(),i.applyQuaternion(r),o.applyQuaternion(r),o=(new THREE.Vector3).subVectors(i,o),new THREE.PlaneBufferGeometry(o.x,o.y)):(o=2*(t=_viewer.getVisibleBounds()).getBoundingSphere().radius,new THREE.PlaneBufferGeometry(o,o))}var o=new THREE.MeshBasicMaterial({opacity:.1,color:16777215,side:THREE.DoubleSide,transparent:!0}),a=new mt(c,o,e),t=t.getCenter(),t=e.projectPoint(t);a.position.copy(t),a.quaternion.multiply(n);for(var n=new THREE.Color(16711680),s=new THREE.LineBasicMaterial({color:n,linewidth:1}),l=a.geometry.getAttribute("position"),d=0;d<M.length;d++){var c;(c=new THREE.Geometry).vertices.push((new THREE.Vector3).fromArray(l.array,M[d][0]*l.itemSize),(new THREE.Vector3).fromArray(l.array,M[d][1]*l.itemSize));var h=new THREE.Line(c,s);a.add(h),a.outlines.push(h)}return a}(u,s)).position.sub(l),f.name=h,r.add(f),c.push(f),x.push(f),T[n[h]]=f,A[n[h]]=f.position.clone(),w.push(f.planeVec)}for(h=0;h<c.length;h++)for(var f=c[h],p=i[h],m=0;m<p.length;m++){for(var g=[],v=p[m],y=0;y<v.length;y++)g.push(d[v[y]]);f.connectivity.push(g)}null==S&&(S=new THREE.Scene);I.updateMatrixWorld(!0),S.add(I),O(),R()}(t),1==s&&c(),null==r&&(r=new d),b.viewer.addFrameListener(r),this.viewer.render();else{this.active=!1,THREE.ShaderChunk.clipping_planes_fragment=o.clipping_planes_fragment,THREE.ShaderChunk.clipping_planes_pars_fragment=o.clipping_planes_pars_fragment,THREE.ShaderChunk.meshphong_frag=o.meshphong_frag,THREE.ShaderChunk.meshphysical_frag=o.meshphysical_frag,THREE.ShaderLib.phong.fragmentShader=o.phongFrag,THREE.ShaderLib.physical.fragmentShader=o.physicalFrag,r&&(b.viewer.removeFrameListener(r),r=null);for(var n=0;n<x.length;n++)ye.disposeObject(x[n]);if(x=[],w=[],I=null,S)for(n=0;n<S.children.length;n++)S.remove(S.children[n]),n--;S=null,i&&(i.dispose(),i=null),l&&(l.dispose(),l=null),b.viewer.renderer.clippingPlanes=[],b.viewer.render()}};var h,u,f,p,m=(h=new THREE.Matrix3,u=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,function(e,t,n,i){h.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,n.normal.x,n.normal.y,n.normal.z);var r=h.determinant();return 0===r?null:(u.crossVectors(t.normal,n.normal).multiplyScalar(-e.constant),f.crossVectors(n.normal,e.normal).multiplyScalar(-t.constant),p.crossVectors(e.normal,t.normal).multiplyScalar(-n.constant),(i||new THREE.Vector3).copy(u).add(f).add(p).divideScalar(r))});function O(){for(var e=0;e<I.children.length;e++){var t=I.children[e];if(t instanceof mt&&0<t.connectivity.length){for(var n=(new THREE.Matrix4).getInverse(t.matrixWorld),i=new THREE.Vector3,r=t.geometry.getAttribute("position"),o=0;o<3*r.count/r.itemSize;o++){var a=t.connectivity[o];null!==m(t.plane,a[0],a[1],i)&&(i.applyMatrix4(n),r.setXYZ(o,i.x,i.y,i.z),i.clone().add(t.position))}r.needsUpdate=!0,t.geometry.computeBoundingBox(),t.geometry.computeBoundingSphere();for(o=0;o<t.outlines.length;o++){var s=t.outlines[o];s.geometry.vertices[0].fromArray(r.array,M[o][0]*r.itemSize),s.geometry.vertices[1].fromArray(r.array,M[o][1]*r.itemSize),s.geometry.verticesNeedUpdate=!0}}}}this.isSectionBoxEnabled=function(){return!!S},this.displaySectionBox=function(e){I&&((I.visible=e)?i.attach(I):(i.detach(i.object),l.detach())),b.viewer.render()},this.getSectionBoxVisible=function(){return!!I&&I.visible}},St=(n(122),function(e,t,n){this.viewer=e;var k=this,V=n,d=null,d=e.canvas2D||e.canvas3D,c=void 0===t?1:t;1===c&&(THREE.ShaderChunk.clipping_planes_fragment=vt,THREE.ShaderChunk.clipping_planes_pars_fragment=gt,THREE.ShaderChunk.meshphong_frag=Et,THREE.ShaderLib.phong.fragmentShader=Et,THREE.ShaderChunk.meshphysical_frag=bt,THREE.ShaderLib.physical.fragmentShader=bt),this.clipTransRotControl=null,this.clipTransRotControls=[],this.clipActiveId=0,this.planeNameToId={},this.showSectionImage=!1;var a=null,s=null,h=[],l=null,j=[],U=-1/0,z=-1/0,G=1/0,W=1/0,Y=null,u=null,f=null,p=null,m=null,g=null,X=0,Z={};function v(){this.run=function(){k.clipTransRotControl&&(k.clipTransRotControl.update(),k.clipTransRotControl.updateMatrixWorld(!0))}}function y(){var e=Y.getObjectByName("sectionRoot");e&&(ye.disposeObject(e),Y.remove(e));e=new THREE.Group;e.name="sectionRoot",Y.add(e);var t=new THREE.Group;e.add(t);var n=new THREE.Group;e.add(n);var i=new THREE.Box3;if(k.viewer.ndsModel){var r=k.viewer.ndsModel.meshManager;z=U=-1/0,W=G=1/0;for(var o=0;o<k.viewer.renderer.clippingPlanes.length;o++){var a=k.viewer.renderer.clippingPlanes[o].clone(),s=NDS.Intersector.makePlaneBasis(a),l=(new THREE.Matrix4).getInverse(s);Z={};for(var d,c,h,u,f,p,m,g=X=0,v=k.viewer.ndsModel.wholeLeafBodyNodes.length;g<v;++g){var y=k.viewer.ndsModel.wholeLeafBodyNodes[g];if(y.leafBodyAttri){var E=y.leafBodyAttri.bodyMeshIds;if(E&&!(E.length<1)){for(var b=[],M=null,x=0;x<E.length;x++){var w=E[x];if(!r.isMeshHidden(w)&&(r.getMeshBBox(w,i),NDS.Intersector.intersectBoxPlane(a,i))){for(var I,S,T,A=!0,R=0;R<k.viewer.renderer.clippingPlanes.length;++R)if(R!=o){var O=(B=k.viewer.renderer.clippingPlanes[R]).distanceToPoint(i.getCenter());if(!NDS.Intersector.intersectBoxPlane(B,i)&&Math.sign(O)<0){A=!1;break}}A&&(r.getMeshInfor(w,I={}),M=M||I.material,S={},T=[],NDS.Intersector.intersectMeshPlane(a,I.geometry,I.matrixWorld,w,T),b=b.concat(T))}}if(!(b.length<1)){for(R=0;R<k.viewer.renderer.clippingPlanes.length;++R){var P=function(t,n){return Object.keys(t).find(function(e){return t[e]===n})};if(R!=o){for(var C,B=k.viewer.renderer.clippingPlanes[R],L=[],x=0;x<b.length;x++){var D=new THREE.Vector3,H=new THREE.Vector3;1!=NDS.Intersector.intersectSegmentPlane(B,b[x].pt1,b[x].pt2,D,H)?(O=B.distanceToPoint(b[x].pt1),Math.sign(O)<0&&1e-6<Math.abs(O)&&(b.splice(x,1),x--)):(O=B.distanceToPoint(b[x].pt1),H=B.distanceToPoint(b[x].pt2),N=b[x],Math.abs(O)<1e-6?(Math.sign(H)<0&&(b.splice(x,1),x--),S[N.eid1]=D):Math.sign(O)<0?(Math.abs(H)<1e-6?(b.splice(x,1),x--):(N.pt1=D,N.eid1=N.eid1+":"+R),S[N.eid1]=D):0<Math.sign(O)&&(1e-6<Math.abs(H)&&(N.pt2=D,N.eid2=N.eid2+":"+R),S[N.eid2]=D),L.find(function(e){return Math.abs(D.x-e.x)<1e-6&&Math.abs(D.y-e.y)<1e-6&&Math.abs(D.z-e.z)<1e-6})||L.push(D.clone()))}if(0<L.length&&L.length%2==0){2<L.length&&(C=NDS.Intersector.makePlaneBasis(B),L.sort(function(e,t){e=e.clone().applyMatrix4(C),t=t.clone().applyMatrix4(C);return 1e-6<Math.abs(e.x-t.x)?e.x-t.x:e.y-t.y}));for(x=0;x<L.length;x+=2){var N,F=P(S,L[x]),_=P(S,L[x+1]);(N=new NDS.Triangulator.Edge(L[x],L[x+1],0,0,1,1,2)).eid1=F,N.eid2=_,b.push(N)}}}}y=!1;(function(e,t,n,i,r,o,a){if(e.length){var s=new THREE.Box3;NDS.Intersector.convertToPlaneCoords(n,e,s);var l=new THREE.Geometry,d=new NDS.Triangulator.ContourSet(e,s);d.snapEdges(),d.sanitizeEdges(),d.stitchContours();for(var c=0;c<d.contours.length;c++)for(var h=d.contours[c],u=1;u<h.length;u++){var f=d.pts[h[u-1]],p=d.pts[h[u]],f=new THREE.Vector3(f.x,f.y,0),p=new THREE.Vector3(p.x,p.y,0);l.vertices.push(f),l.vertices.push(p)}s=new THREE.LineBasicMaterial({opacity:1});s.color.setRGB(1,0,0);s=new THREE.LineSegments(l,s);if(s.matrix.copy(i),s.matrixAutoUpdate=!1,s.frustumCulled=!1,r.add(s),V){var m=new NDS.Triangulator.TriangulatedSurface(d);if(m.indices.length){j=[];for(var r=new THREE.BufferGeometry,g=new Float32Array(3*m.pts.length),c=0;c<m.pts.length;c++)g[3*c]=m.pts[c].x,g[3*c+1]=m.pts[c].y,g[3*c+2]=0;r.addAttribute("position",new THREE.BufferAttribute(g,3));for(var v=t.packedNormals,y=v?new Uint16Array(2*m.pts.length):new Float32Array(3*m.pts.length),c=0;c<m.pts.length;c++)v?(y[2*c]=32767,y[2*c+1]=65535):(y[3*c]=0,y[3*c+1]=0,y[3*c+2]=1);r.addAttribute("normal",new THREE.BufferAttribute(y,v?2:3)),v&&(r.attributes.normal.bytesPerItem=2,r.attributes.normal.normalize=!0);s=new Uint16Array(m.indices.length);s.set(m.indices);var E=(m.cset.bbox.max.x-m.cset.bbox.min.x)*(m.cset.bbox.max.y-m.cset.bbox.min.y);if(U=Math.max(m.cset.bbox.max.x,U),z=Math.max(m.cset.bbox.max.y,z),G=Math.min(m.cset.bbox.min.x,G),W=Math.min(m.cset.bbox.min.y,W),a)for(var b=0;b<m.indices.length;b+=3){var M=m.pts[m.indices[b]],x=m.pts[m.indices[b+1]],w=m.pts[m.indices[b+2]];j.push(new THREE.Vector2(M.x,M.y)),j.push(new THREE.Vector2(x.x,x.y)),j.push(new THREE.Vector2(w.x,w.y))}r.setIndex(new THREE.BufferAttribute(s,1)),r.streamingDraw=!0,r.streamingIndex=!0;a=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{color:{type:"c",value:new THREE.Color(1,1,1)},hatchParams:{type:"v2",value:new THREE.Vector2(1,10)},hatchTintColor:{type:"c",value:new THREE.Color(0,1,1)},hatchTintIntensity:{type:"f",value:.2}},vertexShader:xt.vertex,fragmentShader:xt.fragment});for(a.polygonOffset=!0,a.polygonOffsetFactor=0,a.polygonOffsetUnits=1;-1!=Object.keys(Z).indexOf(E.toString());)E*=1+1e-5;Z[E]={material:a,triangle:j.concat()};s=Object.keys(Z).length*Math.PI*10/180+Math.PI/4,s=Math.tan(s);a.uniforms.hatchParams.value=new THREE.Vector2(s,20),a.uniforms.color.value=t.color.clone(),a.needsUpdate=!0;a=new THREE.Mesh(r,a);a.matrix.copy(i),a.matrixAutoUpdate=!1,o.add(a)}}}})(b,M,s,l,n,t,y=k.clipActiveId==o&&k.showSectionImage&&!k.clipTransRotControl.isDragging()?!0:y)}}}}Object.keys(Z).sort(function(e,t){return e-t}).forEach(function(e){Z[e].material.polygonOffsetFactor=X,X+=.01}),k.clipActiveId==o&&k.showSectionImage&&!k.clipTransRotControl.isDragging()&&(m=document.createElement("canvas"),d=Math.max(U-G,z-W),m.width=1.1*d,m.height=1.1*d,c=1,d<40?(m.width=420,m.height=420,c=400/d):m.width<400?(m.width=10*d+40,m.height=10*d+40,c=10):6e3<m.width&&(m.width=640,m.height=640,c=600/d),h=m.width/2-(U+G)*c/2,u=m.height/2-(z+W)*c/2,f=m.getContext("2d"),p=new THREE.Color(.39,.59,.59),Object.keys(Z).sort(function(e,t){return t-e}).forEach(function(e){f.beginPath(),f.fillStyle="#"+p.getHexString(),p.addScalar(.1),j=Z[e].triangle;for(var t=0;t<j.length;t+=3){var n=j[t].x,i=j[t].y,r=j[t+1].x,o=j[t+1].y,r=r*c+h,o=o*c+u,a=j[t+2].x,s=j[t+2].y,a=a*c+h,s=s*c+u;f.moveTo(n=n*c+h,i=i*c+u),f.lineTo(r,o),f.lineTo(a,s)}f.fill()}),m=m.toDataURL("image/png"),k.viewer.dispatchEvent({type:"ActiveSectionViewChangeEvent",base64Img:m})),Z={}}}}function E(){var e;function t(e){var t=new THREE.Vector3(0,0,1),n=l.quaternion;t.applyQuaternion(n);var i,r,o=t,a=e;i=o,r=a,t=Math.abs(i.x-r.x)<.001,e=Math.abs(i.y-r.y)<.001,r=Math.abs(i.z-r.z)<.001,t&&e&&r||((r=new THREE.Quaternion).setFromUnitVectors(o,a),n.multiplyQuaternions(r,n),l.setRotationFromQuaternion(n),l.updateMatrixWorld(!0))}0!=k.viewer.renderer.clippingPlanes.length&&0!=h.length&&(a=k.viewer.renderer.clippingPlanes[k.clipActiveId],s=h[k.clipActiveId],l=s.children[0],(e=k.clipTransRotControls[k.clipActiveId]).isDragging()&&"translate"===e.pickType&&("X"===e.axis?t(new THREE.Vector3(1,0,0)):"Y"===e.axis?t(new THREE.Vector3(0,1,0)):"Z"===e.axis&&t(new THREE.Vector3(0,0,1))),a.normal.set(0,0,-1),a.normal.applyQuaternion(l.getWorldQuaternion()),a.constant=-1*s.getWorldPosition().dot(a.normal))}this.hasClipCapScene=function(){return!m},this.setActiveSectionPlane=function(e){if(k.clipActiveId=k.planeNameToId[e],!(k.clipActiveId<0||k.clipActiveId>k.clipTransRotControls.length-1)){for(var t=0;t<k.clipTransRotControls.length;++t)k.clipTransRotControls[t].visible=!1,h[t].visible=!1;k.clipTransRotControls[k.clipActiveId].visible=!0,h[k.clipActiveId].visible=!0,k.clipTransRotControl=k.clipTransRotControls[k.clipActiveId],3===c&&y(),k.viewer.render()}},this.deleteSectionPlane=function(e){if(Y&&-1!=k.planeNameToId[e]){for(var t in k.clipActiveId=k.planeNameToId[e],k.planeNameToId[e]=-1,k.planeNameToId)k.planeNameToId[t]>k.clipActiveId&&k.planeNameToId[t]--;k.clipTransRotControls[k.clipActiveId].visible=!1,k.clipTransRotControls[k.clipActiveId].dispose(),Y.remove(k.clipTransRotControls[k.clipActiveId]),Y.remove(h[k.clipActiveId]),k.clipTransRotControls.splice(k.clipActiveId,1),h.splice(k.clipActiveId,1),k.viewer.renderer.clippingPlanes.splice(k.clipActiveId,1),3===c&&y(),k.viewer.render()}},this.renderClipScene=function(e,t){Y&&(e?k.viewer.renderer.render(Y,k.viewer.camera,e,t):k.viewer.renderer.render(Y,k.viewer.camera))},this.renderClipPlane=function(e,t){var n,i;m&&(n=k.viewer.scene.overrideMaterial,k.viewer.renderer.state.buffers.stencil.setTest(!0),i=k.viewer.renderer.context,k.viewer.renderer.state.buffers.stencil.setFunc(i.ALWAYS,1,255),k.viewer.renderer.state.buffers.stencil.setOp(i.KEEP,i.KEEP,i.INCR),k.viewer.scene.overrideMaterial=f,e?k.viewer.renderer.render(k.viewer.scene,k.viewer.camera,e,t):k.viewer.renderer.render(k.viewer.scene,k.viewer.camera),k.viewer.renderer.state.buffers.stencil.setFunc(i.ALWAYS,1,255),k.viewer.renderer.state.buffers.stencil.setOp(i.KEEP,i.KEEP,i.DECR),k.viewer.scene.overrideMaterial=p,e?k.viewer.renderer.render(k.viewer.scene,k.viewer.camera,e,!1):k.viewer.renderer.render(k.viewer.scene,k.viewer.camera),k.viewer.scene.overrideMaterial=n,k.viewer.renderer.state.buffers.stencil.setFunc(i.EQUAL,1,255),k.viewer.renderer.state.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),e?k.viewer.renderer.render(m,k.viewer.camera,e,!1):k.viewer.renderer.render(m,k.viewer.camera),k.viewer.renderer.state.buffers.stencil.setTest(!1))},this.isClipTransformControlSelected=function(){return!!k.clipTransRotControl&&k.clipTransRotControl.isSelected()},this.addSectionPlane=function(e){if(Y&&-1==k.planeNameToId[e]){for(var t=0;t<k.clipTransRotControls.length;++t)k.clipTransRotControls[t].visible=!1,h[t].visible=!1;var n=k.viewer.controls.getBoundingBox().getCenter(),i=k.viewer.controls.getBoundingBox().getSize(),r=Math.max(i.x,i.y,i.z);r*=1.3;var o=new THREE.PlaneBufferGeometry(r,r,1,1),a=null,i=new THREE.Color;"XZ"==e?(a=new THREE.Plane(new THREE.Vector3(0,-1,0),0),i.setRGB(.298,.8,.4)):"YZ"==e?(a=new THREE.Plane(new THREE.Vector3(-1,0,0),0),i.setRGB(.4,.298,.8)):"XY"==e&&(a=new THREE.Plane(new THREE.Vector3(0,0,-1),0),i.setRGB(.8,.4,.298)),a.setFromNormalAndCoplanarPoint(a.normal,n),k.viewer.renderer.clippingPlanes.push(a.clone());r=new THREE.Object3D;r.position.copy(n),r.updateMatrixWorld(),h.push(r);o=new THREE.Mesh(o,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,opacity:.3}));3===c&&V&&(o.material.polygonOffset=!0,o.material.polygonOffsetFactor=-2,o.material.polygonOffsetUnits=1),o.material.color.copy(i),o.material.transparent=!0,r.add(o);i=new THREE.Quaternion;i.setFromUnitVectors(new THREE.Vector3(0,0,-1),a.normal),o.setRotationFromQuaternion(i),o.updateMatrixWorld(!0);o=new P(k.viewer.camera,d);Y.add(o),Y.add(r),o.setSize(.7),o.setMode("both"),o.setSpace("local"),o.attach(r),o.name=e,o.addEventListener("change",function(){k.viewer.render()}),o.addEventListener("objectChange",function(){E(),3===c&&y(),Ue.enableBroadcast&&!Ue.broadcastMajor||k.viewer.render()}),k.clipTransRotControls.push(o),k.clipActiveId=k.clipTransRotControls.length-1,k.planeNameToId[e]=k.clipActiveId,k.clipTransRotControl=k.clipTransRotControls[k.clipActiveId],3===c&&y(),k.viewer.render()}},this.onSectionView=function(e,t){if(e){null==g&&(g=new v),k.viewer.addFrameListener(g),k.viewer.toggleAutoRotation(!1),k.viewer.zoomExtents(),2==c&&(u=new THREE.ShaderMaterial({uniforms:Mt.uniforms.caps,vertexShader:Mt.vertex,fragmentShader:Mt.fragment}),f=new THREE.ShaderMaterial({defines:Mt.defines,uniforms:Mt.uniforms.clipping,vertexShader:Mt.vertexClipping,fragmentShader:Mt.fragmentClippingFront,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),p=new THREE.ShaderMaterial({defines:Mt.defines,uniforms:Mt.uniforms.clipping,vertexShader:Mt.vertexClipping,fragmentShader:Mt.fragmentClippingFront,colorWrite:!1,depthWrite:!1}),(m=new THREE.Scene).add(new THREE.Mesh(new THREE.PlaneBufferGeometry(2*k.viewer.camera.far,2*k.viewer.camera.far,1,1),u))),k.planeNameToId.XY=0,k.planeNameToId.YZ=-1,k.planeNameToId.XZ=-1;var n=new THREE.Plane(new THREE.Vector3(0,0,-1),0),i=k.viewer.controls.getBoundingBox().getCenter();n.setFromNormalAndCoplanarPoint(n.normal,i),Mt.uniforms.clipping.clippingPlaneNDS.value=[n.normal.x,n.normal.y,n.normal.z,n.constant];for(var r=0;r<k.clipTransRotControls.length;++r)k.clipTransRotControls[r].dispose();k.viewer.renderer.clippingPlanes=[n],k.viewer.controls.getOperator()&&k.viewer.controls.getOperator().resetEventListener();e=new THREE.Object3D;e.position.copy(i),e.updateMatrixWorld(),h.push(e);i=k.viewer.controls.getBoundingBox().getSize(),i=Math.max(i.x,i.y,i.z);i*=1.3;i=new THREE.PlaneBufferGeometry(i,i,1,1),i=new THREE.Mesh(i,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,opacity:.3}));3===c&&V&&(i.material.polygonOffset=!0,i.material.polygonOffsetFactor=-2,i.material.polygonOffsetUnits=1),i.material.color.setRGB(.8,.4,.298),i.material.transparent=!0,e.add(i),Y=new THREE.Scene;i=new P(k.viewer.camera,d);Y.add(i),i.setSize(.7),i.setMode("both"),i.setSpace("local"),i.attach(e),i.name="XY",k.clipTransRotControls.push(i),k.clipTransRotControl=k.clipTransRotControls[k.clipActiveId],e.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,-1),n.normal),Y.add(e),m&&m.position.copy(e.position),3===c&&y(),i.addEventListener("change",function(){k.viewer.render()}),i.addEventListener("objectChange",function(){E(),3===c&&y(),Ue.enableBroadcast&&!Ue.broadcastMajor||k.viewer.render()}),0!=t&&k.viewer.render()}else{if(k.clipTransRotControl){if(u&&u.dispose(),u=null,f&&f.dispose(),f=null,p&&p.dispose(),p=null,m)for(var o=0;o<m.children.length;o++)m.children[o].geometry&&m.children[o].geometry.dispose(),m.remove(m.children[o]),o--;m=null;for(r=0;r<k.viewer.renderer.clippingPlanes.length;++r)a=k.viewer.renderer.clippingPlanes[r],a=null;for(r=0;r<k.clipTransRotControls.length;++r)k.clipTransRotControls[r].dispose();k.clipTransRotControls=[],s=null;for(o=0;o<h.length;o++)ye.disposeObject(h[o]);if(h=[],Y)for(o=0;o<Y.children.length;o++)Y.remove(Y.children[o]),o--;Y=null,k.viewer.renderer.clippingPlanes=[]}this.planeNameToId={},k.clipActiveId=0,k.viewer.removeFrameListener(g),g=null,0!=t&&k.viewer.render()}},this.onCloseClipControl=function(){k.clipTransRotControl&&(k.clipTransRotControl.visible=!1,k.viewer.render())},this.getClipControlVisible=function(){return!!k.clipTransRotControl&&k.clipTransRotControl.visible},this.onOpenClipControl=function(){k.clipTransRotControl&&(k.clipTransRotControl.visible=!0,k.viewer.render())},this.isSectionViewEnabled=function(){return!!Y},this.getClipPlaneInfor=function(){if(Y){for(var e={clipGlobalPlaneObjects:[]},t=0;t<h.length;++t){var n={position:h[t].position.clone(),quaternion:h[t].quaternion.clone(),meshquaternion:h[t].children[0].quaternion.clone()};e.clipGlobalPlaneObjects.push(n)}return e.planeNameToId=k.planeNameToId,e.clippingPlanes=k.viewer.renderer.clippingPlanes,e.clipActiveId=k.clipActiveId,s=h[k.clipActiveId],e.planeVisible=s.visible,e}return null},this.setClipPlaneInfor=function(e){k.planeNameToId=e.planeNameToId,k.viewer.renderer.clippingPlanes=[],h=[],k.clipTransRotControls=[],Y=new THREE.Scene;for(var t=null,n=0;n<e.clipGlobalPlaneObjects.length;++n){for(var i in k.planeNameToId)if(k.planeNameToId[i]==n){t=i;break}var r=k.viewer.controls.getBoundingBox().getSize(),o=Math.max(r.x,r.y,r.z);o*=1.3;var a=new THREE.PlaneBufferGeometry(o,o,1,1),s=new THREE.Plane(e.clippingPlanes[n].normal,e.clippingPlanes[n].constant),r=new THREE.Color;"XZ"==t?(new THREE.Vector3(0,-1,0),r.setRGB(.298,.8,.4)):"YZ"==t?(new THREE.Vector3(-1,0,0),r.setRGB(.4,.298,.8)):"XY"==t&&(new THREE.Vector3(0,0,-1),r.setRGB(.8,.4,.298)),k.viewer.renderer.clippingPlanes.push(s.clone());o=new THREE.Object3D;o.position.copy(e.clipGlobalPlaneObjects[n].position);s=e.clipGlobalPlaneObjects[n].quaternion;o.quaternion.set(s._x,s._y,s._z,s._w),o.updateMatrixWorld(),h.push(o);s=new THREE.Mesh(a,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,opacity:.3}));3===c&&V&&(s.material.polygonOffset=!0,s.material.polygonOffsetFactor=-2,s.material.polygonOffsetUnits=1),s.material.color.copy(r),s.material.transparent=!0,o.add(s);a=new THREE.Quaternion,r=e.clipGlobalPlaneObjects[n].meshquaternion;a.set(r._x,r._y,r._z,r._w),s.setRotationFromQuaternion(a),s.updateMatrixWorld(!0);s=new P(k.viewer.camera,d);Y.add(s),Y.add(o),s.setSize(.7),s.setMode("both"),s.setSpace("local"),s.attach(o),s.name=t,s.update(),n!=e.clipActiveId&&(o.visible=!1,s.visible=!1),s.addEventListener("change",function(){k.viewer.render()}),s.addEventListener("objectChange",function(){E(),3===c&&y(),Ue.enableBroadcast&&!Ue.broadcastMajor||k.viewer.render()}),k.clipTransRotControls.push(s)}k.clipActiveId=e.clipActiveId;var l=k.getClipControlVisible();k.clipTransRotControl=k.clipTransRotControls[k.clipActiveId],k.clipTransRotControl.visible=l,3===c&&y(),k.hideShowClipPlane(e.planeVisible),k.viewer.render()},this.hideShowClipPlane=function(e){(s=h[k.clipActiveId])&&(s.visible=e,k.viewer.render())},this.getClipPlaneVisible=function(){return!!(s=h[k.clipActiveId])&&s.visible},this.reverseClipDirection=function(){s=h[k.clipActiveId],a=k.viewer.renderer.clippingPlanes[k.clipActiveId],l=s.children[0],a.normal.negate(),s.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,-1),a.normal),a.setFromNormalAndCoplanarPoint(a.normal,s.position);var e=new THREE.Quaternion(0,0,0,1);l.setRotationFromQuaternion(e),l.updateMatrixWorld(!0),3===c&&y(),k.viewer.render()},this.updateClipPlane=function(){3===c&&y(),k.viewer.render()}}),Tt=function(e){var t=this;this.viewer=e,this.customComments=new Array,this.commentsStyle={font:"20px Verdana",color:"#ff0000"};var r=this;this.clear=function(){t.customComments=new Array},this.setDefultStyle=function(e){null!=e&&(null!=e.font&&(this.commentsStyle.font=e.font),null!=e.color&&(this.commentsStyle.color=e.color))},this.addComment=function(e){return null==e.visible&&(e.visible=!0),null==e.hasIndicator&&(e.visible=!1),r.customComments.push(e),r.viewer.render(),r.customComments.length-1},this.getAllComments=function(){return r.customComments},this.getCommentsCount=function(){return r.customComments.length},this.getComment=function(e){return null==e||e<0||e>=r.customComments.length?null:r.customComments[e]},this.setCommentVisible=function(e,t){null==e||null==t||e<0||e>=r.customComments.length||null!=t&&(r.customComments[e].visible=t,r.viewer.render())},this.removeComment=function(e){null==e||e<0||e>=r.customComments.length||(r.customComments.splice(e,1),r.viewer.render())},this.removeAllComments=function(){var e=r.customComments.length;r.customComments.splice(0,e),r.viewer.render()},this.get2dPoint=function(e){var t=(new THREE.Vector3).copy(e);t.project(r.viewer.camera);var n=r.viewer.container.offsetWidth/2,e=r.viewer.container.offsetHeight/2;return{x:Math.round(t.x*n+n),y:Math.round(-t.y*e+e)}},this.setAllCommentsVisible=function(e){if(null!=e){for(var t=0;t<r.customComments.length;t++)r.customComments[t].visible=e;r.viewer.render()}},this.renderComments=function(){if(null!=r.viewer.canvas2DLayer){var e=r.viewer.canvas2DLayer.getContext("2d");if(e.clearRect(0,0,window.innerWidth,window.innerHeight),0<r.customComments.length){r.viewer.canvas2DLayer.style.display="";for(var t=0;t<r.customComments.length;t++){var n,i=r.customComments[t];i.visible&&(n=r.get2dPoint(r.customComments[t].position),null!=i.font?e.font=i.font:e.font=this.commentsStyle.font,null!=i.color?e.fillStyle=i.color:e.fillStyle=this.commentsStyle.color,i.hasIndicator?(e.beginPath(),e.arc(n.x,n.y,4,0,2*Math.PI),e.fill(),e.fillText(r.customComments[t].text,n.x+6,n.y+5)):(e.beginPath(),e.fillText(r.customComments[t].text,n.x,n.y)))}}}}},At=function(e,t){this.viewer=e;var n="coverer_"+Date.now(),n=new NDS.Element({className:"coverer",id:n});n.setVisibility(!1),void 0!==t&&n.setBgColor(t),e.container.appendChild(n.domElement),e.coverer=n},Rt=function(e){var a=this;this.viewer=e,this.Fonts={},this.loadFonts=function(t,n){var i=new THREE.FontLoader,r=new He(new THREE.LoadingManager);r.setCrossOrigin("anonymous"),r.setResponseType("arraybuffer");function o(){console.log("load Font error")}r.load(null,"./Fonts/DS ISO 1_Regular.js.gz",function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);a.Fonts.default=i.parse(e),t?r.load(null,"./Fonts/simfang_Regular.js.gz",function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);a.Fonts.simfang=i.parse(e),n&&n()},void 0,o):n&&n()},void 0,o)}},Ot=function(e){console.log("THREE.WebGLRenderer",THREE.REVISION);var a=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),t=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,i=void 0===e.depth||e.depth,r=void 0===e.stencil||e.stencil,o=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,d=e.is2DModel,m=[],T=[],g=null,v=[],y=[];this.domElement=a,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=THREE.LinearToneMapping,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.maxPrimitivesPerFrame=6e7;var S,A,R,O,E,P,p,b,C,c,M,x,w,I,B,L,D,h,H,N,u,F=this,_=!1,f=null,k=null,V=-1,j="",U=null,z=null,G=new THREE.Vector4,W=new THREE.Vector4,Y=null,X=null,Z=null,q=-1,Q=null,J=null,K=0,$=a.width,ee=a.height,te=1,ne=new THREE.Vector4(0,0,$,ee),ie=new THREE.Vector4(0,0,$,ee),re=!1,oe=new THREE.Frustum,ae=new THREE.WebGLClipping,se=!1,le=!1,de=new THREE.Matrix4,ce=!1,he=new THREE.Vector3,ue={geometries:0,textures:0},fe={frame:0,calls:0,vertices:0,faces:0,lines:0,points:0};function pe(){return null===f?te:1}this.info={render:fe,memory:ue,programs:null};try{var me,ge={alpha:n,depth:i,stencil:r,antialias:o,premultipliedAlpha:s,preserveDrawingBuffer:l};if(null===(me=t||a.getContext("webgl",ge)||a.getContext("experimental-webgl",ge)))throw null!==a.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===me.getShaderPrecisionFormat&&(me.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),a.addEventListener("webglcontextlost",be,!1),a.addEventListener("webglcontextrestored",Me,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}function ve(){(S=new THREE.WebGLExtensions(me)).get("WEBGL_depth_texture"),S.get("OES_texture_float"),S.get("OES_texture_float_linear"),S.get("OES_texture_half_float"),S.get("OES_texture_half_float_linear"),S.get("OES_standard_derivatives"),H=S.get("ANGLE_instanced_arrays"),N=S.get("OES_vertex_array_object"),S.get("WEBGL_draw_buffers"),S.get("OES_element_index_uint")&&(THREE.BufferGeometry.MaxIndex=4294967296),h=new THREE.WebGLUtils(me,S),A=new THREE.WebGLCapabilities(me,S,e),(R=new THREE.WebGLState(me,S,h)).scissor(W.copy(ie).multiplyScalar(te)),R.viewport(G.copy(ne).multiplyScalar(te)),O=new THREE.WebGLProperties,E=new THREE.WebGLTextures(me,S,R,O,A,h,ue),P=new THREE.WebGLAttributes(me),p=new THREE.WebGLGeometries(me,P,ue),b=new THREE.WebGLObjects(p,fe),w=new THREE.WebGLMorphtargets(me),c=new THREE.WebGLPrograms(F,S,A),C=new THREE.WebGLLights,M=new THREE.WebGLRenderLists,x=new THREE.WebGLBackground(F,R,p,s),I=new THREE.WebGLBufferRenderer(me,S,fe),B=new THREE.WebGLIndexedBufferRenderer(me,S,fe),L=new THREE.WebGLFlareRenderer(F,me,R,E,A),D=new THREE.WebGLSpriteRenderer(F,me,R,E,A),F.info.programs=c.programs,F.context=me,F.capabilities=A,F.extensions=S,F.properties=O,F.renderLists=M,F.state=R}this.colorTarget=u,ve();var ye=new THREE.WebVRManager(F);this.vr=ye;var Ee=new THREE.WebGLShadowMap(F,b,A.maxTextureSize);function be(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),_=!0}function Me(e){console.log("THREE.WebGLRenderer: Context Restored."),_=!1,ve()}function xe(e){e=e.target;e.removeEventListener("dispose",xe),we(e=e),O.remove(e)}function we(e){var t=O.get(e).program;(e.program=void 0)!==t&&c.releaseProgram(t)}function Ie(e){var t,n=e.target;for(t in n.index&&(P.get(n.index)?P.remove(n.index):n.index.indexBuffer&&(me.deleteBuffer(n.index.indexBuffer),n.index.indexBuffer=null)),n.attributes)P.get(n.attributes[t])?(P.remove(n.attributes[t]),n.attributes[t].data&&n.attributes[t].data.dataBuffer&&(n.attributes[t].data.dataBuffer=null)):n.attributes[t].dataBuffer?(me.deleteBuffer(n.attributes[t].dataBuffer),n.attributes[t].dataBuffer=null):n.attributes[t].data&&n.attributes[t].data.dataBuffer&&(n.attributes[t].data.dataBuffer=null);n.modelMatrixBuffer&&(me.deleteBuffer(n.modelMatrixBuffer),n.modelMatrixBuffer=null),n.removeEventListener("dispose",Ie),n.hasDisposeEventListener=!1}function Se(e,t,n,i,r,o){if(n&&n.isInstancedBufferGeometry&&null===S.get("ANGLE_instanced_arrays"))console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");else{void 0===i&&(i=0),R.initAttributes();var a,s=n.attributes,l=t.getAttributes(),d=e.defaultAttributeValues;for(a in l){var c=l[a];if("modelMatrixAttrib"!==a){if(0<=c){var h=s[a];if(void 0!==h){var u,f,p,m,g,v,y,E,b=h.normalized,M=h.itemSize;if(r)h.data?n.useSharedGlBuffer?(m=h.data.uuid,h.data.uuid="attributes",void 0===(g=P.get(h))?(P.update(h,me.ARRAY_BUFFER),g=P.get(h)):(me.bindBuffer(me.ARRAY_BUFFER,g.buffer),me.bufferData(me.ARRAY_BUFFER,h.data.array,me.DYNAMIC_DRAW)),h.data.uuid=m):h.data.dataBuffer||(h.data.dataBuffer=me.createBuffer(),me.bindBuffer(me.ARRAY_BUFFER,h.data.dataBuffer),me.bufferData(me.ARRAY_BUFFER,h.data.array,me.STATIC_DRAW)):void 0===(g=P.get(h))?n.useSharedGlBuffer?(m=h.uuid,h.uuid=a,void 0===(g=P.get(h))?(P.update(h,me.ARRAY_BUFFER),g=P.get(h)):(me.bindBuffer(me.ARRAY_BUFFER,g.buffer),me.bufferData(me.ARRAY_BUFFER,h.array,me.DYNAMIC_DRAW)),h.uuid=m):(P.update(h,me.ARRAY_BUFFER),g=P.get(h)):g.version<h.version&&(n.useSharedGlBuffer||(P.update(h,me.ARRAY_BUFFER),g=P.get(h))),u=g?g.buffer:h.data.dataBuffer,f=g?g.type:me.FLOAT,p=g?g.bytesPerElement:4;else{if(void 0===(g=P.get(h)))continue;u=g.buffer,f=g.type,p=g.bytesPerElement}h.isInterleavedBufferAttribute?(y=(v=h.data).stride,E=h.offset,v&&v.isInstancedInterleavedBuffer?(R.enableAttributeAndDivisor(c,v.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=v.meshPerAttribute*v.count)):R.enableAttribute(c),me.bindBuffer(me.ARRAY_BUFFER,u),me.vertexAttribPointer(c,M,f,b,y*p,(i*y+E)*p),null==(g=g||P.get(h))&&(P.update(h,me.ARRAY_BUFFER),g=P.get(h)),g&&g.version<h.data.version&&(n.useSharedGlBuffer||P.update(h,me.ARRAY_BUFFER))):(h.isInstancedBufferAttribute?(R.enableAttributeAndDivisor(c,h.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=h.meshPerAttribute*h.count)):R.enableAttribute(c),me.bindBuffer(me.ARRAY_BUFFER,u),me.vertexAttribPointer(c,M,f,b,0,i*M*p))}else if(void 0!==d){var x=d[a];if(void 0!==x)switch(x.length){case 2:me.vertexAttrib2fv(c,x);break;case 3:me.vertexAttrib3fv(c,x);break;case 4:me.vertexAttrib4fv(c,x);break;default:me.vertexAttrib1fv(c,x)}}}}else{n.modelMatrixBuffer?(me.bindBuffer(me.ARRAY_BUFFER,n.modelMatrixBuffer),o.matrixWorlds&&me.bufferData(me.ARRAY_BUFFER,o.matrixWorlds,me.STATIC_DRAW)):(n.modelMatrixBuffer=me.createBuffer(),me.bindBuffer(me.ARRAY_BUFFER,n.modelMatrixBuffer),o.matrixWorlds&&o.matrixWorlds.length,me.bufferData(me.ARRAY_BUFFER,o.matrixWorlds,me.STATIC_DRAW),n.instanceInfo&&(n.instanceInfo.modelMatrixBuffer=n.modelMatrixBuffer));for(var w=0;w<4;++w){var I=c+w;R.enableAttributeAndDivisor(I,1),me.vertexAttribPointer(I,4,me.FLOAT,!1,64,16*w)}}}R.disableUnusedAttributes()}}function Te(e,t,n,i){if(void 0!==e.renderOnce&&!e.lineSegmentsSet.dirty||(e.renderOnce=!0),e.renderOnce){var r=e.getDrawModeFace(),o=e.getDrawModeFaceColorMask(),a=e.getDrawModeEdge(),s=r&&o&&e.renderOnce&&e.hasTransparentBodies()&&!e.meshManager.overrideMaterial&&e.geomManager.allGeomInMemory,l=s,d=!!e.bvh.nLines;if(e.needsFastRendering&&(i/=1.2),e.forceRenderAll&&(e.forceRenderAll=d=!(i=500)),r&&0<i){if(e.selectedBodiesDirty&&!e.meshManager.overrideMaterial&&!Ue.inBIMContext){for(var c=0,h=(x=e.getSelectedBodies()).length;c<h;++c)for(var u=x[c],f=0,p=e.meshManager.getNumBodyMeshs(u);f<p;++f)(w=e.meshManager.getBodyMesh(u,f))&&(w.material=e.meshManager.selectedMaterial,w.material.lights&&(w.geometry.attributes.normal?w.material.flatShading=!1:w.material.flatShading=!0),w.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,w.matrixWorld),w.matrixAutoUpdate=!1,w.matrixWorldNeedsUpdate=!1,o||(w.material.colorWrite=!1),F.renderBufferDirect(n,t.fog,w.geometry,w.material,w,null,!0),o||(w.material.colorWrite=!0));e.selectedBodiesDirty=!1}if(e.meshManager.dirty){for(c=0,h=e.meshManager.getNumInstancedMeshes();c<h;++c){var m=e.meshManager.getInstancedMeshId(c);e.meshManager.isMeshSelected(m)||(w=e.meshManager.getInstancedMesh(c))&&(l&&w.material.transparent&&w.material.opacity<=.99?(w.geometry.dirty=!0,w.geometry.updateModelMatrix=!0):(w.matrixAutoUpdate=!1,w.matrixWorldNeedsUpdate=!1,o||(w.material.colorWrite=!1),F.renderBufferDirect(n,t.fog,w.geometry,w.material,w,null,!0),o||(w.material.colorWrite=!0)))}e.meshManager.dirty=!1}var g=e.getMeshSets(),v=[];0==g.length&&(d=!1);e.geomManager.bufferChunksToLoad.length;for(var y=0;y<g.length;++y)!(M=g[y]).isLoaded()||!(M.dirty||M.lineDirty||M.hiddenLineDirty)||M.isAllMeshHidden()||e.renderOnce&&!M.isVisible(oe,e.ModelUpMatrix4)||(M.requireReload?M.reloadGeometry():M.isReloadingGeometry()||v.push(y));e.sortMeshSets(v,n),o||(R.buffers.color.setMask(!1),R.buffers.color.setLocked(!0));for(var E=0,b=v.length;E<b;++E){var M=g[v[E]];if(M.dirty&&(i=function(e,t,n,i,r,o){function a(e){if(o&&e.material.transparent&&e.material.opacity<=.99)return e.geometry.dirty=!0,e.geometry.updateModelMatrix=!0,0;s?(ce=Ae(e.matrixWorld,s),s.copy(e.matrixWorld)):(s=e.matrixWorld.clone(),ce=!1),e.instancedCount||e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(n,t.fog,e.geometry,e.material,e,null,!0)}var s=null,l=performance.now();e.sorted||e.sortMeshes();if(r){for(var d=0,c=e.getNumMeshes();d<c;++d){var h=e.getMeshId(d);e.bvh.meshManager.isMeshSelected(h)||(m=e.getMesh(d))&&a(m)}for(var u=0,f=e.getNumTexts();u<f;++u)(g=e.getText(u))&&a(g)}else{for(var p=e.getNumMeshes()-1;0<=p;--p){var m,h=e.getMeshId(p);e.bvh.meshManager.isMeshSelected(h)||(m=e.getMesh(p))&&a(m)}for(var g,v=e.getNumTexts()-1;0<=v;--v)(g=e.getText(v))&&a(g)}return r=performance.now(),i-=r-l}(M,t,n,i,!0,l),e.renderMeshSetCount+=1,M.renderOnce=!0,M.dirty=!1,d&&(M.lineDirty=!0),i<0||i<300&&fe.faces+fe.lines>F.maxPrimitivesPerFrame))break}if((s||Ue.inBIMContext&&0<e.getSelectedBodies().length)&&e.transparentBodiesDirty){for(c=0,h=e.meshManager.getNumInstancedMeshes();c<h;++c){m=e.meshManager.getInstancedMeshId(c);e.meshManager.isMeshSelected(m)||(w=e.meshManager.getInstancedMesh(c))&&l&&w.material.transparent&&w.material.opacity<=.99&&(w.matrixAutoUpdate=!1,w.matrixWorldNeedsUpdate=!1,o||(w.material.colorWrite=!1),F.renderBufferDirect(n,t.fog,w.geometry,w.material,w,null,!0),o||(w.material.colorWrite=!0))}s=e.getAllTransparentBodies(!0);if(!function(e,t,n,i,r){for(var o,a=null,s=performance.now(),l=0,d=t.length;l<d;++l)for(var c=t[l],h=e.meshManager.getNumBodyMeshs(c),u=0;u<h;++u){var f=e.meshManager.getBodyMeshId(c,u);e.meshManager.isMeshSelected(f)||(f=e.meshManager.getMesh(f))&&f.material.transparent&&f.material.opacity<=.99&&(a?(ce=Ae(f.matrixWorld,a),a.copy(f.matrixWorld)):(a=f.matrixWorld.clone(),ce=!1),f.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,f.matrixWorld),f.matrixAutoUpdate=!1,f.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(i,n.fog,f.geometry,f.material,f,null,!0))}o=performance.now(),r-=o-s}(e,s,t,n,i),e.transparentBodiesDirty=!1,ce=!1,e.selectedBodiesDirty&&!e.meshManager.overrideMaterial&&Ue.inBIMContext){for(var x,c=0,h=(x=e.getSelectedBodies()).length;c<h;++c)for(var w,u=x[c],f=0,p=e.meshManager.getNumBodyMeshs(u);f<p;++f)(w=e.meshManager.getBodyMesh(u,f))&&(w.material=Ue.BIMselectedMaterial,w.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,w.matrixWorld),w.matrixAutoUpdate=!1,w.matrixWorldNeedsUpdate=!1,o||(w.material.colorWrite=!1),F.renderBufferDirect(n,t.fog,w.geometry,w.material,w,null,!0),o||(w.material.colorWrite=!0));e.selectedBodiesDirty=!1}}o||(R.buffers.color.setLocked(!1),R.buffers.color.setMask(!0))}a&&0<i&&(i=function(e,t,n,i,r,o){if(!t.dirty)return o;var a,s=null,l=e.getDrawModeHiddenEdge(),d=performance.now(),c=o,h=0,u=e.meshManager.getNumInstancedLineSegs(),f=u?e.meshManager.getNumUnInstancedLineSegs():t.getNumLineSegments(),f=u+f,p=0,m=1;l&&(m+=1);for(p=0;p<m;++p){var g=e.meshManager.getNumInstancedLineSegs();1==p&&e.meshManager.resetLineInstance();for(var v=0,y=g;v<y;++v){++h;for(var E=e.meshManager.instancedLineSegInfos[v],b=!0,M=0;M<E.lineSegIds.length;M++)if(e.meshManager.lineSegBodyNodes[E.lineSegIds[M]].isSelected()){b=!1;break}if(b)1===(R=e.meshManager.getInstancedLineSegWithState(v,1===p)).state&&((R=R.lineSegments).matrixAutoUpdate=!1,R.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(r,i.fog,R.geometry,R.material,R,null,!0));else for(var x,E=e.meshManager.instancedLineSegInfos[v],M=0;M<E.lineSegIds.length;M++)1===(R=e.meshManager.getLineSegmentsWithState(E.lineSegIds[M],1===p,!1)).state&&(x=R.lineSegments,s?(ce=Ae(x.matrixWorld,s),s.copy(x.matrixWorld)):(s=x.matrixWorld.clone(),ce=!1),x.instancedCount||x.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,x.matrixWorld),x.matrixAutoUpdate=!1,x.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(r,i.fog,x.geometry,x.material,x,null,!0))}if(a=performance.now(),o=c-(a-d),n){var w=e.getMeshSets();for(v=0,y=n.length;v<y;++v){var I=w[n[v]];if(I.lineDirty||I.hiddenLineDirty){for(var S=0,T=I.getNumLineSegments();S<T;++S){var A,R=I.getLineSegmentsWithState(S,1===p,!0);++h,1===R.state&&(A=R.lineSegments,s?(ce=Ae(A.matrixWorld,s),s.copy(A.matrixWorld)):(s=A.matrixWorld.clone(),ce=!1),A.instancedCount||A.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,A.matrixWorld),A.matrixAutoUpdate=!1,A.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(r,i.fog,A.geometry,A.material,A,null,!0),Re(r,i,R.lineStyle,A.matrixWorld,A.instancedCount,A.matrixWorlds))}I.lineDirty?(I.lineDirty=!1,2===m&&(I.hiddenLineDirty=!0)):I.hiddenLineDirty&&(I.hiddenLineDirty=!1)}a=performance.now(),o=c-(a-d)}}else{var O=g?e.meshManager.getNumUnInstancedLineSegs():t.getNumLineSegments();for(v=0,y=O;v<y;++v){var P=void 0,C=void 0;C=g?e.meshManager.getUnInstancedLineSegWithState(v,1===p):t.getLineSegmentsWithState(v,1===p),++h,1===C.state&&(P=C.lineSegments,s?(ce=Ae(P.matrixWorld,s),s.copy(P.matrixWorld)):(s=P.matrixWorld.clone(),ce=!1),P.instancedCount||P.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,P.matrixWorld),P.matrixAutoUpdate=!1,P.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(r,i.fog,P.geometry,P.material,P,null,!0),Re(r,i,C.lineStyle,P.matrixWorld,P.instancedCount,P.matrixWorlds))}a=performance.now(),o-=a-d}}(f*m<=h||n&&0===n.length)&&(t.dirty=!1);return o}(e,e.getLineSegmentsSet(),d?v:null,t,n,i)),e.renderOnce&&(e.renderOnce=g&&e.renderMeshSetCount>=v.length,d&&e.renderOnce&&(e.renderOnce=e.getLineSegmentsSet().dirty),null==e.renderOnce&&(e.renderOnce=!0)),e.renderOnce||(e.renderMeshSetCount=0),e.requireContinueLoading()&&(e.pageOut(),e.hasEnoughAvailableMemory()&&e.continueLoading()),Z&&N.bindVertexArrayOES(null),ce=!1}}function Ae(e,t){for(var n=e.elements,i=t.elements,r=0;r<16;r++)if(1e-7<Math.abs(n[r]-i[r]))return!1;return!0}function Re(e,t,n,i,r){var o;n&&(o=n.textMesh,n.textMesh&&(o.matrixWorld.copy(i),r||o.modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,i),o.matrixAutoUpdate=!1,o.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(e,t.fog,o.geometry,o.material,o,null,!0)),(o=n.pointMesh)&&(o.matrixWorld.copy(i),r||o.modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,i),o.matrixAutoUpdate=!1,o.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(e,t.fog,o.geometry,o.material,o,null,!0)),(n=n.lineMesh)&&(n.matrixWorld.copy(i),r||n.modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,i),n.matrixAutoUpdate=!1,n.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(e,t.fog,n.geometry,n.material,n,null,!0)))}this.shadowMap=Ee,this.getContext=function(){return me},this.getContextAttributes=function(){return me.getContextAttributes()},this.forceContextLoss=function(){var e=S.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=S.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return te},this.setPixelRatio=function(e){void 0!==e&&(te=e,this.setSize($,ee,!1))},this.getSize=function(){return{width:$,height:ee}},this.setSize=function(e,t,n){var i,r,o=ye.getDevice();o&&o.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):($=e,ee=t,a.width=e*te,a.height=t*te,!1!==n&&(a.style.width=e+"px",a.style.height=t+"px"),i=me.getParameter(me.MAX_TEXTURE_SIZE),r=2,r=(o=a.width*(r=d?1:r))/(n=a.height*r),n<o?i<o&&(o=i,n=Math.floor(o/r)):i<n&&(n=i,o=Math.floor(n*r)),u&&u.width===o&&u.height===n||(u&&(u.dispose(),u=null),r={magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:THREE.UnsignedByteType,depthBuffer:!0,stencilBuffer:!1,depthTexture:null},(u=new THREE.WebGLRenderTarget(o,n,r)).texture.generateMipmaps=!1),this.colorTarget=u,this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(){return{width:$*te,height:ee*te}},this.setDrawingBufferSize=function(e,t,n){$=e,ee=t,te=n,a.width=e*n,a.height=t*n,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,n,i){ne.set(e,ee-t-i,n,i),R.viewport(G.copy(ne).multiplyScalar(te))},this.setScissor=function(e,t,n,i){ie.set(e,ee-t-i,n,i),R.scissor(W.copy(ie).multiplyScalar(te))},this.setScissorTest=function(e){R.setScissorTest(re=e)},this.getClearColor=x.getClearColor,this.setClearColor=x.setClearColor,this.getClearAlpha=x.getClearAlpha,this.setClearAlpha=x.setClearAlpha,this.clear=function(e,t,n){var i=0;void 0!==e&&!e||(i|=me.COLOR_BUFFER_BIT),void 0!==t&&!t||(i|=me.DEPTH_BUFFER_BIT),void 0!==n&&!n||(i|=me.STENCIL_BUFFER_BIT),me.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,n,i){this.setRenderTarget(e),this.clear(t,n,i)},this.dispose=function(){a.removeEventListener("webglcontextlost",be,!1),a.removeEventListener("webglcontextrestored",Me,!1),M.dispose(),ye.dispose()},this.renderBufferImmediate=function(e,t,n){R.initAttributes();var i=O.get(e);e.hasPositions&&!i.position&&(i.position=me.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=me.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=me.createBuffer()),e.hasColors&&!i.color&&(i.color=me.createBuffer());t=t.getAttributes();if(e.hasPositions&&(me.bindBuffer(me.ARRAY_BUFFER,i.position),me.bufferData(me.ARRAY_BUFFER,e.positionArray,me.DYNAMIC_DRAW),R.enableAttribute(t.position),me.vertexAttribPointer(t.position,3,me.FLOAT,!1,0,0)),e.hasNormals){if(me.bindBuffer(me.ARRAY_BUFFER,i.normal),!n.isMeshPhongMaterial&&!n.isMeshStandardMaterial&&!n.isMeshNormalMaterial&&!0===n.flatShading)for(var r=0,o=3*e.count;r<o;r+=9){var a=e.normalArray,s=(a[r+0]+a[r+3]+a[r+6])/3,l=(a[r+1]+a[r+4]+a[r+7])/3,d=(a[r+2]+a[r+5]+a[r+8])/3;a[r+0]=s,a[r+1]=l,a[r+2]=d,a[r+3]=s,a[r+4]=l,a[r+5]=d,a[r+6]=s,a[r+7]=l,a[r+8]=d}me.bufferData(me.ARRAY_BUFFER,e.normalArray,me.DYNAMIC_DRAW),R.enableAttribute(t.normal),me.vertexAttribPointer(t.normal,3,me.FLOAT,!1,0,0)}e.hasUvs&&n.map&&(me.bindBuffer(me.ARRAY_BUFFER,i.uv),me.bufferData(me.ARRAY_BUFFER,e.uvArray,me.DYNAMIC_DRAW),R.enableAttribute(t.uv),me.vertexAttribPointer(t.uv,2,me.FLOAT,!1,0,0)),e.hasColors&&n.vertexColors!==THREE.NoColors&&(me.bindBuffer(me.ARRAY_BUFFER,i.color),me.bufferData(me.ARRAY_BUFFER,e.colorArray,me.DYNAMIC_DRAW),R.enableAttribute(t.color),me.vertexAttribPointer(t.color,3,me.FLOAT,!1,0,0)),R.disableUnusedAttributes(),me.drawArrays(me.TRIANGLES,0,e.count),fe.calls++,fe.vertices+=e.count,fe.faces+=e.count/3,e.count=0},this.renderBufferDirect=function(e,t,n,i,r,o,a){R.setMaterial(i),n.isNdsGeometry&&!n.hasDisposeEventListener&&(n.addEventListener("dispose",Ie),n.hasDisposeEventListener=!0);var s=_e(e,t,i,r),l=n.uuid+"_"+s.id+"_"+(!0===i.wireframe);n.instanceInfo&&(l+="_"+i.uuid);var d=!1,c=!1;l!==j&&(j=l,c=d=!0),r.morphTargetInfluences&&(w.update(r,n,i,s),d=!0);e=n.index,t=n.attributes.position,l=1;!0===i.wireframe&&(e=p.getWireframeAttribute(n),l=2);var h,u=I;a?(!(N=null)||n.vao||n.useSharedGlBuffer||function(e,t,n){if(Z&&q===t.id&&Q===e.index.uuid&&J===e.attributes.position.data.uuid)return e.vao=Z;var i=t.getAttributes();e.vao=N.createVertexArrayOES(),N.bindVertexArrayOES(e.vao),e.index.indexBuffer?me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,e.index.indexBuffer):(e.index.indexBuffer=me.createBuffer(),me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,e.index.indexBuffer),me.bufferData(me.ELEMENT_ARRAY_BUFFER,e.index.array,me.STATIC_DRAW));var r=e.attributes.position;if(r.data.dataBuffer?me.bindBuffer(me.ARRAY_BUFFER,r.data.dataBuffer):(r.data.dataBuffer=me.createBuffer(),me.bindBuffer(me.ARRAY_BUFFER,r.data.dataBuffer),me.bufferData(me.ARRAY_BUFFER,r.data.array,me.STATIC_DRAW)),r=i.position,me.vertexAttribPointer(r,3,me.FLOAT,!1,24,0),me.enableVertexAttribArray(r),r=i.normal,me.vertexAttribPointer(r,3,me.FLOAT,!1,24,12),me.enableVertexAttribArray(r),H&&1<=n.instancedCount){var o=i.modelMatrixAttrib;e.modelMatrixBuffer?me.bindBuffer(me.ARRAY_BUFFER,e.modelMatrixBuffer):(e.modelMatrixBuffer=me.createBuffer(),me.bindBuffer(me.ARRAY_BUFFER,e.modelMatrixBuffer),me.bufferData(me.ARRAY_BUFFER,n.matrixWorlds,me.STATIC_DRAW));for(var a=0;a<4;++a){var s=o+a;me.vertexAttribPointer(s,4,me.FLOAT,!1,64,16*a),me.enableVertexAttribArray(s),H.vertexAttribDivisorANGLE(s,1)}}N.bindVertexArrayOES(null),Z=e.vao,q=t.id,Q=e.index.uuid,J=e.attributes.position.data.uuid}(n,s,r),n.vao?(c||e&&X!==e.uuid)&&(N.bindVertexArrayOES(n.vao),X=e.uuid):null!=e&&(e.type||(e.array instanceof Uint16Array?e.type=me.UNSIGNED_SHORT:e.array instanceof Uint32Array?e.type=me.UNSIGNED_INT:e.array instanceof Uint8Array&&(e.type=me.UNSIGNED_BYTE),e.bytesPerElement=e.array.BYTES_PER_ELEMENT),d=(n.useSharedGlBuffer?(h=e.uuid,e.uuid="index",void 0===(f=P.get(e))?(P.update(e,me.ELEMENT_ARRAY_BUFFER),f=P.get(e)):(me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,f.buffer),me.bufferData(me.ELEMENT_ARRAY_BUFFER,e.array,me.DYNAMIC_DRAW)),e.uuid=h):e.indexBuffer||(e.indexBuffer=me.createBuffer(),me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,e.indexBuffer),me.bufferData(me.ELEMENT_ARRAY_BUFFER,e.array,me.STATIC_DRAW)),!0),(c||e&&X!==e.uuid)&&(Se(i,s,n,0,a,r),h=f?f.buffer:e.indexBuffer,!c&&X===e.uuid||(me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,h),X=e.uuid)))):(null!==e&&(f=P.get(e),(u=B).setIndex(f)),d&&(Se(i,s,n),null!==e&&me.bindBuffer(me.ELEMENT_ARRAY_BUFFER,f.buffer)));d=0;null!==e?d=e.count:void 0!==t&&(d=t.count);var s=n.drawRange.start*l,f=n.drawRange.count*l,t=null!==o?o.start*l:0,o=null!==o?o.count*l:1/0,l=Math.max(s,t),t=Math.min(d,s+f,t+o)-1,o=Math.max(0,t-l+1);if(0!==o){if(r.isMesh)if(!0===i.wireframe||i.asLines)R.setLineWidth(i.wireframeLinewidth*pe()),u.setMode(me.LINES);else switch(r.drawMode){case THREE.TrianglesDrawMode:u.setMode(me.TRIANGLES);break;case THREE.TriangleStripDrawMode:u.setMode(me.TRIANGLE_STRIP);break;case THREE.TriangleFanDrawMode:u.setMode(me.TRIANGLE_FAN)}else r.isLine?(t=i.linewidth,R.setLineWidth((t=void 0===t?1:t)*pe()),r.isLineSegments?u.setMode(me.LINES):r.isLineLoop?u.setMode(me.LINE_LOOP):u.setMode(me.LINE_STRIP)):(r.isPoints||n.isPoints)&&u.setMode(me.POINTS);n&&n.isInstancedBufferGeometry?0<n.maxInstancedCount&&u.renderInstances(n,l,o):a?H&&1<=r.instancedCount?(a=r.isPoints||n.isPoints?me.POINTS:i.wireframe||i.asLines||!r.isMesh?me.LINES:me.TRIANGLES,H.drawElementsInstancedANGLE(a,o,e.type,l*e.bytesPerElement,r.instancedCount),fe.calls++,fe.vertices+=o*r.instancedCount,a===me.TRIANGLES?fe.faces+=r.instancedCount*o/3:a===me.LINES?fe.lines+=r.instancedCount*o/2:a===me.POINTS&&(fe.lines+=r.instancedCount*o)):null!=e&&(r=r.isPoints||n.isPoints?me.POINTS:i.wireframe||i.asLines||!r.isMesh?me.LINES:me.TRIANGLES,me.drawElements(r,o,e.type,l*e.bytesPerElement),fe.calls++,fe.vertices+=o,r===me.TRIANGLES?fe.faces+=o/3:r===me.LINES?fe.lines+=o/2:r===me.POINTS&&(fe.points+=+o)):u.render(l,o)}},this.supportInstancedArrays=function(){return!!H};var Oe,Pe,Ce,Be=!(this.compile=function(n,e){m.length=0,T.length=0,n.traverse(function(e){e.isLight&&(m.push(e),e.castShadow&&T.push(e))}),C.setup(m,T,e),n.traverse(function(e){if(e.material)if(Array.isArray(e.material))for(var t=0;t<e.material.length;t++)Fe(e.material[t],n.fog,e);else Fe(e.material,n.fog,e)})}),Le=null;function De(e){null!==Le&&Le(e),(ye.getDevice()||window).requestAnimationFrame(De)}function He(e,t,n,i){for(var r=0,o=e.length;r<o;r++){var a=e[r],s=a.object,l=a.geometry,d=void 0===i?a.material:i,c=a.group;if(n.isArrayCamera)for(var h=(z=n).cameras,u=0,f=h.length;u<f;u++){var p,m,g,v,y=h[u];s.layers.test(y.layers)&&(p=(v=y.bounds).x*$,m=v.y*ee,g=v.z*$,v=v.w*ee,R.viewport(G.set(p,m,g,v).multiplyScalar(te)),Ne(s,t,y,l,d,c))}else z=null,Ne(s,t,n,l,d,c)}}function Ne(e,t,n,i,r,o){var a,s,l;e.onBeforeRender(F,t,n,i,r,o),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject?(R.setMaterial(r),a=_e(n,t.fog,r,e),j="",s=a,l=r,e.render(function(e){F.renderBufferImmediate(e,s,l)})):F.renderBufferDirect(n,t.fog,i,r,e,o),e.onAfterRender(F,t,n,i,r,o)}function Fe(e,t,n){var i=O.get(e),r=c.getParameters(e,C.state,T,t,ae.numPlanes,ae.numIntersection,n),o=c.getProgramCode(e,r),a=i.program,n=!0;if(void 0===a)e.addEventListener("dispose",xe);else if(a.code!==o)we(e);else{if(void 0!==r.shaderID)return;n=!1}n&&(r.shaderID?(n=THREE.ShaderLib[r.shaderID],i.shader={name:e.type,uniforms:THREE.UniformsUtils.clone(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader}):i.shader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader},e.onBeforeCompile(i.shader),a=c.acquireProgram(e,i.shader,r,o),i.program=a,e.program=a);var s=a.getAttributes();if(e.morphTargets)for(var l=e.numSupportedMorphTargets=0;l<F.maxMorphTargets;l++)0<=s["morphTarget"+l]&&e.numSupportedMorphTargets++;if(e.morphNormals)for(l=e.numSupportedMorphNormals=0;l<F.maxMorphNormals;l++)0<=s["morphNormal"+l]&&e.numSupportedMorphNormals++;a=i.shader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=ae.numPlanes,i.numIntersection=ae.numIntersection,a.clippingPlanes=ae.uniform),i.fog=t,i.lightsHash=C.state.hash,e.lights&&(a.ambientLightColor.value=C.state.ambient,a.directionalLights.value=C.state.directional,a.spotLights.value=C.state.spot,a.rectAreaLights.value=C.state.rectArea,a.pointLights.value=C.state.point,a.hemisphereLights.value=C.state.hemi,a.directionalShadowMap.value=C.state.directionalShadowMap,a.directionalShadowMatrix.value=C.state.directionalShadowMatrix,a.spotShadowMap.value=C.state.spotShadowMap,a.spotShadowMatrix.value=C.state.spotShadowMatrix,a.pointShadowMap.value=C.state.pointShadowMap,a.pointShadowMatrix.value=C.state.pointShadowMatrix);t=i.program.getUniforms(),a=THREE.WebGLUniforms.seqWithValue(t.seq,a);i.uniformsList=a}function _e(e,t,n,i){K=0;var r=O.get(n);se&&(!le&&e===U||(c=e===U&&n.id===V,ae.setState(n.clippingPlanes,n.clipIntersection,n.clipShadows,e,r,c))),!1===n.needsUpdate&&(void 0===r.program||n.fog&&r.fog!==t||n.lights&&r.lightsHash!==C.state.hash||void 0!==r.numClippingPlanes&&(r.numClippingPlanes!==ae.numPlanes||r.numIntersection!==ae.numIntersection))&&(n.needsUpdate=!0),n.needsUpdate&&(Fe(n,t,i),n.needsUpdate=!1);var o=!1,a=!1,s=!1;n.needsRefresh&&(n.needsRefresh=!(o=!0));var l,d,c,h,u,f,p,m,g,v=r.program,y=v.getUniforms(),E=r.shader.uniforms;if(R.useProgram(v.program)&&(s=o=a=!0),n.id!==V&&(V=n.id,o=!0),!a&&e===U||(me.uniformMatrix4fv(y.addrs.projectionMatrix,!1,e.projectionMatrix.elements),A.logarithmicDepthBuffer&&y.setValue(me,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),U!==(z||e)&&(U=z||e,s=o=!0),!(n.isShaderMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.envMap)||void 0!==(d=y.map.cameraPosition)&&d.setValue(me,he.setFromMatrixPosition(e.matrixWorld)),(n.isInstanceMaterial||n.isMeshPhongMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial||n.skinning||n.isLineBasicMaterial)&&me.uniformMatrix4fv(y.addrs.viewMatrix,!1,e.matrixWorldInverse.elements)),n.skinning&&(y.setOptional(me,i,"bindMatrix"),y.setOptional(me,i,"bindMatrixInverse"),(l=i.skeleton)&&(c=l.bones,A.floatVertexTextures?(void 0===l.boneTexture&&(d=Math.sqrt(4*c.length),d=THREE.Math.nextPowerOfTwo(Math.ceil(d)),d=Math.max(d,4),(e=new THREE.Float32Array(d*d*4)).set(l.boneMatrices),c=new THREE.DataTexture(e,d,d,THREE.RGBAFormat,THREE.FloatType),l.boneMatrices=e,l.boneTexture=c,l.boneTextureSize=d),y.setValue(me,"boneTexture",l.boneTexture),y.setValue(me,"boneTextureSize",l.boneTextureSize)):y.setOptional(me,l,"boneMatrices"))),o){a&&(y.setValue(me,"toneMappingExposure",F.toneMappingExposure),y.setValue(me,"toneMappingWhitePoint",F.toneMappingWhitePoint)),n.lights&&(o=s,(s=E).ambientLightColor.needsUpdate=o,s.directionalLights.needsUpdate=o,s.pointLights.needsUpdate=o,s.spotLights.needsUpdate=o,s.rectAreaLights.needsUpdate=o,s.hemisphereLights.needsUpdate=o),t&&n.fog&&(g=t,(m=E).fogColor.value=g.color,g.isFog?(m.fogNear.value=g.near,m.fogFar.value=g.far):g.isFogExp2&&(m.fogDensity.value=g.density)),n.isMeshBasicMaterial?ke(E,n):n.isMeshLambertMaterial?(ke(E,n),m=E,(g=n).emissiveMap&&(m.emissiveMap.value=g.emissiveMap)):n.isMeshPhongMaterial?(ke(E,n),n.isMeshToonMaterial?(Ve(f=E,p=n),p.gradientMap&&(f.gradientMap.value=p.gradientMap)):Ve(E,n)):n.isMeshStandardMaterial?(ke(E,n),n.isMeshPhysicalMaterial?(f=n,(p=E).clearCoat.value=f.clearCoat,p.clearCoatRoughness.value=f.clearCoatRoughness,je(p,f)):je(E,n)):n.isMeshDepthMaterial?(ke(E,n),h=E,(u=n).displacementMap&&(h.displacementMap.value=u.displacementMap,h.displacementScale.value=u.displacementScale,h.displacementBias.value=u.displacementBias)):n.isMeshDistanceMaterial?(ke(E,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(E,n)):n.isMeshNormalMaterial?(ke(E,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale);t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale));t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(E,n)):n.isLineBasicMaterial?(h=n,(u=E).diffuse.value=h.color,u.opacity.value=h.opacity,n.isLineDashedMaterial&&(u=n,(h=E).dashSize.value=u.dashSize,h.totalSize.value=u.dashSize+u.gapSize,h.scale.value=u.scale)):n.isPointsMaterial?function(e,t){{var n;e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*te,e.scale.value=.5*ee,e.map.value=t.map,null!==t.map&&(n=t.map.offset,t=t.map.repeat,e.offsetRepeat.value.set(n.x,n.y,t.x,t.y))}}(E,n):n.isShadowMaterial&&(E.color.value=n.color,E.opacity.value=n.opacity),void 0!==E.ltcMat&&(E.ltcMat.value=THREE.UniformsLib.LTC_MAT_TEXTURE),void 0!==E.ltcMag&&(E.ltcMag.value=THREE.UniformsLib.LTC_MAG_TEXTURE);for(var b=E,M=0,x=(w=r.uniformsList).length;M!==x;++M)!1!==(S=b[(I=w[M]).id]).needsUpdate&&I.setValue(me,S.value,F)}if(n.isShaderMaterial&&!0===n.uniformsNeedUpdate){for(var w,I,S,b=E,M=0,x=(w=r.uniformsList).length;M!==x;++M)!1!==(S=b[(I=w[M]).id]).needsUpdate&&I.setValue(me,S.value,F);n.uniformsNeedUpdate=!1}return!a&&ce||(i.instancedCount||me.uniformMatrix4fv(y.addrs.modelViewMatrix,!1,i.modelViewMatrix.elements),r=!!n.envMap,a=F.shadowMap.enabled&&i.receiveShadow&&0<T.length,(r||a||n.requireModelMatrix)&&!i.instancedCount&&me.uniformMatrix4fv(y.addrs.modelMatrix,!1,i.matrixWorld.elements)),v}function ke(e,t){var n;e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity),t.map?n=t.map:t.specularMap?n=t.specularMap:t.displacementMap?n=t.displacementMap:t.normalMap?n=t.normalMap:t.bumpMap?n=t.bumpMap:t.roughnessMap?n=t.roughnessMap:t.metalnessMap?n=t.metalnessMap:t.alphaMap?n=t.alphaMap:t.emissiveMap&&(n=t.emissiveMap),void 0!==n&&(t=(n=n.isWebGLRenderTarget?n.texture:n).offset,n=n.repeat,e.offsetRepeat.value.set(t.x,t.y,n.x,n.y))}function Ve(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function je(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}this.animate=function(e){Le=e,Be||((ye.getDevice()||window).requestAnimationFrame(De),Be=!0)},this.render=function(e,t,n,i,r,o){var a,s,l,d,c,h,u,f,p=6<arguments.length&&void 0!==arguments[6]?arguments[6]:60;t&&t.isCamera?_||(j="",q=V=-1,!(J=Q=Z=X=U=null)===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),ye.enabled&&(t=ye.getCamera(t)),de.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),oe.setFromMatrix(de),t.pixelSizeVector=(a=F.domElement.clientWidth,s=F.domElement.clientHeight,l=t.projectionMatrix,d=t.matrixWorldInverse,c=l.elements[0]*a*.5,a=l.elements[8]*a*.5+l.elements[11]*a*.5,c=new THREE.Vector3(d.elements[0]*c+d.elements[2]*a,d.elements[4]*c+d.elements[6]*a,d.elements[8]*c+d.elements[10]*a),a=l.elements[5]*s*.5,s=l.elements[9]*s*.5+l.elements[11]*s*.5,a=new THREE.Vector3(d.elements[1]*a+d.elements[2]*s,d.elements[5]*a+d.elements[6]*s,d.elements[9]*a+d.elements[10]*s),s=l.elements[11],l=l.elements[15],l=new THREE.Vector4(d.elements[2]*s,d.elements[6]*s,d.elements[10]*s,d.elements[14]*s+d.elements[15]*l),a=.7071067811/Math.sqrt(c.lengthSq()+a.lengthSq()),l.multiplyScalar(a),l),m.length=0,T.length=0,v.length=0,y.length=0,le=this.localClippingEnabled,se=ae.init(this.clippingPlanes,le,t),(g=M.get(e,t)).init(),0<e.children.length&&e.children[e.children.length-1]instanceof ze&&(h=e.children.pop()),function e(t,n,i){if(!t.visible)return;var r=t.layers.test(n.layers);if(r)if("CoordSystem"==t.type&&t.update(),t.isLight)m.push(t),t.castShadow&&T.push(t);else if(t.isSprite)t.frustumCulled&&!oe.intersectsSprite(t)||v.push(t);else if(t.isLensFlare)y.push(t);else if(t.isImmediateRenderObject)i&&he.setFromMatrixPosition(t.matrixWorld).applyMatrix4(de),g.push(t,null,t.material,he.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.update(),!t.frustumCulled||oe.intersectsObject(t))){i&&he.setFromMatrixPosition(t.matrixWorld).applyMatrix4(de);var o=b.update(t),a=t.material;if(a)if(Array.isArray(a))for(var s=o.groups,l=0,d=s.length;l<d;l++){var c=s[l],h=a[c.materialIndex];h&&h.visible&&g.push(t,o,h,he.z,c)}else a.visible&&g.push(t,o,a,he.z,null)}var u=t.children;for(var l=0,d=u.length;l<d;l++)e(u[l],n,i)}(e,t,F.sortObjects),!0===F.sortObjects&&g.sort(),se&&ae.beginShadows(),Ee.render(T,e,t),C.setup(m,T,t),se&&ae.endShadows(),fe.frame++,fe.calls=0,fe.vertices=0,fe.faces=0,fe.lines=0,fe.points=0,this.setRenderTarget(n=void 0===n?null:n),x.render(g,e,t,i),h&&(o?(i=e,o=t,(f=h).referenceEntityDirty&&0<f.wholeRefEntityNodes.length&&!f.referenceEntityDispManager.overrideMaterial&&(performance.now(),(u=f.referenceEntityDispManager.getAxisDispData()).normalAxisLines&&(u.normalAxisLines.modelViewMatrix.copy(o.matrixWorldInverse),u.normalAxisLines.matrixAutoUpdate=!1,u.normalAxisLines.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.normalAxisLines.geometry,u.normalAxisLines.material,u.normalAxisLines,null,!0)),u.selectedAxisLines&&(u.selectedAxisLines.modelViewMatrix.copy(o.matrixWorldInverse),u.selectedAxisLines.matrixAutoUpdate=!1,u.selectedAxisLines.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.selectedAxisLines.geometry,u.selectedAxisLines.material,u.selectedAxisLines,null,!0)),u.preselectedAxisLines&&(u.preselectedAxisLines.modelViewMatrix.copy(o.matrixWorldInverse),u.preselectedAxisLines.matrixAutoUpdate=!1,u.preselectedAxisLines.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.preselectedAxisLines.geometry,u.preselectedAxisLines.material,u.preselectedAxisLines,null,!0)),(u=f.referenceEntityDispManager.getPlaneDispData()).normalPlaneEdge&&(u.normalPlaneEdge.modelViewMatrix.copy(o.matrixWorldInverse),u.normalPlaneEdge.matrixAutoUpdate=!1,u.normalPlaneEdge.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.normalPlaneEdge.geometry,u.normalPlaneEdge.material,u.normalPlaneEdge,null,!0)),u.selectedPlaneEdge&&(u.selectedPlaneEdge.modelViewMatrix.copy(o.matrixWorldInverse),u.selectedPlaneEdge.matrixAutoUpdate=!1,u.selectedPlaneEdge.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.selectedPlaneEdge.geometry,u.selectedPlaneEdge.material,u.selectedPlaneEdge,null,!0)),u.preselectedPlaneEdge&&(u.preselectedPlaneEdge.modelViewMatrix.copy(o.matrixWorldInverse),u.preselectedPlaneEdge.matrixAutoUpdate=!1,u.preselectedPlaneEdge.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.preselectedPlaneEdge.geometry,u.preselectedPlaneEdge.material,u.preselectedPlaneEdge,null,!0)),u.normalPlaneMesh&&(u.normalPlaneMesh.modelViewMatrix.copy(o.matrixWorldInverse),u.normalPlaneMesh.matrixAutoUpdate=!1,u.normalPlaneMesh.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.normalPlaneMesh.geometry,u.normalPlaneMesh.material,u.normalPlaneMesh,null,!0)),u.selectedPlaneMesh&&(u.selectedPlaneMesh.modelViewMatrix.copy(o.matrixWorldInverse),u.selectedPlaneMesh.matrixAutoUpdate=!1,u.selectedPlaneMesh.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.selectedPlaneMesh.geometry,u.selectedPlaneMesh.material,u.selectedPlaneMesh,null,!0)),u.preselectedPlaneMesh&&(u.preselectedPlaneMesh.modelViewMatrix.copy(o.matrixWorldInverse),u.preselectedPlaneMesh.matrixAutoUpdate=!1,u.preselectedPlaneMesh.matrixWorldNeedsUpdate=!1,F.renderBufferDirect(o,i.fog,u.preselectedPlaneMesh.geometry,u.preselectedPlaneMesh.material,u.preselectedPlaneMesh,null,!0)),f.referenceEntityDirty=!1,performance.now())):Te(h,e,t,p)),u=g.opaque,f=g.transparent,e.overrideMaterial?(p=e.overrideMaterial,u.length&&He(u,e,t,p),f.length&&He(f,e,t,p)):(u.length&&He(u,e,t),f.length&&He(f,e,t)),h?h.spriteDirty&&(D.render(v,e,t),L.render(y,e,t,G),h.spriteDirty=!1):(D.render(v,e,t),L.render(y,e,t,G)),n&&E.updateRenderTargetMipmap(n),R.buffers.depth.setTest(!0),R.buffers.depth.setMask(!0),R.buffers.color.setMask(!0),R.setPolygonOffset(!1),ye.enabled&&ye.submitFrame()):console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFaceCulling=function(e,t){R.setCullFace(e),R.setFlipSided(t===THREE.FrontFaceDirectionCW)},this.allocTextureUnit=function(){var e=K;return e>=A.maxTextures&&console.warn("WebGLRenderer: THREE.Trying to use "+e+" texture units while this GPU supports only "+A.maxTextures),K+=1,e},this.setTexture2D=(Oe=!1,function(e,t){e&&e.isWebGLRenderTarget&&(Oe||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. THREE.Use their .texture property instead."),Oe=!0),e=e.texture),E.setTexture2D(e,t)}),this.setTexture=(Pe=!1,function(e,t){Pe||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),Pe=!0),E.setTexture2D(e,t)}),this.setTextureCube=(Ce=!1,function(e,t){e&&e.isWebGLRenderTargetCube&&(Ce||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),Ce=!0),e=e.texture),e&&e.isCubeTexture||Array.isArray(e.image)&&6===e.image.length?E.setTextureCube(e,t):E.setTextureCubeDynamic(e,t)}),this.getRenderTarget=function(){return f},this.setRenderTarget=function(e){(f=e)&&void 0===O.get(e).__webglFramebuffer&&E.setupRenderTarget(e);var t,n=null,i=!1;Y=e?(t=O.get(e).__webglFramebuffer,e.isWebGLRenderTargetCube?(n=t[e.activeCubeFace],i=!0):n=t,G.copy(e.viewport),W.copy(e.scissor),e.scissorTest):(G.copy(ne).multiplyScalar(te),W.copy(ie).multiplyScalar(te),re),k!==n&&(me.bindFramebuffer(me.FRAMEBUFFER,n),k=n),R.viewport(G),R.scissor(W),R.setScissorTest(Y),i&&(i=O.get(e.texture),me.framebufferTexture2D(me.FRAMEBUFFER,me.COLOR_ATTACHMENT0,me.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,i.__webglTexture,e.activeMipMapLevel))},this.readRenderTargetPixels=function(e,t,n,i,r,o){if(e&&e.isWebGLRenderTarget){var a=O.get(e).__webglFramebuffer;if(a){var s=!1;a!==k&&(me.bindFramebuffer(me.FRAMEBUFFER,a),s=!0);try{var l=e.texture,d=l.format,c=l.type;if(d!==THREE.RGBAFormat&&h.convert(d)!==me.getParameter(me.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(c===THREE.UnsignedByteType||h.convert(c)===me.getParameter(me.IMPLEMENTATION_COLOR_READ_TYPE)||c===THREE.FloatType&&(S.get("OES_texture_float")||S.get("WEBGL_color_buffer_float"))||c===THREE.HalfFloatType&&S.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");me.checkFramebufferStatus(me.FRAMEBUFFER)===me.FRAMEBUFFER_COMPLETE?0<=t&&t<=e.width-i&&0<=n&&n<=e.height-r&&me.readPixels(t,n,i,r,h.convert(d),h.convert(c),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&me.bindFramebuffer(me.FRAMEBUFFER,k)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}};wt.prototype=Object.create(THREE.EventDispatcher.prototype);function Pt(e,t){var o=this;this.viewer=e,this.operator=t;var n=new NDS.Dialog({id:"dlgOpAnnotation",className:"dialog",callbackEvent:r,title:"Comments",noScrollbar:!0});n.setVisibility(!1),n.setSize(250,180),n.addEventListener("close",function(e){o.dialog.setVisibility(!1),o.operator.clicked=-1}),n.setOpacity(Ue.dialogOpacity),e.container.appendChild(n.domElement),this.dialog=n;var i=new NDS.Element({className:"dialog-content"});function r(e){var t,n;switch(e.target.domElement.id){case"dlgOpAnnotation":break;case"btnOk":n={position:null,text:"",visible:!0,hasIndicator:!0},"click"!=(t=(t=e).event.type)&&"touchstart"!=t||null!=o.textInput.domElement.value&&null!=o.textInput.domElement.value&&""!=o.textInput.domElement.value&&(n.position=(new THREE.Vector3).copy(o.operator.lastSprite),o.operator.lastSprite=null,n.text=o.textInput.domElement.value,o.viewer.getCommentsManager().addComment(n),o.show(!1));break;case"btnCancel":"click"!=e.event.type&&"touchstart"!=e.event.tyep||(o.show(!1),o.operator.clicked=-1)}}n.setContent(i),this.textInput=new NDS.TextArea({id:"AnnotationInput",name:"AnnotationInput",className:"annotation-input",type:"textarea",callbackEvent:r}),n.addChildElement(this.textInput),i.domElement.appendChild(this.textInput.domElement),this.link=document.createElement("a"),this.link.href="http://www.baidu.com",this.link.target="_blank",this.link.innerText="点击了解更多详情",i.domElement.appendChild(document.createElement("a")),i.domElement.appendChild(this.link),(t=new NDS.Table).addRow(),t.addRow(),t.addRow(),t.addRow(),t.addRow(),t.addRow(),t.addRow(),t.addRow(),(e=new NDS.Button({id:"btnOk",className:"uploadify-button",callbackEvent:r,text:"OK"})).domElement.width=70,t.addCol({element:e}),(e=new NDS.Button({id:"btnCancel",className:"uploadify-button",callbackEvent:r,text:"Cancel"})).domElement.width=70,t.addCol({element:e}),n.addChildElement(t),i.domElement.appendChild(t.domElement),this.release=function(){o.viewer.container.removeChild(n.domElement)},this.show=function(e,t,n,i,r){e&&(o.dialog.setLeft(t),o.dialog.setTop(n),o.textInput.domElement.value=i,void 0!==r?(o.link.href=r,o.link.innerText="点击了解更多详情"):(o.link.href="",o.link.innerText=""),o.dialog.deleteOpacity()),o.dialog.setVisibility(e)}}n(153);Pt.prototype=Object.create(THREE.EventDispatcher.prototype);function Ct(e){ce.call(this,e),this.type="OpAddComment",this.lastSprite=null,this.addCommentDlg=new Pt(e,this),this.addCommentDlg.show(!1),this.viewer.canvas2D.style.display="",this.getClickPosition=function(){return this.lastSprite}}(Ct.prototype=Object.create(ce.prototype)).release=function(){this.lastSprite=null,this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth,window.innerHeight),this.addCommentDlg.release(),this.addCommentDlg=null,this.update(),this.render(),ce.prototype.release.call(this)},Ct.prototype.update=function(){ce.prototype.update.call(this)},Ct.prototype.onLMouseClick=function(e){e.preventDefault(),this.onClickEvent(e.clientX,e.clientY)},Ct.prototype.onTouchSingleStart=function(e){e.preventDefault(),this.onClickEvent(e.touches[0].clientX,e.touches[0].clientY)},Ct.prototype.onClickEvent=function(e,t){var n=this.viewer,i=n.renderer.domElement,r=n.renderer.getPixelRatio(),o=e*r/i.width*2-1,r=2*-(t*r/i.height)+1,i=new THREE.Raycaster;n.camera.setCastRay(i,o,r);i=i.intersectObjects(n.selectionManager.getTargetList());0<i.length&&(this.lastSprite=i[0].point,this.viewer.getCommentsManager().renderComments(),n=this.viewer.canvas2D.getContext("2d"),i=this.get2dPoint(i[0].point.clone()),n.beginPath(),n.arc(i.x,i.y,4,0,2*Math.PI),n.fillStyle="red",n.fill(),this.addCommentDlg.show(!0,e,t))},Ct.prototype.FindParentElement=function(e){return null==e?null:e instanceof THREE.Object3D&&("RevitElement"===e.type||"Element"===e.type)?e:this.FindParentElement(e.parent)},Ct.prototype.pan=function(e){ce.prototype.pan.call(this,e),this.reCalculatePos()},Ct.prototype.zoom=function(e,t){ce.prototype.zoom.call(this,e,t),this.reCalculatePos()},Ct.prototype.rotate=function(e){this.viewer.is2DViewer||(ce.prototype.rotate.call(this,e),this.reCalculatePos())},Ct.prototype.get2dPoint=function(e){e.project(this.viewer.camera);var t=this.viewer.renderer.domElement.width/2,n=this.viewer.renderer.domElement.height/2;return{x:Math.round(e.x*t+t),y:Math.round(-e.y*n+n)}},Ct.prototype.reCalculatePos=function(){this.viewer.getCommentsManager().renderComments();var e,t=this.viewer.canvas2D.getContext("2d");t.clearRect(0,0,window.innerWidth,window.innerHeight),t.fillStyle="red",this.lastSprite&&(e=this.get2dPoint(this.lastSprite.clone()),t.beginPath(),t.arc(e.x,e.y,4,0,2*Math.PI),t.fill())};var Bt=function(e){ce.call(this,e),this.type="OpAnnotation",this.interpPts=[],this.annotationUUID=null};Bt.prototype=Object.create(ce.prototype),Bt.prototype.onLMouseDown=function(e){ce.prototype.onLMouseDown.call(this,e),this.onAnnotationStart()},Bt.prototype.onLMouseMove=function(e){"pt"==this.viewer.getAnnotationMode()?ce.prototype.onLMouseMove.call(this,e):this.onAnnotationMove()},Bt.prototype.onLMouseUp=function(e){ce.prototype.onLMouseUp.call(this,e),this.onAnnotationEnd()},Bt.prototype.onTouchSingleStart=function(e){ce.prototype.onTouchSingleStart.call(this,e),this.onAnnotationStart()},Bt.prototype.onTouchSingleMove=function(e){"pt"==this.viewer.getAnnotationMode()?ce.prototype.onTouchSingleMove.call(this,e):this.onAnnotationMove()},Bt.prototype.onTouchSingleEnd=function(e){ce.prototype.onTouchSingleEnd.call(this,e),this.onAnnotationEnd()},Bt.prototype.onAnnotationStart=function(e){this.interpPts=[],this.annotationUUID=THREE.Math.generateUUID(),this.interpPts.push(new THREE.Vector3(this.pointer.x,this.pointer.y,0)),Bt.prototype.onLMouseDbClick=function(e){ce.prototype.onLMouseDbClick.call(this,e)}},Bt.prototype.onAnnotationMove=function(e){if(0<this.interpPts.length&&((!this.viewer.animationsManager||this.viewer.animationsManager.isAnimationsExited())&&"pt"!=this.viewer.getAnnotationMode())){var t=this.viewer.renderer.getPixelRatio(),n=this.viewer.renderer.domElement.width/(t*Ue.lineSegAnnotationGridCount),i=this.viewer.renderer.domElement.height/(t*Ue.lineSegAnnotationGridCount);if(n*n+i*i<this.pointer.distanceToSquared(this.interpPts[this.interpPts.length-1])&&this.interpPts.push(new THREE.Vector3(this.pointer.x,this.pointer.y,0)),1<this.interpPts.length){var r=new THREE.Matrix4;r.multiplyMatrices(this.viewer.camera.matrixWorld,r.getInverse(this.viewer.camera.projectionMatrix));for(var o=this.viewer.renderer.domElement,a=[],s=new THREE.Vector3,l=0;l<this.interpPts.length;++l)s.set(this.interpPts[l].x*t/o.width*2-1,2*-(this.interpPts[l].y*t/o.height)+1,.5),s.applyMatrix4(r),a.push(s.x),a.push(s.y),a.push(s.z);this.viewer.showAnnotation({version:"2",type:"lineSeg",coords:a,uuid:this.annotationUUID,cameraInfo:this.viewer.getCameraInfo()},!1)}}},Bt.prototype.onAnnotationEnd=function(e){this.onAnnotationDone()},Bt.prototype.onAnnotationDone=function(){var e=this.viewer;if(!e.isSmoothTranslationDone())return this.interpPts=[],void(this.annotationUUID=null);var t=!1;if(this.viewer.animationsManager&&!this.viewer.animationsManager.isAnimationsExited()&&(t=!0),"pt"!=e.getAnnotationMode()||1!=this.interpPts.length||!(3<Math.abs(this.pointer.x-this.interpPts[0].x)||3<Math.abs(this.pointer.y-this.interpPts[0].y))){var n=e.renderer.domElement,i=e.renderer.getPixelRatio();if(0<this.interpPts.length){e.annotationsManager||(e.annotationsManager=new je(e));var r=e.annotationsManager.getRenderTarget(),o=this.viewer.scene.overrideMaterial,a=this.viewer.renderer.getClearColor().clone(),s=this.viewer.renderer.getClearAlpha();e.ndsModel||(e.scene.overrideMaterial=e.annotationsManager.getDepthRGBAMaterial(),e.renderer.setClearColor(16777215),e.scene.remove(e.lightControls._scene),e.renderer.render(e.scene,e.camera,r,!0),e.scene.add(e.lightControls._scene),e.scene.overrideMaterial=o);var l=new THREE.Matrix4;l.multiplyMatrices(e.camera.matrixWorld,l.getInverse(e.camera.projectionMatrix));if(1==this.interpPts.length){var d,c,h,u=[],f="",p=null;e.ndsModel?(O=[this.interpPts[0].x,this.interpPts[0].y,this.interpPts[0].z],(R=e.getIntersectionPtByScreenPt(O))&&(u=R.coords,f=R.locationObjectUUID,(p=R.locationObject)&&p.id&&0<=p.id&&(d=e.ndsModel.getBodyTranslate(p),u[0]-=d[0],u[1]-=d[1],u[2]-=d[2]))):((I=new Uint8Array(4))[0]=I[1]=I[2]=I[3]=0,e.renderer.readRenderTargetPixels(r,this.interpPts[0].x*i,r.height-this.interpPts[0].y*i,1,1,I),c=10,h=[],e.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.materialAnnotationRecord=e.material,e instanceof THREE.Line||e instanceof THREE.LineSegments?e.material=new THREE.LineBasicMaterial:(e.material=new THREE.MeshBasicMaterial,e.material.side=THREE.DoubleSide),e.material.color.setHex(c),h[c]=e,c+=10)}),e.scene.overrideMaterial=null,e.renderer.render(e.scene,e.camera,r,!0),e.scene.overrideMaterial=o,e.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.material=e.materialAnnotationRecord,e.materialAnnotationRecord=void 0)}),(v=new Uint8Array(4))[0]=v[1]=v[2]=v[3]=0,e.renderer.readRenderTargetPixels(r,this.interpPts[0].x*i,r.height-this.interpPts[0].y*i,1,1,v),e.renderer.setRenderTarget(null),e.renderer.setClearColor(a,s),253<v[0]&&253<v[1]&&253<v[2]||(m=v[0]<<16|v[1]<<8|v[2],h[m]&&(p=h[m],f=h[m].uuid)),253<I[0]&&253<I[1]&&253<I[2]&&253<I[3]||(T=I[0]*(S=255/256)/16777216+I[1]*S/65536+I[2]*S/256+I[3]*S,T=2*(T/=255)-1,this.interpPts[0].set(this.interpPts[0].x*i/n.width*2-1,2*-(this.interpPts[0].y*i/n.height)+1,T-=4e-8*T),this.interpPts[0].applyMatrix4(l),""!=f&&p&&((g=new THREE.Matrix4).getInverse(p.matrixWorld),this.interpPts[0].applyMatrix4(g)),u.push(this.interpPts[0].x),u.push(this.interpPts[0].y),u.push(this.interpPts[0].z)));var m,g,v=e.getCameraInfo();e.ndsModel||((m=new THREE.Matrix4).getInverse(e.modelRootObject.matrixWorld),(g=new THREE.Vector3).set(v.position.x,v.position.y,v.position.z),g.applyMatrix4(m),v.position.x=g.x,v.position.y=g.y,v.position.z=g.z,g.set(v.target.x,v.target.y,v.target.z),g.applyMatrix4(m),v.target.x=g.x,v.target.y=g.y,v.target.z=g.z,g.set(v.up.x,v.up.y,v.up.z),g.transformDirection(m),v.up.x=g.x,v.up.y=g.y,v.up.z=g.z),0<u.length&&""!=f&&p&&(Bt.prototype.onLMouseDbClick=function(e){},A=e.getLineSegAnnotationStyle(),t?e.dispatchEvent({type:"annotationEventForAnimation",userData:{version:"4",type:"pt",ownerType:"animation",ownerUuid:e.animationsManager.getCurrentAnimationUuid(),timeStart:e.animationsManager.getCurrentAnimationTime(),timeEnd:e.animationsManager.getCurrentAnimationDuration(),coords:u,uuid:this.annotationUUID,strokeStyle:A.strokeStyle,locationObjectUUID:f,cameraInfo:v}}):e.dispatchEvent({type:"annotationEvent",userData:{version:"4",type:"pt",coords:u,uuid:this.annotationUUID,strokeStyle:A.strokeStyle,locationObjectUUID:f,cameraInfo:v}}))}else{var u=[],y=new THREE.Vector3;e.controls.getBoundingBox().center(y),y.project(e.camera);var E=y.z;E<-1&&(E=-.99);for(var b=0;b<this.interpPts.length;++b)y.set(this.interpPts[b].x*i/n.width*2-1,2*-(this.interpPts[b].y*i/n.height)+1,E),y.applyMatrix4(l),u.push(y.x),u.push(y.y),u.push(y.z);for(var M=0,x=0,w=0,b=0;b<u.length/3;++b)M+=u[3*b],x+=u[3*b+1],w+=u[3*b+2];M/=u.length/3,x/=u.length/3,w/=u.length/3;t=new THREE.Vector3(M,x,w),f=new THREE.Matrix4;f.multiplyMatrices(e.camera.projectionMatrix,e.camera.matrixWorldInverse),t.applyMatrix4(f);var I,S,T,A,v=e.renderer.domElement.width/2,f=e.renderer.domElement.height/2;if(t.x=Math.round(t.x*v+v),t.y=Math.round(-t.y*f+f),e.ndsModel){for(var R,O=[0,0,0],P=0;P<this.interpPts.length;++P)O[0]+=this.interpPts[P].x,O[1]+=this.interpPts[P].y;O[0]/=this.interpPts.length,O[1]/=this.interpPts.length,(R=e.getIntersectionPtByScreenPt(O))&&(M=R.coords[0],x=R.coords[1],w=R.coords[2])}else(I=new Uint8Array(4))[0]=I[1]=I[2]=I[3]=0,e.renderer.readRenderTargetPixels(r,t.x,r.height-t.y,1,1,I),e.renderer.setRenderTarget(null),e.renderer.setClearColor(a,s),253<I[0]&&253<I[1]&&253<I[2]&&253<I[3]||(T=I[0]*(S=255/256)/16777216+I[1]*S/65536+I[2]*S/256+I[3]*S,T=2*(T/=255)-1,t.set(t.x/n.width*2-1,2*-(t.y/n.height)+1,T-=4e-8*T),t.applyMatrix4(l),M=t.x,x=t.y,w=t.z);u.push(M),u.push(x),u.push(w),0<u.length&&(A=e.getLineSegAnnotationStyle(),e.dispatchEvent({type:"annotationEvent",userData:{version:"2",type:"lineSeg",coords:u,uuid:this.annotationUUID,lineWidth:A.lineWidth,strokeStyle:A.strokeStyle,cameraInfo:e.getCameraInfo()}}))}this.interpPts=[],this.annotationUUID=null}}};function Lt(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var a,e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),n={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(a in this.activePlane=n.XYZE,n.YZ.rotation.set(0,Math.PI/2,0),n.XZ.rotation.set(-Math.PI/2,0,0),n)n[a].name=a,this.planes.add(n[a]),this.planes[a]=n[a];t=function(e,t){for(var n in e)for(a=e[n].length;a--;){var i=e[n][a][0],r=e[n][a][1],o=e[n][a][2];i.name=n,r&&i.position.set(r[0],r[1],r[2]),o&&i.rotation.set(o[0],o[1],o[2]),t.add(i)}};t(this.handleGizmos,this.handles),t(this.pickerGizmos,this.pickers),this.traverse(function(e){var t;e instanceof THREE.Mesh&&(e.updateMatrix(),(t=e.geometry.clone()).applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1))})},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})}}var Dt=new y({visible:!1,transparent:!1});((Lt.prototype=Object.create(THREE.Object3D.prototype)).constructor=Lt).prototype.update=function(t,n){var i=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,1,0),o=new THREE.Matrix4;this.traverse(function(e){-1!==e.name.search("E")?e.quaternion.setFromRotationMatrix(o.lookAt(n,i,r)):-1===e.name.search("X")&&-1===e.name.search("Y")&&-1===e.name.search("Z")||e.quaternion.setFromEuler(t)})};function Ht(e){Lt.call(this);var t=!0,n=!0,i=!0;e&&(t=0<=e.indexOf("translateX"),n=0<=e.indexOf("translateY"),i=0<=e.indexOf("translateZ"));var r=new THREE.Geometry,o=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.1,12,1,!1));o.position.y=.5,o.updateMatrix(),r.merge(o.geometry,o.matrix);var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,.7,0,0],3)),(e=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,.7,0],3)),(o=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,.7],3)),this.handleGizmos={},t&&(this.handleGizmos.X=[[new THREE.Mesh(r,new y({color:16711680})),[.2,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new E({color:16711680}))]]),n&&(this.handleGizmos.Y=[[new THREE.Mesh(r,new y({color:65280})),[0,.2,0]],[new THREE.Line(e,new E({color:65280}))]]),i&&(this.handleGizmos.Z=[[new THREE.Mesh(r,new y({color:255})),[0,0,.2],[Math.PI/2,0,0]],[new THREE.Line(o,new E({color:255}))]]),t&&n&&i&&(this.handleGizmos.XY=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:16776960,opacity:.25})),[.15,.15,0]]],this.handleGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],this.handleGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new y({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]),this.pickerGizmos={},t&&(this.pickerGizmos.X=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[.6,0,0],[0,0,-Math.PI/2]]]),n&&(this.pickerGizmos.Y=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[0,.6,0]]]),i&&(this.pickerGizmos.Z=[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[0,0,.6],[Math.PI/2,0,0]]]),t&&n&&i&&(this.pickerGizmos.XYZ=[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),Dt)]],this.pickerGizmos.XY=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),Dt),[.2,.2,0]]],this.pickerGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),Dt),[0,.2,.2],[0,Math.PI/2,0]]],this.pickerGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),Dt),[.2,0,.2],[-Math.PI/2,0,0]]]),this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()}(Ht.prototype=Object.create(Lt.prototype)).constructor=Ht;function Nt(){function e(e,t,n){var i=new THREE.BufferGeometry,r=[];n=n||1;for(var o=0;o<=64*n;++o)"x"===t&&r.push(0,Math.cos(o/32*Math.PI)*e,Math.sin(o/32*Math.PI)*e),"y"===t&&r.push(Math.cos(o/32*Math.PI)*e,0,Math.sin(o/32*Math.PI)*e),"z"===t&&r.push(Math.sin(o/32*Math.PI)*e,Math.cos(o/32*Math.PI)*e,0);return i.addAttribute("position",new THREE.Float32BufferAttribute(r,3)),i}Lt.call(this),this.handleGizmos={X:[[new THREE.Line(new e(.5,"x",.5),new E({color:16711680}))]],Y:[[new THREE.Line(new e(.5,"y",.5),new E({color:65280}))]],Z:[[new THREE.Line(new e(.5,"z",.5),new E({color:255}))]],XYZE:[[new THREE.Line(new e(.5,"z",1),new E({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.5,.12,4,12,Math.PI),Dt),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.5,.12,4,12,Math.PI),Dt),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(.5,.12,4,12,Math.PI),Dt),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){Lt.prototype.update.apply(this,arguments);this.handles,this.pickers;var n=new THREE.Matrix4,i=new THREE.Euler(0,0,1),r=new THREE.Quaternion,o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,d=new THREE.Quaternion,c=new THREE.Quaternion,h=t.clone();i.copy(this.planes.XY.rotation),r.setFromEuler(i),n.makeRotationFromQuaternion(r).getInverse(n),h.applyMatrix4(n),this.traverse(function(e){r.setFromEuler(i),"X"===e.name&&(l.setFromAxisAngle(o,Math.atan2(-h.y,h.z)),r.multiplyQuaternions(r,l),e.quaternion.copy(r)),"Y"===e.name&&(d.setFromAxisAngle(a,Math.atan2(h.x,h.z)),r.multiplyQuaternions(r,d),e.quaternion.copy(r)),"Z"===e.name&&(c.setFromAxisAngle(s,Math.atan2(h.y,h.x)),r.multiplyQuaternions(r,c),e.quaternion.copy(r))})},this.init()}(Nt.prototype=Object.create(Lt.prototype)).constructor=Nt;function Ft(){var n=this;THREE.Object3D.call(this),this._gizmoTranslate=new Ht,this._gizmoRotate=new Nt,this.add(this._gizmoTranslate),this.add(this._gizmoRotate),this._translatePickers=this._gizmoTranslate.pickers,this._rotatePickers=this._gizmoRotate.pickers,this.activePlane=this._gizmoTranslate.activePlane,this.highlight=function(e,t){"translate"==t?(this._gizmoRotate.highlight(null),this._gizmoTranslate.highlight(e)):"rotate"==t&&(this._gizmoTranslate.highlight(null),this._gizmoRotate.highlight(e))},this.setActivePlane=function(e,t){"translate"==n.pickType?(this._gizmoTranslate.setActivePlane(e,t),this.activePlane=this._gizmoTranslate.activePlane):"rotate"==n.pickType&&(this._gizmoRotate.setActivePlane(e,t),this.activePlane=this._gizmoRotate.activePlane)},this.update=function(e,t){this._gizmoTranslate.update(e,t),this._gizmoRotate.update(e,t)}}(Ft.prototype=Object.create(THREE.Object3D.prototype)).constructor=Ft;function _t(){Lt.call(this);var e=new THREE.Geometry,t=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));t.position.y=.5,t.updateMatrix(),e.merge(t.geometry,t.matrix);var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),(t=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(e,new y({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(n,new E({color:16711680}))]],Y:[[new THREE.Mesh(e,new y({color:65280})),[0,.5,0]],[new THREE.Line(i,new E({color:65280}))]],Z:[[new THREE.Mesh(e,new y({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(t,new E({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new y({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),Dt),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),Dt)]]},this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()}(_t.prototype=Object.create(Lt.prototype)).constructor=_t;function kt(o,a,e,t,n){THREE.Object3D.call(this),a=void 0!==a?a:document,this.object=void 0,this.viewer=e,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=.5,this.axis=null,this.pickType=null,this.newPosition=new THREE.Vector3,this.textBox=null,this.down=!1,this.opBall=t;var i,s=this,l="translate",d=!1,c={translate:new Ht(n),rotate:new Nt,both:new Ft,scale:new _t};for(i in c){var r=c[i];r.visible=i===l,this.add(r)}var h={type:"change"},u={type:"mouseDown"},f={type:"mouseUp",mode:l},p=document.createEvent("HTMLEvents");p.initEvent("mousemove",!0,!0);var m={type:"objectChange"},g=new THREE.Raycaster,v=new THREE.Vector2,y=new THREE.Vector3,E=new THREE.Vector3,b=new THREE.Vector3,M=0,x=0,w=new THREE.Vector3,I=new THREE.Vector3,S=1,T=new THREE.Matrix4,A=new THREE.Vector3,R=new THREE.Matrix4,O=new THREE.Vector3,P=new THREE.Quaternion,C=new THREE.Vector3(1,0,0),B=new THREE.Vector3(0,1,0),L=new THREE.Vector3(0,0,1),D=new THREE.Quaternion,H=new THREE.Quaternion,N=new THREE.Quaternion,F=new THREE.Quaternion,_=new THREE.Quaternion,k=new THREE.Quaternion,V=new THREE.Vector3,j=new THREE.Vector3,U=new THREE.Vector3,z=new THREE.Matrix4,G=new THREE.Matrix4,W=new THREE.Vector3,Y=new THREE.Vector3,X=new THREE.Euler,Z=new THREE.Matrix4,q=new THREE.Vector3,Q=new THREE.Euler;function J(e){var t,n;Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===s.object||!0===d||void 0!==e.button&&0!==e.button||s.down||(n=e.changedTouches?e.changedTouches[0]:e,t=null,"both"!=l?t=re(n,c[l].pickers.children):(t=re(n,c[l]._rotatePickers.children))?s.pickType="rotate":(t=re(n,c[l]._translatePickers.children))&&(s.pickType="translate"),n=null,t&&(n=t.object.name,e.preventDefault()),s.axis!==n&&(s.axis=n,s.update(),s.dispatchEvent(h)))}function K(e){"Enter"==e.key&&(e=parseFloat(s.textBox.value),"translate"===l||"translate"==s.pickType?(y.copy(E),y.x+=e,y.y+=e,y.z+=e,te()):"rotate"!==l&&"rotate"!=s.pickType||(e=e*Math.PI/180,D.setFromRotationMatrix(z),"X"===s.axis?(H.setFromAxisAngle(C,e),D.multiplyQuaternions(D,H),k.copy(H)):"Y"===s.axis?(N.setFromAxisAngle(B,e),D.multiplyQuaternions(D,N),k.copy(N)):"Z"===s.axis&&(F.setFromAxisAngle(L,e),D.multiplyQuaternions(D,F),k.copy(F)),s.object.quaternion.copy(D)),s.opBall.onOpBall())}function $(e){s.textBox.value=s.textBox.value.replace(/[^\d.-]/g,"")}function ee(e){var t,n,i,r,o;Ue.enableBroadcast&&!Ue.broadcastMajor||(t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==this&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),void 0===s.object||!0===d||void 0!==e.button&&0!==e.button||(0!==(o=e.changedTouches?e.changedTouches[0]:e).button&&void 0!==o.button||(i=null,"both"!=l?i=re(o,c[l].pickers.children):(i=re(o,c[l]._rotatePickers.children))?s.pickType="rotate":(i=re(o,c[l]._translatePickers.children))&&(s.pickType="translate"),i?(s.textBox||(s.textBox=document.createElement("input"),s.textBox.style.position="fixed",s.textBox.style.color="white",s.textBox.style.backgroundColor="rgba(115,0,230,0.75)",s.textBox.style.zIndex=3,s.textBox.style.paddingLeft="3px",s.textBox.onkeypress=K,s.textBox.oninput=$,s.textBox.onmouseup=ie,s.textBox.onmousemove=function(e){p.clientX=e.clientX,p.clientY=e.clientY,a.dispatchEvent(p)},s.textBox.style.width="80px",document.body.appendChild(s.textBox)),r=s.viewer.renderer.getPixelRatio(),s.textBox.value="",s.textBox.style.left=Math.round((t+20)/r)+"px",s.textBox.style.top=Math.round((n+20)/r)+"px",e.preventDefault(),e.stopPropagation(),s.dispatchEvent(u),s.axis=i.object.name,s.down=!0,s.update(),A.copy(q).sub(Y).normalize(),c[l].setActivePlane(s.axis,A),(o=re(o,[c[l].activePlane]))&&(V.copy(s.object.position),j.copy(s.object.position),U.copy(s.object.scale),z.extractRotation(s.object.matrix),Z.extractRotation(s.object.matrixWorld),s.object.parent&&(G.extractRotation(s.object.parent.matrixWorld),W.setFromMatrixScale(R.getInverse(s.object.parent.matrixWorld))),E.copy(o.point))):(s.removeTextBox(),s.axis=null,s.update(),s.down=!1,s.pickType="default",s.dispatchEvent(h))),d=!0))}function te(){"translate"===l||"translate"==s.pickType?(y.sub(E),y.multiply(W),"local"===s.space&&(y.applyMatrix4(R.getInverse(Z)),-1===s.axis.search("X")&&(y.x=0),-1===s.axis.search("Y")&&(y.y=0),-1===s.axis.search("Z")&&(y.z=0),y.applyMatrix4(z),s.object.position.copy(V),s.object.position.add(y),(b=s.object.position.clone()).sub(j),s.newPosition=s.object.position.clone(),j.copy(s.newPosition)),"world"!==s.space&&-1===s.axis.search("XYZ")||(-1===s.axis.search("X")&&(y.x=0),-1===s.axis.search("Y")&&(y.y=0),-1===s.axis.search("Z")&&(y.z=0),y.applyMatrix4(R.getInverse(G)),s.object.position.copy(V),s.object.position.add(y)),null!==s.translationSnap&&("local"===s.space&&s.object.position.applyMatrix4(R.getInverse(Z)),-1!==s.axis.search("X")&&(s.object.position.x=Math.round(s.object.position.x/s.translationSnap)*s.translationSnap),-1!==s.axis.search("Y")&&(s.object.position.y=Math.round(s.object.position.y/s.translationSnap)*s.translationSnap),-1!==s.axis.search("Z")&&(s.object.position.z=Math.round(s.object.position.z/s.translationSnap)*s.translationSnap),"local"===s.space&&s.object.position.applyMatrix4(Z))):"scale"===l?(y.sub(E),y.multiply(W),"local"===s.space&&("XYZ"===s.axis?(S=1+y.y/Math.max(U.x,U.y,U.z),s.object.scale.x=U.x*S,s.object.scale.y=U.y*S,s.object.scale.z=U.z*S):(y.applyMatrix4(R.getInverse(Z)),"X"===s.axis&&(s.object.scale.x=U.x*(1+y.x/U.x)),"Y"===s.axis&&(s.object.scale.y=U.y*(1+y.y/U.y)),"Z"===s.axis&&(s.object.scale.z=U.z*(1+y.z/U.z))))):"rotate"!==l&&"rotate"!=s.pickType||(y.sub(Y),y.multiply(W),O.copy(E).sub(Y),O.multiply(W),"E"===s.axis?(y.applyMatrix4(R.getInverse(T)),O.applyMatrix4(R.getInverse(T)),w.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),I.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),P.setFromRotationMatrix(R.getInverse(G)),_.setFromAxisAngle(A,w.z-I.z),D.setFromRotationMatrix(Z),P.multiplyQuaternions(P,_),P.multiplyQuaternions(P,D),s.object.quaternion.copy(P)):"XYZE"===s.axis?(_.setFromEuler(y.clone().cross(O).normalize()),P.setFromRotationMatrix(R.getInverse(G)),H.setFromAxisAngle(_,-y.clone().angleTo(O)),D.setFromRotationMatrix(Z),P.multiplyQuaternions(P,H),P.multiplyQuaternions(P,D),s.object.quaternion.copy(P)):"local"===s.space?(y.applyMatrix4(R.getInverse(Z)),O.applyMatrix4(R.getInverse(Z)),w.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),I.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),D.setFromRotationMatrix(z),null!==s.rotationSnap?(H.setFromAxisAngle(C,Math.round((w.x-I.x)/s.rotationSnap)*s.rotationSnap),N.setFromAxisAngle(B,Math.round((w.y-I.y)/s.rotationSnap)*s.rotationSnap),F.setFromAxisAngle(L,Math.round((w.z-I.z)/s.rotationSnap)*s.rotationSnap)):(H.setFromAxisAngle(C,w.x-I.x),N.setFromAxisAngle(B,w.y-I.y),F.setFromAxisAngle(L,w.z-I.z)),"X"===s.axis&&D.multiplyQuaternions(D,H),"Y"===s.axis&&D.multiplyQuaternions(D,N),"Z"===s.axis&&D.multiplyQuaternions(D,F),s.object.quaternion.copy(D)):"world"===s.space&&(w.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),I.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),P.setFromRotationMatrix(R.getInverse(G)),null!==s.rotationSnap?(H.setFromAxisAngle(C,Math.round((w.x-I.x)/s.rotationSnap)*s.rotationSnap),N.setFromAxisAngle(B,Math.round((w.y-I.y)/s.rotationSnap)*s.rotationSnap),F.setFromAxisAngle(L,Math.round((w.z-I.z)/s.rotationSnap)*s.rotationSnap)):(H.setFromAxisAngle(C,w.x-I.x),N.setFromAxisAngle(B,w.y-I.y),F.setFromAxisAngle(L,w.z-I.z)),D.setFromRotationMatrix(Z),"X"===s.axis&&P.multiplyQuaternions(P,H),"Y"===s.axis&&P.multiplyQuaternions(P,N),"Z"===s.axis&&P.multiplyQuaternions(P,F),P.multiplyQuaternions(P,D),s.object.quaternion.copy(P))),s.update(),s.dispatchEvent(h),s.dispatchEvent(m)}function ne(e){var t;Ue.enableBroadcast&&!Ue.broadcastMajor||void 0===s.object||null===s.axis||!1===d||void 0!==e.button&&0!==e.button||!1!==(t=re(e.changedTouches?e.changedTouches[0]:e,[c[l].activePlane]))&&(e.preventDefault(),e.stopPropagation(),y.copy(t.point),te())}function ie(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(e.preventDefault(),void 0!==e.button&&0!==e.button||(d&&null!==s.axis&&(f.mode=l,s.dispatchEvent(f)),d=!1,"TouchEvent"in window&&e instanceof TouchEvent?(s.axis=null,s.update(),s.dispatchEvent(h)):J(e)))}function re(e,t){var n=a.getBoundingClientRect(),i=n.width,r=n.height;null!=a.clientWidth&&null!=a.clientHeight&&(10<Math.abs(i-a.clientWidth)&&(i=a.clientWidth),10<Math.abs(r-a.clientHeight)&&(r=a.clientHeight));i=(e.clientX-n.left)/i,r=(e.clientY-n.top)/r;v.set(2*i-1,-2*r+1),o.setCastRay(g,v.x,v.y);t=g.intersectObjects(t,!0);return t[0]||!1}ye.isMobileDevice()?(a.addEventListener("touchstart",ee,!1),a.addEventListener("touchmove",J,!1),a.addEventListener("touchmove",ne,!0),a.addEventListener("touchend",ie,!1),a.addEventListener("touchcancel",ie,!1)):(a.addEventListener("mousedown",ee,!1),a.addEventListener("mousemove",J,!1),a.addEventListener("mousemove",ne,!0),a.addEventListener("mouseup",ie,!1)),this.getOffset=function(){return b},this.getRotate=function(){return D},this.getRotateOffset=function(){return k},this.isDragging=function(){return d},this.isSelected=function(){return null!=s.axis},this.setOldPosition=function(e){e&&V.copy(e)},this.getOldPosition=function(){return V},this.dispose=function(){ye.isMobileDevice()?(a.removeEventListener("touchstart",ee),a.removeEventListener("touchmove",J),a.removeEventListener("touchmove",ne),a.removeEventListener("touchend",ie),a.removeEventListener("touchcancel",ie),a.removeEventListener("touchleave",ie)):(a.removeEventListener("mousedown",ee),a.removeEventListener("mousemove",J),a.removeEventListener("mousemove",ne),a.removeEventListener("mouseup",ie),a.removeEventListener("mouseout",ie))},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return l},this.setMode=function(e){for(var t in"scale"===(l=e||l)&&(s.space="local"),c)c[t].visible=t===l;this.update(),s.dispatchEvent(h)},this.setTranslationSnap=function(e){s.translationSnap=e},this.setRotationSnap=function(e){s.rotationSnap=e},this.setSize=function(e){s.size=e,this.update(),s.dispatchEvent(h)},this.setSpace=function(e){s.space=e,this.update(),s.dispatchEvent(h)},this.removeTextBox=function(){this.textBox&&(document.body.removeChild(this.textBox),this.textBox=null)},this.SetTextValue=function(){var e,t;"translate"===l||"translate"==s.pickType?-1!=s.axis.search("X")?this.textBox.value=(this.newPosition.x-V.x).toFixed(4):-1!=s.axis.search("Y")?this.textBox.value=(this.newPosition.y-V.y).toFixed(4):-1!=s.axis.search("Z")&&(this.textBox.value=(this.newPosition.z-V.z).toFixed(4)):"rotate"!==l&&"rotate"!=s.pickType||(e=new THREE.Euler,t=0,-1!=s.axis.search("X")?(t=180*e.setFromQuaternion(H).x/Math.PI,this.textBox.value=t.toFixed(1),x=t-M,M=t,k.setFromAxisAngle(C,x*Math.PI/180)):-1!=s.axis.search("Y")?(e.setFromQuaternion(N),t=180*e.y/Math.PI,Math.abs(Math.abs(e.x)-Math.PI)<1e-5&&(t=(180-Math.abs(t))*t/Math.abs(t)),this.textBox.value=t.toFixed(1),x=t-M,M=t,k.setFromAxisAngle(B,x*Math.PI/180)):-1!=s.axis.search("Z")&&(t=180*e.setFromQuaternion(F).z/Math.PI,this.textBox.value=t.toFixed(1),x=t-M,M=t,k.setFromAxisAngle(L,x*Math.PI/180)))},this.update=function(){void 0!==s.object&&(s.object.updateMatrixWorld(),Y.setFromMatrixPosition(s.object.matrixWorld),X.setFromRotationMatrix(R.extractRotation(s.object.matrixWorld)),o.updateMatrixWorld(),q.setFromMatrixPosition(o.matrixWorld),Q.setFromRotationMatrix(R.extractRotation(o.matrixWorld)),S=Y.distanceTo(q)/6*s.size,this.position.copy(Y),this.scale.set(S,S,S),A.copy(q).sub(Y).normalize(),"local"===s.space?c[l].update(X,A):"world"===s.space&&c[l].update(new THREE.Euler,A),c[l].highlight(s.axis,s.pickType))}}(kt.prototype=Object.create(THREE.Object3D.prototype)).constructor=kt;function Vt(e){ce.call(this,e),this.type="OpBall",this.opMode="move",this.translateScene=null,this.clipTransRotControl=null,this.domElement=null,this.WorldPosition=null,this.IntersectModel=null,e.canvas2D?this.domElement=e.canvas2D:this.domElement=e.canvas3D}(Vt.prototype=Object.create(ce.prototype)).onLMouseDown=function(e){this.state=NDS.MOUSE.LEFT},Vt.prototype.onLMouseDbClick=function(e){this.viewer.zoomExtents(),this.updateRotateCenterHelper()},Vt.prototype.setMoveMode=function(){this.opMode="move"},Vt.prototype.setRestoreMode=function(){this.opMode="restore"},Vt.prototype.setDefaultMode=function(){this.opMode="default"},Vt.prototype.isModelMoved=function(){if(this.viewer.ndsModel)return this.viewer.ndsModel.hasDraggedBodies();var t=!1;return this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&null!=e.matrixWorldTransOrginalDrag&&(t=!0)}),t},Vt.prototype.hideSelectedModel=function(){this.viewer.hideSelectedObjects()},Vt.prototype.showAllModel=function(){this.viewer.showObject(this.viewer.scene,!0),this.render()},Vt.prototype.reverseVisibleAndHidingModel=function(){this.viewer.showObjectReversed(this.viewer.scene),this.render()},Vt.prototype.create=function(){this.viewer.selectionManager.setSelectType("body"),ce.prototype.create.call(this)},Vt.prototype.release=function(){this.update(),this.render(),this.clipTransRotControl&&this.clipTransRotControl.dispose(),ce.prototype.release.call(this)},Vt.prototype.update=function(){this.viewer.selectionManager.clearSelection(),ce.prototype.update.call(this)},Vt.prototype.onLMouseClick=function(e){e.preventDefault(),e.stopPropagation();this.viewer.renderer.domElement;var t,n=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(n=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(n=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),Math.abs(n-this.lMouseDown.x)<1&&Math.abs(i-this.lMouseDown.y)<1&&("move"==this.opMode||"default"==this.opMode?(this.viewer.selectionManager.selectByClick(n,i,!1),t=this.viewer.selectionManager.getSelectedObjects(),(this.IntersectModel||t&&0!==t.length)&&(this.IntersectModel&&0===t.length?this.viewer.selectionManager.selectObject(this.IntersectModel):this.IntersectModel=t[0],(e=this.viewer.getIntersectionPtByScreenPt([n,i],this.IntersectModel))&&(this.WorldPosition=new THREE.Vector3(e.coords[0],e.coords[1],e.coords[2]),t=new THREE.Object3D,e=new THREE.PlaneBufferGeometry(400,400,1,1),(e=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,opacity:.3}))).material.color.setRGB(.8,.4,.298),e.material.transparent=!0,t.add(e),t.position.copy(this.WorldPosition),t.visible=!1,this.translateScene?(this.translateScene.remove(this.translateScene.children[0]),this.translateScene.remove(this.translateScene.children[0])):this.translateScene=new THREE.Scene,this.clipTransRotControl&&this.clipTransRotControl.removeTextBox(),this.clipTransRotControl=new kt(this.viewer.camera,this.domElement,this.viewer,this),this.clipTransRotControl.position.copy(this.WorldPosition),this.translateScene.add(this.clipTransRotControl),this.clipTransRotControl.setSize(.7),this.clipTransRotControl.setMode("both"),this.clipTransRotControl.setSpace("local"),this.clipTransRotControl.attach(t),this.translateScene.add(t),this.viewer.controls.getOperator()&&this.viewer.controls.getOperator().resetEventListener(),this.viewer.renderer.render(this.translateScene,this.viewer.camera),this.render()))):"restore"==this.opMode&&this.onOpRestore(n,i))},Vt.prototype.renderModel=function(e,t){this.translateScene&&(this.clipTransRotControl.update(),this.clipTransRotControl.updateMatrixWorld(),this.viewer.renderer.render(this.translateScene,this.viewer.camera))},Vt.prototype.onOpBall=function(){var e=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes(),t=this.clipTransRotControl.getOffset(),n=this.clipTransRotControl.getRotateOffset(),i=t.clone();if(null==this.viewer.draggedObjects&&(this.viewer.draggedObjects=new Array),"translate"==this.clipTransRotControl.pickType){if(this.viewer.ndsModel)for(var r=0;r<e.length;++r){var o=e[r],a=new THREE.Matrix4,s=(new THREE.Matrix4).makeTranslation(i.x,i.y,i.z);o.matrix?a.fromArray(o.matrix).premultiply(s):a.copy(s),this.viewer.ndsModel.updateNodeMatrix(o.uuid,a.toArray(),s),this.render(),this.entityIsTransformed=!0}else for(r=0;r<e.length;++r){void 0===(u=e[r].key).matrixWorldTransOrginal&&(u.matrixWorldTransOrginal=new THREE.Vector3,u.matrixWorldTransOrginal.setFromMatrixPosition(u.matrixWorld));var l=new THREE.Vector3;l.setFromMatrixPosition(u.matrixWorld),l.add(i),u.matrixWorld.setPosition(l),u.matrixWorldTransExplode?l.sub(u.matrixWorldTransExplode):l.sub(u.matrixWorldTransOrginal),void 0===u.matrixWorldTransOrginalDrag&&(u.matrixWorldTransOrginalDrag=new THREE.Vector3),u.matrixWorldTransOrginalDrag.copy(l)}this.clipTransRotControl.SetTextValue()}else if("rotate"==this.clipTransRotControl.pickType){if(this.viewer.ndsModel)for(r=0;r<e.length;++r){var o=e[r],d=new THREE.Matrix4,c=new THREE.Matrix4,h=new THREE.Matrix4;o.matrix&&d.fromArray(o.matrix),h.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),d.premultiply(h),c.premultiply(h),h.makeRotationFromQuaternion(n),d.premultiply(h),c.premultiply(h),h.makeTranslation(this.WorldPosition.x,this.WorldPosition.y,this.WorldPosition.z),d.premultiply(h),c.premultiply(h),this.viewer.ndsModel.updateNodeMatrix(o.uuid,d.toArray(),c),this.render(),this.entityIsTransformed=!0}else for(var u,r=0;r<e.length;++r){void 0===(u=e[r].key).matrixWorldTransOrginal&&(u.matrixWorldTransOrginal=new THREE.Vector3,u.matrixWorldTransOrginal.setFromMatrixPosition(u.matrixWorld)),void 0===u.matrixWorldRotateOrginal&&(u.matrixWorldRotateOrginal=new THREE.Matrix4,u.matrixWorldRotateOrginal=u.matrixWorld.clone());new THREE.Vector3;var f=this.clipTransRotControl.newPosition;u.matrixWorld=u.matrixWorldRotateOrginal.clone();var p=new THREE.Matrix4;p.makeTranslation(-f.x,-f.y,-f.z),u.matrixWorld.premultiply(p),p.makeRotationFromQuaternion(n),u.matrixWorld.premultiply(p),p.makeTranslation(f.x,f.y,f.z),u.matrixWorld.premultiply(p)}this.clipTransRotControl.SetTextValue()}this.render(),this.viewer.dispatchEvent({type:"dragingModel"})},Vt.prototype.addDraggedObject=function(e){for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return;this.viewer.draggedObjects.push(e)},Vt.prototype.removeDraggedObject=function(e){if(null!=this.viewer.draggedObjects)for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return void this.viewer.draggedObjects.splice(t,1)},Vt.prototype.onOpRestore=function(e,t){if(this.viewer.selectionManager.clearSelection(),this.viewer.selectionManager.selectByClick(e,t),this.viewer.ndsModel)for(var n=this.viewer.selectionManager.getSelectedObjects(),i=0;i<n.length;++i){var r=n[i];this.viewer.ndsModel.restoreDraggedBody(r),this.removeDraggedObject(r)}else for(n=this.viewer.selectionManager.getSelectedMeshes(),i=0;i<n.length;++i)(r=n[i].key).matrixWorldTransOrginalDrag&&(r.matrixWorldTransOrginalDrag=void 0),r.matrixWorldTransExplode?r.matrixWorld.setPosition(r.matrixWorldTransExplode):r.matrixWorldTransOrginal&&(r.matrixWorld.setPosition(r.matrixWorldTransOrginal),r.matrixWorldTransOrginal=void 0),this.removeDraggedObject(r);this.render(),this.viewer.dispatchEvent({type:"dragingModel"})},Vt.prototype.onLMouseMove=function(e){0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes()).length&&"default"!=this.clipTransRotControl.pickType?this.onOpBall():ce.prototype.onLMouseMove.call(this,e)},Vt.prototype.onTouchSingleStart=function(e){ce.prototype.onTouchSingleStart.call(this,e)},Vt.prototype.onTouchSingleMove=function(e){0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes()).length&&"default"!=this.clipTransRotControl.pickType?this.onOpBall():ce.prototype.onTouchSingleMove.call(this,e)},Vt.prototype.onTouchSingleEnd=function(e){this.state=-1,Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x)<1&&Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y)<1&&("move"==this.opMode||"default"==this.opMode?(this.viewer.selectionManager.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.render()):"restore"==this.opMode&&this.onOpRestore(this.singleTouchEndPos.x,this.singleTouchEndPos.y))};function jt(e){ce.call(this,e),this.type="OpSelect"}(jt.prototype=Object.create(ce.prototype)).release=function(){this.update(),this.render(),ce.prototype.release.call(this)},jt.prototype.update=function(){this.viewer.selectionManager.clearSelection(),ce.prototype.update.call(this)},jt.prototype.onLMouseClick=function(e){e.preventDefault();var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),this.viewer.selectionManager.selectByClick(t,n,e.ctrlKey),this.render()};function Ut(e){ce.call(this,e),this.type="OpSvgZoom",this.zoomRate=1.1}(Ut.prototype=Object.create(ce.prototype)).addEvents=function(e){zt.prototype.addEvents.call(this)},Ut.prototype.removeEvents=function(e){zt.prototype.removeEvents.call(this)},Ut.prototype.onLMouseDown=function(e){ce.prototype.onLMouseDown.call(this),this.addEvents()},Ut.prototype.onLMouseUp=function(e){ce.prototype.onLMouseUp.call(this),this.removeEvents()},Ut.prototype.onMMouseDown=function(e){ce.prototype.onMMouseDown.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).removeEventListener("mousewheel",this.onMouseWheel,!1),this.addEvents()},Ut.prototype.onMMouseUp=function(e){ce.prototype.onMMouseUp.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).addEventListener("mousewheel",this.onMouseWheel,!1),this.removeEvents()},Ut.prototype.onLMouseMove=function(e){var t=this.pointer.y-this.pointerOld.y;this.zoom(new THREE.Vector3(0,0,5*t))},Ut.prototype.onMMouseMove=function(e){zt.prototype.onMMouseMove.call(this,e)},Ut.prototype.onRMouseMove=function(e){},Ut.prototype.pan=function(e,t){zt.prototype.pan.call(this,e,t)},Ut.prototype.zoom=function(e){var t=this.viewer.svgViewer.getSvgElement(),n=t.getAttribute("viewBox");if(null!=n){var i=n.split(" ");i[2]=parseFloat(i[2]),i[3]=parseFloat(i[3]);var r=i[2],n=i[3];if(e.z<0)i[2]/=this.zoomRate,i[3]/=this.zoomRate;else{if(!(0<e.z))return;i[2]*=this.zoomRate,i[3]*=this.zoomRate}i[0]=parseFloat(i[0]),i[1]=parseFloat(i[1]);r=.5*(i[2]-r),n=.5*(i[3]-n);i[0]-=r,i[1]-=n,t.setAttribute("viewBox",i.join(" "))}},Ut.prototype.create=function(){zt.prototype.create.call(this)},Ut.prototype.release=function(){zt.prototype.release.call(this)};var zt=function(e){ce.call(this,e),this.type="OpSvgPan",this.zoomRate=1.1};zt.prototype=Object.create(ce.prototype),zt.prototype.addEvents=function(e){var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).addEventListener("mousemove",this.onMouseMove,!1),t.addEventListener("mouseup",this.onMouseUp,!1)},zt.prototype.removeEvents=function(e){var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).removeEventListener("mousemove",this.onMouseMove,!1),t.removeEventListener("mouseup",this.onMouseUp,!1)},zt.prototype.onLMouseDown=function(e){ce.prototype.onLMouseDown.call(this),this.addEvents()},zt.prototype.onLMouseUp=function(e){ce.prototype.onLMouseUp.call(this),this.removeEvents()},zt.prototype.onMMouseDown=function(e){ce.prototype.onMMouseDown.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).removeEventListener("mousewheel",this.onMouseWheel,!1),this.addEvents()},zt.prototype.onMMouseUp=function(e){ce.prototype.onMMouseUp.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).addEventListener("mousewheel",this.onMouseWheel,!1),this.removeEvents()},zt.prototype.onLMouseMove=function(e){var t=this.pointer.x-this.pointerOld.x,n=this.pointer.y-this.pointerOld.y;this.pan(t,n)},zt.prototype.onMMouseMove=function(e){zt.prototype.onLMouseMove.call(this,e)},zt.prototype.onRMouseMove=function(e){},zt.prototype.pan=function(e,t){var n,i,r=this.viewer.svgViewer.getSvgElement(),o=r.getAttribute("viewBox");null!=o&&(n=this.viewer.svgViewer.svgObj.style.width,i=this.viewer.svgViewer.svgObj.style.height,(o=o.split(" "))[0]=parseFloat(o[0]),o[1]=parseFloat(o[1]),o[2]=parseFloat(o[2]),o[3]=parseFloat(o[3]),n=o[2]/n,i=o[3]/i,i*=1.15,o[0]-=e*(n*=1.15),o[1]-=t*i,r.setAttribute("viewBox",o.join(" ")))},zt.prototype.zoom=function(e){Ut.prototype.zoom.call(this,e)},zt.prototype.create=function(){var e=this.viewer.svgViewer.getSvgElement();(e=null!==e?e:document).addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousewheel",this.onMouseWheel,!1),e.addEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.addEventListener("click",this.onClick,!1)},zt.prototype.release=function(){var e=this.viewer.svgViewer.getSvgElement();(e=null!==e?e:document).removeEventListener("mousedown",this.onMouseDown,!1),e.removeEventListener("mousewheel",this.onMouseWheel,!1),e.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.removeEventListener("click",this.onClick,!1)};function Gt(e){ce.call(this,e),this.type="OpSvgSelect",this.zoomRate=1.1}(Gt.prototype=Object.create(ce.prototype)).addEvents=function(e){zt.prototype.addEvents.call(this)},Gt.prototype.removeEvents=function(e){zt.prototype.removeEvents.call(this)},Gt.prototype.onLMouseDown=function(e){ce.prototype.onLMouseDown.call(this),this.addEvents()},Gt.prototype.onLMouseUp=function(e){ce.prototype.onLMouseUp.call(this),this.removeEvents()},Gt.prototype.onMMouseDown=function(e){ce.prototype.onMMouseDown.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).removeEventListener("mousewheel",this.onMouseWheel,!1),this.addEvents()},Gt.prototype.onMMouseUp=function(e){ce.prototype.onMMouseUp.call(this);var t=this.viewer.svgViewer.getSvgElement();(t=null!==t?t:document).addEventListener("mousewheel",this.onMouseWheel,!1),this.removeEvents()},Gt.prototype.onLMouseClick=function(e){},Gt.prototype.onMMouseMove=function(e){zt.prototype.onMMouseMove.call(this,e)},Gt.prototype.onRMouseMove=function(e){},Gt.prototype.pan=function(e,t){zt.prototype.pan.call(this,e,t)},Gt.prototype.zoom=function(e){Ut.prototype.zoom.call(this,e)},Gt.prototype.create=function(){zt.prototype.create.call(this)},Gt.prototype.release=function(){zt.prototype.release.call(this)};function Wt(e){ce.call(this,e),this.type="OpPrint",this.x_1,this.x_2,this.y_1,this.y_2}(Wt.prototype=Object.create(ce.prototype)).onOpPrint=function(){},Wt.prototype.onLMouseDown=function(e){this.x_1=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,this.y_1=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top,this.state=NDS.MOUSE.LEFT},Wt.prototype.onLMouseMove=function(e){e.offsetX||(e.clientX,this.viewer.container.getBoundingClientRect().left),e.offsetY||(e.clientY,this.viewer.container.getBoundingClientRect().top)},Wt.prototype.onLMouseUp=function(e){this.x_2=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,this.y_2=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top,this.state=NDS.MOUSE.NONE;e=this.x_1>this.x_2?[this.x_2,this.y_2,this.x_1,this.y_1]:[this.x_1,this.y_1,this.x_2,this.y_2];this.viewer.getPrintData("temp","A4","l","color","select",e)},Wt.prototype.onMMouseDown=function(e){this.state=NDS.MOUSE.MIDDLE,this.viewer.getPrintData("temp","A4","l","color",null,null)},Wt.prototype.onRMouseDown=function(e){this.state=NDS.MOUSE.RIGHT,this.viewer.getPrintData("temp","A4","l","color","view",null)},Wt.prototype.onTouchSingleMove=function(e){};var Yt=function(n,u){var f=this;this.viewer=n;var p=new NDS.Toolbar({id:"tbOperator",className:"toolbar",callbackEvent:x});p.setVisibility(!1),f.viewer.getToolBarAutoHideFlag()&&p.setOpacity(Ue.toolbarOpacity),n.container.appendChild(p.domElement),n.tlbOperator=p;var i=[],m=void 0,g=void 0,e=void 0,r=void 0,v=void 0,o=void 0,a=void 0,y=null,s="toolbar-button",l="",E=void 0,b=void 0,d=null,c=void 0,h=null;null!=u.toolbarButtonSize&&"small"==u.toolbarButtonSize&&(l="-"+u.toolbarButtonSize,s+=l),null!=u.toolbarButtonListRule&&"row"==u.toolbarButtonListRule&&(y="none");var t=!0;if(u.toolbarButtons)for(var M=0;M<u.toolbarButtons.length;++M)switch(u.toolbarButtons[M].id){case"btnOrbit":(e=p.addButton({id:"btnOrbit"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ORBIT")})),n.bDefaultOpRotate&&n.onOpChanged({target:e});break;case"btnPan":(e=p.addButton({id:"btnPan"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_PAN")})),!1===n.bDefaultOpRotate&&n.onOpChanged({target:e});break;case"btnZoom":(e=p.addButton({id:"btnZoom"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ZOOM")}));break;case"btnExplode":(m=p.addButton({id:"btnExplode"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_EXPLODE")})),r=new wt(n,m,u);break;case"btnAnnotation":(e=p.addButton({id:"btnAnnotation"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ANNOTATION")}));break;case"btnFitToView":(e=p.addButton({id:"btnFitToView"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_FITTOVIEW")}));break;case"btnResetCamera":(e=p.addButton({id:"btnResetCamera"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_RESETCAMERA")}));break;case"btnFullScreen":(e=p.addButton({id:"btnFullScreen"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_FULLSCREEN")}));break;case"btnLineVisibility":(e=f.viewer.getLinesVisibility()?p.addButton({id:"btnLineInVisible"+l,className:s,callbackEvent:x,float:y}):p.addButton({id:"btnLineVisible"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_HIDELINES")}));break;case"btnSelect":(e=p.addButton({id:"btnSelect"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_SELECT")}));break;case"btnDrag":(g=p.addButton({id:"btnDrag"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAG")})),(v=new NDS.Toolbar({id:"dragOpToolbar",className:"toolbar",callbackEvent:x})).setVisibility(!1),n.getToolBarAutoHideFlag()&&v.setOpacity(Ue.toolbarOpacity),g.setPopupDialog(v),(e=v.addButton({id:"btnDragOp_Select"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAGOP_SELECT")})),(e=v.addButton({id:"btnDragOp_Restore"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAGOP_RESTORE")})),(e=v.addButton({id:"btnDragOp_Hide"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAGOP_HIDE")})),(e=v.addButton({id:"btnDragOp_ReverseVisibility"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAGOP_REVERSEVISIBILITY")})),(e=v.addButton({id:"btnDragOp_ShowAll"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DRAGOP_SHOWALL")})),n.container.appendChild(v.domElement);break;case"btnDispStyle":(E=p.addButton({id:"btnDispStyle"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE")})),(b=new NDS.Toolbar({id:"dispStyleToolbar",className:"toolbar",callbackEvent:x})).setVisibility(!1),n.getToolBarAutoHideFlag()&&b.setOpacity(Ue.toolbarOpacity),E.setPopupDialog(b),(e=b.addButton({id:"btnDispStyle_ShadedEdges"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE_SHADEDEDGES")})),(e=b.addButton({id:"btnDispStyle_Shaded"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE_SHADED")})),(e=b.addButton({id:"btnDispStyle_HiddenRemoved"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE_HIDDENREMOVED")})),(e=b.addButton({id:"btnDispStyle_HiddenVisible"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE_HIDDENVISIBLE")})),(e=b.addButton({id:"btnDispStyle_Wireframe"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_DISPSTYLE_WIREFRAME")})),n.container.appendChild(b.domElement);break;case"btnSectionView":(e=p.addButton({id:"btnSectionView"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_SECTIONVIEW")}));break;case"btnBoxSectionView":(e=p.addButton({id:"btnBoxSectionView"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_BOXSECTIONVIEW")}));break;case"btnAnnotationSetting":(e=p.addButton({id:"btnAnnotationSettingShow"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("btnAnnotationSettingHide")}));break;case"btnLightEditor":(e=p.addButton({id:"btnLightEditor"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_LIGHTEDITOR")}));break;case"btnAddComment":(e=p.addButton({id:"btnAddComment"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:"文字注记"}));break;case"btnMeasure":(e=p.addButton({id:"btnMeasure"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_MEASURE")}));break;case"btnModelBrowser":(e=p.addButton({id:"btnModelBrowser"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_MODELBROWSER")}));break;case"btnPerspective":(e=p.addButton({id:"btnPerspective"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_PERSPECTIVE")})),e.setBorder("1px solid rgba(150,150,150,0.8)"),e.setBgColor(Ue.toolbarButtonClickedBkgColor);break;case"btnZoomWindow":(e=p.addButton({id:"btnZoomWindow"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ZOOMWINDOW")}));break;case"btnSnap":(e=p.addButton({id:"btnSnap"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:"Snap"}));break;case"btnOperball":(e=p.addButton({id:"btnOperball"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_OPERATING_BALL")}))}else void 0!==u.hasViewOperationUI&&!u.hasViewOperationUI||((e=p.addButton({id:"btnOrbit"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ORBIT")})),n.onOpChanged({target:e}),(e=p.addButton({id:"btnPan"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_PAN")})),(e=p.addButton({id:"btnZoom"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ZOOM")}))),u.hasExplosionUI&&((m=p.addButton({id:"btnExplode"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_EXPLODE")})),r=new wt(n,m,u)),u.hasAnnotationUI&&(e=p.addButton({id:"btnAnnotation"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_ANNOTATION")})),(e=p.addButton({id:"btnFitToView"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_FITTOVIEW")})),(e=p.addButton({id:"btnResetCamera"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_RESETCAMERA")})),u.hasFullScreenUI&&(e=p.addButton({id:"btnFullScreen"+l,className:s,callbackEvent:x,float:y})).setTooltip(new NDS.Tooltip({className:"tooltip",text:ye.translateString("IDS_FULLSCREEN")}));function x(e){if(!Ue.enableBroadcast||Ue.broadcastMajor){var t=e.target.domElement.id;if(f.viewer.controls instanceof ve)switch(t){case"tbOperator":w(e);break;case"btnPan"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new zt(f.viewer)),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnZoom"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new Ut(f.viewer)),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnSelect"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new Gt(f.viewer)),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnLoadModel"+l:I(e);break;case"btnSnap"+l:!function(e){var t=e.event.type;e.target.subElements.tooltip;switch(t){case"click":case"touchstart":var n=f.viewer.getSvgViewportInfo(),i=f.viewer.getSvgScreenCapture(function(e){f.viewer.dispatchEvent({type:"snapEvent",cameraInfo:n,imgData:i})});break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnResetCamera"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.resetSvgViewBox();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e)}else if(f.viewer.controls instanceof me)switch(t){case"tbOperator":w(e);break;case"dragOpToolbar":!function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&f.viewer.getToolBarAutoHideFlag()){var t=e.event.type,n=e.target;switch(t){case"mouseenter":n.deleteOpacity();break;case"mouseleave":n.setOpacity(Ue.toolbarOpacity);break;case"mouseover":n.deleteOpacity();break;case"mouseout":n.setOpacity(Ue.toolbarOpacity)}}}(e);break;case"btnOrbit"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new dt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnPan"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new ct(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnZoom"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new ht(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnSelect"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new jt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnView"+l:!function(e){var t=e.event.type,n=e.target.domElement,i=e.target.subElements.popupElement;switch(t){case"mouseenter":var r=ye.getStyle(i.domElement,"margin"),o=n.offsetLeft-parseInt(r),r=f.viewer.tlbOperator.domElement.offsetHeight;i.setLeft(o),i.setBottom(r),i.setVisibility(!0);break;case"mouseleave":ye.onAutoHide(i)}}(e);break;case"btnFitToView"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.zoomExtents();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnResetCamera"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onResetCamera();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnSetting"+l:!function(e){switch(e.event.type){case"click":case"touchstart":break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnLoadModel"+l:I(e);break;case"btnSnap"+l:S(e);break;case"btnOperball"+l:!function(e){var t=e.event.type;e.target.subElements.tooltip;switch(t){case"click":case"touchstart":"OpBall"==f.viewer.controls.getOperator().type?f.viewer.controls.setOperator(new dt(f.viewer)):f.viewer.controls.setOperator(new Vt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnMeasure"+l:!function(e){var t=e.event.type;e.target.subElements.tooltip;switch(t){case"click":case"touchstart":var n=new lt(f.viewer);f.viewer.controls.setOperator(n),null!=a&&a.dialog.getVisibility()?(a.show(!1),f.viewer.controls.setOperator(new dt(f.viewer)),f.viewer.clipPlaneManager.isSectionViewEnabled()&&f.viewer.clipPlaneManager.onOpenClipControl()):(a=new de(f.viewer),f.viewer.Optoolbar.setMeasureDlg(a),a.show(!0),f.viewer.clipPlaneManager.onCloseClipControl()),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnExplode"+l:!function(e){var t=e.event.type,n=e.target.subElements.tooltip,i=(e.target.domElement,e.target.subElements.popupDialog);switch(t){case"click":case"touchstart":f.viewer.isSectionViewEnabled()&&f.viewer.onSectionView(!1),i.setVisibility(!i.style.visibility),i.style.visibility?(e.target.domElement.style.backgroundColor=Ue.toolbarButtonClickedBkgColor,Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render()):(e.target.domElement.style.backgroundColor="",r&&(0==r.getExplodeDlgValue()?f.viewer.render():r.resetExplosion()));break;case"mouseenter":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!0);break;case"mouseleave":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!1);break;case"mouseover":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!0);break;case"mouseout":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!1)}}(e);break;case"btnFullScreen"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.executeFullScreen();break;default:if(!f.viewer.getShowToolTipFlag(e.target.subElements.tooltip))return;ye.onShowTooltip(e)}}(e);break;case"btnAnnotation"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new Bt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnLineVisibility"+l:case"btnLineVisible"+l:case"btnLineInVisible"+l:T(e);break;case"btnDrag"+l:!function(e){switch(e.event.type){case"click":case"touchstart":var t;"OpDrag"==f.viewer.controls.getOperator().type?(f.viewer.controls.setOperator(new dt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),t={target:p.getChildElement("btnOrbit")},f.viewer.onOpChanged(t)):(f.viewer.controls.setOperator(new We(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e)),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDragOp_Select"+l:!function(e){switch(e.event.type){case"click":case"touchstart":var t=o;null!=t&&(t.setBorder(""),t.setBgColor("")),e.target.setBorder("1px solid rgba(150,150,150,0.8)"),e.target.setBgColor(Ue.toolbarButtonClickedBkgColor),f.viewer.onSelectAndMoveModel(!0),o=e.target,Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDragOp_Restore"+l:!function(e){switch(e.event.type){case"click":case"touchstart":var t=o;null!=t&&(t.setBorder(""),t.setBgColor("")),e.target.setBorder("1px solid rgba(150,150,150,0.8)"),e.target.setBgColor(Ue.toolbarButtonClickedBkgColor),f.viewer.onSelectAndRestoreModel(!0),o=e.target,Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDragOp_Hide"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onHideModel();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDragOp_ReverseVisibility"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onReverseVisibleAndHidingModel();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDragOp_ShowAll"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onShowAllModel();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnSectionView"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.clipBoxManager.isSectionBoxEnabled()&&f.viewer.onBoxSectionView(!1);var t=f.viewer.isSectionViewEnabled();f.viewer.onSectionView(!t);var n=e.target;null!=n&&(n.setBorder(""),n.setBgColor("")),t||(e.target.setBorder("1px solid rgba(150,150,150,0.8)"),e.target.setBgColor(Ue.toolbarButtonClickedBkgColor));break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnBoxSectionView"+l:!function(e){switch(e.event.type){case"click":case"touchstart":var t=f.viewer.isSectionViewEnabled();t&&f.viewer.onSectionView(!1),f.viewer.clipBoxManager.isSectionBoxEnabled()?f.viewer.onBoxSectionView(!1):f.viewer.onBoxSectionView(!0);var n=e.target;null!=n&&(n.setBorder(""),n.setBgColor("")),t||(e.target.setBorder("1px solid rgba(150,150,150,0.8)"),e.target.setBgColor(Ue.toolbarButtonClickedBkgColor));break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnAnnotationSettingShow"+l:case"btnAnnotationSettingHide"+l:O(e);break;case"btnLightEditor"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onLightEditor();n.getLightControls();for(var t=0;t<i.length;t++)i[t].run();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnAddComment"+l:!function(e){var t=e.event.type;e.target.subElements.tooltip;switch(t){case"click":case"touchstart":f.viewer.controls.setOperator(new Ct(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnModelBrowser"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.onModelBrowser();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnPerspective"+l:!function(e){switch(e.event.type){case"click":case"touchstart":var t=f.viewer.camera.IsPerspective();t?f.viewer.camera.toOrthographic():f.viewer.camera.toPerspective(),f.viewer.render();var n=e.target;null!=n&&(n.setBorder(""),n.setBgColor(""),t||(n.setBorder("1px solid rgba(150,150,150,0.8)"),n.setBgColor(Ue.toolbarButtonClickedBkgColor)));break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnZoomWindow"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.controls.setOperator(new ut(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"dispStyleToolbar":!function(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&f.viewer.getToolBarAutoHideFlag()){var t=e.event.type,n=e.target;switch(t){case"mouseenter":n.deleteOpacity();break;case"mouseleave":n.setOpacity(Ue.toolbarOpacity);break;case"mouseover":n.deleteOpacity();break;case"mouseout":n.setOpacity(Ue.toolbarOpacity)}}}(e);break;case"btnDispStyle"+l:!function(e){switch(e.event.type){case"click":case"touchstart":h=e.target,R(c=void 0===c||!1===c),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDispStyle_ShadedEdges"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.setRenderMode("shadedWithEdges"),A(e.target,d),d=e.target,R(!1),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDispStyle_Shaded"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.setRenderMode("shaded"),A(e.target,d),d=e.target,R(!1),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDispStyle_HiddenRemoved"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.setRenderMode("hiddenLineRemove"),A(e.target,d),d=e.target,R(!1),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDispStyle_HiddenVisible"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.setRenderMode("hiddenLineVisible"),A(e.target,d),d=e.target,R(!1),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnDispStyle_Wireframe"+l:!function(e){switch(e.event.type){case"click":case"touchstart":f.viewer.setRenderMode("wireframe"),A(e.target,d),d=e.target,R(!1),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}(e);break;case"btnSnap"+l:S(e)}}}function w(e){if((!Ue.enableBroadcast||Ue.broadcastMajor)&&f.viewer.getToolBarAutoHideFlag()){var t=e.event.type,n=e.target;switch(t){case"mouseenter":n.deleteOpacity();break;case"mouseleave":n.setOpacity(Ue.toolbarOpacity);break;case"mouseover":n.deleteOpacity();break;case"mouseout":n.setOpacity(Ue.toolbarOpacity)}}}function I(e){var t=e.event.type,n=e.target.subElements.tooltip,i=e.target.domElement,r=e.target.subElements.popupDialog;switch(t){case"click":case"touchstart":var o=f.viewer.tlbOperator.domElement,a=o.offsetLeft+i.offsetLeft,s=parseInt(ye.getStyle(o,"padding-top"))+parseInt(ye.getStyle(o,"padding-bottom"))+parseInt(ye.getStyle(o,"border-top-width"))+parseInt(ye.getStyle(o,"border-bottom-width"))+parseInt(ye.getStyle(o,"margin-top"))+parseInt(ye.getStyle(o,"margin-bottom"));parseInt(ye.getStyle(o,"margin-bottom"));s=o.offsetHeight+s;r.setLeft(a),r.setBottom(s),r.setVisibility(!r.style.visibility);break;case"mouseenter":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!0);break;case"mouseleave":if(!f.viewer.getShowToolTipFlag())return;n.setVisibility(!1)}}function S(e){var t=e.event.type;e.target.subElements.tooltip;switch(t){case"click":case"touchstart":f.viewer.controls.setOperator(new Wt(f.viewer)),f.viewer.controls.addEventListener("change",f.viewer.render),f.viewer.onOpChanged(e);break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}function T(e){switch(e.event.type){case"click":case"touchstart":f.viewer.getLinesVisibility()?f.viewer.setLinesVisibility(!1):f.viewer.setLinesVisibility(!0),f.viewer.getLinesVisibility()?(e.target.domElement.id="btnLineInVisible",e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_HIDELINES")):(e.target.domElement.id="btnLineVisible",e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_SHOWLINES"));break;default:if(f.viewer.getLinesVisibility()?e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_HIDELINES"):e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_SHOWLINES"),!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}function A(e,t){t&&(t.setBorder(""),t.setBgColor("")),e.setBorder("1px solid rgba(150,150,150,0.8)"),e.setBgColor(Ue.toolbarButtonClickedBkgColor)}function R(e){c=e=null!=e&&e,b.setVisibility(e),null!=h&&(e?(h.setBorder("1px solid rgba(150,150,150,0.8)"),h.setBgColor(Ue.toolbarButtonClickedBkgColor)):(h.setBorder(""),h.setBgColor("")))}function O(e){switch(e.event.type){case"click":case"touchstart":(t=!t)?(e.target.domElement.id="btnAnnotationSettingShow",e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_ANNOTATIONSETTINGHIDE")):(e.target.domElement.id="btnAnnotationSettingHide",e.target.subElements.tooltip.domElement.innerHTML=ye.translateString("IDS_ANNOTATIONSETTINGSHOW")),t?f.viewer.annotationsManager&&f.viewer.annotationsManager.getAnnotationJsonArray()&&f.viewer.showAnnotations(f.viewer.annotationsManager.getAnnotationJsonArray()):f.viewer.annotationsManager&&(f.viewer.annotationsManager.removeAllAnnotations(),Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render()),!f.viewer.annotationsManager&&Ue.enableBroadcast&&Ue.broadcastMajor&&f.viewer.render();break;default:if(e.target.subElements.tooltip.domElement.innerHTML=t?ye.translateString("IDS_ANNOTATIONSETTINGHIDE"):ye.translateString("IDS_ANNOTATIONSETTINGSHOW"),!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}p.showButton=function(e,t){this.getChildElement(e).domElement.parentElement.style.display=t?"":"none"},p.onResize=function(e,t){p.setLeft(0);var n,i,r,o,a,s,l=p.domElement.offsetWidth,d=p.domElement.offsetHeight,c=0,h=0;switch(u.toolbarVerticalAlign){case"top":h=t-d-10;break;case"center":h=(t-d-10)/2;break;case"bottom":default:h=0}switch(u.toolbarHorizontalAlign){case"left":c=0;break;case"right":c=e-l-10;break;case"center":default:c=(e-l-10)/2}p.setLeft(c),p.setBottom(h),0<e&&0<t&&f.viewer.toolbarInitialVisibility&&p.setVisibility(!0),m&&((n=p.getChildElementIndex(m.domElement.id))<0&&(n=0),o=r=0,y?(i=(d-2)/p.childElements.length,s=m.subElements.popupDialog.domElement.getBoundingClientRect(),r=c+l+6+4,o=h+(p.childElements.length-n)*i+6-s.height,null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(r=c-s.width)):(r=c+n*(a=(l-2)/p.childElements.length)+6,o=h+d+6+4,null!=u.toolbarVerticalAlign&&"top"==u.toolbarVerticalAlign&&(o=h-(s=m.subElements.popupDialog.domElement.getBoundingClientRect()).height-4),null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(r=r-(s=m.subElements.popupDialog.domElement.getBoundingClientRect()).width+a)),m.subElements.popupDialog.dispatchEvent({type:"resize",left:r,bottom:o})),g&&v&&((n=p.getChildElementIndex(g.domElement.id))<0&&(n=0),o=r=0,y?(i=(d-2)/p.childElements.length,s=g.subElements.popupDialog.domElement.getBoundingClientRect(),r=c+l+6+4,o=h+(p.childElements.length-n)*i+6-s.height,null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(r=c-s.width)):(r=c+n*(a=(l-2)/p.childElements.length)-.5*a-5+6,o=h+d+6+4,null!=u.toolbarVerticalAlign&&"top"==u.toolbarVerticalAlign&&(s=g.subElements.popupDialog.domElement.getBoundingClientRect(),o=h-d-6-4),null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(r=r-(s=g.subElements.popupDialog.domElement.getBoundingClientRect()).width+a)),v.setLeft(r),v.setBottom(o)),p.resizeDispStyleToolbar(E,b,l,d,c,h)},p.resizeDispStyleToolbar=function(e,t,n,i,r,o){var a,s,l,d,c;e&&t&&((a=p.getChildElementIndex(e.domElement.id))<0&&(a=0),d=l=0,y?(s=(i-2)/p.childElements.length,c=e.subElements.popupDialog.domElement.getBoundingClientRect(),l=r+n+6+4,d=o+(p.childElements.length-a)*s+6-c.height,null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(l=r-c.width)):(l=r+a*(n=(n-2)/p.childElements.length)-.5*n-5+6,d=o+i+6+4,null!=u.toolbarVerticalAlign&&"top"==u.toolbarVerticalAlign&&(c=e.subElements.popupDialog.domElement.getBoundingClientRect(),d=o-i-6-4),null!=u.toolbarHorizontalAlign&&"right"==u.toolbarHorizontalAlign&&(l=l-(c=e.subElements.popupDialog.domElement.getBoundingClientRect()).width+n)),t.setLeft(l),t.setBottom(d))},this.addButton=function(e,t){p.addButton({img:e.backGroundImage,id:e.id,className:s,float:y,callbackEvent:function(e){switch(e.event.type){case"click":case"touchstart":t&&t();break;default:if(!f.viewer.getShowToolTipFlag())return;ye.onShowTooltip(e)}}}).setTooltip(new NDS.Tooltip({className:"tooltip",text:e.tooltip}));var n=this.viewer.container.getBoundingClientRect(),e=n.width,n=n.height;p.onResize(e,n)},this.addLightEditBtnListener=function(e){i.push(e)},this.resetExplosion=function(){r&&r.resetExplosion()},this.getExplodeDlgVisibility=function(){return!!r&&r.dialog.getVisibility()},this.getExplodeDlgValue=function(){return r?r.getExplodeDlgValue():0},this.setExplodeDlgVisibility=function(e){r&&r.dialog.getVisibility()!=e&&r.dialog.setVisibility(e)},this.setExplodeDlgValue=function(e){r&&r.getExplodeDlgValue()!=e&&r.setExplodeDlgValue(e)},this.onOpChanged=function(e){var t;v&&e&&e.target&&(e.target.domElement.id=="btnDrag"+l?v.setVisibility(!0):(v.setVisibility(!1),null!=(t=o)&&(t.setBorder(""),t.setBgColor("")),o=void 0)),a&&e&&e.target&&e.target.domElement.id!="btnMeasure"+l&&e.target.domElement.id!="btnOperball"+l&&(a.release(),a=void 0)},this.getDispStyleToolbar=function(){return b},this.getMeasureDlg=function(){return a},this.setMeasureDlg=function(e){a=e},this.getAnnotationSetting=function(){return t},this.setVisibility=function(e){p&&p.setVisibility(e),0==e?(v&&(v.preVisibility=v.getVisibility(),v.setVisibility(!1)),r&&(r.preVisibility=r.dialog.getVisibility(),r.dialog.setVisibility(!1)),b&&(b.preVisibility=b.getVisibility(),b.setVisibility(!1))):(v&&(1==v.preVisibility&&v.setVisibility(!0),v.preVisibility=void 0),r&&(1==r.preVisibility&&r.dialog.setVisibility(!0),r.preVisibility=void 0),b&&(1==b.preVisibility&&b.setVisibility(!0),b.preVisibility=void 0))},this.getVisibility=function(){return!!p&&p.getVisibility()},this.getDragToolbarBtnSelected=function(){return o?o.domElement.id:null},this.setDragToolbarBtnSelected=function(e){var t;null!=e&&(o&&e==o.domElement.id||(o&&(o.setBorder(""),o.setBgColor("")),!v||(t=v.getChildElement(e))&&(t.setBorder("1px solid rgba(150,150,150,0.8)"),t.setBgColor(Ue.toolbarButtonClickedBkgColor)),o=t))}};function Xt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Zt=function(){function r(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.viewer=e;var t=void 0,n=void 0,i=new THREE.LoadingManager;Object.defineProperties(this,{cachedProperties:{get:function(){return t},set:function(e){t=e}},cachedPropertyFileName:{get:function(){return n},set:function(e){n=e}},loadingManager:{get:function(){return i}}})}var e,t,n;return e=r,(t=[{key:"getObjectProperty",value:function(e,t,n){var i,r,o=e.uuid,a=e.propertyfile;null!=a&&null!=a?void 0===this.cachedProperties||this.cachedPropertyFileName!=a||null==this.cachedProperties[o]||null==t?((i=new He(this.loadingManager)).setCrossOrigin("anonymous"),i.setResponseType("arraybuffer"),e=function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")}(this.viewer.modelInfo[0].url),r=this,i.load(null,e+a,function(e){e=pako.inflate(e,{to:"string"});r.cachedProperties=JSON.parse(e),null!=r.cachedProperties&&(r.cachedPropertyFileName=a,null!=t&&(null!=r.cachedProperties[o]?t(r.cachedProperties[o],n):t(null,n)))},void 0,function(e){null!=t&&t(null,n)},!0)):t(this.cachedProperties[o],n):null!=t&&t(null,n)}}])&&Xt(e.prototype,t),n&&Xt(e,n),r}(),qt=function(e){this.viewer=e,this.renderTarget=null,this.bkgDepthRGBAMat=null,this.bkgDepthRGBAMatCopy=null,this.bodyIdMat=null,this.convertPointScreen=function(e,t){var n=this.viewer.renderer.domElement,i=this.viewer.renderer.getPixelRatio();if(e&&2<=e.length){this.renderTarget||(this.renderTarget=new THREE.WebGLRenderTarget(n.width,n.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1}),this.renderTarget.texture.generateMipmaps=!1);var r=this.renderTarget;this.bkgDepthRGBAMat||(this.viewer.ndsModel?(this.bkgDepthRGBAMat=new THREE.ShaderMaterial({vertexShader:N.vertexShader,fragmentShader:N.fragmentShader}),this.bkgDepthRGBAMatCopy=(new this.bkgDepthRGBAMat.constructor).copy(this.bkgDepthRGBAMat)):(this.bkgDepthRGBAMat=new THREE.ShaderMaterial({vertexShader:N.vertexShader,fragmentShader:N.fragmentShader}),this.bkgDepthRGBAMat.side=THREE.DoubleSide));var o=this.viewer.scene.overrideMaterial,a=this.viewer.renderer.getClearColor().clone(),s=this.viewer.renderer.getClearAlpha();this.viewer.scene.overrideMaterial=this.bkgDepthRGBAMat,this.viewer.renderer.setClearColor(16777215),this.viewer.lightControls&&this.viewer.scene.remove(this.viewer.lightControls._scene),this.viewer.ndsModel&&(this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.viewer.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.bkgDepthRGBAMat,this.bkgDepthRGBAMatCopy,!1)),this.viewer.renderer.render(this.viewer.scene,this.viewer.camera,r,!0,!0),this.viewer.scene.overrideMaterial=o,this.viewer.ndsModel&&this.viewer.ndsModel.setOverrideMaterial(null,null,!1);var l=new THREE.Matrix4;l.multiplyMatrices(this.viewer.camera.matrixWorld,l.getInverse(this.viewer.camera.projectionMatrix));var d=[],c="",h=null,u=new Uint8Array(4);u[0]=u[1]=u[2]=u[3]=0,this.viewer.renderer.readRenderTargetPixels(r,e[0]*i,r.height-e[1]*i,1,1,u);var f,p,m,g=253<u[0]&&253<u[1]&&253<u[2]&&253<u[3];g||(u=u[0]*(f=255/256)/16777216+u[1]*f/65536+u[2]*f/256+u[3]*f,u=2*(u/=255)-1,u-=4e-8*u,(f=new THREE.Vector3).set(e[0]*i/n.width*2-1,2*-(e[1]*i/n.height)+1,u),f.applyMatrix4(l),d.push(f.x),d.push(f.y),d.push(f.z)),g||null!=t&&1!=t||(p=10,m=[],this.viewer.ndsModel?this.bodyIdMat||(this.bodyIdMat=new THREE.MeshBasicMaterial):this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.materialRaycasterRecord=e.material,e instanceof THREE.Line||e instanceof THREE.LineSegments?e.material=new THREE.LineBasicMaterial:(e.material=new THREE.MeshBasicMaterial,e.material.side=THREE.DoubleSide),e.material.color.setHex(p),m[p]=e,p+=10)}),this.viewer.scene.overrideMaterial=null,this.viewer.ndsModel&&(this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.viewer.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.bodyIdMat,null,!0)),this.viewer.renderer.render(this.viewer.scene,this.viewer.camera,r,!0,!0),this.viewer.scene.overrideMaterial=o,this.viewer.ndsModel&&this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&e.materialRaycasterRecord&&(e.material&&e.material.dispose(),e.material=e.materialRaycasterRecord,e.materialRaycasterRecord=void 0)}),(o=new Uint8Array(4))[0]=o[1]=o[2]=o[3]=0,this.viewer.renderer.readRenderTargetPixels(r,e[0]*i,r.height-e[1]*i,1,1,o),(g=253<o[0]&&253<o[1]&&253<o[2])||(g=o[0]<<16|o[1]<<8|o[2],this.viewer.ndsModel?(o=this.viewer.ndsModel.getBodyNode(g/10))&&(c=(h=o).uuid):m[g]&&(h=m[g],c=m[g].uuid))),this.viewer.renderer.setRenderTarget(null),this.viewer.renderer.setClearColor(a,s),this.viewer.lightControls&&this.viewer.scene.add(this.viewer.lightControls._scene),this.viewer.render();s=null;return s=0<d.length?{coords:d,locationObjectUUID:c,locationObject:h}:s}return null}};function Qt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Jt=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.viewer=e;var y=this,u=new Array,o=new Array,f=new Array,a=new Array,p=new Array,i="body";Ue.enablePreSelectBrep?i="vertex_edge_face":Ue.inAssemblyContext&&(i="component");var c="replace",h=new Array,m=new Array,g=new Array,v=new Array,E=new Array,b=new Array,d=null,M=null,x=null,w=null,I=null,S=null,T=3,r=new THREE.Scene,A=new THREE.Object3D;r.add(A);var R=this.selectfromtree=!1,O=null,P=!1,C=null;function B(){if(y.viewer.ndsModel)y.viewer.ndsModel.clearSelection();else for(var e=y.viewer.getRenderMode(),t=0;t<a.length;++t){var n=a[t].key,i=a[t].value.oldMat;n.material=i,void 0!==n.material.colorWrite&&(4==e||5==e?n.material.colorWrite=!0:6!=e&&7!=e||(n instanceof THREE.Line||n instanceof THREE.LineSegments?n.material.colorWrite=!0:n.material.colorWrite=!1))}a.length=0,p.length=0,A.children.length=0,h.length=0,m.length=0,g.length=0,v.length=0,E.length=0,b.length=0}function L(e,t){var n=!1;"face"!=t&&(d=null,M&&(A.remove(M),n=!(M=null))),"edge"!=t&&(x=null,w&&(A.remove(w),n=!(w=null))),"vertex"!=t&&(I=null,S&&(A.remove(S),n=!(S=null)));t=y.viewer.ndsModel.clearPreSelection();(n||t)&&e&&y.viewer.render()}function D(e,t){return e.uuid==t.uuid||!(!e.parent||!D(e.parent,t))}function s(e,t){if(void 0!==e&&!1!==e.visible&&!(e instanceof THREE.Light||"lightctrls"==e.name)){if(e.hasOwnProperty("geometry")){if(e instanceof THREE.Line){for(var n=0,i=o.length;n<i;n++)if(o[n]===e)return;o.push(e)}else t.push(e);f.push(e)}if(void 0!==e.children)for(var r=e.children,n=0,i=r.length;n<i;++n)s(r[n],t)}}function H(e,t){return!(e&&!t||!e&&t||!e&&!t)&&((!y.viewer.ndsModel||e.bodyId==t.bodyId&&e.meshId==t.meshId&&e.lineSegId==t.lineSegId)&&(e.parentObj==t.parentObj&&e.id==t.id))}function l(e){if(e&&y.viewer.hasBrepInfo()){var t=y.viewer.ndsModel?e.object:y.findParentElement(e.object);if(t){var n,i,r,o=t.type.toLowerCase();return t&&"body"===o&&(o=t.uuid,t=e.object.uuid,y.viewer.ndsModel&&(0<=e.meshId?(e.mesh=y.viewer.ndsModel.meshManager.getSingleMesh(e.meshId),e.mesh&&(n=e.faceIndex-e.mesh.geometry.drawRange.start/3,i="face")):0<=e.lineSegId&&(e.mesh=y.viewer.ndsModel.meshManager.getLineSegments(e.lineSegId),e.mesh&&(n=.5*(e.index-e.mesh.geometry.drawRange.start),i="edge")),t=e.geomUuid),0<=n&&(r=y.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(o,t,n,i))&&(r.parentObj=e.mesh,r.intersect=e.point.clone(),r.bodyId=o,r.meshId=t,r.lineSegId=e.lineSegId,r.normal&&null==r.worldNormal&&(o=new THREE.Vector3,t=new THREE.Quaternion,e=new THREE.Vector3,r.parentObj.matrixWorld.decompose(o,t,e),r.worldNormal=new THREE.Vector3(r.normal[0],r.normal[1],r.normal[2]),r.worldNormal.applyQuaternion(t)))),r}}}function N(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var n=e.parentObj.geometry,i=e.indexRange.concat();if(y.viewer.ndsModel&&(i[0]+=n.drawRange.start/3,i[1]+=n.drawRange.start/3),n.isBufferGeometry){for(var r=n.index,o=n.attributes.position,a=i[1]-i[0]+1,s=new Float32Array(9*a),l=0,d=i[0],c=i[1];d<=c;d++,l+=1){var h=3*d,u=r.getX(h),f=r.getX(1+h),p=r.getX(2+h),m=new THREE.Vector3,g=new THREE.Vector3,h=new THREE.Vector3;m.fromBufferAttribute(o,u),g.fromBufferAttribute(o,f),h.fromBufferAttribute(o,p),s[9*l]=m.x,s[9*l+1]=m.y,s[9*l+2]=m.z,s[9*l+3]=g.x,s[9*l+4]=g.y,s[9*l+5]=g.z,s[9*l+6]=h.x,s[9*l+7]=h.y,s[9*l+8]=h.z,h=g=m=null}var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.BufferAttribute(s,3)),(a=new THREE.Mesh(a,0==t?Ue.selectedFaceMaterial:Ue.preSelectedFaceMaterial)).objectType="Face",a.applyMatrix(e.parentObj.matrixWorld),a.matrixWorldNeedsUpdate=!0}return a}}function F(e,t){if(e&&e.parentObj instanceof THREE.Line){var n=e.parentObj.geometry,i=e.indexRange.concat();if(y.viewer.ndsModel&&(i[0]+=n.drawRange.start/2,i[1]+=n.drawRange.start/2),n.isBufferGeometry){var r=i[1]-i[0]+1,o=n.index,a=n.attributes.position.array,s=new Float32Array(6*r);if(null!=o){var l=o.array,d=0,o=i[0],c=i[1],i=c;"circle"==e.type&&(i=(i=Math.round(.5*(o+c)))==o?c:i);for(var h=o,u=c;h<=u;h++,d+=1){var f=l[2*h],p=l[2*h+1],m=new THREE.Vector3,g=new THREE.Vector3;m.fromArray(a,3*f),g.fromArray(a,3*p),s[6*d]=m.x,s[6*d+1]=m.y,s[6*d+2]=m.z,s[6*d+3]=g.x,s[6*d+4]=g.y,s[6*d+5]=g.z,g=m=null}var c=new THREE.BufferGeometry;c.addAttribute("position",new THREE.BufferAttribute(s,3)),(c=new THREE.LineSegments(c,0==t?Ue.selectedEdgeMaterial:Ue.preSelectedEdgeMaterial)).objectType="Edge",c.applyMatrix(e.parentObj.matrixWorld),c.matrixWorldNeedsUpdate=!0}}return c}}function _(e,t){t=function(e,t){var n=5;null!=t&&(n=t);var i=y.viewer.camera.getCameraTarget(),r=y.viewer.camera.position;return(t=new THREE.Vector3).subVectors(i,r),e=e.position.clone(),r=y.viewer.camera.isPerspective?e.sub(r).dot(t.normalize()):t.length(),t=y.viewer.camera.fov,r=2*r*Math.tan(THREE.Math.degToRad(.5*t)),t=y.viewer.renderer.domElement.height,n*r*y.viewer.renderer.getPixelRatio()/t}(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()}function k(e,t,n){n=new THREE.Mesh(new THREE.SphereGeometry(1),0==n?Ue.selectedVertexMaterial:Ue.preSelectedVertexMaterial);return n.position.set(e.x,e.y,e.z),_(n,t),n.objectType="Point",n}function V(e,t,n){t?e.isPreSelected()||(y.viewer.ndsModel.preSelectObject(e),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.uuid})):null!=n&&1==n||"accumulate"==c?y.isObjectSelected(e)?(y.deselectObject(e),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:e.type,bodyId:e.uuid,entityId:""}]})):(y.selectObject(e),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:e.type,bodyId:e.uuid,entityId:""}],removed:[]})):y.isObjectSelected(e)?y.clearSelection():(y.clearSelection(),y.selectObject(e),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:e.type,bodyId:e.uuid,entityId:""}],removed:[]}))}function j(e){e=l(e[0]);return e&&null!=e.area?e:null}function U(e,t,n){if(t)L(!1,"face"),d?H(d,e)||(d=e,A.remove(M),M=N(e,!0),A.add(M),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(M=N(d=e,!0),A.add(M),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var i,r,o=!1,a=-1,s=0,l=h.length;s<l;s++)if(H(h[s],e)){o=!0,a=s;break}null!=n&&1==n||"accumulate"==c?o?(i=h[a],h.splice(a,1),A.remove(m[a]),m[a]=null,m.splice(a,1),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"face",bodyId:i.bodyId,entityId:i.id}]})):(h.push(e),(r=N(e,!1))&&(A.add(r),m.push(r)),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"face",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(n=y.getAllSelectionInfors(),i=[],B(),o||(h.push(e),i.push({entityType:"face",bodyId:e.bodyId,entityId:e.id}),(r=N(e,!1))&&(A.add(r),m.push(r))),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:i,removed:n}))}}function z(e,t,n,i,r){if(y.viewer.hasBrepInfo()){t=X(e,t,!1);if(t&&0<t.length){if("refplane"==t[0].bodyNode.type.toLowerCase())return void V(t[0].bodyNode,n,i);t=j(t);if(t)return(!r||"plane"==t.type)&&void U(t,n,i)}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function G(e){var t,n=null;if(y.viewer.ndsModel?0<=e[0].lineSegId&&(n=e[0]):e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?n=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&(Math.abs(e[1].distance-e[0].distance)<(t=y.viewer.controls.getBoundingBox()).min.distanceTo(t.max)/1e3&&(n=e[1])),n){n=l(n);if(n)return n}return null}function W(e,t,n){if(t)L(!1,"edge"),x?H(x,e)||(x=e,A.remove(w),w=F(e,!0),A.add(w),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(w=F(x=e,!0),A.add(w),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var i,r,o=!1,a=-1,s=0,l=g.length;s<l;s++)if(H(g[s],e)){o=!0,a=s;break}null!=n&&1==n||"accumulate"==c?o?(i=g[a],g.splice(a,1),A.remove(v[a]),v[a]=null,v.splice(a,1),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"edge",bodyId:i.bodyId,entityId:i.id}]})):(g.push(e),(r=F(e,!1))&&(A.add(r),v.push(r)),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"edge",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(n=y.getAllSelectionInfors(),i=[],B(),o||(g.push(e),i.push({entityType:"edge",bodyId:e.bodyId,entityId:e.id}),(r=F(e,!1))&&(A.add(r),v.push(r))),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:i,removed:n}))}}function Y(e,t,n,i){if(y.viewer.hasBrepInfo()){t=X(e,t,!0);if(t&&0<t.length){if("refaxis"==t[0].bodyNode.type.toLowerCase())return void V(t[0].bodyNode,n,i);t=G(t);if(null!=t)return void W(t,n,i)}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function X(e,t,n){var i=y.viewer,r=i.renderer.domElement,o=i.renderer.getPixelRatio(),e=e*o/r.width*2-1,o=2*-(t*o/r.height)+1,r=new THREE.Raycaster;i.camera.setCastRay(r,e,o),n&&(r.linePrecision=1,e=i.clientCoordToModelCoord([0,0]),o=new THREE.Vector3(e[0],e[1],e[2]),e=i.clientCoordToModelCoord([4,0]),e=new THREE.Vector3(e[0],e[1],e[2]),r.linePrecision=o.distanceTo(e));var a=null;if(i.ndsModel){if((a=n?i.ndsModel.intersect(r.ray,r.linePrecision):i.ndsModel.intersect(r.ray))&&0<a.length)if(R){if(O&&0<O.length)for(var s=!1,l=0;l<a.length;l++){c=a[l].bodyNode;for(var s=!1,d=0;d<O.length;d++)if(O[d]==c||c.isChildOfNode(O[d])){s=!0;break}s&&(a.splice(l,1),l--)}}else if(P&&C&&0<C.length)for(var c,h=!1,l=0;l<a.length;l++){c=a[l].bodyNode;for(h=!1,d=0;d<C.length;d++)if(C[d]==c||c.isChildOfNode(C[d])){h=!0;break}h||(a.splice(l,1),l--)}}else i=y.viewer.getIsolateMeshes(),a=0<i.length?r.intersectObjects(i):n?r.intersectObjects(f):r.intersectObjects(u);return a}function Z(e){var t=e[0],n=y.viewer.ndsModel?t.object:y.findParentElement(t.object);if(!n||"body"!=n.type.toLowerCase())return null;var i,r,o=n.uuid,a=y.viewer.brepManager.GetVerticesByBodyUUID(o);if(a){var s=(s=.5,(i=n)?(i.boxDiagonalLength||(r=new THREE.Vector3,e=new THREE.Vector3,y.viewer.computeBoundingBox(i,r,e,{flag:!0}),i.boxDiagonalLength=e.distanceTo(r)),s=.015*i.boxDiagonalLength):s),l=s*s,d=t.point.clone(),t=null,t=y.viewer.ndsModel?n.worldMatrix:n.matrixWorld,n=new THREE.Matrix4;n.getInverse(t),d.applyMatrix4(n);for(var c,n=y.viewer.modelCoordToClientCoord([d.x,d.y,d.z]),h=new THREE.Vector3(n[0],n[1],0),u=new THREE.Vector3,f=new THREE.Vector3,p=64,m=-1,g=0,v=a.length;g<v;g++)f.set(a[g].coords[0],a[g].coords[1],a[g].coords[2]),d.distanceToSquared(f)<l&&(c=y.viewer.modelCoordToClientCoord(a[g].coords),u.set(c[0],c[1],0),(c=h.distanceToSquared(u))<p&&(m=g,p=c));if(0<=m)return f.set(a[m].coords[0],a[m].coords[1],a[m].coords[2]),f.applyMatrix4(t),{id:a[m].id,coords:[f.x,f.y,f.z],bodyId:o}}return null}function q(e,t,n){var i=new THREE.Vector3(e.coords[0],e.coords[1],e.coords[2]);if(t)L(!1,"vertex"),I?I.id!=e.id&&(I=e,S.position.set(i.x,i.y,i.z),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(I=e,S=k(i,T,!0),A.add(S),y.viewer.render(),y.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var r,o,a=!1,s=-1,l=0,d=E.length;l<d;l++)if(E[l].id==e.id){a=!0,s=l;break}null!=n&&1==n||"accumulate"==c?a?(r=E[s],E.splice(s,1),A.remove(b[s]),b[s]=null,b.splice(s,1),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"vertex",bodyId:r.bodyId,entityId:r.id}]})):(E.push(e),(o=k(i,T,!1))&&(A.add(o),b.push(o)),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"vertex",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(n=y.getAllSelectionInfors(),r=[],B(),a||(E.push(e),r.push({entityType:"vertex",bodyId:e.bodyId,entityId:e.id}),(o=k(i,T,!1))&&(A.add(o),b.push(o))),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:r,removed:n}))}}function Q(e,t,n,i){if(y.viewer.hasBrepInfo()){t=X(e,t,!0);if(t&&0<t.length){t=Z(t);if(null!=t)return void q(t,n,i)}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function J(e,t,n,i){if(y.viewer.hasBrepInfo()){e=X(e,t,!0);if(e&&0<e.length){t=e[0].bodyNode.type.toLowerCase();if("refpoint"==t||"refaxis"==t||"refplane"==t)return void V(e[0].bodyNode,n,i);t=Z(e);if(t)return void q(t,n,i);t=G(e);if(t)return void W(t,n,i);e=j(e);if(e)return void U(e,n,i)}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function K(e,t,n,i){if(y.viewer.hasBrepInfo()){e=X(e,t,!0);if(e&&0<e.length){if("refaxis"==e[0].bodyNode.type.toLowerCase())return void V(e[0].bodyNode,n,i);t=G(e);if(t){if("line"==t.type)return void W(t,n,i)}else{e=j(e);if(e&&"cylinder"==e.type)return void U(e,n,i)}}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function $(e,t,n,i){if(y.viewer.hasBrepInfo()){t=X(e,t,!0);if(t&&0<t.length){if("refaxis"==t[0].bodyNode.type.toLowerCase())return void V(t[0].bodyNode,n,i);t=G(t);if(null!=t&&"line"==t.type)return void W(t,n,i)}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function ee(e,t,n,i){if(y.viewer.hasBrepInfo()){e=X(e,t,!0);if(e&&0<e.length){t=e[0].bodyNode.type.toLowerCase();if("refaxis"==t||"refplane"==t)return void V(e[0].bodyNode,n,i);t=G(e);if(null!=t){if("line"==t.type)return void W(t,n,i)}else{e=j(e);if(e&&"plane"==e.type)return void U(e,n,i)}}n?L(!0):null!=i&&0!=i||y.clearSelection()}}function te(e){return null==e?null:e instanceof THREE.Object3D&&"Link"===e.type?e:te(e.parent)}this.selectedObjects=p,this.setSelectType=function(e){i=e},this.getSelectType=function(){return i},this.setSelectPolicy=function(e){c=e},this.getSelectPolicy=function(){return c},this.enableExclusivePicking=function(e,t){if(e)if(P=!(R=!0),C=null,t&&0<t.length){var n;O=[];for(var i=0;i<t.length;i++)(n=y.viewer.ndsModel.getBodyNodeFromUuid(t[i]))&&O.push(n)}else O=null;else R=!1,O=null},this.enableInclusivePicking=function(e,t){if(e)if(R=!(P=!0),O=null,t&&0<t.length){var n;C=[];for(var i=0;i<t.length;i++)(n=y.viewer.ndsModel.getBodyNodeFromUuid(t[i]))&&C.push(n)}else C=null;else P=!1,C=null},this.clearSelection1=function(){if(0!=a.length||0!=p.length||0!=h.length||0!=g||0!=E.length){for(var e,t=0;t<a.length;++t){var n=a[t].key,i=a[t].value;n.material=i}a.length=0,p.length=0,A.children.length=0,h.length=0,m.length=0,g.length=0,v.length=0,E.length=0,b.length=0,y.viewer.dispatchAsyncEvent({type:"clearSelection"}),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&((e=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:e[0],modelUnit:e[1]}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null}))}},this.clearSelection=function(){var e,t,n,i;(0!=a.length||0!=p.length||0!=h.length||0!=g||0!=E.length||y.viewer.ndsModel&&0!=y.viewer.ndsModel.selectedBodies.length)&&(e=0<p.length,n=y.getAllSelectionInfors(),B(),y.viewer.dispatchAsyncEvent({type:"clearSelection"}),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:n}),n="BodyVolume"!==(t=y.viewer.getCurrentMeasureType())&&"BodyArea"!==t,Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&e&&n&&((i=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:i[0],modelUnit:i[1]}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&!n&&((i=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:i[0],measureType:t,modelUnit:i[1]}):y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:t,modelUnit:null})))},this.clearPreSelection=function(e){L(e)},this.clearSelectedBrepEntities=function(){var e;0==h.length&&0==g&&0==E.length||(e=y.getAllSelectedBrepEntities(),A.children.length=0,h.length=0,m.length=0,g.length=0,v.length=0,E.length=0,b.length=0,y.viewer.dispatchAsyncEvent({type:"clearSelectedBrepEntities"}),y.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:e}))},this.changeSelectedObjectMaterial=function(e,t){var n=e.children;if((null==n||n.length<=0||e instanceof THREE.SkinnedMesh)&&!function(e){for(var t=0,n=a.length;t<n;++t)if(e==a[t].key)return!0;return!1}(e)&&null!=e.material){var i=e.material.clone();return i.oldMat=e.material,a.push(new ye.map(e,i)),e instanceof THREE.SkinnedMesh?t.skinning=!0:t.skinning=!1,void(e.material=t)}for(var r=0;r<n.length;++r)y.changeSelectedObjectMaterial(n[r],t)},this.selectObjectByList=function(e){for(var t=0;t<e.length;++t){var n=(y.viewer.ndsModel.objectidTouuid||y.viewer.ndsModel.meshManager.bodyUuids)[e[t]],i=y.viewer.ndsModel.getBodyNodeFromUuid(n);if(i||(n=y.viewer.ndsModel.meshManager.lineSegBodyUuids[e[t]],i=y.viewer.ndsModel.getBodyNodeFromUuid(n)),i&&!y.isObjectSelected(i))for(y.selectObject(i);i.parent&&y.viewer.ndsModel.isBodyAllChildSelected(i.parent);)y.selectObject(i.parent),i=i.parent}y.viewer.render()},this.selectObject=function(e,t){y.selectfromtree=t||!1;var n=e;y.viewer.ndsModel&&(n=y.viewer.ndsModel.getBodyNodeFromUuid(e.uuid)),y.viewer.outlinePass?y.viewer.outlinePass.selectedObjects=p:(Ue.selectedMaterial.colorWrite=!0,y.viewer.ndsModel?"refpoint"==(o=n.type.toLowerCase())||"refaxis"==o||"refplane"==o?n.select():(Ue.inBIMContext,y.viewer.ndsModel.meshManager.setSelectedMaterial(Ue.selectedMaterial,Ue.selectedLineMaterial),y.viewer.ndsModel.addSelection(n)):y.changeSelectedObjectMaterial(n,Ue.selectedMaterial));for(var i=!1,r=0;r<p.length;++r)if(n.uuid==p[r].uuid){i=!0;break}if(!i){for(r=0;r<p.length;++r)D(p[r],n)&&(p.splice(r,1),r--);p.push(n)}y.viewer.dispatchAsyncEvent({type:"selectObject",object:n,selectfromtree:y.selectfromtree});var o,a,t=y.viewer.getCurrentMeasureType(),e="BodyVolume"!==t&&"BodyArea"!==t?!0:!1;Ue.enableBodyVolumeMeasure&&(!y.viewer.hasBrepInfo()||y.viewer.productData)&&e&&((o=y.viewer.getSelectedObjectProperty(function(){}))&&1e-7<o.area?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:o,modelUnit:o.unit}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&!y.viewer.productData&&e&&((a=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:a[0],modelUnit:a[1]}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&!e&&((a=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:a[0],measureType:t,modelUnit:a[1]}):y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:t,modelUnit:null}))},this.isObjectSelected=function(e){if(e.parent&&this.isObjectSelected(e.parent))return!0;for(var t=0,n=p.length;t<n;++t)if(e.uuid==p[t].uuid)return!0;return!1},this.deselectObject=function(e){var t=e;y.viewer.ndsModel&&(t=y.viewer.ndsModel.getBodyNodeFromUuid(e.uuid)),y.viewer.ndsModel?"refpoint"==(d=t.type.toLowerCase())||"refaxis"==d||"refplane"==d?t.deSelect():y.viewer.ndsModel.removeSelection(t):y.restoreSelectedObjectMaterial(t);for(var n=0;n<p.length;++n)D(p[n],t)&&(p.splice(n,1),n--);for(var i=[],n=0;n<p.length;++n)if(D(t,p[n])){var r=null;y.viewer.ndsModel?r=y.viewer.ndsModel.getSelectedLeafBodyNodes(p[n]):function e(t,n){if(y.viewer.isLeaf(t)){for(var i=!1,r=y.getSelectedMeshes(),o=0,a=r.length;o<a;++o){var s=r[o].key;if(s.uuid==t.uuid||s.parent.uuid==t.uuid){i=!0;break}}i&&n.push(t)}else for(o=0,a=t.children.length;o<a;o++)e(t.children[o],n)}(p[n],r=[]);for(var o=0,a=r.length;o<a;++o)i.push(r[o]);p.splice(n,1),n--}for(var s=p.length,n=0,a=i.length;n<a;++n){for(var l=!1,o=0;o<s;o++)if(i[n].uuid==p[o].uuid){l=!0;break}l||p.push(i[n])}var d,c,h=y.viewer.getCurrentMeasureType(),e="BodyVolume"!==h&&"BodyArea"!==h?!0:!1;Ue.enableBodyVolumeMeasure&&(!y.viewer.hasBrepInfo()||y.viewer.productData)&&e&&((d=y.viewer.getSelectedObjectProperty(function(){}))&&1e-7<d.area?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:d,modelUnit:d.unit}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&!y.viewer.productData&&e&&((c=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:c[0],modelUnit:c[1]}):y.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),Ue.enableBodyVolumeMeasure&&y.viewer.hasBrepInfo()&&!e&&((c=y.getSelectedBodyVolumeAndArea())?y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:c[0],measureType:h,modelUnit:c[1]}):y.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:h,modelUnit:null}))},this.restoreSelectedObjectMaterial=function(e){var t=e.children;if(null==t||t.length<1||e instanceof THREE.SkinnedMesh)for(var n=0;n<a.length;n++)if(e.uuid==a[n].key.uuid){var i=a[n].value;return e.material=i,void 0!==e.material.colorWrite&&(4==(i=y.viewer.getRenderMode())||5==i?e.material.colorWrite=!0:6!=i&&7!=i||(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.material.colorWrite=!0:e.material.colorWrite=!1)),void a.splice(n,1)}for(n=0;n<t.length;++n)y.restoreSelectedObjectMaterial(t[n])},this.getSelectedMeshes=function(){return a},this.getSelectedObjects=function(){return p},this.hasTransformableObjectSelected=function(){for(var e=0,t=p.length;e<t;e++){var n=p[e].type.toLowerCase();if("assembly"==n||"component"==n||"part"==n)return!0}return!1},this.getSelectedFaceInfors=function(){for(var e=[],t=0,n=h.length;t<n;t++)e.push({bodyId:h[t].bodyId,faceId:h[t].id});return e},this.getSelectedEdgeInfors=function(){for(var e=[],t=0,n=g.length;t<n;t++)e.push({bodyId:g[t].bodyId,edgeId:g[t].id});return e},this.getSelectedVertexInfors=function(){for(var e=[],t=0,n=E.length;t<n;t++)e.push({bodyId:E[t].bodyId,vertexId:E[t].id});return e},this.getAllSelectionInfors=function(){for(var e=[],t=0,n=h.length;t<n;t++)(i={entityType:"face"}).bodyId=h[t].bodyId,i.entityId=h[t].id,e.push(i);for(t=0,n=g.length;t<n;t++)(i={entityType:"edge"}).bodyId=g[t].bodyId,i.entityId=g[t].id,e.push(i);for(t=0,n=E.length;t<n;t++)(i={entityType:"vertex"}).bodyId=E[t].bodyId,i.entityId=E[t].id,e.push(i);for(t=0,n=p.length;t<n;t++){var i,r=p[t].type.toLowerCase();"body"!=r&&"rawmesh"!=r&&"refpoint"!=r&&"refaxis"!=r&&"refplane"!=r||((i={}).entityType=p[t].type,i.bodyId=p[t].uuid,i.entityId="",e.push(i))}return e},this.getAllSelectedBrepEntities=function(){for(var e=[],t=0,n=h.length;t<n;t++)(i={entityType:"face"}).bodyId=h[t].bodyId,i.entityId=h[t].id,e.push(i);for(t=0,n=g.length;t<n;t++)(i={entityType:"edge"}).bodyId=g[t].bodyId,i.entityId=g[t].id,e.push(i);for(var i,t=0,n=E.length;t<n;t++)(i={entityType:"vertex"}).bodyId=E[t].bodyId,i.entityId=E[t].id,e.push(i);return e},this.selectBrepEntities=function(e,t){if(y.viewer.hasBrepInfo()){t&&B();for(var n=0,i=e.length;n<i;n++)if("face"==e[n].entityType){for(var r,o=!1,a=0;a<h.length;a++)if(e[n].bodyId==h[a].bodyId&&e[n].entityId==h[a].id){o=!0;break}o||(r=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(h.push(r),(s=N(r,!1))&&(A.add(s),m.push(s)))}else if("edge"==e[n].entityType){for(var s,o=!1,a=0;a<g.length;a++)if(e[n].bodyId==g[a].bodyId&&e[n].entityId==g[a].id){o=!0;break}o||(s=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(g.push(s),(l=F(s,!1))&&(A.add(l),v.push(l)))}else if("vertex"==e[n].entityType){for(var l,o=!1,a=0;a<E.length;a++)if(e[n].bodyId==E[a].bodyId&&e[n].entityId==E[a].id){o=!0;break}o||(l=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(E.push(l),(l=k(new THREE.Vector3(l.coords[0],l.coords[1],l.coords[2]),T,!1))&&(A.add(l),b.push(l)))}}},this.deselectBrepEntities=function(e){for(var t=0,n=e.length;t<n;t++)if("face"==e[t].entityType){for(var i=0;i<h.length;i++)if(e[t].bodyId==h[i].bodyId&&e[t].entityId==h[i].id){h.splice(i,1),A.remove(m[i]),m[i]=null,m.splice(i,1);break}}else if("edge"==e[t].entityType){for(i=0;i<g.length;i++)if(e[t].bodyId==g[i].bodyId&&e[t].entityId==g[i].id){g.splice(i,1),A.remove(v[i]),v[i]=null,v.splice(i,1);break}}else if("vertex"==e[t].entityType)for(i=0;i<E.length;i++)if(e[t].bodyId==E[i].bodyId&&e[t].entityId==E[i].id){E.splice(i,1),A.remove(b[i]),b[i]=null,b.splice(i,1);break}},this.selectEntities=function(e,t){if(y.viewer.hasBrepInfo()){t&&B();for(var n=0,i=e.length;n<i;n++){var r=e[n].entityType.toLowerCase();if("face"==r){for(var o,a=!1,s=0;s<h.length;s++)if(e[n].bodyId==h[s].bodyId&&e[n].entityId==h[s].id){a=!0;break}a||(o=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(h.push(o),(l=N(o,!1))&&(A.add(l),m.push(l)))}else if("edge"==r){for(var l,a=!1,s=0;s<g.length;s++)if(e[n].bodyId==g[s].bodyId&&e[n].entityId==g[s].id){a=!0;break}a||(l=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(g.push(l),(d=F(l,!1))&&(A.add(d),v.push(d)))}else if("vertex"==r){for(var d,a=!1,s=0;s<E.length;s++)if(e[n].bodyId==E[s].bodyId&&e[n].entityId==E[s].id){a=!0;break}a||(d=y.viewer.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[n].bodyId,e[n].entityId,e[n].entityType))&&(E.push(d),(d=k(new THREE.Vector3(d.coords[0],d.coords[1],d.coords[2]),T,!1))&&(A.add(d),b.push(d)))}else"refplane"!=r&&"refaxis"!=r||y.viewer.ndsModel&&(r=y.viewer.ndsModel.getBodyNodeFromUuid(e[n].bodyId),y.isObjectSelected(r)||(r.select(),p.push(r)))}}},this.deselectEntities=function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t].entityType.toLowerCase();if("face"==i){for(var r=0;r<h.length;r++)if(e[t].bodyId==h[r].bodyId&&e[t].entityId==h[r].id){h.splice(r,1),A.remove(m[r]),m[r]=null,m.splice(r,1);break}}else if("edge"==i){for(r=0;r<g.length;r++)if(e[t].bodyId==g[r].bodyId&&e[t].entityId==g[r].id){g.splice(r,1),A.remove(v[r]),v[r]=null,v.splice(r,1);break}}else if("vertex"==i){for(r=0;r<E.length;r++)if(e[t].bodyId==E[r].bodyId&&e[t].entityId==E[r].id){E.splice(r,1),A.remove(b[r]),b[r]=null,b.splice(r,1);break}}else if(("refplane"==i||"refaxis"==i)&&y.viewer.ndsModel){var o=y.viewer.ndsModel.getBodyNodeFromUuid(e[t].bodyId);o.deSelect();for(r=0;r<p.length;r++)if(p[r].uuid==o.uuid){p.splice(r,1);break}}}},this.computeTargetList=function(e){u.length=0,o.length=0,f.length=0,s(e,u)},this.addToTargetList=function(e){s(e,u)},this.getTargetList=function(){return u},this.getTargetLineList=function(){return o},this.getTargetIncludeLineList=function(){return f},this.getLineObjectFromUUid=function(e){for(var t=0,n=o.length;t<n;t++){var i=o[t];if(i&&i.uuid==e)return i}return null},this.getSelectedComponent=function(){if(0<p.length){var e=p[0];if(this.viewer.ndsModel){for(var t=e.parent,n=t?t.parent:null,i=e;null!=t&&null!=n&&("model"!=n.type||"assembly"!=t.type);)n=(t=(i=t).parent)?t.parent:null;return i}}return null},this.findParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D){var t=e.type.toLowerCase();if(y.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var n=e.parent;null!=n&&null!=n;)"instanceobject"==n.type.toLowerCase()&&(e=n),n=n.parent;return Ue.selectObjectWithPropertyOnly&&!e.propertyfile?this.findParentElement(e.parent):e}return this.findParentElement(e.parent)}return this.findParentElement(e.parent)},this.getPickIntersects=function(e,t){var n=y.viewer,i=n.renderer.domElement,r=n.renderer.getPixelRatio(),e=e*r/i.width*2-1,r=2*-(t*r/i.height)+1,i=new THREE.Raycaster;n.camera.setCastRay(i,e,r);return n.ndsModel?n.ndsModel.intersect(i.ray):i.intersectObjects(u)},this.selectByClick=function(e,t,n){"component"==i?function(e,t,n){var i=y.viewer,r=X(e,t,!1);if(r&&0<r.length){var o=null;if(i.ndsModel){var a=(o=r[0].bodyNode).parent,s=a?a.parent:null;for(o=null;null!=a&&null!=s&&("model"!=s.type||"assembly"!=a.type);)s=(a=(o=a).parent)?a.parent:null}null!=o&&(null!=n&&1==n?y.isObjectSelected(o)?(y.deselectObject(o),i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"component",bodyId:o.uuid,entityId:""}]})):(y.selectObject(o),i.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:o.uuid,entityId:""}],removed:[]})):y.isObjectSelected(o)?(y.clearSelection(),i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t})):(y.clearSelection(),y.selectObject(o),i.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:o.uuid,entityId:""}],removed:[]})))}else null!=n&&0!=n||(n=!1,0<p.length&&(n=!0),y.clearSelection(),n&&i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t}))}(e,t,n):"body"==i?function(e,t,n){var i=y.viewer,r=X(e,t,!1);if(r&&0<r.length){var o=null;if(i.ndsModel){if(o=r[0].bodyNode,Ue.selectObjectWithPropertyOnly&&!o.propertyfile){var a=o.parent;for(o=null;null!=a&&null!=a;){if(a.propertyfile){o=a;break}a=a.parent}}}else null==(o=y.findParentElement(r[0].object))&&(o=r[0].object);null!=o&&(null!=n&&1==n?y.isObjectSelected(o)?(y.deselectObject(o),i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"body",bodyId:o.uuid,entityId:""}]})):(y.selectObject(o),i.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"body",bodyId:o.uuid,entityId:""}],removed:[]})):y.isObjectSelected(o)?(y.clearSelection(),i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t})):(y.clearSelection(),y.selectObject(o),i.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:e,clickPosY:t}),i.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"body",bodyId:o.uuid,entityId:""}],removed:[]})))}else null!=n&&0!=n||(n=!1,0<p.length&&(n=!0),y.clearSelection(),n&&i.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:e,clickPosY:t}))}(e,t,n):"face"==i?z(e,t,!1,n,!1):"edge"==i?Y(e,t,!1,n):"vertex"==i?Q(e,t,!1,n):"plane"==i?z(e,t,!1,n,!0):"axis"==i?K(e,t,!1,n):"line"==i?$(e,t,!1,n):"line_plane"==i?ee(e,t,!1,n):"vertex_edge_face"==i&&J(e,t,!1,n)},this.selectOnMouseMove=function(e,t){"vertex"==i?Q(e,t,!0):"edge"==i?Y(e,t,!0):"face"==i?z(e,t,!0,void 0,!1):"plane"==i?z(e,t,!0,void 0,!0):"axis"==i?K(e,t,!0):"line"==i?$(e,t,!0):"line_plane"==i?ee(e,t,!0):"vertex_edge_face"==i&&J(e,t,!0)},this.renderSelectionScene=function(e,t){if(0<A.children.length){for(var n=0;n<A.children.length;n++){var i=A.children[n];null!=i.objectType&&"Point"===i.objectType&&_(i,T)}e?this.viewer.renderer.render(r,this.viewer.camera,e,t):this.viewer.renderer.render(r,this.viewer.camera)}},this.selectObjectByUuid=function(e,t){t=function e(t,n,i){var r=null;var o=n.children;if(null==o)return r;for(var a=0,s=o.length;a<s;++a){var l=o[a];if(l.uuid==t){if(!i){r=l;break}var d=te(l);if(d&&i==d.uuid){r=l;break}}else if(null!=(r=e(t,l,i)))break}return r}(e,y.scene,t);null!=t&&(y.clearSelection(),y.selectObject(t))}}var e,n,i;return e=t,(n=[{key:"getSelectedBodyVolumeAndArea",value:function(){var l=this,e=function e(t,n){for(var i=0,r=t.length;i<r;i++)if("body"==t[i].type.toLowerCase()){for(var o,a=!1,s=0;s<l.selectedObjects.length;++s)if(t[i].uuid==l.selectedObjects[s].uuid){a=!0;break}a&&l.selectedObjects!=t||(o=l.viewer.brepManager.GetBodyVolumeAndArea(t[i].uuid))&&(n.volume+=o.volume,n.area+=o.area)}else{for(a=!1,s=0;s<l.selectedObjects.length;++s)if(t[i].uuid==l.selectedObjects[s].uuid){a=!0;break}(!a||l.selectedObjects==t)&&0<t[i].children.length&&e(t[i].children,n)}};if(this.viewer.hasBrepInfo()&&0<this.selectedObjects.length){var t={volume:0,area:0};if(e(this.selectedObjects,t),1e-7<t.area){e=this.viewer.getDispalyModelUnit(t.volume,t.area);return t.volume=t.volume*e.scale*e.scale*e.scale,t.area=t.area*e.scale*e.scale,[t,e.unit]}return null}return null}}])&&Qt(e.prototype,n),i&&Qt(e,i),t}(),Kt=function(e){var t=this;this.viewer=e;var n=new NDS.Element({className:"stater"});n.setVisibility(!1),e.container.appendChild(n.domElement);var i=new NDS.Element({className:"stater-title",text:"Loading..."});n.domElement.appendChild(i.domElement);var r=new NDS.Button({className:"stater-button",text:"Cancel"});n.domElement.appendChild(r.domElement);r.domElement.addEventListener("click",o,!1);function o(e){t.dispatchEvent({type:"cancel"})}this.show=function(e){n.setVisibility(e),e||r.setVisibility(e)},this.setText=function(e){i.setText(e)},this.setBtnCancelShow=function(e){r.setVisibility(e)}};Kt.prototype=Object.create(THREE.EventDispatcher.prototype);var $t=function(e){var t=this;this.viewer=e;var n=new NDS.Menu({id:"menuView",className:"menu",callbackEvent:i});function i(e){switch(n.setVisibility(!1),e.target.domElement.id){case"itemIsolate":"click"===e.event.type&&t.viewer.isolateSelectedObjects();break;case"itemHide":"click"===e.event.type&&t.viewer.hideSelectedObjects();break;case"itemShowAll":"click"===e.event.type&&t.viewer.showAllModel();break;case"itemProperty":"click"===e.event.type&&t.viewer.getSelectedObjectProperty(function(e){null!=e&&alert(JSON.stringify(e))});break;case"itemTransparent":"click"===e.event.type&&t.viewer.transparentSelectedObjects()}}n.setVisibility(!1),e.container.appendChild(n.domElement),(e.menuView=n).addItem({id:"itemIsolate",text:ye.translateString("IDS_RMB_ISOLATE"),className:"menuItem",callbackEvent:i}),n.addItem({id:"itemHide",text:ye.translateString("IDS_RMB_HIDE"),className:"menuItem",callbackEvent:i}),n.addItem({id:"itemShowAll",text:ye.translateString("IDS_RMB_SHOWALL"),className:"menuItem",callbackEvent:i}),n.addItem({id:"itemTransparent",text:"透明",className:"menuItem",callbackEvent:i}),n.addItem({id:"itemProperty",text:ye.translateString("IDS_RMB_PROPERTY"),className:"menuItem",callbackEvent:i})},en=function(e,t){this.viewer=e;var n="waiter_"+Date.now(),i=new NDS.Element({className:"waiter",id:n});i.setVisibility(!1);var r=new NDS.Element({className:"bounce1"}),o=new NDS.Element({className:"bounce2"}),n=new NDS.Element({className:"bounce3"});void 0!==t&&(r.setBgColor(t),o.setBgColor(t),n.setBgColor(t)),i.addSubElement(r),i.addSubElement(o),i.addSubElement(n),e.container.appendChild(i.domElement),e.waiter=i};function tn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var nn=function(l){this.viewer=l,this.pdfInfo={fileName:"temp",colorType:"color",size:"A4",width:297,height:210,orientation:"l",align:0,xAlign:0,yAlign:0,scale:1,xSelMin:0,xSelMax:0,ySelMin:0,ySelMax:0,xLen:0,yLen:0};this.fontSaveArray=[],this.fontArray=[],this.colorArray=[],this.lineStyleArray=[],this.uuidToTextInfo={},this.linePointArray={},this.meshPointArray=[],this.textPointArray=[],this.pointPointArray={},this.totalPointNum=0,this.textInfoArray=[],this.OldLineStyle=null,this.textVersion=1,this.textBufferchunks=null,this.textMaterials=null,this.textObject=null,this.textBufferchunks2=null,this.textFonts=null,this.textFontMap=!1,this.saveTextForPDF=function(e,t){this.textVersion=t,this.textBufferchunks=null,this.textMaterials=null,this.textObject=null,this.textBufferchunks2=null,this.textFonts=null,this.textFontMap=!1,1==this.textVersion?(this.textBufferchunks=e.bufferchunks,this.textMaterials=e.materials,this.textObject=e.object):(this.textBufferchunks2=e.bufferchunks,this.textFonts=e.fonts)},this.getUUidToTextInfo=function(e){var r=this;if(0==this.textFontMap)if(1==this.textVersion){for(var o={},a={},t=0;t<this.textBufferchunks.length;t++)for(var n=0;n<this.textBufferchunks[t].geometries.length;n++){var i,s=this.textBufferchunks[t].geometries[n];"TextGeometry"==s.type&&(i=this.getFontSaveTableId(s.textFont),a[s.uuid]={text:s.text,isChina:s.isChina,fontId:i,colorHex:null,position:null,angle:null})}for(var l=0;l<this.textMaterials.length;l++)o[this.textMaterials[l].uuid]=this.textMaterials[l].color;var d=new THREE.Color;(function e(t){for(var n,i=0;i<t.children.length;i++)t.children[i].children?e(t.children[i]):(d.setHex(parseInt(o[t.children[i].material])),(n=a[t.children[i].geometry])&&(r.uuidToTextInfo[t.children[i].uuid]={text:n.text,isChina:n.isChina,fontId:n.fontId,colorHex:d.clone(),position:t.children[i].position,angle:t.children[i].angle}))})(this.textObject)}else{if(!this.textFonts)return;for(var c={},h=0;h<this.textFonts.length;h++)c[this.textFonts[h].uuid]={uuid:this.textFonts[h].uuid,bigName:this.textFonts[h].bigName,name:this.textFonts[h].name,size:this.textFonts[h].size,width:this.textFonts[h].width,style:this.textFonts[h].style,weight:this.textFonts[h].weight};for(var u=0;u<this.textBufferchunks2.length;u++)for(var f=0;f<this.textBufferchunks2[u].geometries.length;f++){var p,m=this.textBufferchunks2[u].geometries[f];"TextGeometry"==m.type&&(p=c[m.textFont],p=this.getFontSaveTableId(p||m.textFont),this.uuidToTextInfo[m.uuid]={text:m.text,isChina:m.isChina,fontId:p,colorHex:null,position:new THREE.Vector3(m.position.x,m.position.y,m.position.z),angle:m.angle,isMirroredInX:m.isMirroredInX,isMirroredInY:m.isMirroredInY})}}return this.textFontMap=!0,this.uuidToTextInfo[e]},this.setPDFInfo=function(e,t,n,i,r,o){var a,s;this.viewer.is2DModel&&(a=this.viewer.getCameraInfo(),s=new THREE.Vector3(a.up.x,a.up.y,a.up.z),this.rad=-s.angleTo(new THREE.Vector3(0,1,0)),this.matrixWorld=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),this.rad),this.transPosition=new THREE.Vector3(a.target.x,a.target.y,0),this.totalPointNum=0,this.pdfInfo.fileName=e||"temp",this.pdfInfo.size=t||"A4",this.pdfInfo.orientation=n||"l",this.pdfInfo.colorType=i||"color",s=new THREE.Matrix4,(a=new THREE.Matrix4).makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),s.premultiply(a),s.premultiply(this.matrixWorld),a.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),s.premultiply(a),e=new THREE.Vector3,t=new THREE.Vector3,"view"==r?(n=l.renderer.getPixelRatio(),i=this.viewer.renderer.domElement.width/n,a=this.viewer.renderer.domElement.height/n,n=tn(this.viewer.clientCoordToModelCoord([0,0]),2),e.x=n[0],e.y=n[1],a=tn(this.viewer.clientCoordToModelCoord([i,a]),2),t.x=a[0],t.y=a[1],e.applyMatrix4(s),t.applyMatrix4(s),this.pdfInfo.xSelMin=(e.x>t.x?t:e).x,this.pdfInfo.xSelMax=(e.x<t.x?t:e).x,this.pdfInfo.ySelMin=(e.y>t.y?t:e).y,this.pdfInfo.ySelMax=(e.y<t.y?t:e).y):"select"==r?(o[0]!=o[2]&&o[1]!=o[3]||(o[2]+=.01,o[3]+=.01),r=tn(this.viewer.clientCoordToModelCoord([o[0],o[1]]),2),e.x=r[0],e.y=r[1],o=tn(this.viewer.clientCoordToModelCoord([o[2],o[3]]),2),t.x=o[0],t.y=o[1],e.applyMatrix4(s),t.applyMatrix4(s),this.pdfInfo.xSelMin=(e.x>t.x?t:e).x,this.pdfInfo.xSelMax=(e.x<t.x?t:e).x,this.pdfInfo.ySelMin=(e.y>t.y?t:e).y,this.pdfInfo.ySelMax=(e.y<t.y?t:e).y):(this.textflag=!0,s=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0),this.getBoundingBox(s,t,this.textflag),0<(e=this.calcTextRect()).length&&(this.textflag?(this.textflag=!1,s.x=e[0],s.y=e[1],t.x=e[2],t.y=e[3]):(e[0]<s.x&&(s.x=e[0]),e[1]<s.y&&(s.y=e[1]),e[2]>t.x&&(t.x=e[2]),e[3]>t.y&&(t.y=e[3]))),this.pdfInfo.xSelMin=s.x-.001,this.pdfInfo.ySelMin=s.y-.001,this.pdfInfo.xSelMax=t.x+.001,this.pdfInfo.ySelMax=t.y+.001),this.setPaperSize(this.pdfInfo.size,this.pdfInfo.orientation),this.setAlign(),this.drawPDFInfo())},this.getBoundingBox=function(e,t,n){this.viewer.ndsModel.setDirty();for(var i=0,r=this.viewer.ndsModel.meshManager.getNumInstancedMeshes();i<r;++i){var o=this.viewer.ndsModel.meshManager.getInstancedMesh(i);o&&(o.geometry.updateModelMatrix=!0)}for(var a=this.viewer.ndsModel.getMeshSets(),s=[],l=[],d=!1,c=0;c<a.length;++c)s.push(c);for(var h=0,u=s.length;h<u;++h){for(var f=a[s[h]],p=0,m=f.getNumMeshes();p<m;++p){var g=f.getMesh(p);if(g){var v=g.geometry;if(!(v.bufferLength<=0)){var y=new THREE.Matrix4,E=new THREE.Matrix4;if(0<g.instancedCount)for(var b=0;b<g.instancedCount;b++){y.fromArray(g.matrixWorlds,16*b),E.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),y.premultiply(E),y.premultiply(this.matrixWorld),E.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),y.premultiply(E);var M=v.boundingBox.min.clone().applyMatrix4(y),x=v.boundingBox.max.clone().applyMatrix4(y);this.textflag?(this.textflag=!1,e.x=M.x,e.y=M.y,t.x=x.x,t.y=x.y):(M.x<e.x&&(e.x=M.x),M.y<e.y&&(e.y=M.y),x.x>t.x&&(t.x=x.x),x.y>t.y&&(t.y=x.y))}else{y.copy(g.matrixWorld),E.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),y.premultiply(E),y.premultiply(this.matrixWorld),E.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),y.premultiply(E);var w=v.boundingBox.min.clone().applyMatrix4(y),I=v.boundingBox.max.clone().applyMatrix4(y);this.textflag?(this.textflag=!1,e.x=w.x,e.y=w.y,t.x=I.x,t.y=I.y):(w.x<e.x&&(e.x=w.x),w.y<e.y&&(e.y=w.y),I.x>t.x&&(t.x=I.x),I.y>t.y&&(t.y=I.y))}}}}for(var S=0,T=f.getNumTexts();S<T;++S){var A=f.getText(S);if(A&&A.geometry){var R=new THREE.Vector3(0,0,0),O=this.getUUidToTextInfo(A.geometry.uuid),P={bigName:this.fontSaveArray[O.fontId].bigName,name:this.fontSaveArray[O.fontId].name,size:this.fontSaveArray[O.fontId].size,style:this.fontSaveArray[O.fontId].style,weight:this.fontSaveArray[O.fontId].weight,width:this.fontSaveArray[O.fontId].width},C=new THREE.Matrix4,B=new THREE.Matrix4,L=new THREE.Vector3,D=new THREE.Quaternion,H=new THREE.Vector3;if(0<A.instancedCount)for(var N=0;N<A.instancedCount;N++)C.fromArray(A.matrixWorlds,16*N),C.decompose(L,D,H),B.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),C.premultiply(B),C.premultiply(this.matrixWorld),B.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),C.premultiply(B),R.set(0,0,0),R.applyMatrix4(C),this.calcRect(O.text,O.angle,P,R,l,d,H.x),d=!0;else C.copy(A.matrixWorld),C.decompose(L,D,H),B.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),C.premultiply(B),C.premultiply(this.matrixWorld),B.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),C.premultiply(B),R.applyMatrix4(C),this.calcRect(O.text,O.angle,P,R,l,d,H.x),d=!0}}}0<l.length&&(this.textflag?(this.textflag=!1,e.x=l[0],e.y=l[1],t.x=l[2],t.y=l[3]):(l[0]<e.x&&(e.x=l[0]),l[1]<e.y&&(e.y=l[1]),l[2]>t.x&&(t.x=l[2]),l[3]>t.y&&(t.y=l[3])));for(var F=this.viewer.ndsModel.getLineSegmentsSet(),_=0,k=F.getNumLineSegments();_<k;++_){var V,j,U,z=F.getLineSegments(_);z&&((V=z.geometry).bufferLength<=0||(U=new THREE.Matrix4,j=new THREE.Matrix4,U.copy(z.matrixWorld),j.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),U.premultiply(j),U.premultiply(this.matrixWorld),j.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),U.premultiply(j),j=V.boundingBox.min.clone().applyMatrix4(U),U=V.boundingBox.max.clone().applyMatrix4(U),this.textflag?(this.textflag=!1,e.x=j.x,e.y=j.y,t.x=U.x,t.y=U.y):(j.x<e.x&&(e.x=j.x),j.y<e.y&&(e.y=j.y),U.x>t.x&&(t.x=U.x),U.y>t.y&&(t.y=U.y))))}},this.setPaperSize=function(e,t){switch(e){case"A5":var n=[210,148];this.pdfInfo.width=n[0],this.pdfInfo.height=n[1];break;case"A4":var i=[297,210];this.pdfInfo.width=i[0],this.pdfInfo.height=i[1];break;case"A3":i=[420,297];this.pdfInfo.width=i[0],this.pdfInfo.height=i[1];break;case"A2":var r=[594,420];this.pdfInfo.width=r[0],this.pdfInfo.height=r[1];break;case"A1":r=[841,594];this.pdfInfo.width=r[0],this.pdfInfo.height=r[1];break;case"A0":var o=[1189,841];this.pdfInfo.width=o[0],this.pdfInfo.height=o[1];break;default:o=[297,210];this.pdfInfo.width=o[0],this.pdfInfo.height=o[1]}"l"!=t&&(t=this.pdfInfo.width,this.pdfInfo.width=this.pdfInfo.height,this.pdfInfo.height=t)},this.getPaperSize=function(){return["A5","A4","A3","A2","A1","A0"]},this.setAlign=function(){this.pdfInfo.xLen=this.pdfInfo.xSelMax-this.pdfInfo.xSelMin,this.pdfInfo.yLen=this.pdfInfo.ySelMax-this.pdfInfo.ySelMin;var e=this.pdfInfo.xLen/this.pdfInfo.yLen;this.pdfInfo.height,this.pdfInfo.width;e>this.pdfInfo.width/this.pdfInfo.height?(this.pdfInfo.xAlign=0,this.pdfInfo.yAlign=(this.pdfInfo.height-this.pdfInfo.width/e)/2,this.pdfInfo.scale=(this.pdfInfo.height-2*this.pdfInfo.yAlign)/this.pdfInfo.yLen):(this.pdfInfo.xAlign=(this.pdfInfo.width-this.pdfInfo.height*e)/2,this.pdfInfo.yAlign=0,this.pdfInfo.scale=(this.pdfInfo.width-2*this.pdfInfo.xAlign)/this.pdfInfo.xLen)},this.normalize=function(e){e.x=(e.x-this.pdfInfo.xSelMin)/this.pdfInfo.xLen,e.y=(e.y-this.pdfInfo.ySelMin)/this.pdfInfo.yLen},this.convertToPDFCood=function(e,t,n){var i,r,o=this.pdfInfo.width-2*this.pdfInfo.xAlign,a=this.pdfInfo.height-2*this.pdfInfo.yAlign,s=e.x*o+this.pdfInfo.xAlign,e=(1-e.y)*a+this.pdfInfo.yAlign;return t&&(i=t.x*o+this.pdfInfo.xAlign,r=(1-t.y)*a+this.pdfInfo.yAlign),n?[s,e,i,r,n.x*o+this.pdfInfo.xAlign,(1-n.y)*a+this.pdfInfo.yAlign]:t?[s,e,i,r]:[s,e]},this.colorTest=function(e){16777215==e.getHex()&&e.setHex(16777215-e.getHex())},this.getFontSaveTableId=function(e){for(var t,n=0;n<this.fontSaveArray.length;n++)if((t=this.fontSaveArray[n]).name==e.name&&t.bigName==e.bigName&&t.style==e.style&&t.weight==e.weight&&Math.abs(t.size-e.size)<1e-8&&Math.abs(t.width-e.width)<1e-8)return n;return this.fontSaveArray.push(e),this.fontSaveArray.length-1},this.getFontTableId=function(e){for(var t,n=0;n<this.fontArray.length;n++)if((t=this.fontArray[n]).name==e.name&&t.bigName==e.bigName&&t.style==e.style&&t.weight==e.weight&&Math.abs(t.size-e.size)<1e-8&&Math.abs(t.width-e.width)<1e-8)return n;return this.fontArray.push({bigName:e.bigName,name:e.name,style:e.style,weight:e.weight,size:e.size,width:e.width}),this.fontArray.length-1},this.getColorTableId=function(e){this.colorTest(e);for(var t=e.getHexString(),n=0;n<this.colorArray.length;n++)if(this.colorArray[n]==t)return n;return this.colorArray.push(t),this.colorArray.length-1},this.getOldLineStyleData=function(e){switch(parseInt(e)){case NDS.DASHTYPE.DASH:return[12,-3];case NDS.DASHTYPE.DASHSPACE:return[12,-18];case NDS.DASHTYPE.LONGDASH_DOT:return[24,-3,.5,-3];case NDS.DASHTYPE.LONGDASH_DOUBLEDOT:return[24,-3,.5,-3,.5,-3];case NDS.DASHTYPE.LONGDASH_TRIPLEDOT:return[24,-3,.5,-3,.5,-3,.5,-3];case NDS.DASHTYPE.DOT0:return[.5,-3];case NDS.DASHTYPE.LONGDASH_SHORTDASH:return[24,-3,6,-3];case NDS.DASHTYPE.LONGDASH_DOUBLESHORTDASH:return[24,-3,6,-3,6,-3];case NDS.DASHTYPE.DASH_DOT:return[12,-3,.5,-3];case NDS.DASHTYPE.DOUBLEDASH_DOT:return[12,-3,12,-3,.5,-3];case NDS.DASHTYPE.DASH_DOUBLEDOT:return[12,-3,.5,-3,.5,-3];case NDS.DASHTYPE.DOUBLEDASH_DOUBLEDOT:return[12,-3,12,-3,.5,-3,.5,-3];case NDS.DASHTYPE.DASH_TRIPLEDOT:return[12,-3,.5,-3,.5,-3,.5,-3];case NDS.DASHTYPE.DOUBLEDASH_TRIPLEDOT:return[12,-3,12,-3,.5,-3,.5,-3,.5,-3];case NDS.DASHTYPE.BATTING:return[12,-3,.5,-3];case NDS.DASHTYPE.BORDER:return[12,-3,12,-3,.5,-3];case NDS.DASHTYPE.BORDER2:return[6,-3,6,-3,.5,-3];case NDS.DASHTYPE.BORDERX2:return[24,-3,24,-3,.5,-3];case NDS.DASHTYPE.CENTER:return[24,-6,6,-6];case NDS.DASHTYPE.CENTER2:return[12,-3,3,-3];case NDS.DASHTYPE.CENTERX2:return[48,-6,6,-6];case NDS.DASHTYPE.DASHDOT:return[12,-3,.5,-3];case NDS.DASHTYPE.DASHDOT2:return[6,-1.5,.5,-1.5];case NDS.DASHTYPE.DASHDOTX2:return[24,-6,.5,-6];case NDS.DASHTYPE.DASHED:return[12,-6];case NDS.DASHTYPE.DASHED2:return[6,-3];case NDS.DASHTYPE.DASHEDX2:return[24,-12,.5,-12,.5,-12];case NDS.DASHTYPE.DIVIDE:return[12,-6,.5,-6,.5,-6];case NDS.DASHTYPE.DIVIDE2:return[6,-3,.5,-3,.5,-3];case NDS.DASHTYPE.DIVIDEX2:return[24,-12,.5,-12,.5,-12];case NDS.DASHTYPE.DOT:return[.5,-6];case NDS.DASHTYPE.DOT2:return[.5,-3];case NDS.DASHTYPE.DOTX2:return[.5,-12];case NDS.DASHTYPE.FENCELINE1:case NDS.DASHTYPE.FENCELINE2:case NDS.DASHTYPE.GAS_LINE:return[12,-3,.5,-3];case NDS.DASHTYPE.HIDDEN:return[6,-3];case NDS.DASHTYPE.HIDDEN2:return[3,-1.5];case NDS.DASHTYPE.HIDDENX2:return[12,-6];case NDS.DASHTYPE.HOT_WATER_SUPPLY:return[12,-3,.5,-3];case NDS.DASHTYPE.JIS_02_07:return[.84,-.51];case NDS.DASHTYPE.JIS_02_10:return[1.2,-.6];case NDS.DASHTYPE.JIS_02_12:return[1.44,-.66];case NDS.DASHTYPE.JIS_02_20:return[2.4,-.78];case NDS.DASHTYPE.JIS_02_40:return[4.8,-1.5];case NDS.DASHTYPE.JIS_08_11:return[11,-3,.7,-3];case NDS.DASHTYPE.JIS_08_15:return[15,-3,.7,-3];case NDS.DASHTYPE.JIS_08_25:return[25,-3,.7,-3];case NDS.DASHTYPE.JIS_08_37:return[37,-1,.7,-1];case NDS.DASHTYPE.JIS_08_50:return[50,-1.4,.7,-1.4];case NDS.DASHTYPE.JIS_09_08:return[8,-.9,.5,-.9,.5,-.9];case NDS.DASHTYPE.JIS_09_15:return[15,-.9,.5,-.9,.5,-.9];case NDS.DASHTYPE.JIS_09_29:return[29,-.9,.5,-.9,.5,-.9];case NDS.DASHTYPE.JIS_09_50:return[50,-.9,.5,-.9,.5,-.9];case NDS.DASHTYPE.PHANTOM:return[31,-6,6,-6,6,-6];case NDS.DASHTYPE.PHANTOM2:return[15,-3,3,-3,3,-3];case NDS.DASHTYPE.PHANTOMX2:return[60,-12,12,-12,12,-12];default:return[12,-3,.5,-3]}},this.getOldLineStyleTableId=function(e){if(e<1||998<e)return-1;for(var t=0;t<this.lineStyleArray.length;t++)if(this.lineStyleArray[t].lineTypeId==e)return t;return this.lineStyleArray.push({lineTypeId:e,data:this.getOldLineStyleData(e),scale:1}),this.lineStyleArray.length-1},this.getLineStyleTableId=function(e,t){for(var n=0;n<this.lineStyleArray.length;n++)if(this.lineStyleArray[n].lineTypeId==e&&Math.abs(this.lineStyleArray[n].scale-t)<1e-8)return n;return this.lineStyleArray.push({lineTypeId:e,data:this.viewer.lineTypes.getLineStyleArray(e),scale:t}),this.lineStyleArray.length-1},this.drawPDFInfo=function(){this.viewer.selectionManager.clearSelection(),this.viewer.ndsModel.setDirty();this.drawMesh();var e=this.drawLine();if(this.viewer.pmiObject){for(var t=this.viewer.ndsModel.getLayerBodies(this.viewer.ndsModel.rootBodyNode),n=0,i=t.length;n<i;++n){var r=t[n];if(r.visible&&r.pmiuuid)for(var o=0;o<r.pmiuuid.length;++o)this.drawText(r.pmiuuid[o])}for(var a=this.viewer.SDFMaker.GetLines(),s=new THREE.Vector3,l=new THREE.Vector3,d=0;d<a.length;d++)for(var c=new THREE.Color(a[d].material.color.getHex()),h=this.getColorTableId(c),u=a[d].geometry.vertices,f=0;f<u.length;f+=2){s.copy(u[f]),l.copy(u[f+1]),this.normalize(s),this.normalize(l);var p,m,g,v,y=this.clipLine(s,l);0<y.length&&(p=(v=tn(this.convertToPDFCood(y[0],y[1]),4))[0],m=v[1],g=v[2],y=v[3],(v=this.linePointArray[e])||(v=new Array,this.linePointArray[e]=v),v.push(p,m,g,y,h,-1),this.totalPointNum+=6)}}},this.drawMesh=function(){for(var e=0,t=0,n=this.viewer.ndsModel.meshManager.getNumInstancedMeshes();t<n;++t){var i=this.viewer.ndsModel.meshManager.getInstancedMesh(t);i&&(i.geometry.updateModelMatrix=!0)}for(var r=this.viewer.ndsModel.getMeshSets(),o=[],a=0;a<r.length;++a)o.push(a);this.viewer.ndsModel.sortMeshSets(o,this.viewer.camera);for(var s=0,l=o.length;s<l;++s){for(var d=r[o[s]],c=0,h=d.getNumMeshes();c<h;++c){var u=d.getMesh(c);if(u&&u.geometry){var f=new THREE.Matrix4,p=new THREE.Matrix4;if(0<u.instancedCount)for(var m=0;m<u.instancedCount;m++)f.fromArray(u.matrixWorlds,16*m),p.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),f.premultiply(p),f.premultiply(this.matrixWorld),p.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),f.premultiply(p),this.draw(3,u.geometry,u.material,e,f);else f.copy(u.matrixWorld),p.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),f.premultiply(p),f.premultiply(this.matrixWorld),p.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),f.premultiply(p),this.draw(3,u.geometry,u.material,e,f);e++}}for(var g=0,v=d.getNumTexts();g<v;++g){var y=d.getText(g);if(y&&y.geometry){var E=new THREE.Vector3(0,0,0),b=new THREE.Matrix4,M=new THREE.Matrix4,x=new THREE.Vector3,w=new THREE.Quaternion,I=new THREE.Vector3;if(0<y.instancedCount)for(var S=0;S<y.instancedCount;S++)b.fromArray(y.matrixWorlds,16*S),b.decompose(x,w,I),M.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),b.premultiply(M),b.premultiply(this.matrixWorld),M.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),b.premultiply(M),E.set(0,0,0),E.applyMatrix4(b),this.drawText(y.geometry.uuid,y.material.uniforms.diffuse.value,E,I.x);else b.copy(y.matrixWorld),b.decompose(x,w,I),M.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),b.premultiply(M),b.premultiply(this.matrixWorld),M.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),b.premultiply(M),E.applyMatrix4(b),this.drawText(y.geometry.uuid,y.material.uniforms.diffuse.value,E,I.x)}}}return e},this.drawLine=function(){for(var e=this.viewer.ndsModel.getLineSegmentsSet(),t=0,n=0,i=e.getNumLineSegments();n<i;++n){var r=e.getLineSegments(n);if(r&&r.geometry){var o=r.geometry.geomType?3-r.geometry.geomType:2,a=new THREE.Matrix4,s=new THREE.Matrix4;if(0<r.instancedCount)for(var l=0;l<r.instancedCount;l++)a.fromArray(r.matrixWorlds,16*l),s.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),a.premultiply(s),a.premultiply(this.matrixWorld),s.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),a.premultiply(s),this.draw(o,r.geometry,r.material,t,a);else a.copy(r.matrixWorld),s.makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),a.premultiply(s),a.premultiply(this.matrixWorld),s.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),a.premultiply(s),this.draw(o,r.geometry,r.material,t,a);t++}}return t},this.draw=function(e,t,n,i,r){var o=t.getAttribute("position");if(o&&t.index){for(var a,s=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=e,h=new THREE.Color(n.color.getHex()),u=this.getColorTableId(h),f=t.drawRange.start,p=t.drawRange.start+t.drawRange.count;f<p;f+=c)if(1==e){var m=t.index.getX(f);s.fromBufferAttribute(o,m),s.applyMatrix4(r),this.normalize(s),s.x<0||1<s.x||s.y<0||1<s.y||(v=(b=tn(this.convertToPDFCood(s),2))[0],y=b[1],(g=this.pointPointArray[u])||(g=new Array,this.pointPointArray[u]=g),g.push(v,y),this.totalPointNum+=2)}else if(2==e){m=t.index.getX(f),a=t.index.getX(f+1),s.fromBufferAttribute(o,m),l.fromBufferAttribute(o,a),s.applyMatrix4(r),l.applyMatrix4(r),this.normalize(s),this.normalize(l);var g,v,y,E,b,M=this.clipLine(s,l);0<M.length&&(g=(b=tn(this.convertToPDFCood(M[0],M[1]),4))[0],v=b[1],y=b[2],M=b[3],E=-1,null!=n.uniforms&&null!=n.uniforms.lineTypeId?E=this.getLineStyleTableId(n.uniforms.lineTypeId.value,n.uniforms.lineScale.value):null!=n.uniforms&&null!=n.uniforms.lineStyle&&(E=this.getOldLineStyleTableId(n.uniforms.lineStyle.value)),(b=this.linePointArray[i])||(b=new Array,this.linePointArray[i]=b),b.push(g,v,y,M,u,E),this.totalPointNum+=6)}else if(3==e){m=t.index.getX(f),a=t.index.getX(f+1),E=t.index.getX(f+2),s.fromBufferAttribute(o,m),l.fromBufferAttribute(o,a),d.fromBufferAttribute(o,E),s.applyMatrix4(r),l.applyMatrix4(r),d.applyMatrix4(r),this.normalize(s),this.normalize(l),this.normalize(d);for(var x=this.clipTriangle(s,l,d),w=0;w<x.length;w+=3){var I=tn(this.convertToPDFCood(x[w],x[w+1],x[w+2]),6),S=I[0],T=I[1],A=I[2],R=I[3],O=I[4],I=I[5];this.meshPointArray.push(S,T,A,R,O,I,u),this.totalPointNum+=7}}if(this.viewer.lineTypes&&null!=n.uniforms&&null!=n.uniforms.lineTypeId){var h=this.viewer.lineTypes.getLineStyleInfoForPDF(t,n.uniforms.lineTypeId.value,n.uniforms.lineScale.value,n.color),P=h.styleText;if(P){var C,B=new THREE.Vector3;for(C in P)for(var L=P[C],D={name:L.fontName,size:L.size,isShx:L.isShx,style:"normal",weight:"normal",width:1},H=0;H<L.data.length;H+=3){B.set(L.data[H],L.data[H+1],0),B.applyMatrix4(r),D.size=L.size;for(var N=this.clipText2(C,L.data[H+2],D,B,0<L.shapeId),F=0;F<N.length;F++){D.name=N[F].font,0<L.shapeId&&(D.size=4.5*L.size),B.set(N[F].pos[0],N[F].pos[1],0);var _=tn(this.convertToPDFCood(B),2),k=_[0],V=_[1],_=this.getFontTableId(D);this.addTextInfoArray(N[F].char,L.data[H+2],u,_,k,V,L.shapeId)}}}var j=h.stylePoint;if(j)for(var U,z=new THREE.Vector3,G=0;G<j.length;G+=3)z.set(j[G+0],j[G+1],j[G+2]),z.applyMatrix4(r),this.normalize(z),0<z.x&&z.x<1&&0<z.y&&z.y<1&&(k=(U=tn(this.convertToPDFCood(z),2))[0],V=U[1],(U=this.pointPointArray[u])||(U=new Array,this.pointPointArray[u]=U),U.push(k,V),this.totalPointNum+=2);var W=h.styleLine;if(W)for(var Y=new THREE.Vector3,X=new THREE.Vector3,Z=0;Z<W.length;Z+=6){Y.set(W[Z+0],W[Z+1],W[Z+2]),X.set(W[Z+3],W[Z+4],W[Z+5]),Y.applyMatrix4(r),X.applyMatrix4(r),this.normalize(Y),this.normalize(X);var q,Q,J,K,$=this.clipLine(Y,X);0<$.length&&(q=(K=tn(this.convertToPDFCood($[0],$[1]),4))[0],Q=K[1],J=K[2],$=K[3],(K=this.linePointArray[i])||(K=new Array,this.linePointArray[i]=K),K.push(q,Q,J,$,u,-1),this.totalPointNum+=6)}}}},this.drawText=function(e,t,n,i){var r=this.getUUidToTextInfo(e);if(r){var o=n||(new THREE.Vector3).fromArray(r.position),t=new THREE.Color(t||r.colorHex),i=i||1,a=this.getColorTableId(t),s={bigName:this.fontSaveArray[r.fontId].bigName,name:this.fontSaveArray[r.fontId].name,size:this.fontSaveArray[r.fontId].size*i,style:this.fontSaveArray[r.fontId].style,weight:this.fontSaveArray[r.fontId].weight,width:this.fontSaveArray[r.fontId].width},i=this.viewer.SDFMaker.RegText(r.text);r.text=i.text;for(var l=this.clipText2(r.text,r.angle,s,o),d=0;d<l.length;d++){s.name=l[d].font,s.width=l[d].width,o.set(l[d].pos[0],l[d].pos[1],0);var c=this.getFontTableId(s),h=tn(this.convertToPDFCood(o),2),u=h[0],h=h[1];this.addTextInfoArray(l[d].char,r.angle,a,c,u,h)}}},this.addTextInfoArray=function(e,t,n,i,r,o,a){var s={};s.text=e,s.data=[2,n,i],.001<Math.abs(+t)&&(s.angle=parseFloat((180*(0<t?2*Math.PI-t:Math.abs(t))/Math.PI).toFixed(8))),0<a&&(s.shapeId=a.toString());a=this.getTextInfoId(s),s=this.textPointArray[a];s||(s=new Array,this.textPointArray[a]=s),s.push(parseFloat(r.toFixed(8)),parseFloat(o.toFixed(8))),this.totalPointNum+=2},this.getTextInfoId=function(e){for(var t=0;t<this.textInfoArray.length;t++)if(this.textInfoArray[t].text==e.text&&this.textInfoArray[t].data[1]==e.data[1]&&this.textInfoArray[t].data[2]==e.data[2]&&this.textInfoArray[t].angle==e.angle&&this.textInfoArray[t].shapdId==e.shapdId)return this.textInfoArray[t].data[0]+=2,t;return this.textInfoArray.push(e),this.textInfoArray.length-1},this.clearArray=function(){this.linePointArray={},this.meshPointArray=[],this.textPointArray=[],this.pointPointArray={},this.totalPointNum=0,this.colorArray=[],this.fontArray=[],this.lineStyleArray=[],this.textInfoArray=[]},this.strToUnicode=function(e){for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n),r=i.toString(16);t+=i<15?"\\u000"+r:i<255?"\\u00"+r:i<4095?"\\u0"+r:"\\u"+r}return t},this.sendFile=function(e){var t,n={name:this.pdfInfo.fileName,size:this.pdfInfo.size,orientation:this.pdfInfo.orientation,unit:"mm",colorType:this.pdfInfo.colorType,color:this.colorArray,font:[],lineStyle:[],meshInfo:{start:0,step:7,data:[]},lineInfo:{start:0,step:6,lineWidth:.2,data:[]},textInfo:{start:0,data:[]},pointInfo:{start:0,step:3,data:[]}},i=new ArrayBuffer(4*this.totalPointNum),r=new Float32Array(i),o=0;for(t in n.meshInfo.start=o,r.set(this.meshPointArray,o),o+=this.meshPointArray.length,n.meshInfo.data.push(this.meshPointArray.length),n.lineInfo.start=o,this.linePointArray){var a=this.linePointArray[t];r.set(a,o),o+=a.length,n.lineInfo.data.push(a.length)}n.textInfo.start=o;for(var s,l=0;l<this.textPointArray.length;l++){var d=this.textPointArray[l];r.set(d,o),o+=d.length}for(s in n.pointInfo.start=o,this.pointPointArray){var c=this.pointPointArray[s];r.set(c,o),o+=c.length,n.pointInfo.data.push(c.length,parseInt(s),.1)}for(var h=0;h<this.lineStyleArray.length;h++){for(var u=this.lineStyleArray[h].data.slice(),f=0;f<u.length;f++)u[f]=parseFloat((u[f]*this.lineStyleArray[h].scale*this.pdfInfo.scale).toFixed(8));n.lineStyle.push(u)}for(var p=0;p<this.fontArray.length;p++){var m=this.fontArray[p].name;m=""==m?"YAHEI.ttf":-1==this.fontArray[p].name.search(/\./g)?this.fontArray[p].name+".ttf":this.fontArray[p].name;var g=this.viewer.SDFMaker.IsShxFont(m);this.fontArray[p].isShx?n.font.push({name:m,size:parseFloat((this.fontArray[p].size*this.pdfInfo.scale).toFixed(8)),isShx:this.fontArray[p].isShx,style:this.fontArray[p].style,weight:this.fontArray[p].weight,width:this.fontArray[p].width,index:p}):(g=this.fontArray[p].size*this.pdfInfo.scale*(g?.9:1),n.font.push({name:m,size:parseFloat(g.toFixed(8)),style:this.fontArray[p].style,weight:this.fontArray[p].weight,width:this.fontArray[p].width,index:p}))}for(var v=0;v<this.textInfoArray.length;v++)this.textInfoArray[v].text=this.strToUnicode(this.textInfoArray[v].text);return n.textInfo.data=this.textInfoArray,{jsonData:JSON.stringify(n),binData:i}},this.PDFTest=function(){this.totalPointNum=0,this.pdfInfo.fileName="temp",this.pdfInfo.size="A4",this.pdfInfo.orientation="p",this.pdfInfo.colorType="color",this.pdfInfo.xSelMin=0,this.pdfInfo.ySelMin=0,this.pdfInfo.xSelMax=210,this.pdfInfo.ySelMax=297,this.setPaperSize(this.pdfInfo.size,this.pdfInfo.orientation),this.setAlign(),this.colorArray.push("000000"),this.lineStyleArray.push({lineTypeId:0,data:[10,-10],scale:1});var e=this.linePointArray[0];e||(e=new Array,this.linePointArray[0]=e),e.push(10,10,110,10,0,0),this.totalPointNum+=6,e.push(10,20,20,20,0,-1),this.totalPointNum+=6,e.push(30,20,40,20,0,-1),this.totalPointNum+=6,e.push(50,20,60,20,0,-1),this.totalPointNum+=6,e.push(70,20,80,20,0,-1),this.totalPointNum+=6,e.push(90,20,100,20,0,-1),this.totalPointNum+=6,e.push(10,30,110,30,0,-1),this.totalPointNum+=6,(e=this.pointPointArray[0])||(e=new Array,this.pointPointArray[0]=e),e.push(30,8),this.totalPointNum+=2,e.push(70,8),this.totalPointNum+=2,this.sendFile()},this.PDFTestDrawBox=function(){var e=new THREE.LineLoop(new THREE.BufferGeometry,new THREE.LineBasicMaterial({color:255}));e.geometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(12),3));var t=[];t.push(new THREE.Vector3(this.pdfInfo.xSelMin,this.pdfInfo.ySelMin,0)),t.push(new THREE.Vector3(this.pdfInfo.xSelMin,this.pdfInfo.ySelMax,0)),t.push(new THREE.Vector3(this.pdfInfo.xSelMax,this.pdfInfo.ySelMax,0)),t.push(new THREE.Vector3(this.pdfInfo.xSelMax,this.pdfInfo.ySelMin,0)),e.geometry.attributes.position.copyVector3sArray(t),e.geometry.attributes.position.needsUpdate=!0,e.geometry.computeBoundingSphere(),this.viewer.scene.add(e)},this.PDFTestDrawBoundingBox=function(e){var t=new THREE.LineLoop(new THREE.BufferGeometry,new THREE.LineBasicMaterial({color:255}));t.geometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(12),3));var n=[];n.push(new THREE.Vector3(e.min.x,e.min.y,0)),n.push(new THREE.Vector3(e.min.x,e.max.y,0)),n.push(new THREE.Vector3(e.max.x,e.max.y,0)),n.push(new THREE.Vector3(e.max.x,e.min.y,0)),t.geometry.attributes.position.copyVector3sArray(n),t.geometry.attributes.position.needsUpdate=!0,t.geometry.computeBoundingSphere(),this.viewer.scene.add(t)},this.calcTextRect=function(){var e=[],t=!1;if(this.viewer.pmiObject)for(var n=this.viewer.ndsModel.getLayerBodies(this.viewer.ndsModel.rootBodyNode),i=0,r=n.length;i<r;++i){var o=n[i];if(o.visible&&o.pmiuuid)for(var a=0;a<o.pmiuuid.length;++a){var s,l,d=this.getUUidToTextInfo(o.pmiuuid[a]);d&&(s=(new THREE.Vector3).fromArray(d.position),l={bigName:this.fontSaveArray[d.fontId].bigName,name:this.fontSaveArray[d.fontId].name,size:this.fontSaveArray[d.fontId].size,style:this.fontSaveArray[d.fontId].style,weight:this.fontSaveArray[d.fontId].weight,width:this.fontSaveArray[d.fontId].width},this.calcRect(d.text,d.angle,l,s,e,t),t=!0)}}return e},this.calcRect=function(e,t,n,i,r,o,a){for(var s=new THREE.Vector3(i.x,i.y,0),l=new THREE.Vector3(i.x,i.y,0),d=new THREE.Vector3(i.x,i.y,0),c=new THREE.Vector3(i.x,i.y,0),h=new THREE.Vector3(Math.cos(t),Math.sin(t),0),u=.001,f=a||1,p=this.viewer.SDFMaker.GetMaterialStyleId(n.style,n.weight),m=0;m<e.length;m++){var g=this.viewer.SDFMaker.GetDimensionsForSize(e[m],n.size*f,p,n.name,n.width,n.bigName);g.discard||(u=u>g.height?u:g.height,d.addScaledVector(h,g.width))}c.copy(d);var i=new THREE.Vector3(0,0,1);i.cross(h).normalize(),l.addScaledVector(i,u),c.addScaledVector(i,u),t=this.min(s.x,l.x,d.x,c.x)-u,a=this.min(s.y,l.y,d.y,c.y)-u,i=this.max(s.x,l.x,d.x,c.x)+u,c=this.max(s.y,l.y,d.y,c.y)+u,o?(r[0]>t&&(r[0]=t),r[1]>a&&(r[1]=a),r[2]<i&&(r[2]=i),r[3]<c&&(r[3]=c)):r.push(t,a,i,c)},this.min=function(e,t,n,i){e=t<e?t:e,n=i<n?i:n;return n<e?n:e},this.max=function(e,t,n,i){e=t<e?e:i,i=i<n?n:i;return i<e?e:i},this.clipText2=function(e,t,n,i,r){for(var o,a,s=[],l=new THREE.Vector3(i.x,i.y,0),d=new THREE.Vector3(Math.cos(t),Math.sin(t),0),c=(l.x-this.pdfInfo.xSelMin)/this.pdfInfo.xLen,h=(l.y-this.pdfInfo.ySelMin)/this.pdfInfo.yLen,u=this.viewer.SDFMaker.GetMaterialStyleId(n.style,n.weight),f=0;f<e.length;f++){var p=r?e:e[f],m=this.viewer.SDFMaker.GetDimensionsForSize(p,n.size,u,n.name,n.width,n.bigName);if(!m.discard&&(o=c,a=h,l.addScaledVector(d,m.width),c=(l.x-this.pdfInfo.xSelMin)/this.pdfInfo.xLen,h=(l.y-this.pdfInfo.ySelMin)/this.pdfInfo.yLen,1<=o||o<=0||1<=a||a<=0||1<=c||c<=0||1<=h||h<=0||s.push({font:m.font,width:m.widthScale,char:p,pos:[o,a],clip:!1}),r))break}for(var g=0;g<s.length;g++)for(var v=g+1;v<s.length;v++){if(s[g].font!=s[v].font){g=v-1;break}s[g].char+=s[v].char,s[v].clip=!0}for(var y=[],E=0;E<s.length;E++)s[E].clip||y.push(s[E]);return y},this.clipLine=function(e,t){var n=[];return n=this.cohenSutherlandLineClipAndDraw(e,t)?[e,t]:n},this.computeOutCode=function(e,t){var n=0;return e<0?n|=1:1<e&&(n|=2),t<0?n|=4:1<t&&(n|=8),n},this.cohenSutherlandLineClipAndDraw=function(e,t){for(var n=this.computeOutCode(e.x,e.y),i=this.computeOutCode(t.x,t.y),r=!1;;){if(!(n|i)){r=!0;break}if(n&i)break;var o=void 0,a=void 0,s=n||i;8&s?(o=e.x+(t.x-e.x)*(1-e.y)/(t.y-e.y),a=1):4&s?(o=e.x+(t.x-e.x)*(0-e.y)/(t.y-e.y),a=0):2&s?(a=e.y+(t.y-e.y)*(1-e.x)/(t.x-e.x),o=1):1&s&&(a=e.y+(t.y-e.y)*(0-e.x)/(t.x-e.x),o=0),s==n?(e.x=o,e.y=a,n=this.computeOutCode(e.x,e.y)):(t.x=o,t.y=a,i=this.computeOutCode(t.x,t.y))}return!!r},this.clipTriangle=function(e,t,n){for(var i=[t,e,n],r=[[0,0],[0,1],[1,1],[1,0]],o=0;o<4;o++){var a=(o+1)%4;if(0==(i=this.sutherlandHodgman(i,i.length,r[o][0],r[o][1],r[a][0],r[a][1])).length)break}return 4==i.length&&i.push(i[0],i[2]),5==i.length&&i.push(i[0],i[0],i[2],i[3]),6==i.length&&i.push(i[0],i[2],i[3],i[0],i[3],i[5]),i},this.x_letersect=function(e,t,n,i,r,o,a,s){return((e*i-t*n)*(r-a)-(e-n)*(r*s-o*a))/((e-n)*(o-s)-(t-i)*(r-a))},this.y_letersect=function(e,t,n,i,r,o,a,s){return((e*i-t*n)*(o-s)-(t-i)*(r*s-o*a))/((e-n)*(o-s)-(t-i)*(r-a))},this.sutherlandHodgman=function(e,t,n,i,r,o){for(var a=[],s=0;s<t;s++){var l,d=(s+1)%t,c=e[s].x,h=e[s].y,u=e[d].x,f=e[d].y,p=(r-n)*(h-i)-(o-i)*(c-n),m=(r-n)*(f-i)-(o-i)*(u-n);p<0&&m<0?(a.push(new THREE.Vector2(u,f)),0):0<=p&&m<0?(l=this.x_letersect(n,i,r,o,c,h,u,f),d=this.y_letersect(n,i,r,o,c,h,u,f),a.push(new THREE.Vector2(l,d)),a.push(new THREE.Vector2(u,f)),0):p<0&&0<=m&&(m=this.x_letersect(n,i,r,o,c,h,u,f),f=this.y_letersect(n,i,r,o,c,h,u,f),a.push(new THREE.Vector2(m,f)),0)}return a}};NDS.Element=function(e){this.type="Element",this.domElement=void 0!==(e=e||{}).element?document.createElement(e.element):document.createElement("div");var n=this.domElement;void 0!==e.id&&(n.id=e.id),void 0!==e.name&&(n.name=e.name),void 0!==e.className&&(n.className=e.className),void 0!==e.callbackEvent&&this.addEventListener("event",e.callbackEvent),this.style={},this.subElements={},this.childElements=new Array;var i=this.style,r=this;this.setSize=function(e,t){n.style.width=e+"px",n.style.height=t+"px",i.width=e,i.height=t},this.setWidth=function(e){n.style.width=e+"px",i.width=e},this.setHeight=function(e){n.style.height=e+"px",i.height=e},this.setPos=function(e,t){n.style.left=e+"px",n.style.top=t+"px",i.left=e,i.top=t},this.setLeft=function(e){n.style.left=e+"px",i.left=e},this.setTop=function(e){n.style.top=e+"px",i.top=e},this.setRight=function(e){n.style.right=e+"px",i.right=e},this.setBottom=function(e){n.style.bottom=e+"px",i.bottom=e},this.setBgColor=function(e){n.style.backgroundColor=e,i.opacity=e},this.setOpacity=function(e){n.style.opacity=e,i.opacity=e},this.deleteOpacity=function(){n.style.opacity="",delete i.opacity},this.setPosition=function(e){n.style.position=e,i.position=e},this.setBorder=function(e){n.style.border=e,i.border=e},this.setMargin=function(e){n.style.marginLeft=e.left+"px",n.style.marginRight=e.right+"px",n.style.marginTop=e.top+"px",n.style.marginBottom=e.bottom+"px",i.margin=e},this.setBorderRadius=function(e){n.style.borderRadius=e+"px",i.borderRadius=e},this.setPadding=function(e){n.style.paddingLeft=e.left+"px",n.style.paddingRight=e.right+"px",n.style.paddingTop=e.top+"px",n.style.paddingBottom=e.bottom+"px",i.padding=e},this.setListStyle=function(e){n.style.listStyle=e,i.listStyle=e},this.setTextAlign=function(e){n.style.textAlign=e,i.textAlign=e},this.setFloat=function(e){n.style.styleFloat=e,i.styleFloat=e,n.style.cssFloat=e,i.cssFloat=e},this.setCursor=function(e){n.style.cursor=e,i.cursor=e},this.setVisibility=function(e){n.style.visibility=e?"visible":"hidden",i.visibility=e},this.getVisibility=function(){return!(null==i.visibility||!i.visibility)},this.setDisplay=function(e){n.style.display=e?"":"none",i.display=e},this.setBgImage=function(e){n.style.backgroundImage=e,i.bgImage=e},this.setBgPosition=function(e){n.style.backgroundPosition=e,i.backgroundPosition=e},this.setBgRepeat=function(e){n.style.backgroundRepeat=e,i.backgroundRepeat=e},this.setText=function(e){n.innerHTML=e,i.text=e},this.setTitle=function(e){n.title=e,i.title=e},this.addEvent=function(e,t){n.addEventListener(e,r.onEvent,t)},this.removeEvent=function(e,t){n.removeEventListener(e,r.onEvent,t)},this.onEvent=function(e){r.dispatchEvent({type:"event",event:e})},this.addSubElement=function(e){n.appendChild(e.domElement)},this.addChildElement=function(e){r.childElements.push(new ye.map(e.domElement.id,e))},this.getChildElement=function(e){for(var t=0;t<r.childElements.length;++t)if(r.childElements[t].key==e)return r.childElements[t].value},this.updateChildElement=function(e,t){for(var n=0;n<r.childElements.length;++n)r.childElements[n].key==e&&(r.childElements[n].key=t)},this.getChildElementIndex=function(e){for(var t=0;t<r.childElements.length;++t)if(r.childElements[t].key==e)return t;return-1},this.release=function(){n.parentElement.removeChild(n)},void 0!==e.img&&r.setBgImage(e.img),void 0!==e.text&&r.setText(e.text),void 0!==e.ttTitle&&r.setTitle(e.ttTitle)},NDS.Element.prototype=Object.create(THREE.EventDispatcher.prototype),NDS.Titlebar=function(e){e=e||{},NDS.Element.call(this,e),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),this.type="Titlebar";var t=this.domElement,n=this.style,i="titlebar-title",r="titlebar-button";void 0!==e.titleClassName&&(i=e.titleClassName),void 0!==e.buttonClassName&&(r=e.buttonClassName);var o=new NDS.Element({className:i});t.appendChild(o.domElement),this.subElements.title=o;r=new NDS.Button({className:r,text:"x"});t.appendChild(r.domElement),this.subElements.btnClose=r,this.setTitle=function(e){o.domElement.innerHTML=e,n.text=e}},NDS.Titlebar.prototype=Object.create(NDS.Element.prototype),NDS.Dialog=function(n){n=n||{},NDS.Element.call(this,n),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),this.type="Dialog",this.subElements.title=null,this.subElements.content=null,this.subElements.scrollbar=null;var i=this.domElement,r=(this.style,this),e=this.subElements.title,o=this.subElements.content,a=this.subElements.scrollbar;function t(){var e=new NDS.Titlebar,t=e.subElements.btnClose.domElement;return 1==n.noCloseButton?e.domElement.removeChild(t):t.addEventListener("click",r.onClose,!1),i.appendChild(e.domElement),r.subElements.title=e}function s(){var e=new NDS.Scrollbar({className:"scrollbar right"});return i.appendChild(e.domElement),r.subElements.scrollbar=e}this.onClose=function(e){r.setVisibility(!1),r.dispatchEvent({type:"close",event:e})},null!=(e=void 0===n.noTitlebar||1!=n.noTitlebar?t():e)&&null!=n.title&&e.setTitle(n.title),void 0!==n.noScrollbar&&1==n.noScrollbar||(a=s()),this.setContent=function(e){var t,n=a?a.domElement:i;null==o||null!=(t=o.domElement)&&n.removeChild(t),n.appendChild(e.domElement),o=e,r.subElements.content=o}},NDS.Dialog.prototype=Object.create(NDS.Element.prototype),NDS.Button=function(e){e=e||{},NDS.Element.call(this,e),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),ye.isMobileDevice()?this.addEvent("touchstart",!1):this.addEvent("click",!1),this.type="Button";var i=this.domElement,r=(this.style,this);this.setPopupElement=function(e){var t=i.parentNode,n=r.subElements.popupElement;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.popupElement=e},this.setTooltip=function(e){var t=i.parentNode,n=r.subElements.tooltip;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.tooltip=e},this.setPopupDialog=function(e){r.subElements.popupDialog=e}},NDS.Button.prototype=Object.create(NDS.Element.prototype),NDS.Tooltip=function(e){NDS.Element.call(this,e),this.type="Tooltip";this.domElement,this.style;void 0!==e.text&&this.setText(e.text)},NDS.Tooltip.prototype=Object.create(NDS.Element.prototype),NDS.Toolbar=function(e){e=e||{},NDS.Element.call(this,e),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),this.type="Toolbar";var e=this.domElement,n=(this.style,new NDS.Element({element:"ul"})),n=e.appendChild(n.domElement);this.addButton=function(e){e=e||{};var t=new NDS.Element({element:"li"});null!=e.float&&(t.domElement.style.float=e.float);t=n.appendChild(t.domElement),e=new NDS.Button(e);return t.appendChild(e.domElement),this.addChildElement(e),e}},NDS.Toolbar.prototype=Object.create(NDS.Element.prototype),NDS.Table=function(e){(e=e||{}).element="table",NDS.Element.call(this,e),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),this.type="Table";var t=this.domElement,r=(this.style,this),o=new Array,a=new Array,n=t;null!=e.scrollbar&&(n=e.scrollbar.domElement,t.appendChild(n));var i=new NDS.Element({element:"thead"});n.appendChild(i.domElement);var s=new NDS.Element({element:"tbody"});n.appendChild(s.domElement),this.addHeadRow=function(){var e=new NDS.Element({element:"tr"});return i.domElement.appendChild(e.domElement),a.push({row:e,cols:new Array}),e},this.addHeadCol=function(e){if(null==(e=e||{}).element)return null;a.length<=0&&r.addHeadRow();var t=a[a.length-1].row,n=a[a.length-1].cols,i=new NDS.Element({element:"th",className:e.className});t.domElement.appendChild(i.domElement),n.push(i);e=e.element;return i.domElement.appendChild(e.domElement),e},this.addRow=function(){var e=new NDS.Element({element:"tr"});return s.domElement.appendChild(e.domElement),o.push({row:e,cols:new Array}),e},this.addCol=function(e){if(null==(e=e||{}).element)return null;o.length<=0&&r.addRow();var t=o[o.length-1].row,n=o[o.length-1].cols,i=new NDS.Element({element:"td",className:e.className});t.domElement.appendChild(i.domElement),n.push(i);e=e.element;return i.domElement.appendChild(e.domElement),e}},NDS.Table.prototype=Object.create(NDS.Element.prototype),NDS.Input=function(e){(e=e||{}).element="input",NDS.Element.call(this,e),this.addEvent("click",!1),this.type="Input";var i=this.domElement,r=(this.style,this);void 0!==e.type&&(i.type=e.type),void 0!==e.multiple&&(i.multiple=e.multiple),this.setPopupElement=function(e){var t=i.parentNode,n=r.subElements.popupElement;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.popupElement=e},this.setTooltip=function(e){var t=i.parentNode,n=r.subElements.tooltip;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.tooltip=e},this.setPopupDialog=function(e){r.subElements.popupDialog=e}},NDS.Input.prototype=Object.create(NDS.Element.prototype),NDS.Scrollbar=function(e){e=e||{},NDS.Element.call(this,e),this.type="Scrollbar"},NDS.Scrollbar.prototype=Object.create(NDS.Element.prototype),NDS.Menu=function(e){e=e||{},NDS.Element.call(this,e),this.type="Menu";var t=this.domElement;this.style;this.addItem=function(e){e=e||{};e=new NDS.Element(e);return e.addEvent("click",!1),this.addChildElement(e),t.appendChild(e.domElement),e}},NDS.Menu.prototype=Object.create(NDS.Element.prototype),NDS.Slider=function(e){(e=e||{}).element="input",NDS.Element.call(this,e),this.addEvent("mouseenter",!1),this.addEvent("mouseleave",!1),this.addEvent("mouseover",!1),this.addEvent("mouseout",!1),this.addEvent("click",!1),this.type="Slider";var i=this.domElement,r=(this.style,this);i.type="range",i.min=void 0!==e.min?e.min:"0",i.max=void 0!==e.max?e.max:"1",i.step=void 0!==e.step?e.step:"0.01",i.value=void 0!==e.value?e.value:"0",this.setTooltip=function(e){var t=i.parentNode,n=r.subElements.tooltip;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.tooltip=e}},NDS.Slider.prototype=Object.create(NDS.Element.prototype),NDS.TextArea=function(e){(e=e||{}).element="textarea",NDS.Element.call(this,e),this.addEvent("click",!1),this.type="textarea";var i=this.domElement,r=(this.style,this);void 0!==e.type&&(i.type=e.type),void 0!==e.multiple&&(i.multiple=e.multiple),this.setTooltip=function(e){var t=i.parentNode,n=r.subElements.tooltip;null==n||null!=(n=n.domElement)&&t.removeChild(n),t.appendChild(e.domElement),r.subElements.tooltip=e}},NDS.TextArea.prototype=Object.create(NDS.Element.prototype);function rn(e){return"("+e.x+";"+e.y+")"}var on=1e-12,an={CW:1,CCW:-1,COLLINEAR:0},sn=function(e,t){this.name="PointError",this.points=t=t||[],this.message=e||"Invalid Points!";for(var n=0;n<t.length;n++)this.message+=" "+ln.toString(t[n])},ln={};function dn(e,t,n,i){t=(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y);return!(-on<=t)&&!((e.x-n.x)*(i.y-n.y)-(i.x-n.x)*(e.y-n.y)<=on)}function cn(e,t){if(!e)throw new Error(t||"Assert Failed")}function hn(e,t,n){n=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x);return-on<n&&n<on?an.COLLINEAR:0<n?an.CCW:an.CW}function un(e,t,n){var i=t.x-e.x,t=t.y-e.y;return i*(n.x-e.x)+t*(n.y-e.y)<0}ln.toString=function(e){var t=e.toString();return"[object Object]"===t?rn(e):t},ln.toStringBase=rn,ln.compare=function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y},ln.equals=function(e,t){return e.x===t.x&&e.y===t.y};function fn(e,t){this.head_=e,this.tail_=t,this.search_node_=e}var pn=function(e,t){this.point=e,this.triangle=t||null,this.next=null,this.prev=null,this.value=e.x};fn.prototype.head=function(){return this.head_},fn.prototype.setHead=function(e){this.head_=e},fn.prototype.tail=function(){return this.tail_},fn.prototype.setTail=function(e){this.tail_=e},fn.prototype.search=function(){return this.search_node_},fn.prototype.setSearch=function(e){this.search_node_=e},fn.prototype.findSearchNode=function(){return this.search_node_},fn.prototype.locateNode=function(e){var t=this.search_node_;if(e<t.value){for(;t=t.prev;)if(e>=t.value)return this.search_node_=t}else for(;t=t.next;)if(e<t.value)return this.search_node_=t.prev,t.prev;return null},fn.prototype.locatePoint=function(e){var t=e.x,n=this.findSearchNode(t),i=n.point.x;if(t===i){if(e!==n.point)if(e===n.prev.point)n=n.prev;else{if(e!==n.next.point)throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call");n=n.next}}else if(t<i)for(;(n=n.prev)&&e!==n.point;);else for(;(n=n.next)&&e!==n.point;);return n&&(this.search_node_=n),n};function mn(e,t){this.x=+e||0,this.y=+t||0,this._p2t_edge_list=null}mn.prototype.toString=function(){return ln.toStringBase(this)},mn.prototype.toJSON=function(){return{x:this.x,y:this.y}},mn.prototype.clone=function(){return new mn(this.x,this.y)},mn.prototype.set_zero=function(){return this.x=0,this.y=0,this},mn.prototype.set=function(e,t){return this.x=+e||0,this.y=+t||0,this},mn.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},mn.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},mn.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},mn.prototype.mul=function(e){return this.x*=e,this.y*=e,this},mn.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},mn.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,e},mn.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},mn.negate=function(e){return new mn(-e.x,-e.y)},mn.add=function(e,t){return new mn(e.x+t.x,e.y+t.y)},mn.sub=function(e,t){return new mn(e.x-t.x,e.y-t.y)},mn.mul=function(e,t){return new mn(e*t.x,e*t.y)},mn.cross=function(e,t){return"number"==typeof e?"number"==typeof t?e*t:new mn(-e*t.y,e*t.x):"number"==typeof t?new mn(t*e.y,-t*e.x):e.x*t.y-e.y*t.x},mn.toString=ln.toString,mn.compare=ln.compare,mn.cmp=ln.compare,mn.equals=ln.equals,mn.dot=function(e,t){return e.x*t.x+e.y*t.y};var gn={triangulate:function(e){e.initTriangulation(),e.createAdvancingFront(),function(e){var t,n=e.pointCount();for(t=1;t<n;++t)for(var i=e.getPoint(t),r=function(e,t){var n=e.locateNode(t),i=function(e,t,n){var i=new On(t,n.point,n.next.point);i.markNeighbor(n.triangle),e.addToMap(i);t=new pn(t);t.next=n.next,(t.prev=n).next.prev=t,n.next=t,bn(e,i)||e.mapTriangleToNodes(i);return t}(e,t,n);t.x<=n.point.x+on&&En(e,n);return function(e,t){var n=t.next;for(;n.next&&!un(n.point,n.next.point,n.prev.point);)En(e,n),n=n.next;n=t.prev;for(;n.prev&&!un(n.point,n.next.point,n.prev.point);)En(e,n),n=n.prev;t.next&&t.next.next&&function(e){var t=e.point.x-e.next.next.point.x,e=e.point.y-e.next.next.point.y;return cn(0<=e,"unordered y"),0<=t||Math.abs(t)<e}(t)&&function(e,t){hn(t.point,t.next.point,t.next.next.point)===an.CCW?e.basin.left_node=t.next.next:e.basin.left_node=t.next;e.basin.bottom_node=e.basin.left_node;for(;e.basin.bottom_node.next&&e.basin.bottom_node.point.y>=e.basin.bottom_node.next.point.y;)e.basin.bottom_node=e.basin.bottom_node.next;if(e.basin.bottom_node!==e.basin.left_node){for(e.basin.right_node=e.basin.bottom_node;e.basin.right_node.next&&e.basin.right_node.point.y<e.basin.right_node.next.point.y;)e.basin.right_node=e.basin.right_node.next;e.basin.right_node!==e.basin.bottom_node&&(e.basin.width=e.basin.right_node.point.x-e.basin.left_node.point.x,e.basin.left_highest=e.basin.left_node.point.y>e.basin.right_node.point.y,function e(t,n){if(xn(t,n))return;En(t,n);{if(n.prev===t.basin.left_node&&n.next===t.basin.right_node)return;if(n.prev===t.basin.left_node){if(hn(n.point,n.next.point,n.next.next.point)===an.CW)return;n=n.next}else if(n.next===t.basin.right_node){if(hn(n.point,n.prev.point,n.prev.prev.point)===an.CCW)return;n=n.prev}else n=n.prev.point.y<n.next.point.y?n.prev:n.next}e(t,n)}(e,e.basin.bottom_node))}}(e,t)}(e,i),i}(e,i),o=i._p2t_edge_list,a=0;o&&a<o.length;++a)!function(e,t,n){if(e.edge_event.constrained_edge=t,e.edge_event.right=t.p.x>t.q.x,!yn(n.triangle,t.p,t.q)){!function(e,t,n){(e.edge_event.right?function(e,t,n){for(;n.next.point.x<t.p.x;)hn(t.q,n.next.point,t.p)===an.CCW?function e(t,n,i){i.point.x<n.p.x&&(hn(i.point,i.next.point,i.next.next.point)===an.CCW?wn(t,n,i):(In(t,n,i),e(t,n,i)))}(e,t,n):n=n.next}:function(e,t,n){for(;n.prev.point.x>t.p.x;)hn(t.q,n.prev.point,t.p)===an.CW?function e(t,n,i){i.point.x>n.p.x&&(hn(i.point,i.prev.point,i.prev.prev.point)===an.CW?Tn(t,n,i):(Sn(t,n,i),e(t,n,i)))}(e,t,n):n=n.prev})(e,t,n)}(e,t,n);try{vn(e,t.p,t.q,n.triangle,t.q)}catch(e){}}}(e,o[a],r)}(e),function(e){var t=e.front().head().next.triangle,n=e.front().head().next.point;for(;!t.getConstrainedEdgeCW(n);)t=t.neighborCCW(n);e.meshClean(t)}(e)}};function vn(e,t,n,i,r){if(!yn(i,t,n)){var o=i.pointCCW(r),a=hn(n,o,t);if(a===an.COLLINEAR)throw new sn("poly2tri EdgeEvent: Collinear not supported!",[n,o,t]);var s=i.pointCW(r),o=hn(n,s,t);if(o===an.COLLINEAR)throw new sn("poly2tri EdgeEvent: Collinear not supported!",[n,s,t]);a===o?vn(e,t,n,i=a===an.CW?i.neighborCCW(r):i.neighborCW(r),r):An(e,t,n,i,r)}}function yn(e,t,n){var i=e.edgeIndex(t,n);if(-1!==i){e.markConstrainedEdgeByIndex(i);i=e.getNeighbor(i);return i&&i.markConstrainedEdgeByPoints(t,n),1}}function En(e,t){var n=new On(t.prev.point,t.point,t.next.point);n.markNeighbor(t.prev.triangle),n.markNeighbor(t.triangle),e.addToMap(n),t.prev.next=t.next,t.next.prev=t.prev,bn(e,n)||e.mapTriangleToNodes(n)}function bn(e,t){for(var n=0;n<3;++n)if(!t.delaunay_edge[n]){var i=t.getNeighbor(n);if(i){var r=t.getPoint(n),o=i.oppositePoint(t,r),a=i.index(o);if(i.constrained_edge[a]||i.delaunay_edge[a])t.constrained_edge[n]=i.constrained_edge[a];else{var s=function(e,t,n,i){var r=e.x-i.x,o=e.y-i.y,a=t.x-i.x,s=t.y-i.y,e=r*s-a*o;if(e<=0)return!1;t=n.x-i.x,n=n.y-i.y,i=t*o-r*n;if(i<=0)return!1;return 0<(r*r+o*o)*(a*n-t*s)+(a*a+s*s)*i+(t*t+n*n)*e}(r,t.pointCCW(r),t.pointCW(r),o);if(s)return t.delaunay_edge[n]=!0,i.delaunay_edge[a]=!0,Mn(t,r,i,o),!bn(e,t)&&e.mapTriangleToNodes(t),!bn(e,i)&&e.mapTriangleToNodes(i),t.delaunay_edge[n]=!1,i.delaunay_edge[a]=!1,1}}}}function Mn(e,t,n,i){var r=e.neighborCCW(t),o=e.neighborCW(t),a=n.neighborCCW(i),s=n.neighborCW(i),l=e.getConstrainedEdgeCCW(t),d=e.getConstrainedEdgeCW(t),c=n.getConstrainedEdgeCCW(i),h=n.getConstrainedEdgeCW(i),u=e.getDelaunayEdgeCCW(t),f=e.getDelaunayEdgeCW(t),p=n.getDelaunayEdgeCCW(i),m=n.getDelaunayEdgeCW(i);e.legalize(t,i),n.legalize(i,t),n.setDelaunayEdgeCCW(t,u),e.setDelaunayEdgeCW(t,f),e.setDelaunayEdgeCCW(i,p),n.setDelaunayEdgeCW(i,m),n.setConstrainedEdgeCCW(t,l),e.setConstrainedEdgeCW(t,d),e.setConstrainedEdgeCCW(i,c),n.setConstrainedEdgeCW(i,h),e.clearNeighbors(),n.clearNeighbors(),r&&n.markNeighbor(r),o&&e.markNeighbor(o),a&&e.markNeighbor(a),s&&n.markNeighbor(s),e.markNeighbor(n)}function xn(e,t){t=e.basin.left_highest?e.basin.left_node.point.y-t.point.y:e.basin.right_node.point.y-t.point.y;return e.basin.width>t}function wn(e,t,n){En(e,n.next),n.next.point!==t.p&&hn(t.q,n.next.point,t.p)===an.CCW&&hn(n.point,n.next.point,n.next.next.point)===an.CCW&&wn(e,t,n)}function In(e,t,n){hn(n.next.point,n.next.next.point,n.next.next.next.point)===an.CCW?wn(e,t,n.next):hn(t.q,n.next.next.point,t.p)===an.CCW&&In(e,t,n.next)}function Sn(e,t,n){hn(n.prev.point,n.prev.prev.point,n.prev.prev.prev.point)===an.CW?Tn(e,t,n.prev):hn(t.q,n.prev.prev.point,t.p)===an.CW&&Sn(e,t,n.prev)}function Tn(e,t,n){En(e,n.prev),n.prev.point!==t.p&&hn(t.q,n.prev.point,t.p)===an.CW&&hn(n.point,n.prev.point,n.prev.prev.point)===an.CW&&Tn(e,t,n)}function An(e,t,n,i,r){var o=i.neighborAcross(r);cn(o,"FLIP failed due to missing triangle!");var a,s,l,d,c,h,u=o.oppositePoint(i,r);if(i.getConstrainedEdgeAcross(r)){var f=i.index(r);throw new sn("poly2tri Intersecting Constraints",[r,u,i.getPoint((f+1)%3),i.getPoint((f+2)%3)])}dn(r,i.pointCCW(r),i.pointCW(r),u)?(Mn(i,r,o,u),e.mapTriangleToNodes(i),e.mapTriangleToNodes(o),r===n&&u===t?n===e.edge_event.constrained_edge.q&&t===e.edge_event.constrained_edge.p&&(i.markConstrainedEdgeByPoints(t,n),o.markConstrainedEdgeByPoints(t,n),bn(e,i),bn(e,o)):(a=hn(n,u,t),s=i,l=o,d=r,c=u,An(f=e,t,n,i=a!==an.CCW?(h=s.edgeIndex(d,c),s.delaunay_edge[h]=!0,bn(f,s),s.clearDelaunayEdges(),l):(h=l.edgeIndex(d,c),l.delaunay_edge[h]=!0,bn(f,l),l.clearDelaunayEdges(),s),r))):(function e(t,n,i,r,o,a){var s=o.neighborAcross(a);cn(s,"FLIP failed due to missing triangle");a=s.oppositePoint(o,a);dn(i,r.pointCCW(i),r.pointCW(i),a)?An(t,i,a,s,a):(a=Rn(n,i,s,a),e(t,n,i,r,s,a))}(e,t,n,i,o,Rn(t,n,o,u)),vn(e,t,n,i,r))}function Rn(e,t,n,i){var r=hn(t,i,e);if(r===an.CW)return n.pointCCW(i);if(r===an.CCW)return n.pointCW(i);throw new sn("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[t,i,e])}var On=function(e,t,n){this.points_=[e,t,n],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},Pn=ln.toString;On.prototype.toString=function(){return"["+Pn(this.points_[0])+Pn(this.points_[1])+Pn(this.points_[2])+"]"},On.prototype.getPoint=function(e){return this.points_[e]},On.prototype.GetPoint=On.prototype.getPoint,On.prototype.getPoints=function(){return this.points_},On.prototype.getNeighbor=function(e){return this.neighbors_[e]},On.prototype.containsPoint=function(e){var t=this.points_;return e===t[0]||e===t[1]||e===t[2]},On.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},On.prototype.containsPoints=function(e,t){return this.containsPoint(e)&&this.containsPoint(t)},On.prototype.isInterior=function(){return this.interior_},On.prototype.setInterior=function(e){return this.interior_=e,this},On.prototype.markNeighborPointers=function(e,t,n){var i=this.points_;if(e===i[2]&&t===i[1]||e===i[1]&&t===i[2])this.neighbors_[0]=n;else if(e===i[0]&&t===i[2]||e===i[2]&&t===i[0])this.neighbors_[1]=n;else{if(!(e===i[0]&&t===i[1]||e===i[1]&&t===i[0]))throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call");this.neighbors_[2]=n}},On.prototype.markNeighbor=function(e){var t=this.points_;e.containsPoints(t[1],t[2])?(this.neighbors_[0]=e).markNeighborPointers(t[1],t[2],this):e.containsPoints(t[0],t[2])?(this.neighbors_[1]=e).markNeighborPointers(t[0],t[2],this):e.containsPoints(t[0],t[1])&&(this.neighbors_[2]=e).markNeighborPointers(t[0],t[1],this)},On.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},On.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},On.prototype.pointCW=function(e){var t=this.points_;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null},On.prototype.pointCCW=function(e){var t=this.points_;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:null},On.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},On.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},On.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},On.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},On.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},On.prototype.setConstrainedEdgeCW=function(e,t){e===this.points_[0]?this.constrained_edge[1]=t:e===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},On.prototype.setConstrainedEdgeCCW=function(e,t){e===this.points_[0]?this.constrained_edge[2]=t:e===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},On.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},On.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},On.prototype.setDelaunayEdgeCW=function(e,t){e===this.points_[0]?this.delaunay_edge[1]=t:e===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},On.prototype.setDelaunayEdgeCCW=function(e,t){e===this.points_[0]?this.delaunay_edge[2]=t:e===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},On.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},On.prototype.oppositePoint=function(e,t){t=e.pointCW(t);return this.pointCW(t)},On.prototype.legalize=function(e,t){var n=this.points_;if(e===n[0])n[1]=n[0],n[0]=n[2],n[2]=t;else if(e===n[1])n[2]=n[1],n[1]=n[0],n[0]=t;else{if(e!==n[2])throw new Error("poly2tri Invalid Triangle.legalize() call");n[0]=n[2],n[2]=n[1],n[1]=t}},On.prototype.index=function(e){var t=this.points_;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},On.prototype.edgeIndex=function(e,t){var n=this.points_;if(e===n[0]){if(t===n[1])return 2;if(t===n[2])return 1}else if(e===n[1]){if(t===n[2])return 0;if(t===n[0])return 2}else if(e===n[2]){if(t===n[0])return 1;if(t===n[1])return 0}return-1},On.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},On.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},On.prototype.markConstrainedEdgeByPoints=function(e,t){var n=this.points_;t===n[0]&&e===n[1]||t===n[1]&&e===n[0]?this.constrained_edge[2]=!0:t===n[0]&&e===n[2]||t===n[2]&&e===n[0]?this.constrained_edge[1]=!0:(t===n[1]&&e===n[2]||t===n[2]&&e===n[1])&&(this.constrained_edge[0]=!0)};function Cn(e,t){if(this.p=e,this.q=t,e.y>t.y)this.q=e,this.p=t;else if(e.y===t.y)if(e.x>t.x)this.q=e,this.p=t;else if(e.x===t.x)throw new sn("poly2tri Invalid Edge constructor: repeated points!",[e]);this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)}function Bn(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1}Bn.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};function Ln(){this.constrained_edge=null,this.right=!1}function Dn(e,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?e.slice(0):e,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new Bn,this.edge_event=new Ln,this.initEdges(this.points_)}Dn.prototype.AddHole=Dn.prototype.addHole=function(e){this.initEdges(e);for(var t=e.length,n=0;n<t;n++)this.points_.push(e[n]);return this},Dn.prototype.addHoles=function(e){for(var t=e.length,n=0;n<t;n++)this.initEdges(e[n]);return this.points_=this.points_.concat.apply(this.points_,e),this},Dn.prototype.AddPoint=Dn.prototype.addPoint=function(e){return this.points_.push(e),this},Dn.prototype.addPoints=function(e){return this.points_=this.points_.concat(e),this},Dn.prototype.triangulate=function(){return gn.triangulate(this),this},Dn.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},Dn.prototype.GetTriangles=Dn.prototype.getTriangles=function(){return this.triangles_},Dn.prototype.front=function(){return this.front_},Dn.prototype.pointCount=function(){return this.points_.length},Dn.prototype.head=function(){return this.head_},Dn.prototype.setHead=function(e){this.head_=e},Dn.prototype.tail=function(){return this.tail_},Dn.prototype.setTail=function(e){this.tail_=e},Dn.prototype.getMap=function(){return this.map_},Dn.prototype.initTriangulation=function(){for(var e=this.points_[0].x,t=this.points_[0].x,n=this.points_[0].y,i=this.points_[0].y,r=this.points_.length,o=1;o<r;o++){var a=this.points_[o];a.x>e&&(e=a.x),a.x<t&&(t=a.x),a.y>n&&(n=a.y),a.y<i&&(i=a.y)}this.pmin_=new mn(t,i),this.pmax_=new mn(e,n);var s=.3*(e-t),l=.3*(n-i);this.head_=new mn(e+s,i-l),this.tail_=new mn(t-s,i-l),this.points_.sort(mn.compare)},Dn.prototype.initEdges=function(e,t){for(var n=e.length,i=t?e.length-1:e.length,r=0;r<i;++r)this.edge_list.push(new Cn(e[r],e[(r+1)%n]))},Dn.prototype.getPoint=function(e){return this.points_[e]},Dn.prototype.addToMap=function(e){this.map_.push(e)},Dn.prototype.locateNode=function(e){return this.front_.locateNode(e.x)},Dn.prototype.createAdvancingFront=function(){var e,t,n=new On(this.points_[0],this.tail_,this.head_);this.map_.push(n),e=new pn(n.getPoint(1),n),t=new pn(n.getPoint(0),n),n=new pn(n.getPoint(2)),this.front_=new fn(e,n),(e.next=t).next=n,t.prev=e,n.prev=t},Dn.prototype.removeNode=function(e){},Dn.prototype.mapTriangleToNodes=function(e){for(var t,n=0;n<3;++n)e.getNeighbor(n)||(t=this.front_.locatePoint(e.pointCW(e.getPoint(n))))&&(t.triangle=e)},Dn.prototype.removeFromMap=function(e){for(var t=this.map_,n=t.length,i=0;i<n;i++)if(t[i]===e){t.splice(i,1);break}},Dn.prototype.meshClean=function(e){for(var t,n,i=[e];t=i.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),n=0;n<3;n++)t.constrained_edge[n]||i.push(t.getNeighbor(n))};NDS.Triangulator=new function(){function s(e,t,n){return n+":"+(e<t?e+":"+t:t+":"+e)}function h(){this.bbox=new THREE.Box2,this.left=null,this.right=null,this.node_edges=[]}function u(e,t,n){this.pts=e,this.edges=t,this.bbox=n,this.pipResult=!1}function e(e,t){this.edges=e,this.bbox=t,this.pts=[],this.idmap={},this.xymap={},this.contours=[],this.scale=1e6/this.bbox.getSize().length()}function t(e){this.indices=[],this.cset=e;var t=this.pts=e.pts;this.intervalTree=new u(e.pts,e.edges,e.bbox),this.intervalTree.build();for(var n=0;n<t.length;n++)t[n].id=n;var i=new Dn([]);if(i.points_=t.slice(),e.contours)for(var r=this.cset.contours,o=0;o<r.length;o++){var a=r[o],s=a[0]!==a[a.length-1];if(!s){for(var l=[],d=0;d<a.length-1;d++)l.push(t[a[d]]);i.initEdges(l,s)}}else for(var c=this.cset.edges,n=0;n<c.length;n++){var h=c[n];h.p1!=h.p2&&(h=[t[h.p1],t[h.p2]],i.initEdges(h,!0))}0<i.edge_list.length&&(this.triangulate(i),this.processResult(i))}u.prototype.splitNode=function(e){if(!(e.bbox.min.y>=e.bbox.max.y||e.node_edges.length<3)){var t=.5*(e.bbox.min.y+e.bbox.max.y);e.left=new h,e.right=new h;for(var n=this.pts,i=e.node_edges,r=[],o=new THREE.Vector2,a=0;a<i.length;a++){var s=this.edges[i[a]],l=n[s.p1].y,d=n[s.p2].y;d<l&&(c=l,l=d,d=c);var c=null;d<t?(e.left.node_edges.push(i[a]),c=e.left.bbox):t<l?(e.right.node_edges.push(i[a]),c=e.right.bbox):r.push(i[a]),c&&(o.set(n[s.p1].x,n[s.p1].y),c.expandByPoint(o),o.set(n[s.p2].x,n[s.p2].y),c.expandByPoint(o))}e.node_edges=r,e.left.node_edges.length&&this.splitNode(e.left),e.right.node_edges.length&&this.splitNode(e.right)}},u.prototype.build=function(){this.root=new h;for(var e=this.root.node_edges,t=0;t<this.edges.length;t++)e.push(t);this.root.bbox.copy(this.bbox),this.splitNode(this.root)},u.prototype.pointInPolygonRec=function(e,t,n){if(e.bbox.min.y<=n&&e.bbox.max.y>=n)for(var i=this.pts,r=e.node_edges,o=0,a=r.length;o<a;o++){var s=this.edges[r[o]],l=i[s.p1],d=l.x,c=l.y,h=i[s.p2],l=h.x,s=h.y,h=n<=s;n<=c!=h&&(l-t)*(c-s)<=(s-n)*(d-l)==h&&(this.pipResult=!this.pipResult)}var u=e.left;u&&u.bbox.min.y<=n&&u.bbox.max.y>=n&&this.pointInPolygonRec(u,t,n);e=e.right;e&&e.bbox.min.y<=n&&e.bbox.max.y>=n&&this.pointInPolygonRec(e,t,n)},u.prototype.pointInPolygon=function(e,t){return this.pipResult=!1,this.pointInPolygonRec(this.root,e,t),this.pipResult},e.prototype.getPointIndex=function(e,t,n){var i=this.idmap[n];if(void 0!==i)return i;var r=0|e*this.scale,o=0|t*this.scale,i=this.xymap[r],r=void 0===i?void(this.xymap[r]=i={}):i[o];return void 0===r&&(i[o]=r=this.pts.length,this.idmap[n]=r,this.pts.push({x:e,y:t})),r},e.prototype.snapEdges=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e];t.p1=this.getPointIndex(t.pt1.x,t.pt1.y,t.eid1),t.p2=this.getPointIndex(t.pt2.x,t.pt2.y,t.eid2)}},e.prototype.sanitizeEdges=function(){for(var e={},t=[],n=0,i=this.edges.length;n<i;n++){var r,o=this.edges[n];o.p1!==o.p2&&(!0!==e[r=Math.min(o.p1,o.p2)+":"+Math.max(o.p1,o.p2)]&&(e[r]=!0,t.push(o)))}this.edges=t},e.prototype.stitchContours=function(){for(var e={},t=0;t<this.edges.length;t++){var n=this.edges[t];n.p1!==n.p2&&(void 0!==e[n.p1]?e[n.p1].push(n.p2):e[n.p1]=[n.p2],void 0!==e[n.p2]?e[n.p2].push(n.p1):e[n.p2]=[n.p1])}var i=[];for(o in e)if(2!==e[o].length)break;for(;;){var r=void 0;for(o in e)if(1<e[o].length){r=o;break}if(!r)for(var o in e)if(0<e[o].length){r=o;break}if(!r)break;var a=-1,s=parseInt(r),l=e[r];for(i.push(s);l&&l.length;){var d=l.shift();if(void 0===(d=d===a?l.shift():d)){delete e[s];break}i.push(d),0!=l.length&&l[0]!==a||delete e[s],a=s,l=e[s=d]}i.length&&(this.contours.push(i),i=[])}for(var c=[],t=0;t<this.contours.length;t++)(p=this.contours[t])[0]!==p[p.length-1]&&c.push(p);if(c.length)for(var h=!0;h;){for(var h=!1,u={},f=this.contours,t=0;t<f.length;t++){var p,m=(p=f[t])[0],g=p[p.length-1];m!==g&&(u[m]?u[m].push(-t-1):u[m]=[-t-1],u[g]?u[g].push(t):u[g]=[t])}for(o in u){var v=u[o];if(2==v.length){var y,E,b=void 0;v[0]<0&&v[1]<0&&(y=-v[0]-1,f[E=-v[1]-1].shift(),Array.prototype.push.apply(f[y].reverse(),f[E]),b=E),v[0]<0&&0<v[1]&&(y=-v[0]-1,f[E=v[1]].pop(),Array.prototype.push.apply(f[E],f[y]),b=y),0<v[0]&&v[1]<0&&(y=v[0],E=-v[1]-1,f[y].pop(),Array.prototype.push.apply(f[y],f[E]),b=E),0<v[0]&&0<v[1]&&(y=v[0],E=v[1],f[y].pop(),Array.prototype.push.apply(f[y],f[E].reverse()),b=E),void 0!==b&&(f.splice(b,1),h=!0);break}}}},e.prototype.stitchContoursCheng=function(){for(var e={},t=0;t<this.edges.length;t++){var n=this.edges[t];n.p1!==n.p2&&(void 0!==e[n.p1]?e[n.p1].push(n.p2):e[n.p1]=[n.p2],void 0!==e[n.p2]?e[n.p2].push(n.p1):e[n.p2]=[n.p1])}for(var i=[];;){for(var r in e)if(1==e[r].length)for(var o in delete e[r],e){var a=parseInt(r),s=e[o].indexOf(a);-1!=s&&e[o].splice(s,1)}var l=!1;for(r in e)if(1==e[r].length){l=!0;break}if(!l)break}for(;;){var d=void 0;for(r in e)if(1<e[r].length){d=r;break}if(!d)for(var r in e)if(0<e[r].length){d=r;break}if(!d)break;var c=-1,a=parseInt(d),h=e[d];for(i.push(a);h&&h.length;){var u=h.shift();if(void 0===(u=u===c?h.shift():u)){delete e[a];break}i.push(u);for(l=!1,t=0;t<i.length-1;++t)if(u==i[t]){i=i.slice(t),l=!0;break}if(l)break;(0==h.length||h[0]===c)&&delete e[a],c=a,h=e[a=u]}i.length&&(this.contours.push(i),i=[])}for(var f=[],t=0;t<this.contours.length;t++)(v=this.contours[t])[0]!==v[v.length-1]&&f.push(v);if(f.length)for(var p=!0;p;){for(var p=!1,m={},g=this.contours,t=0;t<g.length;t++){var v,y=(v=g[t])[0],E=v[v.length-1];y!==E&&(m[y]?m[y].push(-t-1):m[y]=[-t-1],m[E]?m[E].push(t):m[E]=[t])}for(r in m){var b=m[r];if(2==b.length){var M,x,w=void 0;b[0]<0&&b[1]<0&&(M=-b[0]-1,g[x=-b[1]-1].shift(),Array.prototype.push.apply(g[M].reverse(),g[x]),w=x),b[0]<0&&0<b[1]&&(M=-b[0]-1,g[x=b[1]].pop(),Array.prototype.push.apply(g[x],g[M]),w=M),0<b[0]&&b[1]<0&&(M=b[0],x=-b[1]-1,g[M].pop(),Array.prototype.push.apply(g[M],g[x]),w=x),0<b[0]&&0<b[1]&&(M=b[0],x=b[1],g[M].pop(),Array.prototype.push.apply(g[M],g[x].reverse()),w=x),void 0!==w&&(g.splice(w,1),p=!0);break}}}},t.prototype.triangulate=function(e){try{e.triangulate()}catch(e){}},t.prototype.processResult=function(e){for(var t=0;t<e.map_.length;t++){var n=e.map_[t],i=n.points_[0],r=n.points_[1],n=n.points_[2];void 0!==i.id&&void 0!==r.id&&void 0!==n.id&&this.filterFace(i.id,r.id,n.id)}},t.prototype.pointInEdgeList=function(e,t){for(var n=this.cset.pts,i=this.cset.edges,r=!1,o=0,a=i.length;o<a;++o){var s,l=i[o],d=n[l.p1].x,c=n[l.p1].y,h=n[l.p2].x;t<=c!=(l=t<=(s=n[l.p2].y))&&(h-e)*(c-s)<=(s-t)*(d-h)==l&&(r=!r)}return r},t.prototype.pointInContour=function(e,t,n){for(var i,r,o,a=!1,s=this.cset.pts,l=s[n[n.length-1]].x,d=s[n[n.length-1]].y,c=t<=d,h=0,u=n.length;h<u;++h)r=s[n[h]].x,c!=(i=t<=(o=s[n[h]].y))&&(r-e)*(d-o)<=(o-t)*(l-r)==i&&(a=!a),c=i,l=r,d=o;return a},t.prototype.pointInPolygon=function(e,t){for(var n=!1,i=0;i<this.cset.contours.length;i++)this.pointInContour(e,t,this.cset.contours[i])&&(n=!n);return n},t.prototype.filterFace=function(e,t,n){var i=this.pts[e],r=this.pts[t],o=this.pts[n],a=(i.x+r.x+o.x)/3,s=(i.y+r.y+o.y)/3;this.intervalTree.pointInPolygon(a,s)&&(a=r.x-i.x,s=r.y-i.y,r=o.x-i.x,0<a*(o.y-i.y)-r*s?this.indices.push(e,t,n):this.indices.push(e,n,t))},this.TriangulatedSurface=t,this.ContourSet=e,this.Edge=function(e,t,n,i,r,o,a){this.pt1=e,this.pt2=t,this.p1=-1,this.p2=-1,this.eid1=s(n,i,a),this.eid2=s(r,o,a)}};NDS.Intersector=new function(){var M=1e-10,x=NDS.Triangulator.Edge;function h(e){return Math.abs(e)<M}this.intersectSegmentPlane=function(e,t,n,i,r){var o=(new THREE.Vector3).subVectors(n,t);if(h(a=e.normal.dot(o)))return i.copy(t),r.copy(n),2;var a=1/a,a=-(t.dot(e.normal)*a+e.constant*a);if(a<-M||1+M<a)return 0;t=o.multiplyScalar(a).add(t);return i.copy(t),1},this.intersectTrianglePlane=function(e,t,n,i,r,o,a,s,l){var d=new THREE.Vector3,c=new THREE.Vector3,h=e.distanceToPoint(t),u=e.distanceToPoint(n),f=e.distanceToPoint(i);if(h<-M&&u<-M&&f<-M)return null;if(M<h&&M<u&&M<f)return null;var p,m,g,v,y,E,b,h=Math.sign(h),u=Math.sign(u),f=Math.sign(f);if(0===h&&0===u&&0===f)return null;if(h!==u){if(2==(b=this.intersectSegmentPlane(e,t,n,d,c)))return void s.push(new x(t.clone(),n.clone(),r,r,o,o,l));1==b&&(g=r,v=o,p=d.clone())}if(u!==f){if(2==(b=this.intersectSegmentPlane(e,n,i,d,c)))return void s.push(new x(n.clone(),i.clone(),o,o,a,a,l));1==b&&(p?d.distanceTo(p)>M&&(y=o,E=a,m=d.clone()):(g=o,v=a,p=d.clone()))}if(f!==h){if(2==(b=this.intersectSegmentPlane(e,i,t,d,c)))return void s.push(new x(i.clone(),t.clone(),a,a,r,r,l));1==b&&p&&d.distanceTo(p)>M&&(y=a,E=r,m=d.clone())}p&&m&&s.push(new x(p,m,g,v,y,E,l))},this.intersectBoxPlane=function(e,t){var n=new THREE.Vector3;n.set(t.min.x,t.min.y,t.min.z);var i=e.distanceToPoint(n),r=Math.sign(i);n.set(t.min.x,t.min.y,t.max.z);i=e.distanceToPoint(n);return Math.sign(i)!==r||(n.set(t.min.x,t.max.y,t.min.z),i=e.distanceToPoint(n),Math.sign(i)!==r||(n.set(t.min.x,t.max.y,t.max.z),i=e.distanceToPoint(n),Math.sign(i)!==r||(n.set(t.max.x,t.min.y,t.min.z),i=e.distanceToPoint(n),Math.sign(i)!==r||(n.set(t.max.x,t.min.y,t.max.z),i=e.distanceToPoint(n),Math.sign(i)!==r||(n.set(t.max.x,t.max.y,t.min.z),i=e.distanceToPoint(n),Math.sign(i)!==r||(n.set(t.max.x,t.max.y,t.max.z),i=e.distanceToPoint(n),Math.sign(i)!==r))))))},this.intersectMeshPlane=function(e,t,n,i,r){var o,a,s,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Matrix4,u=new THREE.Plane,f=t,p=r.length,t=f.attributes,m=n;if(h.getInverse(m),u.copy(e).applyMatrix4(h),void 0!==t.index||null!=f.index){var g=(t.index?t:f).index.array,v=f.vb||t.position.array,y=f.vb?f.vbstride:3;t.position&&t.position instanceof THREE.InterleavedBufferAttribute&&(v=t.position.data.array,y=t.position.data.stride);var E=f.groups;E&&0!==E.length||(E=[{start:0,count:g.length,index:0}],f.drawRange&&f.drawRange.count!=1/0&&(E[0].start=f.drawRange.start,E[0].count=f.drawRange.count));for(var b=0,M=E.length;b<M;++b)for(var x=E[b].start,w=E[b].count,I=E[b].index,S=x,T=x+w;S<T;S+=3)o=I+g[S],a=I+g[S+1],s=I+g[S+2],l.x=v[o*y],l.y=v[o*y+1],l.z=v[o*y+2],d.x=v[a*y],d.y=v[a*y+1],d.z=v[a*y+2],c.x=v[s*y],c.y=v[s*y+1],c.z=v[s*y+2],this.intersectTrianglePlane(u,l,d,c,o,a,s,r,i)}else{v=f.vb||t.position.array,y=f.vb?f.vbstride:3;t.position&&t.position instanceof THREE.InterleavedBufferAttribute&&(v=t.position.data.array,y=t.position.data.stride);for(S=0,T=v.length;S<T;S+=3,0)a=(o=S)+1,s=S+2,l.x=v[o*y],l.y=v[o*y+1],l.z=v[o*y+2],d.x=v[a*y],d.y=v[a*y+1],d.z=v[a*y+2],c.x=v[s*y],c.y=v[s*y+1],c.z=v[s*y+2],this.intersectTrianglePlane(u,l,d,c,o,a,s,r,i)}for(S=p,T=r.length;S<T;S++)r[S].pt1.applyMatrix4(m),r[S].pt2.applyMatrix4(m)},this.makePlaneBasis=function(e){var t,n,i,r,o,a,s=new THREE.Vector3(0,0,1),l=(l=e.normal.clone().cross(s)).normalize(),d=s.dot(e.normal),c=new THREE.Matrix4;return h(l.x)&&h(l.y)&&h(l.z)?c.elements[14]=d*e.constant:(t=l,i=c,r=n=d,o=Math.sqrt(1-r*r),a=1-r,s=t.x,l=t.y,d=t.z,n=a*s,t=a*l,i.set(n*s+r,n*l-o*d,n*d+o*l,0,n*l+o*d,t*l+r,t*d-o*s,0,n*d-o*l,t*d+o*s,a*d*d+r,0,0,0,0,1),c.elements[14]=e.constant),c},this.convertToPlaneCoords=function(e,t,n){for(var i=0,r=t.length;i<r;i++){var o=t[i];o.pt1.applyMatrix4(e),o.pt2.applyMatrix4(e),n.expandByPoint(o.pt1),n.expandByPoint(o.pt2)}}};var t=["#if NUM_CUTPLANES > 0","uniform vec4 cutplanes[NUM_CUTPLANES];","#ifdef CUTPLANES_LINE","uniform vec3 cutplanesOutlineColor;","uniform float cutplanesOutlineThickness;","#endif","bool checkCutPlanes() {","bool isCut = false;","#ifdef CUTPLANES_LINE","bool isCutEdge = false;","float eyeDist = length(vViewPosition);","#endif","for (int i=0; i<NUM_CUTPLANES; i++) {","float dotPlane = dot(vec4(vWorldPosition, 1.0), cutplanes[i]);","isCut = isCut || (dotPlane > 0.0);","#ifdef CUTPLANES_LINE","isCutEdge = isCutEdge || (dotPlane > -cutplanesOutlineThickness*eyeDist);","#endif","}","if (isCut) {","discard;","return true;","}","#ifdef CUTPLANES_LINE","else if (isCutEdge) {","gl_FragColor = vec4(cutplanesOutlineColor, 1.0);","return true;","}","#endif","return false;","}","#endif"].join("\n"),yt=["vec4 packDepth( const in float depth ) {","vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;","enc = fract(enc);","enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);","return enc;","}","float unpackDepth( const in vec4 rgba_depth ) {","return dot( rgba_depth, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );","}"].join("\n"),Hn={uniforms:{cutplanes:{type:"v4v",value:[]}},vertexShader:["#ifdef USE_LOGDEPTHBUF","    #ifdef USE_LOGDEPTHBUF_EXT","        varying float vFragDepth;","    #endif","    uniform float logDepthBufFC;","#endif","#if NUM_CUTPLANES > 0","varying vec3 vWorldPosition;","#endif","void main() {","#ifdef USE_MODELMATRIXATTRIB","    mat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;","    gl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );","#else","    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );;","#endif","#if NUM_CUTPLANES > 0","    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","    vWorldPosition = worldPosition.xyz;","#endif","#ifdef USE_LOGDEPTHBUF","    gl_Position.z = log2(max(1e-6, gl_Position.w + 1.0)) * logDepthBufFC;","    #ifdef USE_LOGDEPTHBUF_EXT","        vFragDepth = 1.0 + gl_Position.w;","    #else","        gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;","    #endif","#endif","}"].join("\n"),fragmentShader:["#ifdef USE_LOGDEPTHBUF","    uniform float logDepthBufFC;","    #ifdef USE_LOGDEPTHBUF_EXT","        #extension GL_EXT_frag_depth : enable","        varying float vFragDepth;","    #endif","#endif",yt,"#if NUM_CUTPLANES > 0","varying vec3 vWorldPosition;","#endif",t,"void main() {","#if NUM_CUTPLANES > 0","if (checkCutPlanes()) return;","#endif","#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)","gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;","#endif","#ifdef USE_LOGDEPTHBUF_EXT","float depth = gl_FragDepthEXT / gl_FragCoord.w;","#else","float depth = gl_FragCoord.z / gl_FragCoord.w;","#endif","depth = 1.0 - depth;","gl_FragColor = packDepth(depth);","}"].join("\n")},Nn={uniforms:{tDepth:{type:"t",value:null},worldSize:{type:"v3",value:new THREE.Vector3(1,1,1)}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#define NUM_SAMPLES 29.0","#define NUM_SPIRAL_TURNS 7.0","uniform sampler2D tDepth;","uniform vec3 worldSize;","varying vec2 vUv;","#ifdef PRESET_2","#define SAMPLE_RADIUS 0.3","#define AO_GAMMA 1.0","#define AO_INTENSITY 1.0","#else","#define SAMPLE_RADIUS 0.2","#define AO_GAMMA 3.0","#define AO_INTENSITY 0.8","#endif",yt,"#define PI 3.14159265358979","float rand(vec2 co) {","return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);","}","float getRandomAngle(vec2 pos) {","return rand(pos) * (2.0 * PI);","}","vec2 tapLocation(float sampleNumber, float spinAngle, out float ssR){","float alpha = float(sampleNumber + 0.5) * (1.0 / NUM_SAMPLES);","float angle = alpha * (NUM_SPIRAL_TURNS * PI * 2.0) + spinAngle;","ssR = alpha;","return vec2(cos(angle), sin(angle));","}","vec2 sampleAO(vec2 unitDirection, float radius) {","vec2 sampleOffset = unitDirection * radius;","float idepth = unpackDepth(texture2D(tDepth, vUv + sampleOffset));","float depth = 1.0 - idepth;","if (depth < 1e-6) {","if (radius == 0.0)","return vec2(1.0, 1.0);","else","return vec2(0.0, 1.0);","}","vec3 dir = vec3(sampleOffset.x, depth, sampleOffset.y) * worldSize;","float distance2 = dot(dir,dir);","float idistance = 1.0 / sqrt(distance2);","vec3 ndir = dir * idistance;","#ifdef PRESET_2","float importance = ndir.y * idistance;","#else","float importance = ndir.y / distance2;","#endif","vec2 ret;","ret.x = (idepth == 0.0) ? 0.0 : importance;","ret.y = importance;","return ret;","}","void main() {","vec2 sum = vec2(0.0);","float angle = getRandomAngle(vUv);","for (float i = 0.0; i<NUM_SAMPLES; i+= 1.0) {","float ssR;","vec2 uv = tapLocation(i, angle, ssR);","sum += sampleAO(uv, ssR * SAMPLE_RADIUS);","}","float ao = sum.x / sum.y;","gl_FragColor = packDepth(AO_INTENSITY * clamp(pow(ao, AO_GAMMA), 0.0, 0.9999));","}"].join("\n")},Fn={uniforms:{tDepth:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + KERNEL_SCALE*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + KERNEL_SCALE*(Y))","#endif",yt,"#define PI 3.14159265358979","#define SIGMA ((2.0 * KERNEL_RADIUS+1.0) / 6.0)","#define SIGMASQ2 (2.0 * SIGMA * SIGMA)","#ifdef BOX","#define KERNEL_VAL(X) 1.0","#else","#define KERNEL_VAL(X) ( (1.0 / sqrt(PI * SIGMASQ2)) * exp(-(X)*(X)/SIGMASQ2) )","#endif","void main() {","float depthVal = 0.0;","float sum = 0.0;","for (float x=-KERNEL_RADIUS; x<=KERNEL_RADIUS; x+=1.0) {","depthVal += unpackDepth(texture2D(tDepth, GET_UV(x))) * KERNEL_VAL(x);","sum += KERNEL_VAL(x);","}","gl_FragColor = packDepth(depthVal/sum);","}"].join("\n")},_n={uniforms:{tDepth:{type:"t",value:null},uShadowColor:{type:"v4",value:new THREE.Vector4(0,0,0,1)}},vertexShader:["varying vec2 vUv;","void main() {","    vUv = vec2(uv.x, uv.y);","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","uniform vec4 uShadowColor;","varying vec2 vUv;",yt,"void main() {","float depthVal = unpackDepth(texture2D(tDepth, vUv));","#ifdef DARKNESS_SCALE","depthVal *= DARKNESS_SCALE;","#endif","gl_FragColor = vec4(uShadowColor.rgb, uShadowColor.a * depthVal);","}"].join("\n")},kn=function(e,t,n){var r,i,o,a,s,l,d,c,h,u,f,p,m=e,g=t,v=!1,y=this,E={texSize:64,pixScale:1,blurRadius:7,debug:!1};function b(e){return new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(e.uniforms),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,defines:THREE.UniformsUtils.clone(e.defines)})}if(this.setTransform=function(e,t,n,i){r.left=-t.z/2,r.right=t.z/2,r.top=t.x/2,r.bottom=-t.x/2,r.near=1,r.far=t.y+r.near,r.updateProjectionMatrix(),r.position.addVectors(e,n.clone().multiplyScalar(-t.y/2-r.near)),i&&r.up.set(i.x,i.y,i.z),r.lookAt(e),o.position.set(e.x,e.y,e.z),o.rotation.set(r.rotation.x,r.rotation.y,r.rotation.z),o.scale.set(t.z,t.x,t.y),E.debug&&(p.position.set(e.x,e.y,e.z),p.rotation.set(r.rotation.x,r.rotation.y,r.rotation.z),p.scale.set(t.z,t.x,t.y)),f.uniforms.worldSize.value.copy(t)},this.renderIntoShadow=function(e){var t;e.overrideMaterial&&e.overrideMaterial.transparent||(t=e.overrideMaterial,e.overrideMaterial=l,m.ndsModel&&(m.ndsModel.backupDirty(),m.ndsModel.setDirty(),m.ndsModel.setDrawMode(m.ndsModel.SHADED),m.scene.children.push(m.ndsModel),m.ndsModel.setOverrideMaterial(l,d,!1)),g.render(e,r,a,!1),e.overrideMaterial=t,m.ndsModel&&(m.ndsModel.setOverrideMaterial(null,null,!1),m.ndsModel.resetDirty()))},this.renderShadow=function(e,t){v&&(t?g.render(i,e,t,!1):g.render(i,e))},this.postprocess=function(){u.render(g,s,a),h.render(g,a,s),v=!0},this.clear=function(){var e=g.getClearColor().getHex(),t=g.getClearAlpha();g.setClearColor(0,0),g.clearTarget(a,!0,!0,!1),g.setClearColor(e,t),v=!1},this.getRenderTarget=function(){return a},this.setColor=function(e){c.uniforms.uShadowColor.value.x=e.r,c.uniforms.uShadowColor.value.y=e.g,c.uniforms.uShadowColor.value.z=e.b},this.getColor=function(){return new THREE.Color(c.uniforms.uShadowColor.value.x,c.uniforms.uShadowColor.value.y,c.uniforms.uShadowColor.value.z)},this.setAlpha=function(e){c.uniforms.uShadowColor.value.w=e},this.getAlpha=function(){return c.uniforms.uShadowColor.value.w},this.isValid=function(){return v},this.getDepthMaterial=function(){return l},this.updateGroundTransform=function(e,t,n){var i,r,o;y.enabled&&t&&(y.needClear=!0,o=t.clone(),i=new THREE.Vector3(1,0,0),r=o.getCenter(),t=o.getSize(),e.worldUpTransform&&(i.applyMatrix4(e.worldUpTransform),o.applyMatrix4(e.worldUpTransform),t=o.size()),o=t.x>t.z?t.x/t.z:t.z/t.x,t.multiply(new THREE.Vector3(1.25,1.01,1.25)),t.x=t.z=Math.max(t.x,t.z),n?y.setTransform(r,t,n,i):y.setTransform(r,t,e.up,i),--o<5&&(o/=500),0<(o=2/Math.PI*Math.atan(o))&&(c.defines.DARKNESS_SCALE=1.00001+o))},n)for(var M in E)E[M]=n[M]||E[M];i=new THREE.Scene,r=new THREE.OrthographicCamera,(a=new THREE.WebGLRenderTarget(E.texSize,E.texSize,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1,(s=new THREE.WebGLRenderTarget(E.texSize,E.texSize,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1,(l=b(Hn)).defines.NUM_CUTPLANES=0,l.side=THREE.DoubleSide,l.blending=THREE.NoBlending,d=(new l.constructor).copy(l),h=new Le(Fn,"tDepth"),u=new Le(Fn,"tDepth"),f=new Le(Nn,"tDepth"),h.material.defines.KERNEL_SCALE=u.material.defines.KERNEL_SCALE=(E.pixScale/E.texSize).toFixed(4),h.material.defines.KERNEL_RADIUS=u.material.defines.KERNEL_RADIUS=E.blurRadius.toFixed(2),f.material.blending=h.material.blending=u.material.blending=THREE.NoBlending,f.material.depthWrite=h.material.depthWrite=u.material.depthWrite=!1,f.material.depthTest=h.material.depthTest=u.material.depthTest=!1,h.material.defines.HORIZONTAL=1,(c=b(_n)).uniforms.tDepth.value=a,c.depthWrite=!1,c.transparent=!0,c.defines.NUM_CUTPLANES=0,(t=new THREE.BufferGeometry).addAttribute("position",new THREE.BufferAttribute(new Float32Array([-.5,-.5,.5,-.5,.5,.5,.5,.5,.5,.5,-.5,.5]),3)),t.addAttribute("uv",new THREE.BufferAttribute(new Float32Array([0,0,0,1,1,1,1,0]),2)),t.setIndex(new THREE.BufferAttribute(new Uint16Array([0,1,2,2,3,0]),1)),o=new THREE.Mesh(t,c),i.add(o),E.debug&&(p=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:65280,wireframe:!0})),i.add(p)),this.setTransform(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0))};function Vn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jn(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Un(e,t,n){return t&&jn(e.prototype,t),n&&jn(e,n),e}kn.prototype.constructor=kn;var zn=function(){function e(){Vn(this,e),this.name="",this.prototypeMap=new Map}return Un(e,[{key:"overrideValue",value:function(e,t,n){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set(t,{type:"value",value:n})}},{key:"overrideFunction",value:function(e,t,n){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set(t,{type:"function",value:n})}},{key:"overridePrototype",value:function(e,t){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set("",{type:"prototype",value:t})}},{key:"load",value:function(r){this.isLoad||(this.prototypeMap.forEach(function(e,i,t){e.forEach(function(e,t,n){"prototype"===e.type?(e.lastValue=NDSWebViewer[i].prototype,NDSWebViewer[i].prototype=e.value):("Viewer"===i&&r&&(r[t]=e.value),e.lastValue=NDSWebViewer[i].prototype[t],NDSWebViewer[i].prototype[t]=e.value)})}),this.isLoad=!0)}},{key:"unload",value:function(r){this.isLoad&&(this.prototypeMap.forEach(function(e,i,t){e.forEach(function(e,t,n){"prototype"===e.type?NDSWebViewer[i].prototype=e.lastValue:("Viewer"===i&&r&&(r[t]=e.lastValue),NDSWebViewer[i].prototype[t]=e.lastValue)})}),this.isLoad=!1)}},{key:"update",value:function(e){}}]),e}(),Gn=function(){function e(){Vn(this,e)}return Un(e,null,[{key:"addExtension",value:function(e){this.extensions.set(e.name,e)}},{key:"removeExtension",value:function(e){this.extensions.has(e)&&this.extensions.get(e).unload(),this.extensions.delete(e)}},{key:"getExtension",value:function(e){return this.extensions.get(e)}},{key:"update",value:function(i){this.extensions.forEach(function(e,t,n){e.update(i)})}}]),e}();function Wn(e){return(Wn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Yn(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Xn(e){return(Xn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Zn(e,t){return(Zn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function qn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}Gn.extensions=new Map,function(){for(var o=0,e=["ms","moz","webkit","o"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var n=(new Date).getTime(),i=Math.max(0,16-(n-o)),r=window.setTimeout(function(){e(n+i)},i);return o=n+i,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),NDS.StartRenderTime=Date.now();var Qn=function(){function he(h){var x;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,he),e=this,i=Xn(he).call(this),x=!i||"object"!==Wn(i)&&"function"!=typeof i?qn(e):i,console.log("NDSViewer3D v4.1.006"),document.body.style.cssText="margin: 0; overflow: hidden",document.addEventListener("contextmenu",function(e){e.preventDefault()},!1),x.fontsManager=new Rt(qn(qn(x)));var w=qn(qn(x)),I=[];x.animationClock=new THREE.Clock,x.animationsManager=new Ve(qn(qn(x))),x.pmiObject=null,x.pmiVisible=!0,x.viewerPMIVisible=!0,x.haspartPMI=!1,x.hasAssemblyPMI=!1,x.PartPmiVisible=!0,x.AssemblyPMIVisible=!0,x.PartPMIuuid=[],x.explodeObjects=[],x.brepManager=null,x.inWaitProcedure=!1,x.inWheel=!1,x.AssemblyPMIState=null,x.PartPMIState=null,x.exchangeBackImage=null,x.exchangeNodeColor=[],Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:function(e,t){return new Uint8Array(Array.prototype.slice.call(this,e,t))}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){return e&&(this.filter(e)||[])[0]}}),x.addFrameListener=function(e){for(var t=0,n=I.length;t<n;t++)if(I[t]==e)return;I.push(e)},x.removeFrameListener=function(e){for(var t=0;t<I.length;t++)I[t]==e&&I.splice(t,1)},w.lights=[],w.lightControls=null,w.viewer2DInfo={center:new THREE.Vector3(0,0,0),normal:new THREE.Vector3(0,0,1),yDir:new THREE.Vector3(0,1,0),distance:100};var u=new THREE.LoadingManager;w.annotationsManager=void 0,w.materialsSetting=void 0,w.propertyManager=new Zt(w),w.containProperty=!1;var a=null;x.trueMapList=null,h.materialsSetting&&(a=h.materialsSetting,h.materialsSetting=void 0);var S=void 0!==(h=h||{}).is2DViewer&&h.is2DViewer;w.is2DViewer=S,w.loadbrepDefault=h.loadbrepDefault,w.testMode=void 0!==h.testMode&&h.testMode,w.is2DModel=void 0!==h.is2DModel&&h.is2DModel,w.renderMode=void 0===h.viewState?"shaded":h.viewState,w.viewerPMIVisible=void 0===h.pmiVisible||h.pmiVisible,w.bBackGroundTransparent=void 0!==h.backGroundTransparent&&h.backGroundTransparent,w.bLinesVisibility=void 0===h.showLines||h.showLines,w.bShowToolTip=void 0===h.showToolTip||h.showToolTip,w.bToolBarAutoHide=void 0===h.toolBarAutoHide||h.toolBarAutoHide,w.bMouseWheelForwardEnlarge=void 0===h.mouseWheelForwardEnlarge||h.mouseWheelForwardEnlarge,w.bHasLoadingWaiter=void 0===h.hasLoadingWaiter||h.hasLoadingWaiter,w.bHasLoadingCoverer=void 0===h.hasLoadingCoverer||h.hasLoadingCoverer,w.bHasLoadingStater=void 0!==h.hasLoadingStater&&h.hasLoadingStater,w.limitEventArea=void 0===h.limitEventArea?void 0:h.limitEventArea,w.convertPhongToPBR=void 0!==h.convertPhongToPBR&&h.convertPhongToPBR,w.reflected=void 0!==h.reflected&&h.reflected,w.enableInternalRMB=void 0!==h.enableInternalRMB&&h.enableInternalRMB,w.hasViewBox=void 0===h.hasViewBox||h.hasViewBox,w.showSectionPlane=void 0!==h.showSectionPlane&&h.showSectionPlane,w.viewBoxSize=h.viewBoxSize,h.angles&&0<h.angles.length?w.Euler=new THREE.Euler(THREE.Math.degToRad(h.angles[0]),THREE.Math.degToRad(h.angles[1]),THREE.Math.degToRad(h.angles[2])):w.Euler=null,w.disratio=void 0===h.disratio?1:h.disratio,w.parameters=h,ye.setMobileDevice(h.from),w.watermark=void 0===h.Arthur?null:h.Arthur,w.excalibur=!0;w.watermark&&(w.watermark=function(e){for(var t=new String,n=new Array,i=new Array,r=e.length,o=0;o<r;o++)n[o]=e.charCodeAt(o),i[o]=e.charCodeAt(o+1);for(o=0;o<r;o+=2)t+=String.fromCharCode(n[o]-i[o]);return t}(w.watermark)),w.watermark&&4<w.watermark.length&&"9527"===w.watermark.substr(0,4)&&(w.excalibur=!1),w.turnoffAnimation=void 0!==h.turnoffAnimation&&h.turnoffAnimation,w.defaultStandardView=h.defaultStandardView,w.bDefaultOpRotate=void 0===h.defaultOpRotate||h.defaultOpRotate,void 0!==h.toolbarButtonClickedBkgColor&&(Ue.toolbarButtonClickedBkgColor=h.toolbarButtonClickedBkgColor),Ue.avoidCaching=void 0===h.avoidCaching||h.avoidCaching,Ue.lineColor=void 0===h.lineColor?void 0:h.lineColor,Ue.lineSegAnnotationGridCount=void 0===h.lineSegAnnotationGridCount?200:h.lineSegAnnotationGridCount,Ue.enableBroadcast=void 0!==h.enableBroadcast&&h.enableBroadcast,Ue.broadcastMajor=void 0!==h.broadcastMajor&&h.broadcastMajor,Ue.enableSelect=void 0!==h.enableSelect&&h.enableSelect,Ue.autoSwitchFirstPersonView=void 0!==h.autoSwitchFirstPersonView&&h.autoSwitchFirstPersonView,Ue.tangentEdgeVisible=void 0===h.tangentEdgeVisible||h.tangentEdgeVisible,Ue.enableArrowKeyOp=void 0===h.enableArrowKeyOp||h.enableArrowKeyOp,Ue.dynamicRotateCenter=void 0===h.dynamicRotateCenter||h.dynamicRotateCenter,Ue.enableOutlineEffect=void 0!==h.enableOutlineEffect&&h.enableOutlineEffect,Ue.enableBodyVolumeMeasure=void 0!==h.enableBodyVolumeMeasure&&h.enableBodyVolumeMeasure,Ue.enablePreSelectBrep=void 0!==h.enablePreSelectBrep&&h.enablePreSelectBrep,Ue.enableTextRenderingBothSide=void 0===h.enableTextRenderingBothSide||h.enableTextRenderingBothSide,Ue.selectObjectWithPropertyOnly=void 0!==h.selectObjectWithPropertyOnly&&h.selectObjectWithPropertyOnly,Ue.enableDirectMove=void 0!==h.enableDirectMove&&h.enableDirectMove,Ue.enableDirectRotate=void 0!==h.enableDirectRotate&&h.enableDirectRotate,Ue.inAssemblyContext=void 0!==h.inAssemblyContext&&h.inAssemblyContext,Ue.inBIMContext=void 0!==h.inBIMContext&&h.inBIMContext,Ue.modelUpDirection=void 0===h.modelUpDirection?"posy":h.modelUpDirection,Ue.bodyOpacity=void 0===h.bodyOpacity?.4:h.bodyOpacity,Ue.lineOpacity=void 0===h.lineOpacity?.2:h.lineOpacity,w.is2DModel&&(Ue.enableTextRenderingBothSide=!1),h.inAssemblyContext&&(w.excalibur=!1),void 0!==h.loadWorkerUrl&&(Ue.loadWorkerUrl=h.loadWorkerUrl),void 0!==h.BreploadWorkerUrl&&(Ue.BreploadWorkerUrl=h.BreploadWorkerUrl),w.oneKeyColor={isActive:!1,color:0},x.broadcastManager=new pt(qn(qn(x))),x.selectionManager=new Jt(qn(qn(x))),x.brepLoadIndex=0,x.brepInfo={BfaceArea:!1,BbodyVolume:!1,BbodyArea:!1,BtotalArea:!1,BfacePerimeter:!1};var t=!0,f=!0,n=null;void 0!==h.id&&(n=document.getElementById(h.id));var s=h.toolbar;void 0===s&&(s=!0),w.toolbarInitialVisibility=void 0===h.toolbarInitialVisibility||h.toolbarInitialVisibility,null==n&&(n=new NDS.Element,n=document.body.appendChild(n.domElement));var e=new NDS.Element({className:"container"});e.domElement.style.width=n.style.width,e.domElement.style.height=n.style.height,x.container=n.appendChild(e.domElement),x.container.id="t_container";var p=0,m=0,l=0,i=x.container.getBoundingClientRect();x.isRunning=!1;x.enableProgressiveRender=!0;w.bBackGroundTransparent?x.renderer=new Ot({antialias:!0,alpha:!0,is2DModel:x.is2DModel}):x.renderer=new Ot({antialias:!0,is2DModel:x.is2DModel}),he.renderer=x.renderer,x.isiPhone=!1,x.deviceMemory=2,navigator&&-1!==navigator.userAgent.toLowerCase().indexOf("iphone")&&(x.isiPhone=!0,(r=x.renderer.getContext().getExtension("WEBGL_debug_renderer_info"))&&(-1!==(o=x.renderer.getContext().getParameter(r.UNMASKED_RENDERER_WEBGL)).indexOf("A8")?x.deviceMemory=1:-1!==o.indexOf("A1")&&3<=window.devicePixelRatio&&(x.deviceMemory=3)));var T=!!x.renderer.getContext().getContextAttributes().antialias,e=x.renderer.extensions;Ue.OES_element_index_uint=!!e.get("OES_element_index_uint"),x.renderer.setPixelRatio(window.devicePixelRatio),x.renderer.setSize(i.width,i.height),w.bBackGroundTransparent?x.renderer.setClearColor(11912911,0):x.renderer.setClearColor(11912911,1);var r=void 0===h.backGroundColor?16777215:h.backGroundColor;w.bBackGroundTransparent?x.renderer.setClearColor(r,0):x.renderer.setClearColor(r,1),x.clearColor="0xb5c6cf",x.renderer.autoClear=!1;var o=x.renderer.domElement;o.className="canvas3DBIM",o.id="canvas3D_"+Date.now(),x.canvas3D=o,x.container.appendChild(o),h.has2DCover&&(x.canvas2D=document.createElement("canvas"),x.canvas2D.className="canvas2DBIM",x.canvas2D.id="canvas2D_"+Date.now(),x.container.appendChild(x.canvas2D),x.canvas2DLayer=document.createElement("canvas"),x.canvas2DLayer.className="canvas2DLayer",x.canvas2DLayer.id="canvas2DLayer_"+Date.now(),x.container.appendChild(x.canvas2DLayer)),x.progressBar=document.createElement("div"),x.progressBar.style.cssText="display: block; position: absolute; z-index: 2;left: 2px; bottom: 2px; height: 4px; width: 200px;background: rgba(0,0,0,1);visibility: hidden;",x.progressBarFrontground=document.createElement("div"),x.progressBarFrontground.style.cssText="height: 4px; width: 200px;background: #04d83a;",x.progressBar.appendChild(x.progressBarFrontground),x.container.appendChild(x.progressBar),x.progressBarWidth=200,x.scene=new THREE.Scene,x.scene.autoUpdate=!1,x.meshLoadedUUIDs=void 0,x.modelRootObject=void 0,x.additionalObjectsScene=new THREE.Scene;var g=void 0,A=0,R=null,d=x.scene,O=0,P=!1;x.camera=new fe(i.width/i.height),h.cameraInfo&&x.camera.setOrginalCameraInfo({center:new THREE.Vector3(h.cameraInfo.target.x,h.cameraInfo.target.y,h.cameraInfo.target.z),up:new THREE.Vector3(h.cameraInfo.up.x,h.cameraInfo.up.y,h.cameraInfo.up.z),position:new THREE.Vector3(h.cameraInfo.position.x,h.cameraInfo.position.y,h.cameraInfo.position.z),fov:h.cameraInfo.fov,near:h.cameraInfo.near,far:h.cameraInfo.far,isPerspective:h.cameraInfo.isPerspective,width:h.cameraInfo.width,height:h.cameraInfo.height,modelScreenBBox:h.cameraInfo.modelScreenBBox}),(null!=h.projectionMode&&"Orthographic"==h.projectionMode||null!=h.cameraInfo&&0==h.cameraInfo.isPerspective)&&x.camera.toOrthographic(),x.cameraControl=new pe(qn(qn(x))),x.cameraControl.setAutoRotateSpeed(.5),S&&(function(){var e=new THREE.AmbientLight(16777215);d.add(e)}(),S&&(w.camera.near=.1,w.camera.far=6e3,w.camera.position.set(0,0,100),w.camera.lookAt(new THREE.Vector3(0,0,0))));e=.25,r=.45;null!=w.convertPhongToPBR&&1==w.convertPhongToPBR&&(e=.5,r=.8,w.reflected&&(e=1,r=1.2));var c=void 0===h.directionLightIntensity?e:h.directionLightIntensity,v=(void 0===h.directionLightColor||h.directionLightColor,void 0===h.hemiSphereLightIntensity?r:h.hemiSphereLightIntensity);void 0===h.hemiSphereLightColor||h.hemiSphereLightColor;x.groundShadow=new kn(qn(qn(x)),x.renderer),x.groundShadow.enabled=!0,x.backGroundScene=void 0,x.backGroundCamera=void 0,x.backGroundMesh=void 0,x.envMapCamera=void 0,x.envMapScene=void 0,x.envMapTexture=void 0;var C=(x.envMapMaterial=void 0)!==h.hideEnvMap&&h.hideEnvMap,y=void 0!==h.enableEnvMap&&h.enableEnvMap,E=(E=void 0===h.envMapMode?"reflection":h.envMapMode).toLowerCase();x.envMapBlurTargetH=void 0,x.envMapBlurTargetV=void 0,x.envMapBlurPassH=void 0;var B=(x.envMapBlurPassV=void 0)!==h.enableEnvMapBlur&&h.enableEnvMapBlur,b=void 0===h.envMapBlurVersion?2:h.envMapBlurVersion,M=2,L=void 0===h.envMapBlurLevel?0:h.envMapBlurLevel;0==L&&(B=!1,L=1),T||(z=x.renderer.getPixelRatio(),x.effectRenderTarget=new THREE.WebGLRenderTarget(i.width*z,i.height*z,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),void 0===h.fxaaVersion&&(h.fxaaVersion=1),1==h.fxaaVersion?x.effectFXAA=new Oe(Ie):x.effectFXAA=new Oe(Se),x.effectFXAA.renderToScreen=!0),Ue.enableOutlineEffect&&(x.outlinePass=new Be(qn(qn(x)),new THREE.Vector2(i.width*z,i.height*z),x.scene,x.camera));i=new me(qn(qn(x)));S||!1===x.bDefaultOpRotate?i.setOperator(new ct(qn(qn(x)))):i.setOperator(new dt(qn(qn(x)))),x.controls=i,x.originalMeshes=new Array,x.isolateMeshes=new Array,x.modelInfo=[],x.modelUnit=null,x.userModelUnit=null,x.draggedObjects=void 0;var D=new THREE.Vector2(-1,-1),H=(new THREE.Vector3(1,1.5,1),new THREE.Vector3(0,2e3,0),!0),N=!1,F=!1,_=void 0===h.enableGroundShadow||h.enableGroundShadow,k=0,V=!1,j=void 0===h.enableSmoothTranslation||h.enableSmoothTranslation,U=void 0===h.enableAutoRotation||h.enableAutoRotation,z=void 0===h.clipPlaneShaderVersion?1:h.clipPlaneShaderVersion;x.clipPlaneManager=new St(qn(qn(x)),z,w.showSectionPlane),x.clipBoxManager=new It(qn(qn(x)),qn(qn(x)),z);var G=null==h.modelOperationMode?"normal":h.modelOperationMode;x.originalModelOperationMode=G;var W=void 0;null!=h.modelOperationVerticalRotationRange&&Array.isArray(h.modelOperationVerticalRotationRange)&&2<=h.modelOperationVerticalRotationRange.length&&(W=new THREE.Vector2).fromArray(h.modelOperationVerticalRotationRange),x.commentManager=new Tt(qn(qn(x))),x.ndsModel=null,x.ndsModelBvhLoaded=!1,x.ndsModelPMILoaded=!1,x.ndsModelObjectTreeLoaded=!1,x.nBufferChunks=0,x.nBufferChunksLoaded=0,x.windowResize=!0;var Y=new Le(Me);Y.material.blending=THREE.NoBlending,Y.material.depthWrite=!1,Y.material.depthTest=!1,x.forceClear=!0;var X=!Ue.inBIMContext;x.composer=new Pe(w.renderer,void 0,w.renderer.colorTarget);z=new Ce(w.scene,w.camera,w);x.composer.addPass(z);z=new Oe(Ae);z.uniforms.resolution.value.x=w.renderer.getSize().width*w.renderer.getPixelRatio(),z.uniforms.resolution.value.y=w.renderer.getSize().height*w.renderer.getPixelRatio(),x.composer.addPass(z);z=new Oe(Te);z.uniforms.texSize.value.x=w.renderer.getSize().width*w.renderer.getPixelRatio(),z.uniforms.texSize.value.y=w.renderer.getSize().height*w.renderer.getPixelRatio(),z.uniforms.direction.value=new THREE.Vector2(1,0),z.uniforms.kernelRadius.value=.1,x.composer.addPass(z);z=new Oe(Te);z.uniforms.texSize.value.x=w.renderer.getSize().width*w.renderer.getPixelRatio(),z.uniforms.texSize.value.y=w.renderer.getSize().height*w.renderer.getPixelRatio(),z.uniforms.direction.value=new THREE.Vector2(0,1),z.uniforms.kernelRadius.value=.1,x.composer.addPass(z);var Z,q,Q,J,K,z=new Oe(Re);function $(){var e;w.btnSelected?te(w.btnSelected.domElement.id):null!=w.prevCursor&&(null!=(e=w.renderer.domElement)&&(1==w.inWaitProcedure?e.oldCursor=w.prevCursor:e.style.cursor=w.prevCursor),null!=(e=w.canvas2D)&&(1==w.inWaitProcedure?e.oldCursor=w.prevCursor:e.style.cursor=w.prevCursor),null!=w.canvas2DLayer&&(1==w.inWaitProcedure?w.canvas2DLayer.oldCursor=w.prevCursor:w.canvas2DLayer.style.cursor=w.prevCursor))}function ee(){w.prevCursor=w.renderer.domElement.style.cursor}function te(e){var t="";switch(e="coordinate"==w.getCurrentMeasureType()&&"MeasureType"!=e?"coordinate":e){case"btnOrbit":case"OpOrbit":t="url('img/cursorOrbit.ico'), wait";break;case"btnPan":case"OpPan":t="url('img/cursorPan.ico'), wait";break;case"btnZoom":case"OpZoom":t="url('img/cursorZoom.ico'), wait";break;case"OpZoomWindow":t="url('img/zoomWindow.ico') 6 16, wait";break;case"coordinate":t="url('img/cursorCross.ico'), crosshair"}e=w.renderer.domElement;null!=e&&(1==w.inWaitProcedure?e.oldCursor=t:e.style.cursor=t);e=w.canvas2D;null!=e&&(1==w.inWaitProcedure?e.oldCursor=t:e.style.cursor=t),null!=w.canvas2DLayer&&(1==w.inWaitProcedure?w.canvas2DLayer.oldCursor=t:w.canvas2DLayer.style.cursor=t)}function ne(e,t){for(var n=0,i=t.length;n<i;++n)if(e==t[n].key)return 1}z.uniforms.resolution.value.x=w.renderer.getSize().width*w.renderer.getPixelRatio(),z.uniforms.resolution.value.y=w.renderer.getSize().height*w.renderer.getPixelRatio(),z.uniforms.selectColor.value=Ue.selectedLineMaterial.color,z.renderToColor=!0,x.composer.addPass(z),x.getEnableSmoothTranslation=function(){return j},x.getLoadingManager=function(){return u},x.getCommentsManager=function(){return w.commentManager},Object.defineProperties(qn(qn(x)),{bGeoBufferChunkLoaded:{get:function(){return g},set:function(e){g=e}},loadingManager:{get:function(){return u}}}),x.drawCenterCross=function(){var e,t,n,i,r;w.canvas2D&&(e=w.canvas2D.getContext("2d"),t=Math.round(w.canvas2D.width/2),n=Math.round(w.canvas2D.height/2),e.clearRect(t-15,n-15,30,30),i=e.strokeStyle,r=e.lineWidth,e.strokeStyle="#FFFFFF",e.lineWidth=1,e.beginPath(),e.moveTo(t-15,n),e.lineTo(t+15,n),e.moveTo(t,n-15),e.lineTo(t,n+15),e.stroke(),e.strokeStyle=i,e.lineWidth=r)},x.clearCenterCross=function(){var e,t,n;w.canvas2D&&(e=w.canvas2D.getContext("2d"),t=Math.round(w.canvas2D.width/2),n=Math.round(w.canvas2D.height/2),e.clearRect(t-15,n-15,30,30))},x.addToScene=function(e){w.scene.add(e),e instanceof THREE.Light||S&&w.selectionManager.addToTargetList(e)},x.displayViewBox=function(e){this.viewBoxDiv?this.viewBoxDiv.style.visibility=e?"visible":"hidden":this.initViewBox()},x.initViewBox=function(){this.is2DModel||(this.viewBoxDiv=document.createElement("div"),this.viewBoxDiv.className="viewbox",this.container.appendChild(this.viewBoxDiv),this.viewBox=new Ee(this,w.viewBoxSize),this.cameraControl.setViewBox(this.viewBox))},x.render=function(e){var t=!!e&&!!e.forceRenderAll;w.broadcastManager&&(e&&null!=e.needBroadcast&&null!=e.needBroadcast?w.broadcastManager.needBroadcast=e.needBroadcast:w.broadcastManager.needBroadcast=!0),w.ndsModel?(w.forceClear=!0,NDS.StartRenderTime=Date.now(),w.ndsModel.forceRenderAll=!!w.enableProgressiveRender&&t):w.renderNew()},x.renderNew=(Q=q=Z=0,J=[],K=[],function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:performance.now(),t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(!w.loaderror)if(0===e?Z=performance.now():e-Z<1?Q=q=30:q=((Q=e?1e3/(e-Z):q)+q)/2,J.length>K.length&&K.push(q),65<=q)q=60;else{1<=e-Z&&(Z=e);var n=0===e?100:q/30*60;if((Q<20||!x.enableProgressiveRender)&&(J.length=0,K.length=0),10<=J.length){for(var i=0,r=J.length;i<r;++i){var o=K[i]*J[i]/20;20<K[i]&&o>w.renderer.maxPrimitivesPerFrame&&(w.renderer.maxPrimitivesPerFrame=o)}J.length=0,K.length=0}if(t){if(x.enableProgressiveRender||(n=1e4),null!=I)for(var a=0,s=I.length;a<s;a++)I[a].run();Gn.update({timeStamp:e,fps:q}),w.additionalObjectsScene&&w.updateAdditionalObjectsScene(),w.envMapCamera&&V&&w.envMapCamera.rotation.copy(w.camera.rotation);var l=w.selectionManager.getSelectedMeshes();R&&(w.scene.remove(w.lightControls._scene),w.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(ne(e,l)||(e.materialWhiteMold=e.material,e.material=R))}),w.scene.add(w.lightControls._scene));t=!1;w.forceClear&&(t=!0),w.ndsModel||(t=!0),N=!(H=!1),w.renderer.clear();e=w.renderer.clippingPlanes;if(w.renderer.clippingPlanes=[],H)w.ndsModel?(w.forceClear&&(w.positionMaterial.uniforms.cameraNear.value=w.camera.near,w.positionMaterial.uniforms.cameraFar.value=w.camera.far,w.positionMaterialCopy||(w.positionMaterialCopy=(new w.positionMaterial.constructor).copy(w.positionMaterial)),w.positionMaterialCopy.uniforms.cameraNear.value=w.positionMaterial.uniforms.cameraNear.value,w.positionMaterialCopy.uniforms.cameraFar.value=w.positionMaterial.uniforms.cameraFar.value,w.ndsModel.setDirty(),w.ndsModel.setDrawMode(w.ndsModel.SHADED),w.scene.children.push(w.ndsModel),w.ndsModel.setOverrideMaterial(w.positionMaterial,w.positionMaterialCopy,!1),w.renderer.render(w.scene,w.camera,w.positionTarget,!0),w.ndsModel.setOverrideMaterial(null,null,!1),w.normalMaterialCopy||(w.normalMaterialCopy=(new w.normalMaterial.constructor).copy(w.normalMaterial)),w.ndsModel.setDirty(),w.ndsModel.setDrawMode(w.ndsModel.SHADED),w.scene.children.push(w.ndsModel),w.ndsModel.setOverrideMaterial(w.normalMaterial,w.normalMaterialCopy,!1),w.renderer.render(w.scene,w.camera,w.normalTarget,!0),w.ndsModel.setOverrideMaterial(null,null,!1),w.renderer.clearTarget(w.normalRenderTarget,!0,!0,!1),w.ndsModel.setDirty(),w.forceClear=!1),c=w.ndsModel.SHADED_WITH_EDGES,4===A?c=w.ndsModel.SHADED_WITH_EDGES:5===A?c=w.ndsModel.SHADED:2===A?c=w.ndsModel.WIREFRAME:6===A?c=w.ndsModel.HIDDEN_LINE_REMOVE:7===A&&(c=w.ndsModel.HIDDEN_LINE_VISIBLE),c!==w.ndsModel.SHADED_WITH_EDGES||w.bLinesVisibility||(c=w.ndsModel.SHADED),w.ndsModel.setDrawMode(c),w.scene.children.push(w.ndsModel),w.renderer.render(w.scene,w.camera,w.normalRenderTarget,!1,!1,!1,n),d=w.renderer.info.render.faces+w.renderer.info.render.lines,24<q&&0<n&&d>=w.renderer.maxPrimitivesPerFrame&&J.push(d)):(w.showLineObjects(w.scene,!1),w.positionMaterial.uniforms.cameraNear.value=w.camera.near,w.positionMaterial.uniforms.cameraFar.value=w.camera.far,w.scene.overrideMaterial=w.positionMaterial,w.renderer.render(w.scene,w.camera,w.positionTarget,!0),w.scene.overrideMaterial=w.normalMaterial,w.renderer.render(w.scene,w.camera,w.normalTarget,!0),w.scene.overrideMaterial=null,w.showLineObjects(w.scene,!0),w.renderer.render(w.scene,w.camera,w.normalRenderTarget,!0)),w.ssaoComposer.render();else if(w.ndsModel){if(w.forceClear&&(w.renderer.clearTarget(w.renderer.colorTarget,!0,!0,!1),w.ndsModel.setDirty()),void 0!==w.backGroundScene&&!S&&w.forceClear&&w.renderer.render(w.backGroundScene,w.backGroundCamera,w.renderer.colorTarget),w.envMapScene&&!C&&w.forceClear&&(B?(w.renderer.render(w.envMapScene,w.envMapCamera,w.envMapBlurTargetH),w.envMapBlurPassV.render(w.renderer,w.envMapBlurTargetV,w.envMapBlurTargetH),w.envMapBlurPassH.render(w.renderer,w.renderer.colorTarget,w.envMapBlurTargetV)):w.renderer.render(w.envMapScene,w.envMapCamera,w.renderer.colorTarget)),_&&w.groundShadow.needClear&&(w.groundShadow.clear(),w.groundShadow.needClear=!1),_&&!w.groundShadow.isValid()&&V&&(w.groundShadow.renderIntoShadow(w.scene),w.groundShadow.postprocess()),V||S){w.clipPlaneManager.renderClipPlane(),w.renderer.clippingPlanes=e;var d=0,c=w.ndsModel.SHADED_WITH_EDGES;if(4===A?c=w.ndsModel.SHADED_WITH_EDGES:5===A?c=w.ndsModel.SHADED:2===A?c=w.ndsModel.WIREFRAME:6===A?c=w.ndsModel.HIDDEN_LINE_REMOVE:7===A&&(c=w.ndsModel.HIDDEN_LINE_VISIBLE),c!==w.ndsModel.SHADED_WITH_EDGES||w.bLinesVisibility||(c=w.ndsModel.SHADED),w.ndsModel.setDrawMode(c),w.scene.children.push(w.ndsModel),w.renderer.render(w.scene,w.camera,w.renderer.colorTarget,!1,!1,!1,n),d+=w.renderer.info.render.faces+w.renderer.info.render.lines,Ue.enableOutlineEffect&&w.forceClear&&x.outlinePass.render(w.renderer,null,w.renderer.colorTarget),!X||c!=w.ndsModel.WIREFRAME&&c!=w.ndsModel.HIDDEN_LINE_REMOVE&&c!=w.ndsModel.HIDDEN_LINE_VISIBLE||w.is2DModel||(w.composer.colorTarget.uuid!=w.renderer.colorTarget.uuid&&w.composer.setColorTarget(w.renderer.colorTarget),w.composer.render()),w.renderer.clippingPlanes=[],w.renderer.colorTarget&&w.forceClear&&_&&w.groundShadow.isValid()&&w.groundShadow.renderShadow(w.camera,w.renderer.colorTarget),w.forceClear&&(w.clipPlaneManager.renderClipScene(w.renderer.colorTarget),w.clipBoxManager.renderClipBox(w.renderer.colorTarget),w.selectionManager.renderSelectionScene(w.renderer.colorTarget),w.additionalObjectsScene&&(w.renderer.render(w.additionalObjectsScene,w.camera,w.renderer.colorTarget),d+=w.renderer.info.render.faces+w.renderer.info.render.lines)),w.ndsModel.referenceEntityDirty&&0<w.ndsModel.wholeRefEntityNodes.length&&(w.scene.children.push(w.ndsModel),w.renderer.render(w.scene,w.camera,w.renderer.colorTarget,!1,!1,!0)),24<q&&0<n&&d>=w.renderer.maxPrimitivesPerFrame&&J.push(d),w.renderer.colorTarget&&(w.forceClear||V)&&Y.render(w.renderer,null,w.renderer.colorTarget.texture),w.forceClear=!1,"OpMeasure"==w.controls.getOperator().type)w.controls.getOperator().renderMeasureScene();else if((m=w.watermark)&&w.excalibur)if(ye.isMobileDevice()){m=m.substr(0,20);c=Math.cos(45*Math.PI/180),n=Math.sin(45*Math.PI/180),d=(p=x.canvas2D.width/2)*c-(f=x.canvas2D.height/2)*n,c=p*n+f*c,v=m.length+1;(g=x.canvas2D.getContext("2d")).rotate(-45*Math.PI/180),g.clearRect(d-24*v,c-48,48*v,60),g.font="bold 48px Arial",g.textAlign="center",g.fillStyle="#137FE2",g.globalAlpha=w.is2DModel?.2:.05,g.fillText(m,d,c),g.rotate(45*Math.PI/180),g.globalAlpha=1}else{var h=0,u=0,f=0,p=0,h=-x.canvas2D.width;for(p=0;h<x.canvas2D.width;h+=150,p++){for(f=u=0;u<2*x.canvas2D.height;u+=100,f++){var m,g,v=(m=m.substr(0,20)).length+1;(g=x.canvas2D.getContext("2d")).rotate(-25*Math.PI/180),g.clearRect(h-18*v/2,u-18,18*v,27),g.font="bold 18px Arial",g.textAlign="center",g.fillStyle="#000000",g.globalAlpha=.1,g.fillText(m,h,u),g.rotate(25*Math.PI/180),g.globalAlpha=1}h+=18*v}}for(var y,E=w.ndsModel.getMeshSets(),b=0,M=0,s=E.length;M<s;++M)E[M].dirty&&E[M].visible||(b+=1);P&&(y=1,0<E.length&&(y=b/E.length),2!==A&&0!==E.length||(y=1),w.dispatchEvent({type:"updateProgress",userData:{precent:y}})),"OpBall"==w.controls.getOperator().type&&w.controls.getOperator().renderModel()}}else T?_?(void 0===w.backGroundScene||S||w.renderer.render(w.backGroundScene,w.backGroundCamera),w.envMapScene&&!C&&(B?(w.renderer.render(w.envMapScene,w.envMapCamera,w.envMapBlurTargetH),w.envMapBlurPassV.render(w.renderer,w.envMapBlurTargetV,w.envMapBlurTargetH),w.envMapBlurPassH.render(w.renderer,void 0,w.envMapBlurTargetV)):w.renderer.render(w.envMapScene,w.envMapCamera)),w.groundShadow.needClear&&(w.groundShadow.clear(),w.groundShadow.needClear=!1),!w.groundShadow.isValid()&&V&&(w.groundShadow.renderIntoShadow(w.scene),w.groundShadow.postprocess()),(V||S)&&(w.clipPlaneManager.renderClipPlane(),w.renderer.clippingPlanes=e,7==A?w.renderHiddenLinesVisible():w.renderer.render(w.scene,w.camera),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera),w.selectionManager.renderSelectionScene(),Ue.enableOutlineEffect&&x.outlinePass.render(w.renderer),w.clipPlaneManager.renderClipScene(),w.clipBoxManager.renderClipBox(),w.groundShadow.isValid()&&w.groundShadow.renderShadow(w.camera),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(),"OpBall"==w.controls.getOperator().type&&w.controls.getOperator().renderModel())):(void 0===w.backGroundScene||S||w.renderer.render(w.backGroundScene,w.backGroundCamera),w.envMapScene&&!C&&(B?(w.renderer.render(w.envMapScene,w.envMapCamera,w.envMapBlurTargetH),w.envMapBlurPassV.render(w.renderer,w.envMapBlurTargetV,w.envMapBlurTargetH),w.envMapBlurPassH.render(w.renderer,void 0,w.envMapBlurTargetV)):w.renderer.render(w.envMapScene,w.envMapCamera)),(V||S)&&(w.clipPlaneManager.renderClipPlane(),w.renderer.clippingPlanes=e,7==A?w.renderHiddenLinesVisible():w.renderer.render(w.scene,w.camera),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera),w.selectionManager.renderSelectionScene(),Ue.enableOutlineEffect&&x.outlinePass.render(w.renderer),w.clipPlaneManager.renderClipScene(),w.clipBoxManager.renderClipBox(),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(),"OpBall"==w.controls.getOperator().type&&w.controls.getOperator().renderModel())):(_?(w.groundShadow.needClear&&(w.groundShadow.clear(),w.groundShadow.needClear=!1),!w.groundShadow.isValid()&&V&&(w.groundShadow.renderIntoShadow(w.scene),w.groundShadow.postprocess()),void 0!==w.envMapScene&&!C||void 0!==w.backGroundScene?(void 0===w.backGroundScene||S||w.renderer.render(w.backGroundScene,w.backGroundCamera,w.effectRenderTarget,!0),w.envMapScene&&!C&&(B?(w.renderer.render(w.envMapScene,w.envMapCamera,w.envMapBlurTargetH),w.envMapBlurPassV.render(w.renderer,w.envMapBlurTargetV,w.envMapBlurTargetH),w.envMapBlurPassH.clear=!0,w.envMapBlurPassH.render(w.renderer,w.effectRenderTarget,w.envMapBlurTargetV)):w.renderer.render(w.envMapScene,w.envMapCamera,w.effectRenderTarget,!0)),(V||S)&&(w.clipPlaneManager.renderClipPlane(w.effectRenderTarget,!1),w.renderer.clippingPlanes=e,w.renderer.render(w.scene,w.camera,w.effectRenderTarget,!1),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera,w.effectRenderTarget,!1),w.selectionManager.renderSelectionScene(w.effectRenderTarget,!1),w.clipPlaneManager.renderClipScene(w.effectRenderTarget,!1),w.clipBoxManager.renderClipBox(x.effectRenderTarget,!1),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(w.effectRenderTarget,!1))):(V||S)&&(w.clipPlaneManager.renderClipPlane(w.effectRenderTarget,!0),w.renderer.clippingPlanes=e,w.renderer.render(w.scene,w.camera,w.effectRenderTarget,w.clipPlaneManager.hasClipCapScene()),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera,w.effectRenderTarget,!1),w.selectionManager.renderSelectionScene(w.effectRenderTarget,!1),w.clipPlaneManager.renderClipScene(w.effectRenderTarget,!1),w.clipBoxManager.renderClipBox(w.effectRenderTarget,!1),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(w.effectRenderTarget,!1)),w.groundShadow.isValid()&&V&&w.groundShadow.renderShadow(w.camera,w.effectRenderTarget)):void 0!==w.envMapScene&&!C||void 0!==w.backGroundScene?(void 0===w.backGroundScene||S||w.renderer.render(w.backGroundScene,w.backGroundCamera,w.effectRenderTarget,!0),w.envMapScene&&!C&&(B?(w.renderer.render(w.envMapScene,w.envMapCamera,w.envMapBlurTargetH),w.envMapBlurPassV.render(w.renderer,w.envMapBlurTargetV,w.envMapBlurTargetH),w.envMapBlurPassH.clear=!0,w.envMapBlurPassH.render(w.renderer,w.effectRenderTarget,w.envMapBlurTargetV)):w.renderer.render(w.envMapScene,w.envMapCamera,w.effectRenderTarget,!0)),(V||S)&&(w.clipPlaneManager.renderClipPlane(w.effectRenderTarget,!1),w.renderer.clippingPlanes=e,w.renderer.render(w.scene,w.camera,w.effectRenderTarget,!1),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera,w.effectRenderTarget,!1),w.selectionManager.renderSelectionScene(w.effectRenderTarget,!1),w.clipPlaneManager.renderClipScene(w.effectRenderTarget,!1),w.clipBoxManager.renderClipBox(w.effectRenderTarget,!1),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(w.effectRenderTarget,!1))):(V||S)&&(w.clipPlaneManager.renderClipPlane(w.effectRenderTarget,!0),w.renderer.clippingPlanes=e,w.renderer.render(w.scene,w.camera,w.effectRenderTarget,w.clipPlaneManager.hasClipCapScene()),w.renderer.clippingPlanes=[],w.additionalObjectsScene&&w.renderer.render(w.additionalObjectsScene,w.camera,w.effectRenderTarget,!1),w.selectionManager.renderSelectionScene(w.effectRenderTarget,!1),w.clipPlaneManager.renderClipScene(w.effectRenderTarget,!1),w.clipBoxManager.renderClipBox(w.effectRenderTarget,!1),"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().renderMeasureScene(w.effectRenderTarget,!1)),w.effectFXAA.render(w.renderer,void 0,w.effectRenderTarget));w.annotationsManager&&(y=!1,w.animationsManager&&w.annotationsManager.hasAnnotationsForAnimation(w.animationsManager.getCurrentAnimationUuid())&&(y=!0,w.annotationsManager.updateAnnotationsVisiblilityForAnimation(w.animationsManager.getCurrentAnimationUuid(),w.animationsManager.getCurrentAnimationTime())),(null==w.animationsManager||w.animationsManager&&w.animationsManager.isAnimationsExited()||y)&&t&&w.annotationsManager.renderAnnotations()),t&&"FirstPerson"==G&&"OpOrbit"==w.controls.getOperator().type&&w.drawCenterCross(),R&&(w.scene.remove(w.lightControls._scene),w.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(ne(e,l)||(e.material=e.materialWhiteMold,e.materialWhiteMold=void 0))}),w.scene.add(w.lightControls._scene)),w.renderer.clippingPlanes=e,Ue.enableBroadcast&&Ue.broadcastMajor&&t&&w.broadcastManager.needBroadcast&&w.ndsModel&&(30<(t=Date.now())-O&&(O=t,w.dispatchEvent({type:"broadcastEvent"}))),null!=w.commentManager&&w.commentManager.renderComments()}}}),x.prepareModelForRendering=function(e,t){this.dispatchEvent({type:"updateProgress",userData:{precent:0}});var n=this.ndsModel.prepareForRendering(this.renderer.supportInstancedArrays(),this,t);if(n&&(e?(e.boundingBox.min.sub(n),e.boundingBox.max.sub(n)):(this.modelRootObject.boundingBox.min.sub(n),this.modelRootObject.boundingBox.max.sub(n))),this.isiPhone?1==this.deviceMemory?this.ndsModel.geomManager.useSmallMemory():2==this.deviceMemory?this.ndsModel.geomManager.useMediumMemory():this.ndsModel.geomManager.useLargeMemory():ye.isMobileDevice()||this.ndsModel.geomManager.usePCMemory(),w.is2DModel&&(w.renderMode="shadedWithEdges"),w.ndsModel&&(!w.parameters.isBundledType||t)){for(var i=w.ndsModel.getMeshSets(),r=0,o=0;o<i.length;o++)r+=i[o].getNumMeshes();0==r&&(w.renderMode="shadedWithEdges")}w.setRenderMode(w.renderMode,!1)},x.onResize=function(e){w.windowResize&&setTimeout(function(){w.dispatchEvent({type:"windowResize"})},300)},x.enableWindowResize=function(e){w.windowResize=e},x.onWindowResize=function(e,t,n){w.viewBox&&w.viewBox.refreshCube();var i=w.container.getBoundingClientRect(),r=i.width,i=i.height;null!=w.container.clientWidth&&null!=w.container.clientHeight&&(10<Math.abs(r-w.container.clientWidth)&&(r=w.container.clientWidth),10<Math.abs(i-w.container.clientHeight)&&(i=w.container.clientHeight)),w.renderer.setSize(r=null!=t?t:r,i=null!=n?n:i),s&&w.tlbOperator.onResize(r,i);var o,n=w.renderer.getPixelRatio();r*=n,i*=n,w.canvas2D&&(w.canvas2D.width=r,w.canvas2D.height=i,w.canvas2D.style.width=r/n+"px",w.canvas2D.style.height=i/n+"px"),w.canvas2DLayer&&(w.canvas2DLayer.width=r,w.canvas2DLayer.height=i,w.canvas2DLayer.style.width=r/n+"px",w.canvas2DLayer.style.height=i/n+"px"),w.annotationsManager&&w.annotationsManager.setSize(r,i),w.cameraControl.setCameraSize(r,i),w.envMapCamera&&(w.envMapCamera.aspect=r/i,w.envMapCamera.updateProjectionMatrix()),B&&w.envMapBlurTargetH&&(n=.5*r,o=.5*i,w.envMapBlurTargetH.dispose(),w.envMapBlurTargetH=new THREE.WebGLRenderTarget(n,o,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),w.envMapBlurTargetH.texture.generateMipmaps=!1,w.envMapBlurTargetV&&w.envMapBlurTargetV.dispose(),w.envMapBlurTargetV=new THREE.WebGLRenderTarget(n,o,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),w.envMapBlurTargetV.texture.generateMipmaps=!1,(1==b||2==b||3<b)&&(w.envMapBlurPassH&&(w.envMapBlurPassH.material.defines.RESOLUTION=(M/n).toFixed(4),w.envMapBlurPassH.material.needsUpdate=!0),w.envMapBlurPassV&&(w.envMapBlurPassV.material.defines.RESOLUTION=(M/o).toFixed(4),w.envMapBlurPassV.material.needsUpdate=!0))),w.backGroundMesh&&w.backGroundMesh.material&&w.updateBackGroudImageRatio(w.backGroundMesh.material),w.ssaoComposer&&(w.renderTarget&&w.renderTarget.dispose(),w.renderTarget=new THREE.WebGLRenderTarget(r,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),w.ssaoComposer.reset(w.renderTarget),w.fxaaPass.uniforms.resolution.value.set(1/r,1/i),w.positionTarget&&w.positionTarget.dispose(),w.positionTarget=new THREE.WebGLRenderTarget(r,i,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),w.ssaoPass.uniforms.tPosition.value=w.positionTarget,w.normalTarget&&w.normalTarget.dispose(),w.normalTarget=new THREE.WebGLRenderTarget(r,i,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),w.ssaoPass.uniforms.tNormal.value=w.normalTarget,o=Math.sqrt(r*r+i*i),w.ssaoPass.uniforms.fRadiusNear.value=Math.max(.01*o,2),w.ssaoPass.uniforms.fRadiusFar.value=Math.max(.01*o,2),w.normalRenderTarget&&w.normalRenderTarget.dispose(),w.normalRenderTarget=new THREE.WebGLRenderTarget(r,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),w.ssaoFilterPass.uniforms.tSSAOMap.value=w.renderTarget,w.ssaoFilterPass.uniforms.tDiffuseOrginal.value=w.normalRenderTarget,w.ssaoFilterPass.uniforms.vSize.value.set(r,i)),T||(w.effectRenderTarget&&w.effectRenderTarget.dispose(),w.effectRenderTarget=new THREE.WebGLRenderTarget(r,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),w.effectFXAA.uniforms.resolution.value.set(1/r,1/i)),this.outlinePass&&this.outlinePass.setSize(r,i),w.render(),w.ndsModel&&w.renderNew()},x.onMouseDown=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(D.set(e.clientX,e.clientY),Ue.enableSelect&&w.enableInternalRMB&&w.showViewMenu(!1),H&&(F=!(H=!1)),X&&4!==A&&5!==A&&(F=!(X=!1)),N=!1,w.toggleAutoRotation(!1))},x.onMouseUp=function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||(2!==e.button||(e=new THREE.Vector2(e.clientX,e.clientY)).equals(D)&&0<w.modelInfo.length&&"js"===w.modelInfo[0].type&&Ue.enableSelect&&w.enableInternalRMB&&w.showViewMenu(!0,e.x,e.y),H=!0,X=!Ue.inBIMContext,N&&F&&(w.render(),F=!1))},x.showModelBroserMenu=function(e,t,n){e?(w.menuView.getChildElement("itemIsolate").setDisplay(!0),w.menuView.getChildElement("itemHide").setDisplay(!0),w.menuView.getChildElement("itemShowAll").setDisplay(!0),w.menuView.getChildElement("itemProperty").setDisplay(!0),w.menuView.setPos(t,n),w.menuView.setVisibility(!0)):w.menuView.setVisibility(!1)},x.showprompt=function(e,t){this.promptshow=e,this.promptstring=t,!this.prompt&&this.promptshow&&(this.prompt=document.createElement("div"),this.prompt.className="pc-alert",this.container.appendChild(this.prompt)),this.prompt&&!this.promptshow&&(this.container.removeChild(this.prompt),this.prompt=null)},x.getSelectedBodyVolumeAndArea=function(){var e=w.selectionManager.getSelectedBodyVolumeAndArea();if(e){var t=e[0];return t.modelUnit=e[1],t}return null},x.showViewMenu=function(e,t,n){e?(0<(e=w.selectionManager.getSelectedObjects()).length?(w.menuView.getChildElement("itemIsolate").setDisplay(!0),w.menuView.getChildElement("itemHide").setDisplay(!0),w.menuView.getChildElement("itemShowAll").setDisplay(!0),1==e.length?w.menuView.getChildElement("itemProperty").setDisplay(!0):w.menuView.getChildElement("itemProperty").setDisplay(!1)):(w.menuView.getChildElement("itemIsolate").setDisplay(!1),w.menuView.getChildElement("itemHide").setDisplay(!1),w.menuView.getChildElement("itemShowAll").setDisplay(!0),w.menuView.getChildElement("itemProperty").setDisplay(!1)),w.menuView.setPos(t,n),w.menuView.setVisibility(!0)):w.menuView.setVisibility(!1)},x.showSvgMenu=function(e,t,n){e?(w.menuView.getChildElement("itemIsolate").setDisplay(!1),w.menuView.getChildElement("itemSelectObject").setDisplay(!1),w.menuView.setPos(t,n),w.menuView.setVisibility(!0)):w.menuView.setVisibility(!1)},x.onControlsEvent=function(e){if(!(w.controls instanceof ve)){var t=e.event;if("select"!=t.subType){var n=t.event;switch(n.type){case"mousedown":var i=n.button;switch(ee(),i){case 1:case 2:te("btnPan")}break;case"mouseup":$();break;case"mousewheel":if(0==n.buttons){clearTimeout(void 0),0==w.inWheel&&(w.inWheel=!0,ee()),te("btnZoom");setTimeout(function(){$(),w.inWheel=!1},200);break}}}else{var r=t.uuid,o=t.userData,e=t.linkID,t=t.linkInstanceID;w.dispatchEvent({type:"selectEvent",uuid:r,userData:o,linkID:e,linkInstanceID:t})}}},x.startWaitProcedure=function(){w.inWaitProcedure=!0,w.restoreToolbarCursor(),w.setToolbarCursor("wait")},x.onChangeCursor=function(e){te(e)},x.exitWaitProcedure=function(){w.inWaitProcedure=!1,w.backToolbarCursor()},x.restoreToolbarCursor=function(){if(w.tlbOperator){w.tlbOperator.oldCursor=w.tlbOperator.domElement.style.cursor;for(var e=0;e<w.tlbOperator.childElements.length;e++){var t=w.tlbOperator.childElements[e];t.value.oldCursor=t.value.domElement.style.cursor}}var n=w.renderer.domElement;null!=n&&(n.oldCursor=n.style.cursor);n=w.canvas2D;null!=n&&(n.oldCursor=n.style.cursor),null!=w.canvas2DLayer&&(w.canvas2DLayer.oldCursor=w.canvas2DLayer.style.cursor)},x.setToolbarCursor=function(e){if(w.tlbOperator){w.tlbOperator.setCursor(e);for(var t=0;t<w.tlbOperator.childElements.length;t++)w.tlbOperator.childElements[t].value.setCursor(e)}var n=w.renderer.domElement;null!=n&&(n.style.cursor=e);n=w.canvas2D;null!=n&&(n.style.cursor=e),null!=w.canvas2DLayer&&(w.canvas2DLayer.style.cursor=e)},x.backToolbarCursor=function(){if(w.tlbOperator){w.tlbOperator.setCursor(w.tlbOperator.oldCursor);for(var e=0;e<w.tlbOperator.childElements.length;e++){var t=w.tlbOperator.childElements[e];t.value.setCursor(t.value.oldCursor)}}var n=w.renderer.domElement;null!=n&&(n.style.cursor=n.oldCursor);n=w.canvas2D;null!=n&&(n.style.cursor=n.oldCursor),null!=w.canvas2DLayer&&(w.canvas2DLayer.style.cursor=w.canvas2DLayer.oldCursor)},x.onOpChanged=function(e){var t,n=null!=e?e.target:null;null!=n?(null!=(t=w.btnSelected)&&(t.setBorder(""),t.setBgColor("")),n.setBorder("1px solid rgba(150,150,150,0.8)"),n.setBgColor(Ue.toolbarButtonClickedBkgColor),te((w.btnSelected=n).domElement.id)):null!=e&&null!=e.id&&te(e.id),w.Optoolbar&&w.Optoolbar.onOpChanged(e)},x.onShowTooltip=function(e){var t=e.event.type,n=e.target.subElements.tooltip;switch(t){case"mouseenter":n.setVisibility(!0);break;case"mouseleave":n.setVisibility(!1)}},x.computeMeshesBoundingBox=function(e,t,n,i){for(var r=0,o=e.length;r<o;++r)w.computeBoundingBox(e[r].key,t,n,i)},x.computeBoundingBox=function(e,t,n,i){if(null!=e){var r,o,a;if(this.ndsModel)return e===this.scene?(o=this.modelRootObject.boundingBox.clone(),Ue.inBIMContext&&0<this.ndsModel.ModelUpMatrix4.length&&((r=new THREE.Matrix4).fromArray(this.ndsModel.ModelUpMatrix4),o.applyMatrix4(r)),this.is2DModel&&(o.max.z=o.min.z)):o=this.ndsModel.getBodyBoundingBox(e),void(o&&(t.copy(o.min),n.copy(o.max)));if(e instanceof THREE.Object3D)if(!(e instanceof THREE.Light||"lightctrls"==e.name))if(e.hasOwnProperty("geometry")&&(a=!1,(r=e.geometry)instanceof THREE.Geometry?a=null!=r.vertices&&0!=r.vertices.count:r instanceof THREE.BufferGeometry&&(a=null!=e.geometry.attributes.position),(a||r.boundingBox)&&(null==r.boundingBox&&r.computeBoundingBox(),isFinite(r.boundingBox.min.x)&&((o=new THREE.Vector3).copy(r.boundingBox.min),(a=new THREE.Vector3).copy(r.boundingBox.max),(a=new THREE.Box3(o,a)).applyMatrix4(e.matrixWorld),1==i.flag?(t.copy(a.min),n.copy(a.max),i.flag=!1):(t.x=Math.min(t.x,a.min.x),t.y=Math.min(t.y,a.min.y),t.z=Math.min(t.z,a.min.z),n.x=Math.max(n.x,a.max.x),n.y=Math.max(n.y,a.max.y),n.z=Math.max(n.z,a.max.z))))),null!=e.children)for(var s=0,l=e.children.length;s<l;++s)w.computeBoundingBox(e.children[s],t,n,i)}},x.switchRotateCenterBySelection=function(){var e=w.selectionManager.getSelectedObjects();if(0<e.length){for(var t=new THREE.Box3,n=0;n<e.length;++n){var i=e[n],i=w.ndsModel.getBodyBoundingBox(i);i&&(t.expandByPoint(i.max),t.expandByPoint(i.min))}var r=t.getCenter();w.cameraControl.setRotateCenter(r)}else{var o=w.controls.getBoundingBox().getCenter();w.cameraControl.setRotateCenter(o)}o=w.controls.getOperator();o&&o.updateRotateCenterHelper()},x.zoomExtents=function(e,t,n){this.cameraControl.zoomExtents(e,t,n)},x.zoomToObject=function(e,t){this.cameraControl.zoomToObject(e,t)},x.getScreenCapture=function(e,t,n){return this.getScreenCapture2(e,!1,!1,t,n),"111"},x.getScreenCapture2=function(a,s,e,l,d){function c(e,t,n,i){t&&t(e),n&&w.dispatchEvent({type:"snapEvent",cameraInfo:w.getCameraInfo(),imgData:e}),i&&(i="<div align='center'><img src='"+e+"'></img></div>",(e=window.open()).document.open(),e.document.write(i),e.document.close())}var h,u=e&&w.watermark&&w.excalibur;w.lightControls.getVisible()&&(h=!0),null!=d&&d||h&&w.lightControls.setVisible(!1);var f=!1,p=!1,m=!1,g=!1;function v(e){var t,n,i,r,o=e.userData.precent,e=w.ndsModel.getLineSegmentsSet();o<.99||4===A&&e.dirty||(t=document.createElement("canvas"),n=t.getContext("2d"),e=w.renderer.domElement.toDataURL(),i=w.canvas2D.toDataURL(),(r=new Image).onload=function(){var e;t.width=r.width,t.height=r.height,n.globalAlpha=1,n.drawImage(r,0,0),u?((e=new Image).onload=function(){n.drawImage(e,0,0),c(t.toDataURL(),a,s,l)},e.src=i):c(t.toDataURL(),a,s,l)},r.src=e,w.removeEventListener("updateProgress",v),w.isSectionViewEnabled()&&(f&&w.clipPlaneManager.hideShowClipPlane(!0),p&&w.clipPlaneManager.onOpenClipControl()),m&&w.isSectionBoxViewEnabled()&&w.clipBoxManager.displaySectionBox(!0),g&&w.ndsModel.explodeObject&&w.explodeAxis&&this.setExplodeAxisVisible(!0,w.explodeAxis),null!=d&&d||h&&w.lightControls.setVisible(!0),w.render())}this.isSectionViewEnabled()&&(this.clipPlaneManager.getClipPlaneVisible()&&(this.clipPlaneManager.hideShowClipPlane(!1),f=!0),this.clipPlaneManager.getClipControlVisible()&&(this.clipPlaneManager.onCloseClipControl(),p=!0)),this.isSectionBoxViewEnabled()&&this.clipBoxManager.getSectionBoxVisible()&&(this.clipBoxManager.displaySectionBox(!1),m=!0),this.ndsModel.explodeObject&&this.ndsModel.explodeObject.visible&&this.explodeAxis&&this.ndsModel.explodeObject.getAxisVisible(this.explodeAxis)&&(this.setExplodeAxisVisible(!1),g=!0),w.renderNew(),w.addEventListener("updateProgress",v,!1)},x.getImagePortion=function(e,t,n,i,r,o){var a=document.createElement("canvas"),s=a.getContext("2d");a.width=t,a.height=n;var l=document.createElement("canvas"),d=l.getContext("2d");return l.width=e.width,l.height=e.height,d.drawImage(e,0,0),s.drawImage(l,i,r,t*o,n*o,0,0,t,n),a.toDataURL()},x.getScreenCapturethumbnail=function(i){var e=this.modelRootObject.boundingBox,t=[];t[0]=e.max.x,t[1]=e.max.y,t[2]=e.max.z;var n=this.modelCoordToClientCoord(t);(t=[])[0]=e.min.x,t[1]=e.max.y,t[2]=e.min.z;var r=this.modelCoordToClientCoord(t);(t=[])[0]=e.min.x,t[1]=e.max.y,t[2]=e.max.z;var o=this.modelCoordToClientCoord(t);(t=[])[0]=e.max.x,t[1]=e.max.y,t[2]=e.min.z;var a=this.modelCoordToClientCoord(t);(t=[])[0]=e.min.x,t[1]=e.min.y,t[2]=e.min.z;var s=this.modelCoordToClientCoord(t);(t=[])[0]=e.min.x,t[1]=e.min.y,t[2]=e.max.z;var l=this.modelCoordToClientCoord(t);(t=[])[0]=e.max.x,t[1]=e.min.y,t[2]=e.min.z;var d=this.modelCoordToClientCoord(t);(t=[])[0]=e.max.x,t[1]=e.min.y,t[2]=e.max.z;var c=this.modelCoordToClientCoord(t),h=Math.max(n[0],r[0],o[0],a[0],s[0],l[0],d[0],c[0]),e=Math.min(n[0],r[0],o[0],a[0],s[0],l[0],d[0],c[0]),t=Math.max(n[1],r[1],o[1],a[1],s[1],l[1],d[1],c[1]),d=Math.min(n[1],r[1],o[1],a[1],s[1],l[1],d[1],c[1]);h*=this.renderer.getPixelRatio(),e*=this.renderer.getPixelRatio(),t*=this.renderer.getPixelRatio(),d*=this.renderer.getPixelRatio();var c=Math.max(h-e,t-d),u=c/360,f=(h+e)/2-c/2,p=(t+d)/2-c/2;this.getScreenCapture(function(e){var t=new Image;t.src=e;var n=w;t.onload=function(){var e=n.getImagePortion(t,400,400,f,p,u);i&&i(e)}},null,null)},x.getScreenCaptureByParams=function(e,t,n,i,r){var o,a=w.container.getBoundingClientRect(),s=a.width,l=a.height;w.lightControls.getVisible()&&(o=!0),null!=r&&r||o&&w.lightControls.setVisible(!1),s!=e||l!=t?w.onWindowResize(null,e,t):w.render();a=w.renderer.domElement.toDataURL();return s==e&&l==t||w.onWindowResize(null,s,l),n&&n(a),i&&window.open(a),null!=r&&r||o&&w.lightControls.setVisible(!0),a},x.getCameraInfo=function(){return this.cameraControl.getCameraInfo()},x.resetSvgViewBox=function(){w.svgViewer.resetSvgViewBox()},x.resetCamera=function(e){S?(w.cameraControl.set2DViewerInfo(w.viewer2DInfo),w.render()):(e.type=w.defaultStandardView,w.look(e)),Ue.autoSwitchFirstPersonView&&"FirstPerson"==G&&(G=this.originalModelOperationMode)},x.look=function(e){this.cameraControl.look(e)},x.getSvgScreenCapture=function(n){var i=w.svgViewer.svgCanvas,e=w.svgViewer.svgObj.style.width,t=w.svgViewer.svgObj.style.height;i.domElement.width=e,i.domElement.height=t;var r=w.svgViewer.getSvgElement();r.getAttribute("width")&&r.setAttribute("width",e),r.getAttribute("height")&&r.setAttribute("height",t);t=r.outerHTML;void 0===t&&(t=(new XMLSerializer).serializeToString(r));var o=window.URL||window.webkitURL||window,a=new Image;a.crossOrigin="Anonymous";var t=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),s=o.createObjectURL(t);a.onload=function(){var e=i.domElement.getContext("2d");e.drawImage(a,0,0),o.revokeObjectURL(s);var t=i.domElement.toDataURL();n&&n(t),window.open(t),e.clearRect(0,0,i.domElement.width,i.domElement.height)},a.src=s,0},x.getSvgViewportInfo=function(){return{type:"SvgCamera",width:w.svgViewer.svgObj.style.width,height:w.svgViewer.svgObj.style.height,viewBox:w.svgViewer.getSvgElement().getAttribute("viewBox")}},x.showWaiterCoverStater=function(e,t,n){w.showWaiter(e=null==e||e),w.showCoverer(t=null!=t?t:e),w.showStater(n=null!=n?n:e)},x.showWaiter=function(e){w.bHasLoadingWaiter&&(e?(w.waiter||new en(w,h.loadingWaiterColor),w.waiter.setVisibility(e)):w.waiter&&(w.container.removeChild(w.waiter.domElement),w.waiter=null))},x.showCoverer=function(e){w.bHasLoadingCoverer&&(e?(w.coverer||new At(w,h.loadingCovererColor),w.coverer.setVisibility(e)):w.coverer&&(w.container.removeChild(w.coverer.domElement),w.coverer=null))},x.showStater=function(e){w.bHasLoadingStater&&w.stater.show(e)},x.addButton=function(e,t){this.Optoolbar&&this.Optoolbar.addButton(e,t)},x.setPmiVisible=function(e){null!=e&&w.pmiVisible!=e&&null!=w.pmiObject&&(w.pmiVisible=e,w.isPartPmi()||w.isAssemblyPmi()?(w.setAssemblyPMIVisible(e),w.setPartPMIVisible(e)):(e?w.scene.getObjectByName("pmiobject")||w.scene.add(w.pmiObject):w.scene.getObjectByName("pmiobject")&&w.scene.remove(w.pmiObject),w.render()))},x.isPmiVisible=function(){return w.pmiVisible},x.isAssemblyPmi=function(){return w.hasAssemblyPMI},x.isPartPmi=function(){return w.haspartPMI},x.setAssemblyPMIVisible=function(t){if(null!=t&&w.isAssemblyPmi()){w.scene.getObjectByName("pmiobject")||(w.scene.add(w.pmiObject),w.setPartPMIVisible(w.PartPmiVisible)),this.AssemblyPMIState={visible:t},w.AssemblyPMIVisible=t,w.AssemblyPMIVisible==w.PartPmiVisible&&(w.pmiVisible=w.AssemblyPMIVisible);var e=w.ndsModel.rootBodyNode;if(e.pmiuuid&&!w.is2DModel&&w.pmiObject)for(var n=0;n<e.pmiuuid.length;++n){var i=e.pmiuuid[n],i=w.pmiObject.getObjectByName(i);i&&(i.visible=t,i.traverse(function(e){e.visible=t}))}w.render()}},x.setPartPMIVisible=function(t){if(null!=t&&w.isPartPmi()){if(w.scene.getObjectByName("pmiobject")||(w.scene.add(w.pmiObject),w.setAssemblyPMIVisible(w.AssemblyPMIVisible)),this.PartPMIState={visible:t},w.PartPmiVisible=t,w.AssemblyPMIVisible==w.PartPmiVisible&&(w.pmiVisible=w.AssemblyPMIVisible),w.PartPMIuuid&&!w.is2DModel&&w.pmiObject)for(var e=0;e<w.PartPMIuuid.length;++e)for(var n=w.PartPMIuuid[e],i=0;i<n.length;++i){var r=n[i],r=w.pmiObject.getObjectByName(r);r&&(r.visible=t,r.traverse(function(e){e.visible=t}))}w.render()}},x.isAssemblyPMIVisible=function(){return w.AssemblyPMIVisible},x.isPartPmiVisible=function(){return w.PartPmiVisible},x.loadModel=function(e,t,n,i,r,o,a,s,l,d){if(null==e||null==t)return!1;switch(w.ndsModel&&0<w.ndsModel.meshManager.nMeshes?f=!1:(f=!0,w.ndsModel&&w.camera.setOrginalCameraInfo(void 0)),w.initViewer(!0),w.ConfigNum=void 0===l.configNum?0:l.configNum,k=l.explodeFactor||0,w.explodeMode=l.explodeMode||NDS.EXPLODEMODE.NORMAL,w.explodeLevel=l.explodeLevel||1,w.explodeObjects=l.explodeObjects||[],w.useUnvisibleList=void 0!==l.useUnvisibleList&&l.useUnvisibleList,w.useTransparentList=void 0!==l.useTransparentList&&l.useTransparentList,w.unvisibleList=l.unvisibleList,w.transparentList=l.transparentList,w.clipPlaneInfo=l.clipPlaneInfo,w.clipBoxInfo=l.clipBoxInfo,w.pmiVisible=void 0===l.pmiVisible?w.viewerPMIVisible:l.pmiVisible,w.AssemblyPMIVisible=w.pmiVisible,w.PartPmiVisible=w.pmiVisible,w.measuringScale=void 0===l.measuringScale?1:l.measuringScale,w.is2DModel||(w.measuringScale=1),w.trueMapList=s,w.bodyNodeUUidToMaterial=d,r){case"js":case"obj":case"obj_json":w.load3D(ye.encodeURL(t),ye.encodeURL(n),i,o,r,a);break;case"svg":w.svgViewer.loadSvg(ye.encodeURL(t),o)}w.modelInfo.push({id:e,type:r,url:t})};var ie,re=!(x.allowshow=function(e,s){var t=ye.encodeURL(e),e=new He;e.setCrossOrigin(this.crossOrigin),e.load(null,t,function(e){var t=null,n=1;if((t=JSON.parse(e)).fileID){for(var i=t.fileID.slice(4),r="",o=0;o<i.length/4;o++){var a=i.slice(4*o,4*(o+1));r+=String.fromCharCode(parseInt(a,16))}"Viewer版本过低，请升级"==r&&(n=2)}s(n)},function(){},function(){s(3)})});var oe=function(e){e&&e.render&&(void 0!==e.render.showLines&&w.setLinesVisibility(e.render.showLines,!1),void 0!==e.render.enableAutoRotation&&(U=e.render.enableAutoRotation),void 0!==e.render.enableGroundShadow&&(_=e.render.enableGroundShadow),void 0!==e.render.enableSmoothTranslation&&(j=e.render.enableSmoothTranslation),void 0!==e.render.enableEnvMap&&(y=e.render.enableEnvMap),void 0!==e.render.envMapReflectionRatio&&(_envMapReflectionRatio=e.render.envMapReflectionRatio),void 0!==e.render.envMapTextures?w.setEnvMapTextures(e.render.envMapTextures):void 0!==e.render.backGroundImage&&w.setBackGroundImage(e.render.backGroundImage),void 0!==e.render.envMapBlurLevel&&(L=e.render.envMapBlurLevel),void 0!==e.render.enableEnvMapBlur&&w.setEnvMapBlurEnabled(e.render.enableEnvMapBlur),void 0!==e.render.renderMode&&w.setRenderMode(e.render.renderMode,!1),void 0!==e.render.modelUpDirection&&w.initModelUpDirection(e.render.modelUpDirection))},ae=function(e,t){var n,i,r,o;t&&w.ndsModel&&(e&&w.ndsModel&&!w.ndsModel.rootBodyNode||(NDS.StartRenderTime=Date.now(),w.nBufferChunksLoaded+=1,w.ndsModel&&w.nBufferChunksLoaded%10==0&&w.render(),w.ndsModel&&5<w.nBufferChunksLoaded&&(n=w.nBufferChunksLoaded/w.nBufferChunks,w.dispatchEvent({type:"updateProgress",userData:{precent:n}})),t=V,V=g=!0,t||(u.onLoad(),f&&w.resetCamera({useOrginal:!0,smoothTranslation:!1})),w.groundShadow.needClear=!0,e&&(w.animationsManager&&w.animationsManager.hasAnimations()?Ue.enableBroadcast||0!=w.turnoffAnimation||w.startAnimationByUUID(h.animationUUID,!0):u.onSmoothTranslationDone=function(){u.onSmoothTranslationDone=void 0,w.ndsModel&&0!=w.ndsModel.geomManager.bufferChunksToLoad.length||w.toggleAutoRotation(!0)},f&&(n={useOrginal:!0},w.Euler&&((t=new THREE.Vector3(0,0,1)).applyEuler(w.Euler),n.from=t.toArray(),(t=new THREE.Vector3(0,1,0)).applyEuler(w.Euler),n.up=t.toArray()),w.resetCamera(n)),!w.backGroundScene&&w.is2DModel&&(i="0x"+w.renderer.getClearColor().getHexString(),w.clearColor=null,w.setBackGroundColor(i)),w.lightControls.resetPosition()),Ue.enableBroadcast&&w.render(),e&&(i=w.ndsModel?w.ndsModel.getGeometriesCount():le(w.scene),console.log("Mesh  count : "+i.Mesh.count+"   triangles : "+i.Mesh.triangles+"   points : "+i.Mesh.points),console.log("Line  count : "+i.Line.count+"   points : "+i.Line.points),Ue.enableBroadcast&&Ue.broadcastMajor&&(document.addEventListener("mousemove",w.broadcastManager.onBroadcastMouseMove,!1),document.addEventListener("touchmove",w.broadcastManager.onTouchMove,!1)),e=(performance||Date).now(),l=(e-p)/1e3,console.log("All load time : "+l.toFixed(2)),i.Mesh.count+i.Line.count!=0?(function(){a&&w.updateAllMateriaslInfo(a,A),w.hasViewBox&&null==w.viewBox&&w.initViewBox(),w.isExploded()&&(e=k,k=0,w.setExplodeMode(w.explodeMode,w.explodeLevel,!0),w.explodeModel(e)),w.clipPlaneInfo&&(w.isSectionViewEnabled()||w.onSectionView(!0,!1),w.clipPlaneManager.setClipPlaneInfor(w.clipPlaneInfo)),w.clipBoxInfo&&w.clipBoxInfo.clipBoxActive&&(w.isSectionViewEnabled()&&w.onSectionView(!1,!1),w.clipBoxManager.onBoxSectionView(w.clipBoxInfo.clipBoxActive,w.clipBoxInfo.clipbox));var e,t={useOrginal:!0,smoothTranslation:!0};if(w.Euler&&((e=new THREE.Vector3(0,0,1)).applyEuler(w.Euler),t.from=e.toArray(),(e=new THREE.Vector3(0,1,0)).applyEuler(w.Euler),t.up=e.toArray()),w.resetCamera(t),Ue.enableBroadcast=w.oldenableBroadcast,w.ndsModel.pureLineBody&&0<w.ndsModel.pureLineBody.length){for(var n=0;n<w.ndsModel.pureLineBody.length;n++)6==w.ndsModel.pureLineBody[n].leafBodyAttri.bodyBbox.length&&Number.isFinite(w.ndsModel.pureLineBody[n].leafBodyAttri.bodyBbox[0])||w.ndsModel.calculateLineBodyBoundingBox(w.ndsModel.pureLineBody[n]);w.ndsModel.pureLineBody=[]}}(),w.dispatchEvent({type:"updateProgress",userData:{precent:1}}),w.ndsModel&&!w.hasBrepFile()&&w.ndsModel.meshManager.mergeLineSegments(),w.hasBrepFile()||w.dispatchEvent({type:"BrepInfoEvent",faceArea:!1,bodyVolume:!1,totalVolume:!1,bodyArea:!1,totalArea:!1,boundingbox:!1,facePerimeter:!1}),P=!0,w.dispatchAsyncEvent({type:"geometryAllLoadedEvent",modelLoadedTime:m,wholeModelLoadedTime:l,modelInfo:i}),w.dispatchBrepEvent(),w.hasBodyRepeat()&&(r=document.createElement("div"),ye.isMobileDevice()&&(o=w.renderer.getSize().height/2-21+"px",r.style.top=o),r.className="app-alert",w.container.appendChild(r),r.style.color="#f76700",r.style.backgroundColor="#ffdcc3",o="en"==ye.getLanguage(),r.innerHTML=o?"Entity already exist please<br/>modify the model and try again":"存在重复实体<br/>请修改后重新上传",r.style.height="84px",r.style.display="block",ye.isMobileDevice()||(r.innerHTML=o?"Entity already exist please modify the model and try again":"提示:存在重复实体请修改后重新上传",r.style.height="42px"),setTimeout(function(){w.container.removeChild(r)},3e3))):se())))},se=function(e){w.showWaiterCoverStater(!1),w.loaderror=!0,w.dispatchAsyncEvent({type:"loadError",errorInfo:e||"objectloader error"})};function le(e){var t={Mesh:{count:0,triangles:0,points:0},Line:{count:0,points:0}};if(void 0===e)return t;if(e.hasOwnProperty("geometry")&&(e.geometry instanceof THREE.Geometry?(t.Mesh.count+=1,t.Mesh.points+=e.geometry.vertices.length,t.Mesh.triangles+=e.geometry.faces.length):e.geometry instanceof THREE.BufferGeometry&&(e instanceof THREE.Mesh?(t.Mesh.count+=1,e.geometry.attributes.position&&(t.Mesh.points+=e.geometry.attributes.position.count),e.geometry.index&&(t.Mesh.triangles+=e.geometry.index.count/3)):(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&(t.Line.count+=1,e.geometry.attributes.position&&(t.Line.points+=e.geometry.attributes.position.count)))),void 0===e.children)return t;for(var n=0,i=e.children.length;n<i;++n){var r=le(e.children[n]);t.Mesh.triangles+=r.Mesh.triangles,t.Mesh.points+=r.Mesh.points,t.Mesh.count+=r.Mesh.count,t.Line.points+=r.Line.points,t.Line.count+=r.Line.count}return t}function de(e){if(!e||0!=e.selectfromtree){var t=w.selectionManager.getSelectedObjects();if(1!=e){w.explodeObjects=[];for(var n=new THREE.Box3,i=0;i<t.length;++i){var r,o=t[i];(h=w.ndsModel.getBodyBoundingBox(o))&&!h.isEmpty()&&(n.expandByPoint(h.max),n.expandByPoint(h.min)),o.leafBodyAttri||null!=(r=w.ndsModel.objectidTouuid?o.objectid:w.ndsModel.meshManager.bodyUuid2IdMap[o.uuid])&&-1==w.explodeObjects.indexOf(r)&&w.explodeObjects.push(r)}for(var a=(n.isEmpty()?w.controls.getBoundingBox():n).getCenter(),s=new THREE.Box3,i=0;i<t.length;++i)for(var o=t[i],l=w.ndsModel.getLeafBodies(o),d=0,c=l.length;d<c;d++)l[d].leafBodyAttri&&(w.ndsModel.objectidTouuid?w.explodeObjects.push(l[d].objectid):w.explodeObjects.push(l[d].id),s.min.fromArray(l[d].leafBodyAttri.bodyBbox,0),s.max.fromArray(l[d].leafBodyAttri.bodyBbox,3),l[d].leafBodyAttri.bodyTranslate[0]=.5*(s.min.x+s.max.x)-a.x,l[d].leafBodyAttri.bodyTranslate[1]=.5*(s.min.y+s.max.y)-a.y,l[d].leafBodyAttri.bodyTranslate[2]=.5*(s.min.z+s.max.z)-a.z)}else{for(n=new THREE.Box3,i=0;i<w.explodeObjects.length;++i){var h,u=(w.ndsModel.objectidTouuid||w.ndsModel.meshManager.bodyUuids)[w.explodeObjects[i]];(o=w.ndsModel.getBodyNodeFromUuid(u))||(u=w.ndsModel.meshManager.lineSegBodyUuids[w.explodeObjects[i]],o=w.ndsModel.getBodyNodeFromUuid(u)),o.leafBodyAttri&&(h=w.ndsModel.getBodyBoundingBox(o))&&(n.expandByPoint(h.max),n.expandByPoint(h.min))}for(a=n.getCenter(),s=new THREE.Box3,i=0;i<w.explodeObjects.length;++i)u=(w.ndsModel.objectidTouuid||w.ndsModel.meshManager.bodyUuids)[w.explodeObjects[i]],(o=w.ndsModel.getBodyNodeFromUuid(u))||(u=w.ndsModel.meshManager.lineSegBodyUuids[w.explodeObjects[i]],o=w.ndsModel.getBodyNodeFromUuid(u)),o.leafBodyAttri&&(s.min.fromArray(o.leafBodyAttri.bodyBbox,0),s.max.fromArray(o.leafBodyAttri.bodyBbox,3),o.leafBodyAttri.bodyTranslate[0]=.5*(s.min.x+s.max.x)-a.x,o.leafBodyAttri.bodyTranslate[1]=.5*(s.min.y+s.max.y)-a.y,o.leafBodyAttri.bodyTranslate[2]=.5*(s.min.z+s.max.z)-a.z)}}}function ce(){w.dispatchEvent({type:"fullScreenEvent",isFullScreen:w.isFullScreen()})}return Object.defineProperties(qn(qn(x)),{loadCallback:{get:function(){return ie},set:function(e){ie=e}},renderSettingCallback:{get:function(){return oe},set:function(e){oe=e}},bufferChunkCallback:{get:function(){return ae},set:function(e){ae=e}},loadErrorCallback:{get:function(){return se},set:function(e){se=e}}}),NDS.TextureLoadingManager=new THREE.LoadingManager,NDS.TextureLoadingManager.onProgress=function(e,t,n){V&&w.render()},NDS.TextureLoadingManager.onError=function(){NDS.TextureLoadingManager.itemEnd(),V&&w.render()},x.load3D=function(t,n,i,o,e,a){w.showWaiterCoverStater(!0),w.controls.SetBoundingBoxUpdated(!1),p=(performance||Date).now(),NDS.StartRenderTime=Date.now(),V=!1,g=void 0,w.meshLoadedUUIDs=[];try{var r,s,l,d,c;u.onProgress=function(e,t,n){},u.onError=function(){u.itemEnd()},u.onLoad=function(){if(!1!==g){var e;w.dispatchEvent({type:"loadBegin"}),w.showWaiterCoverStater(!1),w.initModelUpDirection(h.modelUpDirection),w.scene.updateMatrixWorld(!0),w.getLinesVisibility()||w.showLineObjects(w.scene,!1),V=void 0===g||g,w.selectionManager.computeTargetList(w.scene),y&&w.updateEnvMap(w.envMapTexture),null==o?f&&(t={smoothTranslation:!1},w.camera.getOrginalCameraInfo()&&(t.useOrginal=!0),w.cameraInfoFile&&w.is2DModel&&!w.cameraInfoFile.hasSet&&(t.up=w.cameraInfoFile.up,w.cameraInfoFile.hasSet=!0),w.Euler&&((e=new THREE.Vector3(0,0,1)).applyEuler(w.Euler),t.from=e.toArray(),(e=new THREE.Vector3(0,1,0)).applyEuler(w.Euler),t.up=e.toArray()),w.resetCamera(t)):(o.smoothTranslation=!1,w.setCameraInfo(o)),w.recordOriginalMeshes(),w.isolateMeshes.length=0;var t=(performance||Date).now();if(m=(t-p)/1e3,console.log("Load time : "+m.toFixed(2)),w.dispatchAsyncEvent({type:"geometryLoadedEvent"}),void 0===g&&(w.setRenderMode(w.renderMode,!1),t=le(w.scene),console.log("Mesh  count : "+t.Mesh.count+"   triangles : "+t.Mesh.triangles+"   points : "+t.Mesh.points),console.log("Line  count : "+t.Line.count+"   points : "+t.Line.points),w.animationsManager&&w.animationsManager.hasAnimations()?Ue.enableBroadcast||0!=w.turnoffAnimation||w.startAnimationByUUID(h.animationUUID,!0):w.toggleAutoRotation(!0),Ue.enableBroadcast&&(w.render(),Ue.broadcastMajor&&document.addEventListener("mousemove",w.broadcastManager.onBroadcastMouseMove,!1))),re?(w.lightControls.resetPosition(),a&&a(w.meshLoadedUUIDs)):(w.lightControls.loadTextures(function(){w.lightControls.resetPosition(),a&&a(w.meshLoadedUUIDs)}),re=!0),w.useTransparentList&&w.transparentList){for(var n=[],i=0;i<w.transparentList.length;++i){var r=(r=w.ndsModel.meshManager.bodyUuids[w.transparentList[i]])||w.ndsModel.objectidTouuid[w.transparentList[i]];w.ndsModel.bodyUuid2NodeMap[r]&&n.push(w.ndsModel.bodyUuid2NodeMap[r])}0<n.length&&w.ndsModel.transparentizeBodies(n)}}},"js"===e||null==e?Array.isArray(t)?(Gn.getExtension("RefModelModeExtension")&&Gn.getExtension("RefModelModeExtension").unload(w),(c=new Fe(u,w)).load(h,t,n,i,ie,oe,ae,void 0,se)):((r=new He).setCrossOrigin(this.crossOrigin),r.load(null,t,function(e){try{JSON.parse(e).bundleFile?Gn.getExtension("RefModelModeExtension")&&(Gn.getExtension("RefModelModeExtension").load(w),w.initViewer()):Gn.getExtension("RefModelModeExtension")&&Gn.getExtension("RefModelModeExtension").unload(w),new Fe(u,w).load(h,t,n,i,ie,oe,ae,void 0,se)}catch(e){return void(se&&se())}})):"obj"===e?(c=new _e(u),s=t.lastIndexOf("|"),d=l=null,0<s?(l=t.substr(0,s),d=t.substr(s+1,t.length)):l=t,u.itemStart(),c.load(l,d,function(e){w.clearScene(w.scene),w.scene.add(e),w.modelRootObject=e,w.addLights(w.scene),u.itemEnd()},function(){},function(){u.itemEnd()})):"obj_json"===e&&(c=new THREE.JSONLoader(u),u.itemStart(),c.load(t,function(e,t){t=new THREE.Mesh(e,new THREE.MeshFaceMaterial(t));w.clearScene(w.scene),w.scene.add(t),w.modelRootObject=t,w.addLights(w.scene),u.itemEnd()}))}catch(e){w.showWaiterCoverStater(!1),w.dispatchAsyncEvent({type:"loadError",errorInfo:"load3d error"})}},x.run=function(e){requestAnimationFrame(w.run);var t=Date.now()-NDS.StartRenderTime;w.renderNew(e,t<15e3),w.isRunning=!0},x.resetForReload=function(){w.clearScene(w.scene),w.ndsModel=null,w.modelRootObject=null,w.modelInfo.length=0,w.camera.setOrginalCameraInfo(void 0),w.originalMeshes.length=0,w.brepManager=null,w.pmiObject=null,w.ndsModelObjectTreeLoaded=!1,w.additionalObjectsScene.children.length=0,w.selectionManager.clearSelection(),w.annotationsManager&&(w.annotationsManager.removeAllAnnotations(),w.annotationsManager=void 0),w.ndsModelPMILoaded=!1,w.ndsModelBvhLoaded=!1,w.onSectionView(!1),w.onBoxSectionView(!1),w.bDefaultOpRotate?w.setOperatorByID("OpOrbit"):w.setOperatorByID("OpPan"),w.controls.update(),w.render(),w.loaderror=!1},x.clearScene=function(e){for(var t=0;t<e.children.length;t++)"lightctrls"===e.children[t].name||e.children[t]instanceof THREE.Light||(e.remove(e.children[t]),t--);w.controls.update(),w.render()},x.showLineObjects=function(e,t){for(var n=e.children,i=0;i<n.length;i++)n[i]instanceof THREE.Line||n[i]instanceof THREE.LineSegments?(!w.materialsSetting||w.materialsSetting&&w.materialsSetting.getMaterialsMarkersMat()!=n[i].material)&&(n[i].visible=t,null!=n[i].tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(n[i].visible=!1)):0<n[i].children.length&&"lightctrls"!=n[i].name&&this.showLineObjects(n[i],t)},x.renderHiddenLinesVisible=function(){w.modelRootObject&&(w.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&void 0!==e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)}),w.renderer.render(w.scene,w.camera),w.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&(void 0===e.material.oldOpacity&&(e.material.oldOpacity=e.material.opacity,e.material.oldDepthFunc=e.material.depthFunc,e.material.oldTransparent=e.material.transparent),e.material.opacity=.2,e.material.depthFunc=THREE.GreaterDepth,e.material.transparent=!0,e.material.needsUpdate=!0)}),w.renderer.render(w.scene,w.camera),w.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&void 0!==e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)}))},x.getLightControls=function(){return w.lightControls},x.addLights=function(e){var t,n,i;0<w.lights.length||(null==w.ambientLight&&(w.ambientLight=new THREE.AmbientLight(5263440),w.scene.add(w.ambientLight)),(t=new THREE.HemisphereLight(16777215,5592405,v)).position.set(0,5,0),(n=new THREE.DirectionalLight(16777215,c)).position.set(1,2,0),n._followCamera=!0,(i=new THREE.PointLight(16777215,0)).position.set(0,0,0),w.lights.push(t),w.lights.push(n),w.lights.push(i),w.lightControls=new ge(this))},x.changeLights=function(e){if(void 0!==e)switch(e){case"0":w.hemiSphereLight.intensity=.12;break;case"1":w.hemiSphereLight.intensity=.28;break;case"2":w.hemiSphereLight.intensity=.58;break;case"3":w.hemiSphereLight.intensity=.8;break;default:w.hemiSphereLight.intensity=.12}},x.showObjectAtObjectLevel=function(e,t){if(w.ndsModel&&e===w.scene&&t)return w.showAllModel();w.ndsModel?t?w.ndsModel.showBody(e):w.ndsModel.hideBody(e):e instanceof THREE.Light||(e.visible=t,w.selectionManager.computeTargetList(w.modelRootObject))},x.showObject=function(e,t){if(w.ndsModel&&e===w.scene&&t)return w.showAllModel();if(w.ndsModel)t?w.ndsModel.showBody(e):w.ndsModel.hideBody(e);else if(!(e instanceof THREE.Light)){t&&(e.visible=t);var n=e.children;if(null==n||n.length<=0||e instanceof THREE.SkinnedMesh)e instanceof THREE.Line||e instanceof THREE.LineSegments?w.bLinesVisibility&&(!w.materialsSetting||w.materialsSetting&&w.materialsSetting.getMaterialsMarkersMat()!=e.material)&&(e.visible=t,null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1)):e.visible=t;else for(var i=0,r=n.length;i<r;++i)w.showObject(n[i],t)}},x.showObjectList=function(e,t){if(w.showObject(w.scene,!t),e&&0<e.length)for(var n=0;n<e.length;++n){var i=w.ndsModel.getBodyNodeFromUuid(e[n]);w.showObject(i,t)}w.zoomExtents()},x.showObjectReversed=function(e){if(w.ndsModel&&e===w.scene)return w.ndsModel.reverseBodyVisibility();if(w.ndsModel)w.ndsModel.showBodyReversed(e);else if(!(e instanceof THREE.Light||"lightctrls"==e.name)){var t=e.children;if(null==t||t.length<=0||e instanceof THREE.SkinnedMesh)e instanceof THREE.Line||e instanceof THREE.LineSegments?w.bLinesVisibility&&(!w.materialsSetting||w.materialsSetting&&w.materialsSetting.getMaterialsMarkersMat()!=e.material)&&(e.visible=!e.visible,null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1)):e.visible=!e.visible;else for(var n=0,i=t.length;n<i;++n)w.showObjectReversed(t[n])}},x.fixObjectByUUID=function(e,t){w.ndsModel&&(w.ndsModel.getBodyNodeFromUuid(e).fixed=t)},x.setRefPlaneVisibilityByComponent=function(e,t){!w.ndsModel||(e=w.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentRefPlaneVisibility(t),w.render())},x.setRefAxisVisibilityByComponent=function(e,t){!w.ndsModel||(e=w.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentRefAxisVisibility(t),w.render())},x.setCoordinateSysVisibilityByComponent=function(e,t){!w.ndsModel||(e=w.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentCoordinateSysVisibility(t),w.render())},x.setBodyVisibilityByComponent=function(e,t){!w.ndsModel||(e=w.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentBodyVisibility(t),w.render())},x.setObjectOpacity=function(e,t){if(w.ndsModel)t<.98?w.ndsModel.transparentBody(e,t):w.ndsModel.opaqueBody(e);else if(!(e instanceof THREE.Light)){var n=e.children;if((null==n||n.length<=0)&&e.material)return e.material.opacity=t,void(e.material.transparent=1!=e.material.opacity);for(var i=0,r=n.length;i<r;++i)w.setObjectOpacity(n[i],t)}},x.setObjectOpacityIsolate=function(e,t,n){if(!(e instanceof THREE.Light||"lightctrls"==e.name)){var i=e.children;if((null==i||i.length<=0||e instanceof THREE.SkinnedMesh)&&e.material)return ne(e,n)?void 0:(e.material.opacity=t,e.material.transparent=1!=e.material.opacity,void(e.material.needsUpdate=!0));for(var r=0,o=i.length;r<o;++r)w.setObjectOpacityIsolate(i[r],t,n)}},x.changeObjectColor=function(e,t){var n;!w.ndsModel||(n=w.ndsModel.getBodyNodeFromUuid(e))&&(w.ndsModel.changeBodyColor(n,t,!1),this.exchangeNodeColor.push({objectUUID:e,color:t})),w.render()},x.getObjectColor=function(e){if(w.ndsModel){e=w.ndsModel.getBodyNodeFromUuid(e);if(e&&e.getUserMaterial()){e=e.getUserMaterial().color.getHex();if(e)return e}}return null},x.autoChangeObjectColor=function(e,t){var n;return w.ndsModel&&(n=w.ndsModel.rootBodyNode,e?(t=t||w.materialsSetting.randColor(),w.oneKeyColor.isActive=!0,w.oneKeyColor.color=t,w.ndsModel.changeBodyColor(n,t,!0)):(this.exchangeNodeColor=[],w.oneKeyColor.isActive=!1,w.ndsModel.changeBodyColor(n,!1,!1))),w.render(),t},x.getBodyNodeFromUuid=function(e){return w.ndsModel.getBodyNodeFromUuid(e)},x.recordOriginalMeshes=function(){w.originalMeshes.length=0,function e(t,n){if(t instanceof THREE.Light||"lightctrls"==t.name)return;var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.material)return void n.push(new ye.map(t,{opacity:t.material.opacity,transparent:t.material.transparent,oriMat:t.material}));for(var r=0,o=i.length;r<o;++r)e(i[r],n)}(w.scene,w.originalMeshes)},x.restoreOriginalMeshes1=function(){for(var e=0,t=w.originalMeshes.length;e<t;++e){var n=w.originalMeshes[e].key,i=w.originalMeshes[e].value;n.material!=Ue.selectedMaterial&&(n.material.opacity=i.opacity,n.material.transparent=i.transparent)}},x.restoreOriginalMeshes=function(){for(var e=0,t=w.originalMeshes.length;e<t;++e){var n=w.originalMeshes[e].key,i=w.originalMeshes[e].value;n.material!=Ue.selectedMaterial&&(n.material=i.oriMat,n.material.opacity=i.opacity,n.material.transparent=i.transparent)}},x.restoreObjectOpacity=function(e){var t=function(e,t){for(var n=0,i=t.length;n<i;++n)if(e==t[n].key)return t[n].value}(e,w.originalMeshes);t&&(e.material.opacity=t.opacity,e.material.transparent=t.transparent)},x.isLeaf=function(e){var t=e.children.length;if(t<=0)return!0;var n=!1;if(w.ndsModel){for(var i=0;i<t;i++)if("mesh"==(r=e.children[i]).type.toLowerCase()||"line"==r.type.toLowerCase()||"linepieces"==r.type.toLowerCase())return!0}else for(var r,i=0;i<t;i++)if((r=e.children[i])instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.LineSegments||r instanceof THREE.SkinnedMesh){n=!0;break}return n},x.getModelTree=function(e){function i(e,t){if(e.fullpath=""!=t?t+"/"+e.name:e.name,0<e.children.length)for(var n=0;n<e.children.length;++n)i(e.children[n],e.fullpath)}function n(e){if(1<e.children.length)return i(e,""),e;if(1!=e.children.length)return i(e,""),e;if(null==e.type||"model"!=e.type.toLowerCase()&&"part"!=e.type.toLowerCase()&&"assembly"!=e.type.toLowerCase()){var t=e.children[0];return t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.LineSegments||t instanceof THREE.SkinnedMesh?(i(e,""),e):null==t.type||"model"!=t.type.toLowerCase()&&"object3d"!=t.type.toLowerCase()?n(e.children[0]):(i(t,""),t)}return i(e,""),e}var t=null,t=w.ndsModel?w.ndsModel.rootBodyNode:w.modelRootObject;return e?function e(t){if(!0===t.unload)return null;if(t.children.length)for(var n=t.children.length-1;0<=n;n--)!0===t.children[n].unload?t.children.splice(n,1):e(t.children[n]);return t}(n(t)):n(t)},x.isolateObject=function(e){w.showObject(w.scene,!1),w.showObject(e,!0),w.zoomExtents()},x.copyMeshes=function(e,t){for(var n=e.length=0,i=t.length;n<i;++n)e.push(new ye.map(t[n].key,t[n].value.clone()))},x.getObjectByUUID=function(e){return w.ndsModel?w.ndsModel.getBodyNodeFromUuid(e):w.modelRootObject.getObjectByProperty("uuid",e)},x.isolateObjectsByUUID=function(e){for(var t=[],n=0;n<e.length;n++){var i=null;(i=w.ndsModel?w.ndsModel.getBodyNodeFromUuid(e[n]):w.modelRootObject.getObjectByProperty("uuid",e[n]))&&t.push(i)}0<t.length&&w.isolateObjects(t)},x.isolateObjects=function(e){if(w.ndsModel)w.ndsModel.inIsolate()&&w.exitIsolate(),w.ndsModel.isolateBodies(e,Ue.bodyOpacity,Ue.lineOpacity),w.selectionManager.clearSelection(),w.render();else{for(var n=[],t=0,i=e.length;t<i;t++)e[t].traverse(function(e){var t;(null==e.children||e.children.length<=0||e instanceof THREE.SkinnedMesh||e.material)&&(n.push(new ye.map(e,e.material)),t=e.material.clone(),e.material=t)});n.length<=0||(w.copyMeshes(w.isolateMeshes,n),w.selectionManager.clearSelection(),w.setObjectOpacityIsolate(w.modelRootObject,Ue.bodyOpacity,w.isolateMeshes),w.render())}},x.getIsolateMeshes=function(){for(var e=[],t=0,n=w.isolateMeshes.length;t<n;t++)e.push(w.isolateMeshes[t].key);return e},x.isAllwhiteforline=function(){for(var e in w.ndsModel.meshManager.materials)if(!w.ndsModel.meshManager.materials[e].mat.color.equals(new THREE.Color(1,1,1)))return!1;return!0},x.isolateSelectedObjects=function(){var e,t;w.ndsModel?(t=w.selectionManager.getSelectedObjects(),w.hasObjectIsolated()?(w.dispatchEvent({type:"isolateSelectedObjects",objects:t}),t.length<=0||(w.ndsModel.isolateBodiesOnly(t),w.selectionManager.clearSelection(),w.render())):(w.dispatchEvent({type:"isolateSelectedObjects",objects:t}),t.length<=0||(w.ndsModel.isolateBodies(t,Ue.bodyOpacity,Ue.lineOpacity),w.selectionManager.clearSelection(),w.render()))):(0<w.isolateMeshes.length&&(w.restoreOriginalMeshes1(),w.isolateMeshes.length=0,w.dispatchEvent({type:"exitIsolate"})),e=w.selectionManager.getSelectedMeshes(),t=w.selectionManager.getSelectedObjects(),w.dispatchEvent({type:"isolateSelectedObjects",objects:t}),e.length<=0||(w.copyMeshes(w.isolateMeshes,e),w.selectionManager.clearSelection1(),w.restoreOriginalMeshes1(),w.setObjectOpacityIsolate(w.modelRootObject,Ue.bodyOpacity,w.isolateMeshes)),w.render())},x.exitIsolate=function(){if(w.ndsModel){if(!w.ndsModel.inIsolate())return;w.ndsModel.exitIsolate()}else{if(w.isolateMeshes.length<=0)return;w.restoreOriginalMeshes(),w.isolateMeshes.length=0}w.render(),w.dispatchEvent({type:"exitIsolate"})},x.transparentSelectedObjects=function(){if(w.ndsModel){var e=w.selectionManager.getSelectedObjects();w.ndsModel.inIsolate()?(w.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(w.ndsModel.transparentizeBodiesOnly(e),w.selectionManager.clearSelection(),w.render())):(w.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(w.ndsModel.transparentizeBodies(e),w.selectionManager.clearSelection(),w.render()))}else{var t=w.selectionManager.getSelectedMeshes();if(!(t.length<=0))for(var n=0,i=t.length;n<i;++n){var r=t[n].value.oldMat.clone();r.transparent=!0,r.opacity=.2,r.depthWrite=!1,t[n].value.oldMat=r}}},x.transparentOrisolateSelectObjects=function(){var e;w.ndsModel&&((e=w.selectionManager.getSelectedObjects()).length<=0||(e[0].isTransparent()?(w.dispatchEvent({type:"isolateSelectedObjects",objects:e}),w.ndsModel.isolateBodiesOnly(e)):(w.dispatchEvent({type:"transparentSelectedObjects",objects:e}),w.ndsModel.transparentizeBodiesOnly(e)),w.selectionManager.clearSelection(),w.render()))},x.getSelectedObjectsstatus=function(){if(w.ndsModel){for(var e=w.ndsModel.getSelectedBodies(),t=0,n=0;n<e.length;++n)t+=e[n].isTransparent();return 0==t?{num:e.length,status:"show"}:t==e.length?{num:e.length,status:"transparent"}:{num:e.length,status:"other"}}},x.opaqueSelectedObjects=function(){if(w.ndsModel)for(var e,t=0,n=(e=w.selectionManager.getSelectedObjects()).length;t<n;++t)w.ndsModel.opaqueBody(e[t]);else if(!((e=w.selectionManager.getSelectedMeshes()).length<=0))for(var i=0,n=e.length;i<n;++i){var r=e[i].value.oldMat.clone();r.transparent=!1,r.opacity=1,r.depthWrite=!0,e[i].value.oldMat=r}},x.hideSelectedObjects=function(){if(w.ndsModel)for(var e=0,t=(n=w.selectionManager.getSelectedObjects()).length;e<t;++e)w.ndsModel.hideBody(n[e]),w.modelBrowserDlg&&w.modelBrowserDlg.hideTreeNodeByObject(n[e]);else{var n;if((n=w.selectionManager.getSelectedMeshes()).length<=0)return;for(e=0,t=n.length;e<t;++e)w.showObject(n[e].key,!1),w.modelBrowserDlg&&w.modelBrowserDlg.hideTreeNodeByObject(n[e])}w.selectionManager.clearSelection(),w.render()},x.hideUnloadbodies=function(e){if(w.ndsModel)if(e.unload)w.ndsModel.hideBody(e);else if(e.children)for(var t=0;t<e.children.length;t++){var n=e.children[t];w.hideUnloadbodies(n)}},x.hideOtherObjects=function(){if(0!=w.selectionManager.getSelectedObjects().length){if(w.ndsModel){w.ndsModel.hideAllBodies();for(var e=w.selectionManager.getSelectedObjects(),t=0,n=e.length;t<n;++t)w.ndsModel.showBody(e[t]),w.hideUnloadbodies(e[t])}w.selectionManager.clearSelection(),w.render()}},x.showAllModel=function(){if(w.exitIsolate(),w.ndsModel)for(var e in w.ndsModel.showAllBodies(),w.ndsModel.bodyUuid2NodeMap)w.ndsModel.bodyUuid2NodeMap[e].unload&&w.ndsModel.hideBody(w.ndsModel.bodyUuid2NodeMap[e]);else w.showObject(w.scene,!0);w.modelBrowserDlg&&w.modelBrowserDlg.showAllTreeNode(),w.render(),w.dispatchEvent({type:"showAllModel"})},x.getSelectedObjectProperty=function(e){var t=w.selectionManager.getSelectedObjects();if(t.length<=0)return null;null==w.propertyManager&&(w.propertyManager=new Zt(w));var n=null;if(w.ndsModel){for(var i=[],r=[],o=0;o<t.length;++o){var a=w.ndsModel.getBodyNodeFromUuid(t[o].uuid);r.push(a)}for(var s=0,o=0;o<r.length;++o){if(0<=r[o].id&&!r[o].isHidden())-1==i.indexOf(r[o])&&i.push(r[o]);else for(var l=0,d=r[o].children.length;l<d;++l)r.push(r[o].children[l]);0<r[o].children.length&&"Body"==r[o].children[0].type&&!this.ndsModel.isBodyAllChildHidden(r[o])&&s++}var n={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:s,bodyNum:0,unit:w.modelUnit,boundingboxVolume:0},c=new THREE.Box3;if(w.brepManager)for(l=0;l<i.length;++l){var h=i[l],u=w.brepManager.GetBodyVolumeAndArea(h.uuid),f=w.ndsModel.getBodyBoundingBox(h),p=h.isHidden();u?p||(n.area+=u.area,n.volume+=u.volume,f&&(c.expandByPoint(f.max),c.expandByPoint(f.min))):this.productDataMap&&(u=this.productDataMap[h.uuid])&&!p&&(n.area+=u.area,n.volume+=u.volume,f&&(c.expandByPoint(f.max),c.expandByPoint(f.min)))}else if(this.productDataMap)for(l=0;l<i.length;++l){h=i[l],u=this.productDataMap[h.uuid],f=this.ndsModel.getBodyBoundingBox(h),p=h.isHidden();u&&!p&&(n.area+=u.area,n.volume+=u.volume,f&&(c.expandByPoint(f.max),c.expandByPoint(f.min)))}n.boundingboxVolume=Math.abs(c.max.x-c.min.x)*Math.abs(c.max.y-c.min.y)*Math.abs(c.max.z-c.min.z),n.boundingbox.x=Math.abs(c.max.x-c.min.x),n.boundingbox.y=Math.abs(c.max.y-c.min.y),n.boundingbox.z=Math.abs(c.max.z-c.min.z);var m=w.getDispalyModelUnit(n.volume,n.area);m&&(n.volume=n.volume*m.scale*m.scale*m.scale,n.area=n.area*m.scale*m.scale,n.boundingbox.x*=m.scale,n.boundingbox.y*=m.scale,n.boundingbox.z*=m.scale,n.boundingboxVolume=n.boundingboxVolume*m.scale*m.scale*m.scale,n.unit=m.unit)}return w.propertyManager.getObjectProperty(t[0],e,n),n},x.getBrepMemory=function(){if(this.productData)return this.productData.datas[0].brepMemory},x.getObjectProperty=function(e,t,n){null==w.propertyManager&&(w.propertyManager=new Zt(w)),n=n||!1;for(var i,r=[],o=[e],a=0,s=0;s<o.length;++s){if(i=o[s].type.toLowerCase(),0<=o[s].id&&!o[s].isReferenceEntity()&&!o[s].isCoordinate()&&!o[s].isHidden())r.push(o[s]);else for(var l=0,d=o[s].children.length;l<d;++l)o.push(o[s].children[l]);0<o[s].children.length&&"part"==i&&!this.ndsModel.isBodyAllChildHidden(o[s])&&a++}var c={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:a,bodyNum:r.length,unit:w.modelUnit,boundingboxVolume:0},h=new THREE.Box3;if(w.brepManager)for(l=0;l<r.length;++l){var u=r[l],f=w.brepManager.GetBodyVolumeAndArea(u.uuid),p=w.ndsModel.getBodyBoundingBox(u),m=u.isHidden();f?m||(c.area+=f.area,c.volume+=f.volume,p&&(h.expandByPoint(p.max),h.expandByPoint(p.min))):this.productDataMap&&(u=r[l],(f=this.productDataMap[u.uuid])&&!m&&(c.area+=f.area,c.volume+=f.volume,p&&!isNaN(p.max.x)&&(h.expandByPoint(p.max),h.expandByPoint(p.min))))}else if(this.productDataMap)for(var g=0;g<r.length;++g){u=r[g],f=this.productDataMap[u.uuid],p=this.ndsModel.getBodyBoundingBox(u),m=u.isHidden();f&&!m&&(c.area+=f.area,c.volume+=f.volume,p&&!isNaN(p.max.x)&&(h.expandByPoint(p.max),h.expandByPoint(p.min)))}!this.productData||e.uuid!=w.ndsModel.rootBodyNode.uuid&&!n||this.ndsModel.isBodyOrSomeChildHidden(e)||(c.pmiNum=this.productData.datas[0].pmiNum,h=this.modelRootObject.boundingBox),c.boundingboxVolume=Math.abs(h.max.x-h.min.x)*Math.abs(h.max.y-h.min.y)*Math.abs(h.max.z-h.min.z),c.boundingbox.x=Math.abs(h.max.x-h.min.x),c.boundingbox.y=Math.abs(h.max.y-h.min.y),c.boundingbox.z=Math.abs(h.max.z-h.min.z);n=w.getDispalyModelUnit(c.volume,c.area);return n&&(c.volume=c.volume*n.scale*n.scale*n.scale,c.area=c.area*n.scale*n.scale,c.boundingbox.x*=n.scale,c.boundingbox.y*=n.scale,c.boundingbox.z*=n.scale,c.boundingboxVolume=c.boundingboxVolume*n.scale*n.scale*n.scale,c.unit=n.unit),w.hasBrepFile()||(c.boundingbox=new THREE.Vector3,c.boundingboxVolume=0),w.propertyManager.getObjectProperty(e,t,c),c},x.getfileProperty=function(e,t){var n=!1;for(e.uuid==w.ndsModel.rootBodyNode.uuid&&(n=!0),"Model"!=e.type||1!=e.children.length||"Part"!=e.children[0].type||null!=e.parent||e.children[0].fileguid||(e=e.children[0]);(null==e.propertyfile||null==e.propertyfile)&&e.parent;)e=e.parent;this.getObjectProperty(e,t,n)},x.getStaticProperty=function(){return{meshNum:le(w.scene).Mesh.count,bodyNum:this.ndsModel.wholeLeafBodyNodes.length,box:this.modelRootObject.boundingBox,pmiNum:this.productData.datas[0].pmiNum}},x.getUnvisibleList=function(){if(w.ndsModel){for(var e=w.ndsModel.hideBodies,t=[],n=0;n<e.length;++n){var i,r=e[n];if(r)for(w.ndsModel.objectidTouuid?-1==t.indexOf(r.objectid)&&t.push(r.objectid):(i=this.ndsModel.meshManager.bodyUuid2IdMap[r.uuid],-1==t.indexOf(i)&&t.push(i));r.parent;){if(w.ndsModel.objectidTouuid){if(-1!=t.indexOf(r.parent.objectid))break}else if(null!=(i=this.ndsModel.meshManager.bodyUuid2IdMap[r.parent.uuid])&&-1!=t.indexOf(i))break;if(!w.ndsModel.isBodyAllChildHidden(r.parent))break;w.ndsModel.objectidTouuid?t.push(r.parent.objectid):null!=(i=this.ndsModel.meshManager.bodyUuid2IdMap[r.parent.uuid])&&t.push(i),r=r.parent}}return t}},x.hasObjectHidden=function(){if(w.ndsModel)return w.ndsModel.hasHiddenBodies},x.hasObjectIsolated=function(){if(w.ndsModel)return 0<w.getTransparentList().length},x.getTransparentList=function(){if(w.ndsModel){for(var e=w.ndsModel.getTransparentizedBodies(),t=[],n=0;n<e.length;++n){var i=e[n];i&&-1!=i.id&&(w.ndsModel.objectidTouuid?t.push(i.objectid):t.push(i.id))}return t}},x.hasObjectHiddenOrIsolated=function(){if(w.ndsModel)return!(!w.ndsModel.hasHiddenBodies&&!w.hasObjectIsolated());if(0<w.isolateMeshes.length)return!0;var e=new Object;return e.hidden=!1,0<w.scene.children.length&&function e(t,n){var i=t.children;if(null==i||i.length<=0||t instanceof THREE.SkinnedMesh){if(t instanceof THREE.Line||t instanceof THREE.LineSegments){if(w.bLinesVisibility)if(null!=t.tangentEdgeObject){if(1==Ue.tangentEdgeVisible&&0==t.visible)return void(n.hidden=!0)}else if(0==t.visible)return void(n.hidden=!0)}else if(0==t.visible)return void(n.hidden=!0)}else if(0==t.visible)return void(n.hidden=!0);if(i)for(var r=0,o=i.length;r<o;++r){if(n.hidden)return;e(i[r],n)}}(w.scene.children[0],e),!!e.hidden},x.isAllHidden=function(){if(0<this.scene.children.length){var e=new Object;return e.visible=!1,function e(t,n){if(0!=t.visible){var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.visible)n.visible=!0;else for(var r=0,o=i.length;r<o;++r){if(n.visible)return;e(i[r],n)}}}(this.scene.children[0],e),!e.visible}return!1},x.isObjectOrSomeChildHidden=function(e){if(e instanceof De&&w.ndsModel)return w.ndsModel.isBodyOrSomeChildHidden(e)},x.isEmptyNode=function(e){if(e instanceof De&&w.ndsModel){if(0!=e.children.length||e.leafBodyAttri){if(0<e.children.length){for(var t=0;t<e.children.length;++t){var n=e.children[t];if(!this.isEmptyNode(n))return!1}return!0}return!1}return!0}},x.getModelCenter=function(){var e=new THREE.Vector3,t=new THREE.Vector3;w.computeBoundingBox(w.scene,e,t,{flag:!0});var n=new THREE.Vector3;return n.x=.5*(t.x+e.x),n.y=.5*(t.y+e.y),n.z=.5*(t.z+e.z),n},x.stopReadingModel=function(e){w.fileUpload&&(w.fileUpload.stopReadingModel(),w.showWaiterCoverStater(!1))},x.setLinesVisibility=function(e,t){w.bLinesVisibility=void 0===e||e,w.showLineObjects(w.modelRootObject,w.bLinesVisibility),!1!==t&&w.render()},x.getLinesVisibility=function(e){return w.bLinesVisibility},x.setZoomSpeed=function(e){w.cameraControl.setZoomSpeed(e)},x.setRotateSpeed=function(e){w.cameraControl.setRotateSpeed(e)},x.getShowToolTipFlag=function(e){return e&&w.bShowToolTip&&(w.isFullScreen()?e.domElement.innerHTML=ye.translateString("IDS_EXITFULLSCREEN"):e.domElement.innerHTML=ye.translateString("IDS_FULLSCREEN")),w.bShowToolTip},x.getToolBarAutoHideFlag=function(){return w.bToolBarAutoHide},x.getMouseWheelForwardEnlargeFlag=function(){return w.bMouseWheelForwardEnlarge},x.isObjectTypeOfElement=function(e){if(null==e)return!1;e=e.type.toLowerCase();return"element"==e||"revitelement"==e||"body"==e||"object"==e||"instanceobject"==e||"acdblayertablerecord"==e},x.traverseBodyForExplosion=function(i,e,t,n,r,o,a,s){if(null!=i&&i instanceof THREE.Object3D&&!(i instanceof THREE.Light||"lightctrls"==i.name)){if(e=w.isObjectTypeOfElement(i)?!0:e){var l=void 0,d=void 0,c=new THREE.Vector3;return(i.traverse(function(e){var t,n;(e instanceof THREE.Mesh||e instanceof THREE.Line)&&e.hasOwnProperty("geometry")&&(null==(n=e.geometry).boundingBox&&n.computeBoundingBox(),t=!1,n instanceof THREE.Geometry?t=null!=n.vertices&&0!=n.vertices.length:n instanceof THREE.BufferGeometry&&(t=null!=n.attributes.position),t&&(n=n.boundingBox.clone(),e.matrixWorldTransOrginal?(c.setFromMatrixPosition(e.matrixWorld),e.matrixWorld.setPosition(e.matrixWorldTransOrginal),n.applyMatrix4(e.matrixWorld),e.matrixWorld.setPosition(c)):n.applyMatrix4(i.matrixWorld),void 0===l||void 0===d?(l=new THREE.Vector3,d=new THREE.Vector3,l.copy(n.min),d.copy(n.max)):(l.x=Math.min(l.x,n.min.x),l.y=Math.min(l.y,n.min.y),l.z=Math.min(l.z,n.min.z),d.x=Math.max(d.x,n.max.x),d.y=Math.max(d.y,n.max.y),d.z=Math.max(d.z,n.max.z))))}),null==d||null==l)?void 0:(c.x=.5*(d.x+l.x),c.y=.5*(d.y+l.y),c.z=.5*(d.z+l.z),o+=(c.x-t.x)*(f=4*r),a+=(c.y-t.y)*f,s+=(c.z-t.z)*f,void i.traverse(function(e){var t;e.hasOwnProperty("geometry")&&(void 0===e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=new THREE.Vector3,e.matrixWorldTransOrginal.setFromMatrixPosition(e.matrixWorld)),0==r?(c.copy(e.matrixWorldTransOrginal),e.matrixWorldTransOrginalDrag&&c.add(e.matrixWorldTransOrginalDrag),e.matrixWorld.setPosition(c),(e.matrixWorldTransExplode=void 0)===e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginal=void 0)):((t=e.matrixWorldTransOrginal.clone()).x+=o,t.y+=a,t.z+=s,void 0===e.matrixWorldTransExplode&&(e.matrixWorldTransExplode=new THREE.Vector3),e.matrixWorldTransExplode.copy(t),e.matrixWorldTransOrginalDrag&&t.add(e.matrixWorldTransOrginalDrag),e.matrixWorld.setPosition(t)))}))}var h,u,f;if(i.hasOwnProperty("geometry")&&(null==(u=i.geometry).boundingBox&&u.computeBoundingBox(),h=!1,u instanceof THREE.Geometry?h=null!=u.vertices&&0!=u.vertices.length:u instanceof THREE.BufferGeometry&&(h=null!=u.attributes.position),h&&(u=u.boundingBox.clone(),c=new THREE.Vector3,i.matrixWorldTransOrginal?(c.setFromMatrixPosition(i.matrixWorld),i.matrixWorld.setPosition(i.matrixWorldTransOrginal),u.applyMatrix4(i.matrixWorld),i.matrixWorld.setPosition(c)):u.applyMatrix4(i.matrixWorld),c.x=.5*(u.max.x+u.min.x),c.y=.5*(u.max.y+u.min.y),c.z=.5*(u.max.z+u.min.z),o+=(c.x-t.x)*(f=4*r),a+=(c.y-t.y)*f,s+=(c.z-t.z)*f,void 0===i.matrixWorldTransOrginal&&(i.matrixWorldTransOrginal=new THREE.Vector3,i.matrixWorldTransOrginal.setFromMatrixPosition(i.matrixWorld)),0==r?(c.copy(i.matrixWorldTransOrginal),i.matrixWorldTransOrginalDrag&&c.add(i.matrixWorldTransOrginalDrag),i.matrixWorld.setPosition(c),(i.matrixWorldTransExplode=void 0)===i.matrixWorldTransOrginalDrag&&(i.matrixWorldTransOrginal=void 0)):((f=i.matrixWorldTransOrginal.clone()).x+=o,f.y+=a,f.z+=s,void 0===i.matrixWorldTransExplode&&(i.matrixWorldTransExplode=new THREE.Vector3),i.matrixWorldTransExplode.copy(f),i.matrixWorldTransOrginalDrag&&f.add(i.matrixWorldTransOrginalDrag),i.matrixWorld.setPosition(f)))),null!=i.children)for(var p=i.children,m=0;m<p.length;++m)w.traverseBodyForExplosion(i.children[m],e,t,n+1,r,o,a,s)}},x.explodeModel=function(e,t){var n;e!=k&&(w.toggleAutoRotation(!1),n=w.controls.getBoundingBox().getCenter(),w.ndsModel?w.ndsModel.setExplodeFactor(n,4*e):this.traverseBodyForExplosion(w.modelRootObject,!1,n,0,e,0,0,0),0==(k=e)?(w.controls.resetExplosionBoundingBox(),w.groundShadow.updateGroundTransform(w.camera,w.controls.getBoundingBox(),w.camera.worldup),w.camera.setOrthoNear(w.controls.getBoundingBox())):(n=new THREE.Vector3,e=new THREE.Vector3,w.computeBoundingBox(w.scene,n,e,{flag:!0}),w.controls.setExplosionBoundingBox(n,e),w.groundShadow.updateGroundTransform(w.camera,w.controls.getExplosionBoundingBox(),w.camera.worldup),w.camera.setOrthoNear(w.controls.getExplosionBoundingBox())),0!=t&&this.render(),w.dispatchEvent({type:"explodingModel"}))},x.setExplodeMode=function(e,t,n){0==(e&NDS.EXPLODEMODE.NORMAL)&&0==(e&NDS.EXPLODEMODE.X)&&0==(e&NDS.EXPLODEMODE.Y)&&0==(e&NDS.EXPLODEMODE.Z)&&(e+=NDS.EXPLODEMODE.NORMAL),this.isExploded()&&this.onExplode(0),this.ndsModel.explodeMode=e,this.ndsModel.explodeLevel=t;var i=[this.ndsModel.rootBodyNode],r=[];if(e&NDS.EXPLODEMODE.LEVEL){for(var o=0;o<i.length;++o){var a=i[o].getLevel();if(a==t)r.push(i[o]);else if(a<t&&0==i[o].children.length&&0<=i[o].id&&!i[o].isReferenceEntity())r.push(i[o]);else if(a<t&&0<i[o].children.length)for(var s=0,l=i[o].children.length;s<l;++s)i.push(i[o].children[s])}for(var d=this.controls.getBoundingBox().getCenter(),o=(new THREE.Box3,0);o<r.length;++o)for(var c=r[o],h=this.ndsModel.getBodyBoundingBox(c),u=this.ndsModel.getLeafBodies(c),f=0,p=u.length;f<p;f++)u[f].leafBodyAttri&&(u[f].leafBodyAttri.bodyTranslate[0]=.5*(h.min.x+h.max.x)-d.x,u[f].leafBodyAttri.bodyTranslate[1]=.5*(h.min.y+h.max.y)-d.y,u[f].leafBodyAttri.bodyTranslate[2]=.5*(h.min.z+h.max.z)-d.z);for(var o=0,m=this.ndsModel.geomManager.geoms.length;o<m;++o)this.ndsModel.geomManager.geoms[o].updateModelMatrix=!0}e&NDS.EXPLODEMODE.NORMAL&&(this.ndsModel.explodeMode&=~NDS.EXPLODEMODE.X,this.ndsModel.explodeMode&=~NDS.EXPLODEMODE.Y,this.ndsModel.explodeMode&=~NDS.EXPLODEMODE.Z,this.ndsModel.explodeObject&&this.ndsModel.explodeObject.detach()),e&NDS.EXPLODEMODE.SELECTED?(de(n),this.addEventListener("selectObject",de)):(this.explodeObjects=[],this.removeEventListener("selectObject",de)),(e&NDS.EXPLODEMODE.X||e&NDS.EXPLODEMODE.Y||e&NDS.EXPLODEMODE.Z)&&(this.ndsModel.explodeObject?(this.ndsModel.explodeObject.attach(this.ndsModel.rootBodyNode),this.ndsModel.explodeObject.visible=!1,this.ndsModel.explodeObject.name="explodeObject"):(e=null,e=this.canvas2D||this.canvas3D,(e=new be(this.camera,e)).attach(this.ndsModel.rootBodyNode),this.ndsModel.explodeObject=e,this.scene.add(e),this.ndsModel.explodeObject.name="explodeObject",this.ndsModel.explodeObject.visible=!1,this.ndsModel.explodeObject.size=.5)),this.render()},x.setExplodeAxisVisible=function(e,t){t&&(t=t.toUpperCase(),this.explodeAxis=t),this.ndsModel.explodeObject&&(this.ndsModel.explodeObject.visible=!0,this.ndsModel.explodeObject.axisVisible(e,t)),this.render()},x.selectExplodeEvent=function(e){0!=(this.ndsModel.explodeMode&NDS.EXPLODEMODE.SELECTED)&&(e?this.addEventListener("selectObject",de):this.removeEventListener("selectObject",de))},x.isExploded=function(){return 1e-6<k},x.isFullScreen=function(){return!!(document.fullscreenEnabled||document.mozFullScreenElement||document.webkitIsFullScreen||document.msFullscreenElement)},x.executeFullScreen=function(){var e,t;w.isFullScreen()?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():(e=n).requestFullscreen?e.requestFullscreen(t):e.mozRequestFullScreen?e.mozRequestFullScreen(t):e.webkitRequestFullscreen?e.webkitRequestFullscreen(t):e.msRequestFullscreen&&e.msRequestFullscreen(t)},x.startSmoothTranslation=function(e,t){this.cameraControl.startSmoothTranslation(e,t)},x.isSmoothTranslationDone=function(){return this.cameraControl.isSmoothTranslationDone()},x.smoothTranslation=function(e,t){this.cameraControl.smoothTranslation(e,t)},x.updateBackGroudImageRatio=function(e){var t,n,i,r,o,a;null!=e&&null!=e.map&&(e.map.imageOriginal instanceof HTMLImageElement||e.map.imageOriginal instanceof HTMLCanvasElement)&&(a=+w.renderer.domElement.width/w.renderer.domElement.height,i=+(t=e.map.imageOriginal.width)/(n=e.map.imageOriginal.height),r=t,o=n,.25<Math.abs(i-a)&&(a<i?(o=n,r=Math.floor(a*o)):(r=t,o=Math.floor(r/a))),t<r&&(r=t),n<o&&(o=n),(10<Math.abs(r-e.map.image.width)||10<Math.abs(o-e.map.image.height))&&((a=document.createElement("canvas")).width=r,a.height=o,a.getContext("2d").drawImage(e.map.imageOriginal,Math.floor(.5*(t-r)),Math.floor(.5*(n-o)),r,o,0,0,a.width,a.height),e.map.image=a,e.map.needsUpdate=!0))},x.setBackGroundImage=function(e,t,n){if(!e)return this.backGroundScene=void 0,this.backGroundCamera=void 0,this.backGroundMesh&&this.backGroundMesh.material&&this.backGroundMesh.material.map&&this.backGroundMesh.material.map.dispose(),this.backGroundMesh=void 0,void this.render();if(this.setEnvMapTextures(null),this.backGroundScene||(this.backGroundScene=new THREE.Scene,this.backGroundScene.autoUpdate=!1,this.backGroundCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.backGroundMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),new THREE.MeshBasicMaterial),this.backGroundMesh.material.depthTest=!1,this.backGroundMesh.material.depthWrite=!1,this.backGroundScene.add(this.backGroundCamera),this.backGroundScene.add(this.backGroundMesh),this.backGroundScene.updateMatrixWorld(!0)),t&&t(.2),this.exchangeBackImage){var i=!1;if(this.exchangeBackImage.value!==e&&(this.exchangeBackImage={type:"EnvMap",value:e},i=!0),!i)return}this.exchangeBackImage={type:"Image",value:e},Ue.avoidCaching&&(e=e+"?time="+Date.now());i=new THREE.TextureLoader;i.crossOrigin="anonymous";var r=i.load(e,function(){r.imageOriginal=r.image,w.backGroundMesh.material.map&&w.backGroundMesh.material.map.dispose(),w.backGroundMesh.material.map=r,w.backGroundMesh.material.needsUpdate=!0,w.updateBackGroudImageRatio(w.backGroundMesh.material),t&&t(1),w.render(),w.dispatchEvent({type:"backGroundImageLoaded"})},void 0,function(e){n&&n(e),w.dispatchEvent({type:"backGroundImageLoaded"}),w.dispatchEvent({type:"loadError",errorInfo:"background image error"})})},x.setGroundShadowVisibility=function(e){_=e,this.render()},x.setSmoothTranslationEnabled=function(e){j=e},x.setAutoRotationEnabled=function(e){U=e,this.cameraControl.setAutoRotationEnabled(e)},x.toggleAutoRotation=function(e){U&&this.cameraControl.toggleAutoRotation(e)},x.autoRotation=function(){this.cameraControl.autoRotation()},x.setCameraInfo=function(e,t){this.cameraControl.setCameraInfo(e,t)},x.setViewBoxDir=function(e){var t={smoothTranslation:!0,useOrginal:!1};null==(w.defaultStandardView=e)&&(t.useOrginal=!0),S||(t.type=e,w.look(t))},x.hideEnvMapTextures=function(e,t){C!=e&&(C=e,0!=t&&this.render())},x.setEnvMapTextures=function(e,t,n){if(!e)return this.updateEnvMap(null),this.envMapCamera=void 0,this.envMapScene=void 0,this.envMapTexture&&this.envMapTexture.dispose(),this.envMapTexture=void 0,this.envMapMaterial&&this.envMapMaterial.dispose(),this.envMapMaterial=void 0,this.exchangeBackImage=null,void this.render();if(this.exchangeBackImage){for(var i=!1,r=0;r<e.length;r++)if(this.exchangeBackImage.value[r]!==e[r]){this.exchangeBackImage={type:"EnvMap",value:e},i=!0;break}if(!i)return}this.exchangeBackImage={type:"EnvMap",value:e},this.envMapScene||(s=this.container.getBoundingClientRect(),this.envMapCamera=new THREE.PerspectiveCamera(60,s.width/s.height,1,1e5),this.envMapScene=new THREE.Scene,this.envMapScene.autoUpdate=!1,s=THREE.ShaderLib.cube,this.envMapMaterial=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,depthTest:!1,blending:THREE.NoBlending,side:THREE.BackSide}),this.envMapMaterial.requireModelMatrix=!0,this.envMapMaterial.uniforms.tCube.value=this.envMapTexture,s=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),this.envMapMaterial),this.envMapScene.add(s)),t&&t(.2);var o=[];if(Ue.avoidCaching)for(var a=0;a<e.length;++a)o.push(e[a]+"?time="+Date.now());else o=e;var s=new THREE.CubeTextureLoader;s.crossOrigin="anonymous";var l=s.load(o,function(){w.envMapTexture&&w.envMapTexture.dispose(),w.envMapTexture=l,w.envMapTexture.format=THREE.RGBFormat,w.envMapTexture.minFilter=THREE.LinearFilter,w.envMapTexture.magFilter=THREE.LinearFilter,w.envMapTexture.mapping="reflection"==E?THREE.CubeReflectionMapping:THREE.CubeRefractionMapping,w.envMapMaterial.uniforms.tCube.value=w.envMapTexture,w.envMapMaterial.needsUpdate=!0,y&&w.updateEnvMap(l),t&&t(1),w.render(),w.dispatchEvent({type:"envMapTexturesLoaded"})},void 0,function(e){n&&n(e),w.dispatchEvent({type:"envMapTexturesLoaded"}),w.dispatchEvent({type:"loadError",errorInfo:"envMap error"})})},x.updateEnvMap=function(t){this.scene.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||(e.material.envMap=t,void 0!==e.material.combine&&(e.material.combine=THREE.MultiplyOperation),e.material.needsUpdate=!0)}),t&&this.ndsModel&&this.ndsModel.meshManager.setMeshMaterialEnvMap(t,THREE.MultiplyOperation)},x.setEnvMapEnabled=function(e){y!=(y=e)&&(y?this.updateEnvMap(this.envMapTexture):this.updateEnvMap(),this.render())},x.setEnvMapMode=function(e){"reflection"!=(e=e.toLowerCase())&&"refraction"!=e||E!=(E=e)&&this.envMapTexture&&(this.envMapTexture.mapping="reflection"==E?THREE.CubeReflectionMapping:THREE.CubeRefractionMapping,y&&this.updateEnvMap(this.envMapTexture),this.render())},x.updateEnvMapBlur=function(){if(B){var e=w.container.getBoundingClientRect(),t=e.width,n=e.height,e=w.renderer.getPixelRatio();if(t*=e,n*=e,t*=.5,n*=.5,this.envMapBlurTargetH&&this.envMapBlurTargetH.dispose(),this.envMapBlurTargetH=new THREE.WebGLRenderTarget(t,n,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),this.envMapBlurTargetH.texture.generateMipmaps=!1,this.envMapBlurTargetV&&this.envMapBlurTargetV.dispose(),this.envMapBlurTargetV=new THREE.WebGLRenderTarget(t,n,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),this.envMapBlurTargetV.texture.generateMipmaps=!1,1==b||3<b){this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Le(xe,"tDiffuse"),this.envMapBlurPassV=new Le(xe,"tDiffuse");var i=this.envMapBlurPassH.material.defines.HORIZONTAL=1;switch(L){case 1:i=2,M=1;break;case 2:i=3.5,M=1.5;break;case 3:i=6.5,M=2}this.envMapBlurPassH.material.defines.RESOLUTION=(M/t).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(M/n).toFixed(4),this.envMapBlurPassH.material.defines.SIGMA=this.envMapBlurPassV.material.defines.SIGMA=i.toFixed(3)}else if(2==b){switch(L){case 1:M=1;break;case 2:M=1.5;break;case 3:M=2}this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Le(we,"tDiffuse"),this.envMapBlurPassV=new Le(we,"tDiffuse"),this.envMapBlurPassH.material.defines.BLUR_LEVEL=this.envMapBlurPassV.material.defines.BLUR_LEVEL=L,this.envMapBlurPassH.material.defines.HORIZONTAL=1,this.envMapBlurPassH.material.defines.RESOLUTION=(M/t).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(M/n).toFixed(4)}else if(3==b){this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Le(we,"tDiffuse"),this.envMapBlurPassV=new Le(we,"tDiffuse");var r=.02;switch(L){case 1:r=.01;break;case 2:r=.03;break;case 3:r=.1}this.envMapBlurPassH.material.defines.BLUR_AMOUNT=this.envMapBlurPassV.material.defines.BLUR_AMOUNT=r.toFixed(4)}this.envMapBlurPassH.material.blending=this.envMapBlurPassV.material.blending=THREE.NoBlending,this.envMapBlurPassH.material.depthWrite=this.envMapBlurPassV.material.depthWrite=!1,this.envMapBlurPassH.material.depthTest=this.envMapBlurPassV.material.depthTest=!1}else this.envMapBlurTargetH&&this.envMapBlurTargetH.dispose(),this.envMapBlurTargetH=void 0,this.envMapBlurTargetV&&this.envMapBlurTargetV.dispose(),this.envMapBlurTargetV=void 0,this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassH=void 0,this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassV=void 0;this.render()},x.setEnvMapBlurLevel=function(e){if(L=e,B){if(1==b||3<b){var t=1;switch(L){case 1:t=2,M=1;break;case 2:t=3.5,M=1.5;break;case 3:t=6.5,M=2}this.envMapBlurPassH.material.defines.RESOLUTION=(M/this.envMapBlurTargetH.width).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(M/this.envMapBlurTargetH.height).toFixed(4),this.envMapBlurPassH.material.defines.SIGMA=this.envMapBlurPassV.material.defines.SIGMA=t.toFixed(3)}else if(2==b){switch(L){case 1:M=1;break;case 2:M=1.5;break;case 3:M=2}this.envMapBlurPassH.material.defines.RESOLUTION=(M/this.envMapBlurTargetH.width).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(M/this.envMapBlurTargetH.height).toFixed(4),this.envMapBlurPassH.material.defines.BLUR_LEVEL=this.envMapBlurPassV.material.defines.BLUR_LEVEL=L}else if(3==b){var n=.02;switch(L){case 1:n=.01;break;case 2:n=.03;break;case 3:n=.1}this.envMapBlurPassH.material.defines.BLUR_AMOUNT=this.envMapBlurPassV.material.defines.BLUR_AMOUNT=n.toFixed(4)}this.envMapBlurPassH.material.needsUpdate=this.envMapBlurPassV.material.needsUpdate=!0,this.render()}},x.setEnvMapBlurEnabled=function(e){B!=(B=e)&&this.updateEnvMapBlur()},x.setHemisphereLightIntensity=function(e){for(var t=0;t<this.lights.length;t++)this.lights[t]instanceof THREE.HemisphereLight&&(this.lights[t].intensity=e);v=e,this.render()},x.setHemisphereLightColorHex=function(e){this.hemiSphereLight&&(this.hemiSphereLight.color.setHex(e),this.hemiSphereLight.groundColor.setHex(e),this.render())},x.setHemisphereLightColorRGB=function(e,t,n){this.hemiSphereLight&&(this.hemiSphereLight.color.setRGB(e,t,n),this.hemiSphereLight.groundColor.setRGB(e,t,n),this.hemiSphereLight.color.getHex(),this.render())},x.setDirectionalLightIntensity=function(e){for(var t=0;t<this.lights.length;t++)this.lights[t]instanceof THREE.DirectionalLight&&(this.lights[t].intensity=e);c=e,this.render()},x.setDirectionalLightColorHex=function(e){this.drectionalLight&&(this.drectionalLight.color.setHex(e),this.render())},x.setDirectionalLightColorRGB=function(e,t,n){this.drectionalLight&&(this.drectionalLight.color.setRGB(e,t,n),this.drectionalLight.color.getHex(),this.render())},x.getBodyUuids=function(){return Object.keys(w.ndsModel.bodyUuid2NodeMap)},x.initModelUpDirection=function(e){if(void 0!==(Ue.modelUpDirection=e)){var t=new THREE.Matrix4,n=new THREE.Matrix4,i=new THREE.Matrix4;this.ndsModel.rootBodyNode.matrix&&t.fromArray(this.ndsModel.rootBodyNode.matrix);var r=this.modelRootObject.boundingBox.getCenter();switch(i.makeTranslation(-r.x,-r.y,-r.z),t.premultiply(i),n.premultiply(i),e){case"posx":i.makeRotationAxis(new THREE.Vector3(0,0,1),.5*Math.PI);break;case"negx":i.makeRotationAxis(new THREE.Vector3(0,0,1),.5*-Math.PI);break;case"posy":break;case"negy":i.makeRotationAxis(new THREE.Vector3(1,0,0),Math.PI);break;case"posz":i.makeRotationAxis(new THREE.Vector3(1,0,0),.5*-Math.PI);break;case"negz":i.makeRotationAxis(new THREE.Vector3(1,0,0),.5*Math.PI)}t.premultiply(i),n.premultiply(i),i.makeTranslation(r.x,r.y,r.z),t.premultiply(i),n.premultiply(i),this.ndsModel.ModelUpMatrix4=n.toArray(),this.ndsModel.updateNodeMatrix(this.ndsModel.rootBodyNode.uuid,t.toArray(),n)}},x.setModelUpDirection=function(e,t){this.cameraControl.setModelUpDirection(e,t)},x.hasLineGeometry=function(){var e=this.selectionManager.getTargetLineList();return e&&0<e.length},x.getviewState=function(){return this.renderMode},x.getfileguid=function(e){function t(e){return e.parent&&e.parent.fileguid?e.parent.fileguid:e.parent?t(e.parent):null}e=w.ndsModel.getBodyNodeFromUuid(e);return e?e.fileguid||t(e):null},x.setRenderMode=function(e,t){if(void 0!==e){this.renderMode=e;var n=A;switch(e){case"lighting":n=0;break;case"primarycolor":n=1;break;case"wireframe":n=2;break;case"whitemold":n=3;break;case"shadedWithEdges":n=4;break;case"shaded":n=5;break;case"hiddenLineRemove":n=6;break;case"hiddenLineVisible":n=7;break;default:n=this.is2DModel?(this.renderMode="shadedWithEdges",4):(this.renderMode="shaded",5)}if(n!=A){if(this.modelRootObject){switch(A){case 0:break;case 1:this.modelRootObject.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||void 0!==e.material.orginalSpecular&&(e.material.specular.copy(e.material.orginalSpecular),e.material.orginalSpecular=void 0,e.material.needsUpdate=!0)});break;case 2:var i=this.hasLineGeometry();this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments||(i?e.visible=!0:void 0!==e.material.wireframe&&(e.material.wireframe=!1,e.material.needsUpdate=!0)))});break;case 3:R=null;break;case 4:case 5:break;case 6:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.renderOrder=0:(e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!0,e.material.needsUpdate=!0)))});break;case 7:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.renderOrder=0,null!=e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)):(e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!0,e.material.needsUpdate=!0)))})}switch(n){case 0:break;case 1:this.scene.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||void 0!==e.material.specular&&(e.material.orginalSpecular=e.material.specular.clone(),e.material.specular.setRGB(0,0,0),e.material.needsUpdate=!0)});break;case 2:i=this.hasLineGeometry();this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.visible=!0,null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1)):i?e.visible=!1:void 0!==e.material.wireframe&&(e.material.wireframe=!0,e.material.needsUpdate=!0))});break;case 3:(R=new THREE.MeshPhongMaterial).side=THREE.DoubleSide,R.skinning=!0,R.color.setRGB(.65,.65,.65),R.specular.setRGB(.4,.4,.4),R.shininess=60;break;case 4:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.visible=!0,(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1))});break;case 5:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.visible=!1:e.visible=!0)});break;case 6:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.visible=!0,e.renderOrder=1e4,0==e.material.colorWrite&&(e.material=e.material.clone(),e.material.colorWrite=!0),null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1)):(e.visible=!0,e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!1,e.material.needsUpdate=!0)))});break;case 7:w.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(0==e.material.colorWrite&&(e.material=e.material.clone(),e.material.colorWrite=!0),e.material.oldOpacity=e.material.opacity,e.material.oldDepthFunc=e.material.depthFunc,e.material.oldTransparent=e.material.transparent,e.material.needsUpdate=!0,e.renderOrder=1e4,e.visible=!0,null!=e.tangentEdgeObject&&0==Ue.tangentEdgeVisible&&(e.visible=!1)):(e.visible=!0,e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!1,e.material.needsUpdate=!0)))})}}null!=this.modelSceneOrgin&&this.modelSceneOrgin!=this.scene&&(this.modelSceneOrgin.overrideMaterial=this.scene.overrideMaterial),A=n,!1!==t&&this.render()}}},x.setBackGroundColor=function(e){if(this.setBackGroundImage(null),this.setEnvMapTextures(null),this.exchangeBackImage={type:"Color",value:e},null==this.clearColor||this.clearColor!==e){this.clearColor=e;var t=(new THREE.Color).setHex(parseInt(e));if(this.renderer.setClearColor(parseInt(e),!0),this.ndsModel&&this.is2DModel)if(2<=this.modelContentVersion){var n=new THREE.Color(1,1,1),i=new THREE.Color(0,0,0);if(t.equals(i)){for(var r in w.ndsModel.meshManager.materials){var o=w.ndsModel.meshManager.materials[r].mat;"ShaderMaterial"!=o.type&&o.color.equals(i)?o.color.copy(n):"ShaderMaterial"==o.type&&o.uniforms.diffuse.value.equals(i)&&(o.color&&o.color.copy(n),o.uniforms.diffuse.value.copy(n))}for(var a=0,s=w.ndsModel.meshManager.mats.length;a<s;++a){var l=w.ndsModel.meshManager.mats[a];l&&("ShaderMaterial"!=l.type&&l.color.equals(i)?l.color.copy(n):"ShaderMaterial"==l.type&&l.uniforms.diffuse.value.equals(i)&&(l.color&&l.color.copy(n),l.uniforms.diffuse.value.copy(n)))}}else{for(var r in w.ndsModel.meshManager.materials){var d=w.ndsModel.meshManager.materials[r].mat;"ShaderMaterial"!=d.type&&d.color.equals(n)?d.color.copy(i):"ShaderMaterial"==d.type&&d.uniforms.diffuse.value.equals(n)&&(d.color&&d.color.copy(i),d.uniforms.diffuse.value.copy(i))}for(var c=0,h=w.ndsModel.meshManager.mats.length;c<h;++c){var u=w.ndsModel.meshManager.mats[c];u&&("ShaderMaterial"!=u.type&&u.color.equals(n)?u.color.copy(i):"ShaderMaterial"==u.type&&u.uniforms.diffuse.value.equals(n)&&(u.color&&u.color.copy(i),u.uniforms.diffuse.value.copy(i)))}}w.lineTypes&&w.lineTypes.setBackGroundColor(t.equals(i)?t:n)}else if(this.renderer.getClearColor().equals(new THREE.Color(0,0,0))){for(var r in w.ndsModel.meshManager.materials)w.ndsModel.meshManager.materials[r].mat.color.equals(new THREE.Color(0,0,0))&&("ShaderMaterial"!=w.ndsModel.meshManager.materials[r].mat.type?w.ndsModel.meshManager.materials[r].mat.color.setRGB(1,1,1):"ShaderMaterial"==w.ndsModel.meshManager.materials[r].mat.type&&(w.ndsModel.meshManager.materials[r].mat.color.setRGB(1,1,1),w.ndsModel.meshManager.materials[r].mat.uniforms.diffuse.value.setRGB(1,1,1)));if(w.pmiObject){if(g=this.pmiObject.getObjectByName("TextGroup"))for(var f=0;f<g.children.length;++f){for(var p=g.children[f].geometry.attributes.position.data,m=0;m<p.count;++m)0==p.array[m*p.stride+3]&&0==p.array[m*p.stride+4]&&0==p.array[m*p.stride+5]&&(p.array[m*p.stride+3]=1,p.array[m*p.stride+4]=1,p.array[m*p.stride+5]=1);p.version++,p.updateRange.count=p.count}this.pmiObject.traverse(function(e){"LineSegments"==e.type&&e.material.color.equals(new THREE.Color(0,0,0))&&e.material.color.setRGB(1,1,1)})}w.lineTypes&&w.lineTypes.setBackGroundColor(t)}else{for(var r in w.ndsModel.meshManager.materials)w.ndsModel.meshManager.materials[r].mat.color.equals(new THREE.Color(1,1,1))&&("ShaderMaterial"!=w.ndsModel.meshManager.materials[r].mat.type?w.ndsModel.meshManager.materials[r].mat.color.setRGB(0,0,0):"ShaderMaterial"==w.ndsModel.meshManager.materials[r].mat.type&&(w.ndsModel.meshManager.materials[r].mat.color.setRGB(0,0,0),w.ndsModel.meshManager.materials[r].mat.uniforms.diffuse.value.setRGB(0,0,0)));if(this.pmiObject){for(var g=this.pmiObject.getObjectByName("TextGroup"),f=0;f<g.children.length;++f){for(p=g.children[f].geometry.attributes.position.data,m=0;m<p.count;++m)1==p.array[m*p.stride+3]&&1==p.array[m*p.stride+4]&&1==p.array[m*p.stride+5]&&(p.array[m*p.stride+3]=0,p.array[m*p.stride+4]=0,p.array[m*p.stride+5]=0);p.version++,p.updateRange.count=p.count}this.pmiObject.traverse(function(e){"LineSegments"==e.type&&e.material.color.equals(new THREE.Color(1,1,1))&&e.material.color.setRGB(0,0,0)})}w.lineTypes&&w.lineTypes.setBackGroundColor(t)}e="#"+w.renderer.getClearColor().getHexString();this.container.style.backgroundColor=e,this.render()}},x.getMaterialsInfo=function(){if(w.materialsSetting)return w.materialsSetting.getMaterialsInfo()},x.getRenderMode=function(){return A},x.getMapList=function(){if(w.materialsSetting)return w.materialsSetting.getMapList()},x.removeMap=function(e,t){if(w.materialsSetting)return w.materialsSetting.removeMap(e,t,A)},x.isMapWorking=function(e){if(w.materialsSetting)return w.materialsSetting.isMapWorking(e)},x.removeObjectMaterial=function(e){w.materialsSetting.removeObjectMaterial(e)},x.getObjectMaterialInfo=function(e){return w.materialsSetting.getObjectMaterialInfo(e)},x.updateMaterialInfo=function(e,t){w.materialsSetting&&null!=e&&(w.materialsSetting.updateMaterialInfo(e,A,t),this.render())},x.updateAllMateriaslInfo=function(e,t){w.materialsSetting&&w.materialsSetting.updateAllMateriaslInfo(e,A,t)},x.autoSetBodyNodeMaterial=function(e){w.materialsSetting&&w.materialsSetting.autoSetBodyNodeMaterial(e||w.ndsModel.rootBodyNode.uuid)},x.getBodyNodeMaterialsInfo=function(){return w.ndsModel.getBodyNodeUUidToMaterial()},x.setBodyNodeMaterialsInfo=function(e){if(e){for(var t in w.bodyNodeUUidToMaterial){var n=w.bodyNodeUUidToMaterial[t],n=w.materialsSetting.jsonToMaterial(n);n&&(w.bodyNodeUUidToMaterial[t]=n)}w.ndsModel.setBodyNodeMaterials(w.bodyNodeUUidToMaterial)}},x.convertMaterialInfo=function(e,t){if(w.materialsSetting){var n=w.materialsSetting.convertMaterialInfo(e,t,A);if(n.matJson&&n.matObj){if(this.traverseAndReplaceMaterialMeshes(this.scene,n.matObj),this.animationsManager){var i=this.animationsManager.getAllAnimationScenes();if(i)for(var r=0;r<i.length;++r)this.traverseAndReplaceMaterialMeshes(i[r],n.matObj);this.animationsManager.setMaterialsUpdated(!0)}return this.modelSceneOrgin&&this.scene!=this.modelSceneOrgin&&this.traverseAndReplaceMaterialMeshes(this.modelSceneOrgin,n.matObj),this.render(),n.matJson}}},x.convertAllMaterialsInfo=function(e,t){if(w.materialsSetting){for(var n={materials:[]},i=!1,r=0,o=e.materials.length;r<o;++r){var a=w.materialsSetting.convertMaterialInfo(e.materials[r],t,A);if(a.matJson&&a.matObj){if(i=!0,n.materials.push(a.matJson),this.traverseAndReplaceMaterialMeshes(this.scene,a.matObj),this.animationsManager){var s=this.animationsManager.getAllAnimationScenes();if(s)for(var l=0;l<s.length;++l)this.traverseAndReplaceMaterialMeshes(s[l],a.matObj);this.animationsManager.setMaterialsUpdated(!0)}this.modelSceneOrgin&&this.scene!=this.modelSceneOrgin&&this.traverseAndReplaceMaterialMeshes(this.modelSceneOrgin,a.matObj)}else n.materials.push(e.materials[r])}return i&&(this.scene.overrideMaterial&&(this.scene.overrideMaterial.needsUpdate=!0),R&&(R.needsUpdate=!0),this.render()),n}},x.traverseAndReplaceMaterialMeshes=function(e,t){if(null!=e&&e instanceof THREE.Object3D&&!(e instanceof THREE.Light)&&(e.hasOwnProperty("geometry")&&e.material&&e.material.uuid==t.uuid&&(e.material=t,e.geometry instanceof THREE.BufferGeometry&&null!=e.geometry.attributes.color&&(e.material.vertexColors=THREE.VertexColors)),null!=e.children))for(var n=e.children,i=0,r=n.length;i<r;++i)this.traverseAndReplaceMaterialMeshes(n[i],t)},x.traverseMaterialMeshes=function(e,t,n,i){var r,o,a,s,l;if(null!=e&&(e instanceof THREE.Object3D&&!(e instanceof THREE.Light)))if(e.hasOwnProperty("geometry"))e.material&&e.material.uuid==i.uuid&&(r=!1,(l=e.geometry)instanceof THREE.Geometry?r=null!=l.vertices&&0!=l.vertices.count:l instanceof THREE.BufferGeometry&&(r=null!=e.geometry.attributes.position),(r||l.boundingBox)&&(null==l.boundingBox&&l.computeBoundingBox(),isFinite(l.boundingBox.min.x)&&(o=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),a=new Float32Array(24),(s=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(o,1)),s.addAttribute("position",new THREE.BufferAttribute(a,3)),r=new THREE.LineSegments(s,n),o=l.boundingBox.min,a=l.boundingBox.max,(l=(s=r.geometry.attributes.position).array)[0]=a.x,l[1]=a.y,l[2]=a.z,l[3]=o.x,l[4]=a.y,l[5]=a.z,l[6]=o.x,l[7]=o.y,l[8]=a.z,l[9]=a.x,l[10]=o.y,l[11]=a.z,l[12]=a.x,l[13]=a.y,l[14]=o.z,l[15]=o.x,l[16]=a.y,l[17]=o.z,l[18]=o.x,l[19]=o.y,l[20]=o.z,l[21]=a.x,l[22]=o.y,l[23]=o.z,s.needsUpdate=!0,r.geometry.computeBoundingSphere(),e.add(r),r.updateMatrixWorld(!0),t.push({parent:e,marker:r}))));else if(null!=e.children)for(var d=e.children,c=0,h=d.length;c<h;++c)this.traverseMaterialMeshes(d[c],t,n,i)},x.showMaterialMarkers=function(e,t,n){var i;w.materialsSetting&&null!=e&&(w.materialsSetting.cleanMaterialsMarkers(),"LineBasicMaterial"!=e.type&&(i=new THREE.LineBasicMaterial({color:16776960}),t&&i.color.setHex(t),n&&(i.lineWidth=n),this.traverseMaterialMeshes(this.scene,n=[],i,e),w.materialsSetting.setMaterialsMarkers(n),w.materialsSetting.setMaterialsMarkersMat(i)),this.render())},x.cleanMaterialMarkers=function(){w.materialsSetting&&(w.materialsSetting.cleanMaterialsMarkers(),this.render())},x.saveTextForPDF=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;this.printPDF||(this.printPDF=new nn(this)),this.printPDF.saveTextForPDF(e,t)},x.getPrintDataCallback=function(n,i,r,o,a,s,l){this.printPDF||(this.printPDF=new nn(this)),this.renderNew();function d(e){var t=e.userData.precent,e=w.ndsModel.getLineSegmentsSet();t<.99||4===A&&e.dirty||(w.removeEventListener("updateProgress",d),c.printPDF.setPDFInfo(i,r,o,a,s,l),e=c.printPDF.sendFile(),c.printPDF.clearArray(),n&&n(e))}var c=this;w.addEventListener("updateProgress",d,!1)},x.getPrintData=function(e,t,n,i,r,o){console.warn("getPrintData has been discard,use getPrintDataCallback"),this.printPDF||(this.printPDF=new nn(this)),this.printPDF.setPDFInfo(e,t,n,i,r,o);o=this.printPDF.sendFile();return this.printPDF.clearArray(),o},x.getUnitScale=function(e){var t=1;return"millimeter"==e||"mm"==e?"centimeter"==this.modelUnit?t=10:"meter"==this.modelUnit?t=1e3:"inch"==this.modelUnit?t=25.4:"feet"==this.modelUnit&&(t=304.8):"centimeter"==e||"cm"==e?"millimeter"==this.modelUnit?t=.1:"meter"==this.modelUnit?t=100:"inch"==this.modelUnit?t=2.54:"feet"==this.modelUnit&&(t=30.48):"meter"==e||"m"==e?"millimeter"==this.modelUnit?t=.001:"centimeter"==this.modelUnit?t=.01:"inch"==this.modelUnit?t=.0254:"feet"==this.modelUnit&&(t=.3048):"inch"==e||"in"==e?"millimeter"==this.modelUnit?t=1/25.4:"centimeter"==this.modelUnit?t=10/25.4:"meter"==this.modelUnit?t=1e3/25.4:"feet"==this.modelUnit&&(t=12):"feet"!=e&&"ft"!=e||("millimeter"==this.modelUnit?t=1/304.8:"centimeter"==this.modelUnit?t=10/304.8:"meter"==this.modelUnit?t=1e3/304.8:"inch"==this.modelUnit&&(t=1/12)),t},x.getDispalyModelUnit=function(e,t){var n={unit:this.userModelUnit||this.modelUnit,scale:this.getUnitScale(this.userModelUnit||this.modelUnit)};return this.userModelUnit||(e<1||t&&t<1?"meter"==this.modelUnit?(n.unit="millimeter",n.scale=1e3):"feet"==this.modelUnit&&(n.unit="inch",n.scale=12):"centimeter"==this.modelUnit&&10<e&&Ue.inBIMContext?(n.unit="meter",n.scale=.01):"millimeter"==this.modelUnit&&100<e&&Ue.inBIMContext&&(n.unit="meter",n.scale=.001)),n},x.getModelUnit=function(){return this.modelUnit},x.setDispalyModelUnit=function(e){this.userModelUnit="millimeter"==e||"mm"==e?"millimeter":"centimeter"==e||"cm"==e?"centimeter":"meter"==e||"m"==e?"meter":"inch"==e||"in"==e?"inch":"feet"==e||"ft"==e?"feet":null,w.dispatchEvent({type:"broadcastEvent"})},x.setAnnotationMode=function(e){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.setAnnotationMode(e)},x.getAnnotationMode=function(){return w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.getAnnotationMode()},x.resetSelectAnnotation=function(){w.annotationsManager&&w.annotationsManager.resetSelectAnnotation()},x.setLineSegAnnotationStyle=function(e){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.setLineSegAnnotationStyle(e)},x.getLineSegAnnotationStyle=function(){return w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.getLineSegAnnotationStyle()},x.selectAnnotation=function(e){w.annotationsManager&&(w.annotationsManager.selectAnnotation(e),w.render())},x.addAnnotation=function(e,t){w.annotationsManager||(w.annotationsManager=new je(w));var n;w.ndsModel&&(!!((n=w.ndsModel.fileguidTouuid[e.fileguid])&&0<n.length)&&e.bOnModel&&e.rootfileguid!=w.ndsModel.rootBodyNode.fileguid&&e.fileguid?w.annotationsManager.addAnnotation(e,null,!0):(e.rootfileguid!=w.ndsModel.rootBodyNode.fileguid&&(e.other=!0),w.annotationsManager.addAnnotation(e))),0!=t&&w.render()},x.addAnnotationSave=function(e){this.CorrectPosition(e),e.state&&this.addAnnotation(e.state)},x.CorrectPosition=function(t){var e,n;w.ndsModel&&t.state.rootfileguid&&(e=w.ndsModel.explodeFactor,w.ndsModel&&(n=w.controls.getBoundingBox().getCenter(),w.ndsModel.setExplodeFactor(n,0)),t.state.rootfileguid!=w.ndsModel.rootBodyNode.fileguid&&t.state.bOnModel&&t.state.fileguid&&(w.getposFromFileGuid(t.state,t,!0),t.list&&t.list.forEach(function(e){w.getposFromFileGuid(t.state,e,!0),e.points&&e.points.forEach(function(e){w.getposFromFileGuid(t.state,e,!0)})})),w.ndsModel&&(n=w.controls.getBoundingBox().getCenter(),w.ndsModel.setExplodeFactor(n,e)))},x.getposFromFileGuid=function(e,t,n){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.getposFromFileGuid(e,t,n)},x.addAnnotations=function(e,t){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.addAnnotations(e),0!=t&&w.render()},x.setAnnotationsVisibility=function(e){w.annotationsManager&&w.annotationsManager.setAnnotationsVisibility(e)},x.setAnnotationType=function(e,t){w.annotationsManager&&w.annotationsManager.setAnnotationType(e,t)},x.setAnnotationsVisibilityByUuid=function(e,t){w.annotationsManager&&w.annotationsManager.setAnnotationsVisibilityByUuid(e,t)},x.showAnnotation=function(e,t,n){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.addAnnotation(e,t),0!=n&&w.render()},x.showAnnotations=function(e,t){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.addAnnotations(e),0!=t&&w.render()},x.removeAnnotation=function(e,t){w.annotationsManager&&(w.annotationsManager.removeAnnotation(e),0!=t&&w.render())},x.removeAnnotations=function(e,t){if(w.annotationsManager){for(var n=0,i=e.length;n<i;++n)w.annotationsManager.removeAnnotation(e[n]);0!=t&&w.render()}},x.removeAllAnnotations=function(e){w.annotationsManager&&(w.annotationsManager.removeAllAnnotations(),0!=e&&w.render())},x.listenAnnotation=function(e){w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.listenAnnotation(e)},x.getHotPoint=function(e,t){return w.annotationsManager||(w.annotationsManager=new je(w)),w.annotationsManager.getHotPoint(e,t)},x.setOperator=function(e){e&&(w.controls.setOperator(e),w.controls.addEventListener("change",w.render),w.onOpChanged({id:e.type}))},x.setOperatorByID=function(e){switch(e){case"OpOrbit":w.controls.setOperator(new dt(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpOrbit"});break;case"OpPan":w.controls.setOperator(new ct(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpPan"});break;case"OpZoom":w.controls.setOperator(new ht(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpZoom"});break;case"OpZoomWindow":w.controls.setOperator(new ut(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpZoomWindow"});break;case"OpSelect":case"OpSectionView":break;case"OpDrag":w.controls.setOperator(new We(w)),w.onOpChanged({id:"OpDrag"});break;case"OpAnnotation":w.controls.setOperator(new Bt(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpAnnotation"});break;case"OpMeasure":w.controls.setOperator(new lt(w)),w.controls.addEventListener("change",w.render),w.onOpChanged({id:"OpMeasure"})}},x.getCurrentOperatorID=function(){return w.controls.getOperator().type},x.getCurrentOperatorState=function(){return w.controls.getOperator().state},x.getCurrentMeasureType=function(){return"OpMeasure"==w.controls.getOperator().type?w.controls.getOperator().measureType:null},x.onFitToView=function(){w.zoomExtents()},x.onResetCamera=function(){w.resetCamera({useOrginal:!0})},x.onExplode=function(e){w.explodeModel(e)},x.onFullScreen=function(){w.executeFullScreen()},x.onLineVisibility=function(e){w.setLinesVisibility(e)},x.isClipTransformControlSelected=function(){var e=w.clipPlaneManager.isClipTransformControlSelected(),t=w.clipBoxManager.isClipTransformControlSelected();return 0<w.renderer.clippingPlanes.length&&e||t},x.isLightEditControlSelected=function(){return!(null==w.lightControls||!w.lightControls.getVisible())&&w.lightControls.isLightEditControlSelected()},x.onLightEditor=function(){null==w.lightControls||w.lightControls.getVisible()?null!=w.lightControls&&w.lightControls.getVisible()&&w.lightControls.setVisible(!1):w.lightControls.setVisible(!0)},x.onModelBrowser=function(){this.modelBrowserDlg||(this.modelBrowserDlg=new ue(this)),this.modelBrowserDlg.show("模型结构")},x.onBoxSectionView=function(e,t){this.clipBoxManager&&this.clipBoxManager.onBoxSectionView(e)},x.onSectionView=function(e,t){w.clipPlaneManager.onSectionView(e,t)},x.setActiveSectionPlane=function(e){w.clipPlaneManager&&w.clipPlaneManager.setActiveSectionPlane(e.toUpperCase())},x.setSectionImageFlag=function(e){w.clipPlaneManager.showSectionImage=e},x.deleteSectionPlane=function(e){w.clipPlaneManager&&w.clipPlaneManager.deleteSectionPlane(e.toUpperCase())},x.addSectionPlane=function(e){w.clipPlaneManager&&w.clipPlaneManager.addSectionPlane(e.toUpperCase())},x.isSectionViewEnabled=function(){return w.clipPlaneManager.isSectionViewEnabled()},x.isSectionBoxViewEnabled=function(){return w.clipBoxManager.isSectionBoxEnabled()},x.getClipPlaneInfo=function(){return w.clipPlaneManager.getClipPlaneInfor()},x.getBoxClipInfo=function(){return w.clipBoxManager.getBoxClipInfo()},x.setClipPlaneInfor=function(e){w.clipPlaneManager.setClipPlaneInfor(e)},x.showSectionImage=function(e){w.clipPlaneManager.showSectionImage=e},x.onSelectAndMoveModel=function(e){"OpDrag"==w.controls.getOperator().type&&(e?w.controls.getOperator().setMoveMode():w.controls.getOperator().setDefaultMode())},x.isModelMoved=function(){var t=!1;return w.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&null!=e.matrixWorldTransOrginalDrag&&(t=!0)}),t},x.onSelectAndRestoreModel=function(e){"OpDrag"==w.controls.getOperator().type&&(e?w.controls.getOperator().setRestoreMode():w.controls.getOperator().setDefaultMode())},x.restoreAllDraggedObjects=function(e){if(null!=w.draggedObjects){for(var t=0,n=w.draggedObjects.length;t<n;++t){var i=w.draggedObjects[t];w.ndsModel.restoreDraggedBody(i)}w.draggedObjects=void 0,w.selectionManager.clearSelection(),null!=e&&1!=e||w.render()}},x.onHideModel=function(){"OpDrag"==w.controls.getOperator().type&&w.controls.getOperator().hideSelectedModel()},x.onReverseVisibleAndHidingModel=function(){"OpDrag"==w.controls.getOperator().type&&w.controls.getOperator().reverseVisibleAndHidingModel()},x.onShowAllModel=function(){"OpDrag"==w.controls.getOperator().type&&w.controls.getOperator().showAllModel()},x.setMeasureOpType=function(e){"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().setMeasureType(e)},x.setMeasuringScale=function(e){this.is2DModel&&(this.measuringScale=e,"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().setMeasureScale(e))},x.getMeasuringScale=function(){return this.measuringScale},x.onMoveForward=function(){var e=w.controls.getOperator();null!=e&&e.moveForwardBack(!0,!0)},x.onMoveBack=function(){var e=w.controls.getOperator();null!=e&&e.moveForwardBack(!1,!0)},x.onMoveLeft=function(){var e=w.controls.getOperator();null!=e&&e.pan(new THREE.Vector3(-20,0,0),!0)},x.onMoveRight=function(){var e=w.controls.getOperator();null!=e&&e.pan(new THREE.Vector3(20,0,0),!0)},x.startAnimationByUUID=function(e,t){var n;w.animationsManager&&(w.toggleAutoRotation(!1),w.animationsManager.startSolidAnimationByUUID(e,t),t&&(null==w.modelSceneOrgin&&(w.modelSceneOrgin=w.scene),null==w.modelRootObjectOrgin&&(w.modelRootObjectOrgin=w.modelRootObject),w.ndsModelBackup=w.ndsModel,w.ndsModel=null,(n=w.animationsManager.getCurrentAnimationScene())&&n!=w.scene&&(n.add(w.ambientLight),n.add(w.lightControls._scene),w.scene=n,w.modelRootObject=w.scene.children[0],w.modelRootObject.rotation.copy(w.modelRootObjectOrgin.rotation),w.modelRootObject.updateMatrix(),n.updateMatrixWorld(!0),w.showLineObjects(n,w.getLinesVisibility()),n.overrideMaterial=w.modelSceneOrgin.overrideMaterial,n.overrideMaterial&&(n.overrideMaterial.needsUpdate=!0),R&&(R.needsUpdate=!0)),w.animationsManager.isMaterialsUpdated()&&this.scene.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||(e.material.needsUpdate=!0)}),w.annotationsManager&&w.annotationsManager.hideAllAnnotations(w.animationsManager.getCurrentAnimationUuid())),w.animationsManager.bHasSkeletonAnimation&&(w.animationsManager.initSkeletonAnimation(),w.animationsManager.startSkeletonAnimationByUUID(e,t)),w.animationsManager.bHasMorph&&(w.animationsManager.initMorphAnimations(),w.animationsManager.startMorphAnimationByUUID(e,t)),w.runAnimation())},x.getAnimationLoopModeByUUID=function(e){return this.animationsManager?this.animationsManager.getAnimationLoopModeByUUID(e):null},x.setAnimationLoopModeByUUID=function(e,t){this.animationsManager&&this.animationsManager.setAnimationLoopModeByUUID(e,t)},x.setAnimationTimeByUUID=function(e,t){this.animationsManager&&this.animationsManager.setAnimationTimeByUUID(e,t)},x.getAnimationScaleByUUID=function(e){return this.animationsManager?this.animationsManager.getAnimationScaleByUUID(e):null},x.setAnimationScaleByUUID=function(e,t){this.animationsManager&&this.animationsManager.setAnimationScaleByUUID(e,t)},x.getAllAnimationsInfo=function(){return this.animationsManager?this.animationsManager.getAllAnimationsInfo():null},x.getAnimationInfoByUUID=function(e){return this.animationsManager?this.animationsManager.getAnimationInfoByUUID(e):null},x.hasAnimations=function(){return!!this.animationsManager&&this.animationsManager.hasAnimations()},x.runAnimation=function(){var e,t;w.animationsManager&&(w.animationsManager.isAnimationsExited()||(requestAnimationFrame(function(){w.runAnimation()}),t=!1,w.animationsManager&&(t=w.animationsManager.update())&&(w.dispatchEvent({type:"animationFrame",time:w.animationsManager.getCurrentAnimationTime()}),w.modelRootObject.traverse(function(e){e.updateMatrix()}),w.modelRootObject.updateMatrixWorld(!0)),t&&(_&&(e=new THREE.Vector3,t=new THREE.Vector3,w.computeBoundingBox(w.scene,e,t,{flag:!0}),w.groundShadow.updateGroundTransform(w.camera,new THREE.Box3(e,t),w.camera.worldup)),this.render(),w.animationsManager&&w.animationsManager.getAnimationFinishedFlag()&&w.dispatchEvent({type:"animationFinished"}))))},x.exitAnimations=function(){var e;w.animationsManager&&(w.animationsManager.exitAnimations(),this.modelRootObject.traverse(function(e){e.updateMatrix()}),this.modelRootObject.updateMatrixWorld(!0),null!=w.modelSceneOrgin&&w.scene!=w.modelSceneOrgin&&(w.ndsModel=w.ndsModelBackup,w.showLineObjects(w.modelSceneOrgin,w.getLinesVisibility()),w.scene=w.modelSceneOrgin,w.scene.add(w.ambientLight),w.scene.add(w.lightControls._scene),w.scene.overrideMaterial&&(w.scene.overrideMaterial.needsUpdate=!0),R&&(R.needsUpdate=!0)),null!=w.modelRootObjectOrgin&&(w.modelRootObject=w.modelRootObjectOrgin),w.animationsManager.isMaterialsUpdated()&&this.scene.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||(e.material.needsUpdate=!0)}),w.annotationsManager&&(w.annotationsManager.restoreAllAnnotations(),w.annotationsManager.setAnnotationsVisiblilityForAnimation(!1)),e=k,k=-1,this.explodeModel(e),w.toggleAutoRotation(),1==w.animationsManager.getAnimationsExitCount()&&U&&w.toggleAutoRotation(!0))},x.setModelOperationModeInternal=function(e){G=e,w.clearCenterCross()},x.setModelOperationMode=function(e,t){G!=(G=e)&&"hall"==G&&V&&(this.scene.updateMatrixWorld(!0),this.controls.SetBoundingBoxUpdated(!1),this.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))}),null!=w.modelSceneOrgin&&w.modelSceneOrgin!=this.scene&&(w.modelSceneOrgin.updateMatrixWorld(!0),w.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))})),this.cameraControl.onOperationModeChange(t)),w.clearCenterCross(),"FirstPerson"==G&&w.drawCenterCross()},x.hasBodyRepeat=function(){if(w.ndsModel&&!w.is2DModel)for(var e=0,t=w.ndsModel.meshManager.getNumInstancedMeshes();e<t;++e){var n=w.ndsModel.meshManager.instancedMeshIds[e],i=w.ndsModel.meshManager.geomManager.getGeomFromId(w.ndsModel.meshManager.geomId[n]),n=i.refMeshes[0],r=w.ndsModel.meshManager.getBodyNode(n),o=w.ndsModel.meshManager.matrixId?w.ndsModel.meshManager.matrixId[n]:-1;n=i.refMeshes[1];i=w.ndsModel.meshManager.getBodyNode(n);if(o===(w.ndsModel.meshManager.matrixId?w.ndsModel.meshManager.matrixId[n]:-1)&&r.worldMatrix.equals(i.worldMatrix))return!0}return!1},x.getModelOperationMode=function(e){return G},x.setModelOperationVerticalRotationRange=function(e,t){null!=t&&null!=e&&(null!=W?W.set(e,t):W=new THREE.Vector2(e,t),"hall"==G&&V&&(e=this.camera.position.clone().sub(this.camera.getCameraTarget()).angleTo(THREE.Object3D.DefaultUp),t=.5*Math.PI-e>=Math.abs(W.y)*Math.PI/180,e=0<e-.5*Math.PI&&e-.5*Math.PI>=Math.abs(W.x)*Math.PI/180,(t||e)&&(this.scene.updateMatrixWorld(!0),this.controls.SetBoundingBoxUpdated(!1),this.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))}),null!=w.modelSceneOrgin&&w.modelSceneOrgin!=this.scene&&(w.modelSceneOrgin.updateMatrixWorld(!0),w.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0))})),this.camera.setOrginalCameraInfo(void 0),this.camera.up.set(0,1,0),e=new THREE.Matrix4,Math.abs(W.y)<4.5?e.lookAt(new THREE.Vector3(1,0,1),new THREE.Vector3,this.camera.up):e.lookAt(new THREE.Vector3(1,.1,1),new THREE.Vector3,this.camera.up),this.camera.quaternion.setFromRotationMatrix(e),this.resetCamera({useOrginal:!0}))))},x.getModelOperationVerticalRotationRange=function(){return W},x.isLineExisted=function(){var t=!1;return this.scene.traverse(function(e){(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(w.materialsSetting&&w.materialsSetting.getMaterialsMarkersMat()==e.material||(t=!0))}),t},x.isModelExplosionAbled=function(){void 0===THREE.Object3D.prototype.tranverseWithCondition&&(THREE.Object3D.prototype.tranverseWithCondition=function(e){if(!e(this))for(var t=this.children,n=0,i=t.length;n<i;n++)"lightctrls"!=t[n].name&&t[n].tranverseWithCondition(e)});var t=0;return this.scene.tranverseWithCondition(function(e){return w.isObjectTypeOfElement(e)?(++t,!0):(e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||++t,!1)}),1<t},x.getExplodeFactor=function(){return k},x.setExplodeFactor=function(e){k=e},x.getExplodeMode=function(){return this.ndsModel.explodeMode},x.getExplodeLevel=function(){return this.ndsModel.explodeLevel},x.getBroadcastInfo=function(){return w.broadcastManager.getBroadcastInfo()},x.setToolbarVisibility=function(e){w.Optoolbar&&w.Optoolbar.setVisibility(e)},x.getToolbarVisibility=function(){return!!w.Optoolbar&&w.Optoolbar.getVisibility()},x.startBroadcast=function(e){w.broadcastManager.startBroadcast(e)},x.exitBroadcast=function(){w.broadcastManager.exitBroadcast()},x.setBroadcastInfo=function(e){w.broadcastManager.setBroadcastInfo(e)},x.getIntersectionPtByScreenPt=function(e,t){w.rayCaster||(w.rayCaster=new qt(this));var n,i=null;return w.ndsModel?(n=w.selectionManager.getPickIntersects(e[0],e[1]))&&0<n.length&&(i={coords:[n[0].point.x,n[0].point.y,n[0].point.z],locationObjectUUID:n[0].bodyNode.uuid,locationObject:n[0].bodyNode}):i=w.rayCaster.convertPointScreen(e,t),i},x.clientCoordToModelCoord=function(e){var t=w.renderer.getPixelRatio(),n=w.renderer.domElement;3==e.length?r=e[2]:(i=new THREE.Vector3,w.controls.getBoundingBox().getCenter(i),i.project(w.camera),(r=i.z)<-1&&(r=-.99));var i=new THREE.Vector3;i.set(e[0]*t/n.width*2-1,2*-(e[1]*t/n.height)+1,r),i.unproject(w.camera);var r=[];return r[0]=i.x,r[1]=i.y,r[2]=i.z,r},x.modelCoordToClientCoord=function(e){var t=w.renderer.getPixelRatio(),n=w.renderer.domElement,i=n.width/2,n=n.height/2,e=new THREE.Vector3(e[0],e[1],e[2]);e.project(w.camera);i=(e.x*i+i)/t,n=(-e.y*n+n)/t,t=[];return t[0]=Math.round(i),t[1]=Math.round(n),t[2]=e.z,t},x.computeModelScreenBBox=function(){var e=w.controls.getBoundingBox(),t=e.min,n=e.max,i=[],e=t.clone();i.push(e),(e=t.clone()).set(n.x,t.y,t.z),i.push(e),(e=t.clone()).set(n.x,n.y,t.z),i.push(e),(e=t.clone()).set(t.x,n.y,t.z),i.push(e),(e=t.clone()).set(t.x,t.y,n.z),i.push(e),(e=t.clone()).set(n.x,t.y,n.z),i.push(e),(e=t.clone()).set(n.x,n.y,n.z),i.push(e),(e=t.clone()).set(t.x,n.y,n.z),i.push(e);for(var r=new THREE.Vector2,o=new THREE.Vector2,a=0;a<i.length;a++){var s=[];s[0]=i[a].x,s[1]=i[a].y,s[2]=i[a].z;s=w.modelCoordToClientCoord(s);0==a?(r.x=s[0],r.y=s[1],o.x=s[0],o.y=s[1]):(r.x=Math.min(r.x,s[0]),r.y=Math.min(r.y,s[1]),o.x=Math.max(o.x,s[0]),o.y=Math.max(o.y,s[1]))}return{min:r,max:o}},x.createScaledSphere=function(e,t){var n=new THREE.Mesh(new THREE.SphereBufferGeometry(1,24,24),new THREE.MeshBasicMaterial({color:16776960}));return n.cameraScale=.005,t&&(null!=t.color&&n.material.color.setHex(t.color),null!=t.scale&&(n.cameraScale=t.scale)),n.name="scaledSphere",n.position.set(e[0],e[1],e[2]),this.additionalObjectsScene&&this.additionalObjectsScene.add(n),this.render(),{uuid:n.uuid}},x.updateAdditionalObjectsScene=function(){this.additionalObjectsScene&&this.additionalObjectsScene.traverse(function(e){var t;"scaledSphere"==e.name&&(t=e.position.distanceTo(w.camera.position)*e.cameraScale,e.scale.set(t,t,t))})},x.setObjectVisibilityByUuid=function(e,t){!this.additionalObjectsScene||(e=this.additionalObjectsScene.getObjectByProperty("uuid",e))&&(e.visible=t,this.render())},x.removeObjectByUuid=function(e){var t,n=!1;if(w.additionalObjectsScene&&(t=w.additionalObjectsScene.getObjectByProperty("uuid",e))&&(t.parent.remove(t),n=!0,w.render()),!n)if(w.ndsModel){var i=w.ndsModel.getBodyNodeFromUuid(e);i&&(w.selectionManager.isObjectSelected(i)&&w.selectionManager.deselectObject(i),w.ndsModel.delete(i),w.render())}else if(t=w.scene.getObjectByProperty("uuid",e)){t.parent.remove(t),n=!0,t==w.modelRootObject&&(w.modelRootObject=null),w.selectionManager.computeTargetList(w.scene);var r=[];if(!function e(t,n){var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.material)n.push(t);else for(var r=0,o=i.length;r<o;++r)e(i[r],n)}(t,r),0<r.length)for(var o=0;o<r.length;o++)for(var a=0;a<w.originalMeshes.length;a++)if(w.originalMeshes[a].key==r[o]){w.originalMeshes[a]=null,w.originalMeshes.splice(a,1);break}w.render()}n&&w.controls.SetBoundingBoxUpdated(!1)},x.createPlaneByWorldPoints=function(e,t,n,i){if(!t){if(null==i)return null;if(i.length<9)return null}var r,o=w.controls.getBoundingBox().min,a=w.controls.getBoundingBox().max.distanceTo(o),s=new THREE.Plane,l=new THREE.Vector3(i[0],i[1],i[2]),o=new THREE.Vector3(i[3],i[4],i[5]),i=new THREE.Vector3(i[6],i[7],i[8]);s.setFromCoplanarPoints(l,o,i),t?r=new THREE.Vector3(0,0,0):(d=w.controls.getBoundingBox().getCenter(),h=s.distanceToPoint(d),(r=d.clone()).sub(s.normal.clone().multiplyScalar(h)));var d={uuid:"",normal:[s.normal.x,s.normal.y,s.normal.z],point:[r.x,r.y,r.z]};if("square"==e){var c=new THREE.PlaneBufferGeometry(a,a,1,1),h=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide,opacity:.4}));d.uuid=h.uuid;var u=new THREE.BufferGeometry;(m=new Float32Array(15))[0]=-.5*a,m[1]=-.5*a,m[3]=.5*a,m[4]=-.5*a,m[6]=.5*a,m[7]=.5*a,m[9]=-.5*a,m[10]=.5*a,m[12]=-.5*a,m[13]=-.5*a,u.addAttribute("position",new THREE.BufferAttribute(m,3));var f=new THREE.Line(u,new THREE.LineBasicMaterial({color:0}));h.add(f),n&&(null!=n.planeColor&&h.material.color.setHex(n.planeColor),null!=n.lineColor&&f.material.color.setHex(n.lineColor),null!=n.opacity&&(h.material.opacity=n.opacity)),h.position.copy(r),h.material.transparent=!0,(c=new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),s.normal),h.quaternion.copy(c),this.additionalObjectsScene&&this.additionalObjectsScene.add(h)}else if("circle"==e){var p=new THREE.CircleBufferGeometry(.5*a,32),a=new THREE.Mesh(p,new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide,opacity:.4}));d.uuid=a.uuid;for(var u=new THREE.BufferGeometry,m=new Float32Array(99),g=0;g<33;g++)m[3*g]=p.attributes.position.array[3*(g+1)],m[3*g+1]=p.attributes.position.array[3*(g+1)+1],m[3*g+2]=p.attributes.position.array[3*(g+1)+2];u.addAttribute("position",new THREE.BufferAttribute(m,3));f=new THREE.Line(u,new THREE.LineBasicMaterial({color:0}));a.add(f),n&&(null!=n.planeColor&&a.material.color.setHex(n.planeColor),null!=n.lineColor&&f.material.color.setHex(n.lineColor),null!=n.opacity&&(a.material.opacity=n.opacity)),a.material.transparent=!0,a.position.copy(r),(c=new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),s.normal),a.quaternion.copy(c),this.additionalObjectsScene&&this.additionalObjectsScene.add(a)}return this.render(),d},x.OpMeasureRelease=function(){"OpMeasure"==w.controls.getOperator().type&&w.controls.getOperator().release()},x.onCloseClipControl=function(){w.clipPlaneManager.onCloseClipControl(),w.clipBoxManager.SetRenderBox(!1),w.render()},x.onOpenClipControl=function(){w.clipPlaneManager.isSectionViewEnabled()&&w.clipPlaneManager.onOpenClipControl(),w.clipBoxManager.SetRenderBox(!0),w.render()},x.createPlaneByScreenPoints=function(e,t,n){if(null==t)return null;if(t.length<4)return null;var i=new THREE.Matrix4;i.multiplyMatrices(this.camera.matrixWorld,i.getInverse(this.camera.projectionMatrix));var r=this.renderer.getPixelRatio(),o=this.renderer.domElement,a=[],s=new THREE.Vector3;return s.set(t[0]*r/o.width*2-1,2*-(t[1]*r/o.height)+1,0),s.applyMatrix4(i),a.push(s.x),a.push(s.y),a.push(s.z),s.set(t[2]*r/o.width*2-1,2*-(t[3]*r/o.height)+1,0),s.applyMatrix4(i),a.push(s.x),a.push(s.y),a.push(s.z),s.set(t[0]*r/o.width*2-1,2*-(t[1]*r/o.height)+1,.1),s.applyMatrix4(i),a.push(s.x),a.push(s.y),a.push(s.z),this.createPlaneByWorldPoints(e,a,n)},x.setMeshVertexColorByUuid=function(e,t,n){if(e&&t){var i=this.scene.getObjectByProperty("uuid",e);if(i&&i.geometry&&i.geometry instanceof THREE.BufferGeometry&&null!=i.geometry.attributes.position){var r=i.geometry.attributes.position.count;if(i.material&&i.material.color){for(var o=new Float32Array(3*r),a=0;a<r;++a)o[3*a+0]=i.material.color.r,o[3*a+1]=i.material.color.g,o[3*a+2]=i.material.color.b;for(var s=new THREE.Color,a=0,l=t.length;a<l;++a){var d=t[a].index;d<r&&(s.setHex(t[a].color),o[3*d+0]=s.r,o[3*d+1]=s.g,o[3*d+2]=s.b)}i.geometry.addAttribute("color",new THREE.BufferAttribute(o,3)),i.material=i.material.clone(),i.material.vertexColors=THREE.VertexColors,i.material.needsUpdate=!0,0!=n&&this.render()}}}},x.removeMeshVertexColorByUuid=function(e,t){e=this.scene.getObjectByProperty("uuid",e);e&&e.geometry&&e.geometry instanceof THREE.BufferGeometry&&null!=e.geometry.attributes.color&&(e.geometry.removeAttribute("color"),e.material&&(e.material.vertexColors=THREE.NoColors,e.material.needsUpdate=!0),0!=t&&this.render())},x.clear=function(){this.ndsModel&&(this.ndsModel.dispose(),this.scene.remove(this.ndsModel),this.ndsModel=null),this.pmiObject&&(this.pmiObject.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.scene.remove(this.pmiObject),this.pmiObject=null),this.animationsManager=new Ve(this),this.pmiObject=null,this.haspartPMI=!1,this.hasAssemblyPMI=!1,this.PartPMIuuid=[],this.explodeObjects=[],this.brepManager=null,this.inWaitProcedure=!1,this.inWheel=!1,this.viewer2DInfo={center:new THREE.Vector3(0,0,0),normal:new THREE.Vector3(0,0,1),yDir:new THREE.Vector3(0,1,0),distance:100},this.annotationsManager=void 0,this.materialsSetting=void 0,this.propertyManager=void 0,this.containProperty=!1,this.trueMapList=null,this.commentManager.clear(),this.ndsModel=null,this.ndsModelBvhLoaded=!1,this.ndsModelPMILoaded=!1,this.ndsModelObjectTreeLoaded=!1,this.nBufferChunks=0,this.nBufferChunksLoaded=0},x.onUpdateProgress=function(e){e=e.userData.precent;.99<=e?w.progressBar.style.visibility="hidden":(w.progressBarFrontground.style.width=w.progressBarWidth*e+"px",w.progressBar.style.visibility="visible")},x.loadBrepInfo=function(e){this.brepManager||(this.brepManager=new Ne(this)),this.brepManager.loadBreps(e)},x.dispatchBrepEvent=function(){var e;this.brepLoadIndex++,2==this.brepLoadIndex&&(e=!!(this.ndsModel&&this.modelRootObject&&this.modelRootObject.boundingBox),this.dispatchEvent({type:"BrepInfoEvent",faceArea:this.brepInfo.BfaceArea,bodyVolume:this.brepInfo.BbodyVolume,totalVolume:this.brepInfo.BbodyVolume,bodyArea:this.brepInfo.BbodyArea,totalArea:this.brepInfo.BtotalArea,boundingbox:!(!this.brepInfo.BfaceArea||!e),facePerimeter:this.brepInfo.BfacePerimeter}))},x.hasBrepInfo=function(){return!!this.brepManager&&this.brepManager.hasBrepInfo()},x.hasBrepFile=function(){return!!this.brepManager&&this.brepManager.hasBrepFile()},x.enableRotation=function(e){t=e,w.viewBox&&w.viewBox.enableViewBox(e)},x.isRotationEnable=function(){return t},x.enablePreSelection=function(e){0==(Ue.enablePreSelectBrep=e)&&this.selectionManager.clearPreSelection()},x.enableDirectMoveAndRotate=function(e){Ue.enableDirectMove=e,Ue.enableDirectRotate=e},x.enableDirectMove=function(e){Ue.enableDirectMove=e},x.enableDirectRotate=function(e){Ue.enableDirectRotate=e},x.getSelectList=function(){var e=w.ndsModel.getSelectedBodies(),t=[];e.forEach(function(e){return t.push(e.objectid)});var n=[];return t.forEach(function(e){for(var t=w.getObjectByUUID(w.ndsModel.objectidTouuid[e]);t.parent&&w.ndsModel.isBodyAllChildSelected(t.parent)&&-1==n.indexOf(t.parent.objectid);)n.push(t.parent.objectid),t=t.parent}),t.concat(n)},x.showObjectbyId=function(e,t){e.forEach(function(e){e=w.ndsModel.objectidTouuid[e];w.showObject(w.getObjectByUUID(e),t)})},x.ObjectIdTouuid=function(e){return w.ndsModel.objectidTouuid[e]},x.ObjectuuidToId=function(e){return w.getBodyNodeFromUuid(e).objectid},x.addSelectList=function(e,t){t?w.selectionManager.selectObjectByList(e):e.forEach(function(e){e=w.ndsModel.objectidTouuid[e],e=w.getObjectByUUID(e);e&&w.selectionManager.deselectObject(e)}),w.render()},x.setTransparentState=function(e,t){var n=[];e.forEach(function(e){return n.push(w.getBodyNodeFromUuid(w.ndsModel.objectidTouuid[e]))}),n.length<=0||(t?(w.ndsModel.inIsolate()?w.ndsModel.transparentizeBodiesOnly(n):w.ndsModel.transparentizeBodies(n),w.render()):w.hasObjectIsolated()&&(w.ndsModel.isolateBodiesOnly(n),w.render()))},x.changeObjectColorByid=function(e,t){e.forEach(function(e){e=w.ndsModel.objectidTouuid[e];w.changeObjectColor(e,t)})},x.zoomToObjectById=function(e){e=w.ndsModel.objectidTouuid[e],e=w.getBodyNodeFromUuid(e);w.zoomToObject(e,!0)},x.dispatchAsyncEvent=function(e){setTimeout(function(){w.dispatchEvent(e)},.5)},x.addIconToContainer=function(e,t,n){this.container.appendChild(e)},x.removeIconFromContainer=function(e,t){this.container.removeChild(e)},x.syncSendMsg=function(e){e.UnitState=this.userModelUnit,this.AssemblyPMIState&&(e.AssemblyPMIState=this.AssemblyPMIState,this.AssemblyPMIState=null),this.PartPMIState&&(e.PartPMIState=this.PartPMIState,this.PartPMIState=null),this.exchangeBackImage&&(e.exchangeBackImage=this.exchangeBackImage),null!=this.oneKeyColor.isActive&&!0===this.oneKeyColor.isActive?(e.useRandomColor=!0,e.randColor=this.oneKeyColor.color,this.oneKeyColor.isActive=!0):null!=this.oneKeyColor.isActive&&!1===this.oneKeyColor.isActive&&(e.useRandomColor=!1,e.randColor=null,this.oneKeyColor.isActive=null),0<this.exchangeNodeColor.length&&(e.exchangeNodeColor=this.exchangeNodeColor),this.isSectionViewEnabled()&&(e.ClipPlaneVisible=this.clipPlaneManager.getClipPlaneVisible(),e.showClipControl=this.clipPlaneManager.getClipControlVisible())},x.syncGetMsg=function(e){if(e.ClearColor!=w.renderer.getClearColor().getHex()&&this.setBackGroundColor(e.ClearColor),e.UnitState!=this.userModelUnit&&this.setDispalyModelUnit(e.UnitState),e.AssemblyPMIState&&null!=e.AssemblyPMIState.visible&&this.setAssemblyPMIVisible(e.AssemblyPMIState.visible),e.PartPMIState&&null!=e.PartPMIState.visible&&this.setPartPMIVisible(e.PartPMIState.visible),e.exchangeBackImage&&("Image"===e.exchangeBackImage.type?(this.setEnvMapTextures(null),this.setBackGroundImage(e.exchangeBackImage.value)):"EnvMap"===e.exchangeBackImage.type?this.setEnvMapTextures(e.exchangeBackImage.value):"Color"===e.exchangeBackImage.type&&(this.setEnvMapTextures(null),this.setBackGroundImage(null),this.setBackGroundColor(e.exchangeBackImage.value))),null!=e.useRandomColor&&!0===e.useRandomColor?this.autoChangeObjectColor(!0,e.randColor):null!=e.useRandomColor&&!1===e.useRandomColor&&(this.autoChangeObjectColor(!1,null),e.useRandomColor=null),e.exchangeNodeColor)for(var t=0;t<e.exchangeNodeColor.length;t++)this.changeObjectColor(e.exchangeNodeColor[t].objectUUID,e.exchangeNodeColor[t].color);this.isSectionViewEnabled()&&e.showClipControl!=this.clipPlaneManager.getClipControlVisible()&&(e.showClipControl?this.clipPlaneManager.onOpenClipControl():this.clipPlaneManager.onCloseClipControl())},h.language?ye.setLanguage(h.language):ye.setLanguage(navigator.language),s&&(x.Optoolbar=new Yt(qn(qn(x)),h)),new en(qn(qn(x)),h.loadingWaiterColor),new At(qn(qn(x)),h.loadingCovererColor),Ue.enableSelect&&x.enableInternalRMB&&new $t(qn(qn(x))),w.bHasLoadingStater&&(x.stater=new Kt(qn(qn(x))),x.stater.addEventListener("cancel",x.stopReadingModel)),i.addEventListener("render",x.render),i.addEventListener("event",x.onControlsEvent),window.addEventListener("keydown",function(e){Ue.enableBroadcast&&!Ue.broadcastMajor||32==e.keyCode&&w.toggleAutoRotation()},!1),x.canvas2D?(x.canvas2D.addEventListener("contextmenu",function(e){e.preventDefault()},!1),ye.isMobileDevice()?(x.canvas2D.addEventListener("touchstart",x.onMouseDown,!1),x.canvas2D.addEventListener("touchend",x.onMouseUp,!1)):(x.canvas2D.addEventListener("mousedown",x.onMouseDown,!1),x.canvas2D.addEventListener("mouseup",x.onMouseUp,!1))):(o.addEventListener("contextmenu",function(e){e.preventDefault()},!1),ye.isMobileDevice()?(o.addEventListener("touchstart",x.onMouseDown,!1),o.addEventListener("touchend",x.onMouseUp,!1)):(o.addEventListener("mousedown",x.onMouseDown,!1),o.addEventListener("mouseup",x.onMouseUp,!1))),window.addEventListener("resize",x.onResize,!1),x.onWindowResize(),$(),document.addEventListener("fullscreenchange",ce),document.addEventListener("webkitfullscreenchange",ce),document.addEventListener("mozfullscreenchange",ce),document.addEventListener("MSFullscreenChange",ce),void 0!==h.envMapTextures&&(x.setEnvMapTextures(h.envMapTextures),x.updateEnvMapBlur()),void 0!==h.backGroundImage&&x.setBackGroundImage(h.backGroundImage),x.addEventListener("updateProgress",x.onUpdateProgress,!1),x.addEventListener("windowResize",x.onWindowResize,!1),x}var e,t,n;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Zn(e,t)}(he,THREE.EventDispatcher),e=he,(t=[{key:"initViewer",value:function(){this.inited&&!(0<arguments.length&&void 0!==arguments[0]&&arguments[0])||(this.brepLoadIndex=0,this.oldenableBroadcast=Ue.enableBroadcast,Ue.enableBroadcast=!1,this.explodeObjects=[],this.inited=!0);var d=this;this.loadCallback=function(e,t,n){if(d.ndsModel&&1!=e.isPmi&&(d.ndsModelObjectTreeLoaded=!0,d.ndsModelBvhLoaded&&(d.prepareModelForRendering(e),d.setBodyNodeMaterialsInfo(d.bodyNodeUUidToMaterial)),d.modelRootObject&&d.modelRootObject.boundingBox.copy(e.boundingBox)),e instanceof THREE.Scene)d.scene=e,d.modelRootObject=e;else if(e.isPmi){if(e.name="pmiobject",d.pmiObject=e,d.dispatchEvent({type:"PMIInfoEvent",PMI:!0}),d.pmiVisible&&d.scene.add(e),d.ndsModelPMILoaded=!0,d.ndsModelBvhLoaded&&d.ndsModelObjectTreeLoaded){for(var i=[d.ndsModel.rootBodyNode],r=0;r<i.length;++r){var o=i[r];if(o.pmiuuid&&!d.is2DModel&&d.pmiObject){null==o.worldMatrix&&(o.worldMatrix=d.ndsModel.calculateNodeWorldMatrix(o));for(var a=0;a<o.pmiuuid.length;++a){var s=o.pmiuuid[a],s=d.pmiObject.getObjectByName(s);s&&"PMI"==s.type&&(s.matrix.multiply(o.worldMatrix),s.updateMatrixWorld(!0))}}!o.visible&&o.pmiuuid&&d.pmiObject&&d.ndsModel.hideBody(o);for(var a=0,l=o.children.length;a<l;++a)i.push(o.children[a])}d.setBodyNodeMaterialsInfo(d.bodyNodeUUidToMaterial)}}else d.modelRootObject?(d.ndsModel||e.children[0].children[0]&&d.modelRootObject.children[0].children[0].add(e.children[0].children[0]),d.selectionManager.computeTargetList(d.scene)):(d.ndsModel||d.scene.add(e),d.modelRootObject=e);e.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(null!=e.urlIndex?d.meshLoadedUUIDs.push({uuid:e.uuid,urlIndex:e.urlIndex}):d.meshLoadedUUIDs.push({uuid:e.uuid,urlIndex:0}))}),d.addLights(d.scene),void 0!==n&&(d.bGeoBufferChunkLoaded=n)}}}])&&Yn(e.prototype,t),n&&Yn(e,n),he}()}],r.c=o,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=154);function r(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var n,o});