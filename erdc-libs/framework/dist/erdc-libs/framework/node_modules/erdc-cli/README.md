# erdc-cli

PLM 3.x 前端服务、构建脚本。

## Features

- 开发服务器
  - [x] 静态资源服务器
  - [x] 开发服务代理
  - [x] html、css、js 文件的热更新
  - [x] Vue 组件热更新
  - [ ] 源码模式
  - [ ] 本地依赖模式
- 前端构建脚本
    - [x] 代码 ES 版本转换
    - [x] 代码压缩
    - [x] 代码打包
    - [x] 代码模块发布
    - [x] 代码合并
    - [ ] 胖包模式
- [x] 自定义配置
- [ ] 插件机制

## 指南

**前提**：当前环境符合下列条件之一：

1. 当前工程是一个 PLM 3.x 微应用；
2. 当前工程是一个 PLM 3.x 微模块；
3. 当前工程一个包含上述内容的 Monorepo 工程；

### 安装与使用

```shell
npm install erdc-cli --registry http://nexus.ddns.e-lead.cn/repository/erdc-npm/ --save-dev
```

### 基础

控制台执行`npx erdc-cli -h`可以查看所有支持的脚本及相关说明。
```shell
Usage: erdc-cli [options] <command> [args]
  Options:
    [--help]                    help information
    [--version]                 peek the version of current package
    [--config,c]                customize the configuration, default is ./erdcloud.config.js
    
  Commands:
    serve                       serve server
      [--proxy]         URL of the proxy server
      [--port]          port to run server
      [--open]          automatically open browser
    clean                       clean current package
      [--dryRun,d]              Dry run
    build                       build current package
      [--output,o]              output directory path
      [--grouped]               grouped output
      [--fat,fatDist]           fat output, for application build only
      [--additional]            additional output, which means the output directory will not be cleaned
      [--dry-run]               dry run
    license                     review licenses
      [--output,o]              where would the license file save to
```

对于布尔类型参数，可以使用`--no-xx`或者`--xx false`的方式设定值。例如下面及种用法都是正确的：
```shell
# 设定 hot 为 true
npx erdc-cli serve -hot
npx erdc-cli serve --hot true
npx erdc-cli serve --hot=true
# 设定 hot 为 false
npx erdc-cli serve --no-hot
npx erdc-cli serve --hot false
npx erdc-cli serve --hot=false
```

推荐在`package.json`文件里配置下列命令：

```json
{
    "scripts": {
        "build": "npx erdc-cli build",
        "build:publish": "npx erdc-cli build --publish",
        "serve": "npx erdc-cli serve --proxy http://your-erdcloud-plm.cn/"
    }
}
```

#### erdc-cli serve

```shell
用法：erdc-cli serve [options]

选项：
  --proxy		服务代理的线上环境
  --[port,p]	指定 port（默认值：1005）
  --open 		在服务器启动时打开浏览器

```

`erdc-cli serve`命令会启动一个开发服务器（基于[Browser Sync](https://browsersync.bootcss.com/)）并附带开箱即用的模块热重载。除了通过命令行参数，你也可以使用`erdcloud.config.js`的`server`字段配置开发服务器。

命令行参数`[proxy]`时一个**必须**提供的配置。在开发阶段，本地只关注开发者所属团队所负责的内容，大部分资源都使用线上的代理版本。`[proxy]`配置用于这些资源的代理；同时也用于代理后端接口。

`[port]`默认使用`1005`；同时，在检测出端口冲突时，会尝试将端口 + 1，直到取得一个能够使用的端口为止。

#### erdc-cli build

```shell
用法：erdc-cli build [options]

选项：
  --[output,o]		指定构建资源的输出路径（默认值：'./dist'）
  --dry-run			测试脚本，指定`true`后不会发布代码、生成压缩包
  --pack			生成压缩包，可用于上传到环境上部署（默认值：true）
  --publish			将资源发布到私库
  --registry		指定私库
  --[additional,add]增量构建，原构建资源不会被清理
```

`erdc-cli build`命令会扫描当前目录下所有微应用与微模块，将扫描出来的模块文件进行转码、压缩、合并等操作。同时，自带包的打包、发布（到 npm 仓库）逻辑，开发者可以根据需要自行决定是否执行。

#### erdc-cli clean

`erdc-cli clean`命令用于清理上次执行`serve/build`命令遗留下来的缓存；通常你不需要手动执行它，因为在启动服务、构建代码时默认是会自动执行代码清理步骤的。

#### erdc-cli license

`erdc-cli license`用于扫描所有依赖包的 license 信息，通常用于审查当前工程是否使用了非商用模块。我们**不应**使用商用不友好的开源模块。更多信息请参看[《什么是License？许可证？协议？都有哪些License？》](https://zhuanlan.zhihu.com/p/111461655)等文章。

### 开发服务

```shell
npx erdc-cli serve --proxy http://your-erdcloud-plm.cn/
```

默认情况下，开发服务会扫描目录下需要收集的内容，按照微前端平台预设的目录结构存整理，放到`nodde_modules/.erdc`目录。同时，`serve`目录启动一个 Browser Sync 服务器，用于代理`.erdc`下的资源，以及`[proxy]`参数指定的服务器资源（本地不存在的静态资源 & 后端接口资源）；启动一个文件监听服务，监听目录下所有文件的变化，并将变化同步到`.erdc`目录，从而使线上能够针对文件变化做一些响应事件。

#### 热更新

指定`[hot]`参数为`true`后，开发服务会向页面注入一个`erdc-cli-client`模块；该模块可以监听`.erdc`的`.{js|html|css}`文件变化，并尝试进行一些模块热更新。

1. 当一个`css`文件变化时，将这个文件动态加载到页面上；
2. 当一个`html`文件变化时，尝试分析其应用：若该资源被应用为 Vue 组件的`template`，尝试热更新对应的组件实例；否则刷新浏览器。
3. 当一个`js`文件变化时，尝试分析其应用：若该资源对外暴露一个 Vue 组件，尝试热更新对应的组件实例；否则刷新浏览器。

上述热更新逻辑在分析文件用途时并非 100% 准确，因此部分场景可能会更新失败。

你可以使用`--no-hot`参数来禁用热更新。

```shell
npx erdc-cli serve --no-hot
```

#### 代理设置

`proxy`配置时必须的。因为开发者开发模块与微应用时，通常大部分依赖资源都在远端服务器上获取。另外，开发者可以在`erdcloud.config.js`的`server`配置指定后端代理规则，这对于与后端开发联调接口时很有帮助。

例如，将`/workflow`开头的请求转发到`http://your.workflow.proxy/`服务器：

```javascript
// erdcloud.config.js
const { defineConfig } = require('erdc-cli');

module.exports = defineConfig({
    server: {
        /**
        * @type {import('http-proxy-middleware').Options}
        * @description http-prixy-middleware配置，参看 https://github.com/chimurai/http-proxy-middleware#readme
        */
        proxyConfig: {
          // 工作流服务代理到另一台服务器
          '/bpm': {
              target: 'http://you-proxy-host.com/',
              changeOrigin: true
          }
        }
    }
});
```

### 构建代码

```java
npx  erdc-cli build
```

发布环境环境时，可以通过`build`命令对代码进行转码与合并，并将生成的 npm 包上传到微前端平台。

#### 构建配置

开发者可以通过`erdcloud.config.js`文件提供一些配置，从而达到定制构建行为的目的。全量构建配置说明参看下文[《配置参考》](#配置参考)章节。

```js
const join = require('path').join;
const { defineConfig } = require('erdc-cli');

module.exports = defineConfig({
    collect: {
        includes: [
            {
                source: ['packages/create-erdc-app/**'],
                excludes: [/node_modules/],
                dest(distPath) {
                    return join(distPath, './create-erdc-app');
                }
            }
        ],
        excludes: [/create-erdc-app/]
    },
    replaces: [],
    build: {
        excludes: [
            /(erdc-thirdparty/
        ]
    }
});
```

#### 代码替换

代码构建阶段，开发者可以选择将部分源代码按字符串进行替换。最常见的场景是所有请求信息出于缓存控制的原因，需为所有后端接口、静态资源加载处追加版本字符串参数，可以参看下面的例子进行（此场景默认包含在`erdc-cli`，开发者无需自行处理；以下内容仅作例子用）。

HTML 源代码：

```html
<!-- __VERSION__ 字符串会在构建时被替换-->
<script src="xxx/xxxx.js?ver=__VERSION__"></script>
```

```javascript
function fetchApi () {
    // 示例用，通常追加版本参数的逻辑是统一追加的
    return fetch({ url: '/api/xxx', params: { _: '__VERSION__' } })
}
```

```javascript
const { defineConfig } = require('erdc-cli');
const packageJson = require('package.json');

module.exports = defineConfig({
    replaces: [
        {
            // 替换范围，支持 Globs 模式以及正则表达式
			// Globs模式例如：**/*.{js,css,html}，或者数组['**/*.{js,css,html}', '!libs/**/*']
            rule: /\.(js|css|html)$/,
            // 要排除的文件，支持 Globs 模式以及正则表达式
            excludes: [],
            replace: [
                // 数组第一个元素是源代码字符串，第二个元素是替换结果字符串
                ['__VERSION__', packageJson.version + '-' + Date.now().toString(36)]
            ]
        }
    ]
});
```

#### 代码收集

通常，开发态的工程结构与最终部署结构是不一致的。以 erdcloud-plat-frontend 为例，在开发态，该工程是一个 Monorepo  工程：
```tex
/
├─ erdc-apps
└─ packages
	├─ erdc-cli
	├─ erdc-kit
	├─ erdc-libs
	├─ erdc-help
	├─ erdc-layout
	├─ erdc-resource
	├─ erdc-theme
    └─ erdc-thirdparty
```

在代码运行态，约定的目录结构是这样的（详情参看 《PLAT 前端开发手册》）：

```text
/
├─ erdc-apps
├─ erdc-libs
├─ erdc-help
├─ erdc-layout
├─ erdc-resource
├─ erdc-theme
└─ erdc-thirdparty
```

为了将工程结构整理成约定结构，`erdc-cli`的收集模块会根据各个包的`package.json`文件的`namespace`将资源各自归位。例如`@erdc-layout/ultra`包放在`packages/erdc-layout/ultra`目录下，构建后会被复制到`/erdc-layout/ultra`目录。

开发者可以利用`collect`配置来定义文件收集行为。例如：
```javascript
const { defineConfig } = require('erdc-cli');
const packageJson = require('package.json');

module.exports = defineConfig({
    collect: {
        includes: [
            {
                // 收集范围
                source: ['packages/create-erdc-app/**'],
                // 排除包内资源
                excludes: [/node_modules/],
                // 输出
                dest(distPath) {
                    return join(distPath, './create-erdc-app');
                }
            },
            {
                source: ['packages/erdc-cli/**'],
                excludes: [/node_modules/],
                dest: 'erdc-cli'
            },
            {
                source: ['packages/erdc-kit/**'],
                excludes: [/node_modules/],
                dest: 'erdc-kit'
            }
        ],
        excludes: []
    }
});
```

当一个应用需要额外安装一些第三方资源时，`collect`配置可以很好地帮助开发者将这些资源引入到前端体系。

#### 代码转码

`build`命令会使用 babel 将 ES6+ 代码转换成 ES5，从而能正确运行在不同浏览器。默认 babel 配置如下：
```javascript
{
    targets: {
        browsers: ['ie >= 11', 'chrome >= 69']
    },
    presets: [['@babel/preset-env']]
}
```

开发者可以根据 [babel 的文档说明](https://babeljs.io/docs/configuration)对转码行为进行定制，也可以对 [browserify](https://browserify.org/) 进行修改。

#### 代码合并

为减少前端静态资源请求数，`erdc-cli build`命令默认会将资源包打包成`erdc-bundle.js`文件，在生产环境下，所有对包内资源的请求都会被重定向到 bundle 文件。开发者可以提供`build.optimize`配置来对合并的资源进行排除，或者干脆自己定制创建 bundle 的过程。

```javascript
const { defineConfig } = require('erdc-cli');

module.exports = defineConfig({
    build: {
        // 无需执行转码的文件，支持Glob 模式或者正则表达式
        excludes: [],
        optimize: {
            // 定制自己的代码合并逻辑
            includes: [],
            // 无需合并到 erdc-bundle.js的文件，支持Glob 模式或者正则表达式
            excludes: [/(BpmFlowchart|bpm_flowchart|erdcloud-ui)/]
        }
    }
});
```

#### 模块发布

```javascript
npx erdc-cli build --publish
```

指定`[publish]`参数后，`build`脚本会将构建出来的包，以及源代码包发布到 npm 仓库。默认情况下，`publish`指定会使用当前 npm 环境指定的`registry`参数；如果当前环境没有指定，则使用 Elead Nexus 私库(` http://nexus.ddns.e-lead.cn/repository/erdc-npm-hosted/`)。

```shell
npx erdc-cli build --publish --registry http://your-private-registry.com
```

**注意，如果开发者在开发客制化模块时，未修改包名前不应该将代码发布到公司私库（除非开发者知道自己干什么）。**

## 配置参考

### 命令行参数

执行下面的命令查看详细描述。

```shell
npx erdc-cli --help
```

### erdcloud.config.js

#### clean

代码清理配置。

##### includes?: `GlobPattern | Array<GlobPattern>`

缓存清理时指定额外的清理内容。

##### excludes?: `GlobPattern | Array<GlobPattern>`

缓存清理时指定无需清理的内容。

#### collect

代码收集配置。

##### includes?: `Array<CollectInclude>`

额外的代码收集配置。

```typescript
export type CollectInclude = {
    // 收集来源
    source: GlobPattern | Array<GlobPattern>;
    // 收集到指定的路径
    dest: ((distPath: string) => string) | string;
	// 排除的资源
    excludes?: GlobPattern |Array<GlobPattern>;
    /**
     * 收集时对文件进行重命名
     * reference to gulp-rename https://www.npmjs.com/package/gulp-rename#usage
     */
    rename?:
        | string
        | object
        | ((path: object) => object)
        | ((context: string, outputPath: string) => string | object | ((path: object) => object));
};
```

##### excludes?: `GlobPattern | Array<GlobPattern>`

排除的收集配置。仅影响`erdc-cli`默认收集行为。

#### replaces?: `Array<ReplaceConfig>`

代码替换配置。

```typescript
export type ReplaceConfig = {
    // 替换范围
    rule: GlobPattern | RegExp;
    // 代码替换内容
    replace: Array<[sourceCodeSnippet: string, replaceWith: string]>;
};
```

#### build

代码构建配置。

##### output? : `string`

构建资源输出路径，可以是相对运行目录的路径，也可以是绝对路径。默认值为`./dist`。当命令行参数`--output`和`-o`同时指定时，命令参数生效。

##### excludes?: `GlobPattern | Array<GlobPattern>`

执行 ES Build 排除的文件。

##### optimize

代码合并配置。

###### rules?: `[path: string, GlobPattern | Array<GlobPattern>] | Array<[path: string, GlobPattern | Array<GlobPattern>]>`

代码的额外合并行为。其中：

- 第一个元素: bundle 输出文件地址;
- 第二个元素：bundle 包含的内容；

###### excludes?: `GlobPattern | Array<GlobPattern>`

影响默认合并行为，排除指定的文件。

### server

#### hot: `boolean`

是否启用热更新，默认值`true`。命令行参数`--hot`优先级更高。

#### port: `number|string`

服务的监听端口，默认值`1005`。命令行参数`--port`和`-p`优先级更高。

#### proxy: `string`

服务的默认代理服务。命令行参数`--proxy`优先级更高。

#### proxyConfig

服务的代理配置，参见 http-proxy-middleware。
